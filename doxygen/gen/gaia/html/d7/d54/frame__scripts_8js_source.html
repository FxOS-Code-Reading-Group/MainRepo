<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: frame_scripts.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d7/d54/frame__scripts_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">frame_scripts.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d7/d54/frame__scripts_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- /</span>
<a name="l00002"></a>00002 <span class="comment">/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */</span>
<a name="l00003"></a>00003 
<a name="l00004"></a><a class="code" href="../../d7/d54/frame__scripts_8js.html#ae2475e10618961c050dcba04e8c42331">00004</a> <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l00005"></a>00005 
<a name="l00053"></a>00053 var <a class="code" href="../../d8/df0/frames_8js.html#a050c35bd1ae66a249cd6c3554661e24a">GestureDetector</a> = (<span class="keyword">function</span>() {
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   <span class="comment">//</span>
<a name="l00056"></a>00056   <span class="comment">// Constructor</span>
<a name="l00057"></a>00057   <span class="comment">//</span>
<a name="l00058"></a>00058   <span class="keyword">function</span> GD(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>) {
<a name="l00059"></a>00059     this.element = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>;
<a name="l00060"></a>00060     this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> || {};
<a name="l00061"></a>00061     this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> = initialState;
<a name="l00062"></a>00062     this.timers = {};
<a name="l00063"></a>00063     this.listeningForMouseEvents = <span class="keyword">true</span>;
<a name="l00064"></a>00064   }
<a name="l00065"></a>00065 
<a name="l00066"></a>00066   <span class="comment">//</span>
<a name="l00067"></a>00067   <span class="comment">// Public methods</span>
<a name="l00068"></a>00068   <span class="comment">//</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070   GD.prototype.startDetecting = <span class="keyword">function</span>() {
<a name="l00071"></a>00071     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00072"></a>00072     eventtypes.forEach(<span class="keyword">function</span>(t) {
<a name="l00073"></a>00073       <span class="keyword">self</span>.element.addEventListener(t, <span class="keyword">self</span>);
<a name="l00074"></a>00074     });
<a name="l00075"></a>00075   };
<a name="l00076"></a>00076 
<a name="l00077"></a>00077   GD.prototype.stopDetecting = <span class="keyword">function</span>() {
<a name="l00078"></a>00078     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00079"></a>00079     eventtypes.forEach(<span class="keyword">function</span>(t) {
<a name="l00080"></a>00080       <span class="keyword">self</span>.element.removeEventListener(t, <span class="keyword">self</span>);
<a name="l00081"></a>00081     });
<a name="l00082"></a>00082   };
<a name="l00083"></a>00083 
<a name="l00084"></a>00084   <span class="comment">//</span>
<a name="l00085"></a>00085   <span class="comment">// Internal methods</span>
<a name="l00086"></a>00086   <span class="comment">//</span>
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   GD.prototype.handleEvent = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00089"></a>00089     var <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a> = this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>[<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.type];
<a name="l00090"></a>00090     <span class="keywordflow">if</span> (!handler) <span class="keywordflow">return</span>;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="comment">// If this is a touch event handle each changed touch separately</span>
<a name="l00093"></a>00093     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.changedTouches) {
<a name="l00094"></a>00094       <span class="comment">// If we ever receive a touch event, then we know we are on a</span>
<a name="l00095"></a>00095       <span class="comment">// touch device and we stop listening for mouse events. If we</span>
<a name="l00096"></a>00096       <span class="comment">// don&#39;t do that, then the touchstart touchend mousedown mouseup</span>
<a name="l00097"></a>00097       <span class="comment">// generated by a single tap gesture will cause us to output</span>
<a name="l00098"></a>00098       <span class="comment">// tap tap dbltap, which is wrong</span>
<a name="l00099"></a>00099       <span class="keywordflow">if</span> (this.listeningForMouseEvents) {
<a name="l00100"></a>00100         this.listeningForMouseEvents = <span class="keyword">false</span>;
<a name="l00101"></a>00101         this.element.removeEventListener(<span class="stringliteral">&#39;mousedown&#39;</span>, <span class="keyword">this</span>);
<a name="l00102"></a>00102       }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104       <span class="comment">// XXX https://bugzilla.mozilla.org/show_bug.cgi?id=785554</span>
<a name="l00105"></a>00105       <span class="comment">// causes touchend events to list all touches as changed, so</span>
<a name="l00106"></a>00106       <span class="comment">// warn if we see that bug</span>
<a name="l00107"></a>00107       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.type === <span class="stringliteral">&#39;touchend&#39;</span> &amp;&amp; <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.changedTouches.length &gt; 1) {
<a name="l00108"></a>00108         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;gesture_detector.js: spurious extra changed touch on &#39;</span> +
<a name="l00109"></a>00109                      <span class="stringliteral">&#39;touchend. See &#39;</span> +
<a name="l00110"></a>00110                      <span class="stringliteral">&#39;https://bugzilla.mozilla.org/show_bug.cgi?id=785554&#39;</span>);
<a name="l00111"></a>00111       }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113       <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.changedTouches.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00114"></a>00114         <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a>(<span class="keyword">this</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.changedTouches[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]);
<a name="l00115"></a>00115         <span class="comment">// The first changed touch might have changed the state of the</span>
<a name="l00116"></a>00116         <span class="comment">// FSM. We need this line to workaround the bug 785554, but it is</span>
<a name="l00117"></a>00117         <span class="comment">// probably the right thing to have here, even once that bug is fixed.</span>
<a name="l00118"></a>00118         handler = this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>[<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.type];
<a name="l00119"></a>00119       }
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121     <span class="keywordflow">else</span> {    <span class="comment">// Otherwise, just dispatch the event to the handler</span>
<a name="l00122"></a>00122       <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a>(<span class="keyword">this</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124   };
<a name="l00125"></a>00125 
<a name="l00126"></a>00126   GD.prototype.startTimer = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>) {
<a name="l00127"></a>00127     this.clearTimer(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>);
<a name="l00128"></a>00128     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00129"></a>00129     this.timers[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() {
<a name="l00130"></a>00130       <span class="keyword">self</span>.timers[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00131"></a>00131       var <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a> = <span class="keyword">self</span>.state[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l00132"></a>00132       <span class="keywordflow">if</span> (handler)
<a name="l00133"></a>00133         <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a>(<span class="keyword">self</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>);
<a name="l00134"></a>00134     }, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>);
<a name="l00135"></a>00135   };
<a name="l00136"></a>00136 
<a name="l00137"></a>00137   GD.prototype.clearTimer = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (this.timers[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>]) {
<a name="l00139"></a>00139       <a class="code" href="../../da/da1/timers_8js.html#ab37ff0db33a3bf80b0163adc40a58424">clearTimeout</a>(this.timers[type]);
<a name="l00140"></a>00140       this.timers[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142   };
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <span class="comment">// Switch to a new FSM state, and call the init() function of that</span>
<a name="l00145"></a>00145   <span class="comment">// state, if it has one.  The event and touch arguments are optional</span>
<a name="l00146"></a>00146   <span class="comment">// and are just passed through to the state init function.</span>
<a name="l00147"></a>00147   GD.prototype.switchTo = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>, touch) {
<a name="l00148"></a>00148     this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> = <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>;
<a name="l00149"></a>00149     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.init)
<a name="l00150"></a>00150       <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.init(<span class="keyword">this</span>, event, touch);
<a name="l00151"></a>00151   };
<a name="l00152"></a>00152 
<a name="l00153"></a>00153   GD.prototype.emitEvent = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, detail) {
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (!this.<a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a>) {
<a name="l00155"></a>00155       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Attempt to emit event with no target&#39;</span>);
<a name="l00156"></a>00156       <span class="keywordflow">return</span>;
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     var <span class="keyword">event</span> = this.element.ownerDocument.createEvent(<span class="stringliteral">&#39;CustomEvent&#39;</span>);
<a name="l00160"></a>00160     <span class="keyword">event</span>.initCustomEvent(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, <span class="keyword">true</span>, <span class="keyword">true</span>, detail);
<a name="l00161"></a>00161     this.<a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a>.dispatchEvent(event);
<a name="l00162"></a>00162   };
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   <span class="comment">//</span>
<a name="l00165"></a>00165   <span class="comment">// Tuneable parameters</span>
<a name="l00166"></a>00166   <span class="comment">//</span>
<a name="l00167"></a>00167   GD.HOLD_INTERVAL = 1000;     <span class="comment">// Hold events after 1000 ms</span>
<a name="l00168"></a>00168   GD.PAN_THRESHOLD = 20;       <span class="comment">// 20 pixels movement before touch panning</span>
<a name="l00169"></a>00169   GD.MOUSE_PAN_THRESHOLD = 15; <span class="comment">// Mice are more precise, so smaller threshold</span>
<a name="l00170"></a>00170   GD.DOUBLE_TAP_DISTANCE = 50;
<a name="l00171"></a>00171   GD.DOUBLE_TAP_TIME = 500;
<a name="l00172"></a>00172   GD.VELOCITY_SMOOTHING = .5;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   <span class="comment">// Don&#39;t start sending transform events until the gesture exceeds a threshold</span>
<a name="l00175"></a>00175   GD.SCALE_THRESHOLD = 20;     <span class="comment">// pixels</span>
<a name="l00176"></a>00176   GD.ROTATE_THRESHOLD = 22.5;  <span class="comment">// degrees</span>
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   <span class="comment">// For pans and zooms, we compute new starting coordinates that are part way</span>
<a name="l00179"></a>00179   <span class="comment">// between the initial event and the event that crossed the threshold so that</span>
<a name="l00180"></a>00180   <span class="comment">// the first event we send doesn&#39;t cause a big lurch. This constant must be</span>
<a name="l00181"></a>00181   <span class="comment">// between 0 and 1 and says how far along the line between the initial value</span>
<a name="l00182"></a>00182   <span class="comment">// and the new value we pick</span>
<a name="l00183"></a>00183   GD.THRESHOLD_SMOOTHING = 0.9;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185   <span class="comment">//</span>
<a name="l00186"></a>00186   <span class="comment">// Helpful shortcuts and utility functions</span>
<a name="l00187"></a>00187   <span class="comment">//</span>
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   var abs = Math.abs, floor = Math.floor, sqrt = Math.sqrt, atan2 = Math.atan2;
<a name="l00190"></a>00190   var PI = Math.PI;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192   <span class="comment">// The names of events that we need to register handlers for</span>
<a name="l00193"></a>00193   var eventtypes = [
<a name="l00194"></a>00194     <span class="stringliteral">&#39;touchstart&#39;</span>,
<a name="l00195"></a>00195     <span class="stringliteral">&#39;touchmove&#39;</span>,
<a name="l00196"></a>00196     <span class="stringliteral">&#39;touchend&#39;</span>,
<a name="l00197"></a>00197     <span class="stringliteral">&#39;mousedown&#39;</span>  <span class="comment">// We register mousemove and mouseup manually</span>
<a name="l00198"></a>00198   ];
<a name="l00199"></a>00199 
<a name="l00200"></a>00200   <span class="comment">// Return the event&#39;s timestamp in ms</span>
<a name="l00201"></a>00201   <span class="keyword">function</span> eventTime(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00202"></a>00202     <span class="comment">// In gecko, synthetic events seem to be in microseconds rather than ms.</span>
<a name="l00203"></a>00203     <span class="comment">// So if the timestamp is much larger than the current time, assue it is</span>
<a name="l00204"></a>00204     <span class="comment">// in microseconds and divide by 1000</span>
<a name="l00205"></a>00205     var ts = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.timeStamp;
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (ts &gt; 2 * Date.now())
<a name="l00207"></a>00207       <span class="keywordflow">return</span> Math.floor(ts / 1000);
<a name="l00208"></a>00208     <span class="keywordflow">else</span>
<a name="l00209"></a>00209       <span class="keywordflow">return</span> ts;
<a name="l00210"></a>00210   }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 
<a name="l00213"></a>00213   <span class="comment">// Return an object containg the space and time coordinates of</span>
<a name="l00214"></a>00214   <span class="comment">// and event and touch. We freeze the object to make it immutable so</span>
<a name="l00215"></a>00215   <span class="comment">// we can pass it in events and not worry about values being changed.</span>
<a name="l00216"></a>00216   <span class="keyword">function</span> coordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00217"></a>00217     <span class="keywordflow">return</span> Object.freeze({
<a name="l00218"></a>00218       screenX: t.screenX,
<a name="l00219"></a>00219       screenY: t.screenY,
<a name="l00220"></a>00220       clientX: t.clientX,
<a name="l00221"></a>00221       clientY: t.clientY,
<a name="l00222"></a>00222       timeStamp: eventTime(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>)
<a name="l00223"></a>00223     });
<a name="l00224"></a>00224   }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="comment">// Like coordinates(), but return the midpoint between two touches</span>
<a name="l00227"></a>00227   <span class="keyword">function</span> midpoints(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t1, t2) {
<a name="l00228"></a>00228     <span class="keywordflow">return</span> Object.freeze({
<a name="l00229"></a>00229       screenX: floor((t1.screenX + t2.screenX) / 2),
<a name="l00230"></a>00230       screenY: floor((t1.screenY + t2.screenY) / 2),
<a name="l00231"></a>00231       clientX: floor((t1.clientX + t2.clientX) / 2),
<a name="l00232"></a>00232       clientY: floor((t1.clientY + t2.clientY) / 2),
<a name="l00233"></a>00233       timeStamp: eventTime(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>)
<a name="l00234"></a>00234     });
<a name="l00235"></a>00235   }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   <span class="comment">// Like coordinates(), but for a mouse event</span>
<a name="l00238"></a>00238   <span class="keyword">function</span> mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00239"></a>00239     <span class="keywordflow">return</span> Object.freeze({
<a name="l00240"></a>00240       screenX: <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.screenX,
<a name="l00241"></a>00241       screenY: <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.screenY,
<a name="l00242"></a>00242       clientX: <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.clientX,
<a name="l00243"></a>00243       clientY: <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.clientY,
<a name="l00244"></a>00244       timeStamp: eventTime(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>)
<a name="l00245"></a>00245     });
<a name="l00246"></a>00246   }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   <span class="comment">// Given coordinates objects c1 and c2, return a new coordinates object</span>
<a name="l00249"></a>00249   <span class="comment">// representing a point and time along the line between those points.</span>
<a name="l00250"></a>00250   <span class="comment">// The position of the point is controlled by the THRESHOLD_SMOOTHING constant</span>
<a name="l00251"></a>00251   <span class="keyword">function</span> between(c1, c2) {
<a name="l00252"></a>00252     var r = GD.THRESHOLD_SMOOTHING;
<a name="l00253"></a>00253     <span class="keywordflow">return</span> Object.freeze({
<a name="l00254"></a>00254       screenX: floor(c1.screenX + r * (c2.screenX - c1.screenX)),
<a name="l00255"></a>00255       screenY: floor(c1.screenY + r * (c2.screenY - c1.screenY)),
<a name="l00256"></a>00256       clientX: floor(c1.clientX + r * (c2.clientX - c1.clientX)),
<a name="l00257"></a>00257       clientY: floor(c1.clientY + r * (c2.clientY - c1.clientY)),
<a name="l00258"></a>00258       timeStamp: floor(c1.timeStamp + r * (c2.timeStamp - c1.timeStamp))
<a name="l00259"></a>00259     });
<a name="l00260"></a>00260   }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262   <span class="comment">// Compute the distance between two touches</span>
<a name="l00263"></a>00263   <span class="keyword">function</span> touchDistance(t1, t2) {
<a name="l00264"></a>00264     var dx = t2.screenX - t1.screenX;
<a name="l00265"></a>00265     var dy = t2.screenY - t1.screenY;
<a name="l00266"></a>00266     <span class="keywordflow">return</span> sqrt(dx * dx + dy * dy);
<a name="l00267"></a>00267   }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269   <span class="comment">// Compute the direction (as an angle) of the line between two touches</span>
<a name="l00270"></a>00270   <span class="comment">// Returns a number d, -180 &lt; d &lt;= 180</span>
<a name="l00271"></a>00271   <span class="keyword">function</span> touchDirection(t1, t2) {
<a name="l00272"></a>00272     <span class="keywordflow">return</span> atan2(t2.screenY - t1.screenY,
<a name="l00273"></a>00273                  t2.screenX - t1.screenX) * 180 / PI;
<a name="l00274"></a>00274   }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <span class="comment">// Compute the clockwise angle between direction d1 and direction d2.</span>
<a name="l00277"></a>00277   <span class="comment">// Returns an angle a -180 &lt; a &lt;= 180.</span>
<a name="l00278"></a>00278   <span class="keyword">function</span> touchRotation(d1, d2) {
<a name="l00279"></a>00279     var angle = d2 - d1;
<a name="l00280"></a>00280     <span class="keywordflow">if</span> (angle &gt; 180)
<a name="l00281"></a>00281       angle -= 360;
<a name="l00282"></a>00282     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &lt;= -180)
<a name="l00283"></a>00283       angle += 360;
<a name="l00284"></a>00284     <span class="keywordflow">return</span> angle;
<a name="l00285"></a>00285   }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287   <span class="comment">// Determine if two taps are close enough in time and space to</span>
<a name="l00288"></a>00288   <span class="comment">// trigger a dbltap event. The arguments are objects returned</span>
<a name="l00289"></a>00289   <span class="comment">// by the coordinates() function.</span>
<a name="l00290"></a>00290   <span class="keyword">function</span> isDoubleTap(lastTap, thisTap) {
<a name="l00291"></a>00291     var dx = abs(thisTap.screenX - lastTap.screenX);
<a name="l00292"></a>00292     var dy = abs(thisTap.screenY - lastTap.screenY);
<a name="l00293"></a>00293     var dt = thisTap.timeStamp - lastTap.timeStamp;
<a name="l00294"></a>00294     <span class="keywordflow">return</span> (dx &lt; GD.DOUBLE_TAP_DISTANCE &amp;&amp;
<a name="l00295"></a>00295             dy &lt; GD.DOUBLE_TAP_DISTANCE &amp;&amp;
<a name="l00296"></a>00296             dt &lt; GD.DOUBLE_TAP_TIME);
<a name="l00297"></a>00297   }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299   <span class="comment">//</span>
<a name="l00300"></a>00300   <span class="comment">// The following objects are the states of our Finite State Machine</span>
<a name="l00301"></a>00301   <span class="comment">//</span>
<a name="l00302"></a>00302 
<a name="l00303"></a>00303   <span class="comment">// In this state we&#39;re not processing any gestures, just waiting</span>
<a name="l00304"></a>00304   <span class="comment">// for an event to start a gesture and ignoring others</span>
<a name="l00305"></a>00305   var initialState = {
<a name="l00306"></a>00306     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;initialState&#39;</span>,
<a name="l00307"></a>00307     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d) {
<a name="l00308"></a>00308       <span class="comment">// When we enter or return to the initial state, clear</span>
<a name="l00309"></a>00309       <span class="comment">// the detector properties that were tracking gestures</span>
<a name="l00310"></a>00310       <span class="comment">// Don&#39;t clear d.lastTap here, though. We need it for dbltap events</span>
<a name="l00311"></a>00311       d.target = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00312"></a>00312       d.start = d.last = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00313"></a>00313       d.touch1 = d.touch2 = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00314"></a>00314       d.vx = d.vy = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00315"></a>00315       d.startDistance = d.lastDistance = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00316"></a>00316       d.startDirection = d.lastDirection = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00317"></a>00317       d.lastMidpoint = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00318"></a>00318       d.scaled = d.rotated = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00319"></a>00319     },
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     <span class="comment">// Switch to the touchstarted state and process the touch event there</span>
<a name="l00322"></a>00322     <span class="comment">// Once we&#39;ve started processing a touch gesture we&#39;ll ignore mouse events</span>
<a name="l00323"></a>00323     touchstart: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00324"></a>00324       d.switchTo(touchStartedState, e, t);
<a name="l00325"></a>00325     },
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     <span class="comment">// Or if we see a mouse event first, then start processing a mouse-based</span>
<a name="l00328"></a>00328     <span class="comment">// gesture, and ignore any touch events</span>
<a name="l00329"></a>00329     mousedown: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00330"></a>00330       d.switchTo(mouseDownState, e);
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332   };
<a name="l00333"></a>00333 
<a name="l00334"></a>00334   <span class="comment">// One finger is down but we haven&#39;t generated any event yet. We&#39;re</span>
<a name="l00335"></a>00335   <span class="comment">// waiting to see...  If the finger goes up soon, its a tap. If the finger</span>
<a name="l00336"></a>00336   <span class="comment">// stays down and still, its a hold. If the finger moves its a pan/swipe.</span>
<a name="l00337"></a>00337   <span class="comment">// And if a second finger goes down, its a transform</span>
<a name="l00338"></a>00338   var touchStartedState = {
<a name="l00339"></a>00339     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;touchStartedState&#39;</span>,
<a name="l00340"></a>00340     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00341"></a>00341       <span class="comment">// Remember the target of the event</span>
<a name="l00342"></a>00342       d.target = e.target;
<a name="l00343"></a>00343       <span class="comment">// Remember the id of the touch that started</span>
<a name="l00344"></a>00344       d.touch1 = t.identifier;
<a name="l00345"></a>00345       <span class="comment">// Get the coordinates of the touch</span>
<a name="l00346"></a>00346       d.start = d.last = coordinates(e, t);
<a name="l00347"></a>00347       <span class="comment">// Start a timer for a hold</span>
<a name="l00348"></a>00348       <span class="comment">// If we&#39;re doing hold events, start a timer for them</span>
<a name="l00349"></a>00349       <span class="keywordflow">if</span> (d.options.holdEvents)
<a name="l00350"></a>00350         d.startTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>, GD.HOLD_INTERVAL);
<a name="l00351"></a>00351     },
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     touchstart: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00354"></a>00354       <span class="comment">// If another finger goes down in this state, then</span>
<a name="l00355"></a>00355       <span class="comment">// go to transform state to start 2-finger gestures.</span>
<a name="l00356"></a>00356       d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l00357"></a>00357       d.switchTo(transformState, e, t);
<a name="l00358"></a>00358     },
<a name="l00359"></a>00359     touchmove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00360"></a>00360       <span class="comment">// Ignore any touches but the initial one</span>
<a name="l00361"></a>00361       <span class="comment">// This could happen if there was still a finger down after</span>
<a name="l00362"></a>00362       <span class="comment">// the end of a previous 2-finger gesture, e.g.</span>
<a name="l00363"></a>00363       <span class="keywordflow">if</span> (t.identifier !== d.touch1)
<a name="l00364"></a>00364         <span class="keywordflow">return</span>;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366       <span class="keywordflow">if</span> (abs(t.screenX - d.start.screenX) &gt; GD.PAN_THRESHOLD ||
<a name="l00367"></a>00367           abs(t.screenY - d.start.screenY) &gt; GD.PAN_THRESHOLD) {
<a name="l00368"></a>00368         d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l00369"></a>00369         d.switchTo(panStartedState, e, t);
<a name="l00370"></a>00370       }
<a name="l00371"></a>00371     },
<a name="l00372"></a>00372     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00373"></a>00373       <span class="comment">// Ignore any touches but the initial one</span>
<a name="l00374"></a>00374       <span class="keywordflow">if</span> (t.identifier !== d.touch1)
<a name="l00375"></a>00375         <span class="keywordflow">return</span>;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377       <span class="comment">// If there was a previous tap that was close enough in time</span>
<a name="l00378"></a>00378       <span class="comment">// and space, then emit a &#39;dbltap&#39; event</span>
<a name="l00379"></a>00379       <span class="keywordflow">if</span> (d.lastTap &amp;&amp; isDoubleTap(d.lastTap, d.start)) {
<a name="l00380"></a>00380         d.emitEvent(<span class="stringliteral">&#39;tap&#39;</span>, d.start);
<a name="l00381"></a>00381         d.emitEvent(<span class="stringliteral">&#39;dbltap&#39;</span>, d.start);
<a name="l00382"></a>00382         <span class="comment">// clear the lastTap property, so we don&#39;t get another one</span>
<a name="l00383"></a>00383         d.lastTap = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00384"></a>00384       }
<a name="l00385"></a>00385       <span class="keywordflow">else</span> {
<a name="l00386"></a>00386         <span class="comment">// Emit a &#39;tap&#39; event using the starting coordinates</span>
<a name="l00387"></a>00387         <span class="comment">// as the event details</span>
<a name="l00388"></a>00388         d.emitEvent(<span class="stringliteral">&#39;tap&#39;</span>, d.start);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         <span class="comment">// Remember the coordinates of this tap so we can detect double taps</span>
<a name="l00391"></a>00391         d.lastTap = coordinates(e, t);
<a name="l00392"></a>00392       }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394       <span class="comment">// In either case clear the timer and go back to the initial state</span>
<a name="l00395"></a>00395       d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l00396"></a>00396       d.switchTo(initialState);
<a name="l00397"></a>00397     },
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     holdtimeout: <span class="keyword">function</span>(d) {
<a name="l00400"></a>00400       d.switchTo(holdState);
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403   };
<a name="l00404"></a>00404 
<a name="l00405"></a>00405   <span class="comment">// A single touch has moved enough to exceed the pan threshold and now</span>
<a name="l00406"></a>00406   <span class="comment">// we&#39;re going to generate pan events after each move and a swipe event</span>
<a name="l00407"></a>00407   <span class="comment">// when the touch ends. We ignore any other touches that occur while this</span>
<a name="l00408"></a>00408   <span class="comment">// pan/swipe gesture is in progress.</span>
<a name="l00409"></a>00409   var panStartedState = {
<a name="l00410"></a>00410     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;panStartedState&#39;</span>,
<a name="l00411"></a>00411     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00412"></a>00412       <span class="comment">// Panning doesn&#39;t start until the touch has moved more than a</span>
<a name="l00413"></a>00413       <span class="comment">// certain threshold. But we don&#39;t want the pan to have a jerky</span>
<a name="l00414"></a>00414       <span class="comment">// start where the first event is a big distance. So proceed as</span>
<a name="l00415"></a>00415       <span class="comment">// pan actually started at a point along the path between the</span>
<a name="l00416"></a>00416       <span class="comment">// first touch and this current touch.</span>
<a name="l00417"></a>00417       d.start = d.last = between(d.start, coordinates(e, t));
<a name="l00418"></a>00418 
<a name="l00419"></a>00419       <span class="comment">// If we transition into this state with a touchmove event,</span>
<a name="l00420"></a>00420       <span class="comment">// then process it with that handler. If we don&#39;t do this then</span>
<a name="l00421"></a>00421       <span class="comment">// we can end up with swipe events that don&#39;t know their velocity</span>
<a name="l00422"></a>00422       <span class="keywordflow">if</span> (e.type === <span class="stringliteral">&#39;touchmove&#39;</span>)
<a name="l00423"></a>00423         panStartedState.touchmove(d, e, t);
<a name="l00424"></a>00424     },
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     touchmove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00427"></a>00427       <span class="comment">// Ignore any fingers other than the one we&#39;re tracking</span>
<a name="l00428"></a>00428       <span class="keywordflow">if</span> (t.identifier !== d.touch1)
<a name="l00429"></a>00429         <span class="keywordflow">return</span>;
<a name="l00430"></a>00430 
<a name="l00431"></a>00431       <span class="comment">// Each time the touch moves, emit a pan event but stay in this state</span>
<a name="l00432"></a>00432       var current = coordinates(e, t);
<a name="l00433"></a>00433       d.emitEvent(<span class="stringliteral">&#39;pan&#39;</span>, {
<a name="l00434"></a>00434         <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: {
<a name="l00435"></a>00435           dx: current.screenX - d.start.screenX,
<a name="l00436"></a>00436           dy: current.screenY - d.start.screenY
<a name="l00437"></a>00437         },
<a name="l00438"></a>00438         relative: {
<a name="l00439"></a>00439           dx: current.screenX - d.last.screenX,
<a name="l00440"></a>00440           dy: current.screenY - d.last.screenY
<a name="l00441"></a>00441         },
<a name="l00442"></a>00442         <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>: current
<a name="l00443"></a>00443       });
<a name="l00444"></a>00444 
<a name="l00445"></a>00445       <span class="comment">// Track the pan velocity so we can report this with the swipe</span>
<a name="l00446"></a>00446       <span class="comment">// Use a exponential moving average for a bit of smoothing</span>
<a name="l00447"></a>00447       <span class="comment">// on the velocity</span>
<a name="l00448"></a>00448       var dt = current.timeStamp - d.last.timeStamp;
<a name="l00449"></a>00449       var vx = (current.screenX - d.last.screenX) / dt;
<a name="l00450"></a>00450       var vy = (current.screenY - d.last.screenY) / dt;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452       <span class="keywordflow">if</span> (d.vx == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) { <span class="comment">// first time; no average</span>
<a name="l00453"></a>00453         d.vx = vx;
<a name="l00454"></a>00454         d.vy = vy;
<a name="l00455"></a>00455       }
<a name="l00456"></a>00456       <span class="keywordflow">else</span> {
<a name="l00457"></a>00457         d.vx = d.vx * GD.VELOCITY_SMOOTHING +
<a name="l00458"></a>00458           vx * (1 - GD.VELOCITY_SMOOTHING);
<a name="l00459"></a>00459         d.vy = d.vy * GD.VELOCITY_SMOOTHING +
<a name="l00460"></a>00460           vy * (1 - GD.VELOCITY_SMOOTHING);
<a name="l00461"></a>00461       }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463       d.last = current;
<a name="l00464"></a>00464     },
<a name="l00465"></a>00465     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00466"></a>00466       <span class="comment">// Ignore any fingers other than the one we&#39;re tracking</span>
<a name="l00467"></a>00467       <span class="keywordflow">if</span> (t.identifier !== d.touch1)
<a name="l00468"></a>00468         <span class="keywordflow">return</span>;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470       <span class="comment">// Emit a swipe event when the finger goes up.</span>
<a name="l00471"></a>00471       <span class="comment">// Report start and end point, dx, dy, dt, velocity and direction</span>
<a name="l00472"></a>00472       var current = coordinates(e, t);
<a name="l00473"></a>00473       var dx = current.screenX - d.start.screenX;
<a name="l00474"></a>00474       var dy = current.screenY - d.start.screenY;
<a name="l00475"></a>00475       <span class="comment">// angle is a positive number of degrees, starting at 0 on the</span>
<a name="l00476"></a>00476       <span class="comment">// positive x axis and increasing clockwise.</span>
<a name="l00477"></a>00477       var angle = atan2(dy, dx) * 180 / PI;
<a name="l00478"></a>00478       <span class="keywordflow">if</span> (angle &lt; 0)
<a name="l00479"></a>00479         angle += 360;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481       <span class="comment">// Direction is &#39;right&#39;, &#39;down&#39;, &#39;left&#39; or &#39;up&#39;</span>
<a name="l00482"></a>00482       var <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>;
<a name="l00483"></a>00483       <span class="keywordflow">if</span> (angle &gt;= 315 || angle &lt; 45)
<a name="l00484"></a>00484         direction = <span class="stringliteral">&#39;right&#39;</span>;
<a name="l00485"></a>00485       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 45 &amp;&amp; angle &lt; 135)
<a name="l00486"></a>00486         direction = <span class="stringliteral">&#39;down&#39;</span>;
<a name="l00487"></a>00487       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 135 &amp;&amp; angle &lt; 225)
<a name="l00488"></a>00488         direction = <span class="stringliteral">&#39;left&#39;</span>;
<a name="l00489"></a>00489       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 225 &amp;&amp; angle &lt; 315)
<a name="l00490"></a>00490         direction = <span class="stringliteral">&#39;up&#39;</span>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492       d.emitEvent(<span class="stringliteral">&#39;swipe&#39;</span>, {
<a name="l00493"></a>00493         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: d.start,
<a name="l00494"></a>00494         <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: current,
<a name="l00495"></a>00495         dx: dx,
<a name="l00496"></a>00496         dy: dy,
<a name="l00497"></a>00497         dt: e.timeStamp - d.start.timeStamp,
<a name="l00498"></a>00498         vx: d.vx,
<a name="l00499"></a>00499         vy: d.vy,
<a name="l00500"></a>00500         direction: <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>,
<a name="l00501"></a>00501         angle: angle
<a name="l00502"></a>00502       });
<a name="l00503"></a>00503 
<a name="l00504"></a>00504       <span class="comment">// Go back to the initial state</span>
<a name="l00505"></a>00505       d.switchTo(initialState);
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507   };
<a name="l00508"></a>00508 
<a name="l00509"></a>00509   <span class="comment">// We enter this state if the user touches and holds for long enough</span>
<a name="l00510"></a>00510   <span class="comment">// without moving much.  When we enter we emit a holdstart event. Motion</span>
<a name="l00511"></a>00511   <span class="comment">// after the holdstart generates holdmove events. And when the touch ends</span>
<a name="l00512"></a>00512   <span class="comment">// we generate a holdend event. holdmove and holdend events can be used</span>
<a name="l00513"></a>00513   <span class="comment">// kind of like drag and drop events in a mouse-based UI. Currently,</span>
<a name="l00514"></a>00514   <span class="comment">// these events just report the coordinates of the touch.  Do we need</span>
<a name="l00515"></a>00515   <span class="comment">// other details?</span>
<a name="l00516"></a>00516   var holdState = {
<a name="l00517"></a>00517     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;holdState&#39;</span>,
<a name="l00518"></a>00518     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d) {
<a name="l00519"></a>00519       d.emitEvent(<span class="stringliteral">&#39;holdstart&#39;</span>, d.start);
<a name="l00520"></a>00520     },
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     touchmove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00523"></a>00523       var current = coordinates(e, t);
<a name="l00524"></a>00524       d.emitEvent(<span class="stringliteral">&#39;holdmove&#39;</span>, {
<a name="l00525"></a>00525         <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: {
<a name="l00526"></a>00526           dx: current.screenX - d.start.screenX,
<a name="l00527"></a>00527           dy: current.screenY - d.start.screenY
<a name="l00528"></a>00528         },
<a name="l00529"></a>00529         relative: {
<a name="l00530"></a>00530           dx: current.screenX - d.last.screenX,
<a name="l00531"></a>00531           dy: current.screenY - d.last.screenY
<a name="l00532"></a>00532         },
<a name="l00533"></a>00533         <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>: current
<a name="l00534"></a>00534       });
<a name="l00535"></a>00535 
<a name="l00536"></a>00536       d.last = current;
<a name="l00537"></a>00537     },
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00540"></a>00540       var current = coordinates(e, t);
<a name="l00541"></a>00541       d.emitEvent(<span class="stringliteral">&#39;holdend&#39;</span>, {
<a name="l00542"></a>00542         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: d.start,
<a name="l00543"></a>00543         <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: current,
<a name="l00544"></a>00544         dx: current.screenX - d.start.screenX,
<a name="l00545"></a>00545         dy: current.screenY - d.start.screenY
<a name="l00546"></a>00546       });
<a name="l00547"></a>00547       d.switchTo(initialState);
<a name="l00548"></a>00548     }
<a name="l00549"></a>00549   };
<a name="l00550"></a>00550 
<a name="l00551"></a>00551   <span class="comment">// We enter this state if a second touch starts before we start</span>
<a name="l00552"></a>00552   <span class="comment">// recoginzing any other gesture.  As the touches move we track the</span>
<a name="l00553"></a>00553   <span class="comment">// distance and angle between them to report scale and rotation values</span>
<a name="l00554"></a>00554   <span class="comment">// in transform events.</span>
<a name="l00555"></a>00555   var transformState = {
<a name="l00556"></a>00556     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;transformState&#39;</span>,
<a name="l00557"></a>00557     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00558"></a>00558       <span class="comment">// Remember the id of the second touch</span>
<a name="l00559"></a>00559       d.touch2 = t.identifier;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561       <span class="comment">// Get the two Touch objects</span>
<a name="l00562"></a>00562       var t1 = e.touches.identifiedTouch(d.touch1);
<a name="l00563"></a>00563       var t2 = e.touches.identifiedTouch(d.touch2);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565       <span class="comment">// Compute and remember the initial distance and angle</span>
<a name="l00566"></a>00566       d.startDistance = d.lastDistance = touchDistance(t1, t2);
<a name="l00567"></a>00567       d.startDirection = d.lastDirection = touchDirection(t1, t2);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569       <span class="comment">// Don&#39;t start emitting events until we&#39;re past a threshold</span>
<a name="l00570"></a>00570       d.scaled = d.rotated = <span class="keyword">false</span>;
<a name="l00571"></a>00571     },
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     touchmove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00574"></a>00574       <span class="comment">// Ignore touches we&#39;re not tracking</span>
<a name="l00575"></a>00575       <span class="keywordflow">if</span> (t.identifier !== d.touch1 &amp;&amp; t.identifier !== d.touch2)
<a name="l00576"></a>00576         <span class="keywordflow">return</span>;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578       <span class="comment">// Get the two Touch objects</span>
<a name="l00579"></a>00579       var t1 = e.touches.identifiedTouch(d.touch1);
<a name="l00580"></a>00580       var t2 = e.touches.identifiedTouch(d.touch2);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582       <span class="comment">// Compute the new midpoints, distance and direction</span>
<a name="l00583"></a>00583       var midpoint = midpoints(e, t1, t2);
<a name="l00584"></a>00584       var distance = touchDistance(t1, t2);
<a name="l00585"></a>00585       var <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a> = touchDirection(t1, t2);
<a name="l00586"></a>00586       var rotation = touchRotation(d.startDirection, direction);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588       <span class="comment">// Check all of these numbers against the thresholds. Otherwise</span>
<a name="l00589"></a>00589       <span class="comment">// the transforms are too jittery even when you try to hold your</span>
<a name="l00590"></a>00590       <span class="comment">// fingers still.</span>
<a name="l00591"></a>00591       <span class="keywordflow">if</span> (!d.scaled) {
<a name="l00592"></a>00592         <span class="keywordflow">if</span> (abs(distance - d.startDistance) &gt; GD.SCALE_THRESHOLD) {
<a name="l00593"></a>00593           d.scaled = <span class="keyword">true</span>;
<a name="l00594"></a>00594           d.startDistance = d.lastDistance =
<a name="l00595"></a>00595             floor(d.startDistance +
<a name="l00596"></a>00596                   GD.THRESHOLD_SMOOTHING * (distance - d.startDistance));
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598         <span class="keywordflow">else</span>
<a name="l00599"></a>00599           distance = d.startDistance;
<a name="l00600"></a>00600       }
<a name="l00601"></a>00601       <span class="keywordflow">if</span> (!d.rotated) {
<a name="l00602"></a>00602         <span class="keywordflow">if</span> (abs(rotation) &gt; GD.ROTATE_THRESHOLD)
<a name="l00603"></a>00603           d.rotated = <span class="keyword">true</span>;
<a name="l00604"></a>00604         <span class="keywordflow">else</span>
<a name="l00605"></a>00605           direction = d.startDirection;
<a name="l00606"></a>00606       }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608       <span class="comment">// If nothing has exceeded the threshold yet, then we</span>
<a name="l00609"></a>00609       <span class="comment">// don&#39;t even have to fire an event.</span>
<a name="l00610"></a>00610       <span class="keywordflow">if</span> (d.scaled || d.rotated) {
<a name="l00611"></a>00611         <span class="comment">// The detail field for the transform gesture event includes</span>
<a name="l00612"></a>00612         <span class="comment">// &#39;absolute&#39; transformations against the initial values and</span>
<a name="l00613"></a>00613         <span class="comment">// &#39;relative&#39; transformations against the values from the last</span>
<a name="l00614"></a>00614         <span class="comment">// transformgesture event.</span>
<a name="l00615"></a>00615         d.emitEvent(<span class="stringliteral">&#39;transform&#39;</span>, {
<a name="l00616"></a>00616           <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: { <span class="comment">// transform details since gesture start</span>
<a name="l00617"></a>00617             <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>: distance / d.startDistance,
<a name="l00618"></a>00618             <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>: touchRotation(d.startDirection, direction)
<a name="l00619"></a>00619           },
<a name="l00620"></a>00620           relative: { <span class="comment">// transform since last gesture change</span>
<a name="l00621"></a>00621             <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>: distance / d.lastDistance,
<a name="l00622"></a>00622             <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>: touchRotation(d.lastDirection, direction)
<a name="l00623"></a>00623           },
<a name="l00624"></a>00624           midpoint: midpoint
<a name="l00625"></a>00625         });
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         d.lastDistance = distance;
<a name="l00628"></a>00628         d.lastDirection = <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>;
<a name="l00629"></a>00629         d.lastMidpoint = midpoint;
<a name="l00630"></a>00630       }
<a name="l00631"></a>00631     },
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00634"></a>00634       <span class="comment">// If either finger goes up, we&#39;re done with the gesture.</span>
<a name="l00635"></a>00635       <span class="comment">// The user might move that finger and put it right back down</span>
<a name="l00636"></a>00636       <span class="comment">// again to begin another 2-finger gesture, so we can&#39;t go</span>
<a name="l00637"></a>00637       <span class="comment">// back to the initial state while one of the fingers remains up.</span>
<a name="l00638"></a>00638       <span class="comment">// On the other hand, we can&#39;t go back to touchStartedState because</span>
<a name="l00639"></a>00639       <span class="comment">// that would mean that the finger left down could cause a tap or</span>
<a name="l00640"></a>00640       <span class="comment">// pan event. So we need an afterTransform state that waits for</span>
<a name="l00641"></a>00641       <span class="comment">// a finger to come back down or the other finger to go up.</span>
<a name="l00642"></a>00642       <span class="keywordflow">if</span> (t.identifier === d.touch2)
<a name="l00643"></a>00643         d.touch2 = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00644"></a>00644       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t.identifier === d.touch1) {
<a name="l00645"></a>00645         d.touch1 = d.touch2;
<a name="l00646"></a>00646         d.touch2 = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00647"></a>00647       }
<a name="l00648"></a>00648       <span class="keywordflow">else</span>
<a name="l00649"></a>00649         <span class="keywordflow">return</span>; <span class="comment">// It was a touch we weren&#39;t tracking</span>
<a name="l00650"></a>00650 
<a name="l00651"></a>00651       <span class="comment">// If we emitted any transform events, now we need to emit</span>
<a name="l00652"></a>00652       <span class="comment">// a transformend event to end the series.  The details of this</span>
<a name="l00653"></a>00653       <span class="comment">// event use the values from the last touchmove, and the</span>
<a name="l00654"></a>00654       <span class="comment">// relative amounts will 1 and 0, but they are included for</span>
<a name="l00655"></a>00655       <span class="comment">// completeness even though they are not useful.</span>
<a name="l00656"></a>00656       <span class="keywordflow">if</span> (d.scaled || d.rotated) {
<a name="l00657"></a>00657         d.emitEvent(<span class="stringliteral">&#39;transformend&#39;</span>, {
<a name="l00658"></a>00658           <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: { <span class="comment">// transform details since gesture start</span>
<a name="l00659"></a>00659             <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>: d.lastDistance / d.startDistance,
<a name="l00660"></a>00660             <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>: touchRotation(d.startDirection, d.lastDirection)
<a name="l00661"></a>00661           },
<a name="l00662"></a>00662           relative: { <span class="comment">// nothing has changed relative to the last touchmove</span>
<a name="l00663"></a>00663             <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>: 1,
<a name="l00664"></a>00664             <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>: 0
<a name="l00665"></a>00665           },
<a name="l00666"></a>00666           midpoint: d.lastMidpoint
<a name="l00667"></a>00667         });
<a name="l00668"></a>00668       }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670       d.switchTo(afterTransformState);
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672   };
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="comment">// We did a tranform and one finger went up. Wait for that finger to</span>
<a name="l00675"></a>00675   <span class="comment">// come back down or the other finger to go up too.</span>
<a name="l00676"></a>00676   var afterTransformState = {
<a name="l00677"></a>00677     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;afterTransformState&#39;</span>,
<a name="l00678"></a>00678     touchstart: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00679"></a>00679       d.switchTo(transformState, e, t);
<a name="l00680"></a>00680     },
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l00683"></a>00683       <span class="keywordflow">if</span> (t.identifier === d.touch1)
<a name="l00684"></a>00684         d.switchTo(initialState);
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686   };
<a name="l00687"></a>00687 
<a name="l00688"></a>00688   var mouseDownState = {
<a name="l00689"></a>00689     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;mouseDownState&#39;</span>,
<a name="l00690"></a>00690     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00691"></a>00691       <span class="comment">// Remember the target of the event</span>
<a name="l00692"></a>00692       d.target = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.target;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694       <span class="comment">// Register this detector as a *capturing* handler on the document</span>
<a name="l00695"></a>00695       <span class="comment">// so we get all subsequent mouse events until we remove these handlers</span>
<a name="l00696"></a>00696       var doc = d.element.ownerDocument;
<a name="l00697"></a>00697       doc.addEventListener(<span class="stringliteral">&#39;mousemove&#39;</span>, d, <span class="keyword">true</span>);
<a name="l00698"></a>00698       doc.addEventListener(<span class="stringliteral">&#39;mouseup&#39;</span>, d, <span class="keyword">true</span>);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700       <span class="comment">// Get the coordinates of the mouse event</span>
<a name="l00701"></a>00701       d.start = d.last = mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00702"></a>00702 
<a name="l00703"></a>00703       <span class="comment">// Start a timer for a hold</span>
<a name="l00704"></a>00704       <span class="comment">// If we&#39;re doing hold events, start a timer for them</span>
<a name="l00705"></a>00705       <span class="keywordflow">if</span> (d.options.holdEvents)
<a name="l00706"></a>00706         d.startTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>, GD.HOLD_INTERVAL);
<a name="l00707"></a>00707     },
<a name="l00708"></a>00708 
<a name="l00709"></a>00709     mousemove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00710"></a>00710       <span class="comment">// If the mouse has moved more than the panning threshold,</span>
<a name="l00711"></a>00711       <span class="comment">// then switch to the mouse panning state. Otherwise remain</span>
<a name="l00712"></a>00712       <span class="comment">// in this state</span>
<a name="l00713"></a>00713 
<a name="l00714"></a>00714       <span class="keywordflow">if</span> (abs(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.screenX - d.start.screenX) &gt; GD.MOUSE_PAN_THRESHOLD ||
<a name="l00715"></a>00715           abs(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.screenY - d.start.screenY) &gt; GD.MOUSE_PAN_THRESHOLD) {
<a name="l00716"></a>00716         d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l00717"></a>00717         d.switchTo(mousePannedState, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00718"></a>00718       }
<a name="l00719"></a>00719     },
<a name="l00720"></a>00720 
<a name="l00721"></a>00721     mouseup: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00722"></a>00722       <span class="comment">// Remove the capturing event handlers</span>
<a name="l00723"></a>00723       var doc = d.element.ownerDocument;
<a name="l00724"></a>00724       doc.removeEventListener(<span class="stringliteral">&#39;mousemove&#39;</span>, d, <span class="keyword">true</span>);
<a name="l00725"></a>00725       doc.removeEventListener(<span class="stringliteral">&#39;mouseup&#39;</span>, d, <span class="keyword">true</span>);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727       <span class="comment">// If there was a previous tap that was close enough in time</span>
<a name="l00728"></a>00728       <span class="comment">// and space, then emit a &#39;dbltap&#39; event</span>
<a name="l00729"></a>00729       <span class="keywordflow">if</span> (d.lastTap &amp;&amp; isDoubleTap(d.lastTap, d.start)) {
<a name="l00730"></a>00730         d.emitEvent(<span class="stringliteral">&#39;tap&#39;</span>, d.start);
<a name="l00731"></a>00731         d.emitEvent(<span class="stringliteral">&#39;dbltap&#39;</span>, d.start);
<a name="l00732"></a>00732         d.lastTap = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>; <span class="comment">// so we don&#39;t get another one</span>
<a name="l00733"></a>00733       }
<a name="l00734"></a>00734       <span class="keywordflow">else</span> {
<a name="l00735"></a>00735         <span class="comment">// Emit a &#39;tap&#39; event using the starting coordinates</span>
<a name="l00736"></a>00736         <span class="comment">// as the event details</span>
<a name="l00737"></a>00737         d.emitEvent(<span class="stringliteral">&#39;tap&#39;</span>, d.start);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         <span class="comment">// Remember the coordinates of this tap so we can detect double taps</span>
<a name="l00740"></a>00740         d.lastTap = mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00741"></a>00741       }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743       <span class="comment">// In either case clear the timer and go back to the initial state</span>
<a name="l00744"></a>00744       d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l00745"></a>00745       d.switchTo(initialState);
<a name="l00746"></a>00746     },
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     holdtimeout: <span class="keyword">function</span>(d) {
<a name="l00749"></a>00749       d.switchTo(mouseHoldState);
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751   };
<a name="l00752"></a>00752 
<a name="l00753"></a>00753   <span class="comment">// Like holdState, but for mouse events instead of touch events</span>
<a name="l00754"></a>00754   var mouseHoldState = {
<a name="l00755"></a>00755     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;mouseHoldState&#39;</span>,
<a name="l00756"></a>00756     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d) {
<a name="l00757"></a>00757       d.emitEvent(<span class="stringliteral">&#39;holdstart&#39;</span>, d.start);
<a name="l00758"></a>00758     },
<a name="l00759"></a>00759 
<a name="l00760"></a>00760     mousemove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00761"></a>00761       var current = mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00762"></a>00762       d.emitEvent(<span class="stringliteral">&#39;holdmove&#39;</span>, {
<a name="l00763"></a>00763         <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: {
<a name="l00764"></a>00764           dx: current.screenX - d.start.screenX,
<a name="l00765"></a>00765           dy: current.screenY - d.start.screenY
<a name="l00766"></a>00766         },
<a name="l00767"></a>00767         relative: {
<a name="l00768"></a>00768           dx: current.screenX - d.last.screenX,
<a name="l00769"></a>00769           dy: current.screenY - d.last.screenY
<a name="l00770"></a>00770         },
<a name="l00771"></a>00771         <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>: current
<a name="l00772"></a>00772       });
<a name="l00773"></a>00773 
<a name="l00774"></a>00774       d.last = current;
<a name="l00775"></a>00775     },
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     mouseup: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00778"></a>00778       var current = mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00779"></a>00779       d.emitEvent(<span class="stringliteral">&#39;holdend&#39;</span>, {
<a name="l00780"></a>00780         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: d.start,
<a name="l00781"></a>00781         <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: current,
<a name="l00782"></a>00782         dx: current.screenX - d.start.screenX,
<a name="l00783"></a>00783         dy: current.screenY - d.start.screenY
<a name="l00784"></a>00784       });
<a name="l00785"></a>00785       d.switchTo(initialState);
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787   };
<a name="l00788"></a>00788 
<a name="l00789"></a>00789   var mousePannedState = {
<a name="l00790"></a>00790     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;mousePannedState&#39;</span>,
<a name="l00791"></a>00791     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00792"></a>00792       <span class="comment">// Panning doesn&#39;t start until the mouse has moved more than</span>
<a name="l00793"></a>00793       <span class="comment">// a certain threshold. But we don&#39;t want the pan to have a jerky</span>
<a name="l00794"></a>00794       <span class="comment">// start where the first event is a big distance. So reset the</span>
<a name="l00795"></a>00795       <span class="comment">// starting point to a point between the start point and this</span>
<a name="l00796"></a>00796       <span class="comment">// current point</span>
<a name="l00797"></a>00797       d.start = d.last = between(d.start, mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>));
<a name="l00798"></a>00798 
<a name="l00799"></a>00799       <span class="comment">// If we transition into this state with a mousemove event,</span>
<a name="l00800"></a>00800       <span class="comment">// then process it with that handler. If we don&#39;t do this then</span>
<a name="l00801"></a>00801       <span class="comment">// we can end up with swipe events that don&#39;t know their velocity</span>
<a name="l00802"></a>00802       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.type === <span class="stringliteral">&#39;mousemove&#39;</span>)
<a name="l00803"></a>00803         mousePannedState.mousemove(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00804"></a>00804     },
<a name="l00805"></a>00805     mousemove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00806"></a>00806       <span class="comment">// Each time the mouse moves, emit a pan event but stay in this state</span>
<a name="l00807"></a>00807       var current = mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00808"></a>00808       d.emitEvent(<span class="stringliteral">&#39;pan&#39;</span>, {
<a name="l00809"></a>00809         <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: {
<a name="l00810"></a>00810           dx: current.screenX - d.start.screenX,
<a name="l00811"></a>00811           dy: current.screenY - d.start.screenY
<a name="l00812"></a>00812         },
<a name="l00813"></a>00813         relative: {
<a name="l00814"></a>00814           dx: current.screenX - d.last.screenX,
<a name="l00815"></a>00815           dy: current.screenY - d.last.screenY
<a name="l00816"></a>00816         },
<a name="l00817"></a>00817         <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>: current
<a name="l00818"></a>00818       });
<a name="l00819"></a>00819 
<a name="l00820"></a>00820       <span class="comment">// Track the pan velocity so we can report this with the swipe</span>
<a name="l00821"></a>00821       <span class="comment">// Use a exponential moving average for a bit of smoothing</span>
<a name="l00822"></a>00822       <span class="comment">// on the velocity</span>
<a name="l00823"></a>00823       var dt = current.timeStamp - d.last.timeStamp;
<a name="l00824"></a>00824       var vx = (current.screenX - d.last.screenX) / dt;
<a name="l00825"></a>00825       var vy = (current.screenY - d.last.screenY) / dt;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827       <span class="keywordflow">if</span> (d.vx == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) { <span class="comment">// first time; no average</span>
<a name="l00828"></a>00828         d.vx = vx;
<a name="l00829"></a>00829         d.vy = vy;
<a name="l00830"></a>00830       }
<a name="l00831"></a>00831       <span class="keywordflow">else</span> {
<a name="l00832"></a>00832         d.vx = d.vx * GD.VELOCITY_SMOOTHING +
<a name="l00833"></a>00833           vx * (1 - GD.VELOCITY_SMOOTHING);
<a name="l00834"></a>00834         d.vy = d.vy * GD.VELOCITY_SMOOTHING +
<a name="l00835"></a>00835           vy * (1 - GD.VELOCITY_SMOOTHING);
<a name="l00836"></a>00836       }
<a name="l00837"></a>00837 
<a name="l00838"></a>00838       d.last = current;
<a name="l00839"></a>00839     },
<a name="l00840"></a>00840     mouseup: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00841"></a>00841       <span class="comment">// Remove the capturing event handlers</span>
<a name="l00842"></a>00842       var doc = d.element.ownerDocument;
<a name="l00843"></a>00843       doc.removeEventListener(<span class="stringliteral">&#39;mousemove&#39;</span>, d, <span class="keyword">true</span>);
<a name="l00844"></a>00844       doc.removeEventListener(<span class="stringliteral">&#39;mouseup&#39;</span>, d, <span class="keyword">true</span>);
<a name="l00845"></a>00845 
<a name="l00846"></a>00846       <span class="comment">// Emit a swipe event when the mouse goes up.</span>
<a name="l00847"></a>00847       <span class="comment">// Report start and end point, dx, dy, dt, velocity and direction</span>
<a name="l00848"></a>00848       var current = mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00849"></a>00849 
<a name="l00850"></a>00850       <span class="comment">// FIXME:</span>
<a name="l00851"></a>00851       <span class="comment">// lots of code duplicated between this state and the corresponding</span>
<a name="l00852"></a>00852       <span class="comment">// touch state, can I combine them somehow?</span>
<a name="l00853"></a>00853       var dx = current.screenX - d.start.screenX;
<a name="l00854"></a>00854       var dy = current.screenY - d.start.screenY;
<a name="l00855"></a>00855       <span class="comment">// angle is a positive number of degrees, starting at 0 on the</span>
<a name="l00856"></a>00856       <span class="comment">// positive x axis and increasing clockwise.</span>
<a name="l00857"></a>00857       var angle = atan2(dy, dx) * 180 / PI;
<a name="l00858"></a>00858       <span class="keywordflow">if</span> (angle &lt; 0)
<a name="l00859"></a>00859         angle += 360;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861       <span class="comment">// Direction is &#39;right&#39;, &#39;down&#39;, &#39;left&#39; or &#39;up&#39;</span>
<a name="l00862"></a>00862       var <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>;
<a name="l00863"></a>00863       <span class="keywordflow">if</span> (angle &gt;= 315 || angle &lt; 45)
<a name="l00864"></a>00864         direction = <span class="stringliteral">&#39;right&#39;</span>;
<a name="l00865"></a>00865       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 45 &amp;&amp; angle &lt; 135)
<a name="l00866"></a>00866         direction = <span class="stringliteral">&#39;down&#39;</span>;
<a name="l00867"></a>00867       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 135 &amp;&amp; angle &lt; 225)
<a name="l00868"></a>00868         direction = <span class="stringliteral">&#39;left&#39;</span>;
<a name="l00869"></a>00869       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 225 &amp;&amp; angle &lt; 315)
<a name="l00870"></a>00870         direction = <span class="stringliteral">&#39;up&#39;</span>;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872       d.emitEvent(<span class="stringliteral">&#39;swipe&#39;</span>, {
<a name="l00873"></a>00873         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: d.start,
<a name="l00874"></a>00874         <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: current,
<a name="l00875"></a>00875         dx: dx,
<a name="l00876"></a>00876         dy: dy,
<a name="l00877"></a>00877         dt: current.timeStamp - d.start.timeStamp,
<a name="l00878"></a>00878         vx: d.vx,
<a name="l00879"></a>00879         vy: d.vy,
<a name="l00880"></a>00880         direction: <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>,
<a name="l00881"></a>00881         angle: angle
<a name="l00882"></a>00882       });
<a name="l00883"></a>00883 
<a name="l00884"></a>00884       <span class="comment">// Go back to the initial state</span>
<a name="l00885"></a>00885       d.switchTo(initialState);
<a name="l00886"></a>00886     }
<a name="l00887"></a>00887   };
<a name="l00888"></a>00888 
<a name="l00889"></a>00889   <span class="keywordflow">return</span> GD;
<a name="l00890"></a>00890 }());
<a name="l00891"></a>00891 
<a name="l00892"></a>00892 <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 <span class="comment">//</span>
<a name="l00895"></a>00895 <span class="comment">// Create a &lt;video&gt; element and  &lt;div&gt; containing a video player UI and</span>
<a name="l00896"></a>00896 <span class="comment">// add them to the specified container. The UI requires a GestureDetector</span>
<a name="l00897"></a>00897 <span class="comment">// to be running for the container or one of its ancestors.</span>
<a name="l00898"></a>00898 <span class="comment">//</span>
<a name="l00899"></a>00899 <span class="comment">// Some devices have only a single hardware video decoder and can only</span>
<a name="l00900"></a>00900 <span class="comment">// have one video tag playing anywhere at once. So this class is careful</span>
<a name="l00901"></a>00901 <span class="comment">// to only load content into a &lt;video&gt; element when the user really wants</span>
<a name="l00902"></a>00902 <span class="comment">// to play it. At other times it displays a poster image for the video.</span>
<a name="l00903"></a>00903 <span class="comment">// Initially, it displays the poster image. Pressing play starts the video.</span>
<a name="l00904"></a>00904 <span class="comment">// Pausing pauses the video but does not revert to the poster. Finishing the</span>
<a name="l00905"></a>00905 <span class="comment">// video reverts to the initial state with the poster image displayed.</span>
<a name="l00906"></a>00906 <span class="comment">// If we get a visiblitychange event saying that we&#39;ve been hidden, we</span>
<a name="l00907"></a>00907 <span class="comment">// remember the playback position, pause the video take a temporary</span>
<a name="l00908"></a>00908 <span class="comment">// screenshot and display it, and unload the video. If shown again</span>
<a name="l00909"></a>00909 <span class="comment">// and if the user clicks play again, we resume the video where we left off.</span>
<a name="l00910"></a>00910 <span class="comment">//</span>
<a name="l00911"></a>00911 <span class="keyword">function</span> <a class="code" href="../../db/dcd/build__stage_2email_2shared_2js_2media_2video__player_8js.html#a612b58b49e6b99cf1229b3c371d5f684">VideoPlayer</a>(<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>) {
<a name="l00912"></a>00912   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a> === <span class="stringliteral">&#39;string&#39;</span>)
<a name="l00913"></a>00913     <a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a> = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementById(<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>);
<a name="l00914"></a>00914 
<a name="l00915"></a>00915   <span class="keyword">function</span> newelt(<a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, classes) {
<a name="l00916"></a>00916     var <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a> = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createElement(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>);
<a name="l00917"></a>00917     <span class="keywordflow">if</span> (classes)
<a name="l00918"></a>00918       e.className = classes;
<a name="l00919"></a>00919     <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.appendChild(e);
<a name="l00920"></a>00920     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>;
<a name="l00921"></a>00921   }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923   <span class="comment">// This copies the controls structure of the Video app</span>
<a name="l00924"></a>00924   var poster = newelt(<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>, <span class="stringliteral">&#39;img&#39;</span>, <span class="stringliteral">&#39;videoPoster&#39;</span>);
<a name="l00925"></a>00925   var player = newelt(<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>, <span class="stringliteral">&#39;video&#39;</span>, <span class="stringliteral">&#39;videoPlayer&#39;</span>);
<a name="l00926"></a>00926   var controls = newelt(<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>, <span class="stringliteral">&#39;div&#39;</span>, <span class="stringliteral">&#39;videoPlayerControls&#39;</span>);
<a name="l00927"></a>00927   var playbutton = newelt(controls, <span class="stringliteral">&#39;button&#39;</span>, <span class="stringliteral">&#39;videoPlayerPlayButton&#39;</span>);
<a name="l00928"></a>00928   var <a class="code" href="../../de/dd3/form__test_8js.html#a87728fbcad5f3090ecaa69a5db1cc729">footer</a> = newelt(controls, <span class="stringliteral">&#39;div&#39;</span>, <span class="stringliteral">&#39;videoPlayerFooter hidden&#39;</span>);
<a name="l00929"></a>00929   var pausebutton = newelt(footer, <span class="stringliteral">&#39;button&#39;</span>, <span class="stringliteral">&#39;videoPlayerPauseButton&#39;</span>);
<a name="l00930"></a>00930   var slider = newelt(footer, <span class="stringliteral">&#39;div&#39;</span>, <span class="stringliteral">&#39;videoPlayerSlider&#39;</span>);
<a name="l00931"></a>00931   var elapsedText = newelt(slider, <span class="stringliteral">&#39;span&#39;</span>, <span class="stringliteral">&#39;videoPlayerElapsedText&#39;</span>);
<a name="l00932"></a>00932   var progress = newelt(slider, <span class="stringliteral">&#39;div&#39;</span>, <span class="stringliteral">&#39;videoPlayerProgress&#39;</span>);
<a name="l00933"></a>00933   var backgroundBar = newelt(progress, <span class="stringliteral">&#39;div&#39;</span>, <span class="stringliteral">&#39;videoPlayerBackgroundBar&#39;</span>);
<a name="l00934"></a>00934   var elapsedBar = newelt(progress, <span class="stringliteral">&#39;div&#39;</span>, <span class="stringliteral">&#39;videoPlayerElapsedBar&#39;</span>);
<a name="l00935"></a>00935   var playHead = newelt(progress, <span class="stringliteral">&#39;div&#39;</span>, <span class="stringliteral">&#39;videoPlayerPlayHead&#39;</span>);
<a name="l00936"></a>00936   var durationText = newelt(slider, <span class="stringliteral">&#39;span&#39;</span>, <span class="stringliteral">&#39;videoPlayerDurationText&#39;</span>);
<a name="l00937"></a>00937 
<a name="l00938"></a>00938   this.poster = poster;
<a name="l00939"></a>00939   this.player = player;
<a name="l00940"></a>00940   this.controls = controls;
<a name="l00941"></a>00941   this.<a class="code" href="../../dd/d85/video_8js.html#a94c97cb13c4f819c09fd655f35f2df55">playing</a> = <span class="keyword">false</span>;
<a name="l00942"></a>00942 
<a name="l00943"></a>00943   player.preload = <span class="stringliteral">&#39;metadata&#39;</span>;
<a name="l00944"></a>00944   player.mozAudioChannelType = <span class="stringliteral">&#39;content&#39;</span>;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00947"></a>00947   var controlsHidden = <span class="keyword">false</span>;
<a name="l00948"></a>00948   var <a class="code" href="../../dd/d85/video_8js.html#a4d06d98bcf0d4fd805fdc31f0ea43b4f">dragging</a> = <span class="keyword">false</span>;
<a name="l00949"></a>00949   var pausedBeforeDragging = <span class="keyword">false</span>;
<a name="l00950"></a>00950   var <a class="code" href="../../dd/d85/video_8js.html#aab8bb414ba26a7881b7c795b8ff153fa">endedTimer</a>;
<a name="l00951"></a>00951   var videourl;   <span class="comment">// the url of the video to play</span>
<a name="l00952"></a>00952   var posterurl;  <span class="comment">// the url of the poster image to display</span>
<a name="l00953"></a>00953   var rotation;   <span class="comment">// Do we have to rotate the video? Set by load()</span>
<a name="l00954"></a>00954   var orientation = 0; <span class="comment">// current player orientation</span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956   <span class="comment">// These are the raw (unrotated) size of the poster image, which</span>
<a name="l00957"></a>00957   <span class="comment">// must have the same size as the video.</span>
<a name="l00958"></a>00958   var videowidth, videoheight;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960   var playbackTime;
<a name="l00961"></a>00961   var capturedFrame;
<a name="l00962"></a>00962 
<a name="l00963"></a>00963   this.<a class="code" href="../../db/d6b/make__gaia__shared_8js.html#ac5aa547163f784b68be607a47eb170b1">load</a> = <span class="keyword">function</span>(video, posterimage, <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>, <a class="code" href="../../d4/d8c/viewphoto_8js.html#a06f7a63ceb91351a4c31800c9a7af42f">height</a>, <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>) {
<a name="l00964"></a>00964     this.<a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a>();
<a name="l00965"></a>00965     videourl = video;
<a name="l00966"></a>00966     posterurl = posterimage;
<a name="l00967"></a>00967     rotation = <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a> || 0;
<a name="l00968"></a>00968     videowidth = <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>;
<a name="l00969"></a>00969     videoheight = <a class="code" href="../../d4/d8c/viewphoto_8js.html#a06f7a63ceb91351a4c31800c9a7af42f">height</a>;
<a name="l00970"></a>00970     this.<a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>();
<a name="l00971"></a>00971     <a class="code" href="../../dd/d85/video_8js.html#a80f1ea9fbe384f49287a314810c41138">setPlayerSize</a>();
<a name="l00972"></a>00972   };
<a name="l00973"></a>00973 
<a name="l00974"></a>00974   this.<a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a> = <span class="keyword">function</span>() {
<a name="l00975"></a>00975     <a class="code" href="../../dd/d85/video_8js.html#a87871aceb087d64a0527f9a89eb07e37">hidePlayer</a>();
<a name="l00976"></a>00976     hidePoster();
<a name="l00977"></a>00977   };
<a name="l00978"></a>00978 
<a name="l00979"></a>00979   this.<a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a> = <span class="keyword">function</span>() {
<a name="l00980"></a>00980     playbackTime = 0;
<a name="l00981"></a>00981     <a class="code" href="../../dd/d85/video_8js.html#a87871aceb087d64a0527f9a89eb07e37">hidePlayer</a>();
<a name="l00982"></a>00982     showPoster();
<a name="l00983"></a>00983     this.<a class="code" href="../../d2/da5/camera_2test_2unit_2mock__audio_8js.html#a5816189df258fa7e9c0632313e8c1fdb">pause</a>();
<a name="l00984"></a>00984   };
<a name="l00985"></a>00985 
<a name="l00986"></a>00986   <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#a87871aceb087d64a0527f9a89eb07e37">hidePlayer</a>() {
<a name="l00987"></a>00987     player.style.display = <span class="stringliteral">&#39;none&#39;</span>;
<a name="l00988"></a>00988     player.removeAttribute(<span class="stringliteral">&#39;src&#39;</span>);
<a name="l00989"></a>00989     player.load();
<a name="l00990"></a>00990     <span class="keyword">self</span>.playerShowing = <span class="keyword">false</span>;
<a name="l00991"></a>00991   }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993   <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#a15d44776569f9fc347277fd6f43910f7">showPlayer</a>() {
<a name="l00994"></a>00994     player.style.display = <span class="stringliteral">&#39;block&#39;</span>;
<a name="l00995"></a>00995     player.src = videourl;
<a name="l00996"></a>00996     <span class="keyword">self</span>.playerShowing = <span class="keyword">true</span>;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998     <span class="comment">// The only place we call showPlayer() is from the play() function.</span>
<a name="l00999"></a>00999     <span class="comment">// If play() has to show the player, call it again when we&#39;re ready to play.</span>
<a name="l01000"></a>01000     player.oncanplay = <span class="keyword">function</span>() {
<a name="l01001"></a>01001       player.oncanplay = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01002"></a>01002       <span class="keywordflow">if</span> (playbackTime !== 0) {
<a name="l01003"></a>01003         player.currentTime = playbackTime;
<a name="l01004"></a>01004       }
<a name="l01005"></a>01005       <span class="keyword">self</span>.play();
<a name="l01006"></a>01006     };
<a name="l01007"></a>01007   }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009   <span class="keyword">function</span> hidePoster() {
<a name="l01010"></a>01010     poster.style.display = <span class="stringliteral">&#39;none&#39;</span>;
<a name="l01011"></a>01011     poster.removeAttribute(<span class="stringliteral">&#39;src&#39;</span>);
<a name="l01012"></a>01012     <span class="keywordflow">if</span> (capturedFrame) {
<a name="l01013"></a>01013       <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.revokeObjectURL(capturedFrame);
<a name="l01014"></a>01014       capturedFrame = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01015"></a>01015     }
<a name="l01016"></a>01016   }
<a name="l01017"></a>01017 
<a name="l01018"></a>01018   <span class="keyword">function</span> showPoster() {
<a name="l01019"></a>01019     poster.style.display = <span class="stringliteral">&#39;block&#39;</span>;
<a name="l01020"></a>01020     <span class="keywordflow">if</span> (capturedFrame)
<a name="l01021"></a>01021       poster.src = capturedFrame;
<a name="l01022"></a>01022     <span class="keywordflow">else</span>
<a name="l01023"></a>01023       poster.src = posterurl;
<a name="l01024"></a>01024   }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026   <span class="comment">// Call this when the container size changes</span>
<a name="l01027"></a>01027   this.<a class="code" href="../../dd/d85/video_8js.html#a80f1ea9fbe384f49287a314810c41138">setPlayerSize</a> = <a class="code" href="../../dd/d85/video_8js.html#a80f1ea9fbe384f49287a314810c41138">setPlayerSize</a>;
<a name="l01028"></a>01028 
<a name="l01029"></a>01029   <span class="comment">// Call this when phone orientation changes</span>
<a name="l01030"></a>01030   this.setPlayerOrientation = setPlayerOrientation;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032   this.<a class="code" href="../../d2/da5/camera_2test_2unit_2mock__audio_8js.html#a5816189df258fa7e9c0632313e8c1fdb">pause</a> = <span class="keyword">function</span> <a class="code" href="../../d2/da5/camera_2test_2unit_2mock__audio_8js.html#a5816189df258fa7e9c0632313e8c1fdb">pause</a>() {
<a name="l01033"></a>01033     <span class="comment">// Pause video playback</span>
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (<span class="keyword">self</span>.<a class="code" href="../../dd/d85/video_8js.html#a0b2c4e51d38b8cb42e68439b68d4b800">playerShowing</a>) {
<a name="l01035"></a>01035       this.<a class="code" href="../../dd/d85/video_8js.html#a94c97cb13c4f819c09fd655f35f2df55">playing</a> = <span class="keyword">false</span>;
<a name="l01036"></a>01036       player.pause();
<a name="l01037"></a>01037     }
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <span class="comment">// Hide the pause button and slider</span>
<a name="l01040"></a>01040     footer.classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01041"></a>01041     controlsHidden = <span class="keyword">true</span>;
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <span class="comment">// Show the big central play button</span>
<a name="l01044"></a>01044     playbutton.classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046     <span class="keywordflow">if</span> (this.<a class="code" href="../../d8/df0/frames_8js.html#ac0b05bd6affaca2ff2591510eb1c54eb">onpaused</a>)
<a name="l01047"></a>01047       this.<a class="code" href="../../d8/df0/frames_8js.html#ac0b05bd6affaca2ff2591510eb1c54eb">onpaused</a>();
<a name="l01048"></a>01048   };
<a name="l01049"></a>01049 
<a name="l01050"></a>01050   <span class="comment">// Set up the playing state</span>
<a name="l01051"></a>01051   this.<a class="code" href="../../d2/da5/camera_2test_2unit_2mock__audio_8js.html#a7ee333c65a8edcc0df04e817ffc9cb5c">play</a> = <span class="keyword">function</span> <a class="code" href="../../d2/da5/camera_2test_2unit_2mock__audio_8js.html#a7ee333c65a8edcc0df04e817ffc9cb5c">play</a>() {
<a name="l01052"></a>01052     <span class="keywordflow">if</span> (!this.<a class="code" href="../../dd/d85/video_8js.html#a0b2c4e51d38b8cb42e68439b68d4b800">playerShowing</a>) {
<a name="l01053"></a>01053       <span class="comment">// If we&#39;re displaying the poster image, we have to switch</span>
<a name="l01054"></a>01054       <span class="comment">// to the player first. When the player is ready it wil call this</span>
<a name="l01055"></a>01055       <span class="comment">// function again.</span>
<a name="l01056"></a>01056       hidePoster();
<a name="l01057"></a>01057       <a class="code" href="../../dd/d85/video_8js.html#a15d44776569f9fc347277fd6f43910f7">showPlayer</a>();
<a name="l01058"></a>01058       <span class="keywordflow">return</span>;
<a name="l01059"></a>01059     }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     this.<a class="code" href="../../dd/d85/video_8js.html#a94c97cb13c4f819c09fd655f35f2df55">playing</a> = <span class="keyword">true</span>;
<a name="l01062"></a>01062 
<a name="l01063"></a>01063     <span class="comment">// Start playing the video</span>
<a name="l01064"></a>01064     player.play();
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <span class="comment">// Hide the play button</span>
<a name="l01067"></a>01067     playbutton.classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01068"></a>01068 
<a name="l01069"></a>01069     <span class="comment">// Show the controls</span>
<a name="l01070"></a>01070     footer.classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01071"></a>01071     controlsHidden = <span class="keyword">false</span>;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="keywordflow">if</span> (this.<a class="code" href="../../d8/df0/frames_8js.html#ab48698037688f9874f2cc4d31bbf3c87">onplaying</a>)
<a name="l01074"></a>01074       this.<a class="code" href="../../d8/df0/frames_8js.html#ab48698037688f9874f2cc4d31bbf3c87">onplaying</a>();
<a name="l01075"></a>01075   };
<a name="l01076"></a>01076 
<a name="l01077"></a>01077   <span class="comment">// Hook up the play button</span>
<a name="l01078"></a>01078   playbutton.addEventListener(<span class="stringliteral">&#39;tap&#39;</span>, <span class="keyword">function</span>(e) {
<a name="l01079"></a>01079     <span class="comment">// If we&#39;re not showing the player or are paused, go to the play state</span>
<a name="l01080"></a>01080     <span class="keywordflow">if</span> (!<span class="keyword">self</span>.<a class="code" href="../../dd/d85/video_8js.html#a0b2c4e51d38b8cb42e68439b68d4b800">playerShowing</a> || player.paused) {
<a name="l01081"></a>01081       <span class="keyword">self</span>.play();
<a name="l01082"></a>01082     }
<a name="l01083"></a>01083     e.stopPropagation();
<a name="l01084"></a>01084   });
<a name="l01085"></a>01085 
<a name="l01086"></a>01086   <span class="comment">// Hook up the pause button</span>
<a name="l01087"></a>01087   pausebutton.addEventListener(<span class="stringliteral">&#39;tap&#39;</span>, <span class="keyword">function</span>(e) {
<a name="l01088"></a>01088     <span class="keyword">self</span>.pause();
<a name="l01089"></a>01089     e.stopPropagation();
<a name="l01090"></a>01090   });
<a name="l01091"></a>01091 
<a name="l01092"></a>01092   <span class="comment">// A click anywhere else on the screen should toggle the footer</span>
<a name="l01093"></a>01093   <span class="comment">// But only when the video is playing.</span>
<a name="l01094"></a>01094   controls.addEventListener(<span class="stringliteral">&#39;tap&#39;</span>, <span class="keyword">function</span>(e) {
<a name="l01095"></a>01095     <span class="keywordflow">if</span> (e.target === controls &amp;&amp; !player.paused) {
<a name="l01096"></a>01096       footer.classList.toggle(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01097"></a>01097       controlsHidden = !controlsHidden;
<a name="l01098"></a>01098     }
<a name="l01099"></a>01099   });
<a name="l01100"></a>01100 
<a name="l01101"></a>01101   <span class="comment">// Set the video duration when we get metadata</span>
<a name="l01102"></a>01102   player.onloadedmetadata = <span class="keyword">function</span>() {
<a name="l01103"></a>01103     durationText.textContent = formatTime(player.duration);
<a name="l01104"></a>01104     <span class="comment">// start off in the paused state</span>
<a name="l01105"></a>01105     <span class="keyword">self</span>.pause();
<a name="l01106"></a>01106   };
<a name="l01107"></a>01107 
<a name="l01108"></a>01108   <span class="comment">// Also resize the player on a resize event</span>
<a name="l01109"></a>01109   <span class="comment">// (when the user rotates the phone)</span>
<a name="l01110"></a>01110   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;resize&#39;</span>, <span class="keyword">function</span>() {
<a name="l01111"></a>01111     <a class="code" href="../../dd/d85/video_8js.html#a80f1ea9fbe384f49287a314810c41138">setPlayerSize</a>();
<a name="l01112"></a>01112   });
<a name="l01113"></a>01113 
<a name="l01114"></a>01114   <span class="comment">// If we reach the end of a video, reset to beginning</span>
<a name="l01115"></a>01115   <span class="comment">// This isn&#39;t always reliable, so we also set a timer in updateTime()</span>
<a name="l01116"></a>01116   player.onended = ended;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118   <span class="keyword">function</span> ended() {
<a name="l01119"></a>01119     <span class="keywordflow">if</span> (dragging)
<a name="l01120"></a>01120       <span class="keywordflow">return</span>;
<a name="l01121"></a>01121     <span class="keywordflow">if</span> (endedTimer) {
<a name="l01122"></a>01122       <a class="code" href="../../da/da1/timers_8js.html#ab37ff0db33a3bf80b0163adc40a58424">clearTimeout</a>(endedTimer);
<a name="l01123"></a>01123       endedTimer = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125     <span class="keyword">self</span>.pause();
<a name="l01126"></a>01126     <span class="keyword">self</span>.init();
<a name="l01127"></a>01127   };
<a name="l01128"></a>01128 
<a name="l01129"></a>01129   <span class="comment">// Update the slider and elapsed time as the video plays</span>
<a name="l01130"></a>01130   player.ontimeupdate = updateTime;
<a name="l01131"></a>01131 
<a name="l01132"></a>01132   <span class="comment">// Set the elapsed time and slider position</span>
<a name="l01133"></a>01133   <span class="keyword">function</span> updateTime() {
<a name="l01134"></a>01134     <span class="keywordflow">if</span> (!controlsHidden) {
<a name="l01135"></a>01135       elapsedText.textContent = formatTime(player.currentTime);
<a name="l01136"></a>01136 
<a name="l01137"></a>01137       <span class="comment">// We can&#39;t update a progress bar if we don&#39;t know how long</span>
<a name="l01138"></a>01138       <span class="comment">// the video is. It is kind of a bug that the &lt;video&gt; element</span>
<a name="l01139"></a>01139       <span class="comment">// can&#39;t figure this out for ogv videos.</span>
<a name="l01140"></a>01140       <span class="keywordflow">if</span> (player.duration === <a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a1b0bebbb829f5b272171927a1b7adfbe">Infinity</a> || player.duration === 0)
<a name="l01141"></a>01141         <span class="keywordflow">return</span>;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143       var percent = (player.currentTime / player.duration) * 100 + <span class="charliteral">&#39;%&#39;</span>;
<a name="l01144"></a>01144       elapsedBar.style.width = percent;
<a name="l01145"></a>01145       playHead.style.left = percent;
<a name="l01146"></a>01146     }
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     <span class="comment">// Since we don&#39;t always get reliable &#39;ended&#39; events, see if</span>
<a name="l01149"></a>01149     <span class="comment">// we&#39;ve reached the end this way.</span>
<a name="l01150"></a>01150     <span class="comment">// See: https://bugzilla.mozilla.org/show_bug.cgi?id=783512</span>
<a name="l01151"></a>01151     <span class="comment">// If we&#39;re within 1 second of the end of the video, register</span>
<a name="l01152"></a>01152     <span class="comment">// a timeout a half a second after we&#39;d expect an ended event.</span>
<a name="l01153"></a>01153     <span class="keywordflow">if</span> (!endedTimer) {
<a name="l01154"></a>01154       <span class="keywordflow">if</span> (!dragging &amp;&amp; player.currentTime &gt;= player.duration - 1) {
<a name="l01155"></a>01155         var timeUntilEnd = (player.duration - player.currentTime + .5);
<a name="l01156"></a>01156         endedTimer = <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(ended, timeUntilEnd * 1000);
<a name="l01157"></a>01157       }
<a name="l01158"></a>01158     }
<a name="l01159"></a>01159     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dragging &amp;&amp; player.currentTime &lt; player.duration - 1) {
<a name="l01160"></a>01160       <span class="comment">// If there is a timer set and we drag away from the end, cancel the timer</span>
<a name="l01161"></a>01161       <a class="code" href="../../da/da1/timers_8js.html#ab37ff0db33a3bf80b0163adc40a58424">clearTimeout</a>(endedTimer);
<a name="l01162"></a>01162       endedTimer = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01163"></a>01163     }
<a name="l01164"></a>01164   }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166   <span class="comment">// Pause and unload the video if we&#39;re hidden so that other apps</span>
<a name="l01167"></a>01167   <span class="comment">// can use the video decoder hardware.</span>
<a name="l01168"></a>01168   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;visibilitychange&#39;</span>, visibilityChanged);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170   <span class="keyword">function</span> visibilityChanged() {
<a name="l01171"></a>01171     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.hidden) {
<a name="l01172"></a>01172       <span class="comment">// If we&#39;re just showing the poster image when we&#39;re hidden</span>
<a name="l01173"></a>01173       <span class="comment">// then we don&#39;t have to do anything special</span>
<a name="l01174"></a>01174       <span class="keywordflow">if</span> (!<span class="keyword">self</span>.<a class="code" href="../../dd/d85/video_8js.html#a0b2c4e51d38b8cb42e68439b68d4b800">playerShowing</a>)
<a name="l01175"></a>01175         <span class="keywordflow">return</span>;
<a name="l01176"></a>01176 
<a name="l01177"></a>01177       <span class="keyword">self</span>.pause();
<a name="l01178"></a>01178 
<a name="l01179"></a>01179       <span class="comment">// If we&#39;re not at the beginning of the video, capture a</span>
<a name="l01180"></a>01180       <span class="comment">// temporary poster image to display when we come back</span>
<a name="l01181"></a>01181       <span class="keywordflow">if</span> (player.currentTime !== 0) {
<a name="l01182"></a>01182         playbackTime = player.currentTime;
<a name="l01183"></a>01183         captureCurrentFrame(<span class="keyword">function</span>(blob) {
<a name="l01184"></a>01184           capturedFrame = <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.createObjectURL(blob);
<a name="l01185"></a>01185           <a class="code" href="../../dd/d85/video_8js.html#a87871aceb087d64a0527f9a89eb07e37">hidePlayer</a>();
<a name="l01186"></a>01186           showPoster();
<a name="l01187"></a>01187         });
<a name="l01188"></a>01188       }
<a name="l01189"></a>01189       <span class="keywordflow">else</span> {
<a name="l01190"></a>01190         <span class="comment">// Even if we don&#39;t capture a frame, hide the video</span>
<a name="l01191"></a>01191         <a class="code" href="../../dd/d85/video_8js.html#a87871aceb087d64a0527f9a89eb07e37">hidePlayer</a>();
<a name="l01192"></a>01192         showPoster();
<a name="l01193"></a>01193       }
<a name="l01194"></a>01194     }
<a name="l01195"></a>01195   }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197   <span class="keyword">function</span> captureCurrentFrame(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01198"></a>01198     var <a class="code" href="../../d3/d2e/webgl-demo_8js.html#a1c82fafbefefac03f47e6f1a3cad5b73">canvas</a> = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createElement(<span class="stringliteral">&#39;canvas&#39;</span>);
<a name="l01199"></a>01199     canvas.width = videowidth;
<a name="l01200"></a>01200     canvas.height = videoheight;
<a name="l01201"></a>01201     var <a class="code" href="../../d9/d04/expat_8h.html#afe0934df1732463fe5378d8c8724edc6">context</a> = canvas.getContext(<span class="stringliteral">&#39;2d&#39;</span>);
<a name="l01202"></a>01202     context.drawImage(player, 0, 0);
<a name="l01203"></a>01203     canvas.toBlob(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01204"></a>01204   }
<a name="l01205"></a>01205 
<a name="l01206"></a>01206   <span class="comment">// Make the video fit the container</span>
<a name="l01207"></a>01207   <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#a80f1ea9fbe384f49287a314810c41138">setPlayerSize</a>() {
<a name="l01208"></a>01208     var containerWidth = <a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>.clientWidth;
<a name="l01209"></a>01209     var containerHeight = <a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>.clientHeight;
<a name="l01210"></a>01210 
<a name="l01211"></a>01211     <span class="comment">// Don&#39;t do anything if we don&#39;t know our size.</span>
<a name="l01212"></a>01212     <span class="comment">// This could happen if we get a resize event before our metadata loads</span>
<a name="l01213"></a>01213     <span class="keywordflow">if</span> (!videowidth || !videoheight)
<a name="l01214"></a>01214       <span class="keywordflow">return</span>;
<a name="l01215"></a>01215 
<a name="l01216"></a>01216     var <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>, <a class="code" href="../../d4/d8c/viewphoto_8js.html#a06f7a63ceb91351a4c31800c9a7af42f">height</a>; <span class="comment">// The size the video will appear, after rotation</span>
<a name="l01217"></a>01217     <span class="keywordflow">switch</span> (rotation) {
<a name="l01218"></a>01218     <span class="keywordflow">case</span> 0:
<a name="l01219"></a>01219     <span class="keywordflow">case</span> 180:
<a name="l01220"></a>01220       width = videowidth;
<a name="l01221"></a>01221       height = videoheight;
<a name="l01222"></a>01222       <span class="keywordflow">break</span>;
<a name="l01223"></a>01223     <span class="keywordflow">case</span> 90:
<a name="l01224"></a>01224     <span class="keywordflow">case</span> 270:
<a name="l01225"></a>01225       width = videoheight;
<a name="l01226"></a>01226       height = videowidth;
<a name="l01227"></a>01227     }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229     var xscale = containerWidth / <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>;
<a name="l01230"></a>01230     var yscale = containerHeight / <a class="code" href="../../d4/d8c/viewphoto_8js.html#a06f7a63ceb91351a4c31800c9a7af42f">height</a>;
<a name="l01231"></a>01231     var <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a> = Math.min(xscale, yscale);
<a name="l01232"></a>01232 
<a name="l01233"></a>01233     <span class="comment">// Scale large videos down, and scale small videos up.</span>
<a name="l01234"></a>01234     <span class="comment">// This might reduce image quality for small videos.</span>
<a name="l01235"></a>01235     width *= <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>;
<a name="l01236"></a>01236     height *= <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     var <a class="code" href="../../d3/d91/j3d_8js.html#a47b6aed05bc344861b52fe3ffb7a1edd">left</a> = ((containerWidth - <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>) / 2);
<a name="l01239"></a>01239     var <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a2d367ff48e26f53b84f9b2fe7d6065d6">top</a> = ((containerHeight - <a class="code" href="../../d4/d8c/viewphoto_8js.html#a06f7a63ceb91351a4c31800c9a7af42f">height</a>) / 2);
<a name="l01240"></a>01240 
<a name="l01241"></a>01241     var <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a16f1a2d59c558394e62fa83237fbd076">transform</a>;
<a name="l01242"></a>01242     <span class="keywordflow">switch</span> (rotation) {
<a name="l01243"></a>01243     <span class="keywordflow">case</span> 0:
<a name="l01244"></a>01244       transform = <span class="stringliteral">&#39;translate(&#39;</span> + left + <span class="stringliteral">&#39;px,&#39;</span> + top + <span class="stringliteral">&#39;px)&#39;</span>;
<a name="l01245"></a>01245       <span class="keywordflow">break</span>;
<a name="l01246"></a>01246     <span class="keywordflow">case</span> 90:
<a name="l01247"></a>01247       transform =
<a name="l01248"></a>01248         <span class="stringliteral">&#39;translate(&#39;</span> + (left + <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>) + <span class="stringliteral">&#39;px,&#39;</span> + top + <span class="stringliteral">&#39;px) &#39;</span> +
<a name="l01249"></a>01249         <span class="stringliteral">&#39;rotate(90deg)&#39;</span>;
<a name="l01250"></a>01250       <span class="keywordflow">break</span>;
<a name="l01251"></a>01251     <span class="keywordflow">case</span> 180:
<a name="l01252"></a>01252       transform =
<a name="l01253"></a>01253         <span class="stringliteral">&#39;translate(&#39;</span> + (left + <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>) + <span class="stringliteral">&#39;px,&#39;</span> + (top + height) + <span class="stringliteral">&#39;px) &#39;</span> +
<a name="l01254"></a>01254         <span class="stringliteral">&#39;rotate(180deg)&#39;</span>;
<a name="l01255"></a>01255       <span class="keywordflow">break</span>;
<a name="l01256"></a>01256     <span class="keywordflow">case</span> 270:
<a name="l01257"></a>01257       transform =
<a name="l01258"></a>01258         <span class="stringliteral">&#39;translate(&#39;</span> + left + <span class="stringliteral">&#39;px,&#39;</span> + (top + <a class="code" href="../../d4/d8c/viewphoto_8js.html#a06f7a63ceb91351a4c31800c9a7af42f">height</a>) + <span class="stringliteral">&#39;px) &#39;</span> +
<a name="l01259"></a>01259         <span class="stringliteral">&#39;rotate(270deg)&#39;</span>;
<a name="l01260"></a>01260       <span class="keywordflow">break</span>;
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263     transform += <span class="stringliteral">&#39; scale(&#39;</span> + scale + <span class="charliteral">&#39;)&#39;</span>;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265     poster.style.transform = <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a16f1a2d59c558394e62fa83237fbd076">transform</a>;
<a name="l01266"></a>01266     player.style.transform = <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a16f1a2d59c558394e62fa83237fbd076">transform</a>;
<a name="l01267"></a>01267   }
<a name="l01268"></a>01268 
<a name="l01269"></a>01269   <span class="comment">// Update current player orientation</span>
<a name="l01270"></a>01270   <span class="keyword">function</span> setPlayerOrientation(newOrientation) {
<a name="l01271"></a>01271     orientation = newOrientation;
<a name="l01272"></a>01272   }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274   <span class="comment">// Compute position based on player orientation</span>
<a name="l01275"></a>01275   <span class="keyword">function</span> computePosition(panPosition, rect) {
<a name="l01276"></a>01276     var <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>;
<a name="l01277"></a>01277     <span class="keywordflow">switch</span> (orientation) {
<a name="l01278"></a>01278       <span class="keywordflow">case</span> 0:
<a name="l01279"></a>01279         position = (panPosition.clientX - rect.left) / rect.width;
<a name="l01280"></a>01280         <span class="keywordflow">break</span>;
<a name="l01281"></a>01281       <span class="keywordflow">case</span> 90:
<a name="l01282"></a>01282         position = (rect.bottom - panPosition.clientY) / rect.height;
<a name="l01283"></a>01283         <span class="keywordflow">break</span>;
<a name="l01284"></a>01284       <span class="keywordflow">case</span> 180:
<a name="l01285"></a>01285         position = (rect.right - panPosition.clientX) / rect.width;
<a name="l01286"></a>01286         <span class="keywordflow">break</span>;
<a name="l01287"></a>01287       <span class="keywordflow">case</span> 270:
<a name="l01288"></a>01288         position = (panPosition.clientY - rect.top) / rect.height;
<a name="l01289"></a>01289         <span class="keywordflow">break</span>;
<a name="l01290"></a>01290     }
<a name="l01291"></a>01291     <span class="keywordflow">return</span> <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>;
<a name="l01292"></a>01292   }
<a name="l01293"></a>01293 
<a name="l01294"></a>01294   <span class="comment">// handle drags on the time slider</span>
<a name="l01295"></a>01295   slider.addEventListener(<span class="stringliteral">&#39;pan&#39;</span>, <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a0118c22264bfb2702043c95ec9a8e6b2">pan</a>(e) {
<a name="l01296"></a>01296     e.stopPropagation();
<a name="l01297"></a>01297     <span class="comment">// We can&#39;t do anything if we don&#39;t know our duration</span>
<a name="l01298"></a>01298     <span class="keywordflow">if</span> (player.duration === <a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a1b0bebbb829f5b272171927a1b7adfbe">Infinity</a>)
<a name="l01299"></a>01299       <span class="keywordflow">return</span>;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301     <span class="keywordflow">if</span> (!dragging) {  <span class="comment">// Do this stuff on the first pan event only</span>
<a name="l01302"></a>01302       dragging = <span class="keyword">true</span>;
<a name="l01303"></a>01303       pausedBeforeDragging = player.paused;
<a name="l01304"></a>01304       <span class="keywordflow">if</span> (!pausedBeforeDragging) {
<a name="l01305"></a>01305         player.pause();
<a name="l01306"></a>01306       }
<a name="l01307"></a>01307     }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309     var rect = backgroundBar.getBoundingClientRect();
<a name="l01310"></a>01310     var position = computePosition(e.detail.position, rect);
<a name="l01311"></a>01311     var pos = Math.min(Math.max(position, 0), 1);
<a name="l01312"></a>01312     player.currentTime = player.duration * pos;
<a name="l01313"></a>01313     updateTime();
<a name="l01314"></a>01314   });
<a name="l01315"></a>01315 
<a name="l01316"></a>01316   slider.addEventListener(<span class="stringliteral">&#39;swipe&#39;</span>, <span class="keyword">function</span> <a class="code" href="../../d8/dd3/head_8js.html#a9118729bb0e6af929a26ffd9baafca8b">swipe</a>(e) {
<a name="l01317"></a>01317     e.stopPropagation();
<a name="l01318"></a>01318     dragging = <span class="keyword">false</span>;
<a name="l01319"></a>01319     <span class="keywordflow">if</span> (player.currentTime &gt;= player.duration) {
<a name="l01320"></a>01320       <span class="keyword">self</span>.pause();
<a name="l01321"></a>01321     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pausedBeforeDragging) {
<a name="l01322"></a>01322       player.play();
<a name="l01323"></a>01323     }
<a name="l01324"></a>01324   });
<a name="l01325"></a>01325 
<a name="l01326"></a>01326   <span class="keyword">function</span> formatTime(<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>) {
<a name="l01327"></a>01327     <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a85d894d441c0a15e64373537d8db1658">padLeft</a>(<a class="code" href="../../de/d81/xpt__struct_8h.html#af23ba264fc6071dcd37179d8a2b5440b">num</a>, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>) {
<a name="l01328"></a>01328       var r = String(<a class="code" href="../../de/d81/xpt__struct_8h.html#af23ba264fc6071dcd37179d8a2b5440b">num</a>);
<a name="l01329"></a>01329       <span class="keywordflow">while</span> (r.length &lt; <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>) {
<a name="l01330"></a>01330         r = <span class="charliteral">&#39;0&#39;</span> + r;
<a name="l01331"></a>01331       }
<a name="l01332"></a>01332       <span class="keywordflow">return</span> r;
<a name="l01333"></a>01333     }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335     <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a> = Math.round(<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>);
<a name="l01336"></a>01336     var minutes = Math.floor(<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a> / 60);
<a name="l01337"></a>01337     var seconds = <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a> % 60;
<a name="l01338"></a>01338     <span class="keywordflow">if</span> (minutes &lt; 60) {
<a name="l01339"></a>01339       <span class="keywordflow">return</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a85d894d441c0a15e64373537d8db1658">padLeft</a>(minutes, 2) + <span class="charliteral">&#39;:&#39;</span> + <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a85d894d441c0a15e64373537d8db1658">padLeft</a>(seconds, 2);
<a name="l01340"></a>01340     } <span class="keywordflow">else</span> {
<a name="l01341"></a>01341       var hours = Math.floor(minutes / 60);
<a name="l01342"></a>01342       minutes = Math.round(minutes % 60);
<a name="l01343"></a>01343       <span class="keywordflow">return</span> hours + <span class="charliteral">&#39;:&#39;</span> + <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a85d894d441c0a15e64373537d8db1658">padLeft</a>(minutes, 2) + <span class="charliteral">&#39;:&#39;</span> + <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a85d894d441c0a15e64373537d8db1658">padLeft</a>(seconds, 2);
<a name="l01344"></a>01344     }
<a name="l01345"></a>01345     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l01346"></a>01346   }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348   <span class="comment">// pause the video player if user unplugs headphone</span>
<a name="l01349"></a>01349   var <a class="code" href="../../d1/dd2/_player_8js.html#a2c883fa0cfda1abf056cf1d6ee88ca12">acm</a> = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozAudioChannelManager;
<a name="l01350"></a>01350   <span class="keywordflow">if</span> (acm) {
<a name="l01351"></a>01351     acm.addEventListener(<span class="stringliteral">&#39;headphoneschange&#39;</span>, <span class="keyword">function</span> onheadphoneschange() {
<a name="l01352"></a>01352       <span class="keywordflow">if</span> (!acm.headphones &amp;&amp; <span class="keyword">self</span>.playing) {
<a name="l01353"></a>01353         <span class="keyword">self</span>.pause();
<a name="l01354"></a>01354       }
<a name="l01355"></a>01355     });
<a name="l01356"></a>01356   }
<a name="l01357"></a>01357 }
<a name="l01358"></a>01358 
<a name="l01359"></a>01359 <a class="code" href="../../db/dcd/build__stage_2email_2shared_2js_2media_2video__player_8js.html#a612b58b49e6b99cf1229b3c371d5f684">VideoPlayer</a>.prototype.hide = <span class="keyword">function</span>() {
<a name="l01360"></a>01360   <span class="comment">// Call reset() to hide the poster and player</span>
<a name="l01361"></a>01361   this.controls.style.display = <span class="stringliteral">&#39;none&#39;</span>;
<a name="l01362"></a>01362 };
<a name="l01363"></a>01363 
<a name="l01364"></a>01364 <a class="code" href="../../db/dcd/build__stage_2email_2shared_2js_2media_2video__player_8js.html#a612b58b49e6b99cf1229b3c371d5f684">VideoPlayer</a>.prototype.show = <span class="keyword">function</span>() {
<a name="l01365"></a>01365   <span class="comment">// Call init() to show the poster</span>
<a name="l01366"></a>01366   this.controls.style.display = <span class="stringliteral">&#39;block&#39;</span>;
<a name="l01367"></a>01367 };
<a name="l01368"></a>01368 <span class="comment">/*</span>
<a name="l01369"></a>01369 <span class="comment"> * media_frame.js:</span>
<a name="l01370"></a>01370 <span class="comment"> *</span>
<a name="l01371"></a>01371 <span class="comment"> * A MediaFrame displays a photo or a video. The gallery app uses</span>
<a name="l01372"></a>01372 <span class="comment"> * three side by side to support smooth panning from one item to the</span>
<a name="l01373"></a>01373 <span class="comment"> * next.  The Camera app uses one for image and video preview. The</span>
<a name="l01374"></a>01374 <span class="comment"> * Gallery app&#39;s open activity uses one of these to display the opened</span>
<a name="l01375"></a>01375 <span class="comment"> * item.</span>
<a name="l01376"></a>01376 <span class="comment"> *</span>
<a name="l01377"></a>01377 <span class="comment"> * MediaFrames have different behavior depending on whether they display</span>
<a name="l01378"></a>01378 <span class="comment"> * images or videos. Photo frames allow the user to zoom and pan on the photo.</span>
<a name="l01379"></a>01379 <span class="comment"> * Video frames allow the user to play and pause but don&#39;t allow zooming.</span>
<a name="l01380"></a>01380 <span class="comment"> *</span>
<a name="l01381"></a>01381 <span class="comment"> * When a frame is displaying a video, it handles mouse events.</span>
<a name="l01382"></a>01382 <span class="comment"> * When display a picture, however, it expects the client to handle events</span>
<a name="l01383"></a>01383 <span class="comment"> * and call the pan() and zoom() methods.</span>
<a name="l01384"></a>01384 <span class="comment"> *</span>
<a name="l01385"></a>01385 <span class="comment"> * The pan() method is a little unusual. It &quot;uses&quot; as much of the pan</span>
<a name="l01386"></a>01386 <span class="comment"> * event as it can, and returns a number indicating how much of the</span>
<a name="l01387"></a>01387 <span class="comment"> * horizontal motion it did not use. The gallery uses this returned</span>
<a name="l01388"></a>01388 <span class="comment"> * value for transitioning between frames.  If a frame displays a</span>
<a name="l01389"></a>01389 <span class="comment"> * photo that is not zoomed in at all, then it can&#39;t use any of the</span>
<a name="l01390"></a>01390 <span class="comment"> * pan, and returns the full amount which the gallery app turns into a</span>
<a name="l01391"></a>01391 <span class="comment"> * panning motion between frames.  But if the photo is zoomed in, then</span>
<a name="l01392"></a>01392 <span class="comment"> * the MediaFrame will just move the photo within itself, if it can, and</span>
<a name="l01393"></a>01393 <span class="comment"> * return 0.</span>
<a name="l01394"></a>01394 <span class="comment"> *</span>
<a name="l01395"></a>01395 <span class="comment"> * Much of the code in this file used to be part of the PhotoState class.</span>
<a name="l01396"></a>01396 <span class="comment"> */</span>
<a name="l01397"></a>01397 <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>(<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>, includeVideo) {
<a name="l01398"></a>01398   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a> === <span class="stringliteral">&#39;string&#39;</span>)
<a name="l01399"></a>01399     <a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a> = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementById(<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>);
<a name="l01400"></a>01400   this.<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a> = <a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>;
<a name="l01401"></a>01401   this.image = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createElement(<span class="stringliteral">&#39;img&#39;</span>);
<a name="l01402"></a>01402   this.image.style.transformOrigin = <span class="stringliteral">&#39;center center&#39;</span>;
<a name="l01403"></a>01403   this.<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>.appendChild(this.image);
<a name="l01404"></a>01404   this.image.style.display = <span class="stringliteral">&#39;none&#39;</span>;
<a name="l01405"></a>01405   <span class="keywordflow">if</span> (includeVideo !== <span class="keyword">false</span>) {
<a name="l01406"></a>01406     this.video = <span class="keyword">new</span> <a class="code" href="../../db/dcd/build__stage_2email_2shared_2js_2media_2video__player_8js.html#a612b58b49e6b99cf1229b3c371d5f684">VideoPlayer</a>(<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>);
<a name="l01407"></a>01407     this.video.hide();
<a name="l01408"></a>01408   }
<a name="l01409"></a>01409   this.displayingVideo = <span class="keyword">false</span>;
<a name="l01410"></a>01410   this.displayingImage = <span class="keyword">false</span>;
<a name="l01411"></a>01411   this.<a class="code" href="../../d4/d8c/viewphoto_8js.html#a7b0ef247dd3a1c5dc7d803350ef2c705">imageblob</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01412"></a>01412   this.previewblob = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01413"></a>01413   this.<a class="code" href="../../da/d84/openvideo_8js.html#abb5b227dc42fac12a95f81d10b429719">videoblob</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01414"></a>01414   this.posterblob = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01415"></a>01415   this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01418"></a>01418   this.image.onerror = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l01419"></a>01419     <span class="keywordflow">if</span> (<span class="keyword">self</span>.<a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>)
<a name="l01420"></a>01420       <span class="keyword">self</span>.onerror(e);
<a name="l01421"></a>01421   };
<a name="l01422"></a>01422 }
<a name="l01423"></a>01423 
<a name="l01424"></a>01424 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.displayImage = <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#afd0a40e2b6829bdec138c7b4083a8710">displayImage</a>(blob,
<a name="l01425"></a>01425                                                           width,
<a name="l01426"></a>01426                                                           height,
<a name="l01427"></a>01427                                                           preview,
<a name="l01428"></a>01428                                                           rotation,
<a name="l01429"></a>01429                                                           mirrored)
<a name="l01430"></a>01430 {
<a name="l01431"></a>01431   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a1ac2b96f3c890c1170f3be034398a81d">clear</a>();  <span class="comment">// Reset everything</span>
<a name="l01432"></a>01432 
<a name="l01433"></a>01433   <span class="comment">// Remember what we&#39;re displaying</span>
<a name="l01434"></a>01434   this.<a class="code" href="../../d4/d8c/viewphoto_8js.html#a7b0ef247dd3a1c5dc7d803350ef2c705">imageblob</a> = blob;
<a name="l01435"></a>01435   this.fullsizeWidth = <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>;
<a name="l01436"></a>01436   this.fullsizeHeight = <a class="code" href="../../d4/d8c/viewphoto_8js.html#a06f7a63ceb91351a4c31800c9a7af42f">height</a>;
<a name="l01437"></a>01437   this.preview = preview;
<a name="l01438"></a>01438 
<a name="l01439"></a>01439   <span class="comment">// Note: There is a default value for orientation/mirrored since some</span>
<a name="l01440"></a>01440   <span class="comment">// images don&#39;t have EXIF data to retrieve this information.</span>
<a name="l01441"></a>01441   this.rotation = rotation || 0;
<a name="l01442"></a>01442   this.mirrored = mirrored || <span class="keyword">false</span>;
<a name="l01443"></a>01443 
<a name="l01444"></a>01444   <span class="comment">// Keep track of what kind of content we have</span>
<a name="l01445"></a>01445   this.displayingImage = <span class="keyword">true</span>;
<a name="l01446"></a>01446 
<a name="l01447"></a>01447   <span class="keyword">function</span> bigEnough(preview) {
<a name="l01448"></a>01448     <span class="keywordflow">if</span> (!preview.width || !preview.height)
<a name="l01449"></a>01449       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01450"></a>01450 
<a name="l01451"></a>01451     <span class="comment">// A preview is big enough if at least one dimension is &gt;= the</span>
<a name="l01452"></a>01452     <span class="comment">// screen size in both portait and landscape mode.</span>
<a name="l01453"></a>01453     var sw = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.innerWidth;
<a name="l01454"></a>01454     var sh = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.innerHeight;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456     <span class="keywordflow">return</span> ((preview.width &gt;= sw || preview.height &gt;= sh) &amp;&amp; <span class="comment">// portrait</span>
<a name="l01457"></a>01457             (preview.width &gt;= sh || preview.height &gt;= sw));  <span class="comment">// landscape</span>
<a name="l01458"></a>01458   }
<a name="l01459"></a>01459 
<a name="l01460"></a>01460 
<a name="l01461"></a>01461   <span class="comment">// If the preview is at least as big as the screen, display that.</span>
<a name="l01462"></a>01462   <span class="comment">// Otherwise, display the full-size image.</span>
<a name="l01463"></a>01463   <span class="keywordflow">if</span> (preview &amp;&amp; (preview.start || preview.filename) &amp;&amp; bigEnough(preview)) {
<a name="l01464"></a>01464     this.displayingPreview = <span class="keyword">true</span>;
<a name="l01465"></a>01465     <span class="keywordflow">if</span> (preview.start) {
<a name="l01466"></a>01466       this.previewblob = blob.slice(preview.start, preview.end, <span class="stringliteral">&#39;image/jpeg&#39;</span>);
<a name="l01467"></a>01467       this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a624b5a094fa4a7724116ddd5004545a0">_displayImage</a>(this.previewblob);
<a name="l01468"></a>01468     }
<a name="l01469"></a>01469     <span class="keywordflow">else</span> {
<a name="l01470"></a>01470       var storage = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.getDeviceStorage(<span class="stringliteral">&#39;pictures&#39;</span>);
<a name="l01471"></a>01471       var getreq = storage.get(preview.filename);
<a name="l01472"></a>01472       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01473"></a>01473       getreq.onsuccess = <span class="keyword">function</span>() {
<a name="l01474"></a>01474         <span class="keyword">self</span>.previewblob = getreq.result;
<a name="l01475"></a>01475         <span class="keyword">self</span>._displayImage(<span class="keyword">self</span>.previewblob);
<a name="l01476"></a>01476       };
<a name="l01477"></a>01477       getreq.onerror = <span class="keyword">function</span>() {
<a name="l01478"></a>01478         <span class="keyword">self</span>.displayingPreview = <span class="keyword">false</span>;
<a name="l01479"></a>01479         <span class="keyword">self</span>.preview = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01480"></a>01480         <span class="keyword">self</span>._displayImage(blob);
<a name="l01481"></a>01481       };
<a name="l01482"></a>01482     }
<a name="l01483"></a>01483   }
<a name="l01484"></a>01484   <span class="keywordflow">else</span> {
<a name="l01485"></a>01485     this.preview = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01486"></a>01486     this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a624b5a094fa4a7724116ddd5004545a0">_displayImage</a>(blob);
<a name="l01487"></a>01487   }
<a name="l01488"></a>01488 };
<a name="l01489"></a>01489 
<a name="l01490"></a>01490 <span class="comment">// A utility function we use to display the full-size image or the preview.</span>
<a name="l01491"></a>01491 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype._displayImage = <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a624b5a094fa4a7724116ddd5004545a0">_displayImage</a>(blob) {
<a name="l01492"></a>01492   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494   <span class="comment">// Create a URL for the blob (or preview blob)</span>
<a name="l01495"></a>01495   <span class="keywordflow">if</span> (this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>)
<a name="l01496"></a>01496     <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.revokeObjectURL(this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>);
<a name="l01497"></a>01497   this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> = <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.createObjectURL(blob);
<a name="l01498"></a>01498 
<a name="l01499"></a>01499   var preload = <span class="keyword">new</span> Image();
<a name="l01500"></a>01500 
<a name="l01501"></a>01501   preload.addEventListener(<span class="stringliteral">&#39;load&#39;</span>, <span class="keyword">function</span> <a class="code" href="../../d8/deb/share_8js.html#ae63fb598d93a4bb590d74a27b9398c71">onload</a>() {
<a name="l01502"></a>01502     preload.removeEventListener(<span class="stringliteral">&#39;load&#39;</span>, <a class="code" href="../../d8/deb/share_8js.html#ae63fb598d93a4bb590d74a27b9398c71">onload</a>);
<a name="l01503"></a>01503 
<a name="l01504"></a>01504     <span class="keyword">self</span>.image.src = preload.src;
<a name="l01505"></a>01505 
<a name="l01506"></a>01506     <span class="comment">// Switch height &amp; width for rotated images</span>
<a name="l01507"></a>01507     <span class="keywordflow">if</span> (<span class="keyword">self</span>.rotation == 0 || <span class="keyword">self</span>.rotation == 180) {
<a name="l01508"></a>01508       <span class="keyword">self</span>.itemWidth = preload.width;
<a name="l01509"></a>01509       <span class="keyword">self</span>.itemHeight = preload.height;
<a name="l01510"></a>01510     } <span class="keywordflow">else</span> {
<a name="l01511"></a>01511       <span class="keyword">self</span>.itemWidth = preload.height;
<a name="l01512"></a>01512       <span class="keyword">self</span>.itemHeight = preload.width;
<a name="l01513"></a>01513     }
<a name="l01514"></a>01514 
<a name="l01515"></a>01515     <span class="keyword">self</span>.computeFit();
<a name="l01516"></a>01516     <span class="keyword">self</span>.setPosition();
<a name="l01517"></a>01517     <span class="keyword">self</span>.image.style.display = <span class="stringliteral">&#39;block&#39;</span>;
<a name="l01518"></a>01518   });
<a name="l01519"></a>01519 
<a name="l01520"></a>01520   preload.src = this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>;
<a name="l01521"></a>01521 };
<a name="l01522"></a>01522 
<a name="l01523"></a>01523 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype._switchToFullSizeImage = <span class="keyword">function</span> _switchToFull() {
<a name="l01524"></a>01524   <span class="keywordflow">if</span> (!this.displayingImage || !this.displayingPreview)
<a name="l01525"></a>01525     <span class="keywordflow">return</span>;
<a name="l01526"></a>01526 
<a name="l01527"></a>01527   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01528"></a>01528   this.displayingPreview = <span class="keyword">false</span>;
<a name="l01529"></a>01529 
<a name="l01530"></a>01530   var oldurl = this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>;
<a name="l01531"></a>01531   var oldimage = this.oldimage = this.image;
<a name="l01532"></a>01532   var newimage = this.image = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createElement(<span class="stringliteral">&#39;img&#39;</span>);
<a name="l01533"></a>01533   newimage.src = this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> = <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.createObjectURL(this.<a class="code" href="../../d4/d8c/viewphoto_8js.html#a7b0ef247dd3a1c5dc7d803350ef2c705">imageblob</a>);
<a name="l01534"></a>01534 
<a name="l01535"></a>01535   <span class="comment">// Add the new image to the container before the current preview image</span>
<a name="l01536"></a>01536   <span class="comment">// Because it comes first it will be obscured by the preview</span>
<a name="l01537"></a>01537   this.<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>.insertBefore(newimage, oldimage);
<a name="l01538"></a>01538 
<a name="l01539"></a>01539   <span class="comment">// Resize the preview image to be the same size as the full image.</span>
<a name="l01540"></a>01540   <span class="comment">// It will be pixelated, but it will be ready right away.</span>
<a name="l01541"></a>01541   <span class="keywordflow">if</span> (this.rotation == 0 || this.rotation == 180) {
<a name="l01542"></a>01542     this.itemWidth = this.oldimage.width = this.fullsizeWidth;
<a name="l01543"></a>01543     this.itemHeight = this.oldimage.height = this.fullsizeHeight;
<a name="l01544"></a>01544   } <span class="keywordflow">else</span> {
<a name="l01545"></a>01545     this.itemWidth = this.oldimage.height = this.fullsizeHeight;
<a name="l01546"></a>01546     this.itemHeight = this.oldimage.width = this.fullsizeWidth;
<a name="l01547"></a>01547   }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#aad5d33aecb415588534d9112a50acc6a">computeFit</a>();
<a name="l01550"></a>01550   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a98dd025d5d5071ff7db04e00a9c11478">setPosition</a>();
<a name="l01551"></a>01551 
<a name="l01552"></a>01552   <span class="comment">// Query the position of the two images in order to flush the changes</span>
<a name="l01553"></a>01553   <span class="comment">// made by setPosition() above. This prevents us from accidentally</span>
<a name="l01554"></a>01554   <span class="comment">// animating those changes when the user double taps to zoom.</span>
<a name="l01555"></a>01555   <span class="keywordflow">if</span> (this.oldimage) {
<a name="l01556"></a>01556     var temp = this.oldimage.clientLeft;
<a name="l01557"></a>01557     temp = this.image.clientLeft;
<a name="l01558"></a>01558   }
<a name="l01559"></a>01559 
<a name="l01560"></a>01560   <span class="comment">// When the new image is loaded we can begin to remove the preview image</span>
<a name="l01561"></a>01561   newimage.addEventListener(<span class="stringliteral">&#39;load&#39;</span>, <span class="keyword">function</span> imageLoaded() {
<a name="l01562"></a>01562     newimage.removeEventListener(<span class="stringliteral">&#39;load&#39;</span>, imageLoaded);
<a name="l01563"></a>01563 
<a name="l01564"></a>01564     <span class="comment">// It takes quite a while for gecko to decode a 1200x1600 image once</span>
<a name="l01565"></a>01565     <span class="comment">// it is loaded, so we wait a second here before removing the preview.</span>
<a name="l01566"></a>01566     <span class="comment">// XXX: This is a hack. There really ought to be an event we can listen for</span>
<a name="l01567"></a>01567     <span class="comment">// to know when the image is ready to display onscreen. See Bug 844245.</span>
<a name="l01568"></a>01568     <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() {
<a name="l01569"></a>01569       mozRequestAnimationFrame(<span class="keyword">function</span>() {
<a name="l01570"></a>01570         <span class="keyword">self</span>.container.removeChild(oldimage);
<a name="l01571"></a>01571         <span class="keyword">self</span>.oldimage = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01572"></a>01572         oldimage.src = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01573"></a>01573         <span class="keywordflow">if</span> (oldurl)
<a name="l01574"></a>01574           <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.revokeObjectURL(oldurl);
<a name="l01575"></a>01575       });
<a name="l01576"></a>01576     }, 1000);
<a name="l01577"></a>01577   });
<a name="l01578"></a>01578 };
<a name="l01579"></a>01579 
<a name="l01580"></a>01580 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype._switchToPreviewImage = <span class="keyword">function</span> _switchToPreview() {
<a name="l01581"></a>01581   <span class="keywordflow">if</span> (this.displayingImage &amp;&amp; this.preview &amp;&amp; !this.displayingPreview) {
<a name="l01582"></a>01582     this.displayingPreview = <span class="keyword">true</span>;
<a name="l01583"></a>01583     this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a624b5a094fa4a7724116ddd5004545a0">_displayImage</a>(this.previewblob,
<a name="l01584"></a>01584                        this.preview.width,
<a name="l01585"></a>01585                        <span class="keyword">this</span>.preview.height);
<a name="l01586"></a>01586   }
<a name="l01587"></a>01587 };
<a name="l01588"></a>01588 
<a name="l01589"></a>01589 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.displayVideo = <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a2fc22de9697d1406cbb0fcb02df879e0">displayVideo</a>(<a class="code" href="../../da/d84/openvideo_8js.html#abb5b227dc42fac12a95f81d10b429719">videoblob</a>, posterblob,
<a name="l01590"></a>01590                                                           width, height,
<a name="l01591"></a>01591                                                           rotation)
<a name="l01592"></a>01592 {
<a name="l01593"></a>01593   <span class="keywordflow">if</span> (!this.video)
<a name="l01594"></a>01594     <span class="keywordflow">return</span>;
<a name="l01595"></a>01595 
<a name="l01596"></a>01596   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a1ac2b96f3c890c1170f3be034398a81d">clear</a>();  <span class="comment">// reset everything</span>
<a name="l01597"></a>01597 
<a name="l01598"></a>01598   <span class="comment">// Keep track of what kind of content we have</span>
<a name="l01599"></a>01599   this.displayingVideo = <span class="keyword">true</span>;
<a name="l01600"></a>01600 
<a name="l01601"></a>01601   <span class="comment">// Remember the blobs</span>
<a name="l01602"></a>01602   this.<a class="code" href="../../da/d84/openvideo_8js.html#abb5b227dc42fac12a95f81d10b429719">videoblob</a> = <a class="code" href="../../da/d84/openvideo_8js.html#abb5b227dc42fac12a95f81d10b429719">videoblob</a>;
<a name="l01603"></a>01603   this.posterblob = posterblob;
<a name="l01604"></a>01604 
<a name="l01605"></a>01605   <span class="comment">// Get new URLs for the blobs</span>
<a name="l01606"></a>01606   this.videourl = <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.createObjectURL(<a class="code" href="../../da/d84/openvideo_8js.html#abb5b227dc42fac12a95f81d10b429719">videoblob</a>);
<a name="l01607"></a>01607   this.posterurl = <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.createObjectURL(posterblob);
<a name="l01608"></a>01608 
<a name="l01609"></a>01609   <span class="comment">// Display them in the video element.</span>
<a name="l01610"></a>01610   <span class="comment">// The VideoPlayer class takes care of positioning itself, so we</span>
<a name="l01611"></a>01611   <span class="comment">// don&#39;t have to do anything here with computeFit() or setPosition()</span>
<a name="l01612"></a>01612   this.video.load(this.videourl, this.posterurl, width, height, rotation || 0);
<a name="l01613"></a>01613 
<a name="l01614"></a>01614   <span class="comment">// Show the player controls</span>
<a name="l01615"></a>01615   this.video.show();
<a name="l01616"></a>01616 };
<a name="l01617"></a>01617 
<a name="l01618"></a>01618 <span class="comment">// Reset the frame state, release any urls and and hide everything</span>
<a name="l01619"></a>01619 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.clear = <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a1ac2b96f3c890c1170f3be034398a81d">clear</a>() {
<a name="l01620"></a>01620   <span class="comment">// Reset the saved state</span>
<a name="l01621"></a>01621   this.displayingImage = <span class="keyword">false</span>;
<a name="l01622"></a>01622   this.displayingPreview = <span class="keyword">false</span>;
<a name="l01623"></a>01623   this.displayingVideo = <span class="keyword">false</span>;
<a name="l01624"></a>01624   this.itemWidth = this.itemHeight = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01625"></a>01625   this.<a class="code" href="../../d4/d8c/viewphoto_8js.html#a7b0ef247dd3a1c5dc7d803350ef2c705">imageblob</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01626"></a>01626   this.previewblob = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01627"></a>01627   this.<a class="code" href="../../da/d84/openvideo_8js.html#abb5b227dc42fac12a95f81d10b429719">videoblob</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01628"></a>01628   this.posterblob = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01629"></a>01629   this.fullsizeWidth = this.fullsizeHeight = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01630"></a>01630   this.preview = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01631"></a>01631   this.fit = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01632"></a>01632   <span class="keywordflow">if</span> (this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>) {
<a name="l01633"></a>01633     <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.revokeObjectURL(this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>);
<a name="l01634"></a>01634     this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01635"></a>01635   }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637   <span class="comment">// Hide the image</span>
<a name="l01638"></a>01638   this.image.style.display = <span class="stringliteral">&#39;none&#39;</span>;
<a name="l01639"></a>01639   this.image.src = <span class="stringliteral">&#39;&#39;</span>;  <span class="comment">// Use &#39;&#39; instead of null. See Bug 901410</span>
<a name="l01640"></a>01640 
<a name="l01641"></a>01641   <span class="comment">// Hide the video player</span>
<a name="l01642"></a>01642   <span class="keywordflow">if</span> (this.video) {
<a name="l01643"></a>01643     this.video.reset();
<a name="l01644"></a>01644     this.video.hide();
<a name="l01645"></a>01645     <span class="keywordflow">if</span> (this.videourl)
<a name="l01646"></a>01646       <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.revokeObjectURL(this.videourl);
<a name="l01647"></a>01647     <span class="keywordflow">if</span> (this.posterurl)
<a name="l01648"></a>01648       <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.revokeObjectURL(this.posterurl);
<a name="l01649"></a>01649   }
<a name="l01650"></a>01650 };
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 <span class="comment">// Set the item&#39;s position based on this.fit</span>
<a name="l01653"></a>01653 <span class="comment">// The VideoPlayer object fits itself to its container, and it</span>
<a name="l01654"></a>01654 <span class="comment">// can&#39;t be zoomed or panned, so we only need to do this for images</span>
<a name="l01655"></a>01655 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.setPosition = <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a98dd025d5d5071ff7db04e00a9c11478">setPosition</a>() {
<a name="l01656"></a>01656   <span class="keywordflow">if</span> (!this.fit || !this.displayingImage)
<a name="l01657"></a>01657     <span class="keywordflow">return</span>;
<a name="l01658"></a>01658 
<a name="l01659"></a>01659   var dx = this.fit.left, dy = this.fit.top;
<a name="l01660"></a>01660 
<a name="l01661"></a>01661   <span class="comment">// We have to adjust the translation to account for the fact that the</span>
<a name="l01662"></a>01662   <span class="comment">// scaling is being done around the middle of the image, rather than the</span>
<a name="l01663"></a>01663   <span class="comment">// upper-left corner.  And we have to make this adjustment differently</span>
<a name="l01664"></a>01664   <span class="comment">// for different rotations.</span>
<a name="l01665"></a>01665   <span class="keywordflow">switch</span> (this.rotation) {
<a name="l01666"></a>01666   <span class="keywordflow">case</span> 0:
<a name="l01667"></a>01667   <span class="keywordflow">case</span> 180:
<a name="l01668"></a>01668     dx += (this.fit.width - this.itemWidth) / 2;
<a name="l01669"></a>01669     dy += (this.fit.height - this.itemHeight) / 2;
<a name="l01670"></a>01670     <span class="keywordflow">break</span>;
<a name="l01671"></a>01671   <span class="keywordflow">case</span> 90:
<a name="l01672"></a>01672   <span class="keywordflow">case</span> 270:
<a name="l01673"></a>01673     dx += (this.fit.width - this.itemHeight) / 2;
<a name="l01674"></a>01674     dy += (this.fit.height - this.itemWidth) / 2;
<a name="l01675"></a>01675     <span class="keywordflow">break</span>;
<a name="l01676"></a>01676   }
<a name="l01677"></a>01677 
<a name="l01678"></a>01678   var sx = this.mirrored ? -this.fit.scale : this.fit.scale;
<a name="l01679"></a>01679   var sy = this.fit.scale;
<a name="l01680"></a>01680 
<a name="l01681"></a>01681   var transform =
<a name="l01682"></a>01682     <span class="stringliteral">&#39;translate(&#39;</span> + dx + <span class="stringliteral">&#39;px, &#39;</span> + dy + <span class="stringliteral">&#39;px) &#39;</span> +
<a name="l01683"></a>01683     <span class="stringliteral">&#39;scale(&#39;</span> + sx + <span class="charliteral">&#39;,&#39;</span> + sy + <span class="charliteral">&#39;)&#39;</span> +
<a name="l01684"></a>01684     <span class="stringliteral">&#39;rotate(&#39;</span> + this.rotation + <span class="stringliteral">&#39;deg) &#39;</span>;
<a name="l01685"></a>01685 
<a name="l01686"></a>01686   this.image.style.transform = <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a16f1a2d59c558394e62fa83237fbd076">transform</a>;
<a name="l01687"></a>01687   <span class="keywordflow">if</span> (this.oldimage)
<a name="l01688"></a>01688     this.oldimage.style.transform = <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a16f1a2d59c558394e62fa83237fbd076">transform</a>;
<a name="l01689"></a>01689 };
<a name="l01690"></a>01690 
<a name="l01691"></a>01691 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.computeFit = <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#aad5d33aecb415588534d9112a50acc6a">computeFit</a>() {
<a name="l01692"></a>01692   <span class="keywordflow">if</span> (!this.displayingImage)
<a name="l01693"></a>01693     <span class="keywordflow">return</span>;
<a name="l01694"></a>01694   this.viewportWidth = this.<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>.offsetWidth;
<a name="l01695"></a>01695   this.viewportHeight = this.<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>.offsetHeight;
<a name="l01696"></a>01696 
<a name="l01697"></a>01697   var scalex = this.viewportWidth / this.itemWidth;
<a name="l01698"></a>01698   var scaley = this.viewportHeight / this.itemHeight;
<a name="l01699"></a>01699   var scale = Math.min(Math.min(scalex, scaley), 1);
<a name="l01700"></a>01700 
<a name="l01701"></a>01701   <span class="comment">// Set the image size and position</span>
<a name="l01702"></a>01702   var width = Math.floor(this.itemWidth * scale);
<a name="l01703"></a>01703   var height = Math.floor(this.itemHeight * scale);
<a name="l01704"></a>01704 
<a name="l01705"></a>01705   this.fit = {
<a name="l01706"></a>01706     width: <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>,
<a name="l01707"></a>01707     height: <a class="code" href="../../d4/d8c/viewphoto_8js.html#a06f7a63ceb91351a4c31800c9a7af42f">height</a>,
<a name="l01708"></a>01708     left: Math.floor((this.viewportWidth - width) / 2),
<a name="l01709"></a>01709     top: Math.floor((this.viewportHeight - height) / 2),
<a name="l01710"></a>01710     scale: <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>,
<a name="l01711"></a>01711     baseScale: scale
<a name="l01712"></a>01712   };
<a name="l01713"></a>01713 };
<a name="l01714"></a>01714 
<a name="l01715"></a>01715 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.reset = <span class="keyword">function</span> <a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a>() {
<a name="l01716"></a>01716   <span class="comment">// If we&#39;re not displaying the preview image, but we have one,</span>
<a name="l01717"></a>01717   <span class="comment">// and it is the right size, then switch to it</span>
<a name="l01718"></a>01718   <span class="keywordflow">if</span> (this.displayingImage &amp;&amp; !this.displayingPreview &amp;&amp; this.preview) {
<a name="l01719"></a>01719     this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a4e1808739322e6c26eb58a5a95f30bc6">_switchToPreviewImage</a>(); <span class="comment">// resets image size and position</span>
<a name="l01720"></a>01720     <span class="keywordflow">return</span>;
<a name="l01721"></a>01721   }
<a name="l01722"></a>01722 
<a name="l01723"></a>01723   <span class="comment">// Otherwise, just resize and position the item we&#39;re already displaying</span>
<a name="l01724"></a>01724   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#aad5d33aecb415588534d9112a50acc6a">computeFit</a>();
<a name="l01725"></a>01725   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a98dd025d5d5071ff7db04e00a9c11478">setPosition</a>();
<a name="l01726"></a>01726 };
<a name="l01727"></a>01727 
<a name="l01728"></a>01728 <span class="comment">// We call this from the resize handler when the user rotates the</span>
<a name="l01729"></a>01729 <span class="comment">// screen or when going into or out of fullscreen mode. If the user</span>
<a name="l01730"></a>01730 <span class="comment">// has not zoomed in, then we just fit the image to the new size (same</span>
<a name="l01731"></a>01731 <span class="comment">// as reset).  But if the user has zoomed in (and we need to stay</span>
<a name="l01732"></a>01732 <span class="comment">// zoomed for the new size) then we adjust the fit properties so that</span>
<a name="l01733"></a>01733 <span class="comment">// the pixel that was at the center of the screen before remains at</span>
<a name="l01734"></a>01734 <span class="comment">// the center now, or as close as possible</span>
<a name="l01735"></a>01735 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.resize = <span class="keyword">function</span> <a class="code" href="../../db/d0b/_image_editor_8js.html#adab1da9beef71bb79edbfe07f16b1172">resize</a>() {
<a name="l01736"></a>01736   var oldWidth = this.viewportWidth;
<a name="l01737"></a>01737   var oldHeight = this.viewportHeight;
<a name="l01738"></a>01738   var newWidth = this.<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>.offsetWidth;
<a name="l01739"></a>01739   var newHeight = this.<a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>.offsetHeight;
<a name="l01740"></a>01740 
<a name="l01741"></a>01741   var oldfit = this.fit; <span class="comment">// The current image fit</span>
<a name="l01742"></a>01742 
<a name="l01743"></a>01743   <span class="comment">// If this is triggered by a resize event before the frame has computed</span>
<a name="l01744"></a>01744   <span class="comment">// its size, then there is nothing we can do yet.</span>
<a name="l01745"></a>01745   <span class="keywordflow">if</span> (!oldfit)
<a name="l01746"></a>01746     <span class="keywordflow">return</span>;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748   <span class="comment">// Compute the new fit.</span>
<a name="l01749"></a>01749   <span class="comment">// This updates the the viewportWidth, viewportHeight and fit properties</span>
<a name="l01750"></a>01750   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#aad5d33aecb415588534d9112a50acc6a">computeFit</a>();
<a name="l01751"></a>01751 
<a name="l01752"></a>01752   <span class="comment">// This is how the image would fit at the new screen size</span>
<a name="l01753"></a>01753   var newfit = this.fit;
<a name="l01754"></a>01754 
<a name="l01755"></a>01755   <span class="comment">// If no zooming has been done, then a resize is just a reset.</span>
<a name="l01756"></a>01756   <span class="comment">// The same is true if the new fit base scale is greater than the</span>
<a name="l01757"></a>01757   <span class="comment">// old scale.</span>
<a name="l01758"></a>01758   <span class="keywordflow">if</span> (oldfit.scale === oldfit.baseScale || newfit.baseScale &gt; oldfit.scale) {
<a name="l01759"></a>01759     this.<a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a>();
<a name="l01760"></a>01760     <span class="keywordflow">return</span>;
<a name="l01761"></a>01761   }
<a name="l01762"></a>01762 
<a name="l01763"></a>01763   <span class="comment">// Otherwise, just adjust the old fit as needed and use that so we</span>
<a name="l01764"></a>01764   <span class="comment">// retain the zoom factor.</span>
<a name="l01765"></a>01765   oldfit.left += (newWidth - oldWidth) / 2;
<a name="l01766"></a>01766   oldfit.top += (newHeight - oldHeight) / 2;
<a name="l01767"></a>01767   oldfit.baseScale = newfit.baseScale;
<a name="l01768"></a>01768   this.fit = oldfit;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770   <span class="comment">// Reposition this image without resetting the zoom</span>
<a name="l01771"></a>01771   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a98dd025d5d5071ff7db04e00a9c11478">setPosition</a>();
<a name="l01772"></a>01772 };
<a name="l01773"></a>01773 
<a name="l01774"></a>01774 <span class="comment">// Zoom in by the specified factor, adjusting the pan amount so that</span>
<a name="l01775"></a>01775 <span class="comment">// the image pixels at (fixedX, fixedY) remain at that position.</span>
<a name="l01776"></a>01776 <span class="comment">// Assume that zoom gestures can&#39;t be done in the middle of swipes, so</span>
<a name="l01777"></a>01777 <span class="comment">// if we&#39;re calling zoom, then the swipe property will be 0.</span>
<a name="l01778"></a>01778 <span class="comment">// If time is specified and non-zero, then we set a CSS transition</span>
<a name="l01779"></a>01779 <span class="comment">// to animate the zoom.</span>
<a name="l01780"></a>01780 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.zoom = <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#ae363035d715009a6834763cfdb2e0c71">zoom</a>(scale, fixedX, fixedY, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>) {
<a name="l01781"></a>01781   <span class="comment">// Ignore zooms if we&#39;re not displaying an image</span>
<a name="l01782"></a>01782   <span class="keywordflow">if</span> (!this.displayingImage)
<a name="l01783"></a>01783     <span class="keywordflow">return</span>;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785   <span class="comment">// If we were displaying the preview, switch to the full-size image</span>
<a name="l01786"></a>01786   <span class="keywordflow">if</span> (this.displayingPreview)
<a name="l01787"></a>01787     this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a158bfecf1c25582b59fa889895580225">_switchToFullSizeImage</a>();
<a name="l01788"></a>01788 
<a name="l01789"></a>01789   <span class="comment">// Never zoom in farther than the native resolution of the image</span>
<a name="l01790"></a>01790   <span class="keywordflow">if</span> (this.fit.scale * scale &gt; 1) {
<a name="l01791"></a>01791     scale = 1 / (this.fit.scale);
<a name="l01792"></a>01792   }
<a name="l01793"></a>01793   <span class="comment">// And never zoom out to make the image smaller than it would normally be</span>
<a name="l01794"></a>01794   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (this.fit.scale * scale &lt; <span class="keyword">this</span>.fit.baseScale) {
<a name="l01795"></a>01795     scale = this.fit.baseScale / this.fit.scale;
<a name="l01796"></a>01796   }
<a name="l01797"></a>01797 
<a name="l01798"></a>01798   this.fit.scale = this.fit.scale * <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>;
<a name="l01799"></a>01799 
<a name="l01800"></a>01800   <span class="comment">// Change the size of the photo</span>
<a name="l01801"></a>01801   this.fit.width = Math.floor(this.itemWidth * this.fit.scale);
<a name="l01802"></a>01802   this.fit.height = Math.floor(this.itemHeight * this.fit.scale);
<a name="l01803"></a>01803 
<a name="l01804"></a>01804   <span class="comment">// fixedX and fixedY are in viewport coordinates.</span>
<a name="l01805"></a>01805   <span class="comment">// These are the photo coordinates displayed at that point in the viewport</span>
<a name="l01806"></a>01806   var photoX = fixedX - this.fit.left;
<a name="l01807"></a>01807   var photoY = fixedY - this.fit.top;
<a name="l01808"></a>01808 
<a name="l01809"></a>01809   <span class="comment">// After zooming, these are the new photo coordinates.</span>
<a name="l01810"></a>01810   <span class="comment">// Note we just use the relative scale amount here, not this.fit.scale</span>
<a name="l01811"></a>01811   photoX = Math.floor(photoX * scale);
<a name="l01812"></a>01812   photoY = Math.floor(photoY * scale);
<a name="l01813"></a>01813 
<a name="l01814"></a>01814   <span class="comment">// To keep that point still, here are the new left and top values we need</span>
<a name="l01815"></a>01815   this.fit.left = fixedX - photoX;
<a name="l01816"></a>01816   this.fit.top = fixedY - photoY;
<a name="l01817"></a>01817 
<a name="l01818"></a>01818   <span class="comment">// Now make sure we didn&#39;t pan too much: If the image fits on the</span>
<a name="l01819"></a>01819   <span class="comment">// screen, fixed it. If the image is bigger than the screen, then</span>
<a name="l01820"></a>01820   <span class="comment">// make sure we haven&#39;t gone past any edges</span>
<a name="l01821"></a>01821   <span class="keywordflow">if</span> (this.fit.width &lt;= <span class="keyword">this</span>.viewportWidth) {
<a name="l01822"></a>01822     this.fit.left = (this.viewportWidth - this.fit.width) / 2;
<a name="l01823"></a>01823   }
<a name="l01824"></a>01824   <span class="keywordflow">else</span> {
<a name="l01825"></a>01825     <span class="comment">// Don&#39;t let the left of the photo be past the left edge of the screen</span>
<a name="l01826"></a>01826     <span class="keywordflow">if</span> (this.fit.left &gt; 0)
<a name="l01827"></a>01827       this.fit.left = 0;
<a name="l01828"></a>01828 
<a name="l01829"></a>01829     <span class="comment">// Right of photo shouldn&#39;t be to the left of the right edge</span>
<a name="l01830"></a>01830     <span class="keywordflow">if</span> (this.fit.left + <span class="keyword">this</span>.fit.width &lt; <span class="keyword">this</span>.viewportWidth) {
<a name="l01831"></a>01831       this.fit.left = this.viewportWidth - this.fit.width;
<a name="l01832"></a>01832     }
<a name="l01833"></a>01833   }
<a name="l01834"></a>01834 
<a name="l01835"></a>01835   <span class="keywordflow">if</span> (this.fit.height &lt;= <span class="keyword">this</span>.viewportHeight) {
<a name="l01836"></a>01836     this.fit.top = (this.viewportHeight - this.fit.height) / 2;
<a name="l01837"></a>01837   }
<a name="l01838"></a>01838   <span class="keywordflow">else</span> {
<a name="l01839"></a>01839     <span class="comment">// Don&#39;t let the top of the photo be below the top of the screen</span>
<a name="l01840"></a>01840     <span class="keywordflow">if</span> (this.fit.top &gt; 0)
<a name="l01841"></a>01841       this.fit.top = 0;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843     <span class="comment">// bottom of photo shouldn&#39;t be above the bottom of screen</span>
<a name="l01844"></a>01844     <span class="keywordflow">if</span> (this.fit.top + <span class="keyword">this</span>.fit.height &lt; <span class="keyword">this</span>.viewportHeight) {
<a name="l01845"></a>01845       this.fit.top = this.viewportHeight - this.fit.height;
<a name="l01846"></a>01846     }
<a name="l01847"></a>01847   }
<a name="l01848"></a>01848 
<a name="l01849"></a>01849   <span class="comment">// If a time was specified, set up a transition so that the</span>
<a name="l01850"></a>01850   <span class="comment">// call to setPosition() below is animated</span>
<a name="l01851"></a>01851   <span class="keywordflow">if</span> (<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>) {
<a name="l01852"></a>01852     <span class="comment">// If a time was specfied, animate the transformation</span>
<a name="l01853"></a>01853     var transition = <span class="stringliteral">&#39;transform &#39;</span> + <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a> + <span class="stringliteral">&#39;ms ease&#39;</span>;
<a name="l01854"></a>01854     this.image.style.transition = transition;
<a name="l01855"></a>01855     <span class="keywordflow">if</span> (this.oldimage)
<a name="l01856"></a>01856       this.oldimage.style.transition = transition;
<a name="l01857"></a>01857     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01858"></a>01858     this.image.addEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>() {
<a name="l01859"></a>01859       <span class="keyword">self</span>.image.removeEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>);
<a name="l01860"></a>01860       <span class="keyword">self</span>.image.style.transition = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01861"></a>01861     });
<a name="l01862"></a>01862   }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a98dd025d5d5071ff7db04e00a9c11478">setPosition</a>();
<a name="l01865"></a>01865 };
<a name="l01866"></a>01866 
<a name="l01867"></a>01867 <span class="comment">// If the item being displayed is larger than the continer, pan it by</span>
<a name="l01868"></a>01868 <span class="comment">// the specified amounts.  Return the &quot;unused&quot; dx amount for the gallery app</span>
<a name="l01869"></a>01869 <span class="comment">// to use for sideways swiping</span>
<a name="l01870"></a>01870 <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>.prototype.pan = <span class="keyword">function</span>(dx, dy) {
<a name="l01871"></a>01871   <span class="comment">// We can only pan images, so return the entire dx amount</span>
<a name="l01872"></a>01872   <span class="keywordflow">if</span> (!this.displayingImage) {
<a name="l01873"></a>01873     <span class="keywordflow">return</span> dx;
<a name="l01874"></a>01874   }
<a name="l01875"></a>01875 
<a name="l01876"></a>01876   <span class="comment">// Handle panning in the y direction first, since it is easier.</span>
<a name="l01877"></a>01877   <span class="comment">// Don&#39;t pan in the y direction if we already fit on the screen</span>
<a name="l01878"></a>01878   <span class="keywordflow">if</span> (this.fit.height &gt; <span class="keyword">this</span>.viewportHeight) {
<a name="l01879"></a>01879     this.fit.top += dy;
<a name="l01880"></a>01880 
<a name="l01881"></a>01881     <span class="comment">// Don&#39;t let the top of the photo be below the top of the screen</span>
<a name="l01882"></a>01882     <span class="keywordflow">if</span> (this.fit.top &gt; 0)
<a name="l01883"></a>01883       this.fit.top = 0;
<a name="l01884"></a>01884 
<a name="l01885"></a>01885     <span class="comment">// bottom of photo shouldn&#39;t be above the bottom of screen</span>
<a name="l01886"></a>01886     <span class="keywordflow">if</span> (this.fit.top + <span class="keyword">this</span>.fit.height &lt; <span class="keyword">this</span>.viewportHeight)
<a name="l01887"></a>01887       this.fit.top = this.viewportHeight - this.fit.height;
<a name="l01888"></a>01888   }
<a name="l01889"></a>01889 
<a name="l01890"></a>01890   <span class="comment">// Now handle the X dimension. If we&#39;ve already panned as far as we can</span>
<a name="l01891"></a>01891   <span class="comment">// within the image (or if it isn&#39;t zoomed in) then return the &quot;extra&quot;</span>
<a name="l01892"></a>01892   <span class="comment">// unused dx amount to the caller so that the caller can use them to</span>
<a name="l01893"></a>01893   <span class="comment">// shift the frame left or right.</span>
<a name="l01894"></a>01894   var extra = 0;
<a name="l01895"></a>01895 
<a name="l01896"></a>01896   <span class="keywordflow">if</span> (this.fit.width &lt;= <span class="keyword">this</span>.viewportWidth) {
<a name="l01897"></a>01897     <span class="comment">// In this case, the photo isn&#39;t zoomed in, so it is all extra</span>
<a name="l01898"></a>01898     extra = dx;
<a name="l01899"></a>01899   }
<a name="l01900"></a>01900   <span class="keywordflow">else</span> {
<a name="l01901"></a>01901     this.fit.left += dx;
<a name="l01902"></a>01902 
<a name="l01903"></a>01903     <span class="comment">// If this would take the left edge of the photo past the</span>
<a name="l01904"></a>01904     <span class="comment">// left edge of the screen, then some of the motion is extra</span>
<a name="l01905"></a>01905     <span class="keywordflow">if</span> (this.fit.left &gt; 0) {
<a name="l01906"></a>01906       extra = this.fit.left;
<a name="l01907"></a>01907       this.fit.left = 0;
<a name="l01908"></a>01908     }
<a name="l01909"></a>01909 
<a name="l01910"></a>01910     <span class="comment">// Or, if this would take the right edge of the photo past the</span>
<a name="l01911"></a>01911     <span class="comment">// right edge of the screen, then we&#39;ve got extra.</span>
<a name="l01912"></a>01912     <span class="keywordflow">if</span> (this.fit.left + <span class="keyword">this</span>.fit.width &lt; <span class="keyword">this</span>.viewportWidth) {
<a name="l01913"></a>01913       extra = this.fit.left + this.fit.width - this.viewportWidth;
<a name="l01914"></a>01914       this.fit.left = this.viewportWidth - this.fit.width;
<a name="l01915"></a>01915     }
<a name="l01916"></a>01916   }
<a name="l01917"></a>01917 
<a name="l01918"></a>01918   this.<a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a98dd025d5d5071ff7db04e00a9c11478">setPosition</a>();
<a name="l01919"></a>01919   <span class="keywordflow">return</span> extra;
<a name="l01920"></a>01920 };
<a name="l01921"></a>01921 <span class="comment">// This file contains Gallery code related to the fullscreen view</span>
<a name="l01922"></a>01922 
<a name="l01923"></a>01923 <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925 var <a class="code" href="../../d8/df0/frames_8js.html#aa4b20d1ccb4713cd1de75d236b5e9211">frames</a> = $(<span class="stringliteral">&#39;frames&#39;</span>);
<a name="l01926"></a>01926 
<a name="l01927"></a>01927 <span class="comment">// These three objects are holders for the previous, current and next</span>
<a name="l01928"></a>01928 <span class="comment">// photos or videos to be displayed. They get swapped around and</span>
<a name="l01929"></a>01929 <span class="comment">// reused when we pan to the next or previous photo: next becomes</span>
<a name="l01930"></a>01930 <span class="comment">// current, current becomes previous etc.  See nextFile() and</span>
<a name="l01931"></a>01931 <span class="comment">// previousFile().  Note also that the Frame object is not a DOM</span>
<a name="l01932"></a>01932 <span class="comment">// element.  Use currentFrame.container to refer to the div</span>
<a name="l01933"></a>01933 <span class="comment">// element. The frame constructor creates an &lt;img&gt; element, a &lt;video&gt;</span>
<a name="l01934"></a>01934 <span class="comment">// element, and video player controls within the div, and you can refer to</span>
<a name="l01935"></a>01935 <span class="comment">// those as currentFrame.image and currentFrame.video.player and</span>
<a name="l01936"></a>01936 <span class="comment">// currentFrame.video.controls.</span>
<a name="l01937"></a>01937 var <a class="code" href="../../d8/df0/frames_8js.html#a5d60985775a23d0a9fc6afa50e245ddc">previousFrame</a> = <span class="keyword">new</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>($(<span class="stringliteral">&#39;frame1&#39;</span>));
<a name="l01938"></a>01938 var <a class="code" href="../../d8/df0/frames_8js.html#a35a1d5b2c11c745f050a319c2940c383">currentFrame</a> = <span class="keyword">new</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>($(<span class="stringliteral">&#39;frame2&#39;</span>));
<a name="l01939"></a>01939 var <a class="code" href="../../d8/df0/frames_8js.html#a007e837054378566ec403efc4d177e58">nextFrame</a> = <span class="keyword">new</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a369a818079f25867bf624967bbc86bf7">MediaFrame</a>($(<span class="stringliteral">&#39;frame3&#39;</span>));
<a name="l01940"></a>01940 
<a name="l01941"></a>01941 <span class="comment">// When this variable is set to true, we ignore any user gestures</span>
<a name="l01942"></a>01942 <span class="comment">// so we don&#39;t try to pan or zoom during a frame transition.</span>
<a name="l01943"></a>01943 var <a class="code" href="../../d8/df0/frames_8js.html#a6dd335ba65f38ed72cb9599732a2ce52">transitioning</a> = <span class="keyword">false</span>;
<a name="l01944"></a>01944 
<a name="l01945"></a>01945 <span class="comment">// Clicking on the back button goes back to the thumbnail view</span>
<a name="l01946"></a>01946 $(<span class="stringliteral">&#39;fullscreen-back-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l01947"></a>01947 
<a name="l01948"></a>01948 <span class="comment">// Clicking the delete button while viewing a single item deletes that item</span>
<a name="l01949"></a>01949 $(<span class="stringliteral">&#39;fullscreen-delete-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../d8/df0/frames_8js.html#ae82d4471f0a3ddd4d7dde2a10e7b6857">deleteSingleItem</a>;
<a name="l01950"></a>01950 
<a name="l01951"></a>01951 <span class="comment">// Clicking the Edit button while viewing a photo switches to edit mode</span>
<a name="l01952"></a>01952 $(<span class="stringliteral">&#39;fullscreen-edit-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <span class="keyword">function</span>() {
<a name="l01953"></a>01953   <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a78601e1f2fe929d6470d82a205ad2382">loader</a>.load(<span class="stringliteral">&#39;js/ImageEditor.js&#39;</span>, <span class="keyword">function</span>() {
<a name="l01954"></a>01954     <a class="code" href="../../db/d0b/_image_editor_8js.html#acd058f2b5b35e5443cc4e6a485ba0bde">editPhotoIfCardNotFull</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a>);
<a name="l01955"></a>01955   });
<a name="l01956"></a>01956 };
<a name="l01957"></a>01957 
<a name="l01958"></a>01958 <span class="comment">// In fullscreen mode, the share button shares the current item</span>
<a name="l01959"></a>01959 $(<span class="stringliteral">&#39;fullscreen-share-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../d8/df0/frames_8js.html#aa343e1612db36a59da6bb36f1d689b02">shareSingleItem</a>;
<a name="l01960"></a>01960 
<a name="l01961"></a>01961 <span class="comment">// Use the GestureDetector.js library to handle gestures.</span>
<a name="l01962"></a>01962 <span class="comment">// This will generate tap, pan, swipe and transform events</span>
<a name="l01963"></a>01963 <span class="keyword">new</span> <a class="code" href="../../d8/df0/frames_8js.html#a050c35bd1ae66a249cd6c3554661e24a">GestureDetector</a>(frames).startDetecting();
<a name="l01964"></a>01964 
<a name="l01965"></a>01965 <span class="comment">// Handle gesture events</span>
<a name="l01966"></a>01966 frames.addEventListener(<span class="stringliteral">&#39;tap&#39;</span>, <a class="code" href="../../d8/df0/frames_8js.html#ae31edd530b9d6d637f28f0c5d870a041">tapHandler</a>);
<a name="l01967"></a>01967 frames.addEventListener(<span class="stringliteral">&#39;dbltap&#39;</span>, <a class="code" href="../../d8/df0/frames_8js.html#a05881f0379b775fcee0369ac1b833127">dblTapHandler</a>);
<a name="l01968"></a>01968 frames.addEventListener(<span class="stringliteral">&#39;pan&#39;</span>, <a class="code" href="../../d8/df0/frames_8js.html#a0bace378c552e99ff6419193cec6ebb8">panHandler</a>);
<a name="l01969"></a>01969 frames.addEventListener(<span class="stringliteral">&#39;swipe&#39;</span>, <a class="code" href="../../d8/df0/frames_8js.html#ad9665f9301f7f2377544509ce6c50b19">swipeHandler</a>);
<a name="l01970"></a>01970 frames.addEventListener(<span class="stringliteral">&#39;transform&#39;</span>, <a class="code" href="../../d8/df0/frames_8js.html#a8078be94a625f6eb369ac4b46d230254">transformHandler</a>);
<a name="l01971"></a>01971 
<a name="l01972"></a>01972 <span class="comment">// When displaying a photo or video, a tap hides or shows the toolbar.</span>
<a name="l01973"></a>01973 <span class="comment">// The video player has its own toolbar, so when a video starts playing</span>
<a name="l01974"></a>01974 <span class="comment">// we want to hide the gallery toolbar. And then restore it on pause.</span>
<a name="l01975"></a>01975 <span class="comment">// All three players need this pair of event handlers.</span>
<a name="l01976"></a>01976 <span class="comment">// Note that we&#39;re using the onplaying/onpaused fake handlers the</span>
<a name="l01977"></a>01977 <span class="comment">// VideoPlayer object, not the real onplay/onpause handlers of the &lt;video&gt;</span>
<a name="l01978"></a>01978 <span class="comment">// element. This is because VideoPlayer pauses and plays the &lt;video&gt; when</span>
<a name="l01979"></a>01979 <span class="comment">// the user drags on the slider, and we don&#39;t want to trigger these handlers</span>
<a name="l01980"></a>01980 <span class="comment">// in that case.</span>
<a name="l01981"></a>01981 currentFrame.video.onplaying =
<a name="l01982"></a>01982   previousFrame.video.onplaying =
<a name="l01983"></a>01983   nextFrame.video.onplaying =
<a name="l01984"></a>01984   <span class="keyword">function</span> hideToolbarOnPlay() {
<a name="l01985"></a>01985     this.toolbarWasHidden =
<a name="l01986"></a>01986       <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>.classList.contains(<span class="stringliteral">&#39;toolbarhidden&#39;</span>);
<a name="l01987"></a>01987     <span class="keywordflow">if</span> (!this.isToolbarHidden)
<a name="l01988"></a>01988       <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>.classList.add(<span class="stringliteral">&#39;toolbarhidden&#39;</span>);
<a name="l01989"></a>01989   };
<a name="l01990"></a>01990 
<a name="l01991"></a>01991 currentFrame.video.onpaused =
<a name="l01992"></a>01992   previousFrame.video.onpaused =
<a name="l01993"></a>01993   nextFrame.video.onpaused =
<a name="l01994"></a>01994   <span class="keyword">function</span> restoreToolbarOnPause() {
<a name="l01995"></a>01995     <span class="keywordflow">if</span> (this.toolbarWasHidden === <span class="keyword">false</span>)
<a name="l01996"></a>01996       <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>.classList.remove(<span class="stringliteral">&#39;toolbarhidden&#39;</span>);
<a name="l01997"></a>01997     <span class="keyword">delete</span> this.toolbarWasHidden;
<a name="l01998"></a>01998   };
<a name="l01999"></a>01999 
<a name="l02000"></a>02000 <span class="comment">// Each of the Frame container elements may be subject to animated</span>
<a name="l02001"></a>02001 <span class="comment">// transitions. So give them transitionend event handlers that</span>
<a name="l02002"></a>02002 <span class="comment">// remove the transition style property when the transition ends.</span>
<a name="l02003"></a>02003 <span class="comment">// This helps prevent unexpected transitions.</span>
<a name="l02004"></a>02004 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a840e168d670ba0ccb74cb0a6156b220f">removeTransition</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l02005"></a>02005   <span class="keyword">event</span>.target.style.transition = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02006"></a>02006 }
<a name="l02007"></a>02007 
<a name="l02008"></a>02008 previousFrame.container.addEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <a class="code" href="../../d8/df0/frames_8js.html#a840e168d670ba0ccb74cb0a6156b220f">removeTransition</a>);
<a name="l02009"></a>02009 currentFrame.container.addEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <a class="code" href="../../d8/df0/frames_8js.html#a840e168d670ba0ccb74cb0a6156b220f">removeTransition</a>);
<a name="l02010"></a>02010 nextFrame.container.addEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <a class="code" href="../../d8/df0/frames_8js.html#a840e168d670ba0ccb74cb0a6156b220f">removeTransition</a>);
<a name="l02011"></a>02011 
<a name="l02012"></a>02012 <span class="comment">// Clicking the delete button while viewing a single item deletes that item</span>
<a name="l02013"></a>02013 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#ae82d4471f0a3ddd4d7dde2a10e7b6857">deleteSingleItem</a>() {
<a name="l02014"></a>02014   var <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>;
<a name="l02015"></a>02015   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[<a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a>].metadata.video) {
<a name="l02016"></a>02016     msg = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;delete-video?&#39;</span>);
<a name="l02017"></a>02017   }
<a name="l02018"></a>02018   <span class="keywordflow">else</span> {
<a name="l02019"></a>02019     msg = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;delete-photo?&#39;</span>);
<a name="l02020"></a>02020   }
<a name="l02021"></a>02021   <span class="keywordflow">if</span> (<a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#ab77aa8c2fa705d45d7ff1db3a11306ae">confirm</a>(msg)) {
<a name="l02022"></a>02022     <span class="comment">// disable delete and share button to prevent operations while delete item</span>
<a name="l02023"></a>02023     $(<span class="stringliteral">&#39;fullscreen-delete-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02024"></a>02024     $(<span class="stringliteral">&#39;fullscreen-share-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02025"></a>02025 
<a name="l02026"></a>02026     <a class="code" href="../../d0/da2/gallery_8js.html#a1d34740c9f45587facea86c15f99a2c6">deleteFile</a>(currentFileIndex);
<a name="l02027"></a>02027   }
<a name="l02028"></a>02028 }
<a name="l02029"></a>02029 
<a name="l02030"></a>02030 <span class="comment">// In fullscreen mode, the share button shares the current item</span>
<a name="l02031"></a>02031 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#aa343e1612db36a59da6bb36f1d689b02">shareSingleItem</a>() {
<a name="l02032"></a>02032   <a class="code" href="../../dd/d85/video_8js.html#a1adf7471b1bc968b8517bf786fffa94d">share</a>([currentFrame.imageblob || currentFrame.videoblob]);
<a name="l02033"></a>02033 }
<a name="l02034"></a>02034 
<a name="l02035"></a>02035 <span class="comment">// In order to distinguish single taps from double taps, we have to</span>
<a name="l02036"></a>02036 <span class="comment">// wait after a tap arrives to make sure that a dbltap event isn&#39;t</span>
<a name="l02037"></a>02037 <span class="comment">// coming soon.</span>
<a name="l02038"></a>02038 var <a class="code" href="../../d8/df0/frames_8js.html#a03181923cb507c8a5e60d94a0962cb46">taptimer</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02039"></a>02039 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#ae31edd530b9d6d637f28f0c5d870a041">tapHandler</a>(e) {
<a name="l02040"></a>02040   <span class="comment">// If there is already a timer set, then this is is the second tap</span>
<a name="l02041"></a>02041   <span class="comment">// and we&#39;re about to get a dbl tap event, so ignore this one</span>
<a name="l02042"></a>02042   <span class="keywordflow">if</span> (taptimer)
<a name="l02043"></a>02043     <span class="keywordflow">return</span>;
<a name="l02044"></a>02044   <span class="comment">// If we don&#39;t get a second tap soon, then treat this as a single tap</span>
<a name="l02045"></a>02045   taptimer = <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() {
<a name="l02046"></a>02046     taptimer = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02047"></a>02047     <a class="code" href="../../d8/df0/frames_8js.html#a5921ceb00f11d9b2e84c57c6d370654a">singletap</a>(e);
<a name="l02048"></a>02048   }, <a class="code" href="../../d8/df0/frames_8js.html#a050c35bd1ae66a249cd6c3554661e24a">GestureDetector</a>.DOUBLE_TAP_TIME);
<a name="l02049"></a>02049 }
<a name="l02050"></a>02050 
<a name="l02051"></a>02051 <span class="comment">// Dispatch double tap events, but only when displaying a photo</span>
<a name="l02052"></a>02052 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a05881f0379b775fcee0369ac1b833127">dblTapHandler</a>(e) {
<a name="l02053"></a>02053   <span class="keywordflow">if</span> (currentFrame.displayingVideo)
<a name="l02054"></a>02054     <span class="keywordflow">return</span>;
<a name="l02055"></a>02055 
<a name="l02056"></a>02056   <a class="code" href="../../da/da1/timers_8js.html#ab37ff0db33a3bf80b0163adc40a58424">clearTimeout</a>(taptimer);
<a name="l02057"></a>02057   taptimer = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02058"></a>02058   <a class="code" href="../../d8/df0/frames_8js.html#ac6b5053b91e30f919d71257a5dee51b5">doubletapOnPhoto</a>(e);
<a name="l02059"></a>02059 }
<a name="l02060"></a>02060 
<a name="l02061"></a>02061 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a5921ceb00f11d9b2e84c57c6d370654a">singletap</a>(e) {
<a name="l02062"></a>02062   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>) {
<a name="l02063"></a>02063     <span class="keywordflow">if</span> (currentFrame.displayingImage || currentFrame.video.player.paused) {
<a name="l02064"></a>02064       <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>.classList.toggle(<span class="stringliteral">&#39;toolbarhidden&#39;</span>);
<a name="l02065"></a>02065     }
<a name="l02066"></a>02066   }
<a name="l02067"></a>02067 }
<a name="l02068"></a>02068 
<a name="l02069"></a>02069 <span class="comment">// Quick zoom in and out with dbltap events</span>
<a name="l02070"></a>02070 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#ac6b5053b91e30f919d71257a5dee51b5">doubletapOnPhoto</a>(e) {
<a name="l02071"></a>02071   <span class="comment">// Don&#39;t allow zooming while we&#39;re still scanning for photos and</span>
<a name="l02072"></a>02072   <span class="comment">// have found large photos without previews on the card.  Zooming in</span>
<a name="l02073"></a>02073   <span class="comment">// decodes the full-size version of the photo and that can cause OOM</span>
<a name="l02074"></a>02074   <span class="comment">// errors if there is also metadata scanning going on with large images.</span>
<a name="l02075"></a>02075   <span class="comment">// XXX: Remove this when bug 854795 is fixed.</span>
<a name="l02076"></a>02076   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.parsingBigFiles)
<a name="l02077"></a>02077     <span class="keywordflow">return</span>;
<a name="l02078"></a>02078 
<a name="l02079"></a>02079   var <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>;
<a name="l02080"></a>02080   <span class="keywordflow">if</span> (currentFrame.fit.scale &gt; currentFrame.fit.baseScale)   <span class="comment">// If zoomed in</span>
<a name="l02081"></a>02081     scale = currentFrame.fit.baseScale / currentFrame.fit.scale; <span class="comment">// zoom out</span>
<a name="l02082"></a>02082   <span class="keywordflow">else</span>                                                       <span class="comment">// Otherwise</span>
<a name="l02083"></a>02083     scale = 2;                                                   <span class="comment">// zoom in</span>
<a name="l02084"></a>02084 
<a name="l02085"></a>02085   currentFrame.zoom(scale, e.detail.clientX, e.detail.clientY, 200);
<a name="l02086"></a>02086 }
<a name="l02087"></a>02087 
<a name="l02088"></a>02088 <span class="comment">// Pan the item sideways when the user moves their finger across the screen</span>
<a name="l02089"></a>02089 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a0bace378c552e99ff6419193cec6ebb8">panHandler</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l02090"></a>02090   <span class="keywordflow">if</span> (transitioning)
<a name="l02091"></a>02091     <span class="keywordflow">return</span>;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093   var dx = <span class="keyword">event</span>.detail.relative.dx;
<a name="l02094"></a>02094   var dy = <span class="keyword">event</span>.detail.relative.dy;
<a name="l02095"></a>02095   var oldFrameOffset = <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a>;
<a name="l02096"></a>02096 
<a name="l02097"></a>02097   <span class="comment">// If the frames are already being shifted in the same direction as</span>
<a name="l02098"></a>02098   <span class="comment">// dx then this just continues the shift.  Otherwise, dx might shift</span>
<a name="l02099"></a>02099   <span class="comment">// them back toward the center. If the frames are unshifted to begin</span>
<a name="l02100"></a>02100   <span class="comment">// with or become unshifted after applying dx, then we have got to</span>
<a name="l02101"></a>02101   <span class="comment">// pass dx to the pan() method of the frame, because it might pan</span>
<a name="l02102"></a>02102   <span class="comment">// the image within the frame. But that method returns any dx it</span>
<a name="l02103"></a>02103   <span class="comment">// can&#39;t use, and we apply that to shifting the frames.</span>
<a name="l02104"></a>02104 
<a name="l02105"></a>02105   <span class="comment">// If the frames are already shifted and dx is in the same direction, or</span>
<a name="l02106"></a>02106   <span class="comment">// if dx is in the opposite direction but isn&#39;t big enough to bring</span>
<a name="l02107"></a>02107   <span class="comment">// the frames back to the center, just adjust the frame positions.</span>
<a name="l02108"></a>02108   <span class="comment">// There is no need to pan the content of the frame in this case.</span>
<a name="l02109"></a>02109   <span class="keywordflow">if</span> ((<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> &gt; 0 &amp;&amp; dx &gt; 0) ||
<a name="l02110"></a>02110       (<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> &lt; 0 &amp;&amp; dx &lt; 0) ||
<a name="l02111"></a>02111       (<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> !== 0 &amp;&amp; <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> &gt; -dx)) {
<a name="l02112"></a>02112     <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> += dx;
<a name="l02113"></a>02113   }
<a name="l02114"></a>02114   <span class="keywordflow">else</span> {
<a name="l02115"></a>02115     <span class="comment">// If the frame is shifted, this dx brings it back to center</span>
<a name="l02116"></a>02116     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> !== 0) {
<a name="l02117"></a>02117       dx += <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a>;
<a name="l02118"></a>02118       <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> = 0;
<a name="l02119"></a>02119     }
<a name="l02120"></a>02120 
<a name="l02121"></a>02121     <span class="comment">// Now let the frame pan its content, and add any dx that it doesn&#39;t use</span>
<a name="l02122"></a>02122     <span class="comment">// to the frame offset</span>
<a name="l02123"></a>02123     <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> += currentFrame.pan(dx, dy);
<a name="l02124"></a>02124   }
<a name="l02125"></a>02125 
<a name="l02126"></a>02126   <span class="comment">// Don&#39;t swipe past the end of the last item or past the start of the first</span>
<a name="l02127"></a>02127   <span class="keywordflow">if</span> ((currentFileIndex === 0 &amp;&amp; <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> &gt; 0) ||
<a name="l02128"></a>02128       (currentFileIndex === <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length - 1 &amp;&amp; <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> &lt; 0)) {
<a name="l02129"></a>02129     <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> = 0;
<a name="l02130"></a>02130   }
<a name="l02131"></a>02131 
<a name="l02132"></a>02132   <span class="comment">// If the frameOffset has changed since we started, reposition the frames</span>
<a name="l02133"></a>02133   <span class="keywordflow">if</span> (<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> !== oldFrameOffset)
<a name="l02134"></a>02134     <a class="code" href="../../d8/df0/frames_8js.html#a1e990ee9315d596bcab04e06af23ceea">setFramesPosition</a>();
<a name="l02135"></a>02135 }
<a name="l02136"></a>02136 
<a name="l02137"></a>02137 <span class="comment">// When the user lifts their finger after panning we get this event</span>
<a name="l02138"></a>02138 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#ad9665f9301f7f2377544509ce6c50b19">swipeHandler</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l02139"></a>02139   <span class="comment">// If we just panned within a zoomed-in photo, and the frames are not</span>
<a name="l02140"></a>02140   <span class="comment">// shifted at all, then we don&#39;t have to do anything here.</span>
<a name="l02141"></a>02141   <span class="keywordflow">if</span> (<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> === 0)
<a name="l02142"></a>02142     <span class="keywordflow">return</span>;
<a name="l02143"></a>02143 
<a name="l02144"></a>02144   <span class="comment">// 1 means we&#39;re going to the next item -1 means the previous</span>
<a name="l02145"></a>02145   var <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a> = (<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> &lt; 0) ? 1 : -1;
<a name="l02146"></a>02146 
<a name="l02147"></a>02147   <span class="comment">// If we&#39;re in a right-to-left locale, reverse those directions</span>
<a name="l02148"></a>02148   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a82bac0ea52a4192fdf6f4ad005ef687d">languageDirection</a> === <span class="stringliteral">&#39;rtl&#39;</span>)
<a name="l02149"></a>02149     direction *= -1;
<a name="l02150"></a>02150 
<a name="l02151"></a>02151   <span class="comment">// Did we pan far enough or swipe fast enough to transition to</span>
<a name="l02152"></a>02152   <span class="comment">// a different item?</span>
<a name="l02153"></a>02153   var farenough =
<a name="l02154"></a>02154     Math.abs(<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a>) &gt; <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.innerWidth * <a class="code" href="../../d0/da2/gallery_8js.html#a473a610b53b4a3ebf03fb3ffc7dd43b4">TRANSITION_FRACTION</a>;
<a name="l02155"></a>02155   var velocity = <span class="keyword">event</span>.detail.vx;
<a name="l02156"></a>02156   var fastenough = Math.abs(velocity) &gt; <a class="code" href="../../d0/da2/gallery_8js.html#ad8d2e967e68a60d54c588d6823984541">TRANSITION_SPEED</a>;
<a name="l02157"></a>02157 
<a name="l02158"></a>02158   <span class="comment">// Make sure that that the speed and pan amount are in the same direction</span>
<a name="l02159"></a>02159   var samedirection = velocity === 0 || <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> / velocity &gt;= 0;
<a name="l02160"></a>02160 
<a name="l02161"></a>02161   <span class="comment">// Is there a next or previous item to transition to?</span>
<a name="l02162"></a>02162   var fileexists =
<a name="l02163"></a>02163     (direction === 1 &amp;&amp; currentFileIndex + 1 &lt; <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length) ||
<a name="l02164"></a>02164     (direction === -1 &amp;&amp; currentFileIndex &gt; 0);
<a name="l02165"></a>02165 
<a name="l02166"></a>02166   <span class="comment">// If all of these conditions hold, then we&#39;ll transition to the</span>
<a name="l02167"></a>02167   <span class="comment">// next photo or the previous photo</span>
<a name="l02168"></a>02168   <span class="keywordflow">if</span> (direction !== 0 &amp;&amp; (farenough || fastenough) &amp;&amp;
<a name="l02169"></a>02169       samedirection &amp;&amp; fileexists) {
<a name="l02170"></a>02170 
<a name="l02171"></a>02171     <span class="comment">// Compute how long the transition should take based on the velocity</span>
<a name="l02172"></a>02172     var speed = Math.max(Math.abs(velocity), <a class="code" href="../../d0/da2/gallery_8js.html#ad8d2e967e68a60d54c588d6823984541">TRANSITION_SPEED</a>);
<a name="l02173"></a>02173     var <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a> = (<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.innerWidth - Math.abs(<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a>)) / speed;
<a name="l02174"></a>02174 
<a name="l02175"></a>02175     <span class="comment">// Transition frames in the appropriate direction</span>
<a name="l02176"></a>02176     <span class="keywordflow">if</span> (direction === 1)
<a name="l02177"></a>02177       <a class="code" href="../../d8/df0/frames_8js.html#a54115720eddd216055dc110c3ab8b7f4">nextFile</a>(time);
<a name="l02178"></a>02178     <span class="keywordflow">else</span>
<a name="l02179"></a>02179       <a class="code" href="../../d8/df0/frames_8js.html#a631221a1a1b95efdcd1cb92386f83131">previousFile</a>(time);
<a name="l02180"></a>02180   }
<a name="l02181"></a>02181   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> !== 0) {
<a name="l02182"></a>02182     <span class="comment">// Otherwise, just restore the current item by undoing</span>
<a name="l02183"></a>02183     <span class="comment">// the translations we added during panning</span>
<a name="l02184"></a>02184     var time = Math.abs(<a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a>) / <a class="code" href="../../d0/da2/gallery_8js.html#ad8d2e967e68a60d54c588d6823984541">TRANSITION_SPEED</a>;
<a name="l02185"></a>02185 
<a name="l02186"></a>02186     currentFrame.container.style.transition =
<a name="l02187"></a>02187       nextFrame.container.style.transition =
<a name="l02188"></a>02188       previousFrame.container.style.transition =
<a name="l02189"></a>02189       <span class="stringliteral">&#39;transform &#39;</span> + time + <span class="stringliteral">&#39;ms ease&#39;</span>;
<a name="l02190"></a>02190 
<a name="l02191"></a>02191     <a class="code" href="../../d8/df0/frames_8js.html#aa95a0e33ee54ea6e80e6ca47df7ecf96">resetFramesPosition</a>();
<a name="l02192"></a>02192 
<a name="l02193"></a>02193     <span class="comment">// Ignore  pan and zoom gestures while the transition happens</span>
<a name="l02194"></a>02194     transitioning = <span class="keyword">true</span>;
<a name="l02195"></a>02195     <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() { transitioning = <span class="keyword">false</span>; }, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>);
<a name="l02196"></a>02196   }
<a name="l02197"></a>02197 }
<a name="l02198"></a>02198 
<a name="l02199"></a>02199 <span class="comment">// We also support pinch-to-zoom</span>
<a name="l02200"></a>02200 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a8078be94a625f6eb369ac4b46d230254">transformHandler</a>(e) {
<a name="l02201"></a>02201   <span class="keywordflow">if</span> (transitioning)
<a name="l02202"></a>02202     <span class="keywordflow">return</span>;
<a name="l02203"></a>02203 
<a name="l02204"></a>02204   <span class="comment">// Don&#39;t allow zooming while we&#39;re still scanning for photos and</span>
<a name="l02205"></a>02205   <span class="comment">// have found large photos without previews on the card.  Zooming in</span>
<a name="l02206"></a>02206   <span class="comment">// decodes the full-size version of the photo and that can cause OOM</span>
<a name="l02207"></a>02207   <span class="comment">// errors if there is also metadata scanning going on with large images.</span>
<a name="l02208"></a>02208   <span class="comment">// XXX: Remove this when bug 854795 is fixed.</span>
<a name="l02209"></a>02209   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.parsingBigFiles)
<a name="l02210"></a>02210     <span class="keywordflow">return</span>;
<a name="l02211"></a>02211 
<a name="l02212"></a>02212   currentFrame.zoom(e.detail.relative.scale,
<a name="l02213"></a>02213                     e.detail.midpoint.clientX,
<a name="l02214"></a>02214                     e.detail.midpoint.clientY);
<a name="l02215"></a>02215 }
<a name="l02216"></a>02216 
<a name="l02217"></a>02217 <span class="comment">// A utility function to display the nth image or video in the specified frame</span>
<a name="l02218"></a>02218 <span class="comment">// Used in showFile(), nextFile() and previousFile().</span>
<a name="l02219"></a>02219 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a9da97cccdb118a001a04c6062ff6c31f">setupFrameContent</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, frame) {
<a name="l02220"></a>02220   <span class="comment">// Make sure n is in range</span>
<a name="l02221"></a>02221   <span class="keywordflow">if</span> (n &lt; 0 || n &gt;= <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length) {
<a name="l02222"></a>02222     frame.clear();
<a name="l02223"></a>02223     <span class="keyword">delete</span> frame.filename;
<a name="l02224"></a>02224     <span class="keywordflow">return</span>;
<a name="l02225"></a>02225   }
<a name="l02226"></a>02226 
<a name="l02227"></a>02227   var fileinfo = <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>];
<a name="l02228"></a>02228 
<a name="l02229"></a>02229   <span class="comment">// If we&#39;re already displaying this file in this frame, then do nothing</span>
<a name="l02230"></a>02230   <span class="keywordflow">if</span> (fileinfo.name === frame.filename)
<a name="l02231"></a>02231     <span class="keywordflow">return</span>;
<a name="l02232"></a>02232 
<a name="l02233"></a>02233   <span class="comment">// Remember what file we&#39;re going to display</span>
<a name="l02234"></a>02234   frame.filename = fileinfo.name;
<a name="l02235"></a>02235 
<a name="l02236"></a>02236   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.getFile(fileinfo.name, <span class="keyword">function</span>(imagefile) {
<a name="l02237"></a>02237     <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (fileinfo.metadata.video) {
<a name="l02238"></a>02238       <span class="comment">// If this is a video, then the file we just got is the poster image</span>
<a name="l02239"></a>02239       <span class="comment">// and we still have to fetch the actual video</span>
<a name="l02240"></a>02240       <a class="code" href="../../d0/da2/gallery_8js.html#a377c40257a942d42736eccd490acfec4">getVideoFile</a>(fileinfo.metadata.video, <span class="keyword">function</span>(videofile) {
<a name="l02241"></a>02241         frame.displayVideo(videofile, imagefile,
<a name="l02242"></a>02242                            fileinfo.metadata.width,
<a name="l02243"></a>02243                            fileinfo.metadata.height,
<a name="l02244"></a>02244                            fileinfo.metadata.rotation || 0);
<a name="l02245"></a>02245       });
<a name="l02246"></a>02246     }
<a name="l02247"></a>02247     <span class="keywordflow">else</span> {
<a name="l02248"></a>02248       <span class="comment">// Otherwise, just display the image</span>
<a name="l02249"></a>02249       frame.displayImage(
<a name="l02250"></a>02250         imagefile,
<a name="l02251"></a>02251         fileinfo.metadata.width,
<a name="l02252"></a>02252         fileinfo.metadata.height,
<a name="l02253"></a>02253         fileinfo.metadata.preview,
<a name="l02254"></a>02254         fileinfo.metadata.rotation,
<a name="l02255"></a>02255         fileinfo.metadata.mirrored);
<a name="l02256"></a>02256     }
<a name="l02257"></a>02257   });
<a name="l02258"></a>02258 }
<a name="l02259"></a>02259 
<a name="l02260"></a>02260 var <a class="code" href="../../d8/df0/frames_8js.html#a77049356895d3318ab88c979e2609cbb">FRAME_BORDER_WIDTH</a> = 3;
<a name="l02261"></a>02261 var <a class="code" href="../../d8/df0/frames_8js.html#afab17aea44ce63fa9af1a13fc2ab7564">frameOffset</a> = 0; <span class="comment">// how far are the frames swiped side-to-side?</span>
<a name="l02262"></a>02262 
<a name="l02263"></a>02263 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a1e990ee9315d596bcab04e06af23ceea">setFramesPosition</a>() {
<a name="l02264"></a>02264   <span class="comment">// XXX for RTL languages we should swap next and previous sides</span>
<a name="l02265"></a>02265   var width = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.innerWidth + <a class="code" href="../../d8/df0/frames_8js.html#a77049356895d3318ab88c979e2609cbb">FRAME_BORDER_WIDTH</a>;
<a name="l02266"></a>02266   currentFrame.container.style.transform =
<a name="l02267"></a>02267     <span class="stringliteral">&#39;translateX(&#39;</span> + frameOffset + <span class="stringliteral">&#39;px)&#39;</span>;
<a name="l02268"></a>02268   nextFrame.container.style.transform =
<a name="l02269"></a>02269     <span class="stringliteral">&#39;translateX(&#39;</span> + (frameOffset + <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>) + <span class="stringliteral">&#39;px)&#39;</span>;
<a name="l02270"></a>02270   previousFrame.container.style.transform =
<a name="l02271"></a>02271     <span class="stringliteral">&#39;translateX(&#39;</span> + (frameOffset - <a class="code" href="../../d4/d8c/viewphoto_8js.html#adb90f9ed3668a895cc5b90a19bcdee13">width</a>) + <span class="stringliteral">&#39;px)&#39;</span>;
<a name="l02272"></a>02272 }
<a name="l02273"></a>02273 
<a name="l02274"></a>02274 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#aa95a0e33ee54ea6e80e6ca47df7ecf96">resetFramesPosition</a>() {
<a name="l02275"></a>02275   frameOffset = 0;
<a name="l02276"></a>02276   <a class="code" href="../../d8/df0/frames_8js.html#a1e990ee9315d596bcab04e06af23ceea">setFramesPosition</a>();
<a name="l02277"></a>02277 }
<a name="l02278"></a>02278 
<a name="l02279"></a>02279 <span class="comment">// Switch from thumbnail list view to single-picture fullscreen view</span>
<a name="l02280"></a>02280 <span class="comment">// and display the specified file</span>
<a name="l02281"></a>02281 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#acca2cb5dc9247f573a21f61583c8d81d">showFile</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l02282"></a>02282   <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>); <span class="comment">// Switch to fullscreen mode if not already there</span>
<a name="l02283"></a>02283 
<a name="l02284"></a>02284   <a class="code" href="../../d8/df0/frames_8js.html#a9da97cccdb118a001a04c6062ff6c31f">setupFrameContent</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> - 1, previousFrame);
<a name="l02285"></a>02285   <a class="code" href="../../d8/df0/frames_8js.html#a9da97cccdb118a001a04c6062ff6c31f">setupFrameContent</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, currentFrame);
<a name="l02286"></a>02286   <a class="code" href="../../d8/df0/frames_8js.html#a9da97cccdb118a001a04c6062ff6c31f">setupFrameContent</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> + 1, nextFrame);
<a name="l02287"></a>02287   currentFileIndex = <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>;
<a name="l02288"></a>02288 
<a name="l02289"></a>02289   <a class="code" href="../../d8/df0/frames_8js.html#aa95a0e33ee54ea6e80e6ca47df7ecf96">resetFramesPosition</a>();
<a name="l02290"></a>02290 
<a name="l02291"></a>02291   <span class="comment">// Disable the edit button if this is a video, and enable otherwise</span>
<a name="l02292"></a>02292   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>].metadata.video)
<a name="l02293"></a>02293     $(<span class="stringliteral">&#39;fullscreen-edit-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02294"></a>02294   <span class="keywordflow">else</span>
<a name="l02295"></a>02295     $(<span class="stringliteral">&#39;fullscreen-edit-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02296"></a>02296   <span class="comment">// Always bring delete and share button back after show file</span>
<a name="l02297"></a>02297   $(<span class="stringliteral">&#39;fullscreen-delete-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02298"></a>02298   $(<span class="stringliteral">&#39;fullscreen-share-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02299"></a>02299 }
<a name="l02300"></a>02300 
<a name="l02301"></a>02301 <span class="comment">// Transition to the next file, animating it over the specified time (ms).</span>
<a name="l02302"></a>02302 <span class="comment">// This is used when the user pans.</span>
<a name="l02303"></a>02303 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a54115720eddd216055dc110c3ab8b7f4">nextFile</a>(time) {
<a name="l02304"></a>02304   <span class="comment">// If already displaying the last one, do nothing.</span>
<a name="l02305"></a>02305   <span class="keywordflow">if</span> (currentFileIndex === <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length - 1)
<a name="l02306"></a>02306     <span class="keywordflow">return</span>;
<a name="l02307"></a>02307 
<a name="l02308"></a>02308   <span class="comment">// If the current frame is using a &lt;video&gt; element instead of just</span>
<a name="l02309"></a>02309   <span class="comment">// displaying a poster image, reset it back to just the image</span>
<a name="l02310"></a>02310   <span class="keywordflow">if</span> (currentFrame.displayingVideo &amp;&amp; currentFrame.video.playerShowing)
<a name="l02311"></a>02311     currentFrame.video.init();
<a name="l02312"></a>02312 
<a name="l02313"></a>02313   <span class="comment">// Set a flag to ignore pan and zoom gestures during the transition.</span>
<a name="l02314"></a>02314   transitioning = <span class="keyword">true</span>;
<a name="l02315"></a>02315   <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() { transitioning = <span class="keyword">false</span>; }, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>);
<a name="l02316"></a>02316 
<a name="l02317"></a>02317   <span class="comment">// Set transitions for the visible frames</span>
<a name="l02318"></a>02318   var transition = <span class="stringliteral">&#39;transform &#39;</span> + time + <span class="stringliteral">&#39;ms ease&#39;</span>;
<a name="l02319"></a>02319   currentFrame.container.style.transition = transition;
<a name="l02320"></a>02320   nextFrame.container.style.transition = transition;
<a name="l02321"></a>02321 
<a name="l02322"></a>02322   <span class="comment">// Cycle the three frames so next becomes current,</span>
<a name="l02323"></a>02323   <span class="comment">// current becomes previous, and previous becomes next.</span>
<a name="l02324"></a>02324   var <a class="code" href="../../db/de5/namespacedefault__timezones.html#ac494636c41cb282619c68c44af233bc7">tmp</a> = <a class="code" href="../../d8/df0/frames_8js.html#a5d60985775a23d0a9fc6afa50e245ddc">previousFrame</a>;
<a name="l02325"></a>02325   previousFrame = <a class="code" href="../../d8/df0/frames_8js.html#a35a1d5b2c11c745f050a319c2940c383">currentFrame</a>;
<a name="l02326"></a>02326   currentFrame = <a class="code" href="../../d8/df0/frames_8js.html#a007e837054378566ec403efc4d177e58">nextFrame</a>;
<a name="l02327"></a>02327   nextFrame = <a class="code" href="../../db/de5/namespacedefault__timezones.html#ac494636c41cb282619c68c44af233bc7">tmp</a>;
<a name="l02328"></a>02328   currentFileIndex++;
<a name="l02329"></a>02329 
<a name="l02330"></a>02330   <span class="comment">// Move (transition) the frames to their new position</span>
<a name="l02331"></a>02331   <a class="code" href="../../d8/df0/frames_8js.html#aa95a0e33ee54ea6e80e6ca47df7ecf96">resetFramesPosition</a>();
<a name="l02332"></a>02332 
<a name="l02333"></a>02333   <span class="comment">// Update the frame for the new next item</span>
<a name="l02334"></a>02334   <a class="code" href="../../d8/df0/frames_8js.html#a9da97cccdb118a001a04c6062ff6c31f">setupFrameContent</a>(currentFileIndex + 1, nextFrame);
<a name="l02335"></a>02335 
<a name="l02336"></a>02336   <span class="comment">// When the transition is done, cleanup</span>
<a name="l02337"></a>02337   currentFrame.container.addEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(e) {
<a name="l02338"></a>02338     this.<a class="code" href="../../df/d44/permission__manager_8js.html#acf9987ef04ab3791e7ff8b28d748ebcc">removeEventListener</a>(<span class="stringliteral">&#39;transitionend&#39;</span>, <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>);
<a name="l02339"></a>02339 
<a name="l02340"></a>02340     <span class="comment">// Reposition the item that just transitioned off the screen</span>
<a name="l02341"></a>02341     <span class="comment">// to reset any zooming and panning</span>
<a name="l02342"></a>02342     previousFrame.reset();
<a name="l02343"></a>02343   });
<a name="l02344"></a>02344 
<a name="l02345"></a>02345   <span class="comment">// Disable the edit button if we&#39;re now viewing a video, and enable otherwise</span>
<a name="l02346"></a>02346   <span class="keywordflow">if</span> (currentFrame.displayingVideo)
<a name="l02347"></a>02347     $(<span class="stringliteral">&#39;fullscreen-edit-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02348"></a>02348   <span class="keywordflow">else</span>
<a name="l02349"></a>02349     $(<span class="stringliteral">&#39;fullscreen-edit-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02350"></a>02350 }
<a name="l02351"></a>02351 
<a name="l02352"></a>02352 <span class="comment">// Just like nextFile() but in the other direction</span>
<a name="l02353"></a>02353 <span class="keyword">function</span> <a class="code" href="../../d8/df0/frames_8js.html#a631221a1a1b95efdcd1cb92386f83131">previousFile</a>(time) {
<a name="l02354"></a>02354   <span class="comment">// if already displaying the first one, do nothing.</span>
<a name="l02355"></a>02355   <span class="keywordflow">if</span> (currentFileIndex === 0)
<a name="l02356"></a>02356     <span class="keywordflow">return</span>;
<a name="l02357"></a>02357 
<a name="l02358"></a>02358   <span class="comment">// If the current frame is using a &lt;video&gt; element instead of just</span>
<a name="l02359"></a>02359   <span class="comment">// displaying a poster image, reset it back to just the image.</span>
<a name="l02360"></a>02360   <span class="keywordflow">if</span> (currentFrame.displayingVideo &amp;&amp; currentFrame.video.playerShowing)
<a name="l02361"></a>02361     currentFrame.video.init();
<a name="l02362"></a>02362 
<a name="l02363"></a>02363   <span class="comment">// Set a flag to ignore pan and zoom gestures during the transition.</span>
<a name="l02364"></a>02364   transitioning = <span class="keyword">true</span>;
<a name="l02365"></a>02365   <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() { transitioning = <span class="keyword">false</span>; }, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>);
<a name="l02366"></a>02366 
<a name="l02367"></a>02367   <span class="comment">// Set transitions for the visible frames</span>
<a name="l02368"></a>02368   var transition = <span class="stringliteral">&#39;transform &#39;</span> + time + <span class="stringliteral">&#39;ms ease&#39;</span>;
<a name="l02369"></a>02369   previousFrame.container.style.transition = transition;
<a name="l02370"></a>02370   currentFrame.container.style.transition = transition;
<a name="l02371"></a>02371 
<a name="l02372"></a>02372   <span class="comment">// Transition to the previous item: previous becomes current, current</span>
<a name="l02373"></a>02373   <span class="comment">// becomes next, etc.</span>
<a name="l02374"></a>02374   var tmp = <a class="code" href="../../d8/df0/frames_8js.html#a007e837054378566ec403efc4d177e58">nextFrame</a>;
<a name="l02375"></a>02375   nextFrame = <a class="code" href="../../d8/df0/frames_8js.html#a35a1d5b2c11c745f050a319c2940c383">currentFrame</a>;
<a name="l02376"></a>02376   currentFrame = <a class="code" href="../../d8/df0/frames_8js.html#a5d60985775a23d0a9fc6afa50e245ddc">previousFrame</a>;
<a name="l02377"></a>02377   previousFrame = <a class="code" href="../../db/de5/namespacedefault__timezones.html#ac494636c41cb282619c68c44af233bc7">tmp</a>;
<a name="l02378"></a>02378   currentFileIndex--;
<a name="l02379"></a>02379 
<a name="l02380"></a>02380   <span class="comment">// Move (transition) the frames to their new position</span>
<a name="l02381"></a>02381   <a class="code" href="../../d8/df0/frames_8js.html#aa95a0e33ee54ea6e80e6ca47df7ecf96">resetFramesPosition</a>();
<a name="l02382"></a>02382 
<a name="l02383"></a>02383   <span class="comment">// Preload the new previous item</span>
<a name="l02384"></a>02384   <a class="code" href="../../d8/df0/frames_8js.html#a9da97cccdb118a001a04c6062ff6c31f">setupFrameContent</a>(currentFileIndex - 1, previousFrame);
<a name="l02385"></a>02385 
<a name="l02386"></a>02386   <span class="comment">// When the transition is done do some cleanup</span>
<a name="l02387"></a>02387   currentFrame.container.addEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(e) {
<a name="l02388"></a>02388     this.<a class="code" href="../../df/d44/permission__manager_8js.html#acf9987ef04ab3791e7ff8b28d748ebcc">removeEventListener</a>(<span class="stringliteral">&#39;transitionend&#39;</span>, <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>);
<a name="l02389"></a>02389     <span class="comment">// Reset the size and position of the item that just panned off</span>
<a name="l02390"></a>02390     nextFrame.reset();
<a name="l02391"></a>02391   });
<a name="l02392"></a>02392 
<a name="l02393"></a>02393   <span class="comment">// Disable the edit button if we&#39;re now viewing a video, and enable otherwise</span>
<a name="l02394"></a>02394   <span class="keywordflow">if</span> (currentFrame.displayingVideo)
<a name="l02395"></a>02395     $(<span class="stringliteral">&#39;fullscreen-edit-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02396"></a>02396   <span class="keywordflow">else</span>
<a name="l02397"></a>02397     $(<span class="stringliteral">&#39;fullscreen-edit-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l02398"></a>02398 }
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d7/d54/frame__scripts_8js.html">frame_scripts.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:52:02に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
