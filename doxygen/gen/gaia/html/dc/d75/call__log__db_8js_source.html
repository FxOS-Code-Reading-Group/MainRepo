<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: call_log_db.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('dc/d75/call__log__db_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">call_log_db.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../dc/d75/call__log__db_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../dc/d75/call__log__db_8js.html#ae2475e10618961c050dcba04e8c42331">00001</a> <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l00002"></a>00002 
<a name="l00003"></a><a class="code" href="../../dc/d75/call__log__db_8js.html#a98d3f5eb2c76fecd77dabb87e00e1116">00003</a> var <a class="code" href="../../dc/d75/call__log__db_8js.html#a98d3f5eb2c76fecd77dabb87e00e1116">CallLogDBManager</a> = {
<a name="l00004"></a>00004   _db: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l00005"></a>00005   _dbName: <span class="stringliteral">&#39;dialerRecents&#39;</span>,
<a name="l00006"></a>00006   _dbRecentsStore: <span class="stringliteral">&#39;dialerRecents&#39;</span>,
<a name="l00007"></a>00007   _dbGroupsStore: <span class="stringliteral">&#39;dialerGroups&#39;</span>,
<a name="l00008"></a>00008   _dbVersion: 5,
<a name="l00009"></a>00009   _maxNumberOfGroups: 200,
<a name="l00010"></a>00010   _numberOfGroupsToDelete: 30,
<a name="l00011"></a>00011 
<a name="l00012"></a>00012   _observers: {},
<a name="l00013"></a>00013 
<a name="l00021"></a>00021   <span class="keyword">set</span> onupgradeneeded(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00022"></a>00022     this._addObserver(<span class="stringliteral">&#39;upgradeneeded&#39;</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00023"></a>00023   },
<a name="l00024"></a>00024 
<a name="l00029"></a>00029   <span class="keyword">set</span> onupgradedone(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00030"></a>00030     this._addObserver(<span class="stringliteral">&#39;upgradedone&#39;</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00031"></a>00031   },
<a name="l00032"></a>00032 
<a name="l00037"></a>00037   <span class="keyword">set</span> onupgradeprogress(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00038"></a>00038     this._addObserver(<span class="stringliteral">&#39;upgradeprogress&#39;</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00039"></a>00039   },
<a name="l00040"></a>00040 
<a name="l00041"></a>00041   _addObserver: <span class="keyword">function</span> _addObserver(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00042"></a>00042     <span class="keywordflow">if</span> (!this._observers[<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>]) {
<a name="l00043"></a>00043       this._observers[<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>] = [];
<a name="l00044"></a>00044     }
<a name="l00045"></a>00045     this._observers[<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>].push(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00046"></a>00046   },
<a name="l00047"></a>00047 
<a name="l00048"></a>00048   _notifyObservers: <span class="keyword">function</span> _notifyObservers(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>, <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>) {
<a name="l00049"></a>00049     var observers = this._observers[<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>];
<a name="l00050"></a>00050     <span class="keywordflow">if</span> (!observers) {
<a name="l00051"></a>00051       <span class="keywordflow">return</span>;
<a name="l00052"></a>00052     }
<a name="l00053"></a>00053 
<a name="l00054"></a>00054     <span class="keywordflow">for</span> (var <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> in observers) {
<a name="l00055"></a>00055       <span class="keywordflow">if</span> (observers[<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>] &amp;&amp; <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> observers[<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>] === <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l00056"></a>00056         observers[<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>](<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>);
<a name="l00057"></a>00057       }
<a name="l00058"></a>00058     }
<a name="l00059"></a>00059   },
<a name="l00060"></a>00060 
<a name="l00061"></a>00061   _asyncReturn: <span class="keyword">function</span> _asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>) {
<a name="l00062"></a>00062     <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> &amp;&amp; <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> instanceof Function) {
<a name="l00063"></a>00063       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>);
<a name="l00064"></a>00064     }
<a name="l00065"></a>00065   },
<a name="l00066"></a>00066 
<a name="l00067"></a>00067   <span class="comment">/*</span>
<a name="l00068"></a>00068 <span class="comment">   * Prepare the database. This may include opening the database and upgrading</span>
<a name="l00069"></a>00069 <span class="comment">   * it to the latest schema version.</span>
<a name="l00070"></a>00070 <span class="comment">   *</span>
<a name="l00071"></a>00071 <span class="comment">   * param callback</span>
<a name="l00072"></a>00072 <span class="comment">   *        Function that takes an error and db argument. It is called when</span>
<a name="l00073"></a>00073 <span class="comment">   *        the database is ready to use or if an error occurs while preparing</span>
<a name="l00074"></a>00074 <span class="comment">   *        the database.</span>
<a name="l00075"></a>00075 <span class="comment">   *</span>
<a name="l00076"></a>00076 <span class="comment">   * return (via callback) a database ready for use.</span>
<a name="l00077"></a>00077 <span class="comment">   */</span>
<a name="l00078"></a>00078   _ensureDB: <span class="keyword">function</span> ensureDB(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00079"></a>00079     <span class="keywordflow">if</span> (this._db) {
<a name="l00080"></a>00080       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, this._db);
<a name="l00081"></a>00081       <span class="keywordflow">return</span>;
<a name="l00082"></a>00082     }
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <a class="code" href="../../d3/db5/build__stage_2email_2shared_2js_2lazy__loader_8js.html#aaf5eec8afd0243eeb2166f74e472c877">LazyLoader</a>.load([<span class="stringliteral">&#39;/dialer/js/utils.js&#39;</span>,
<a name="l00085"></a>00085                      <span class="stringliteral">&#39;/dialer/js/contacts.js&#39;</span>], (<span class="keyword">function</span>() {
<a name="l00086"></a>00086       <span class="keywordflow">try</span> {
<a name="l00087"></a>00087         var indexedDB = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.indexedDB || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.webkitIndexedDB ||
<a name="l00088"></a>00088                         <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.mozIndexedDB || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.msIndexedDB;
<a name="l00089"></a>00089         <span class="keywordflow">if</span> (!indexedDB) {
<a name="l00090"></a>00090           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;NO_INDEXED_DB_AVAILABLE&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00091"></a>00091           <span class="keywordflow">return</span>;
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00095"></a>00095         var <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a> = indexedDB.open(this._dbName, this._dbVersion);
<a name="l00096"></a>00096         request.onsuccess = (<span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00097"></a>00097           this._db = <span class="keyword">event</span>.target.result;
<a name="l00098"></a>00098           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, this._db);
<a name="l00099"></a>00099         }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101         request.onerror = <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00102"></a>00102           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.target.errorCode, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00103"></a>00103         };
<a name="l00104"></a>00104 
<a name="l00105"></a>00105         request.onblocked = <span class="keyword">function</span> onblocked() {
<a name="l00106"></a>00106           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;DB_REQUEST_BLOCKED&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00107"></a>00107         };
<a name="l00108"></a>00108 
<a name="l00109"></a>00109         request.onupgradeneeded = <span class="keyword">function</span> onupgradeneeded(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00110"></a>00110           <span class="comment">// Notify the UI about the need to upgrade the database.</span>
<a name="l00111"></a>00111           <span class="keyword">self</span>._notifyObservers(<span class="stringliteral">&#39;upgradeneeded&#39;</span>);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113           var <a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a> = <span class="keyword">event</span>.target.result;
<a name="l00114"></a>00114           var txn = <span class="keyword">event</span>.target.transaction;
<a name="l00115"></a>00115           var currentVersion = <span class="keyword">event</span>.oldVersion;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117           <span class="keyword">function</span> <a class="code" href="../../dd/d6d/mock__spinner_8js.html#ab10b009b0da48f61217a18daf8e20cd8">update</a>(currentVersion) {
<a name="l00118"></a>00118             var next = <a class="code" href="../../dd/d6d/mock__spinner_8js.html#ab10b009b0da48f61217a18daf8e20cd8">update</a>.bind(<span class="keyword">self</span>, currentVersion + 1);
<a name="l00119"></a>00119 
<a name="l00120"></a>00120             <span class="keywordflow">switch</span> (currentVersion) {
<a name="l00121"></a>00121               <span class="keywordflow">case</span> 0:
<a name="l00122"></a>00122                 <span class="keyword">self</span>._createSchema(db, next);
<a name="l00123"></a>00123                 <span class="keywordflow">break</span>;
<a name="l00124"></a>00124               <span class="keywordflow">case</span> 1:
<a name="l00125"></a>00125                 <span class="keyword">self</span>._upgradeSchemaVersion2(db, txn, next);
<a name="l00126"></a>00126                 <span class="keywordflow">break</span>;
<a name="l00127"></a>00127               <span class="keywordflow">case</span> 2:
<a name="l00128"></a>00128                 <span class="keyword">self</span>._upgradeSchemaVersion3(next);
<a name="l00129"></a>00129                 <span class="keywordflow">break</span>;
<a name="l00130"></a>00130               <span class="keywordflow">case</span> 3:
<a name="l00131"></a>00131                 <span class="keyword">self</span>._upgradeSchemaVersion4(db, txn, next);
<a name="l00132"></a>00132                 <span class="keywordflow">break</span>;
<a name="l00133"></a>00133               <span class="keywordflow">case</span> 4:
<a name="l00134"></a>00134                 <span class="keyword">self</span>._upgradeSchemaVersion5(next);
<a name="l00135"></a>00135                 <span class="keywordflow">break</span>;
<a name="l00136"></a>00136               <span class="keywordflow">case</span> 5:
<a name="l00137"></a>00137                 <span class="comment">// we have finished the upgrades. please keep this</span>
<a name="l00138"></a>00138                 <span class="comment">// in sync for future upgrades, since otherwise it</span>
<a name="l00139"></a>00139                 <span class="comment">// will call the default: and abort the transaction :(</span>
<a name="l00140"></a>00140                 <span class="keyword">self</span>._notifyObservers(<span class="stringliteral">&#39;upgradedone&#39;</span>);
<a name="l00141"></a>00141                 <span class="keywordflow">break</span>;
<a name="l00142"></a>00142               <span class="keywordflow">default</span>:
<a name="l00143"></a>00143                 <span class="keyword">event</span>.target.transaction.abort();
<a name="l00144"></a>00144                 <span class="keywordflow">break</span>;
<a name="l00145"></a>00145             }
<a name="l00146"></a>00146             currentVersion++;
<a name="l00147"></a>00147           }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149           <a class="code" href="../../dd/d6d/mock__spinner_8js.html#ab10b009b0da48f61217a18daf8e20cd8">update</a>(currentVersion);
<a name="l00150"></a>00150         };
<a name="l00151"></a>00151       } <span class="keywordflow">catch</span> (ex) {
<a name="l00152"></a>00152         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(ex.message, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00153"></a>00153       }
<a name="l00154"></a>00154     }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l00155"></a>00155   },
<a name="l00170"></a>00170   _newTxn: <span class="keyword">function</span> newTxn(txnType, objectStores, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (!objectStores) {
<a name="l00172"></a>00172       objectStores = [this._dbGroupsStore];
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (!Array.isArray(objectStores)) {
<a name="l00175"></a>00175       objectStores = [objectStores];
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177     this._ensureDB(<span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, <a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>) {
<a name="l00178"></a>00178       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00179"></a>00179         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l00180"></a>00180         <span class="keywordflow">return</span>;
<a name="l00181"></a>00181       }
<a name="l00182"></a>00182       var txn = <a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>.transaction(objectStores, txnType);
<a name="l00183"></a>00183       var stores;
<a name="l00184"></a>00184       <span class="keywordflow">if</span> (objectStores.length === 1) {
<a name="l00185"></a>00185         stores = txn.objectStore(objectStores[0]);
<a name="l00186"></a>00186       } <span class="keywordflow">else</span> {
<a name="l00187"></a>00187         stores = [];
<a name="l00188"></a>00188         <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; objectStores.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00189"></a>00189           stores.push(txn.objectStore(objectStores[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]));
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191       }
<a name="l00192"></a>00192       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, txn, stores);
<a name="l00193"></a>00193     });
<a name="l00194"></a>00194   },
<a name="l00195"></a>00195   <a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a>: <span class="keyword">function</span> rbdm_close() {
<a name="l00196"></a>00196     this._db.close();
<a name="l00197"></a>00197     this._db = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00198"></a>00198   },
<a name="l00205"></a>00205   _createSchema: <span class="keyword">function</span> createSchema(<a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>, next) {
<a name="l00206"></a>00206     <span class="comment">// The object store hosting the recents calls will contain entries like:</span>
<a name="l00207"></a>00207     <span class="comment">// { date: &lt;Date&gt; (primary key),</span>
<a name="l00208"></a>00208     <span class="comment">//   number: &lt;String&gt;,</span>
<a name="l00209"></a>00209     <span class="comment">//   type: &lt;String&gt;,</span>
<a name="l00210"></a>00210     <span class="comment">//   groupId: &lt;Number&gt; }</span>
<a name="l00211"></a>00211     var objStore = <a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>.createObjectStore(this._dbRecentsStore,
<a name="l00212"></a>00212                                         { keyPath: <span class="stringliteral">&#39;date&#39;</span> });
<a name="l00213"></a>00213     objStore.createIndex(<span class="stringliteral">&#39;number&#39;</span>, <span class="stringliteral">&#39;number&#39;</span>);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     next();
<a name="l00216"></a>00216   },
<a name="l00227"></a>00227   _upgradeSchemaVersion2:
<a name="l00228"></a>00228     <span class="keyword">function</span> upgradeSchemaVersion2(<a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>, transaction, next) {
<a name="l00229"></a>00229     <span class="comment">// This object store can be used to quickly construct a group view of the</span>
<a name="l00230"></a>00230     <span class="comment">// recent calls database. Each entry looks like this:</span>
<a name="l00231"></a>00231     <span class="comment">//</span>
<a name="l00232"></a>00232     <span class="comment">// { id: &lt;String&gt; (Primary key, hash created from number and date)</span>
<a name="l00233"></a>00233     <span class="comment">//   number: &lt;String&gt;,</span>
<a name="l00234"></a>00234     <span class="comment">//   contact: &lt;String&gt;,</span>
<a name="l00235"></a>00235     <span class="comment">//   date: &lt;Date&gt;,</span>
<a name="l00236"></a>00236     <span class="comment">//   type: &lt;String&gt;,</span>
<a name="l00237"></a>00237     <span class="comment">//   retryCount: &lt;Number&gt; }</span>
<a name="l00238"></a>00238     <span class="comment">//</span>
<a name="l00239"></a>00239     <span class="comment">//  &#39;retryCount&#39; is incremented when we store a call of the same &#39;type&#39;</span>
<a name="l00240"></a>00240     <span class="comment">//  and resetted to 1 otherwise.</span>
<a name="l00241"></a>00241     <span class="comment">//</span>
<a name="l00242"></a>00242     <span class="comment">//  We store &#39;number&#39; and &#39;contact&#39; separatedly so we allow searches by</span>
<a name="l00243"></a>00243     <span class="comment">//  these fields without being dependent of the contacts API.</span>
<a name="l00244"></a>00244     var groupsStore = <a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>.createObjectStore(this._dbGroupsStore,
<a name="l00245"></a>00245                                            { keyPath: <span class="stringliteral">&#39;id&#39;</span> });
<a name="l00246"></a>00246     <span class="comment">// We create an index for &#39;groupId&#39; in the object store hosting the</span>
<a name="l00247"></a>00247     <span class="comment">// actual calls. Each call belongs to a group indexed by id.</span>
<a name="l00248"></a>00248     var recentsStore = transaction.objectStore(this._dbRecentsStore);
<a name="l00249"></a>00249     recentsStore.createIndex(<span class="stringliteral">&#39;groupId&#39;</span>, <span class="stringliteral">&#39;groupId&#39;</span>);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     next();
<a name="l00252"></a>00252   },
<a name="l00256"></a>00256   _upgradeSchemaVersion3: <span class="keyword">function</span> upgradeSchemaVersion3(next) {
<a name="l00257"></a>00257     <span class="comment">// Do nothing.</span>
<a name="l00258"></a>00258     next();
<a name="l00259"></a>00259   },
<a name="l00276"></a>00276   _upgradeSchemaVersion4:
<a name="l00277"></a>00277     <span class="keyword">function</span> upgradeSchemaVersion4(<a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>, transaction, next) {
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     var waitForAsyncCall = 0;
<a name="l00282"></a>00282     var cursorDone = <span class="keyword">false</span>;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284     var groups = {};
<a name="l00285"></a>00285     var recentsCount = 0;
<a name="l00286"></a>00286     var groupCount = 0;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="keyword">function</span> onGroupsDone() {
<a name="l00289"></a>00289       <span class="keywordflow">if</span> (!cursorDone || waitForAsyncCall) {
<a name="l00290"></a>00290         <span class="keywordflow">return</span>;
<a name="l00291"></a>00291       }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293       <span class="keywordflow">if</span> (groupCount == 0) {
<a name="l00294"></a>00294         next();
<a name="l00295"></a>00295         <span class="keywordflow">return</span>;
<a name="l00296"></a>00296       }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298       <span class="comment">// Once we built all the group of calls we can push them to the</span>
<a name="l00299"></a>00299       <span class="comment">// groups object store and notify the UI about it.</span>
<a name="l00300"></a>00300       <span class="keyword">self</span>._newTxn(<span class="stringliteral">&#39;readwrite&#39;</span>, [<span class="keyword">self</span>._dbGroupsStore],
<a name="l00301"></a>00301                    <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l00302"></a>00302         <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00303"></a>00303           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Error upgrading the database &#39;</span> + <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l00304"></a>00304           <span class="keywordflow">return</span>;
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         <span class="keywordflow">for</span> (var group in groups) {
<a name="l00308"></a>00308           store.put(groups[group]).onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>() {
<a name="l00309"></a>00309             groupCount--;
<a name="l00310"></a>00310             <span class="keywordflow">if</span> (groupCount == 0) {
<a name="l00311"></a>00311               next();
<a name="l00312"></a>00312             }
<a name="l00313"></a>00313           };
<a name="l00314"></a>00314           <span class="keyword">delete</span> groups[group];
<a name="l00315"></a>00315         }
<a name="l00316"></a>00316       });
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="comment">// Populate quick group view with already existing calls information.</span>
<a name="l00320"></a>00320     <span class="keyword">function</span> populateGroups() {
<a name="l00321"></a>00321       <span class="comment">// We send &#39;upgradeprogress&#39; events from two different places:</span>
<a name="l00322"></a>00322       <span class="comment">// 1- For each 15% of the recentsStore cursor requests completed.</span>
<a name="l00323"></a>00323       <span class="comment">//    We increment the progress by 10%, leaving the total amount</span>
<a name="l00324"></a>00324       <span class="comment">//    in 60%.</span>
<a name="l00325"></a>00325       <span class="comment">// 2- For each 25% of the Contacts API requests completed. We</span>
<a name="l00326"></a>00326       <span class="comment">//    also increment the progress by 10%, leaving the total</span>
<a name="l00327"></a>00327       <span class="comment">//    amount in 90%.</span>
<a name="l00328"></a>00328       <span class="comment">// The final progress 100% event is avoided as we send a &#39;upgradedone&#39;</span>
<a name="l00329"></a>00329       <span class="comment">// event instead.</span>
<a name="l00330"></a>00330       var percent = parseInt(recentsCount * 0.15);
<a name="l00331"></a>00331       var countToProgressEvent = percent;
<a name="l00332"></a>00332       var percent2 = parseInt(recentsCount * 0.25);
<a name="l00333"></a>00333       var countToProgressEvent2 = percent2;
<a name="l00334"></a>00334       var progress = 0;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336       recentsStore.openCursor().onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00337"></a>00337         <span class="keywordflow">if</span> (countToProgressEvent === 0) {
<a name="l00338"></a>00338           countToProgressEvent = percent;
<a name="l00339"></a>00339           progress += 10;
<a name="l00340"></a>00340           <span class="keyword">self</span>._notifyObservers(<span class="stringliteral">&#39;upgradeprogress&#39;</span>, progress);
<a name="l00341"></a>00341         } <span class="keywordflow">else</span> {
<a name="l00342"></a>00342           countToProgressEvent--;
<a name="l00343"></a>00343         }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         var <a class="code" href="../../dc/d6a/xpt__xdr_8h.html#a7056fb315468c5bec29afb3b459e8b92">cursor</a> = <span class="keyword">event</span>.target.result;
<a name="l00346"></a>00346         <span class="keywordflow">if</span> (!cursor) {
<a name="l00347"></a>00347           <span class="comment">// As soon as the cursor is done, we bail out. We still need to wait</span>
<a name="l00348"></a>00348           <span class="comment">// for all the async calls to retrieve the contacts information to</span>
<a name="l00349"></a>00349           <span class="comment">// finish before pushing the data to the groups object store. We will</span>
<a name="l00350"></a>00350           <span class="comment">// notify the UI about that so it can request the data again.</span>
<a name="l00351"></a>00351           cursorDone = <span class="keyword">true</span>;
<a name="l00352"></a>00352           onGroupsDone();
<a name="l00353"></a>00353           <span class="keywordflow">return</span>;
<a name="l00354"></a>00354         }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         var record = cursor.value;
<a name="l00357"></a>00357         var <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00358"></a>00358         var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>;
<a name="l00359"></a>00359         <span class="comment">// Get group type and status.</span>
<a name="l00360"></a>00360         <span class="keywordflow">switch</span> (record.type) {
<a name="l00361"></a>00361           <span class="keywordflow">case</span> <span class="stringliteral">&#39;incoming-connected&#39;</span>:
<a name="l00362"></a>00362             type = <span class="stringliteral">&#39;incoming&#39;</span>;
<a name="l00363"></a>00363             status = <span class="stringliteral">&#39;connected&#39;</span>;
<a name="l00364"></a>00364             <span class="keywordflow">break</span>;
<a name="l00365"></a>00365           <span class="keywordflow">case</span> <span class="stringliteral">&#39;incoming-refused&#39;</span>:
<a name="l00366"></a>00366             type = <span class="stringliteral">&#39;incoming&#39;</span>;
<a name="l00367"></a>00367             <span class="keywordflow">break</span>;
<a name="l00368"></a>00368           <span class="keywordflow">default</span>:
<a name="l00369"></a>00369             <span class="keywordflow">if</span> (record.type &amp;&amp; record.type.indexOf(<span class="stringliteral">&#39;dialing&#39;</span>) != -1) {
<a name="l00370"></a>00370               type = <span class="stringliteral">&#39;dialing&#39;</span>;
<a name="l00371"></a>00371             }
<a name="l00372"></a>00372             <span class="keywordflow">break</span>;
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         <span class="comment">// Create the id and a temporary unique key for the group.</span>
<a name="l00376"></a>00376         var <span class="keywordtype">id</span> = <span class="keyword">self</span>._getGroupId({
<a name="l00377"></a>00377           <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: record.date,
<a name="l00378"></a>00378           number: record.number,
<a name="l00379"></a>00379           type: <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>,
<a name="l00380"></a>00380           status: status
<a name="l00381"></a>00381         });
<a name="l00382"></a>00382         var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> = <span class="keyword">new</span> Date(record.date);
<a name="l00383"></a>00383         var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = date.getDay() + date.getMonth() + date.getFullYear() +
<a name="l00384"></a>00384                   record.number + <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>;
<a name="l00385"></a>00385         <span class="keywordflow">if</span> (status) {
<a name="l00386"></a>00386           key += <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>;
<a name="l00387"></a>00387         }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         <span class="comment">// Get the contact information associated with the number.</span>
<a name="l00390"></a>00390         waitForAsyncCall++;
<a name="l00391"></a>00391         <a class="code" href="../../d7/d68/apps_2communications_2contacts_2js_2contacts_8js.html#a55257a4a6c5aab93045fd427504a1c95">Contacts</a>.findByNumber(record.number,
<a name="l00392"></a>00392                               <span class="keyword">function</span>(<a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>, matchingTel) {
<a name="l00393"></a>00393           <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (countToProgressEvent2 === 0) {
<a name="l00394"></a>00394             countToProgressEvent2 = percent2;
<a name="l00395"></a>00395             progress += 10;
<a name="l00396"></a>00396             <span class="keyword">self</span>._notifyObservers(<span class="stringliteral">&#39;upgradeprogress&#39;</span>, progress);
<a name="l00397"></a>00397           } <span class="keywordflow">else</span> {
<a name="l00398"></a>00398             countToProgressEvent2--;
<a name="l00399"></a>00399           }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401           <span class="comment">// Store the group or increment the &#39;retryCount&#39; field if we already</span>
<a name="l00402"></a>00402           <span class="comment">// created a group for this call.</span>
<a name="l00403"></a>00403           <span class="keywordflow">if</span> (key in groups) {
<a name="l00404"></a>00404             <span class="comment">// Groups should have the date of the newest call.</span>
<a name="l00405"></a>00405             <span class="keywordflow">if</span> (groups[key].lastEntryDate &lt;= record.date) {
<a name="l00406"></a>00406               groups[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>].lastEntryDate = record.date;
<a name="l00407"></a>00407             }
<a name="l00408"></a>00408             groups[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>].retryCount++;
<a name="l00409"></a>00409           } <span class="keywordflow">else</span> {
<a name="l00410"></a>00410             var group = {
<a name="l00411"></a>00411               <span class="keywordtype">id</span>: <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>,
<a name="l00412"></a>00412               number: record.number,
<a name="l00413"></a>00413               lastEntryDate: record.date,
<a name="l00414"></a>00414               retryCount: 1
<a name="l00415"></a>00415             };
<a name="l00416"></a>00416             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a> &amp;&amp; <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a> !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l00417"></a>00417               group.contactId = <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>.id;
<a name="l00418"></a>00418               <span class="keywordflow">if</span> (Array.isArray(<a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>.photo) &amp;&amp; <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>.photo[0]) {
<a name="l00419"></a>00419                 group.contactPhoto = <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>.photo[0];
<a name="l00420"></a>00420               }
<a name="l00421"></a>00421               <span class="keywordflow">if</span> (matchingTel) {
<a name="l00422"></a>00422                 var primaryInfo = <a class="code" href="../../d1/db7/apps_2communications_2dialer_2js_2utils_8js.html#af21ebfdaa2ee891fa5788a82b2e2586c">Utils</a>.getPhoneNumberPrimaryInfo(matchingTel,
<a name="l00423"></a>00423                                                                   <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>);
<a name="l00424"></a>00424                 <span class="keywordflow">if</span> (Array.isArray(primaryInfo)) {
<a name="l00425"></a>00425                   primaryInfo = primaryInfo[0];
<a name="l00426"></a>00426                 }
<a name="l00427"></a>00427                 group.contactPrimaryInfo = String(primaryInfo);
<a name="l00428"></a>00428                 <span class="keywordflow">if</span> (Array.isArray(matchingTel.type) &amp;&amp; matchingTel.type[0]) {
<a name="l00429"></a>00429                   group.contactMatchingTelType = String(matchingTel.type[0]);
<a name="l00430"></a>00430                 }
<a name="l00431"></a>00431                 <span class="keywordflow">if</span> (matchingTel.carrier) {
<a name="l00432"></a>00432                   group.contactMatchingTelCarrier = String(matchingTel.carrier);
<a name="l00433"></a>00433                 }
<a name="l00434"></a>00434               }
<a name="l00435"></a>00435             }
<a name="l00436"></a>00436             groups[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = group;
<a name="l00437"></a>00437             groupCount++;
<a name="l00438"></a>00438           }
<a name="l00439"></a>00439           waitForAsyncCall--;
<a name="l00440"></a>00440           onGroupsDone();
<a name="l00441"></a>00441         });
<a name="l00442"></a>00442         <a class="code" href="../../dc/d6a/xpt__xdr_8h.html#a7056fb315468c5bec29afb3b459e8b92">cursor</a>.continue();
<a name="l00443"></a>00443       };
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     var groupsStore = transaction.objectStore(<span class="keyword">self</span>._dbGroupsStore);
<a name="l00447"></a>00447     <span class="comment">// First of all we delete the old groups object store.</span>
<a name="l00448"></a>00448     <a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>.deleteObjectStore(<span class="keyword">self</span>._dbGroupsStore);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="comment">// We recreate the object store that can be used to quickly construct a</span>
<a name="l00451"></a>00451     <span class="comment">// group view of the recent calls database. Each entry looks like this:</span>
<a name="l00452"></a>00452     <span class="comment">// { id: [date&lt;Date&gt;, number&lt;String&gt;, type&lt;String&gt;, status&lt;String&gt;],</span>
<a name="l00453"></a>00453     <span class="comment">//   lastEntryDate: &lt;Date&gt;, (index)</span>
<a name="l00454"></a>00454     <span class="comment">//   retryCount: &lt;Number&gt;,</span>
<a name="l00455"></a>00455     <span class="comment">//   number: &lt;String&gt;, (index)</span>
<a name="l00456"></a>00456     <span class="comment">//   contactId: &lt;String&gt;, (index)</span>
<a name="l00457"></a>00457     <span class="comment">//   contactPrimaryInfo: &lt;String&gt;,</span>
<a name="l00458"></a>00458     <span class="comment">//   contactMatchingTelType: &lt;String&gt;,</span>
<a name="l00459"></a>00459     <span class="comment">//   contactMatchingTelCarrier: &lt;String&gt;,</span>
<a name="l00460"></a>00460     <span class="comment">//   contactPhoto: &lt;Blob&gt; }</span>
<a name="l00461"></a>00461     <span class="comment">//</span>
<a name="l00462"></a>00462     <span class="comment">//  The &lt;Date&gt; value from the &#39;id&#39; field contains only the day of the call.</span>
<a name="l00463"></a>00463     <span class="comment">//</span>
<a name="l00464"></a>00464     <span class="comment">//  &#39;lastEntryDate&#39; contains a full date.</span>
<a name="l00465"></a>00465     <span class="comment">//</span>
<a name="l00466"></a>00466     <span class="comment">//  &#39;retryCount&#39; is incremented when we store a new call.</span>
<a name="l00467"></a>00467     var groupsStore = <a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>.createObjectStore(<span class="keyword">self</span>._dbGroupsStore,
<a name="l00468"></a>00468                                            { keyPath: <span class="stringliteral">&#39;id&#39;</span> });
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <span class="comment">// We create indexes for &#39;contact-id&#39;, &#39;number&#39; and &#39;lastEntryDate&#39;</span>
<a name="l00471"></a>00471     <span class="comment">// as we will be searching by number, contact and date.</span>
<a name="l00472"></a>00472     <span class="comment">// Unfortunately, even if we have the number data in the group id field, we</span>
<a name="l00473"></a>00473     <span class="comment">// can&#39;t search for [*, &quot;exact number match&quot;, *, *], so we need a new</span>
<a name="l00474"></a>00474     <span class="comment">// &#39;number&#39; index.</span>
<a name="l00475"></a>00475     groupsStore.createIndex(<span class="stringliteral">&#39;number&#39;</span>, <span class="stringliteral">&#39;number&#39;</span>);
<a name="l00476"></a>00476     groupsStore.createIndex(<span class="stringliteral">&#39;contactId&#39;</span>, <span class="stringliteral">&#39;contactId&#39;</span>);
<a name="l00477"></a>00477     groupsStore.createIndex(<span class="stringliteral">&#39;lastEntryDate&#39;</span>, <span class="stringliteral">&#39;lastEntryDate&#39;</span>);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <span class="comment">// We get the number of calls stored in the database so we can send</span>
<a name="l00480"></a>00480     <span class="comment">// progress events with the appropriate percentage of upgrade process</span>
<a name="l00481"></a>00481     <span class="comment">// completed.</span>
<a name="l00482"></a>00482     var recentsStore = transaction.objectStore(<span class="keyword">self</span>._dbRecentsStore);
<a name="l00483"></a>00483     recentsStore.count().onsuccess = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00484"></a>00484       recentsCount = <span class="keyword">event</span>.target.result;
<a name="l00485"></a>00485       populateGroups();
<a name="l00486"></a>00486     };
<a name="l00487"></a>00487   },
<a name="l00493"></a>00493   _upgradeSchemaVersion5: <span class="keyword">function</span> upgradeSchemaVersion5(next) {
<a name="l00494"></a>00494     next();
<a name="l00495"></a>00495   },
<a name="l00499"></a>00499   _getGroupId: <span class="keyword">function</span> getGroupId(recentCall) {
<a name="l00500"></a>00500     var groupId = [<a class="code" href="../../d1/db7/apps_2communications_2dialer_2js_2utils_8js.html#af21ebfdaa2ee891fa5788a82b2e2586c">Utils</a>.getDayDate(recentCall.date),
<a name="l00501"></a>00501                    recentCall.number, recentCall.type];
<a name="l00502"></a>00502     <span class="keywordflow">if</span> (recentCall.status &amp;&amp; recentCall.type === <span class="stringliteral">&#39;incoming&#39;</span>) {
<a name="l00503"></a>00503       groupId.push(recentCall.status);
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505     <span class="keywordflow">return</span> groupId;
<a name="l00506"></a>00506   },
<a name="l00550"></a>00550   _getGroupObject: <span class="keyword">function</span> getGroupObject(group) {
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (!Array.isArray(group.id) || group.id.length &lt; 3) {
<a name="l00552"></a>00552       <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00553"></a>00553     }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     var <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>;
<a name="l00556"></a>00556     <span class="keywordflow">if</span> (group.contactId) {
<a name="l00557"></a>00557       contact = {
<a name="l00558"></a>00558         <span class="keywordtype">id</span>: group.contactId,
<a name="l00559"></a>00559         primaryInfo: group.contactPrimaryInfo,
<a name="l00560"></a>00560         matchingTel: {
<a name="l00561"></a>00561           number: group.id[1],
<a name="l00562"></a>00562           <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: group.contactMatchingTelType,
<a name="l00563"></a>00563           carrier: group.contactMatchingTelCarrier
<a name="l00564"></a>00564         },
<a name="l00565"></a>00565         photo: group.contactPhoto
<a name="l00566"></a>00566       };
<a name="l00567"></a>00567     }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     <span class="keywordflow">return</span> {
<a name="l00570"></a>00570       <span class="keywordtype">id</span>: group.id.join(<span class="charliteral">&#39;-&#39;</span>),
<a name="l00571"></a>00571       <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: group.id[0],
<a name="l00572"></a>00572       number: group.id[1],
<a name="l00573"></a>00573       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: group.id[2],
<a name="l00574"></a>00574       <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: group.id[3] || undefined,
<a name="l00575"></a>00575       lastEntryDate: group.lastEntryDate,
<a name="l00576"></a>00576       retryCount: group.retryCount,
<a name="l00577"></a>00577       contact: <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>,
<a name="l00578"></a>00578       emergency: group.emergency,
<a name="l00579"></a>00579       voicemail: group.voicemail
<a name="l00580"></a>00580     };
<a name="l00581"></a>00581   },
<a name="l00588"></a>00588   _keepDbPrettyAndFit: <span class="keyword">function</span> _keepDbPrettyAndFit(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00589"></a>00589     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00590"></a>00590     this._newTxn(<span class="stringliteral">&#39;readonly&#39;</span>, this._dbGroupsStore, <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l00591"></a>00591       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00592"></a>00592         <span class="keywordflow">return</span>;
<a name="l00593"></a>00593       }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595       var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a> = store.count();
<a name="l00596"></a>00596       req.onsuccess = <span class="keyword">function</span>() {
<a name="l00597"></a>00597         var groupsToDelete = req.result - <span class="keyword">self</span>._maxNumberOfGroups;
<a name="l00598"></a>00598         <span class="keywordflow">if</span> (groupsToDelete &gt; 0) {
<a name="l00599"></a>00599           groupsToDelete += <span class="keyword">self</span>._numberOfGroupsToDelete;
<a name="l00600"></a>00600           var cursorReq = store.index(<span class="stringliteral">&#39;lastEntryDate&#39;</span>).openCursor();
<a name="l00601"></a>00601           cursorReq.onsuccess = <span class="keyword">function</span>() {
<a name="l00602"></a>00602             var <a class="code" href="../../dc/d6a/xpt__xdr_8h.html#a7056fb315468c5bec29afb3b459e8b92">cursor</a> = cursorReq.result;
<a name="l00603"></a>00603             <span class="keywordflow">if</span> (!cursor || !groupsToDelete) {
<a name="l00604"></a>00604               <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> &amp;&amp; <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> instanceof Function) {
<a name="l00605"></a>00605                 <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l00606"></a>00606               }
<a name="l00607"></a>00607               <span class="keywordflow">return</span>;
<a name="l00608"></a>00608             }
<a name="l00609"></a>00609             groupsToDelete--;
<a name="l00610"></a>00610             <span class="keyword">self</span>.deleteGroup(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, cursor.value.id);
<a name="l00611"></a>00611             cursor.continue();
<a name="l00612"></a>00612           };
<a name="l00613"></a>00613         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> &amp;&amp; <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> instanceof Function) {
<a name="l00614"></a>00614           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616       };
<a name="l00617"></a>00617     });
<a name="l00618"></a>00618   },
<a name="l00637"></a>00637   <a class="code" href="../../d3/d4a/mock__recipients_8js.html#a81b686bc164506c493dc722ce59d5b54">add</a>: <span class="keyword">function</span> <a class="code" href="../../d3/d4a/mock__recipients_8js.html#a81b686bc164506c493dc722ce59d5b54">add</a>(recentCall, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00638"></a>00638     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> recentCall !== <span class="stringliteral">&#39;object&#39;</span>) {
<a name="l00639"></a>00639       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;INVALID_CALL&#39;</span>);
<a name="l00640"></a>00640       <span class="keywordflow">return</span>;
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00644"></a>00644     this._newTxn(<span class="stringliteral">&#39;readwrite&#39;</span>, [this._dbRecentsStore, this._dbGroupsStore],
<a name="l00645"></a>00645                  <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, stores) {
<a name="l00646"></a>00646       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00647"></a>00647         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l00648"></a>00648         <span class="keywordflow">return</span>;
<a name="l00649"></a>00649       }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651       var recentsStore = stores[0];
<a name="l00652"></a>00652       var groupsStore = stores[1];
<a name="l00653"></a>00653 
<a name="l00654"></a>00654       var groupId = <span class="keyword">self</span>._getGroupId(recentCall);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656       <span class="comment">// For adding a call to the database we first create or update its</span>
<a name="l00657"></a>00657       <span class="comment">// corresponding group and then we store the actual call adding the id</span>
<a name="l00658"></a>00658       <span class="comment">// of the group where it belongs.</span>
<a name="l00659"></a>00659       groupsStore.get(groupId).onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>() {
<a name="l00660"></a>00660         var group = this.<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>;
<a name="l00661"></a>00661         <span class="keywordflow">if</span> (group) {
<a name="l00662"></a>00662           <span class="comment">// Groups should have the date of the newest call.</span>
<a name="l00663"></a>00663           <span class="keywordflow">if</span> (group.lastEntryDate &lt;= recentCall.date) {
<a name="l00664"></a>00664             group.lastEntryDate = recentCall.date;
<a name="l00665"></a>00665             group.emergency = recentCall.emergency;
<a name="l00666"></a>00666             group.voicemail = recentCall.voicemail;
<a name="l00667"></a>00667           }
<a name="l00668"></a>00668           group.retryCount++;
<a name="l00669"></a>00669           groupsStore.put(group).onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>() {
<a name="l00670"></a>00670             <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <span class="keyword">self</span>._getGroupObject(group));
<a name="l00671"></a>00671           };
<a name="l00672"></a>00672         } <span class="keywordflow">else</span> {
<a name="l00673"></a>00673           group = {
<a name="l00674"></a>00674             <span class="keywordtype">id</span>: groupId,
<a name="l00675"></a>00675             number: recentCall.number,
<a name="l00676"></a>00676             lastEntryDate: recentCall.date,
<a name="l00677"></a>00677             retryCount: 1,
<a name="l00678"></a>00678             emergency: recentCall.emergency,
<a name="l00679"></a>00679             voicemail: recentCall.voicemail
<a name="l00680"></a>00680           };
<a name="l00681"></a>00681           <a class="code" href="../../d7/d68/apps_2communications_2contacts_2js_2contacts_8js.html#a55257a4a6c5aab93045fd427504a1c95">Contacts</a>.findByNumber(recentCall.number,
<a name="l00682"></a>00682                                 <span class="keyword">function</span>(contact, matchingTel) {
<a name="l00683"></a>00683             <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (contact &amp;&amp; contact !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l00684"></a>00684               group.contactId = contact.id;
<a name="l00685"></a>00685               <span class="keywordflow">if</span> (Array.isArray(contact.photo) &amp;&amp; contact.photo[0]) {
<a name="l00686"></a>00686                 group.contactPhoto = contact.photo[0];
<a name="l00687"></a>00687               }
<a name="l00688"></a>00688               <span class="keywordflow">if</span> (matchingTel) {
<a name="l00689"></a>00689                 var primaryInfo = <a class="code" href="../../d1/db7/apps_2communications_2dialer_2js_2utils_8js.html#af21ebfdaa2ee891fa5788a82b2e2586c">Utils</a>.getPhoneNumberPrimaryInfo(matchingTel,
<a name="l00690"></a>00690                                                                   contact);
<a name="l00691"></a>00691                 <span class="keywordflow">if</span> (Array.isArray(primaryInfo)) {
<a name="l00692"></a>00692                   primaryInfo = primaryInfo[0];
<a name="l00693"></a>00693                 }
<a name="l00694"></a>00694                 group.contactPrimaryInfo = String(primaryInfo);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696                 <span class="keywordflow">if</span> (Array.isArray(matchingTel.type) &amp;&amp; matchingTel.type[0]) {
<a name="l00697"></a>00697                   group.contactMatchingTelType = String(matchingTel.type[0]);
<a name="l00698"></a>00698                 } <span class="keywordflow">else</span> {
<a name="l00699"></a>00699                   group.contactMatchingTelType = String(matchingTel.type);
<a name="l00700"></a>00700                 }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702                 <span class="keywordflow">if</span> (matchingTel.carrier) {
<a name="l00703"></a>00703                   group.contactMatchingTelCarrier = String(matchingTel.carrier);
<a name="l00704"></a>00704                 }
<a name="l00705"></a>00705               }
<a name="l00706"></a>00706             }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708             <span class="keyword">self</span>._newTxn(<span class="stringliteral">&#39;readwrite&#39;</span>, [<span class="keyword">self</span>._dbGroupsStore],
<a name="l00709"></a>00709                          <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l00710"></a>00710               store.add(group).onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>() {
<a name="l00711"></a>00711                 <span class="comment">// Once the group has successfully been added, we check that the</span>
<a name="l00712"></a>00712                 <span class="comment">// db size is below the max size set.</span>
<a name="l00713"></a>00713                 <span class="keyword">self</span>._keepDbPrettyAndFit(<span class="keyword">function</span>() {
<a name="l00714"></a>00714                   <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <span class="keyword">self</span>._getGroupObject(group));
<a name="l00715"></a>00715                 });
<a name="l00716"></a>00716               };
<a name="l00717"></a>00717             });
<a name="l00718"></a>00718           });
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721         recentCall.groupId = groupId;
<a name="l00722"></a>00722         recentsStore.put(recentCall);
<a name="l00723"></a>00723       };
<a name="l00724"></a>00724     });
<a name="l00725"></a>00725   },
<a name="l00737"></a>00737   deleteGroup: <span class="keyword">function</span> deleteGroup(group, groupId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00738"></a>00738     <span class="comment">// Valid group doesn&#39;t need to contain number, we can receive</span>
<a name="l00739"></a>00739     <span class="comment">// calls from unknown or hidden numbers as well</span>
<a name="l00740"></a>00740     <span class="keywordflow">if</span> (!groupId &amp;&amp;
<a name="l00741"></a>00741         (!group || <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> group !== <span class="stringliteral">&#39;object&#39;</span> || !group.date || !group.type)) {
<a name="l00742"></a>00742       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;NOT_VALID_GROUP&#39;</span>);
<a name="l00743"></a>00743       <span class="keywordflow">return</span>;
<a name="l00744"></a>00744     }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     this._newTxn(<span class="stringliteral">&#39;readwrite&#39;</span>, [this._dbGroupsStore, this._dbRecentsStore],
<a name="l00749"></a>00749                  <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, stores) {
<a name="l00750"></a>00750       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00751"></a>00751         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l00752"></a>00752         <span class="keywordflow">return</span>;
<a name="l00753"></a>00753       }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755       var groupsStore = stores[0];
<a name="l00756"></a>00756       var recentsStore = stores[1];
<a name="l00757"></a>00757 
<a name="l00758"></a>00758       <span class="keywordflow">if</span> (!groupId) {
<a name="l00759"></a>00759         groupId = <span class="keyword">self</span>._getGroupId(group);
<a name="l00760"></a>00760       }
<a name="l00761"></a>00761 
<a name="l00762"></a>00762       <span class="comment">// We delete the given group and all its corresponding calls.</span>
<a name="l00763"></a>00763       groupsStore.delete(groupId).onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>() {
<a name="l00764"></a>00764         var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a90aa0230f3430f1172f8646802a5dd35">deleted</a> = 0;
<a name="l00765"></a>00765         recentsStore.index(<span class="stringliteral">&#39;groupId&#39;</span>).openCursor(groupId)
<a name="l00766"></a>00766                     .onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00767"></a>00767           var cursor = <span class="keyword">event</span>.target.result;
<a name="l00768"></a>00768           <span class="keywordflow">if</span> (cursor) {
<a name="l00769"></a>00769             cursor.delete();
<a name="l00770"></a>00770             deleted++;
<a name="l00771"></a>00771             cursor.continue();
<a name="l00772"></a>00772           } <span class="keywordflow">else</span> {
<a name="l00773"></a>00773             <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deleted);
<a name="l00774"></a>00774           }
<a name="l00775"></a>00775         };
<a name="l00776"></a>00776       };
<a name="l00777"></a>00777     });
<a name="l00778"></a>00778   },
<a name="l00790"></a>00790   deleteGroupList: <span class="keyword">function</span> deleteGroupList(groupList, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>,
<a name="l00791"></a>00791                                             deletedCount) {
<a name="l00792"></a>00792     <span class="keywordflow">if</span> (!deletedCount) {
<a name="l00793"></a>00793       deletedCount = 0;
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     <span class="keywordflow">if</span> (groupList.length &gt; 0) {
<a name="l00799"></a>00799       var itemToDelete = groupList.pop();
<a name="l00800"></a>00800       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> itemToDelete !== <span class="stringliteral">&#39;object&#39;</span>) {
<a name="l00801"></a>00801         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <span class="stringliteral">&#39;INVALID_GROUP_IN_LIST&#39;</span>);
<a name="l00802"></a>00802         <span class="keywordflow">return</span>;
<a name="l00803"></a>00803       }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805       var ondeleted = <span class="keyword">function</span> ondeleted(<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>) {
<a name="l00806"></a>00806         <span class="comment">// We expect a number. Otherwise that means that we got an error</span>
<a name="l00807"></a>00807         <span class="comment">// message.</span>
<a name="l00808"></a>00808         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a> !== <span class="stringliteral">&#39;number&#39;</span>) {
<a name="l00809"></a>00809           <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>);
<a name="l00810"></a>00810           <span class="keywordflow">return</span>;
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812         deletedCount += <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>;
<a name="l00813"></a>00813         <span class="keyword">self</span>.deleteGroupList(groupList, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deletedCount);
<a name="l00814"></a>00814       };
<a name="l00815"></a>00815 
<a name="l00816"></a>00816       <span class="keyword">self</span>.deleteGroup(itemToDelete, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, ondeleted);
<a name="l00817"></a>00817     } <span class="keywordflow">else</span> {
<a name="l00818"></a>00818       <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deletedCount);
<a name="l00819"></a>00819     }
<a name="l00820"></a>00820   },
<a name="l00829"></a>00829   deleteAll: <span class="keyword">function</span> deleteAll(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00830"></a>00830     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00831"></a>00831     this._newTxn(<span class="stringliteral">&#39;readwrite&#39;</span>, [this._dbRecentsStore, this._dbGroupsStore],
<a name="l00832"></a>00832                  <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, stores) {
<a name="l00833"></a>00833       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00834"></a>00834         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l00835"></a>00835         <span class="keywordflow">return</span>;
<a name="l00836"></a>00836       }
<a name="l00837"></a>00837 
<a name="l00838"></a>00838       var recentsStore = stores[0];
<a name="l00839"></a>00839       var groupsStore = stores[1];
<a name="l00840"></a>00840 
<a name="l00841"></a>00841       recentsStore.clear().onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>() {
<a name="l00842"></a>00842         groupsStore.clear().onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>() {
<a name="l00843"></a>00843           <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00844"></a>00844         };
<a name="l00845"></a>00845       };
<a name="l00846"></a>00846     });
<a name="l00847"></a>00847   },
<a name="l00854"></a>00854   deleteDb: <span class="keyword">function</span> deleteDb(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00855"></a>00855     var indexedDB = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.indexedDB || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.webkitIndexedDB ||
<a name="l00856"></a>00856                     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.mozIndexedDB || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.msIndexedDB;
<a name="l00857"></a>00857     <span class="keywordflow">if</span> (!indexedDB) {
<a name="l00858"></a>00858       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;NO_INDEXEDDB_AVAILABLE&#39;</span>);
<a name="l00859"></a>00859       <span class="keywordflow">return</span>;
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861     <span class="comment">// We need to close the DB before deleting it.</span>
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (this._db) {
<a name="l00863"></a>00863       this._db.close();
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00867"></a>00867     var req = indexedDB.deleteDatabase(this._dbName);
<a name="l00868"></a>00868     req.onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>() {
<a name="l00869"></a>00869       <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00870"></a>00870     };
<a name="l00871"></a>00871     req.onerror = <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>() {
<a name="l00872"></a>00872       <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, req.error.name);
<a name="l00873"></a>00873     };
<a name="l00874"></a>00874   },
<a name="l00898"></a>00898   _getList: <span class="keyword">function</span> getList(storeName, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, sortedBy, <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#aa8ce26f0d9a701e8f80cbff3ed272d85">prev</a>,
<a name="l00899"></a>00899                              getCursor, limit) {
<a name="l00900"></a>00900     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> || !<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> instanceof Function) {
<a name="l00901"></a>00901       <span class="keywordflow">return</span>;
<a name="l00902"></a>00902     }
<a name="l00903"></a>00903 
<a name="l00904"></a>00904     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00905"></a>00905     this._newTxn(<span class="stringliteral">&#39;readonly&#39;</span>, [storeName], <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l00906"></a>00906       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00907"></a>00907         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l00908"></a>00908         <span class="keywordflow">return</span>;
<a name="l00909"></a>00909       }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911       var cursor = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00912"></a>00912       var <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a> = <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#aa8ce26f0d9a701e8f80cbff3ed272d85">prev</a> ? <span class="stringliteral">&#39;prev&#39;</span> : <span class="stringliteral">&#39;next&#39;</span>;
<a name="l00913"></a>00913       <span class="keywordflow">if</span> (sortedBy &amp;&amp; sortedBy !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l00914"></a>00914         <span class="keywordflow">if</span> (!store.indexNames.contains(sortedBy) &amp;&amp; sortedBy != <span class="stringliteral">&#39;id&#39;</span>) {
<a name="l00915"></a>00915           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;INVALID_SORTED_BY_KEY&#39;</span>);
<a name="l00916"></a>00916           txn.abort();
<a name="l00917"></a>00917           <span class="keywordflow">return</span>;
<a name="l00918"></a>00918         }
<a name="l00919"></a>00919         cursor = store.index(sortedBy).openCursor(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, direction);
<a name="l00920"></a>00920       } <span class="keywordflow">else</span> {
<a name="l00921"></a>00921         cursor = store.openCursor(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, direction);
<a name="l00922"></a>00922       }
<a name="l00923"></a>00923       var <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a> = [];
<a name="l00924"></a>00924       cursor.onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00925"></a>00925         var item = <span class="keyword">event</span>.target.result;
<a name="l00926"></a>00926 
<a name="l00927"></a>00927         <span class="keywordflow">if</span> (item &amp;&amp; getCursor) {
<a name="l00928"></a>00928           <span class="keywordflow">if</span> (storeName === <span class="keyword">self</span>._dbGroupsStore) {
<a name="l00929"></a>00929             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>({
<a name="l00930"></a>00930               <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>: <span class="keyword">self</span>._getGroupObject(item.value),
<a name="l00931"></a>00931               <span class="keywordflow">continue</span>: <span class="keyword">function</span>() { <span class="keywordflow">return</span> item.continue(); }
<a name="l00932"></a>00932             });
<a name="l00933"></a>00933           } <span class="keywordflow">else</span> {
<a name="l00934"></a>00934             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(item);
<a name="l00935"></a>00935           }
<a name="l00936"></a>00936           <span class="keywordflow">return</span>;
<a name="l00937"></a>00937         }
<a name="l00938"></a>00938 
<a name="l00939"></a>00939         <span class="keywordflow">if</span> (item &amp;&amp; (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> limit === <span class="stringliteral">&#39;undefined&#39;</span> || limit &gt; 0)) {
<a name="l00940"></a>00940           <span class="keywordflow">if</span> (storeName === <span class="keyword">self</span>._dbGroupsStore) {
<a name="l00941"></a>00941             result.push(<span class="keyword">self</span>._getGroupObject(item.value));
<a name="l00942"></a>00942           } <span class="keywordflow">else</span> {
<a name="l00943"></a>00943             result.push(item.value);
<a name="l00944"></a>00944           }
<a name="l00945"></a>00945           <span class="keywordflow">if</span> (limit) {
<a name="l00946"></a>00946             limit--;
<a name="l00947"></a>00947           }
<a name="l00948"></a>00948           item.continue();
<a name="l00949"></a>00949         } <span class="keywordflow">else</span> {
<a name="l00950"></a>00950           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(result);
<a name="l00951"></a>00951         }
<a name="l00952"></a>00952       };
<a name="l00953"></a>00953       cursor.onerror = <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00954"></a>00954         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.target.error.name);
<a name="l00955"></a>00955       };
<a name="l00956"></a>00956     });
<a name="l00957"></a>00957   },
<a name="l00978"></a>00978   getRecentList: <span class="keyword">function</span> getRecentList(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, sortedBy, <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#aa8ce26f0d9a701e8f80cbff3ed272d85">prev</a>,
<a name="l00979"></a>00979                                         getCursor, limit) {
<a name="l00980"></a>00980     this._getList(this._dbRecentsStore, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, sortedBy, <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#aa8ce26f0d9a701e8f80cbff3ed272d85">prev</a>, getCursor,
<a name="l00981"></a>00981                   limit);
<a name="l00982"></a>00982   },
<a name="l01003"></a>01003   getGroupList: <span class="keyword">function</span> getGroupList(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, sortedBy, <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#aa8ce26f0d9a701e8f80cbff3ed272d85">prev</a>,
<a name="l01004"></a>01004                                       getCursor, limit) {
<a name="l01005"></a>01005     <span class="comment">// The primary key of the groups object store contains the &#39;number&#39;, &#39;type&#39;</span>
<a name="l01006"></a>01006     <span class="comment">// and &#39;status&#39; fields.</span>
<a name="l01007"></a>01007     <span class="keywordflow">if</span> (sortedBy === <span class="stringliteral">&#39;number&#39;</span> || sortedBy === <span class="stringliteral">&#39;type&#39;</span> || sortedBy === <span class="stringliteral">&#39;status&#39;</span>) {
<a name="l01008"></a>01008       sortedBy = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01009"></a>01009     }
<a name="l01010"></a>01010     this._getList(this._dbGroupsStore, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, sortedBy, <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#aa8ce26f0d9a701e8f80cbff3ed272d85">prev</a>, getCursor,
<a name="l01011"></a>01011                   limit);
<a name="l01012"></a>01012   },
<a name="l01031"></a>01031   getGroupAtPosition: <span class="keyword">function</span> rdbm_getGroupAtPosition(<a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>, sortedBy, <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#aa8ce26f0d9a701e8f80cbff3ed272d85">prev</a>,
<a name="l01032"></a>01032                                                        <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01033"></a>01033     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> || !<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> instanceof Function) {
<a name="l01034"></a>01034       <span class="keywordflow">return</span>;
<a name="l01035"></a>01035     }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01038"></a>01038     this._newTxn(<span class="stringliteral">&#39;readonly&#39;</span>, this._dbGroupsStore,
<a name="l01039"></a>01039                  <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l01040"></a>01040       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l01041"></a>01041         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l01042"></a>01042         <span class="keywordflow">return</span>;
<a name="l01043"></a>01043       }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045       <span class="keywordflow">try</span> {
<a name="l01046"></a>01046         var <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01047"></a>01047         var direction = <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#aa8ce26f0d9a701e8f80cbff3ed272d85">prev</a> ? <span class="stringliteral">&#39;prev&#39;</span> : <span class="stringliteral">&#39;next&#39;</span>;
<a name="l01048"></a>01048         <span class="keywordflow">if</span> (sortedBy &amp;&amp; sortedBy !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l01049"></a>01049           request = store.index(sortedBy).openCursor(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, direction);
<a name="l01050"></a>01050         } <span class="keywordflow">else</span> {
<a name="l01051"></a>01051           request = store.openCursor(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, direction);
<a name="l01052"></a>01052         }
<a name="l01053"></a>01053 
<a name="l01054"></a>01054         var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         request.onsuccess = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01057"></a>01057           var cursor = <span class="keyword">event</span>.target.result;
<a name="l01058"></a>01058           <span class="keywordflow">if</span> (!cursor) {
<a name="l01059"></a>01059             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l01060"></a>01060             <span class="keywordflow">return</span>;
<a name="l01061"></a>01061           }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063           var recentGroup = <span class="keyword">self</span>._getGroupObject(cursor.value);
<a name="l01064"></a>01064           var matched = !<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> || recentGroup.type.indexOf(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) != -1;
<a name="l01065"></a>01065           <span class="keywordflow">if</span> (matched) {
<a name="l01066"></a>01066             i++;
<a name="l01067"></a>01067           }
<a name="l01068"></a>01068 
<a name="l01069"></a>01069           <span class="keywordflow">if</span> (matched &amp;&amp; i == <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>) {
<a name="l01070"></a>01070             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(recentGroup);
<a name="l01071"></a>01071           } <span class="keywordflow">else</span> {
<a name="l01072"></a>01072             cursor.continue();
<a name="l01073"></a>01073           }
<a name="l01074"></a>01074         };
<a name="l01075"></a>01075 
<a name="l01076"></a>01076         request.onerror = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01077"></a>01077           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.target.error.name);
<a name="l01078"></a>01078         };
<a name="l01079"></a>01079       } <span class="keywordflow">catch</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l01080"></a>01080         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l01081"></a>01081       }
<a name="l01082"></a>01082     });
<a name="l01083"></a>01083   },
<a name="l01084"></a>01084 
<a name="l01094"></a>01094   getLastCall: <span class="keyword">function</span> getLastCall(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01095"></a>01095     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> || !<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> instanceof Function) {
<a name="l01096"></a>01096       <span class="keywordflow">return</span>;
<a name="l01097"></a>01097     }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099     this._newTxn(<span class="stringliteral">&#39;readonly&#39;</span>, [this._dbRecentsStore],
<a name="l01100"></a>01100                  <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l01101"></a>01101       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l01102"></a>01102         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l01103"></a>01103         <span class="keywordflow">return</span>;
<a name="l01104"></a>01104       }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106       var cursor = store.openCursor(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;prev&#39;</span>);
<a name="l01107"></a>01107       cursor.onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01108"></a>01108         var item = <span class="keyword">event</span>.target.result;
<a name="l01109"></a>01109         <span class="keywordflow">if</span> (item &amp;&amp; item.value) {
<a name="l01110"></a>01110           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(item.value);
<a name="l01111"></a>01111         } <span class="keywordflow">else</span> {
<a name="l01112"></a>01112           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l01113"></a>01113         }
<a name="l01114"></a>01114       };
<a name="l01115"></a>01115       cursor.onerror = <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01116"></a>01116         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.target.error.name);
<a name="l01117"></a>01117       };
<a name="l01118"></a>01118     });
<a name="l01119"></a>01119   },
<a name="l01120"></a>01120 
<a name="l01128"></a>01128   _updateCacheRevision: <span class="keyword">function</span> _updateCacheRevision() {
<a name="l01129"></a>01129     <a class="code" href="../../d7/d68/apps_2communications_2contacts_2js_2contacts_8js.html#a55257a4a6c5aab93045fd427504a1c95">Contacts</a>.getRevision(<span class="keyword">function</span>(contactsRevision) {
<a name="l01130"></a>01130       <span class="keywordflow">if</span> (contactsRevision) {
<a name="l01131"></a>01131         <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.asyncStorage.setItem(<span class="stringliteral">&#39;contactCacheRevision&#39;</span>,
<a name="l01132"></a>01132                                     contactsRevision);
<a name="l01133"></a>01133       }
<a name="l01134"></a>01134     });
<a name="l01135"></a>01135   },
<a name="l01136"></a>01136 
<a name="l01152"></a>01152   updateGroupContactInfo: <span class="keyword">function</span> updateGroupContactInfo(contact,
<a name="l01153"></a>01153                                                           matchingTel,
<a name="l01154"></a>01154                                                           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01155"></a>01155 
<a name="l01156"></a>01156     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01157"></a>01157     this._newTxn(<span class="stringliteral">&#39;readwrite&#39;</span>, [this._dbGroupsStore],
<a name="l01158"></a>01158                   <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l01159"></a>01159       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l01160"></a>01160         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l01161"></a>01161         <span class="keywordflow">return</span>;
<a name="l01162"></a>01162       }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164       <span class="keywordflow">if</span> (!contact) {
<a name="l01165"></a>01165         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, 0);
<a name="l01166"></a>01166         <span class="keywordflow">return</span>;
<a name="l01167"></a>01167       }
<a name="l01168"></a>01168 
<a name="l01169"></a>01169       var <a class="code" href="../../de/deb/jsdbgapi_8h.html#af811e5c0ef06b777b160f87806b7285e">count</a> = 0;
<a name="l01170"></a>01170       var req = store.index(<span class="stringliteral">&#39;number&#39;</span>)
<a name="l01171"></a>01171                      .openCursor(IDBKeyRange.only(matchingTel.value));
<a name="l01172"></a>01172       req.onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01173"></a>01173         var cursor = <span class="keyword">event</span>.target.result;
<a name="l01174"></a>01174         <span class="keywordflow">if</span> (cursor &amp;&amp; cursor.value) {
<a name="l01175"></a>01175           var group = cursor.value;
<a name="l01176"></a>01176           group.contactId = contact.id;
<a name="l01177"></a>01177           <span class="keywordflow">if</span> (Array.isArray(contact.photo) &amp;&amp; contact.photo[0]) {
<a name="l01178"></a>01178             group.contactPhoto = contact.photo[0];
<a name="l01179"></a>01179           }
<a name="l01180"></a>01180           <span class="keywordflow">if</span> (matchingTel) {
<a name="l01181"></a>01181             var primaryInfo = <a class="code" href="../../d1/db7/apps_2communications_2dialer_2js_2utils_8js.html#af21ebfdaa2ee891fa5788a82b2e2586c">Utils</a>.getPhoneNumberPrimaryInfo(matchingTel,
<a name="l01182"></a>01182                                                               contact);
<a name="l01183"></a>01183             <span class="keywordflow">if</span> (Array.isArray(primaryInfo) &amp;&amp; primaryInfo[0]) {
<a name="l01184"></a>01184               primaryInfo = primaryInfo[0];
<a name="l01185"></a>01185             }
<a name="l01186"></a>01186             group.contactPrimaryInfo = String(primaryInfo);
<a name="l01187"></a>01187             <span class="keywordflow">if</span> (Array.isArray(matchingTel.type) &amp;&amp; matchingTel.type[0]) {
<a name="l01188"></a>01188               group.contactMatchingTelType = String(matchingTel.type[0]);
<a name="l01189"></a>01189             }
<a name="l01190"></a>01190             <span class="keywordflow">if</span> (matchingTel.carrier) {
<a name="l01191"></a>01191               group.contactMatchingTelCarrier = String(matchingTel.carrier);
<a name="l01192"></a>01192             }
<a name="l01193"></a>01193           }
<a name="l01194"></a>01194           cursor.update(group);
<a name="l01195"></a>01195           count++;
<a name="l01196"></a>01196           cursor.continue();
<a name="l01197"></a>01197         } <span class="keywordflow">else</span> {
<a name="l01198"></a>01198           <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, count);
<a name="l01199"></a>01199           <span class="keyword">self</span>._updateCacheRevision();
<a name="l01200"></a>01200         }
<a name="l01201"></a>01201       };
<a name="l01202"></a>01202       req.onerror = <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01203"></a>01203         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.target.error.name);
<a name="l01204"></a>01204       };
<a name="l01205"></a>01205     });
<a name="l01206"></a>01206   },
<a name="l01207"></a>01207 
<a name="l01226"></a>01226   removeGroupContactInfo: <span class="keyword">function</span> removeGroupContactInfo(contactId,
<a name="l01227"></a>01227                                                           group,
<a name="l01228"></a>01228                                                           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01229"></a>01229     <span class="keywordflow">if</span> (!contactId &amp;&amp; !group) {
<a name="l01230"></a>01230       this._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, 0);
<a name="l01231"></a>01231       <span class="keywordflow">return</span>;
<a name="l01232"></a>01232     }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01235"></a>01235 
<a name="l01236"></a>01236     this._newTxn(<span class="stringliteral">&#39;readwrite&#39;</span>, [this._dbGroupsStore],
<a name="l01237"></a>01237                  <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l01238"></a>01238       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l01239"></a>01239         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l01240"></a>01240         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l01241"></a>01241         <span class="keywordflow">return</span>;
<a name="l01242"></a>01242       }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244       var count = 0;
<a name="l01245"></a>01245 
<a name="l01246"></a>01246       var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a>;
<a name="l01247"></a>01247       <span class="keywordflow">if</span> (contactId) {
<a name="l01248"></a>01248         req = store.index(<span class="stringliteral">&#39;contactId&#39;</span>).openCursor(contactId);
<a name="l01249"></a>01249       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (group) {
<a name="l01250"></a>01250         var groupId = <span class="keyword">self</span>._getGroupId(group);
<a name="l01251"></a>01251         req = store.openCursor(groupId);
<a name="l01252"></a>01252       }
<a name="l01253"></a>01253       req.onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01254"></a>01254         var cursor = <span class="keyword">event</span>.target.result;
<a name="l01255"></a>01255         <span class="keywordflow">if</span> (cursor) {
<a name="l01256"></a>01256           var group = cursor.value;
<a name="l01257"></a>01257           <span class="keywordflow">if</span> (group.contactId) {
<a name="l01258"></a>01258             <span class="keyword">delete</span> group.contactId;
<a name="l01259"></a>01259           }
<a name="l01260"></a>01260           <span class="keywordflow">if</span> (group.contactPrimaryInfo) {
<a name="l01261"></a>01261             <span class="keyword">delete</span> group.contactPrimaryInfo;
<a name="l01262"></a>01262           }
<a name="l01263"></a>01263           <span class="keywordflow">if</span> (group.contactMatchingTelType) {
<a name="l01264"></a>01264             <span class="keyword">delete</span> group.contactMatchingTelType;
<a name="l01265"></a>01265           }
<a name="l01266"></a>01266           <span class="keywordflow">if</span> (group.contactMatchingTelCarrier) {
<a name="l01267"></a>01267             <span class="keyword">delete</span> group.contactMatchingTelCarrier;
<a name="l01268"></a>01268           }
<a name="l01269"></a>01269           <span class="keywordflow">if</span> (group.contactPhoto) {
<a name="l01270"></a>01270             <span class="keyword">delete</span> group.contactPhoto;
<a name="l01271"></a>01271           }
<a name="l01272"></a>01272           cursor.update(group);
<a name="l01273"></a>01273           count++;
<a name="l01274"></a>01274           cursor.continue();
<a name="l01275"></a>01275         } <span class="keywordflow">else</span> {
<a name="l01276"></a>01276           <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, count);
<a name="l01277"></a>01277           <span class="keyword">self</span>._updateCacheRevision();
<a name="l01278"></a>01278         }
<a name="l01279"></a>01279       };
<a name="l01280"></a>01280       req.onerror = <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01281"></a>01281         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.target.error.name);
<a name="l01282"></a>01282       };
<a name="l01283"></a>01283     });
<a name="l01284"></a>01284   },
<a name="l01285"></a>01285   invalidateContactsCache: <span class="keyword">function</span> invalidateContactsCache(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01286"></a>01286     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01287"></a>01287     var waitForAsyncCall = 0;
<a name="l01288"></a>01288     var cursorDone = <span class="keyword">false</span>;
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     <span class="keyword">function</span> onContactsUpdated() {
<a name="l01291"></a>01291       <span class="keywordflow">if</span> (!cursorDone || waitForAsyncCall) {
<a name="l01292"></a>01292         <span class="keywordflow">return</span>;
<a name="l01293"></a>01293       }
<a name="l01294"></a>01294       <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01295"></a>01295       <span class="keyword">self</span>._updateCacheRevision();
<a name="l01296"></a>01296     }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298     this._newTxn(<span class="stringliteral">&#39;readonly&#39;</span>, [this._dbGroupsStore],
<a name="l01299"></a>01299                   <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l01300"></a>01300       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l01301"></a>01301         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l01302"></a>01302         <span class="keywordflow">return</span>;
<a name="l01303"></a>01303       }
<a name="l01304"></a>01304 
<a name="l01305"></a>01305       var req = store.openCursor();
<a name="l01306"></a>01306       req.onsuccess = <span class="keyword">function</span> <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01307"></a>01307         var cursor = <span class="keyword">event</span>.target.result;
<a name="l01308"></a>01308         <span class="keywordflow">if</span> (!cursor) {
<a name="l01309"></a>01309           cursorDone = <span class="keyword">true</span>;
<a name="l01310"></a>01310           onContactsUpdated();
<a name="l01311"></a>01311           <span class="keywordflow">return</span>;
<a name="l01312"></a>01312         }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314         var group = cursor.value;
<a name="l01315"></a>01315         waitForAsyncCall++;
<a name="l01316"></a>01316         <a class="code" href="../../d7/d68/apps_2communications_2contacts_2js_2contacts_8js.html#a55257a4a6c5aab93045fd427504a1c95">Contacts</a>.findByNumber(group.number, <span class="keyword">function</span>(contact, matchingTel) {
<a name="l01317"></a>01317           <span class="comment">// We don&#39;t want to queue db transactions that won&#39;t update</span>
<a name="l01318"></a>01318           <span class="comment">// anything.</span>
<a name="l01319"></a>01319           var needsUpdate = <span class="keyword">false</span>;
<a name="l01320"></a>01320           <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (!contact &amp;&amp; !matchingTel) {
<a name="l01321"></a>01321             <span class="keywordflow">if</span> (group.contactId) {
<a name="l01322"></a>01322               needsUpdate = <span class="keyword">true</span>;
<a name="l01323"></a>01323               <span class="keyword">delete</span> group.contactId;
<a name="l01324"></a>01324             }
<a name="l01325"></a>01325             <span class="keywordflow">if</span> (group.contactPhoto) {
<a name="l01326"></a>01326               needsUpdate = <span class="keyword">true</span>;
<a name="l01327"></a>01327               <span class="keyword">delete</span> group.contactPhoto;
<a name="l01328"></a>01328             }
<a name="l01329"></a>01329             <span class="keywordflow">if</span> (group.contactPrimaryInfo) {
<a name="l01330"></a>01330               needsUpdate = <span class="keyword">true</span>;
<a name="l01331"></a>01331               <span class="keyword">delete</span> group.contactPrimaryInfo;
<a name="l01332"></a>01332             }
<a name="l01333"></a>01333             <span class="keywordflow">if</span> (group.contactMatchingTelType) {
<a name="l01334"></a>01334               needsUpdate = <span class="keyword">true</span>;
<a name="l01335"></a>01335               <span class="keyword">delete</span> group.contactMatchingTelType;
<a name="l01336"></a>01336             }
<a name="l01337"></a>01337             <span class="keywordflow">if</span> (group.contactMatchingTelCarrier) {
<a name="l01338"></a>01338               needsUpdate = <span class="keyword">true</span>;
<a name="l01339"></a>01339               <span class="keyword">delete</span> group.contactMatchingTelCarrier;
<a name="l01340"></a>01340             }
<a name="l01341"></a>01341           } <span class="keywordflow">else</span> {
<a name="l01342"></a>01342             group.contactId = contact.id;
<a name="l01343"></a>01343             <span class="keywordflow">if</span> (Array.isArray(contact.photo) &amp;&amp; contact.photo[0] &amp;&amp;
<a name="l01344"></a>01344                 group.contactPhoto != contact.photo[0]) {
<a name="l01345"></a>01345               group.contactPhoto = contact.photo[0];
<a name="l01346"></a>01346               needsUpdate = <span class="keyword">true</span>;
<a name="l01347"></a>01347             }
<a name="l01348"></a>01348             var primaryInfo = <a class="code" href="../../d1/db7/apps_2communications_2dialer_2js_2utils_8js.html#af21ebfdaa2ee891fa5788a82b2e2586c">Utils</a>.getPhoneNumberPrimaryInfo(matchingTel,
<a name="l01349"></a>01349                                                               contact);
<a name="l01350"></a>01350             <span class="keywordflow">if</span> (Array.isArray(primaryInfo) &amp;&amp; primaryInfo[0]) {
<a name="l01351"></a>01351               primaryInfo = primaryInfo[0];
<a name="l01352"></a>01352             }
<a name="l01353"></a>01353             <span class="keywordflow">if</span> (group.contactPrimaryInfo != String(primaryInfo)) {
<a name="l01354"></a>01354               group.contactPrimaryInfo = String(primaryInfo);
<a name="l01355"></a>01355               needsUpdate = <span class="keyword">true</span>;
<a name="l01356"></a>01356             }
<a name="l01357"></a>01357             <span class="keywordflow">if</span> (Array.isArray(matchingTel.type) &amp;&amp; matchingTel.type[0] &amp;&amp;
<a name="l01358"></a>01358                 group.contactMatchingTelType != String(matchingTel.type[0])) {
<a name="l01359"></a>01359               group.contactMatchingTelType = String(matchingTel.type[0]);
<a name="l01360"></a>01360               needsUpdate = <span class="keyword">true</span>;
<a name="l01361"></a>01361             }
<a name="l01362"></a>01362             <span class="keywordflow">if</span> (matchingTel.carrier &amp;&amp; group.contactMatchingTelCarrier !=
<a name="l01363"></a>01363                 String(matchingTel.carrier)) {
<a name="l01364"></a>01364               group.contactMatchingTelCarrier = String(matchingTel.carrier);
<a name="l01365"></a>01365               needsUpdate = <span class="keyword">true</span>;
<a name="l01366"></a>01366             }
<a name="l01367"></a>01367           }
<a name="l01368"></a>01368 
<a name="l01369"></a>01369           <span class="keywordflow">if</span> (needsUpdate) {
<a name="l01370"></a>01370             <span class="keyword">self</span>._newTxn(<span class="stringliteral">&#39;readwrite&#39;</span>, [<span class="keyword">self</span>._dbGroupsStore],
<a name="l01371"></a>01371                          <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, txn, store) {
<a name="l01372"></a>01372               <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l01373"></a>01373                 <span class="keywordflow">return</span>;
<a name="l01374"></a>01374               }
<a name="l01375"></a>01375               store.put(group).onsuccess = <span class="keyword">function</span>() {
<a name="l01376"></a>01376                 waitForAsyncCall--;
<a name="l01377"></a>01377                 onContactsUpdated();
<a name="l01378"></a>01378               };
<a name="l01379"></a>01379             });
<a name="l01380"></a>01380           } <span class="keywordflow">else</span> {
<a name="l01381"></a>01381             waitForAsyncCall--;
<a name="l01382"></a>01382             onContactsUpdated();
<a name="l01383"></a>01383           }
<a name="l01384"></a>01384         });
<a name="l01385"></a>01385         cursor.continue();
<a name="l01386"></a>01386       };
<a name="l01387"></a>01387       req.onerror = <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l01388"></a>01388         <span class="keyword">self</span>._asyncReturn(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.target.error.name);
<a name="l01389"></a>01389       };
<a name="l01390"></a>01390     });
<a name="l01391"></a>01391   }
<a name="l01392"></a>01392 };
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../dc/d75/call__log__db_8js.html">call_log_db.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:51:09に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
