<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: jskanji.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('dc/d5f/jskanji_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">jskanji.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../dc/d5f/jskanji_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="../../dc/d5f/jskanji_8js.html#ae2475e10618961c050dcba04e8c42331">00001</a> <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 (<span class="keyword">function</span>() {
<a name="l00004"></a>00004 
<a name="l00005"></a>00005   var MAX_FREQUENCY = 10000;
<a name="l00006"></a>00006 
<a name="l00007"></a>00007   var IMELayouts = {
<a name="l00008"></a>00008     <span class="stringliteral">&#39;EN&#39;</span>: <span class="stringliteral">&#39;jp-kanji-en&#39;</span>,
<a name="l00009"></a>00009     <span class="stringliteral">&#39;EN-CAPS&#39;</span>: <span class="stringliteral">&#39;jp-kanji-en-caps&#39;</span>,
<a name="l00010"></a>00010     <span class="stringliteral">&#39;JP&#39;</span>: <span class="stringliteral">&#39;jp-kanji&#39;</span>,
<a name="l00011"></a>00011     <span class="stringliteral">&#39;NUM&#39;</span>: <span class="stringliteral">&#39;jp-kanji-number&#39;</span>
<a name="l00012"></a>00012   };
<a name="l00013"></a>00013 
<a name="l00014"></a>00014   <span class="comment">// IME special key code map</span>
<a name="l00015"></a>00015   <span class="comment">// see `layout.js`</span>
<a name="l00016"></a>00016   var IMESpecialKey = {
<a name="l00017"></a>00017     BACK: -10,
<a name="l00018"></a>00018     PREVIOUS: -11,
<a name="l00019"></a>00019     NEXT: -12,
<a name="l00020"></a>00020     MARK: -13,
<a name="l00021"></a>00021     TRANSFORM: -14,
<a name="l00022"></a>00022     CASE_CHANGE: -16,
<a name="l00023"></a>00023     FULL: -17,
<a name="l00024"></a>00024     H2K: -18,
<a name="l00025"></a>00025     CAPSLOCK: -19,
<a name="l00026"></a>00026     EN_LAYOUT: -20,
<a name="l00027"></a>00027     NUM_LAYOUT: -21,
<a name="l00028"></a>00028     <a class="code" href="../../d1/dbd/apps_2keyboard_2js_2keyboard_8js.html#ace4e053c84f8dbad969823dbde2495cf">BASIC_LAYOUT</a>: -22
<a name="l00029"></a>00029   };
<a name="l00030"></a>00030 
<a name="l00031"></a>00031   <span class="comment">// Keyboard mode mapping</span>
<a name="l00032"></a>00032   <span class="comment">// FIXME partly used, maybe remove used</span>
<a name="l00033"></a>00033   var IMEMode = {
<a name="l00034"></a>00034       FULL_HIRAGANA: 0,
<a name="l00035"></a>00035       FULL_KATAKANA: 1,
<a name="l00036"></a>00036       FULL_ALPHABET: 2,
<a name="l00037"></a>00037       FULL_NUMBER: 3,
<a name="l00038"></a>00038       HALF_NUMBER: 4,
<a name="l00039"></a>00039       HALF_ALPHABET: 5,
<a name="l00040"></a>00040       HALF_KATAKANA: 6
<a name="l00041"></a>00041   };
<a name="l00042"></a>00042 
<a name="l00043"></a>00043   var IMEKeyMap = {
<a name="l00044"></a>00044     <span class="stringliteral">&#39;あ&#39;</span>: 0, <span class="stringliteral">&#39;か&#39;</span>: 1, <span class="stringliteral">&#39;さ&#39;</span>: 2, <span class="stringliteral">&#39;た&#39;</span>: 3, <span class="stringliteral">&#39;な&#39;</span>: 4, <span class="stringliteral">&#39;は&#39;</span>: 5, <span class="stringliteral">&#39;ま&#39;</span>: 6,
<a name="l00045"></a>00045     <span class="stringliteral">&#39;や&#39;</span>: 7, <span class="stringliteral">&#39;ら&#39;</span>: 8, <span class="stringliteral">&#39;わ&#39;</span>: 9, <span class="stringliteral">&#39;、&#39;</span>: 10,
<a name="l00046"></a>00046     <span class="stringliteral">&#39;ア&#39;</span>: 0, <span class="stringliteral">&#39;カ&#39;</span>: 1, <span class="stringliteral">&#39;サ&#39;</span>: 2, <span class="stringliteral">&#39;タ&#39;</span>: 3, <span class="stringliteral">&#39;ナ&#39;</span>: 4, <span class="stringliteral">&#39;ハ&#39;</span>: 5, <span class="stringliteral">&#39;マ&#39;</span>: 6,
<a name="l00047"></a>00047     <span class="stringliteral">&#39;ヤ&#39;</span>: 7, <span class="stringliteral">&#39;ラ&#39;</span>: 8, <span class="stringliteral">&#39;ワ&#39;</span>: 9,
<a name="l00048"></a>00048     <span class="stringliteral">&#39;ｱ&#39;</span>: 0, <span class="stringliteral">&#39;ｶ&#39;</span>: 1, <span class="stringliteral">&#39;ｻ&#39;</span>: 2, <span class="stringliteral">&#39;ﾀ&#39;</span>: 3, <span class="stringliteral">&#39;ﾅ&#39;</span>: 4, <span class="stringliteral">&#39;ﾊ&#39;</span>: 5, <span class="stringliteral">&#39;ﾏ&#39;</span>: 6, <span class="stringliteral">&#39;ﾔ&#39;</span>: 7,
<a name="l00049"></a>00049     <span class="stringliteral">&#39;ﾗ&#39;</span>: 8, <span class="stringliteral">&#39;ﾜ&#39;</span>: 9, <span class="stringliteral">&#39;､&#39;</span>: 10
<a name="l00050"></a>00050   };
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053   var IMEHalfWidthCharactorCandidateList = [
<a name="l00054"></a>00054     <span class="charliteral">&#39;!&#39;</span>, <span class="stringliteral">&#39;“&#39;</span>, <span class="charliteral">&#39;$&#39;</span>, <span class="charliteral">&#39;%&#39;</span>, <span class="stringliteral">&#39;&amp;amp;&#39;</span>, <span class="stringliteral">&quot;&#39;&quot;</span>, <span class="charliteral">&#39;(&#39;</span>, <span class="charliteral">&#39;)&#39;</span>, <span class="charliteral">&#39;*&#39;</span>, <span class="charliteral">&#39;+&#39;</span>, <span class="charliteral">&#39;,&#39;</span>, <span class="charliteral">&#39;-&#39;</span>,
<a name="l00055"></a>00055     <span class="charliteral">&#39;.&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, <span class="charliteral">&#39;:&#39;</span>, <span class="charliteral">&#39;;&#39;</span>, <span class="stringliteral">&#39;&amp;lt&#39;</span>, <span class="charliteral">&#39;=&#39;</span>, <span class="charliteral">&#39;&gt;&#39;</span>, <span class="charliteral">&#39;?&#39;</span>, <span class="charliteral">&#39;@&#39;</span>, <span class="charliteral">&#39;[&#39;</span>, <span class="charliteral">&#39;\\&#39;</span>, <span class="charliteral">&#39;]&#39;</span>,
<a name="l00056"></a>00056     <span class="charliteral">&#39;^&#39;</span>, <span class="charliteral">&#39;_&#39;</span>, <span class="charliteral">&#39;`&#39;</span>, <span class="charliteral">&#39;{&#39;</span>, <span class="charliteral">&#39;|&#39;</span>, <span class="charliteral">&#39;}&#39;</span>, <span class="charliteral">&#39;~&#39;</span>
<a name="l00057"></a>00057   ];
<a name="l00058"></a>00058 
<a name="l00059"></a>00059   var IMEFullWidthCharactorCandidateList = [
<a name="l00060"></a>00060     <span class="stringliteral">&#39;、&#39;</span>, <span class="stringliteral">&#39;。&#39;</span>, <span class="stringliteral">&#39;，&#39;</span>, <span class="stringliteral">&#39;．&#39;</span>, <span class="stringliteral">&#39;・&#39;</span>, <span class="stringliteral">&#39;：&#39;</span>, <span class="stringliteral">&#39;；&#39;</span>, <span class="stringliteral">&#39;？&#39;</span>, <span class="stringliteral">&#39;！&#39;</span>, <span class="stringliteral">&#39;゛&#39;</span>,
<a name="l00061"></a>00061     <span class="stringliteral">&#39;゜&#39;</span>, <span class="stringliteral">&#39;´&#39;</span>, <span class="stringliteral">&#39;｀&#39;</span>, <span class="stringliteral">&#39;¨&#39;</span>, <span class="stringliteral">&#39;＾&#39;</span>, <span class="stringliteral">&#39;￣&#39;</span>, <span class="stringliteral">&#39;＿&#39;</span>, <span class="stringliteral">&#39;ヽ&#39;</span>, <span class="stringliteral">&#39;ヾ&#39;</span>, <span class="stringliteral">&#39;ゝ&#39;</span>,
<a name="l00062"></a>00062     <span class="stringliteral">&#39;ゞ&#39;</span>, <span class="stringliteral">&#39;〃&#39;</span>, <span class="stringliteral">&#39;仝&#39;</span>, <span class="stringliteral">&#39;々&#39;</span>, <span class="stringliteral">&#39;〆&#39;</span>, <span class="stringliteral">&#39;〇&#39;</span>, <span class="stringliteral">&#39;ー&#39;</span>, <span class="stringliteral">&#39;―&#39;</span>, <span class="stringliteral">&#39;‐&#39;</span>, <span class="stringliteral">&#39;／&#39;</span>,
<a name="l00063"></a>00063     <span class="stringliteral">&#39;＼&#39;</span>, <span class="stringliteral">&#39;～&#39;</span>, <span class="stringliteral">&#39;∥&#39;</span>, <span class="stringliteral">&#39;｜&#39;</span>, <span class="stringliteral">&#39;…&#39;</span>, <span class="stringliteral">&#39;‥&#39;</span>, <span class="stringliteral">&#39;‘&#39;</span>, <span class="stringliteral">&#39;’&#39;</span>, <span class="stringliteral">&#39;“&#39;</span>, <span class="stringliteral">&#39;”&#39;</span>,
<a name="l00064"></a>00064     <span class="stringliteral">&#39;（&#39;</span>, <span class="stringliteral">&#39;）&#39;</span>, <span class="stringliteral">&#39;〔&#39;</span>, <span class="stringliteral">&#39;〕&#39;</span>, <span class="stringliteral">&#39;［&#39;</span>, <span class="stringliteral">&#39;］&#39;</span>, <span class="stringliteral">&#39;｛&#39;</span>, <span class="stringliteral">&#39;｝&#39;</span>, <span class="stringliteral">&#39;〈&#39;</span>, <span class="stringliteral">&#39;〉&#39;</span>,
<a name="l00065"></a>00065     <span class="stringliteral">&#39;《&#39;</span>, <span class="stringliteral">&#39;》&#39;</span>, <span class="stringliteral">&#39;「&#39;</span>, <span class="stringliteral">&#39;」&#39;</span>, <span class="stringliteral">&#39;『&#39;</span>, <span class="stringliteral">&#39;』&#39;</span>, <span class="stringliteral">&#39;【&#39;</span>, <span class="stringliteral">&#39;】&#39;</span>, <span class="stringliteral">&#39;＋&#39;</span>, <span class="stringliteral">&#39;－&#39;</span>,
<a name="l00066"></a>00066     <span class="stringliteral">&#39;±&#39;</span>, <span class="stringliteral">&#39;×&#39;</span>, <span class="stringliteral">&#39;÷&#39;</span>, <span class="stringliteral">&#39;＝&#39;</span>, <span class="stringliteral">&#39;≠&#39;</span>, <span class="stringliteral">&#39;＜&#39;</span>, <span class="stringliteral">&#39;＞&#39;</span>, <span class="stringliteral">&#39;≦&#39;</span>, <span class="stringliteral">&#39;≧&#39;</span>, <span class="stringliteral">&#39;∞&#39;</span>,
<a name="l00067"></a>00067     <span class="stringliteral">&#39;∴&#39;</span>, <span class="stringliteral">&#39;♂&#39;</span>, <span class="stringliteral">&#39;♀&#39;</span>, <span class="stringliteral">&#39;∈&#39;</span>, <span class="stringliteral">&#39;∋&#39;</span>, <span class="stringliteral">&#39;⊆&#39;</span>, <span class="stringliteral">&#39;⊇&#39;</span>, <span class="stringliteral">&#39;⊂&#39;</span>, <span class="stringliteral">&#39;⊃&#39;</span>, <span class="stringliteral">&#39;∪&#39;</span>,
<a name="l00068"></a>00068     <span class="stringliteral">&#39;∩&#39;</span>, <span class="stringliteral">&#39;∧&#39;</span>, <span class="stringliteral">&#39;∨&#39;</span>, <span class="stringliteral">&#39;￢&#39;</span>, <span class="stringliteral">&#39;⇒&#39;</span>, <span class="stringliteral">&#39;⇔&#39;</span>, <span class="stringliteral">&#39;∀&#39;</span>, <span class="stringliteral">&#39;∃&#39;</span>, <span class="stringliteral">&#39;∠&#39;</span>, <span class="stringliteral">&#39;⊥&#39;</span>,
<a name="l00069"></a>00069     <span class="stringliteral">&#39;⌒&#39;</span>, <span class="stringliteral">&#39;∂&#39;</span>, <span class="stringliteral">&#39;∇&#39;</span>, <span class="stringliteral">&#39;≡&#39;</span>, <span class="stringliteral">&#39;≒&#39;</span>, <span class="stringliteral">&#39;≪&#39;</span>, <span class="stringliteral">&#39;≫&#39;</span>, <span class="stringliteral">&#39;√&#39;</span>, <span class="stringliteral">&#39;∽&#39;</span>, <span class="stringliteral">&#39;∝&#39;</span>,
<a name="l00070"></a>00070     <span class="stringliteral">&#39;∵&#39;</span>, <span class="stringliteral">&#39;∫&#39;</span>, <span class="stringliteral">&#39;∬&#39;</span>, <span class="stringliteral">&#39;Å&#39;</span>, <span class="stringliteral">&#39;‰&#39;</span>, <span class="stringliteral">&#39;°&#39;</span>, <span class="stringliteral">&#39;′&#39;</span>, <span class="stringliteral">&#39;″&#39;</span>, <span class="stringliteral">&#39;℃&#39;</span>, <span class="stringliteral">&#39;￥&#39;</span>,
<a name="l00071"></a>00071     <span class="stringliteral">&#39;＄&#39;</span>, <span class="stringliteral">&#39;￠&#39;</span>, <span class="stringliteral">&#39;￡&#39;</span>, <span class="stringliteral">&#39;％&#39;</span>, <span class="stringliteral">&#39;＃&#39;</span>, <span class="stringliteral">&#39;＆&#39;</span>, <span class="stringliteral">&#39;＊&#39;</span>, <span class="stringliteral">&#39;＠&#39;</span>, <span class="stringliteral">&#39;§&#39;</span>, <span class="stringliteral">&#39;☆&#39;</span>,
<a name="l00072"></a>00072     <span class="stringliteral">&#39;★&#39;</span>, <span class="stringliteral">&#39;○&#39;</span>, <span class="stringliteral">&#39;●&#39;</span>, <span class="stringliteral">&#39;◎&#39;</span>, <span class="stringliteral">&#39;◇&#39;</span>, <span class="stringliteral">&#39;◆&#39;</span>, <span class="stringliteral">&#39;□&#39;</span>, <span class="stringliteral">&#39;■&#39;</span>, <span class="stringliteral">&#39;△&#39;</span>, <span class="stringliteral">&#39;▲&#39;</span>,
<a name="l00073"></a>00073     <span class="stringliteral">&#39;▽&#39;</span>, <span class="stringliteral">&#39;▼&#39;</span>, <span class="stringliteral">&#39;※&#39;</span>, <span class="stringliteral">&#39;〒&#39;</span>, <span class="stringliteral">&#39;→&#39;</span>, <span class="stringliteral">&#39;←&#39;</span>, <span class="stringliteral">&#39;↑&#39;</span>, <span class="stringliteral">&#39;↓&#39;</span>, <span class="stringliteral">&#39;〓&#39;</span>, <span class="stringliteral">&#39;♯&#39;</span>,
<a name="l00074"></a>00074     <span class="stringliteral">&#39;♭&#39;</span>, <span class="stringliteral">&#39;♪&#39;</span>, <span class="stringliteral">&#39;†&#39;</span>, <span class="stringliteral">&#39;‡&#39;</span>, <span class="stringliteral">&#39;¶&#39;</span>, <span class="stringliteral">&#39;◯&#39;</span>, <span class="stringliteral">&#39;─&#39;</span>, <span class="stringliteral">&#39;╂&#39;</span>, <span class="stringliteral">&#39;①&#39;</span>, <span class="stringliteral">&#39;②&#39;</span>,
<a name="l00075"></a>00075     <span class="stringliteral">&#39;③&#39;</span>, <span class="stringliteral">&#39;④&#39;</span>, <span class="stringliteral">&#39;⑤&#39;</span>, <span class="stringliteral">&#39;⑥&#39;</span>, <span class="stringliteral">&#39;⑦&#39;</span>, <span class="stringliteral">&#39;⑧&#39;</span>, <span class="stringliteral">&#39;⑨&#39;</span>, <span class="stringliteral">&#39;⑩&#39;</span>, <span class="stringliteral">&#39;⑪&#39;</span>, <span class="stringliteral">&#39;⑫&#39;</span>,
<a name="l00076"></a>00076     <span class="stringliteral">&#39;⑬&#39;</span>, <span class="stringliteral">&#39;⑭&#39;</span>, <span class="stringliteral">&#39;⑮&#39;</span>, <span class="stringliteral">&#39;⑯&#39;</span>, <span class="stringliteral">&#39;⑰&#39;</span>, <span class="stringliteral">&#39;⑱&#39;</span>, <span class="stringliteral">&#39;⑲&#39;</span>, <span class="stringliteral">&#39;⑳&#39;</span>, <span class="stringliteral">&#39;Ⅰ&#39;</span>, <span class="stringliteral">&#39;Ⅱ&#39;</span>,
<a name="l00077"></a>00077     <span class="stringliteral">&#39;Ⅲ&#39;</span>, <span class="stringliteral">&#39;Ⅳ&#39;</span>, <span class="stringliteral">&#39;Ⅴ&#39;</span>, <span class="stringliteral">&#39;Ⅵ&#39;</span>, <span class="stringliteral">&#39;Ⅶ&#39;</span>, <span class="stringliteral">&#39;Ⅷ&#39;</span>, <span class="stringliteral">&#39;Ⅸ&#39;</span>, <span class="stringliteral">&#39;Ⅹ&#39;</span>, <span class="stringliteral">&#39;㍉&#39;</span>, <span class="stringliteral">&#39;㌔&#39;</span>,
<a name="l00078"></a>00078     <span class="stringliteral">&#39;㌢&#39;</span>, <span class="stringliteral">&#39;㍍&#39;</span>, <span class="stringliteral">&#39;㌘&#39;</span>, <span class="stringliteral">&#39;㌧&#39;</span>, <span class="stringliteral">&#39;㌃&#39;</span>, <span class="stringliteral">&#39;㌶&#39;</span>, <span class="stringliteral">&#39;㍑&#39;</span>, <span class="stringliteral">&#39;㍗&#39;</span>, <span class="stringliteral">&#39;㌍&#39;</span>, <span class="stringliteral">&#39;㌦&#39;</span>,
<a name="l00079"></a>00079     <span class="stringliteral">&#39;㌣&#39;</span>, <span class="stringliteral">&#39;㌫&#39;</span>, <span class="stringliteral">&#39;㍊&#39;</span>, <span class="stringliteral">&#39;㌻&#39;</span>, <span class="stringliteral">&#39;㎜&#39;</span>, <span class="stringliteral">&#39;㎝&#39;</span>, <span class="stringliteral">&#39;㎞&#39;</span>, <span class="stringliteral">&#39;㎎&#39;</span>, <span class="stringliteral">&#39;㎏&#39;</span>, <span class="stringliteral">&#39;㏄&#39;</span>,
<a name="l00080"></a>00080     <span class="stringliteral">&#39;㎡&#39;</span>, <span class="stringliteral">&#39;㍻&#39;</span>, <span class="stringliteral">&#39;〝&#39;</span>, <span class="stringliteral">&#39;〟&#39;</span>, <span class="stringliteral">&#39;№&#39;</span>, <span class="stringliteral">&#39;㏍&#39;</span>, <span class="stringliteral">&#39;℡&#39;</span>, <span class="stringliteral">&#39;㊤&#39;</span>, <span class="stringliteral">&#39;㊥&#39;</span>, <span class="stringliteral">&#39;㊦&#39;</span>,
<a name="l00081"></a>00081     <span class="stringliteral">&#39;㊧&#39;</span>, <span class="stringliteral">&#39;㊨&#39;</span>, <span class="stringliteral">&#39;㈱&#39;</span>, <span class="stringliteral">&#39;㈲&#39;</span>, <span class="stringliteral">&#39;㈹&#39;</span>, <span class="stringliteral">&#39;㍾&#39;</span>, <span class="stringliteral">&#39;㍽&#39;</span>, <span class="stringliteral">&#39;㍼&#39;</span>, <span class="stringliteral">&#39;≒&#39;</span>, <span class="stringliteral">&#39;≡&#39;</span>,
<a name="l00082"></a>00082     <span class="stringliteral">&#39;∫&#39;</span>, <span class="stringliteral">&#39;∮&#39;</span>, <span class="stringliteral">&#39;∑&#39;</span>, <span class="stringliteral">&#39;√&#39;</span>, <span class="stringliteral">&#39;⊥&#39;</span>, <span class="stringliteral">&#39;∠&#39;</span>, <span class="stringliteral">&#39;∟&#39;</span>, <span class="stringliteral">&#39;⊿&#39;</span>, <span class="stringliteral">&#39;∵&#39;</span>, <span class="stringliteral">&#39;∩&#39;</span>, <span class="stringliteral">&#39;∪&#39;</span>
<a name="l00083"></a>00083   ];
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   <span class="comment">// not used by now</span>
<a name="l00086"></a>00086   <span class="comment">// Uncomment this if half-width and full-width alphabet transformation</span>
<a name="l00087"></a>00087   <span class="comment">// is needed</span>
<a name="l00088"></a>00088   <span class="comment">/*var IMEAlphabetTable = {</span>
<a name="l00089"></a>00089 <span class="comment">    &#39;A&#39;: &#39;Ａ&#39;, &#39;B&#39;: &#39;Ｂ&#39;, &#39;C&#39;: &#39;Ｃ&#39;, &#39;D&#39;: &#39;Ｄ&#39;, &#39;E&#39;: &#39;Ｅ&#39;, &#39;F&#39;: &#39;Ｆ&#39;,</span>
<a name="l00090"></a>00090 <span class="comment">    &#39;G&#39;: &#39;Ｇ&#39;, &#39;H&#39;: &#39;Ｈ&#39;, &#39;I&#39;: &#39;Ｉ&#39;, &#39;J&#39;: &#39;Ｊ&#39;, &#39;K&#39;: &#39;Ｋ&#39;, &#39;L&#39;: &#39;Ｌ&#39;,</span>
<a name="l00091"></a>00091 <span class="comment">    &#39;M&#39;: &#39;Ｍ&#39;, &#39;N&#39;: &#39;Ｎ&#39;, &#39;O&#39;: &#39;Ｏ&#39;, &#39;P&#39;: &#39;Ｐ&#39;, &#39;Q&#39;: &#39;Ｑ&#39;, &#39;R&#39;: &#39;Ｒ&#39;,</span>
<a name="l00092"></a>00092 <span class="comment">    &#39;S&#39;: &#39;Ｓ&#39;, &#39;T&#39;: &#39;Ｔ&#39;, &#39;U&#39;: &#39;Ｕ&#39;, &#39;V&#39;: &#39;Ｖ&#39;, &#39;W&#39;: &#39;Ｗ&#39;, &#39;X&#39;: &#39;Ｘ&#39;,</span>
<a name="l00093"></a>00093 <span class="comment">    &#39;Y&#39;: &#39;Ｙ&#39;, &#39;Z&#39;: &#39;Ｚ&#39;, &#39;Ａ&#39;: &#39;A&#39;, &#39;Ｂ&#39;: &#39;B&#39;, &#39;Ｃ&#39;: &#39;C&#39;, &#39;Ｄ&#39;: &#39;D&#39;,</span>
<a name="l00094"></a>00094 <span class="comment">    &#39;Ｅ&#39;: &#39;E&#39;, &#39;Ｆ&#39;: &#39;F&#39;, &#39;Ｇ&#39;: &#39;G&#39;, &#39;Ｈ&#39;: &#39;H&#39;, &#39;Ｉ&#39;: &#39;I&#39;, &#39;Ｊ&#39;: &#39;J&#39;,</span>
<a name="l00095"></a>00095 <span class="comment">    &#39;Ｋ&#39;: &#39;K&#39;, &#39;Ｌ&#39;: &#39;L&#39;, &#39;Ｍ&#39;: &#39;M&#39;, &#39;Ｎ&#39;: &#39;N&#39;, &#39;Ｏ&#39;: &#39;O&#39;, &#39;Ｐ&#39;: &#39;P&#39;,</span>
<a name="l00096"></a>00096 <span class="comment">    &#39;Ｑ&#39;: &#39;Q&#39;, &#39;Ｒ&#39;: &#39;R&#39;, &#39;Ｓ&#39;: &#39;S&#39;, &#39;Ｔ&#39;: &#39;T&#39;, &#39;Ｕ&#39;: &#39;U&#39;, &#39;Ｖ&#39;: &#39;V&#39;,</span>
<a name="l00097"></a>00097 <span class="comment">    &#39;Ｗ&#39;: &#39;W&#39;, &#39;Ｘ&#39;: &#39;X&#39;, &#39;Ｙ&#39;: &#39;Y&#39;, &#39;Ｚ&#39;: &#39;Z&#39;,</span>
<a name="l00098"></a>00098 <span class="comment">    &#39;a&#39;: &#39;ａ&#39;, &#39;b&#39;: &#39;ｂ&#39;, &#39;c&#39;: &#39;ｃ&#39;, &#39;d&#39;: &#39;ｄ&#39;, &#39;e&#39;: &#39;ｅ&#39;, &#39;f&#39;: &#39;ｆ&#39;,</span>
<a name="l00099"></a>00099 <span class="comment">    &#39;g&#39;: &#39;ｇ&#39;, &#39;h&#39;: &#39;ｈ&#39;, &#39;i&#39;: &#39;ｉ&#39;, &#39;j&#39;: &#39;ｊ&#39;, &#39;k&#39;: &#39;ｋ&#39;, &#39;l&#39;: &#39;ｌ&#39;,</span>
<a name="l00100"></a>00100 <span class="comment">    &#39;m&#39;: &#39;ｍ&#39;, &#39;n&#39;: &#39;ｎ&#39;, &#39;o&#39;: &#39;ｏ&#39;, &#39;p&#39;: &#39;ｐ&#39;, &#39;q&#39;: &#39;ｑ&#39;, &#39;r&#39;: &#39;ｒ&#39;,</span>
<a name="l00101"></a>00101 <span class="comment">    &#39;s&#39;: &#39;ｓ&#39;, &#39;t&#39;: &#39;ｔ&#39;, &#39;u&#39;: &#39;ｕ&#39;, &#39;v&#39;: &#39;ｖ&#39;, &#39;w&#39;: &#39;ｗ&#39;, &#39;x&#39;: &#39;ｘ&#39;,</span>
<a name="l00102"></a>00102 <span class="comment">    &#39;y&#39;: &#39;ｙ&#39;, &#39;z&#39;: &#39;ｚ&#39;, &#39;ａ&#39;: &#39;a&#39;, &#39;ｂ&#39;: &#39;b&#39;, &#39;ｃ&#39;: &#39;c&#39;, &#39;ｄ&#39;: &#39;d&#39;,</span>
<a name="l00103"></a>00103 <span class="comment">    &#39;ｅ&#39;: &#39;e&#39;, &#39;ｆ&#39;: &#39;f&#39;, &#39;ｇ&#39;: &#39;g&#39;, &#39;ｈ&#39;: &#39;h&#39;, &#39;ｉ&#39;: &#39;i&#39;, &#39;ｊ&#39;: &#39;j&#39;,</span>
<a name="l00104"></a>00104 <span class="comment">    &#39;ｋ&#39;: &#39;k&#39;, &#39;ｌ&#39;: &#39;l&#39;, &#39;ｍ&#39;: &#39;m&#39;, &#39;ｎ&#39;: &#39;n&#39;, &#39;ｏ&#39;: &#39;o&#39;, &#39;ｐ&#39;: &#39;p&#39;,</span>
<a name="l00105"></a>00105 <span class="comment">    &#39;ｑ&#39;: &#39;q&#39;, &#39;ｒ&#39;: &#39;r&#39;, &#39;ｓ&#39;: &#39;s&#39;, &#39;ｔ&#39;: &#39;t&#39;, &#39;ｕ&#39;: &#39;u&#39;, &#39;ｖ&#39;: &#39;v&#39;,</span>
<a name="l00106"></a>00106 <span class="comment">    &#39;ｗ&#39;: &#39;w&#39;, &#39;ｘ&#39;: &#39;x&#39;, &#39;ｙ&#39;: &#39;y&#39;, &#39;ｚ&#39;: &#39;z&#39;</span>
<a name="l00107"></a>00107 <span class="comment">  };*/</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   var IMENumberTable = {
<a name="l00110"></a>00110     <span class="charliteral">&#39;1&#39;</span>: <span class="stringliteral">&#39;１&#39;</span>, <span class="charliteral">&#39;2&#39;</span>: <span class="stringliteral">&#39;２&#39;</span>, <span class="charliteral">&#39;3&#39;</span>: <span class="stringliteral">&#39;３&#39;</span>, <span class="charliteral">&#39;4&#39;</span>: <span class="stringliteral">&#39;４&#39;</span>, <span class="charliteral">&#39;5&#39;</span>: <span class="stringliteral">&#39;５&#39;</span>, <span class="charliteral">&#39;6&#39;</span>: <span class="stringliteral">&#39;６&#39;</span>, <span class="charliteral">&#39;7&#39;</span>: <span class="stringliteral">&#39;７&#39;</span>,
<a name="l00111"></a>00111     <span class="charliteral">&#39;8&#39;</span>: <span class="stringliteral">&#39;８&#39;</span>, <span class="charliteral">&#39;9&#39;</span>: <span class="stringliteral">&#39;９&#39;</span>, <span class="charliteral">&#39;0&#39;</span>: <span class="stringliteral">&#39;０&#39;</span>
<a name="l00112"></a>00112   };
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   <span class="comment">// Key loop</span>
<a name="l00115"></a>00115   <span class="comment">// Ex.</span>
<a name="l00116"></a>00116   <span class="comment">//   あ displays when clicking あ</span>
<a name="l00117"></a>00117   <span class="comment">//   い displays when clicking あ twice</span>
<a name="l00118"></a>00118   var IMEHiraganaCycleTable = [
<a name="l00119"></a>00119     [<span class="stringliteral">&#39;あ&#39;</span>, <span class="stringliteral">&#39;い&#39;</span>, <span class="stringliteral">&#39;う&#39;</span>, <span class="stringliteral">&#39;え&#39;</span>, <span class="stringliteral">&#39;お&#39;</span>, <span class="stringliteral">&#39;ぁ&#39;</span>, <span class="stringliteral">&#39;ぃ&#39;</span>, <span class="stringliteral">&#39;ぅ&#39;</span>, <span class="stringliteral">&#39;ぇ&#39;</span>, <span class="stringliteral">&#39;ぉ&#39;</span>],
<a name="l00120"></a>00120     [<span class="stringliteral">&#39;か&#39;</span>, <span class="stringliteral">&#39;き&#39;</span>, <span class="stringliteral">&#39;く&#39;</span>, <span class="stringliteral">&#39;け&#39;</span>, <span class="stringliteral">&#39;こ&#39;</span>],
<a name="l00121"></a>00121     [<span class="stringliteral">&#39;さ&#39;</span>, <span class="stringliteral">&#39;し&#39;</span>, <span class="stringliteral">&#39;す&#39;</span>, <span class="stringliteral">&#39;せ&#39;</span>, <span class="stringliteral">&#39;そ&#39;</span>],
<a name="l00122"></a>00122     [<span class="stringliteral">&#39;た&#39;</span>, <span class="stringliteral">&#39;ち&#39;</span>, <span class="stringliteral">&#39;つ&#39;</span>, <span class="stringliteral">&#39;て&#39;</span>, <span class="stringliteral">&#39;と&#39;</span>, <span class="stringliteral">&#39;っ&#39;</span>],
<a name="l00123"></a>00123     [<span class="stringliteral">&#39;な&#39;</span>, <span class="stringliteral">&#39;に&#39;</span>, <span class="stringliteral">&#39;ぬ&#39;</span>, <span class="stringliteral">&#39;ね&#39;</span>, <span class="stringliteral">&#39;の&#39;</span>],
<a name="l00124"></a>00124     [<span class="stringliteral">&#39;は&#39;</span>, <span class="stringliteral">&#39;ひ&#39;</span>, <span class="stringliteral">&#39;ふ&#39;</span>, <span class="stringliteral">&#39;へ&#39;</span>, <span class="stringliteral">&#39;ほ&#39;</span>],
<a name="l00125"></a>00125     [<span class="stringliteral">&#39;ま&#39;</span>, <span class="stringliteral">&#39;み&#39;</span>, <span class="stringliteral">&#39;む&#39;</span>, <span class="stringliteral">&#39;め&#39;</span>, <span class="stringliteral">&#39;も&#39;</span>],
<a name="l00126"></a>00126     [<span class="stringliteral">&#39;や&#39;</span>, <span class="stringliteral">&#39;ゆ&#39;</span>, <span class="stringliteral">&#39;よ&#39;</span>, <span class="stringliteral">&#39;ゃ&#39;</span>, <span class="stringliteral">&#39;ゅ&#39;</span>, <span class="stringliteral">&#39;ょ&#39;</span>],
<a name="l00127"></a>00127     [<span class="stringliteral">&#39;ら&#39;</span>, <span class="stringliteral">&#39;り&#39;</span>, <span class="stringliteral">&#39;る&#39;</span>, <span class="stringliteral">&#39;れ&#39;</span>, <span class="stringliteral">&#39;ろ&#39;</span>],
<a name="l00128"></a>00128     [<span class="stringliteral">&#39;わ&#39;</span>, <span class="stringliteral">&#39;を&#39;</span>, <span class="stringliteral">&#39;ん&#39;</span>, <span class="stringliteral">&#39;ゎ&#39;</span>, <span class="stringliteral">&#39;ー&#39;</span>],
<a name="l00129"></a>00129     [<span class="stringliteral">&#39;、&#39;</span>, <span class="stringliteral">&#39;。&#39;</span>, <span class="stringliteral">&#39;？&#39;</span>, <span class="stringliteral">&#39;！&#39;</span>, <span class="stringliteral">&#39;・&#39;</span>, <span class="stringliteral">&#39;　&#39;</span>]
<a name="l00130"></a>00130   ];
<a name="l00131"></a>00131   var IMEFullKatakanaCycleTable = [
<a name="l00132"></a>00132     [<span class="stringliteral">&#39;ア&#39;</span>, <span class="stringliteral">&#39;イ&#39;</span>, <span class="stringliteral">&#39;ウ&#39;</span>, <span class="stringliteral">&#39;エ&#39;</span>, <span class="stringliteral">&#39;オ&#39;</span>, <span class="stringliteral">&#39;ァ&#39;</span>, <span class="stringliteral">&#39;ィ&#39;</span>, <span class="stringliteral">&#39;ゥ&#39;</span>, <span class="stringliteral">&#39;ェ&#39;</span>, <span class="stringliteral">&#39;ォ&#39;</span>],
<a name="l00133"></a>00133     [<span class="stringliteral">&#39;カ&#39;</span>, <span class="stringliteral">&#39;キ&#39;</span>, <span class="stringliteral">&#39;ク&#39;</span>, <span class="stringliteral">&#39;ケ&#39;</span>, <span class="stringliteral">&#39;コ&#39;</span>],
<a name="l00134"></a>00134     [<span class="stringliteral">&#39;サ&#39;</span>, <span class="stringliteral">&#39;シ&#39;</span>, <span class="stringliteral">&#39;ス&#39;</span>, <span class="stringliteral">&#39;セ&#39;</span>, <span class="stringliteral">&#39;ソ&#39;</span>],
<a name="l00135"></a>00135     [<span class="stringliteral">&#39;タ&#39;</span>, <span class="stringliteral">&#39;チ&#39;</span>, <span class="stringliteral">&#39;ツ&#39;</span>, <span class="stringliteral">&#39;テ&#39;</span>, <span class="stringliteral">&#39;ト&#39;</span>, <span class="stringliteral">&#39;ッ&#39;</span>],
<a name="l00136"></a>00136     [<span class="stringliteral">&#39;ナ&#39;</span>, <span class="stringliteral">&#39;ニ&#39;</span>, <span class="stringliteral">&#39;ヌ&#39;</span>, <span class="stringliteral">&#39;ネ&#39;</span>, <span class="stringliteral">&#39;ノ&#39;</span>],
<a name="l00137"></a>00137     [<span class="stringliteral">&#39;ハ&#39;</span>, <span class="stringliteral">&#39;ヒ&#39;</span>, <span class="stringliteral">&#39;フ&#39;</span>, <span class="stringliteral">&#39;ヘ&#39;</span>, <span class="stringliteral">&#39;ホ&#39;</span>],
<a name="l00138"></a>00138     [<span class="stringliteral">&#39;マ&#39;</span>, <span class="stringliteral">&#39;ミ&#39;</span>, <span class="stringliteral">&#39;ム&#39;</span>, <span class="stringliteral">&#39;メ&#39;</span>, <span class="stringliteral">&#39;モ&#39;</span>],
<a name="l00139"></a>00139     [<span class="stringliteral">&#39;ヤ&#39;</span>, <span class="stringliteral">&#39;ユ&#39;</span>, <span class="stringliteral">&#39;ヨ&#39;</span>, <span class="stringliteral">&#39;ャ&#39;</span>, <span class="stringliteral">&#39;ュ&#39;</span>, <span class="stringliteral">&#39;ョ&#39;</span>],
<a name="l00140"></a>00140     [<span class="stringliteral">&#39;ラ&#39;</span>, <span class="stringliteral">&#39;リ&#39;</span>, <span class="stringliteral">&#39;ル&#39;</span>, <span class="stringliteral">&#39;レ&#39;</span>, <span class="stringliteral">&#39;ロ&#39;</span>],
<a name="l00141"></a>00141     [<span class="stringliteral">&#39;ワ&#39;</span>, <span class="stringliteral">&#39;ヲ&#39;</span>, <span class="stringliteral">&#39;ン&#39;</span>, <span class="stringliteral">&#39;ヮ&#39;</span>, <span class="stringliteral">&#39;ー&#39;</span>],
<a name="l00142"></a>00142     [<span class="stringliteral">&#39;、&#39;</span>, <span class="stringliteral">&#39;。&#39;</span>, <span class="stringliteral">&#39;？&#39;</span>, <span class="stringliteral">&#39;！&#39;</span>, <span class="stringliteral">&#39;・&#39;</span>, <span class="stringliteral">&#39;　&#39;</span>]
<a name="l00143"></a>00143   ];
<a name="l00144"></a>00144   var IMEHalfKatakanaCycleTable = [
<a name="l00145"></a>00145     [<span class="stringliteral">&#39;ｱ&#39;</span>, <span class="stringliteral">&#39;ｲ&#39;</span>, <span class="stringliteral">&#39;ｳ&#39;</span>, <span class="stringliteral">&#39;ｴ&#39;</span>, <span class="stringliteral">&#39;ｵ&#39;</span>, <span class="stringliteral">&#39;ｧ&#39;</span>, <span class="stringliteral">&#39;ｨ&#39;</span>, <span class="stringliteral">&#39;ｩ&#39;</span>, <span class="stringliteral">&#39;ｪ&#39;</span>, <span class="stringliteral">&#39;ｫ&#39;</span>],
<a name="l00146"></a>00146     [<span class="stringliteral">&#39;ｶ&#39;</span>, <span class="stringliteral">&#39;ｷ&#39;</span>, <span class="stringliteral">&#39;ｸ&#39;</span>, <span class="stringliteral">&#39;ｹ&#39;</span>, <span class="stringliteral">&#39;ｺ&#39;</span>],
<a name="l00147"></a>00147     [<span class="stringliteral">&#39;ｻ&#39;</span>, <span class="stringliteral">&#39;ｼ&#39;</span>, <span class="stringliteral">&#39;ｽ&#39;</span>, <span class="stringliteral">&#39;ｾ&#39;</span>, <span class="stringliteral">&#39;ｿ&#39;</span>],
<a name="l00148"></a>00148     [<span class="stringliteral">&#39;ﾀ&#39;</span>, <span class="stringliteral">&#39;ﾁ&#39;</span>, <span class="stringliteral">&#39;ﾂ&#39;</span>, <span class="stringliteral">&#39;ﾃ&#39;</span>, <span class="stringliteral">&#39;ﾄ&#39;</span>, <span class="stringliteral">&#39;ｯ&#39;</span>],
<a name="l00149"></a>00149     [<span class="stringliteral">&#39;ﾅ&#39;</span>, <span class="stringliteral">&#39;ﾆ&#39;</span>, <span class="stringliteral">&#39;ﾇ&#39;</span>, <span class="stringliteral">&#39;ﾈ&#39;</span>, <span class="stringliteral">&#39;ﾉ&#39;</span>],
<a name="l00150"></a>00150     [<span class="stringliteral">&#39;ﾊ&#39;</span>, <span class="stringliteral">&#39;ﾋ&#39;</span>, <span class="stringliteral">&#39;ﾌ&#39;</span>, <span class="stringliteral">&#39;ﾍ&#39;</span>, <span class="stringliteral">&#39;ﾎ&#39;</span>],
<a name="l00151"></a>00151     [<span class="stringliteral">&#39;ﾏ&#39;</span>, <span class="stringliteral">&#39;ﾐ&#39;</span>, <span class="stringliteral">&#39;ﾑ&#39;</span>, <span class="stringliteral">&#39;ﾒ&#39;</span>, <span class="stringliteral">&#39;ﾓ&#39;</span>],
<a name="l00152"></a>00152     [<span class="stringliteral">&#39;ﾔ&#39;</span>, <span class="stringliteral">&#39;ﾕ&#39;</span>, <span class="stringliteral">&#39;ﾖ&#39;</span>, <span class="stringliteral">&#39;ｬ&#39;</span>, <span class="stringliteral">&#39;ｭ&#39;</span>, <span class="stringliteral">&#39;ｮ&#39;</span>],
<a name="l00153"></a>00153     [<span class="stringliteral">&#39;ﾗ&#39;</span>, <span class="stringliteral">&#39;ﾘ&#39;</span>, <span class="stringliteral">&#39;ﾙ&#39;</span>, <span class="stringliteral">&#39;ﾚ&#39;</span>, <span class="stringliteral">&#39;ﾛ&#39;</span>],
<a name="l00154"></a>00154     [<span class="stringliteral">&#39;ﾜ&#39;</span>, <span class="stringliteral">&#39;ｦ&#39;</span>, <span class="stringliteral">&#39;ﾝ&#39;</span>, <span class="stringliteral">&#39;ｰ&#39;</span>],
<a name="l00155"></a>00155     [<span class="stringliteral">&#39;､&#39;</span>, <span class="stringliteral">&#39;｡&#39;</span>, <span class="charliteral">&#39;?&#39;</span>, <span class="charliteral">&#39;!&#39;</span>, <span class="stringliteral">&#39;･&#39;</span>, <span class="charliteral">&#39; &#39;</span>]
<a name="l00156"></a>00156   ];
<a name="l00157"></a>00157 
<a name="l00158"></a>00158   <span class="comment">// Hiragana (平假名) case convert table</span>
<a name="l00159"></a>00159   var IMEHiraganaCaseTable = {
<a name="l00160"></a>00160     <span class="stringliteral">&#39;あ&#39;</span>: <span class="stringliteral">&#39;ぁ&#39;</span>, <span class="stringliteral">&#39;い&#39;</span>: <span class="stringliteral">&#39;ぃ&#39;</span>, <span class="stringliteral">&#39;う&#39;</span>: <span class="stringliteral">&#39;ぅ&#39;</span>, <span class="stringliteral">&#39;え&#39;</span>: <span class="stringliteral">&#39;ぇ&#39;</span>, <span class="stringliteral">&#39;お&#39;</span>: <span class="stringliteral">&#39;ぉ&#39;</span>, <span class="stringliteral">&#39;ぁ&#39;</span>: <span class="stringliteral">&#39;あ&#39;</span>, <span class="stringliteral">&#39;ぃ&#39;</span>: <span class="stringliteral">&#39;い&#39;</span>,
<a name="l00161"></a>00161     <span class="stringliteral">&#39;ぅ&#39;</span>: <span class="stringliteral">&#39;ヴ&#39;</span>, <span class="stringliteral">&#39;ぇ&#39;</span>: <span class="stringliteral">&#39;え&#39;</span>, <span class="stringliteral">&#39;ぉ&#39;</span>: <span class="stringliteral">&#39;お&#39;</span>, <span class="stringliteral">&#39;か&#39;</span>: <span class="stringliteral">&#39;が&#39;</span>, <span class="stringliteral">&#39;き&#39;</span>: <span class="stringliteral">&#39;ぎ&#39;</span>,
<a name="l00162"></a>00162     <span class="stringliteral">&#39;く&#39;</span>: <span class="stringliteral">&#39;ぐ&#39;</span>, <span class="stringliteral">&#39;け&#39;</span>: <span class="stringliteral">&#39;げ&#39;</span>, <span class="stringliteral">&#39;こ&#39;</span>: <span class="stringliteral">&#39;ご&#39;</span>, <span class="stringliteral">&#39;が&#39;</span>: <span class="stringliteral">&#39;か&#39;</span>, <span class="stringliteral">&#39;ぎ&#39;</span>: <span class="stringliteral">&#39;き&#39;</span>, <span class="stringliteral">&#39;ぐ&#39;</span>: <span class="stringliteral">&#39;く&#39;</span>, <span class="stringliteral">&#39;げ&#39;</span>: <span class="stringliteral">&#39;け&#39;</span>,
<a name="l00163"></a>00163     <span class="stringliteral">&#39;ご&#39;</span>: <span class="stringliteral">&#39;こ&#39;</span>, <span class="stringliteral">&#39;さ&#39;</span>: <span class="stringliteral">&#39;ざ&#39;</span>, <span class="stringliteral">&#39;し&#39;</span>: <span class="stringliteral">&#39;じ&#39;</span>, <span class="stringliteral">&#39;す&#39;</span>: <span class="stringliteral">&#39;ず&#39;</span>, <span class="stringliteral">&#39;せ&#39;</span>: <span class="stringliteral">&#39;ぜ&#39;</span>,
<a name="l00164"></a>00164     <span class="stringliteral">&#39;そ&#39;</span>: <span class="stringliteral">&#39;ぞ&#39;</span>, <span class="stringliteral">&#39;ざ&#39;</span>: <span class="stringliteral">&#39;さ&#39;</span>, <span class="stringliteral">&#39;じ&#39;</span>: <span class="stringliteral">&#39;し&#39;</span>, <span class="stringliteral">&#39;ず&#39;</span>: <span class="stringliteral">&#39;す&#39;</span>, <span class="stringliteral">&#39;ぜ&#39;</span>: <span class="stringliteral">&#39;せ&#39;</span>, <span class="stringliteral">&#39;ぞ&#39;</span>: <span class="stringliteral">&#39;そ&#39;</span>, <span class="stringliteral">&#39;た&#39;</span>: <span class="stringliteral">&#39;だ&#39;</span>,
<a name="l00165"></a>00165     <span class="stringliteral">&#39;ち&#39;</span>: <span class="stringliteral">&#39;ぢ&#39;</span>, <span class="stringliteral">&#39;つ&#39;</span>: <span class="stringliteral">&#39;っ&#39;</span>, <span class="stringliteral">&#39;て&#39;</span>: <span class="stringliteral">&#39;で&#39;</span>, <span class="stringliteral">&#39;と&#39;</span>: <span class="stringliteral">&#39;ど&#39;</span>, <span class="stringliteral">&#39;だ&#39;</span>: <span class="stringliteral">&#39;た&#39;</span>,
<a name="l00166"></a>00166     <span class="stringliteral">&#39;ぢ&#39;</span>: <span class="stringliteral">&#39;ち&#39;</span>, <span class="stringliteral">&#39;っ&#39;</span>: <span class="stringliteral">&#39;づ&#39;</span>, <span class="stringliteral">&#39;で&#39;</span>: <span class="stringliteral">&#39;て&#39;</span>, <span class="stringliteral">&#39;ど&#39;</span>: <span class="stringliteral">&#39;と&#39;</span>, <span class="stringliteral">&#39;づ&#39;</span>: <span class="stringliteral">&#39;つ&#39;</span>, <span class="stringliteral">&#39;ヴ&#39;</span>: <span class="stringliteral">&#39;う&#39;</span>, <span class="stringliteral">&#39;は&#39;</span>: <span class="stringliteral">&#39;ば&#39;</span>,
<a name="l00167"></a>00167     <span class="stringliteral">&#39;ひ&#39;</span>: <span class="stringliteral">&#39;び&#39;</span>, <span class="stringliteral">&#39;ふ&#39;</span>: <span class="stringliteral">&#39;ぶ&#39;</span>, <span class="stringliteral">&#39;へ&#39;</span>: <span class="stringliteral">&#39;べ&#39;</span>, <span class="stringliteral">&#39;ほ&#39;</span>: <span class="stringliteral">&#39;ぼ&#39;</span>, <span class="stringliteral">&#39;ば&#39;</span>: <span class="stringliteral">&#39;ぱ&#39;</span>,
<a name="l00168"></a>00168     <span class="stringliteral">&#39;び&#39;</span>: <span class="stringliteral">&#39;ぴ&#39;</span>, <span class="stringliteral">&#39;ぶ&#39;</span>: <span class="stringliteral">&#39;ぷ&#39;</span>, <span class="stringliteral">&#39;べ&#39;</span>: <span class="stringliteral">&#39;ぺ&#39;</span>, <span class="stringliteral">&#39;ぼ&#39;</span>: <span class="stringliteral">&#39;ぽ&#39;</span>, <span class="stringliteral">&#39;ぱ&#39;</span>: <span class="stringliteral">&#39;は&#39;</span>, <span class="stringliteral">&#39;ぴ&#39;</span>: <span class="stringliteral">&#39;ひ&#39;</span>,
<a name="l00169"></a>00169     <span class="stringliteral">&#39;ぷ&#39;</span>: <span class="stringliteral">&#39;ふ&#39;</span>, <span class="stringliteral">&#39;ぺ&#39;</span>: <span class="stringliteral">&#39;へ&#39;</span>, <span class="stringliteral">&#39;ぽ&#39;</span>: <span class="stringliteral">&#39;ほ&#39;</span>, <span class="stringliteral">&#39;や&#39;</span>: <span class="stringliteral">&#39;ゃ&#39;</span>, <span class="stringliteral">&#39;ゆ&#39;</span>: <span class="stringliteral">&#39;ゅ&#39;</span>, <span class="stringliteral">&#39;よ&#39;</span>: <span class="stringliteral">&#39;ょ&#39;</span>,
<a name="l00170"></a>00170     <span class="stringliteral">&#39;ゃ&#39;</span>: <span class="stringliteral">&#39;や&#39;</span>, <span class="stringliteral">&#39;ゅ&#39;</span>: <span class="stringliteral">&#39;ゆ&#39;</span>, <span class="stringliteral">&#39;ょ&#39;</span>: <span class="stringliteral">&#39;よ&#39;</span>, <span class="stringliteral">&#39;わ&#39;</span>: <span class="stringliteral">&#39;ゎ&#39;</span>, <span class="stringliteral">&#39;ゎ&#39;</span>: <span class="stringliteral">&#39;わ&#39;</span>, <span class="stringliteral">&#39;゛&#39;</span>: <span class="stringliteral">&#39;゜&#39;</span>, <span class="stringliteral">&#39;゜&#39;</span>: <span class="stringliteral">&#39;゛&#39;</span>
<a name="l00171"></a>00171   };
<a name="l00172"></a>00172   <span class="comment">// Katakana (片假名) case convert table</span>
<a name="l00173"></a>00173   var IMEFullKatakanaCaseTable = {
<a name="l00174"></a>00174     <span class="stringliteral">&#39;ア&#39;</span>: <span class="stringliteral">&#39;ァ&#39;</span>, <span class="stringliteral">&#39;イ&#39;</span>: <span class="stringliteral">&#39;ィ&#39;</span>, <span class="stringliteral">&#39;ウ&#39;</span>: <span class="stringliteral">&#39;ゥ&#39;</span>, <span class="stringliteral">&#39;エ&#39;</span>: <span class="stringliteral">&#39;ェ&#39;</span>, <span class="stringliteral">&#39;オ&#39;</span>: <span class="stringliteral">&#39;ォ&#39;</span>, <span class="stringliteral">&#39;ァ&#39;</span>: <span class="stringliteral">&#39;ア&#39;</span>, <span class="stringliteral">&#39;ィ&#39;</span>: <span class="stringliteral">&#39;イ&#39;</span>,
<a name="l00175"></a>00175     <span class="stringliteral">&#39;ゥ&#39;</span>: <span class="stringliteral">&#39;ヴ&#39;</span>, <span class="stringliteral">&#39;ェ&#39;</span>: <span class="stringliteral">&#39;エ&#39;</span>, <span class="stringliteral">&#39;ォ&#39;</span>: <span class="stringliteral">&#39;オ&#39;</span>, <span class="stringliteral">&#39;カ&#39;</span>: <span class="stringliteral">&#39;ガ&#39;</span>, <span class="stringliteral">&#39;キ&#39;</span>: <span class="stringliteral">&#39;ギ&#39;</span>,
<a name="l00176"></a>00176     <span class="stringliteral">&#39;ク&#39;</span>: <span class="stringliteral">&#39;グ&#39;</span>, <span class="stringliteral">&#39;ケ&#39;</span>: <span class="stringliteral">&#39;ゲ&#39;</span>, <span class="stringliteral">&#39;コ&#39;</span>: <span class="stringliteral">&#39;ゴ&#39;</span>, <span class="stringliteral">&#39;ガ&#39;</span>: <span class="stringliteral">&#39;カ&#39;</span>, <span class="stringliteral">&#39;ギ&#39;</span>: <span class="stringliteral">&#39;キ&#39;</span>, <span class="stringliteral">&#39;グ&#39;</span>: <span class="stringliteral">&#39;ク&#39;</span>, <span class="stringliteral">&#39;ゲ&#39;</span>: <span class="stringliteral">&#39;ケ&#39;</span>,
<a name="l00177"></a>00177     <span class="stringliteral">&#39;ゴ&#39;</span>: <span class="stringliteral">&#39;コ&#39;</span>, <span class="stringliteral">&#39;サ&#39;</span>: <span class="stringliteral">&#39;ザ&#39;</span>, <span class="stringliteral">&#39;シ&#39;</span>: <span class="stringliteral">&#39;ジ&#39;</span>, <span class="stringliteral">&#39;ス&#39;</span>: <span class="stringliteral">&#39;ズ&#39;</span>, <span class="stringliteral">&#39;セ&#39;</span>: <span class="stringliteral">&#39;ゼ&#39;</span>,
<a name="l00178"></a>00178     <span class="stringliteral">&#39;ソ&#39;</span>: <span class="stringliteral">&#39;ゾ&#39;</span>, <span class="stringliteral">&#39;ザ&#39;</span>: <span class="stringliteral">&#39;サ&#39;</span>, <span class="stringliteral">&#39;ジ&#39;</span>: <span class="stringliteral">&#39;シ&#39;</span>, <span class="stringliteral">&#39;ズ&#39;</span>: <span class="stringliteral">&#39;ス&#39;</span>, <span class="stringliteral">&#39;ゼ&#39;</span>: <span class="stringliteral">&#39;セ&#39;</span>, <span class="stringliteral">&#39;ゾ&#39;</span>: <span class="stringliteral">&#39;ソ&#39;</span>,
<a name="l00179"></a>00179     <span class="stringliteral">&#39;タ&#39;</span>: <span class="stringliteral">&#39;ダ&#39;</span>, <span class="stringliteral">&#39;チ&#39;</span>: <span class="stringliteral">&#39;ヂ&#39;</span>, <span class="stringliteral">&#39;ツ&#39;</span>: <span class="stringliteral">&#39;ッ&#39;</span>, <span class="stringliteral">&#39;テ&#39;</span>: <span class="stringliteral">&#39;デ&#39;</span>, <span class="stringliteral">&#39;ト&#39;</span>: <span class="stringliteral">&#39;ド&#39;</span>, <span class="stringliteral">&#39;ダ&#39;</span>: <span class="stringliteral">&#39;タ&#39;</span>,
<a name="l00180"></a>00180     <span class="stringliteral">&#39;ヂ&#39;</span>: <span class="stringliteral">&#39;チ&#39;</span>, <span class="stringliteral">&#39;ッ&#39;</span>: <span class="stringliteral">&#39;ヅ&#39;</span>, <span class="stringliteral">&#39;デ&#39;</span>: <span class="stringliteral">&#39;テ&#39;</span>, <span class="stringliteral">&#39;ド&#39;</span>: <span class="stringliteral">&#39;ト&#39;</span>, <span class="stringliteral">&#39;ヅ&#39;</span>: <span class="stringliteral">&#39;ツ&#39;</span>, <span class="stringliteral">&#39;ヴ&#39;</span>: <span class="stringliteral">&#39;ウ&#39;</span>, <span class="stringliteral">&#39;ハ&#39;</span>: <span class="stringliteral">&#39;バ&#39;</span>,
<a name="l00181"></a>00181     <span class="stringliteral">&#39;ヒ&#39;</span>: <span class="stringliteral">&#39;ビ&#39;</span>, <span class="stringliteral">&#39;フ&#39;</span>: <span class="stringliteral">&#39;ブ&#39;</span>, <span class="stringliteral">&#39;ヘ&#39;</span>: <span class="stringliteral">&#39;ベ&#39;</span>, <span class="stringliteral">&#39;ホ&#39;</span>: <span class="stringliteral">&#39;ボ&#39;</span>, <span class="stringliteral">&#39;バ&#39;</span>: <span class="stringliteral">&#39;パ&#39;</span>,
<a name="l00182"></a>00182     <span class="stringliteral">&#39;ビ&#39;</span>: <span class="stringliteral">&#39;ピ&#39;</span>, <span class="stringliteral">&#39;ブ&#39;</span>: <span class="stringliteral">&#39;プ&#39;</span>, <span class="stringliteral">&#39;ベ&#39;</span>: <span class="stringliteral">&#39;ペ&#39;</span>, <span class="stringliteral">&#39;ボ&#39;</span>: <span class="stringliteral">&#39;ポ&#39;</span>, <span class="stringliteral">&#39;パ&#39;</span>: <span class="stringliteral">&#39;ハ&#39;</span>, <span class="stringliteral">&#39;ピ&#39;</span>: <span class="stringliteral">&#39;ヒ&#39;</span>,
<a name="l00183"></a>00183     <span class="stringliteral">&#39;プ&#39;</span>: <span class="stringliteral">&#39;フ&#39;</span>, <span class="stringliteral">&#39;ペ&#39;</span>: <span class="stringliteral">&#39;ヘ&#39;</span>, <span class="stringliteral">&#39;ポ&#39;</span>: <span class="stringliteral">&#39;ホ&#39;</span>, <span class="stringliteral">&#39;ヤ&#39;</span>: <span class="stringliteral">&#39;ャ&#39;</span>, <span class="stringliteral">&#39;ユ&#39;</span>: <span class="stringliteral">&#39;ュ&#39;</span>, <span class="stringliteral">&#39;ヨ&#39;</span>: <span class="stringliteral">&#39;ョ&#39;</span>,
<a name="l00184"></a>00184     <span class="stringliteral">&#39;ャ&#39;</span>: <span class="stringliteral">&#39;ヤ&#39;</span>, <span class="stringliteral">&#39;ュ&#39;</span>: <span class="stringliteral">&#39;ユ&#39;</span>, <span class="stringliteral">&#39;ョ&#39;</span>: <span class="stringliteral">&#39;ヨ&#39;</span>, <span class="stringliteral">&#39;ワ&#39;</span>: <span class="stringliteral">&#39;ヮ&#39;</span>, <span class="stringliteral">&#39;ヮ&#39;</span>: <span class="stringliteral">&#39;ワ&#39;</span>
<a name="l00185"></a>00185   };
<a name="l00186"></a>00186   var IMEHalfKatakanaCaseTable = {
<a name="l00187"></a>00187     <span class="stringliteral">&#39;ｱ&#39;</span>: <span class="stringliteral">&#39;ｧ&#39;</span>, <span class="stringliteral">&#39;ｲ&#39;</span>: <span class="stringliteral">&#39;ｨ&#39;</span>, <span class="stringliteral">&#39;ｳ&#39;</span>: <span class="stringliteral">&#39;ｩ&#39;</span>, <span class="stringliteral">&#39;ｴ&#39;</span>: <span class="stringliteral">&#39;ｪ&#39;</span>, <span class="stringliteral">&#39;ｵ&#39;</span>: <span class="stringliteral">&#39;ｫ&#39;</span>, <span class="stringliteral">&#39;ｧ&#39;</span>: <span class="stringliteral">&#39;ｱ&#39;</span>, <span class="stringliteral">&#39;ｨ&#39;</span>: <span class="stringliteral">&#39;ｲ&#39;</span>,
<a name="l00188"></a>00188     <span class="stringliteral">&#39;ｩ&#39;</span>: <span class="stringliteral">&#39;ｳﾞ&#39;</span>, <span class="stringliteral">&#39;ｪ&#39;</span>: <span class="stringliteral">&#39;ｴ&#39;</span>, <span class="stringliteral">&#39;ｫ&#39;</span>: <span class="stringliteral">&#39;ｵ&#39;</span>, <span class="stringliteral">&#39;ｶ&#39;</span>: <span class="stringliteral">&#39;ｶﾞ&#39;</span>,
<a name="l00189"></a>00189     <span class="stringliteral">&#39;ｷ&#39;</span>: <span class="stringliteral">&#39;ｷﾞ&#39;</span>, <span class="stringliteral">&#39;ｸ&#39;</span>: <span class="stringliteral">&#39;ｸﾞ&#39;</span>, <span class="stringliteral">&#39;ｹ&#39;</span>: <span class="stringliteral">&#39;ｹﾞ&#39;</span>, <span class="stringliteral">&#39;ｺ&#39;</span>: <span class="stringliteral">&#39;ｺﾞ&#39;</span>, <span class="stringliteral">&#39;ｶﾞ&#39;</span>: <span class="stringliteral">&#39;ｶ&#39;</span>, <span class="stringliteral">&#39;ｷﾞ&#39;</span>: <span class="stringliteral">&#39;ｷ&#39;</span>, <span class="stringliteral">&#39;ｸﾞ&#39;</span>: <span class="stringliteral">&#39;ｸ&#39;</span>,
<a name="l00190"></a>00190     <span class="stringliteral">&#39;ｹﾞ&#39;</span>: <span class="stringliteral">&#39;ｹ&#39;</span>, <span class="stringliteral">&#39;ｺﾞ&#39;</span>: <span class="stringliteral">&#39;ｺ&#39;</span>, <span class="stringliteral">&#39;ｻ&#39;</span>: <span class="stringliteral">&#39;ｻﾞ&#39;</span>, <span class="stringliteral">&#39;ｼ&#39;</span>: <span class="stringliteral">&#39;ｼﾞ&#39;</span>,
<a name="l00191"></a>00191     <span class="stringliteral">&#39;ｽ&#39;</span>: <span class="stringliteral">&#39;ｽﾞ&#39;</span>, <span class="stringliteral">&#39;ｾ&#39;</span>: <span class="stringliteral">&#39;ｾﾞ&#39;</span>, <span class="stringliteral">&#39;ｿ&#39;</span>: <span class="stringliteral">&#39;ｿﾞ&#39;</span>, <span class="stringliteral">&#39;ｻﾞ&#39;</span>: <span class="stringliteral">&#39;ｻ&#39;</span>, <span class="stringliteral">&#39;ｼﾞ&#39;</span>: <span class="stringliteral">&#39;ｼ&#39;</span>, <span class="stringliteral">&#39;ｽﾞ&#39;</span>: <span class="stringliteral">&#39;ｽ&#39;</span>, <span class="stringliteral">&#39;ｾﾞ&#39;</span>: <span class="stringliteral">&#39;ｾ&#39;</span>,
<a name="l00192"></a>00192     <span class="stringliteral">&#39;ｿﾞ&#39;</span>: <span class="stringliteral">&#39;ｿ&#39;</span>, <span class="stringliteral">&#39;ﾀ&#39;</span>: <span class="stringliteral">&#39;ﾀﾞ&#39;</span>, <span class="stringliteral">&#39;ﾁ&#39;</span>: <span class="stringliteral">&#39;ﾁﾞ&#39;</span>, <span class="stringliteral">&#39;ﾂ&#39;</span>: <span class="stringliteral">&#39;ｯ&#39;</span>,
<a name="l00193"></a>00193     <span class="stringliteral">&#39;ﾃ&#39;</span>: <span class="stringliteral">&#39;ﾃﾞ&#39;</span>, <span class="stringliteral">&#39;ﾄ&#39;</span>: <span class="stringliteral">&#39;ﾄﾞ&#39;</span>, <span class="stringliteral">&#39;ﾀﾞ&#39;</span>: <span class="stringliteral">&#39;ﾀ&#39;</span>, <span class="stringliteral">&#39;ﾁﾞ&#39;</span>: <span class="stringliteral">&#39;ﾁ&#39;</span>, <span class="stringliteral">&#39;ｯ&#39;</span>: <span class="stringliteral">&#39;ﾂﾞ&#39;</span>, <span class="stringliteral">&#39;ﾃﾞ&#39;</span>: <span class="stringliteral">&#39;ﾃ&#39;</span>, <span class="stringliteral">&#39;ﾄﾞ&#39;</span>: <span class="stringliteral">&#39;ﾄ&#39;</span>,
<a name="l00194"></a>00194     <span class="stringliteral">&#39;ﾂﾞ&#39;</span>: <span class="stringliteral">&#39;ﾂ&#39;</span>, <span class="stringliteral">&#39;ﾊ&#39;</span>: <span class="stringliteral">&#39;ﾊﾞ&#39;</span>, <span class="stringliteral">&#39;ﾋ&#39;</span>: <span class="stringliteral">&#39;ﾋﾞ&#39;</span>, <span class="stringliteral">&#39;ﾌ&#39;</span>: <span class="stringliteral">&#39;ﾌﾞ&#39;</span>,
<a name="l00195"></a>00195     <span class="stringliteral">&#39;ﾍ&#39;</span>: <span class="stringliteral">&#39;ﾍﾞ&#39;</span>, <span class="stringliteral">&#39;ﾎ&#39;</span>: <span class="stringliteral">&#39;ﾎﾞ&#39;</span>, <span class="stringliteral">&#39;ﾊﾞ&#39;</span>: <span class="stringliteral">&#39;ﾊﾟ&#39;</span>, <span class="stringliteral">&#39;ﾋﾞ&#39;</span>: <span class="stringliteral">&#39;ﾋﾟ&#39;</span>, <span class="stringliteral">&#39;ﾌﾞ&#39;</span>: <span class="stringliteral">&#39;ﾌﾟ&#39;</span>, <span class="stringliteral">&#39;ﾍﾞ&#39;</span>: <span class="stringliteral">&#39;ﾍﾟ&#39;</span>,
<a name="l00196"></a>00196     <span class="stringliteral">&#39;ﾎﾞ&#39;</span>: <span class="stringliteral">&#39;ﾎﾟ&#39;</span>, <span class="stringliteral">&#39;ﾊﾟ&#39;</span>: <span class="stringliteral">&#39;ﾊ&#39;</span>, <span class="stringliteral">&#39;ﾋﾟ&#39;</span>: <span class="stringliteral">&#39;ﾋ&#39;</span>, <span class="stringliteral">&#39;ﾌﾟ&#39;</span>: <span class="stringliteral">&#39;ﾌ&#39;</span>, <span class="stringliteral">&#39;ﾍﾟ&#39;</span>: <span class="stringliteral">&#39;ﾍ&#39;</span>,
<a name="l00197"></a>00197     <span class="stringliteral">&#39;ﾎﾟ&#39;</span>: <span class="stringliteral">&#39;ﾎ&#39;</span>, <span class="stringliteral">&#39;ﾔ&#39;</span>: <span class="stringliteral">&#39;ｬ&#39;</span>, <span class="stringliteral">&#39;ﾕ&#39;</span>: <span class="stringliteral">&#39;ｭ&#39;</span>, <span class="stringliteral">&#39;ﾖ&#39;</span>: <span class="stringliteral">&#39;ｮ&#39;</span>, <span class="stringliteral">&#39;ｬ&#39;</span>: <span class="stringliteral">&#39;ﾔ&#39;</span>, <span class="stringliteral">&#39;ｭ&#39;</span>: <span class="stringliteral">&#39;ﾕ&#39;</span>, <span class="stringliteral">&#39;ｮ&#39;</span>: <span class="stringliteral">&#39;ﾖ&#39;</span>,
<a name="l00198"></a>00198     <span class="stringliteral">&#39;ﾜ&#39;</span>: <span class="stringliteral">&#39;ﾜ&#39;</span>, <span class="stringliteral">&#39;ｳﾞ&#39;</span>: <span class="stringliteral">&#39;ｳ&#39;</span>
<a name="l00199"></a>00199   };
<a name="l00200"></a>00200 
<a name="l00201"></a>00201   <span class="comment">// Get key info accoring to previous key and current key</span>
<a name="l00202"></a>00202   <span class="comment">// If current key is the first element of a line</span>
<a name="l00203"></a>00203   <span class="comment">//   and previous key is in the same line,</span>
<a name="l00204"></a>00204   <span class="comment">//   the next key after previous key returns</span>
<a name="l00205"></a>00205   <span class="comment">// Otherwise, current key returns</span>
<a name="l00206"></a>00206   var getNextKeyInfo = <span class="keyword">function</span> ime_getNextKeyInfo(prevK, currK) {
<a name="l00207"></a>00207     var <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a> = IMEHiraganaCycleTable[IMEKeyMap[currK]];
<a name="l00208"></a>00208     var <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a> = line.length;
<a name="l00209"></a>00209     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l00210"></a>00210     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>; i++) {
<a name="l00211"></a>00211       <span class="keywordflow">if</span> (line[i] === prevK) {
<a name="l00212"></a>00212         <span class="keywordflow">return</span> [<span class="keyword">true</span>, line[(i + 1) % len]];
<a name="l00213"></a>00213       }
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     <span class="keywordflow">return</span> [<span class="keyword">false</span>, currK];
<a name="l00216"></a>00216   };
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   <span class="comment">// see `getNextKeyInfo`</span>
<a name="l00219"></a>00219   <span class="comment">// only get key in the reverse way</span>
<a name="l00220"></a>00220   var getPreviousKeyInfo = <span class="keyword">function</span> ime_getPreviousKeyInfo(currK) {
<a name="l00221"></a>00221     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>;
<a name="l00222"></a>00222     var outer_len = IMEHiraganaCycleTable.length;
<a name="l00223"></a>00223     var inner_len;
<a name="l00224"></a>00224     var <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>;
<a name="l00225"></a>00225     <span class="keywordflow">for</span> (i = 0; i &lt; outer_len; i++) {
<a name="l00226"></a>00226       line = IMEHiraganaCycleTable[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l00227"></a>00227       inner_len = line.length;
<a name="l00228"></a>00228       <span class="keywordflow">for</span> (j = 0; j &lt; inner_len; j++) {
<a name="l00229"></a>00229         <span class="keywordflow">if</span> (line[j] === currK) {
<a name="l00230"></a>00230           <span class="keywordflow">return</span> [<span class="keyword">true</span>, line[(j + inner_len - 1) % inner_len]];
<a name="l00231"></a>00231         }
<a name="l00232"></a>00232       }
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="keywordflow">return</span> [<span class="keyword">false</span>, <span class="stringliteral">&#39;&#39;</span>];
<a name="l00236"></a>00236   };
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   var getPosInfoByChar = <span class="keyword">function</span> ime_getPosInfoByChar(ch) {
<a name="l00239"></a>00239     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>;
<a name="l00240"></a>00240     var <a class="code" href="../../d3/d82/prlink_8h.html#aae95f41aa336f8375a3415100cf9ffd4">table</a> = IMEHiraganaCycleTable;
<a name="l00241"></a>00241     <span class="keywordflow">for</span> (i = 0; i &lt; table.length; i++) {
<a name="l00242"></a>00242       <span class="keywordflow">for</span> (j = 0; j &lt; table[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].length; j++) {
<a name="l00243"></a>00243         <span class="keywordflow">if</span> (table[i][j] === ch) {
<a name="l00244"></a>00244           <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>];
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246       }
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248     <span class="keywordflow">return</span> [-1, -1];
<a name="l00249"></a>00249   };
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   <span class="comment">// This is a simple Japanese IME implementation.</span>
<a name="l00252"></a>00252   var IMEngine = <span class="keyword">function</span> ime() {
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="comment">// keep a local copy</span>
<a name="l00255"></a>00255     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="comment">// Glue contains some callback functions</span>
<a name="l00258"></a>00258     var _glue;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <span class="comment">// Query dict</span>
<a name="l00261"></a>00261     var _dict = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <span class="comment">// Enable IndexedDB</span>
<a name="l00264"></a>00264     var _enableIndexedDB = <span class="keyword">true</span>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="comment">// Max length to predict</span>
<a name="l00267"></a>00267     var _dictMaxPredictLength = 20;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="comment">// Input buffer</span>
<a name="l00270"></a>00270     <span class="comment">// NOTICE `_inputBuf` only contains Hiragana</span>
<a name="l00271"></a>00271     var _inputBuf = [];
<a name="l00272"></a>00272     <span class="comment">// Candidate list to be displayed</span>
<a name="l00273"></a>00273     <span class="comment">// candidate is [kanji, kana]</span>
<a name="l00274"></a>00274     var _candidateList = [];
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="comment">// First term info in candidate list</span>
<a name="l00277"></a>00277     <span class="comment">// used for transforming</span>
<a name="l00278"></a>00278     var _firstKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00279"></a>00279     var _firstKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <span class="comment">// Previous selected term info</span>
<a name="l00282"></a>00282     <span class="comment">// used to generate suggestions</span>
<a name="l00283"></a>00283     var _selectedKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00284"></a>00284     var _selectedKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">// Code of previous key pressed</span>
<a name="l00287"></a>00287     var _previousKeycode = 0;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     <span class="comment">// Current keyboard</span>
<a name="l00290"></a>00290     var _currLayout = IMELayouts.JP;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     var KeyMode = {
<a name="l00293"></a>00293       <span class="stringliteral">&#39;NORMAL&#39;</span>: 0,
<a name="l00294"></a>00294       <span class="stringliteral">&#39;TRANSFORM&#39;</span>: 1,
<a name="l00295"></a>00295       <span class="stringliteral">&#39;SELECT&#39;</span>: 2,
<a name="l00296"></a>00296       <span class="stringliteral">&#39;H2K&#39;</span>: 3
<a name="l00297"></a>00297     };
<a name="l00298"></a>00298     var _keyMode = KeyMode.NORMAL;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     var _keyboardMode = IMEMode.FULL_HIRAGANA;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     var _layoutPage = <a class="code" href="../../d1/dbd/apps_2keyboard_2js_2keyboard_8js.html#acc6d7562424bcfd96df0d244843dc884">LAYOUT_PAGE_DEFAULT</a>;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     <span class="comment">// ** The following functions are compulsory functions in IME</span>
<a name="l00305"></a>00305     <span class="comment">// and explicitly called in `keyboard.js` **</span>
<a name="l00306"></a>00306     <span class="comment">//</span>
<a name="l00307"></a>00307     this.<a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a> = <span class="keyword">function</span> ime_init(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>) {
<a name="l00308"></a>00308       <span class="comment">//debug(&#39;init&#39;);</span>
<a name="l00309"></a>00309       _glue = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>;
<a name="l00310"></a>00310     };
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     this.<a class="code" href="../../d3/d44/updatable_8js.html#a0a545f3fc3649048e3c5c41303a26cc3">uninit</a> = <span class="keyword">function</span> ime_uninit() {
<a name="l00313"></a>00313       <span class="keywordflow">if</span> (_dict) {
<a name="l00314"></a>00314         _dict.uninit();
<a name="l00315"></a>00315         _dict = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00316"></a>00316       }
<a name="l00317"></a>00317       <span class="keyword">self</span>.empty();
<a name="l00318"></a>00318     };
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     this.click = <span class="keyword">function</span> ime_click(keyCode) {
<a name="l00321"></a>00321       <span class="keywordflow">if</span> (_layoutPage !== <a class="code" href="../../d1/dbd/apps_2keyboard_2js_2keyboard_8js.html#acc6d7562424bcfd96df0d244843dc884">LAYOUT_PAGE_DEFAULT</a>) {
<a name="l00322"></a>00322         _glue.sendKey(keyCode);
<a name="l00323"></a>00323         <span class="keywordflow">return</span>;
<a name="l00324"></a>00324       }
<a name="l00325"></a>00325       <span class="comment">//debug(&#39;click &#39; + keyCode);</span>
<a name="l00326"></a>00326       <span class="comment">// push keyCode to working queue</span>
<a name="l00327"></a>00327       qPush(keyCode);
<a name="l00328"></a>00328       qNext();
<a name="l00329"></a>00329     };
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     this.<a class="code" href="../../d1/dbd/apps_2keyboard_2js_2keyboard_8js.html#a86ee62b3aff5d19be8a82edbafb2967d">setLayoutPage</a> = <span class="keyword">function</span> ime_setLayoutPage(<a class="code" href="../../d7/d9d/time__test_8js.html#a9b03e8a9f4440c3c0c605b05ef1b0885">page</a>) {
<a name="l00332"></a>00332       _layoutPage = <a class="code" href="../../d7/d9d/time__test_8js.html#a9b03e8a9f4440c3c0c605b05ef1b0885">page</a>;
<a name="l00333"></a>00333     };
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     this.<a class="code" href="../../dd/d6d/mock__spinner_8js.html#acbaa526812f5b09f5e4582d5b59adf8b">select</a> = <span class="keyword">function</span> ime_select(<a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a>, <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>) {
<a name="l00336"></a>00336       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;select &#39;</span> + <a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a> + <span class="charliteral">&#39; &#39;</span> + <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>);
<a name="l00337"></a>00337       _glue.sendString(<a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a>);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339       _inputBuf.splice(0, <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>.length);
<a name="l00340"></a>00340       _selectedKanji = <a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a>;
<a name="l00341"></a>00341       _selectedKana = <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343       <span class="keywordflow">if</span> (_inputBuf.length === 0) {
<a name="l00344"></a>00344         _firstKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00345"></a>00345         _firstKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00346"></a>00346         _keyMode = KeyMode.NORMAL;
<a name="l00347"></a>00347       }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349       <span class="comment">// reset</span>
<a name="l00350"></a>00350       _previousKeycode = 0;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       qPush(0);
<a name="l00353"></a>00353       qNext();
<a name="l00354"></a>00354     };
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     this.empty = <span class="keyword">function</span> ime_empty() {
<a name="l00357"></a>00357       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;empty buffer.&#39;</span>);
<a name="l00358"></a>00358       _inputBuf = [];
<a name="l00359"></a>00359       _selectedKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00360"></a>00360       _selectedKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00361"></a>00361       _keyMode = KeyMode.NORMAL;
<a name="l00362"></a>00362       _keyboardMode = IMEMode.FULL_HIRAGANA;
<a name="l00363"></a>00363       _previousKeycode = 0;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365       sendPendingSymbols();
<a name="l00366"></a>00366       _qIsWorking = <span class="keyword">false</span>;
<a name="l00367"></a>00367       <span class="keywordflow">if</span> (!_dict) {
<a name="l00368"></a>00368         <a class="code" href="../../d0/da2/gallery_8js.html#aa3ad0f72d51416a18a4336efa0b2b3cf">initDB</a>();
<a name="l00369"></a>00369       }
<a name="l00370"></a>00370     };
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     this.activate = <span class="keyword">function</span> ime_activate(<a class="code" href="../../d6/d45/prerror_8h.html#a5b8860d15e47932f3ec6f41c96dcb857">language</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>) {
<a name="l00373"></a>00373       var inputType = <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.type;
<a name="l00374"></a>00374       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Activate. Input type: &#39;</span> + inputType);
<a name="l00375"></a>00375       var layout = IMELayouts.JP;
<a name="l00376"></a>00376       <span class="keywordflow">if</span> (inputType === <span class="stringliteral">&#39;&#39;</span> || inputType === <span class="stringliteral">&#39;text&#39;</span> ||
<a name="l00377"></a>00377           inputType === <span class="stringliteral">&#39;textarea&#39;</span>) {
<a name="l00378"></a>00378         layout = _currLayout;
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381       _glue.alterKeyboard(layout);
<a name="l00382"></a>00382     };
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 
<a name="l00386"></a>00386     <span class="comment">// A *queue* contains all keys pressed</span>
<a name="l00387"></a>00387     var _keyQueue = [];
<a name="l00388"></a>00388     var _qIsWorking = <span class="keyword">false</span>;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     var qPush = <span class="keyword">function</span> queue_push(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>) {
<a name="l00391"></a>00391         _keyQueue.push(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>);
<a name="l00392"></a>00392     };
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="comment">// Start to pop key code from queue</span>
<a name="l00395"></a>00395     <span class="comment">// All logic is in `handleSpecialKey` and `handleNormalKey`</span>
<a name="l00396"></a>00396     var qNext = <span class="keyword">function</span> queue_next() {
<a name="l00397"></a>00397 
<a name="l00398"></a>00398       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;start queue working&#39;</span>);
<a name="l00399"></a>00399 
<a name="l00400"></a>00400       <span class="keywordflow">if</span> (_qIsWorking) {
<a name="l00401"></a>00401         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;queue is working. wait&#39;</span>);
<a name="l00402"></a>00402         <span class="keywordflow">return</span>;
<a name="l00403"></a>00403       }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405       _qIsWorking = <span class="keyword">true</span>;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407       <span class="keywordflow">if</span> (!_dict) {
<a name="l00408"></a>00408         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;DB has not initialized, defer processing.&#39;</span>);
<a name="l00409"></a>00409         <a class="code" href="../../d0/da2/gallery_8js.html#aa3ad0f72d51416a18a4336efa0b2b3cf">initDB</a>(qNext.bind(<span class="keyword">self</span>));
<a name="l00410"></a>00410         <span class="keywordflow">return</span>;
<a name="l00411"></a>00411       }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413       <span class="keywordflow">if</span> (!_keyQueue.length) {
<a name="l00414"></a>00414         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;queue is empty&#39;</span>);
<a name="l00415"></a>00415         _qIsWorking = <span class="keyword">false</span>;
<a name="l00416"></a>00416         <span class="keywordflow">return</span>;
<a name="l00417"></a>00417       }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419       <span class="comment">// pop key code from queue</span>
<a name="l00420"></a>00420       var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a> = _keyQueue.shift();
<a name="l00421"></a>00421       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;queue pops key &#39;</span> + String.fromCharCode(code));
<a name="l00422"></a>00422 
<a name="l00423"></a>00423       <span class="keywordflow">if</span> (handleSpecialKey(code) || handleNormalKey(code)) {
<a name="l00424"></a>00424       }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426       <span class="comment">// FIXME do we need this?</span>
<a name="l00427"></a>00427       <span class="comment">// pass the key to IMEManager for default action</span>
<a name="l00428"></a>00428       <span class="comment">// and run `qNext` again before exiting</span>
<a name="l00429"></a>00429       <span class="comment">//_glue.sendKey(code);</span>
<a name="l00430"></a>00430 
<a name="l00431"></a>00431       _qIsWorking = <span class="keyword">false</span>;
<a name="l00432"></a>00432       qNext();
<a name="l00433"></a>00433     };
<a name="l00436"></a>00436     var handleNormalKey = <span class="keyword">function</span> ime_handleNormalKey(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>) {
<a name="l00437"></a>00437       var <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a> = String.fromCharCode(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>);
<a name="l00438"></a>00438       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;handleNormalKey &#39;</span> + kana);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440       <span class="comment">// set keymode</span>
<a name="l00441"></a>00441       _keyMode = KeyMode.NORMAL;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443       <span class="comment">// push kana directly if previoius key is NEXT</span>
<a name="l00444"></a>00444       <span class="keywordflow">if</span> (_previousKeycode === IMESpecialKey.NEXT) {
<a name="l00445"></a>00445         _previousKeycode = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>;
<a name="l00446"></a>00446         _inputBuf.push(kana);
<a name="l00447"></a>00447         handleInputBuf();
<a name="l00448"></a>00448         <span class="keywordflow">return</span> 1;
<a name="l00449"></a>00449       }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451       <span class="comment">// append new key code to the end of `_inputBuf`</span>
<a name="l00452"></a>00452       <span class="comment">// and begin to deal with the new buf</span>
<a name="l00453"></a>00453       <span class="keywordflow">if</span> (!(kana in IMEKeyMap)) {
<a name="l00454"></a>00454         _glue.sendString(kana);
<a name="l00455"></a>00455         <span class="keywordflow">return</span> 1;
<a name="l00456"></a>00456       }
<a name="l00457"></a>00457       <span class="keywordflow">if</span> (_previousKeycode !== IMESpecialKey.BACK &amp;&amp;
<a name="l00458"></a>00458           !(String.fromCharCode(_previousKeycode) in IMEKeyMap)) {
<a name="l00459"></a>00459         _inputBuf.push(kana);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461       } <span class="keywordflow">else</span> {
<a name="l00462"></a>00462         var prevKana = _inputBuf[_inputBuf.length - 1];
<a name="l00463"></a>00463         var nextKeyInfo = getNextKeyInfo(prevKana, kana);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         <span class="keywordflow">if</span> (nextKeyInfo[0]) {
<a name="l00466"></a>00466           _inputBuf[_inputBuf.length - 1] = nextKeyInfo[1];
<a name="l00467"></a>00467         } <span class="keywordflow">else</span> {
<a name="l00468"></a>00468           _inputBuf.push(nextKeyInfo[1]);
<a name="l00469"></a>00469         }
<a name="l00470"></a>00470       }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472       handleInputBuf();
<a name="l00473"></a>00473       _previousKeycode = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>;
<a name="l00474"></a>00474       <span class="keywordflow">return</span> 1;
<a name="l00475"></a>00475     };
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     var handleSpecialKey = <span class="keyword">function</span> ime_handleSpecialKey(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>) {
<a name="l00478"></a>00478 
<a name="l00479"></a>00479       var immiReturn = <span class="keyword">true</span>;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481       <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>) {
<a name="l00482"></a>00482 
<a name="l00483"></a>00483         <span class="keywordflow">case</span> 32:
<a name="l00484"></a>00484           <span class="comment">// Space</span>
<a name="l00485"></a>00485           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;space&#39;</span>);
<a name="l00486"></a>00486           _glue.sendString(<span class="charliteral">&#39; &#39;</span>);
<a name="l00487"></a>00487           <span class="keywordflow">break</span>;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         <span class="keywordflow">case</span> 0:
<a name="l00490"></a>00490           <span class="comment">// This is a select function operation.</span>
<a name="l00491"></a>00491           handleInputBuf();
<a name="l00492"></a>00492           <span class="keywordflow">break</span>;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <span class="comment">// cycle the IMEHiraganaCycleTable in reversal direction</span>
<a name="l00495"></a>00495         <span class="comment">// Ex.</span>
<a name="l00496"></a>00496         <span class="comment">//   [&#39;あ&#39;, &#39;い&#39;, &#39;う&#39;, &#39;え&#39;, &#39;お&#39;, &#39;ぁ&#39;, &#39;ぃ&#39;, &#39;ぅ&#39;, &#39;ぇ&#39;, &#39;ぉ&#39;]</span>
<a name="l00497"></a>00497         <span class="comment">//   is the cycle table of あ</span>
<a name="l00498"></a>00498         <span class="comment">//   あ will be displayed when user click BACK</span>
<a name="l00499"></a>00499         <span class="comment">//   while い is the current char</span>
<a name="l00500"></a>00500         <span class="keywordflow">case</span> IMESpecialKey.BACK:
<a name="l00501"></a>00501           var <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a> = getPreviousKeyInfo(_inputBuf[_inputBuf.length - 1]);
<a name="l00502"></a>00502           <span class="keywordflow">if</span> (info[0]) {
<a name="l00503"></a>00503             _inputBuf[_inputBuf.length - 1] = info[1];
<a name="l00504"></a>00504           }
<a name="l00505"></a>00505           handleInputBuf();
<a name="l00506"></a>00506           <span class="keywordflow">break</span>;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <span class="keywordflow">case</span> IMESpecialKey.PREVIOUS:
<a name="l00509"></a>00509           <span class="keywordflow">if</span> (_keyMode === KeyMode.NORMAL &amp;&amp; _inputBuf.length &gt; 0) {
<a name="l00510"></a>00510             _keyMode = KeyMode.SELECT;
<a name="l00511"></a>00511             handlePorN(_inputBuf);
<a name="l00512"></a>00512             <span class="keywordflow">break</span>;
<a name="l00513"></a>00513           }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515           <span class="keywordflow">if</span> (_firstKana.length === 1) {
<a name="l00516"></a>00516             _keyMode = KeyMode.NORMAL;
<a name="l00517"></a>00517             handleInputBuf();
<a name="l00518"></a>00518             <span class="keywordflow">break</span>;
<a name="l00519"></a>00519           }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521           <span class="keywordflow">if</span> (_keyMode === KeyMode.SELECT || _keyMode === KeyMode.TRANSFORM) {
<a name="l00522"></a>00522             handlePorN(_inputBuf.slice(0, _firstKana.length - 1));
<a name="l00523"></a>00523 
<a name="l00524"></a>00524           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.H2K) {
<a name="l00525"></a>00525             handleH2K(_inputBuf.slice(0, _firstKana.length - 1));
<a name="l00526"></a>00526           }
<a name="l00527"></a>00527           <span class="keywordflow">break</span>;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529         <span class="keywordflow">case</span> IMESpecialKey.NEXT:
<a name="l00530"></a>00530           <span class="keywordflow">if</span> (_keyMode === KeyMode.NORMAL &amp;&amp; _inputBuf.length &gt; 0) {
<a name="l00531"></a>00531             <span class="comment">//_keyMode = KeyMode.SELECT;</span>
<a name="l00532"></a>00532             <span class="comment">//handlePorN(_inputBuf.slice(0, 1));</span>
<a name="l00533"></a>00533             <span class="keywordflow">break</span>;
<a name="l00534"></a>00534           }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536           <span class="keywordflow">if</span> (_firstKana.length === _inputBuf.length) {
<a name="l00537"></a>00537             _keyMode = KeyMode.NORMAL;
<a name="l00538"></a>00538             handleInputBuf();
<a name="l00539"></a>00539             <span class="keywordflow">break</span>;
<a name="l00540"></a>00540           }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542           <span class="keywordflow">if</span> (_keyMode === KeyMode.SELECT || _keyMode === KeyMode.TRANSFORM) {
<a name="l00543"></a>00543             handlePorN(_inputBuf.slice(0, _firstKana.length + 1));
<a name="l00544"></a>00544           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.H2K) {
<a name="l00545"></a>00545             handleH2K(_inputBuf.slice(0, _firstKana.length + 1));
<a name="l00546"></a>00546           }
<a name="l00547"></a>00547           <span class="keywordflow">break</span>;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549         <span class="comment">// Transform key</span>
<a name="l00550"></a>00550         <span class="keywordflow">case</span> IMESpecialKey.TRANSFORM:
<a name="l00551"></a>00551           <span class="keywordflow">if</span> (_keyMode === KeyMode.TRANSFORM &amp;&amp;
<a name="l00552"></a>00552               _previousKeycode !== IMESpecialKey.TRANSFORM) {
<a name="l00553"></a>00553             <span class="keywordflow">break</span>;
<a name="l00554"></a>00554           }
<a name="l00555"></a>00555           <span class="keywordflow">if</span> (_inputBuf.length === 0) {
<a name="l00556"></a>00556             _glue.sendString(<span class="charliteral">&#39; &#39;</span>);
<a name="l00557"></a>00557             <span class="keywordflow">break</span>;
<a name="l00558"></a>00558           }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560           _keyMode = KeyMode.TRANSFORM;
<a name="l00561"></a>00561           handleTransform();
<a name="l00562"></a>00562           <span class="keywordflow">break</span>;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564         <span class="comment">// Hiragana, full-width katakana and half-width katakana convertor</span>
<a name="l00565"></a>00565         <span class="keywordflow">case</span> IMESpecialKey.H2K:
<a name="l00566"></a>00566           <span class="keywordflow">if</span> (_inputBuf.length === 0) {
<a name="l00567"></a>00567             <span class="keywordflow">break</span>;
<a name="l00568"></a>00568           }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570           <span class="keywordflow">if</span> (_keyMode === KeyMode.H2K) {
<a name="l00571"></a>00571             _keyMode = KeyMode.SELECT;
<a name="l00572"></a>00572             handlePorN(_inputBuf.slice(0, _firstKana.length));
<a name="l00573"></a>00573           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.NORMAL) {
<a name="l00574"></a>00574             _keyMode = KeyMode.H2K;
<a name="l00575"></a>00575             _firstKanji = SyllableUtils.arrayToString(_inputBuf);
<a name="l00576"></a>00576             _firstKana = _firstKanji;
<a name="l00577"></a>00577             handleH2K(_inputBuf.slice(0, _firstKana.length));
<a name="l00578"></a>00578           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.TRANSFORM ||
<a name="l00579"></a>00579                      _keyMode === KeyMode.SELECT) {
<a name="l00580"></a>00580             _keyMode = KeyMode.H2K;
<a name="l00581"></a>00581             handleH2K(_inputBuf.slice(0, _firstKana.length));
<a name="l00582"></a>00582           }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584           <span class="keywordflow">break</span>;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="comment">// 大 &lt;-&gt; 小</span>
<a name="l00587"></a>00587         <span class="keywordflow">case</span> IMESpecialKey.CASE_CHANGE:
<a name="l00588"></a>00588           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;case change&#39;</span>);
<a name="l00589"></a>00589           var last = _inputBuf[_inputBuf.length - 1];
<a name="l00590"></a>00590           var res = IMEHiraganaCaseTable[last];
<a name="l00591"></a>00591           <span class="keywordflow">if</span> (!res) {
<a name="l00592"></a>00592             res = IMEFullKatakanaCaseTable[last];
<a name="l00593"></a>00593           }
<a name="l00594"></a>00594           <span class="keywordflow">if</span> (!res) {
<a name="l00595"></a>00595             res = IMEHalfKatakanaCaseTable[last];
<a name="l00596"></a>00596             <span class="keywordflow">break</span>;
<a name="l00597"></a>00597           }
<a name="l00598"></a>00598           <span class="keywordflow">if</span> (!res) {
<a name="l00599"></a>00599             <span class="keywordflow">break</span>;
<a name="l00600"></a>00600           }
<a name="l00601"></a>00601           _inputBuf[_inputBuf.length - 1] = res;
<a name="l00602"></a>00602           handleInputBuf();
<a name="l00603"></a>00603           <span class="keywordflow">break</span>;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         <span class="keywordflow">case</span> IMESpecialKey.CAPSLOCK:
<a name="l00606"></a>00606           <span class="keywordflow">if</span> (_currLayout === IMELayouts.EN) {
<a name="l00607"></a>00607             alterKeyboard(IMELayouts[<span class="stringliteral">&#39;EN-CAPS&#39;</span>]);
<a name="l00608"></a>00608           } <span class="keywordflow">else</span> {
<a name="l00609"></a>00609             alterKeyboard(IMELayouts.EN);
<a name="l00610"></a>00610           }
<a name="l00611"></a>00611           <span class="keywordflow">break</span>;
<a name="l00612"></a>00612 
<a name="l00613"></a>00613         <span class="comment">// Switch to basic layout</span>
<a name="l00614"></a>00614         <span class="keywordflow">case</span> IMESpecialKey.BASIC_LAYOUT:
<a name="l00615"></a>00615           alterKeyboard(IMELayouts.JP);
<a name="l00616"></a>00616           <span class="keywordflow">break</span>;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         <span class="comment">// Switch to english layout</span>
<a name="l00619"></a>00619         <span class="keywordflow">case</span> IMESpecialKey.EN_LAYOUT:
<a name="l00620"></a>00620           alterKeyboard(IMELayouts.EN);
<a name="l00621"></a>00621           <span class="keywordflow">break</span>;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623         <span class="comment">// Switch to number layout</span>
<a name="l00624"></a>00624         <span class="keywordflow">case</span> IMESpecialKey.NUM_LAYOUT:
<a name="l00625"></a>00625           alterKeyboard(IMELayouts.NUM);
<a name="l00626"></a>00626           <span class="keywordflow">break</span>;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628         <span class="comment">// Default key event</span>
<a name="l00629"></a>00629         <span class="keywordflow">case</span> <a class="code" href="../../d5/d0e/namespacemozilla_1_1dom_1_1constructors_1_1id.html#ad394f5385b88a41941d5965c814a8c47a0866b43a9f8b2707c848ee125a00a2d8">KeyEvent</a>.DOM_VK_RETURN:
<a name="l00630"></a>00630           handleReturn();
<a name="l00631"></a>00631           <span class="keywordflow">break</span>;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="comment">// Default key event</span>
<a name="l00634"></a>00634         <span class="keywordflow">case</span> <a class="code" href="../../d5/d0e/namespacemozilla_1_1dom_1_1constructors_1_1id.html#ad394f5385b88a41941d5965c814a8c47a0866b43a9f8b2707c848ee125a00a2d8">KeyEvent</a>.DOM_VK_BACK_SPACE:
<a name="l00635"></a>00635           handleBackspace();
<a name="l00636"></a>00636           <span class="keywordflow">break</span>;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638         <span class="comment">//</span>
<a name="l00639"></a>00639         <span class="keywordflow">case</span> IMESpecialKey.MARK:
<a name="l00640"></a>00640           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(_inputBuf.length);
<a name="l00641"></a>00641           <span class="keywordflow">if</span> (_inputBuf.length !== 0) {
<a name="l00642"></a>00642             _glue.sendString(SyllableUtils.arrayToString(_inputBuf));
<a name="l00643"></a>00643             _inputBuf = [];
<a name="l00644"></a>00644             _firstKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00645"></a>00645             _firstKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00646"></a>00646             sendPendingSymbols();
<a name="l00647"></a>00647           }
<a name="l00648"></a>00648           <span class="keywordflow">if</span> (_previousKeycode === IMESpecialKey.MARK &amp;&amp;
<a name="l00649"></a>00649               _candidateList[0] === <span class="stringliteral">&#39;、&#39;</span>) {
<a name="l00650"></a>00650             _candidateList = IMEHalfWidthCharactorCandidateList;
<a name="l00651"></a>00651           } <span class="keywordflow">else</span> {
<a name="l00652"></a>00652             _candidateList = IMEFullWidthCharactorCandidateList;
<a name="l00653"></a>00653           }
<a name="l00654"></a>00654           updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l00655"></a>00655           <span class="keywordflow">break</span>;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657         <span class="keywordflow">default</span>:
<a name="l00658"></a>00658           immiReturn = <span class="keyword">false</span>;
<a name="l00659"></a>00659           <span class="keywordflow">break</span>;
<a name="l00660"></a>00660       }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 
<a name="l00663"></a>00663       <span class="keywordflow">if</span> (immiReturn) {
<a name="l00664"></a>00664         _previousKeycode = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>;
<a name="l00665"></a>00665         <span class="keywordflow">return</span> 1;
<a name="l00666"></a>00666       }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668       _keyMode = KeyMode.NORMAL;
<a name="l00669"></a>00669       _keyboardMode = IMEMode.FULL_HIRAGANA;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671       <span class="comment">// Ignore key code less than 0</span>
<a name="l00672"></a>00672       <span class="comment">// except those special code above</span>
<a name="l00673"></a>00673       <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a> &lt;= 0) {
<a name="l00674"></a>00674         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;ignore meaningless key code &lt;= 0&#39;</span>);
<a name="l00675"></a>00675         <span class="keywordflow">return</span> 1;
<a name="l00676"></a>00676       }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678       <span class="keywordflow">return</span> 0;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680     };
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     var alterKeyboard = <span class="keyword">function</span> ime_alterKeyboard(layout) {
<a name="l00683"></a>00683       _currLayout = layout;
<a name="l00684"></a>00684       <span class="keyword">self</span>.empty();
<a name="l00685"></a>00685       _glue.alterKeyboard(layout);
<a name="l00686"></a>00686     };
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     var handleH2K = <span class="keyword">function</span> ime_handleH2K(kanaArr) {
<a name="l00689"></a>00689       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;handleH2K &#39;</span> + kanaArr);
<a name="l00690"></a>00690       <span class="comment">// Send pending symbols to highlight `_firstKanji`</span>
<a name="l00691"></a>00691       _firstKanji = SyllableUtils.arrayToString(kanaArr);
<a name="l00692"></a>00692       _firstKana = SyllableUtils.arrayToString(kanaArr);
<a name="l00693"></a>00693       sendPendingSymbols();
<a name="l00694"></a>00694 
<a name="l00695"></a>00695       updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l00696"></a>00696     };
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     var handlePorN = <span class="keyword">function</span> ime_handlePorN(kanaArr) {
<a name="l00699"></a>00699       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;handlePorN &#39;</span> + kanaArr);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701       var __getTermsCallback1 = <span class="keyword">function</span> handlePorN_getTermsCallback1(terms) {
<a name="l00702"></a>00702         <span class="keywordflow">if</span> (terms.length) {
<a name="l00703"></a>00703           _firstKana = terms[0].kana;
<a name="l00704"></a>00704           _firstKanji = terms[0].kanji;
<a name="l00705"></a>00705         } <span class="keywordflow">else</span> {
<a name="l00706"></a>00706           _firstKana = SyllableUtils.arrayToString(kanaArr);
<a name="l00707"></a>00707           _firstKanji = SyllableUtils.arrayToString(kanaArr);
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709       };
<a name="l00710"></a>00710 
<a name="l00711"></a>00711       var __getTermsCallback2 = <span class="keyword">function</span> handlePorN_getTermsCallback2(terms) {
<a name="l00712"></a>00712         var candidates = [];
<a name="l00713"></a>00713 
<a name="l00714"></a>00714         terms.forEach(<span class="keyword">function</span> readTerm(term) {
<a name="l00715"></a>00715           candidates.push([term.kanji, term.kana]);
<a name="l00716"></a>00716         });
<a name="l00717"></a>00717 
<a name="l00718"></a>00718         <span class="keywordflow">if</span> (!candidates.length) {
<a name="l00719"></a>00719           candidates.push([_firstKanji, _firstKana]);
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         _candidateList = candidates.slice();
<a name="l00723"></a>00723         <span class="keywordflow">return</span>;
<a name="l00724"></a>00724       };
<a name="l00725"></a>00725 
<a name="l00726"></a>00726       <span class="comment">// update _firstKana and _firstKanji</span>
<a name="l00727"></a>00727       _dict.getTerms(kanaArr, __getTermsCallback1);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;firstTerm  &#39;</span> + _firstKanji + <span class="charliteral">&#39; &#39;</span> + _firstKana);
<a name="l00730"></a>00730 
<a name="l00731"></a>00731       <span class="comment">// Send pending symbols to highlight `_firstKana`</span>
<a name="l00732"></a>00732       sendPendingSymbols();
<a name="l00733"></a>00733 
<a name="l00734"></a>00734       <span class="comment">// get candidates by _firstKana</span>
<a name="l00735"></a>00735       _dict.getTerms(SyllableUtils.arrayFromString(_firstKana),
<a name="l00736"></a>00736                      __getTermsCallback2);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738       updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l00739"></a>00739     };
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     var handleReturn = <span class="keyword">function</span> ime_handleReturn() {
<a name="l00742"></a>00742       <span class="keywordflow">if</span> (_keyMode === KeyMode.TRANSFORM) {
<a name="l00743"></a>00743         <span class="keywordflow">if</span> (_firstKana === 0) {
<a name="l00744"></a>00744           <span class="keywordflow">return</span>;
<a name="l00745"></a>00745         }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;handle return in transform mode or select mode&#39;</span>);
<a name="l00748"></a>00748         <span class="comment">// select first term</span>
<a name="l00749"></a>00749         _glue.sendString(_firstKanji);
<a name="l00750"></a>00750         _inputBuf.splice(0, _firstKana.length);
<a name="l00751"></a>00751 
<a name="l00752"></a>00752         <span class="comment">// query to generate first term</span>
<a name="l00753"></a>00753         queryDict();
<a name="l00754"></a>00754 
<a name="l00755"></a>00755         <span class="comment">// do exactly like transforming</span>
<a name="l00756"></a>00756         handleTransform();
<a name="l00757"></a>00757         <span class="keywordflow">return</span>;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.H2K) {
<a name="l00760"></a>00760         var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> = -1;
<a name="l00761"></a>00761         <span class="keywordflow">if</span> (_keyboardMode === IMEMode.FULL_HIRAGANA) {
<a name="l00762"></a>00762           mode = IMEMode.HALF_KATAKANA;
<a name="l00763"></a>00763         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyboardMode === IMEMode.FULL_KATAKANA) {
<a name="l00764"></a>00764           mode = IMEMode.FULL_HIRAGANA;
<a name="l00765"></a>00765         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyboardMode === IMEMode.HALF_KATAKANA) {
<a name="l00766"></a>00766           mode = IMEMode.FULL_KATAKANA;
<a name="l00767"></a>00767         }
<a name="l00768"></a>00768         _glue.sendString(_getPossibleStrings(mode)[0]);
<a name="l00769"></a>00769         _inputBuf = [];
<a name="l00770"></a>00770         _candidateList = [];
<a name="l00771"></a>00771         _keyboardMode = IMEMode.FULL_HIRAGANA;
<a name="l00772"></a>00772         _keyMode = KeyMode.NORMAL;
<a name="l00773"></a>00773         sendPendingSymbols();
<a name="l00774"></a>00774         updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l00775"></a>00775 
<a name="l00776"></a>00776       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.SELECT) {
<a name="l00777"></a>00777         <span class="keywordflow">if</span> (_firstKana === 0) {
<a name="l00778"></a>00778           <span class="keywordflow">return</span>;
<a name="l00779"></a>00779         }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;handle return in transform mode or select mode&#39;</span>);
<a name="l00782"></a>00782         <span class="comment">// select first term</span>
<a name="l00783"></a>00783         _glue.sendString(_firstKanji);
<a name="l00784"></a>00784         _inputBuf.splice(0, _firstKana.length);
<a name="l00785"></a>00785 
<a name="l00786"></a>00786         <span class="comment">// query to generate first term</span>
<a name="l00787"></a>00787         queryDict();
<a name="l00788"></a>00788 
<a name="l00789"></a>00789         handlePorN(_inputBuf.slice(0, _firstKana.length));
<a name="l00790"></a>00790         <span class="keywordflow">return</span>;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792       } <span class="keywordflow">else</span> {
<a name="l00793"></a>00793         <span class="keywordflow">if</span> (_firstKana.length &gt; 0) {
<a name="l00794"></a>00794           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;first term &#39;</span> + _firstKanji + <span class="charliteral">&#39; &#39;</span> + _firstKana);
<a name="l00795"></a>00795           _glue.sendString(_firstKanji);
<a name="l00796"></a>00796           _inputBuf.splice(0, _firstKana.length);
<a name="l00797"></a>00797           handleInputBuf();
<a name="l00798"></a>00798 
<a name="l00799"></a>00799         } <span class="keywordflow">else</span> {
<a name="l00800"></a>00800           _glue.sendKey(<a class="code" href="../../d5/d0e/namespacemozilla_1_1dom_1_1constructors_1_1id.html#ad394f5385b88a41941d5965c814a8c47a0866b43a9f8b2707c848ee125a00a2d8">KeyEvent</a>.DOM_VK_RETURN);
<a name="l00801"></a>00801         }
<a name="l00802"></a>00802       }
<a name="l00803"></a>00803     };
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     var handleBackspace = <span class="keyword">function</span> ime_handleBackspace() {
<a name="l00806"></a>00806       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Backspace key&#39;</span>);
<a name="l00807"></a>00807 
<a name="l00808"></a>00808       <span class="keywordflow">if</span> (_inputBuf.length === 0) {
<a name="l00809"></a>00809         _firstKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00810"></a>00810         _firstKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00811"></a>00811         _candidateList = [];
<a name="l00812"></a>00812 
<a name="l00813"></a>00813         <span class="comment">// pass the key to IMEManager for default action</span>
<a name="l00814"></a>00814         _glue.sendKey(<a class="code" href="../../d5/d0e/namespacemozilla_1_1dom_1_1constructors_1_1id.html#ad394f5385b88a41941d5965c814a8c47a0866b43a9f8b2707c848ee125a00a2d8">KeyEvent</a>.DOM_VK_BACK_SPACE);
<a name="l00815"></a>00815         handleInputBuf();
<a name="l00816"></a>00816         <span class="keywordflow">return</span>;
<a name="l00817"></a>00817       }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819       _inputBuf.pop();
<a name="l00820"></a>00820       handleInputBuf();
<a name="l00821"></a>00821     };
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     var handleTransform = <span class="keyword">function</span> ime_handleTransform() {
<a name="l00824"></a>00824       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;handleTransform&#39;</span>);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826       <span class="keywordflow">if</span> (!_inputBuf.length) {
<a name="l00827"></a>00827         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;empty input buf, return&#39;</span>);
<a name="l00828"></a>00828         handleInputBuf();
<a name="l00829"></a>00829         <span class="keywordflow">return</span>;
<a name="l00830"></a>00830       }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832       <span class="comment">// Send pending symbols to highlight `_firstKana`</span>
<a name="l00833"></a>00833       sendPendingSymbols();
<a name="l00834"></a>00834 
<a name="l00835"></a>00835       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;firstTerm  &#39;</span> + _firstKanji + <span class="charliteral">&#39; &#39;</span> + _firstKana);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837       <span class="comment">// get candidates by _firstKana</span>
<a name="l00838"></a>00838       var __getTermsCallback =
<a name="l00839"></a>00839         <span class="keyword">function</span> handleTransform_getTermsCallback(terms) {
<a name="l00840"></a>00840 
<a name="l00841"></a>00841         var candidates = [];
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         terms.forEach(<span class="keyword">function</span> readTerm(term) {
<a name="l00844"></a>00844           candidates.push([term.kanji, term.kana]);
<a name="l00845"></a>00845         });
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         <span class="keywordflow">if</span> (!candidates.length) {
<a name="l00848"></a>00848           candidates.push([_firstKanji, _firstKana]);
<a name="l00849"></a>00849         }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851         _candidateList = candidates.slice();
<a name="l00852"></a>00852         <span class="keywordflow">return</span>;
<a name="l00853"></a>00853       };
<a name="l00854"></a>00854 
<a name="l00855"></a>00855       <span class="comment">// only query `_firstKana`</span>
<a name="l00856"></a>00856       _dict.getTerms(SyllableUtils.arrayFromString(_firstKana),
<a name="l00857"></a>00857                      __getTermsCallback);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859       updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l00860"></a>00860     };
<a name="l00861"></a>00861 
<a name="l00862"></a>00862     <span class="comment">// query, update pending symbols and candidate syllables</span>
<a name="l00863"></a>00863     <span class="comment">// these three processes normally conbind as one</span>
<a name="l00864"></a>00864     var handleInputBuf = <span class="keyword">function</span> ime_handleInputBuf() {
<a name="l00865"></a>00865       queryDict();
<a name="l00866"></a>00866     };
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="comment">// Query dict, result will be used in sendPendingSymbols</span>
<a name="l00869"></a>00869     <span class="comment">//  and updateCandidateList</span>
<a name="l00870"></a>00870     var queryDict = <span class="keyword">function</span> ime_queryDict() {
<a name="l00871"></a>00871 
<a name="l00872"></a>00872       var candidates = [];
<a name="l00873"></a>00873 
<a name="l00874"></a>00874       <span class="keywordflow">if</span> (_inputBuf.length === 0) {
<a name="l00875"></a>00875         <span class="keywordflow">if</span> (_selectedKana.length) {
<a name="l00876"></a>00876           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Buffer is empty; &#39;</span> +
<a name="l00877"></a>00877             <span class="stringliteral">&#39;make suggestions based on select term.&#39;</span> + _selectedKanji);
<a name="l00878"></a>00878 
<a name="l00879"></a>00879           var <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a> = _selectedKana;
<a name="l00880"></a>00880           var <a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a> = _selectedKanji;
<a name="l00881"></a>00881           _selectedKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00882"></a>00882           _selectedKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00883"></a>00883           _candidateList = [];
<a name="l00884"></a>00884           _keyMode = KeyMode.NORMAL;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886           <span class="comment">// TODO</span>
<a name="l00887"></a>00887           _dict.getSuggestions(kana, kanji,
<a name="l00888"></a>00888             <span class="keyword">function</span>(suggestions) {
<a name="l00889"></a>00889               suggestions.forEach(
<a name="l00890"></a>00890                 <span class="keyword">function</span> suggestions_forEach(suggestion) {
<a name="l00891"></a>00891                   candidates.push(
<a name="l00892"></a>00892                     [suggestion.kanji.substr(kanji.length),
<a name="l00893"></a>00893                      <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>]);
<a name="l00894"></a>00894                 }
<a name="l00895"></a>00895               );
<a name="l00896"></a>00896               _candidateList = candidates.slice();
<a name="l00897"></a>00897             }
<a name="l00898"></a>00898           );
<a name="l00899"></a>00899 
<a name="l00900"></a>00900           sendPendingSymbols();
<a name="l00901"></a>00901           updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l00902"></a>00902           <span class="keywordflow">return</span>;
<a name="l00903"></a>00903         }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Buffer is empty; send empty candidate list.&#39;</span>);
<a name="l00906"></a>00906         _firstKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00907"></a>00907         _firstKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00908"></a>00908         _candidateList = [];
<a name="l00909"></a>00909         sendPendingSymbols();
<a name="l00910"></a>00910         updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l00911"></a>00911         <span class="keywordflow">return</span>;
<a name="l00912"></a>00912       }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914       <span class="comment">// reset</span>
<a name="l00915"></a>00915       _selectedKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00916"></a>00916       _selectedKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00917"></a>00917 
<a name="l00918"></a>00918       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Get term candidates for the entire buffer.&#39;</span>);
<a name="l00919"></a>00919 
<a name="l00920"></a>00920       var __getTermsCallback = <span class="keyword">function</span> queryDict_getTermsCallback(terms) {
<a name="l00921"></a>00921         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;queryDict getTermsCallback&#39;</span>);
<a name="l00922"></a>00922 
<a name="l00923"></a>00923         var kanaStr = SyllableUtils.arrayToString(_inputBuf);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925         <span class="keywordflow">if</span> (terms.length !== 0) {
<a name="l00926"></a>00926           _firstKanji = terms[0].kanji;
<a name="l00927"></a>00927           _firstKana = terms[0].kana;
<a name="l00928"></a>00928 
<a name="l00929"></a>00929           terms.forEach(<span class="keyword">function</span> readTerm(term) {
<a name="l00930"></a>00930             candidates.push([term.kanji, term.kana]);
<a name="l00931"></a>00931           });
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934         <span class="comment">// only one kana in buf</span>
<a name="l00935"></a>00935         <span class="keywordflow">if</span> (_inputBuf.length === 1) {
<a name="l00936"></a>00936           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Only one kana; skip other lookups.&#39;</span>);
<a name="l00937"></a>00937 
<a name="l00938"></a>00938           <span class="keywordflow">if</span> (!candidates.length) {
<a name="l00939"></a>00939             candidates.push([kanaStr, kanaStr]);
<a name="l00940"></a>00940           }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942           _candidateList = candidates.slice();
<a name="l00943"></a>00943           sendPendingSymbols();
<a name="l00944"></a>00944           updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l00945"></a>00945           <span class="keywordflow">return</span>;
<a name="l00946"></a>00946         }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948         var __getSentenceCallback = <span class="keyword">function</span> getSentenceCallback(sentence) {
<a name="l00949"></a>00949           <span class="comment">// sentence = [term, term]</span>
<a name="l00950"></a>00950 
<a name="l00951"></a>00951           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;getSentenceCallback:&#39;</span> + JSON.stringify(sentence));
<a name="l00952"></a>00952 
<a name="l00953"></a>00953           <span class="keywordflow">if</span> (sentence.length !== 0) {
<a name="l00954"></a>00954 
<a name="l00955"></a>00955             var sentenceKana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00956"></a>00956             var sentenceKanji = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958             var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960             <span class="keywordflow">for</span> (i = 0; i &lt; sentence.length; i++) {
<a name="l00961"></a>00961               sentenceKanji += sentence[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].kanji;
<a name="l00962"></a>00962               sentenceKana += sentence[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].kana;
<a name="l00963"></a>00963             }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965             var kanaStr = SyllableUtils.arrayToString(_inputBuf);
<a name="l00966"></a>00966 
<a name="l00967"></a>00967             <span class="comment">// look for candidate that is already in the list</span>
<a name="l00968"></a>00968             var exists = candidates.some(<span class="keyword">function</span> sentenceExists(candidate) {
<a name="l00969"></a>00969               <span class="keywordflow">return</span> (candidate[0] === sentenceKanji);
<a name="l00970"></a>00970             });
<a name="l00971"></a>00971 
<a name="l00972"></a>00972             <span class="keywordflow">if</span> (!exists) {
<a name="l00973"></a>00973               candidates.push([sentenceKanji, sentenceKana]);
<a name="l00974"></a>00974             }
<a name="l00975"></a>00975           }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977           <span class="comment">// The remaining candidates doesn&#39;t match the entire buffer</span>
<a name="l00978"></a>00978           <span class="comment">// these candidates helps user find the exact character/term</span>
<a name="l00979"></a>00979           <span class="comment">// s/he wants</span>
<a name="l00980"></a>00980           <span class="comment">// The remaining unmatched kanas will go through lookup</span>
<a name="l00981"></a>00981           <span class="comment">// over and over until the buffer is emptied.</span>
<a name="l00982"></a>00982           <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = Math.min(_dictMaxPredictLength, _inputBuf.length - 1);
<a name="l00983"></a>00983 
<a name="l00984"></a>00984           var ___findTerms = <span class="keyword">function</span> lookupFindTerms() {
<a name="l00985"></a>00985             <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Lookup for terms that matches first &#39;</span> + <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> + <span class="stringliteral">&#39; kanas.&#39;</span>);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987             var subBuf = _inputBuf.slice(0, <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>);
<a name="l00988"></a>00988 
<a name="l00989"></a>00989             _dict.getTerms(subBuf, <span class="keyword">function</span> lookupCallback(terms) {
<a name="l00990"></a>00990               terms.forEach(<span class="keyword">function</span> readTerm(term) {
<a name="l00991"></a>00991                 <span class="keywordflow">if</span> (_firstKana.length === 0) {
<a name="l00992"></a>00992                   _firstKana = term.kana;
<a name="l00993"></a>00993                   _firstKanji = term.kanji;
<a name="l00994"></a>00994                 }
<a name="l00995"></a>00995                 candidates.push([term.kanji, term.kana]);
<a name="l00996"></a>00996               });
<a name="l00997"></a>00997 
<a name="l00998"></a>00998               <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> === 1 &amp;&amp; !terms.length) {
<a name="l00999"></a>00999                 <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;The first kana does not make up a word,&#39;</span> +
<a name="l01000"></a>01000                   <span class="stringliteral">&#39; output the symbol.&#39;</span>);
<a name="l01001"></a>01001                 candidates.push([kanaStr, kanaStr]);
<a name="l01002"></a>01002               }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004               <span class="keywordflow">if</span> (!--<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>) {
<a name="l01005"></a>01005                 <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Done Looking.&#39;</span>);
<a name="l01006"></a>01006                 _candidateList = candidates.slice();
<a name="l01007"></a>01007                 sendPendingSymbols();
<a name="l01008"></a>01008                 updateCandidateList(qNext.bind(<span class="keyword">self</span>));
<a name="l01009"></a>01009                 <span class="keywordflow">return</span>;
<a name="l01010"></a>01010               }
<a name="l01011"></a>01011 
<a name="l01012"></a>01012               ___findTerms();
<a name="l01013"></a>01013               <span class="keywordflow">return</span>;
<a name="l01014"></a>01014             });
<a name="l01015"></a>01015           };
<a name="l01016"></a>01016 
<a name="l01017"></a>01017           ___findTerms();
<a name="l01018"></a>01018         };
<a name="l01019"></a>01019 
<a name="l01020"></a>01020         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Lookup for sentences that make up from the entire buffer&#39;</span>);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         _dict.getSentence(_inputBuf, __getSentenceCallback);
<a name="l01023"></a>01023       };
<a name="l01024"></a>01024 
<a name="l01025"></a>01025       _dict.getTerms(_inputBuf, __getTermsCallback);
<a name="l01026"></a>01026 
<a name="l01027"></a>01027     };
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     var _getPossibleStrings = <span class="keyword">function</span> ime_getPossibleStrings(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>) {
<a name="l01030"></a>01030 
<a name="l01031"></a>01031       <span class="comment">//</span>
<a name="l01032"></a>01032       var <a class="code" href="../../d3/d82/prlink_8h.html#aae95f41aa336f8375a3415100cf9ffd4">table</a>;
<a name="l01033"></a>01033       <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === IMEMode.FULL_HIRAGANA) {
<a name="l01034"></a>01034         table = IMEFullKatakanaCycleTable;
<a name="l01035"></a>01035       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === IMEMode.FULL_KATAKANA) {
<a name="l01036"></a>01036         table = IMEHalfKatakanaCycleTable;
<a name="l01037"></a>01037       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === IMEMode.HALF_KATAKANA) {
<a name="l01038"></a>01038         table = IMEHiraganaCycleTable;
<a name="l01039"></a>01039       }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041       var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l01042"></a>01042       var strFullKatakana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01043"></a>01043       var strHalfKatakana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01044"></a>01044       var strFullHiragana = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01045"></a>01045       var displayStr = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01046"></a>01046 
<a name="l01047"></a>01047       <span class="keywordflow">for</span> (i = 0; i &lt; _firstKana.length; i++) {
<a name="l01048"></a>01048         var <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a> = getPosInfoByChar(_firstKana[i]);
<a name="l01049"></a>01049         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;get info &#39;</span> + info[0] + <span class="stringliteral">&#39;  &#39;</span> + info[1]);
<a name="l01050"></a>01050         <span class="keywordflow">if</span> (info[0] === -1) {
<a name="l01051"></a>01051           <span class="comment">// FIXME see bug list 1</span>
<a name="l01052"></a>01052           <span class="keywordflow">return</span> [<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>];
<a name="l01053"></a>01053         }
<a name="l01054"></a>01054         displayStr += table[info[0]][info[1]];
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         strFullHiragana += IMEHiraganaCycleTable[info[0]][info[1]];
<a name="l01057"></a>01057         strFullKatakana += IMEFullKatakanaCycleTable[info[0]][info[1]];
<a name="l01058"></a>01058         strHalfKatakana += IMEHalfKatakanaCycleTable[info[0]][info[1]];
<a name="l01059"></a>01059       }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061       <span class="keywordflow">return</span> [displayStr, strFullHiragana, strFullKatakana, strHalfKatakana];
<a name="l01062"></a>01062     };
<a name="l01063"></a>01063 
<a name="l01064"></a>01064     <span class="comment">// Send pending symbols to display</span>
<a name="l01065"></a>01065     var sendPendingSymbols = <span class="keyword">function</span> ime_sendPendingSymbols() {
<a name="l01066"></a>01066 
<a name="l01067"></a>01067 
<a name="l01068"></a>01068       var bufStr = SyllableUtils.arrayToString(_inputBuf);
<a name="l01069"></a>01069 
<a name="l01070"></a>01070       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;sending pending symbols: &#39;</span> + bufStr);
<a name="l01071"></a>01071 
<a name="l01072"></a>01072       <span class="keywordflow">if</span> (_inputBuf.length === 0) {
<a name="l01073"></a>01073         _glue.sendPendingSymbols(<span class="stringliteral">&#39;&#39;</span>);
<a name="l01074"></a>01074         <span class="keywordflow">return</span>;
<a name="l01075"></a>01075       }
<a name="l01076"></a>01076 
<a name="l01077"></a>01077       <span class="keywordflow">if</span> (_keyMode === KeyMode.NORMAL) {
<a name="l01078"></a>01078         _glue.sendPendingSymbols(bufStr);
<a name="l01079"></a>01079         <span class="keywordflow">return</span>;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.TRANSFORM) {
<a name="l01082"></a>01082 
<a name="l01083"></a>01083         <span class="keywordflow">if</span> (_firstKanji.length === 0) {
<a name="l01084"></a>01084           _keyMode = KeyMode.NORMAL;
<a name="l01085"></a>01085 
<a name="l01086"></a>01086         } <span class="keywordflow">else</span> {
<a name="l01087"></a>01087           _glue.sendPendingSymbols(bufStr, 0, _firstKana.length, <span class="stringliteral">&#39;blue&#39;</span>);
<a name="l01088"></a>01088         }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090         <span class="keywordflow">return</span>;
<a name="l01091"></a>01091       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.SELECT) {
<a name="l01092"></a>01092 
<a name="l01093"></a>01093         <span class="keywordflow">if</span> (_firstKanji.length === 0) {
<a name="l01094"></a>01094           _keyMode = KeyMode.NORMAL;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096         } <span class="keywordflow">else</span> {
<a name="l01097"></a>01097           _glue.sendPendingSymbols(bufStr, 0, _firstKana.length, <span class="stringliteral">&#39;green&#39;</span>);
<a name="l01098"></a>01098         }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100         <span class="keywordflow">return</span>;
<a name="l01101"></a>01101       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_keyMode === KeyMode.H2K) {
<a name="l01102"></a>01102 
<a name="l01103"></a>01103         var strs = _getPossibleStrings(_keyboardMode);
<a name="l01104"></a>01104         var candidates = [];
<a name="l01105"></a>01105         _glue.sendPendingSymbols(bufStr, 0, strs[1].<a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>, <span class="stringliteral">&#39;red&#39;</span>);
<a name="l01106"></a>01106 
<a name="l01107"></a>01107         <span class="comment">// candidate list is updated here</span>
<a name="l01108"></a>01108         <span class="comment">// to avoide loop again in `handleInputBuf`</span>
<a name="l01109"></a>01109         <span class="comment">// TODO reorder these three candidates</span>
<a name="l01110"></a>01110         candidates.push([_firstKana, _firstKana]);
<a name="l01111"></a>01111         candidates.push([strs[2], _firstKana]);
<a name="l01112"></a>01112         candidates.push([strs[3], _firstKana]);
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         _candidateList = candidates.slice();
<a name="l01115"></a>01115         <span class="keywordflow">return</span>;
<a name="l01116"></a>01116       }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118       _glue.sendPendingSymbols(bufStr);
<a name="l01119"></a>01119     };
<a name="l01120"></a>01120 
<a name="l01121"></a>01121     <span class="comment">// Update candidate list</span>
<a name="l01122"></a>01122     var updateCandidateList = <span class="keyword">function</span> ime_updateCandidateList(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01123"></a>01123       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;update candidate list&#39;</span>);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125       _glue.sendCandidates(_candidateList);
<a name="l01126"></a>01126       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l01127"></a>01127     };
<a name="l01128"></a>01128 
<a name="l01129"></a>01129 
<a name="l01130"></a>01130     <span class="comment">// Get json and init indexedDB if possible</span>
<a name="l01131"></a>01131     var <a class="code" href="../../d0/da2/gallery_8js.html#aa3ad0f72d51416a18a4336efa0b2b3cf">initDB</a> = <span class="keyword">function</span> ime_initDB(readyCallback) {
<a name="l01132"></a>01132       var dbSettings = {
<a name="l01133"></a>01133         enableIndexedDB: _enableIndexedDB
<a name="l01134"></a>01134       };
<a name="l01135"></a>01135 
<a name="l01136"></a>01136       <span class="keywordflow">if</span> (readyCallback) {
<a name="l01137"></a>01137         dbSettings.ready = readyCallback;
<a name="l01138"></a>01138       }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140       var jsonUrl = _glue.path + <span class="stringliteral">&#39;/dict.json&#39;</span>;
<a name="l01141"></a>01141       _dict = <span class="keyword">new</span> IMEngineDatabase(<span class="stringliteral">&#39;jskanji&#39;</span>, jsonUrl);
<a name="l01142"></a>01142       _dict.init(dbSettings);
<a name="l01143"></a>01143     };
<a name="l01144"></a>01144 
<a name="l01145"></a>01145   };
<a name="l01146"></a>01146 
<a name="l01147"></a>01147   var jskanji = <span class="keyword">new</span> IMEngine(<span class="keyword">self</span>);
<a name="l01148"></a>01148 
<a name="l01149"></a>01149   <span class="comment">// Expose as an AMD module</span>
<a name="l01150"></a>01150   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a> === <span class="stringliteral">&#39;function&#39;</span> &amp;&amp; <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>.amd) {
<a name="l01151"></a>01151     <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;jskanji&#39;</span>, [], <span class="keyword">function</span>() { <span class="keywordflow">return</span> jskanji; });
<a name="l01152"></a>01152   }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154   <span class="comment">// Expose the engine to the Gaia keyboard</span>
<a name="l01155"></a>01155   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d1/dbd/apps_2keyboard_2js_2keyboard_8js.html#aa6f4b4f5c4d498adb4ab480e9598bde5">InputMethods</a> !== <span class="stringliteral">&#39;undefined&#39;</span>) {
<a name="l01156"></a>01156     <a class="code" href="../../d1/dbd/apps_2keyboard_2js_2keyboard_8js.html#aa6f4b4f5c4d498adb4ab480e9598bde5">InputMethods</a>.jskanji = jskanji;
<a name="l01157"></a>01157   }
<a name="l01158"></a>01158 
<a name="l01159"></a>01159   <span class="comment">/* copy from jszhuyin */</span>
<a name="l01160"></a>01160   var debugging = <span class="keyword">false</span>;
<a name="l01161"></a>01161   var <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a> = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l01162"></a>01162     <span class="keywordflow">if</span> (!debugging) {
<a name="l01163"></a>01163       <span class="keywordflow">return</span>;
<a name="l01164"></a>01164     }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.dump) {
<a name="l01167"></a>01167       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.dump(<span class="stringliteral">&#39;JP: &#39;</span> + <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> + <span class="charliteral">&#39;\n&#39;</span>);
<a name="l01168"></a>01168     }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a> &amp;&amp; <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log) {
<a name="l01171"></a>01171       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;JP: &#39;</span> + <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l01172"></a>01172       <span class="keywordflow">if</span> (arguments.length &gt; 1) {
<a name="l01173"></a>01173         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log.apply(<span class="keyword">this</span>, arguments);
<a name="l01174"></a>01174       }
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176   };
<a name="l01177"></a>01177 
<a name="l01178"></a>01178   <span class="comment">// for non-Mozilla browsers</span>
<a name="l01179"></a>01179   <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d0e/namespacemozilla_1_1dom_1_1constructors_1_1id.html#ad394f5385b88a41941d5965c814a8c47a0866b43a9f8b2707c848ee125a00a2d8">KeyEvent</a>) {
<a name="l01180"></a>01180     var <a class="code" href="../../d5/d0e/namespacemozilla_1_1dom_1_1constructors_1_1id.html#ad394f5385b88a41941d5965c814a8c47a0866b43a9f8b2707c848ee125a00a2d8">KeyEvent</a> = {
<a name="l01181"></a>01181       DOM_VK_BACK_SPACE: 0x8,
<a name="l01182"></a>01182       DOM_VK_RETURN: 0xd
<a name="l01183"></a>01183     };
<a name="l01184"></a>01184   }
<a name="l01185"></a>01185   <span class="comment">/* end copy */</span>
<a name="l01186"></a>01186 
<a name="l01187"></a>01187   var SyllableUtils = {
<a name="l01192"></a>01192     arrayToString: <span class="keyword">function</span> syllableUtils_arrayToString(<a class="code" href="../../de/dc5/jsfriendapi_8h.html#ad02ced9aca42ac6266a47ec4bf01d9c6">array</a>) {
<a name="l01193"></a>01193       <span class="keywordflow">return</span> <a class="code" href="../../de/dc5/jsfriendapi_8h.html#ad02ced9aca42ac6266a47ec4bf01d9c6">array</a>.join(<span class="stringliteral">&#39;&#39;</span>);
<a name="l01194"></a>01194     },
<a name="l01195"></a>01195 
<a name="l01200"></a>01200     arrayFromString: <span class="keyword">function</span> syllableUtils_arrayFromString(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l01201"></a>01201       <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.split(<span class="stringliteral">&#39;&#39;</span>);
<a name="l01202"></a>01202     }
<a name="l01203"></a>01203   };
<a name="l01204"></a>01204 
<a name="l01205"></a>01205   var Term = <span class="keyword">function</span> term_constructor(<a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>, <a class="code" href="../../dd/d9f/namespaceconv.html#a704c20f94d48395d1ae0a44a780f9c6f">freq</a>, <a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a>) {
<a name="l01206"></a>01206     this.<a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a> = <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>;
<a name="l01207"></a>01207     this.<a class="code" href="../../dd/d9f/namespaceconv.html#a704c20f94d48395d1ae0a44a780f9c6f">freq</a> = <a class="code" href="../../dd/d9f/namespaceconv.html#a704c20f94d48395d1ae0a44a780f9c6f">freq</a>;
<a name="l01208"></a>01208     this.<a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a> = <a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a>;
<a name="l01209"></a>01209   };
<a name="l01210"></a>01210 
<a name="l01211"></a>01211   Term.prototype = {
<a name="l01212"></a>01212     <span class="comment">/*The actual string of the term */</span>
<a name="l01213"></a>01213     <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>: <span class="stringliteral">&#39;&#39;</span>,
<a name="l01214"></a>01214     <span class="comment">/* The frequency of the term*/</span>
<a name="l01215"></a>01215     <a class="code" href="../../dd/d9f/namespaceconv.html#a704c20f94d48395d1ae0a44a780f9c6f">freq</a>: 0,
<a name="l01216"></a>01216     <a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a>: <span class="stringliteral">&#39;&#39;</span>
<a name="l01217"></a>01217   };
<a name="l01218"></a>01218 
<a name="l01222"></a>01222   var Homonyms = <span class="keyword">function</span> homonyms_constructor(<a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>, terms) {
<a name="l01223"></a>01223     this.<a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a> = <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>;
<a name="l01224"></a>01224 
<a name="l01225"></a>01225     <span class="comment">// Clone a new array</span>
<a name="l01226"></a>01226     this.terms = terms.concat();
<a name="l01227"></a>01227   };
<a name="l01228"></a>01228 
<a name="l01229"></a>01229   Homonyms.prototype = {
<a name="l01230"></a>01230     <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>: <span class="stringliteral">&#39;&#39;</span>,
<a name="l01231"></a>01231     <span class="comment">// Terms array</span>
<a name="l01232"></a>01232     terms: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>
<a name="l01233"></a>01233   };
<a name="l01234"></a>01234 
<a name="l01240"></a>01240   var Index = <span class="keyword">function</span> index_constructor(targetArray, keyPath) {
<a name="l01241"></a>01241     this._keyMap = {};
<a name="l01242"></a>01242     this._sortedKeys = [];
<a name="l01243"></a>01243     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; targetArray.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l01244"></a>01244       var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = targetArray[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>][keyPath];
<a name="l01245"></a>01245       <span class="keywordflow">if</span> (!(key in this._keyMap)) {
<a name="l01246"></a>01246         this._keyMap[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = [];
<a name="l01247"></a>01247         this._sortedKeys.push(key);
<a name="l01248"></a>01248       }
<a name="l01249"></a>01249       this._keyMap[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>].push(<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>);
<a name="l01250"></a>01250     }
<a name="l01251"></a>01251     this._sortedKeys.sort();
<a name="l01252"></a>01252   };
<a name="l01253"></a>01253 
<a name="l01254"></a>01254   Index.prototype = {
<a name="l01255"></a>01255     <span class="comment">// Map the key to the index of the storage array</span>
<a name="l01256"></a>01256     _keyMap: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01257"></a>01257 
<a name="l01258"></a>01258     <span class="comment">// Keys array in ascending order.</span>
<a name="l01259"></a>01259     _sortedKeys: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01260"></a>01260 
<a name="l01265"></a>01265     <span class="keyword">get</span>: <span class="keyword">function</span> index_get(key) {
<a name="l01266"></a>01266       var indices = [];
<a name="l01267"></a>01267       <span class="keywordflow">if</span> (key in this._keyMap) {
<a name="l01268"></a>01268         indices = indices.concat(this._keyMap[key]);
<a name="l01269"></a>01269       }
<a name="l01270"></a>01270       <span class="keywordflow">return</span> indices;
<a name="l01271"></a>01271     },
<a name="l01272"></a>01272 
<a name="l01285"></a>01285     getRange: <span class="keyword">function</span> index_getRange(lower, upper, lowerOpen, upperOpen) {
<a name="l01286"></a>01286       var indices = [];
<a name="l01287"></a>01287       <span class="keywordflow">if</span> (this._sortedKeys.length == 0) {
<a name="l01288"></a>01288         <span class="keywordflow">return</span> indices;
<a name="l01289"></a>01289       }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291       var pos = 0;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293       <span class="comment">// lower bound position</span>
<a name="l01294"></a>01294       var lowerPos = 0;
<a name="l01295"></a>01295       <span class="comment">// uppder bound position</span>
<a name="l01296"></a>01296       var upperPos = this._sortedKeys.length - 1;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298       <span class="keywordflow">if</span> (lower) {
<a name="l01299"></a>01299         pos = this._binarySearch(lower, 0, upperPos);
<a name="l01300"></a>01300         <span class="keywordflow">if</span> (pos == <a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a1b0bebbb829f5b272171927a1b7adfbe">Infinity</a>) {
<a name="l01301"></a>01301           <span class="keywordflow">return</span> indices;
<a name="l01302"></a>01302         }
<a name="l01303"></a>01303         <span class="keywordflow">if</span> (pos != -<a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a1b0bebbb829f5b272171927a1b7adfbe">Infinity</a>) {
<a name="l01304"></a>01304           lowerPos = Math.ceil(pos);
<a name="l01305"></a>01305         }
<a name="l01306"></a>01306         <span class="keywordflow">if</span> (lowerOpen &amp;&amp; this._sortedKeys[lowerPos] == lower) {
<a name="l01307"></a>01307           lowerPos++;
<a name="l01308"></a>01308         }
<a name="l01309"></a>01309       }
<a name="l01310"></a>01310 
<a name="l01311"></a>01311       <span class="keywordflow">if</span> (upper) {
<a name="l01312"></a>01312         pos = this._binarySearch(upper, lowerPos, upperPos);
<a name="l01313"></a>01313         <span class="keywordflow">if</span> (pos == -<a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a1b0bebbb829f5b272171927a1b7adfbe">Infinity</a>) {
<a name="l01314"></a>01314           <span class="keywordflow">return</span> indices;
<a name="l01315"></a>01315         }
<a name="l01316"></a>01316         <span class="keywordflow">if</span> (pos != <a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a1b0bebbb829f5b272171927a1b7adfbe">Infinity</a>) {
<a name="l01317"></a>01317           upperPos = Math.floor(pos);
<a name="l01318"></a>01318         }
<a name="l01319"></a>01319         <span class="keywordflow">if</span> (upperOpen &amp;&amp; this._sortedKeys[upperPos] == upper) {
<a name="l01320"></a>01320           upperPos--;
<a name="l01321"></a>01321         }
<a name="l01322"></a>01322       }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324       <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = lowerPos; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt;= upperPos; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l01325"></a>01325         var key = this._sortedKeys[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01326"></a>01326         indices = indices.concat(this._keyMap[key]);
<a name="l01327"></a>01327       }
<a name="l01328"></a>01328       <span class="keywordflow">return</span> indices;
<a name="l01329"></a>01329     },
<a name="l01330"></a>01330 
<a name="l01343"></a>01343     _binarySearch: <span class="keyword">function</span> index_binarySearch(key, <a class="code" href="../../d3/d91/j3d_8js.html#a47b6aed05bc344861b52fe3ffb7a1edd">left</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#a06a61119547d88fbcdf5e877c6c9057e">right</a>) {
<a name="l01344"></a>01344       <span class="keywordflow">if</span> (key &lt; this._sortedKeys[<a class="code" href="../../d3/d91/j3d_8js.html#a47b6aed05bc344861b52fe3ffb7a1edd">left</a>]) {
<a name="l01345"></a>01345         <span class="keywordflow">return</span> -<a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a1b0bebbb829f5b272171927a1b7adfbe">Infinity</a>;
<a name="l01346"></a>01346       }
<a name="l01347"></a>01347       <span class="keywordflow">if</span> (key &gt; this._sortedKeys[<a class="code" href="../../d2/d7d/jsapi_8h.html#a06a61119547d88fbcdf5e877c6c9057e">right</a>]) {
<a name="l01348"></a>01348         <span class="keywordflow">return</span> <a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a1b0bebbb829f5b272171927a1b7adfbe">Infinity</a>;
<a name="l01349"></a>01349       }
<a name="l01350"></a>01350 
<a name="l01351"></a>01351       <span class="keywordflow">while</span> (right &gt; left) {
<a name="l01352"></a>01352         var mid = Math.floor((left + right) / 2);
<a name="l01353"></a>01353         var midKey = this._sortedKeys[mid];
<a name="l01354"></a>01354         <span class="keywordflow">if</span> (midKey &lt; key) {
<a name="l01355"></a>01355           left = mid + 1;
<a name="l01356"></a>01356         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (midKey &gt; key) {
<a name="l01357"></a>01357           right = mid - 1;
<a name="l01358"></a>01358         } <span class="keywordflow">else</span> {
<a name="l01359"></a>01359           <span class="keywordflow">return</span> mid;
<a name="l01360"></a>01360         }
<a name="l01361"></a>01361       }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363       <span class="comment">// left == right == mid</span>
<a name="l01364"></a>01364       var leftKey = this._sortedKeys[<a class="code" href="../../d3/d91/j3d_8js.html#a47b6aed05bc344861b52fe3ffb7a1edd">left</a>];
<a name="l01365"></a>01365       <span class="keywordflow">if</span> (leftKey == key) {
<a name="l01366"></a>01366         <span class="keywordflow">return</span> <a class="code" href="../../d3/d91/j3d_8js.html#a47b6aed05bc344861b52fe3ffb7a1edd">left</a>;
<a name="l01367"></a>01367       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (leftKey &lt; key) {
<a name="l01368"></a>01368         <span class="keywordflow">return</span> left + 0.5;
<a name="l01369"></a>01369       } <span class="keywordflow">else</span> {
<a name="l01370"></a>01370         <span class="keywordflow">return</span> left - 0.5;
<a name="l01371"></a>01371       }
<a name="l01372"></a>01372     }
<a name="l01373"></a>01373   };
<a name="l01374"></a>01374 
<a name="l01375"></a>01375   var Task = <span class="keyword">function</span> task_constructor(taskFunc, taskData) {
<a name="l01376"></a>01376     this.<a class="code" href="../../d2/d7d/jsapi_8h.html#ad84b078786561118564537030cd7a8b1">func</a> = taskFunc;
<a name="l01377"></a>01377     this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = taskData;
<a name="l01378"></a>01378   };
<a name="l01379"></a>01379 
<a name="l01380"></a>01380   Task.prototype = {
<a name="l01384"></a>01384     <a class="code" href="../../d2/d7d/jsapi_8h.html#ad84b078786561118564537030cd7a8b1">func</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01388"></a>01388     <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>
<a name="l01389"></a>01389   };
<a name="l01390"></a>01390 
<a name="l01391"></a>01391   var TaskQueue = <span class="keyword">function</span> taskQueue_constructor(oncomplete) {
<a name="l01392"></a>01392     this.oncomplete = oncomplete;
<a name="l01393"></a>01393     this._queue = [];
<a name="l01394"></a>01394     this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = {};
<a name="l01395"></a>01395   };
<a name="l01396"></a>01396 
<a name="l01397"></a>01397   TaskQueue.prototype = {
<a name="l01402"></a>01402     oncomplete: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01403"></a>01403 
<a name="l01407"></a>01407     <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01408"></a>01408 
<a name="l01412"></a>01412     _queue: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01413"></a>01413 
<a name="l01424"></a>01424     <a class="code" href="../../d6/da5/libpinyin_8js.html#a52101983b19adda1d8740c8b3d4aa0dc">push</a>: <span class="keyword">function</span> taskQueue_push(taskFunc, taskData) {
<a name="l01425"></a>01425       this._queue.push(<span class="keyword">new</span> Task(taskFunc, taskData));
<a name="l01426"></a>01426     },
<a name="l01427"></a>01427 
<a name="l01432"></a>01432     processNext: <span class="keyword">function</span> taskQueue_processNext() {
<a name="l01433"></a>01433       <span class="keywordflow">if</span> (this._queue.length &gt; 0) {
<a name="l01434"></a>01434         var task = this._queue.shift();
<a name="l01435"></a>01435         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> task.func == <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l01436"></a>01436           task.func(<span class="keyword">this</span>, task.data);
<a name="l01437"></a>01437         } <span class="keywordflow">else</span> {
<a name="l01438"></a>01438           this.processNext();
<a name="l01439"></a>01439         }
<a name="l01440"></a>01440       } <span class="keywordflow">else</span> {
<a name="l01441"></a>01441         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> this.oncomplete == <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l01442"></a>01442           this.oncomplete(this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>);
<a name="l01443"></a>01443         }
<a name="l01444"></a>01444       }
<a name="l01445"></a>01445     },
<a name="l01446"></a>01446 
<a name="l01450"></a>01450     getSize: <span class="keyword">function</span> taskQueue_getSize() {
<a name="l01451"></a>01451       <span class="keywordflow">return</span> this._queue.length;
<a name="l01452"></a>01452     }
<a name="l01453"></a>01453   };
<a name="l01454"></a>01454 
<a name="l01455"></a>01455   var DatabaseStorageBase = <span class="keyword">function</span> storagebase_constructor() {
<a name="l01456"></a>01456   };
<a name="l01457"></a>01457 
<a name="l01461"></a>01461   DatabaseStorageBase.StatusCode = {
<a name="l01462"></a>01462     <span class="comment">/* The storage isn&#39;t initilized.*/</span>
<a name="l01463"></a>01463     UNINITIALIZED: 0,
<a name="l01464"></a>01464     <span class="comment">/* The storage is busy.*/</span>
<a name="l01465"></a>01465     <a class="code" href="../../d9/d0a/namespacemozilla_1_1a11y_1_1states.html#a02acfe34064d0c79373e52c840c9f07b">BUSY</a>: 1,
<a name="l01466"></a>01466     <span class="comment">/* The storage has been successfully initilized and is ready to use.*/</span>
<a name="l01467"></a>01467     READY: 2,
<a name="l01468"></a>01468     <span class="comment">/* The storage is failed to initilized and cannot be used.*/</span>
<a name="l01469"></a>01469     <a class="code" href="../../d1/d58/_error_list_8h.html#a178ee40b977ffac96436bc1d9705a07b">ERROR</a>: 3
<a name="l01470"></a>01470   };
<a name="l01471"></a>01471 
<a name="l01472"></a>01472   DatabaseStorageBase.prototype = {
<a name="l01473"></a>01473     _status: DatabaseStorageBase.StatusCode.UNINITIALIZED,
<a name="l01474"></a>01474 
<a name="l01479"></a>01479     getStatus: <span class="keyword">function</span> storagebase_getStatus() {
<a name="l01480"></a>01480       <span class="keywordflow">return</span> this._status;
<a name="l01481"></a>01481     },
<a name="l01482"></a>01482 
<a name="l01486"></a>01486     isReady: <span class="keyword">function</span> storagebase_isReady() {
<a name="l01487"></a>01487       <span class="keywordflow">return</span> this._status == DatabaseStorageBase.StatusCode.READY;
<a name="l01488"></a>01488     },
<a name="l01489"></a>01489 
<a name="l01498"></a>01498     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span> storagebase_init(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01499"></a>01499     },
<a name="l01500"></a>01500 
<a name="l01507"></a>01507     <a class="code" href="../../d3/d44/updatable_8js.html#a0a545f3fc3649048e3c5c41303a26cc3">uninit</a>: <span class="keyword">function</span> storagebase_uninit(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01508"></a>01508     },
<a name="l01509"></a>01509 
<a name="l01510"></a>01510 
<a name="l01515"></a>01515     isEmpty: <span class="keyword">function</span> storagebase_isEmpty() {
<a name="l01516"></a>01516     },
<a name="l01517"></a>01517 
<a name="l01525"></a>01525     getAllTerms: <span class="keyword">function</span> storagebase_getAllTerms(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01526"></a>01526     },
<a name="l01527"></a>01527 
<a name="l01536"></a>01536     setAllTerms: <span class="keyword">function</span> storagebase_setAllTerms(homonymsArray, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01537"></a>01537     },
<a name="l01538"></a>01538 
<a name="l01547"></a>01547     getTermsByKana: <span class="keyword">function</span> storagebase_getTermsByKana(
<a name="l01548"></a>01548                              syllablesStr, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01549"></a>01549     },
<a name="l01550"></a>01550 
<a name="l01559"></a>01559     getTermsByKanaPrefix: <span class="keyword">function</span> storagebase_getTermsByKanaPrefix(
<a name="l01560"></a>01560                               <a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01561"></a>01561     },
<a name="l01562"></a>01562 
<a name="l01571"></a>01571     addTerm: <span class="keyword">function</span> storagebase_addTerm(syllablesStr, term, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01572"></a>01572     },
<a name="l01573"></a>01573 
<a name="l01582"></a>01582     removeTerm: <span class="keyword">function</span> storagebase_removeTerm(syllablesStr, term, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01583"></a>01583     }
<a name="l01584"></a>01584   };
<a name="l01585"></a>01585 
<a name="l01586"></a>01586   var JsonStorage = <span class="keyword">function</span> jsonStorage_construtor(jsonUrl) {
<a name="l01587"></a>01587     this._jsonUrl = jsonUrl;
<a name="l01588"></a>01588     this._dataArray = [];
<a name="l01589"></a>01589   };
<a name="l01590"></a>01590 
<a name="l01591"></a>01591   JsonStorage.prototype = {
<a name="l01592"></a>01592     <span class="comment">// Inherits DatabaseStorageBase</span>
<a name="l01593"></a>01593     __proto__: <span class="keyword">new</span> DatabaseStorageBase(),
<a name="l01594"></a>01594 
<a name="l01595"></a>01595     _dataArray: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01596"></a>01596 
<a name="l01597"></a>01597     <span class="comment">// The JSON file url.</span>
<a name="l01598"></a>01598     _jsonUrl: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01599"></a>01599 
<a name="l01600"></a>01600     _kanaIndex: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01601"></a>01601 
<a name="l01602"></a>01602     _abrreviatedIndex: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01603"></a>01603 
<a name="l01604"></a>01604     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span> jsonStorage_init(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01605"></a>01605       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01606"></a>01606       var doCallback = <span class="keyword">function</span> init_doCallback() {
<a name="l01607"></a>01607         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01608"></a>01608           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="keyword">self</span>._status);
<a name="l01609"></a>01609         }
<a name="l01610"></a>01610       };
<a name="l01611"></a>01611       <span class="comment">// Check if we could initilize.</span>
<a name="l01612"></a>01612       <span class="keywordflow">if</span> (this._status != DatabaseStorageBase.StatusCode.UNINITIALIZED) {
<a name="l01613"></a>01613         doCallback();
<a name="l01614"></a>01614         <span class="keywordflow">return</span>;
<a name="l01615"></a>01615       }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617       <span class="comment">// Set the status to busy.</span>
<a name="l01618"></a>01618       this._status = DatabaseStorageBase.StatusCode.BUSY;
<a name="l01619"></a>01619 
<a name="l01620"></a>01620       var <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a> = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a2619068a621e6b22d7995161b2cea021">XMLHttpRequest</a>();
<a name="l01621"></a>01621       xhr.open(<span class="stringliteral">&#39;GET&#39;</span>, this._jsonUrl, <span class="keyword">true</span>);
<a name="l01622"></a>01622       <span class="keywordflow">try</span> {
<a name="l01623"></a>01623         xhr.responseType = <span class="stringliteral">&#39;json&#39;</span>;
<a name="l01624"></a>01624       } <span class="keywordflow">catch</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) { }
<a name="l01625"></a>01625       xhr.overrideMimeType(<span class="stringliteral">&#39;application/json; charset=utf-8&#39;</span>);
<a name="l01626"></a>01626       xhr.onreadystatechange = <span class="keyword">function</span> xhrReadystatechange(ev) {
<a name="l01627"></a>01627         <span class="keywordflow">if</span> (xhr.readyState !== 4) {
<a name="l01628"></a>01628           <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.ERROR;
<a name="l01629"></a>01629           <span class="keywordflow">return</span>;
<a name="l01630"></a>01630         }
<a name="l01631"></a>01631 
<a name="l01632"></a>01632         var response;
<a name="l01633"></a>01633         <span class="keywordflow">if</span> (xhr.responseType == <span class="stringliteral">&#39;json&#39;</span>) {
<a name="l01634"></a>01634           <span class="keywordflow">try</span> {
<a name="l01635"></a>01635             <span class="comment">// clone everything under response because it&#39;s readonly.</span>
<a name="l01636"></a>01636             <span class="keyword">self</span>._dataArray = xhr.response.slice();
<a name="l01637"></a>01637           } <span class="keywordflow">catch</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l01638"></a>01638           }
<a name="l01639"></a>01639         }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <span class="keyword">self</span>._dataArray !== <span class="stringliteral">&#39;object&#39;</span>) {
<a name="l01642"></a>01642           <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.ERROR;
<a name="l01643"></a>01643           doCallback();
<a name="l01644"></a>01644           <span class="keywordflow">return</span>;
<a name="l01645"></a>01645         }
<a name="l01646"></a>01646 
<a name="l01647"></a>01647         xhr = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01648"></a>01648         <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(performBuildIndices, 100);
<a name="l01649"></a>01649       };
<a name="l01650"></a>01650 
<a name="l01651"></a>01651       var performBuildIndices = <span class="keyword">function</span> init_performBuildIndices() {
<a name="l01652"></a>01652         <span class="keyword">self</span>._buildIndices();
<a name="l01653"></a>01653         <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.READY;
<a name="l01654"></a>01654         doCallback();
<a name="l01655"></a>01655       };
<a name="l01656"></a>01656 
<a name="l01657"></a>01657       xhr.send(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l01658"></a>01658     },
<a name="l01659"></a>01659 
<a name="l01660"></a>01660     <a class="code" href="../../d3/d44/updatable_8js.html#a0a545f3fc3649048e3c5c41303a26cc3">uninit</a>: <span class="keyword">function</span> jsonStorage_uninit(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01661"></a>01661       var doCallback = <span class="keyword">function</span> uninit_doCallback() {
<a name="l01662"></a>01662         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01663"></a>01663           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l01664"></a>01664         }
<a name="l01665"></a>01665       };
<a name="l01666"></a>01666 
<a name="l01667"></a>01667       <span class="comment">// Check if we could uninitilize the storage</span>
<a name="l01668"></a>01668       <span class="keywordflow">if</span> (this._status == DatabaseStorageBase.StatusCode.UNINITIALIZED) {
<a name="l01669"></a>01669         doCallback();
<a name="l01670"></a>01670         <span class="keywordflow">return</span>;
<a name="l01671"></a>01671       }
<a name="l01672"></a>01672 
<a name="l01673"></a>01673       <span class="comment">// Perform destruction operation</span>
<a name="l01674"></a>01674       this._dataArray = [];
<a name="l01675"></a>01675 
<a name="l01676"></a>01676       this._status = DatabaseStorageBase.StatusCode.UNINITIALIZED;
<a name="l01677"></a>01677       doCallback();
<a name="l01678"></a>01678     },
<a name="l01679"></a>01679 
<a name="l01680"></a>01680     isEmpty: <span class="keyword">function</span> jsonStorage_isEmpty() {
<a name="l01681"></a>01681       <span class="keywordflow">return</span> this._dataArray.length == 0;
<a name="l01682"></a>01682     },
<a name="l01683"></a>01683 
<a name="l01684"></a>01684     getAllTerms: <span class="keyword">function</span> jsonStorage_getAllTerms(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01685"></a>01685       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01686"></a>01686       var homonymsArray = [];
<a name="l01687"></a>01687       var doCallback = <span class="keyword">function</span> getAllTerms_doCallback() {
<a name="l01688"></a>01688         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01689"></a>01689           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(homonymsArray);
<a name="l01690"></a>01690         }
<a name="l01691"></a>01691       };
<a name="l01692"></a>01692 
<a name="l01693"></a>01693       <span class="comment">// Check if the storage is ready.</span>
<a name="l01694"></a>01694       <span class="keywordflow">if</span> (!this.isReady()) {
<a name="l01695"></a>01695         doCallback();
<a name="l01696"></a>01696         <span class="keywordflow">return</span>;
<a name="l01697"></a>01697       }
<a name="l01698"></a>01698 
<a name="l01699"></a>01699       var perform = <span class="keyword">function</span> getAllTerms_perform() {
<a name="l01700"></a>01700         <span class="comment">// Query all terms</span>
<a name="l01701"></a>01701         homonymsArray = homonymsArray.concat(<span class="keyword">self</span>._dataArray);
<a name="l01702"></a>01702         doCallback();
<a name="l01703"></a>01703       };
<a name="l01704"></a>01704 
<a name="l01705"></a>01705       <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(perform, 0);
<a name="l01706"></a>01706     },
<a name="l01707"></a>01707 
<a name="l01708"></a>01708     getTermsByKana: <span class="keyword">function</span> jsonStorage_getTermsByKana(kanaStr, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01709"></a>01709       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01710"></a>01710       var homonymsArray = [];
<a name="l01711"></a>01711       var doCallback = <span class="keyword">function</span> getTermsByKana_doCallback() {
<a name="l01712"></a>01712         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01713"></a>01713           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(homonymsArray);
<a name="l01714"></a>01714         }
<a name="l01715"></a>01715       };
<a name="l01716"></a>01716 
<a name="l01717"></a>01717       <span class="comment">// Check if the storage is ready.</span>
<a name="l01718"></a>01718       <span class="keywordflow">if</span> (!this.isReady()) {
<a name="l01719"></a>01719         doCallback();
<a name="l01720"></a>01720         <span class="keywordflow">return</span>;
<a name="l01721"></a>01721       }
<a name="l01722"></a>01722 
<a name="l01723"></a>01723       var perform = <span class="keyword">function</span> getTermsByKana_perform() {
<a name="l01724"></a>01724         var indices = <span class="keyword">self</span>._kanaIndex.get(kanaStr);
<a name="l01725"></a>01725         <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; indices.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l01726"></a>01726           var <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> = indices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01727"></a>01727           homonymsArray.push(<span class="keyword">self</span>._dataArray[index]);
<a name="l01728"></a>01728         }
<a name="l01729"></a>01729         doCallback();
<a name="l01730"></a>01730       };
<a name="l01731"></a>01731 
<a name="l01732"></a>01732       <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(perform, 0);
<a name="l01733"></a>01733     },
<a name="l01734"></a>01734 
<a name="l01735"></a>01735    getTermsByKanaPrefix: <span class="keyword">function</span>
<a name="l01736"></a>01736      jsonStorage_getTermsByKanaPrefix(<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01737"></a>01737        var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01738"></a>01738        var homonymsArray = [];
<a name="l01739"></a>01739        <span class="keyword">function</span> doCallback() {
<a name="l01740"></a>01740          <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01741"></a>01741            <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(homonymsArray);
<a name="l01742"></a>01742          }
<a name="l01743"></a>01743        }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745        <span class="comment">// Check if the storage is ready.</span>
<a name="l01746"></a>01746        <span class="keywordflow">if</span> (!this.isReady()) {
<a name="l01747"></a>01747          doCallback();
<a name="l01748"></a>01748          <span class="keywordflow">return</span>;
<a name="l01749"></a>01749        }
<a name="l01750"></a>01750 
<a name="l01751"></a>01751        var perform = <span class="keyword">function</span>() {
<a name="l01752"></a>01752          var upperBound = <a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>.substr(0, <a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>.length - 1) +
<a name="l01753"></a>01753            String.fromCharCode(<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>.substr(<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>.length - 1
<a name="l01754"></a>01754                                              ).charCodeAt(0) + 1);
<a name="l01755"></a>01755          var indices =
<a name="l01756"></a>01756            <span class="keyword">self</span>._kanaIndex.getRange(<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>, upperBound, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l01757"></a>01757          <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; indices.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l01758"></a>01758            var <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> = indices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01759"></a>01759            homonymsArray.push(<span class="keyword">self</span>._dataArray[index]);
<a name="l01760"></a>01760          }
<a name="l01761"></a>01761          doCallback();
<a name="l01762"></a>01762        };
<a name="l01763"></a>01763 
<a name="l01764"></a>01764        <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(perform, 0);
<a name="l01765"></a>01765      },
<a name="l01766"></a>01766 
<a name="l01767"></a>01767    _buildIndices: <span class="keyword">function</span> jsonStorage_buildIndices() {
<a name="l01768"></a>01768      this._kanaIndex = <span class="keyword">new</span> Index(this._dataArray, <span class="stringliteral">&#39;kana&#39;</span>);
<a name="l01769"></a>01769    }
<a name="l01770"></a>01770   };
<a name="l01771"></a>01771 
<a name="l01772"></a>01772 
<a name="l01773"></a>01773   <span class="comment">// **Interfaces of indexedDB**</span>
<a name="l01774"></a>01774   var IndexedDB = {
<a name="l01775"></a>01775     indexedDB: <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.indexedDB || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.webkitIndexedDB ||
<a name="l01776"></a>01776       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.mozIndexedDB || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.msIndexedDB,
<a name="l01777"></a>01777 
<a name="l01778"></a>01778     <a class="code" href="../../db/d67/class_i_d_b_database.html">IDBDatabase</a>: <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.IDBDatabase || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.webkitIDBDatabase ||
<a name="l01779"></a>01779       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.msIDBDatabase,
<a name="l01780"></a>01780 
<a name="l01781"></a>01781     <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28af18d7d5f0af340fb17cc01e9b8f24d0b">IDBIndex</a>: <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.IDBIndex || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.webkitIDBIndex || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.msIDBIndex,
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     <span class="comment">// Check if the indexedDB is available on this platform</span>
<a name="l01784"></a>01784     isReady: <span class="keyword">function</span> indexedDB_isReady() {
<a name="l01785"></a>01785       <span class="keywordflow">if</span> (!this.indexedDB || <span class="comment">// No IndexedDB API implementation</span>
<a name="l01786"></a>01786         this.<a class="code" href="../../db/d67/class_i_d_b_database.html">IDBDatabase</a>.prototype.setVersion || <span class="comment">// old version of IndexedDB API</span>
<a name="l01787"></a>01787         <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.location.protocol === <span class="stringliteral">&#39;file:&#39;</span>) {  <span class="comment">// bug 643318</span>
<a name="l01788"></a>01788 
<a name="l01789"></a>01789         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;IndexedDB is not available on this platform.&#39;</span>);
<a name="l01790"></a>01790         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01791"></a>01791       }
<a name="l01792"></a>01792 
<a name="l01793"></a>01793       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01794"></a>01794     }
<a name="l01795"></a>01795 
<a name="l01796"></a>01796   };
<a name="l01797"></a>01797   <span class="comment">/* end IndexedDB */</span>
<a name="l01798"></a>01798 
<a name="l01799"></a>01799   var IndexedDBStorage = <span class="keyword">function</span> indexedDBStorage_constructor(dbName) {
<a name="l01800"></a>01800     this._dbName = dbName;
<a name="l01801"></a>01801   };
<a name="l01802"></a>01802 
<a name="l01803"></a>01803   IndexedDBStorage.kDBVersion = 1.0;
<a name="l01804"></a>01804 
<a name="l01805"></a>01805   IndexedDBStorage.prototype = {
<a name="l01806"></a>01806 
<a name="l01807"></a>01807     <span class="comment">// Inherits DatabaseStorageBase</span>
<a name="l01808"></a>01808     __proto__: <span class="keyword">new</span> DatabaseStorageBase(),
<a name="l01809"></a>01809 
<a name="l01810"></a>01810     <span class="comment">// Database name</span>
<a name="l01811"></a>01811     _dbName: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01812"></a>01812 
<a name="l01813"></a>01813     <span class="comment">// IDBDatabase interface</span>
<a name="l01814"></a>01814     _IDBDatabase: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01815"></a>01815 
<a name="l01816"></a>01816     _count: 0,
<a name="l01817"></a>01817 
<a name="l01818"></a>01818     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span> indexedDBStorage_init(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01819"></a>01819       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01820"></a>01820       <span class="keyword">function</span> doCallback() {
<a name="l01821"></a>01821         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01822"></a>01822           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="keyword">self</span>._status);
<a name="l01823"></a>01823         }
<a name="l01824"></a>01824       }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826       <span class="comment">// Check if we could initilize.</span>
<a name="l01827"></a>01827       <span class="keywordflow">if</span> (IndexedDB.isReady() &amp;&amp;
<a name="l01828"></a>01828           this._status != DatabaseStorageBase.StatusCode.UNINITIALIZED) {
<a name="l01829"></a>01829             doCallback();
<a name="l01830"></a>01830             <span class="keywordflow">return</span>;
<a name="l01831"></a>01831           }
<a name="l01832"></a>01832 
<a name="l01833"></a>01833       <span class="comment">// Set the status to busy.</span>
<a name="l01834"></a>01834       this._status = DatabaseStorageBase.StatusCode.BUSY;
<a name="l01835"></a>01835 
<a name="l01836"></a>01836       <span class="comment">// Open the database</span>
<a name="l01837"></a>01837       var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a> = IndexedDB.indexedDB.open(this._dbName,
<a name="l01838"></a>01838           IndexedDBStorage.kDBVersion);
<a name="l01839"></a>01839       req.onerror = <span class="keyword">function</span> dbopenError(ev) {
<a name="l01840"></a>01840         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Encounter error while opening IndexedDB.&#39;</span>);
<a name="l01841"></a>01841         <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.ERROR;
<a name="l01842"></a>01842         doCallback();
<a name="l01843"></a>01843       };
<a name="l01844"></a>01844 
<a name="l01845"></a>01845       req.onupgradeneeded = <span class="keyword">function</span> dbopenUpgradeneeded(ev) {
<a name="l01846"></a>01846         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;IndexedDB upgradeneeded.&#39;</span>);
<a name="l01847"></a>01847         <span class="keyword">self</span>._IDBDatabase = ev.target.result;
<a name="l01848"></a>01848 
<a name="l01849"></a>01849         <span class="comment">// delete the old ObjectStore if present</span>
<a name="l01850"></a>01850         <span class="keywordflow">if</span> (<span class="keyword">self</span>._IDBDatabase.objectStoreNames.length !== 0) {
<a name="l01851"></a>01851           <span class="keyword">self</span>._IDBDatabase.deleteObjectStore(<span class="stringliteral">&#39;homonyms&#39;</span>);
<a name="l01852"></a>01852         }
<a name="l01853"></a>01853 
<a name="l01854"></a>01854         <span class="comment">// create ObjectStore</span>
<a name="l01855"></a>01855         var store = <span class="keyword">self</span>._IDBDatabase.createObjectStore(<span class="stringliteral">&#39;homonyms&#39;</span>,
<a name="l01856"></a>01856             { keyPath: <span class="stringliteral">&#39;kana&#39;</span> });
<a name="l01857"></a>01857 
<a name="l01858"></a>01858         <span class="comment">// no callback() here</span>
<a name="l01859"></a>01859         <span class="comment">// onupgradeneeded will follow by onsuccess event</span>
<a name="l01860"></a>01860       };
<a name="l01861"></a>01861 
<a name="l01862"></a>01862       req.onsuccess = <span class="keyword">function</span> dbopenSuccess(ev) {
<a name="l01863"></a>01863         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;IndexedDB opened.&#39;</span>);
<a name="l01864"></a>01864         <span class="keyword">self</span>._IDBDatabase = ev.target.result;
<a name="l01865"></a>01865 
<a name="l01866"></a>01866         <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.READY;
<a name="l01867"></a>01867         <span class="keyword">self</span>._count = 0;
<a name="l01868"></a>01868 
<a name="l01869"></a>01869         <span class="comment">// Check the integrity of the storage</span>
<a name="l01870"></a>01870         <span class="keyword">self</span>.getTermsByKana(<span class="stringliteral">&#39;_last_entry_&#39;</span>,
<a name="l01871"></a>01871           <span class="keyword">function</span> getLastEntryCallback(homonymsArray) {
<a name="l01872"></a>01872             <span class="keywordflow">if</span> (homonymsArray.length === 0) {
<a name="l01873"></a>01873               debug(<span class="stringliteral">&#39;IndexedDB is broken.&#39;</span>);
<a name="l01874"></a>01874               <span class="comment">// Could not find the &#39;_last_entry_&#39; element.</span>
<a name="l01875"></a>01875               <span class="comment">// The storage is broken</span>
<a name="l01876"></a>01876               <span class="comment">// and ignore all the data.</span>
<a name="l01877"></a>01877               doCallback();
<a name="l01878"></a>01878               <span class="keywordflow">return</span>;
<a name="l01879"></a>01879             }
<a name="l01880"></a>01880 
<a name="l01881"></a>01881             var transaction = <span class="keyword">self</span>._IDBDatabase.transaction([<span class="stringliteral">&#39;homonyms&#39;</span>],
<a name="l01882"></a>01882                                                             <span class="stringliteral">&#39;readonly&#39;</span>);
<a name="l01883"></a>01883             <span class="comment">// Get the count</span>
<a name="l01884"></a>01884             var reqCount = transaction.objectStore(<span class="stringliteral">&#39;homonyms&#39;</span>).count();
<a name="l01885"></a>01885 
<a name="l01886"></a>01886             reqCount.onsuccess = <span class="keyword">function</span>(ev) {
<a name="l01887"></a>01887               <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;IndexedDB count: &#39;</span> + ev.target.result);
<a name="l01888"></a>01888               <span class="keyword">self</span>._count = ev.target.result - 1;
<a name="l01889"></a>01889               <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.READY;
<a name="l01890"></a>01890               doCallback();
<a name="l01891"></a>01891             };
<a name="l01892"></a>01892 
<a name="l01893"></a>01893             reqCount.onerror = <span class="keyword">function</span>(ev) {
<a name="l01894"></a>01894               <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.ERROR;
<a name="l01895"></a>01895               doCallback();
<a name="l01896"></a>01896             };
<a name="l01897"></a>01897           });
<a name="l01898"></a>01898       };
<a name="l01899"></a>01899     },
<a name="l01900"></a>01900 
<a name="l01901"></a>01901     <a class="code" href="../../d3/d44/updatable_8js.html#a0a545f3fc3649048e3c5c41303a26cc3">uninit</a>: <span class="keyword">function</span> indexedDBStorage_uninit(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01902"></a>01902       <span class="keyword">function</span> doCallback() {
<a name="l01903"></a>01903         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01904"></a>01904           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l01905"></a>01905         }
<a name="l01906"></a>01906       }
<a name="l01907"></a>01907 
<a name="l01908"></a>01908       <span class="comment">// Check if we could uninitilize the storage</span>
<a name="l01909"></a>01909       <span class="keywordflow">if</span> (this._status == DatabaseStorageBase.StatusCode.UNINITIALIZED) {
<a name="l01910"></a>01910         doCallback();
<a name="l01911"></a>01911         <span class="keywordflow">return</span>;
<a name="l01912"></a>01912       }
<a name="l01913"></a>01913 
<a name="l01914"></a>01914       <span class="comment">// Perform destruction operation</span>
<a name="l01915"></a>01915       <span class="keywordflow">if</span> (this._IDBDatabase) {
<a name="l01916"></a>01916         this._IDBDatabase.close();
<a name="l01917"></a>01917       }
<a name="l01918"></a>01918 
<a name="l01919"></a>01919       this._status = DatabaseStorageBase.StatusCode.UNINITIALIZED;
<a name="l01920"></a>01920       doCallback();
<a name="l01921"></a>01921     },
<a name="l01922"></a>01922 
<a name="l01923"></a>01923     isEmpty: <span class="keyword">function</span> indexedDBStorage_isEmpty() {
<a name="l01924"></a>01924       <span class="keywordflow">return</span> this._count == 0;
<a name="l01925"></a>01925     },
<a name="l01926"></a>01926 
<a name="l01927"></a>01927     getAllTerms: <span class="keyword">function</span> indexedDBStorage_getAllTerms(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01928"></a>01928       var homonymsArray = [];
<a name="l01929"></a>01929       <span class="keyword">function</span> doCallback() {
<a name="l01930"></a>01930         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01931"></a>01931           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(homonymsArray);
<a name="l01932"></a>01932         }
<a name="l01933"></a>01933       }
<a name="l01934"></a>01934 
<a name="l01935"></a>01935       <span class="comment">// Check if the storage is ready.</span>
<a name="l01936"></a>01936       <span class="keywordflow">if</span> (!this.isReady()) {
<a name="l01937"></a>01937         doCallback();
<a name="l01938"></a>01938         <span class="keywordflow">return</span>;
<a name="l01939"></a>01939       }
<a name="l01940"></a>01940 
<a name="l01941"></a>01941       <span class="comment">// Query all terms</span>
<a name="l01942"></a>01942       var store = this._IDBDatabase.transaction([<span class="stringliteral">&#39;homonyms&#39;</span>], <span class="stringliteral">&#39;readonly&#39;</span>)
<a name="l01943"></a>01943         .objectStore(<span class="stringliteral">&#39;homonyms&#39;</span>);
<a name="l01944"></a>01944       var req = store.openCursor();
<a name="l01945"></a>01945 
<a name="l01946"></a>01946       req.onerror = <span class="keyword">function</span>(ev) {
<a name="l01947"></a>01947         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Database read error.&#39;</span>);
<a name="l01948"></a>01948         doCallback();
<a name="l01949"></a>01949       };
<a name="l01950"></a>01950       req.onsuccess = <span class="keyword">function</span>(ev) {
<a name="l01951"></a>01951         var <a class="code" href="../../dc/d6a/xpt__xdr_8h.html#a7056fb315468c5bec29afb3b459e8b92">cursor</a> = ev.target.result;
<a name="l01952"></a>01952         <span class="keywordflow">if</span> (cursor) {
<a name="l01953"></a>01953           var homonyms = cursor.value;
<a name="l01954"></a>01954           <span class="keywordflow">if</span> (homonyms.kana != <span class="stringliteral">&#39;_last_entry_&#39;</span>) {
<a name="l01955"></a>01955             homonymsArray.push(homonyms);
<a name="l01956"></a>01956           }
<a name="l01957"></a>01957           cursor.continue();
<a name="l01958"></a>01958         } <span class="keywordflow">else</span> {
<a name="l01959"></a>01959           doCallback();
<a name="l01960"></a>01960         }
<a name="l01961"></a>01961       };
<a name="l01962"></a>01962     },
<a name="l01963"></a>01963 
<a name="l01964"></a>01964     setAllTerms: <span class="keyword">function</span> indexedDBStorage_setAllTerms(homonymsArray,
<a name="l01965"></a>01965                                                        <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01966"></a>01966       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01967"></a>01967       <span class="keyword">function</span> doCallback() {
<a name="l01968"></a>01968         <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.READY;
<a name="l01969"></a>01969         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01970"></a>01970           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l01971"></a>01971         }
<a name="l01972"></a>01972       }
<a name="l01973"></a>01973 
<a name="l01974"></a>01974       var <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> = homonymsArray.length;
<a name="l01975"></a>01975 
<a name="l01976"></a>01976       <span class="comment">// Check if the storage is ready.</span>
<a name="l01977"></a>01977       <span class="keywordflow">if</span> (!this.isReady() || n == 0) {
<a name="l01978"></a>01978         doCallback();
<a name="l01979"></a>01979         <span class="keywordflow">return</span>;
<a name="l01980"></a>01980       }
<a name="l01981"></a>01981 
<a name="l01982"></a>01982       <span class="comment">// Set the status to busy.</span>
<a name="l01983"></a>01983       this._status = DatabaseStorageBase.StatusCode.BUSY;
<a name="l01984"></a>01984 
<a name="l01985"></a>01985       <span class="comment">// Use task queue to add the terms by batch to prevent blocking the main</span>
<a name="l01986"></a>01986       <span class="comment">// thread.</span>
<a name="l01987"></a>01987       var taskQueue = <span class="keyword">new</span> TaskQueue(
<a name="l01988"></a>01988           <span class="keyword">function</span> taskQueueOnCompleteCallback(queueData) {
<a name="l01989"></a>01989             <span class="keyword">self</span>._count = <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>;
<a name="l01990"></a>01990             doCallback();
<a name="l01991"></a>01991           });
<a name="l01992"></a>01992 
<a name="l01993"></a>01993       var processNextWithDelay = <span class="keyword">function</span> setAllTerms_rocessNextWithDelay() {
<a name="l01994"></a>01994         <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span> nextTask() {
<a name="l01995"></a>01995           taskQueue.processNext();
<a name="l01996"></a>01996         }, 0);
<a name="l01997"></a>01997       };
<a name="l01998"></a>01998 
<a name="l01999"></a>01999       <span class="comment">// Clear all the terms before adding</span>
<a name="l02000"></a>02000       var clearAll = <span class="keyword">function</span> setAllTerms_clearAll(taskQueue, taskData) {
<a name="l02001"></a>02001         var transaction =
<a name="l02002"></a>02002           <span class="keyword">self</span>._IDBDatabase.transaction([<span class="stringliteral">&#39;homonyms&#39;</span>], <span class="stringliteral">&#39;readwrite&#39;</span>);
<a name="l02003"></a>02003         var store = transaction.objectStore(<span class="stringliteral">&#39;homonyms&#39;</span>);
<a name="l02004"></a>02004         var req = store.clear();
<a name="l02005"></a>02005         req.onsuccess = <span class="keyword">function</span>(ev) {
<a name="l02006"></a>02006           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;IndexedDB cleared.&#39;</span>);
<a name="l02007"></a>02007           processNextWithDelay();
<a name="l02008"></a>02008         };
<a name="l02009"></a>02009 
<a name="l02010"></a>02010         req.onerror = <span class="keyword">function</span>(ev) {
<a name="l02011"></a>02011           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Failed to clear IndexedDB.&#39;</span>);
<a name="l02012"></a>02012           <span class="keyword">self</span>._status = DatabaseStorageBase.StatusCode.ERROR;
<a name="l02013"></a>02013           doCallback();
<a name="l02014"></a>02014         };
<a name="l02015"></a>02015 
<a name="l02016"></a>02016       };
<a name="l02017"></a>02017 
<a name="l02018"></a>02018       <span class="comment">// Add a batch of terms</span>
<a name="l02019"></a>02019       var addChunk = <span class="keyword">function</span> setAllTerms_addChunk(taskQueue, taskData) {
<a name="l02020"></a>02020         var transaction =
<a name="l02021"></a>02021           <span class="keyword">self</span>._IDBDatabase.transaction([<span class="stringliteral">&#39;homonyms&#39;</span>], <span class="stringliteral">&#39;readwrite&#39;</span>);
<a name="l02022"></a>02022         var store = transaction.objectStore(<span class="stringliteral">&#39;homonyms&#39;</span>);
<a name="l02023"></a>02023         transaction.onerror = <span class="keyword">function</span>(ev) {
<a name="l02024"></a>02024           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Database write error.&#39;</span>);
<a name="l02025"></a>02025           doCallback();
<a name="l02026"></a>02026         };
<a name="l02027"></a>02027 
<a name="l02028"></a>02028         transaction.oncomplete = <span class="keyword">function</span>() {
<a name="l02029"></a>02029           processNextWithDelay();
<a name="l02030"></a>02030         };
<a name="l02031"></a>02031 
<a name="l02032"></a>02032         var begin = taskData.begin;
<a name="l02033"></a>02033         var <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a> = taskData.end;
<a name="l02034"></a>02034         <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = begin; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt;= <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l02035"></a>02035           var homonyms = homonymsArray[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l02036"></a>02036           store.put(homonyms);
<a name="l02037"></a>02037         }
<a name="l02038"></a>02038 
<a name="l02039"></a>02039         <span class="comment">// Add a special element to indicate that all the items are saved.</span>
<a name="l02040"></a>02040         <span class="keywordflow">if</span> (end === n - 1) {
<a name="l02041"></a>02041           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;=======================&#39;</span>);
<a name="l02042"></a>02042           store.put(<span class="keyword">new</span> Homonyms(<span class="stringliteral">&#39;_last_entry_&#39;</span>, []));
<a name="l02043"></a>02043           <span class="comment">//throw(&#39;jdkdkdjd&#39;);</span>
<a name="l02044"></a>02044         }
<a name="l02045"></a>02045       };
<a name="l02046"></a>02046 
<a name="l02047"></a>02047       taskQueue.push(clearAll, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02048"></a>02048 
<a name="l02049"></a>02049       <span class="keywordflow">for</span> (var begin = 0; begin &lt; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>; begin += 2000) {
<a name="l02050"></a>02050         var end = Math.min(begin + 1999, n - 1);
<a name="l02051"></a>02051         taskQueue.push(addChunk, {begin: begin, end: end});
<a name="l02052"></a>02052       }
<a name="l02053"></a>02053 
<a name="l02054"></a>02054       processNextWithDelay();
<a name="l02055"></a>02055     },
<a name="l02056"></a>02056 
<a name="l02057"></a>02057     getTermsByKana: <span class="keyword">function</span> indexedDBStorage_getTermsByKana(syllablesStr,
<a name="l02058"></a>02058                                                              <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02059"></a>02059       var homonymsArray = [];
<a name="l02060"></a>02060       <span class="keyword">function</span> doCallback() {
<a name="l02061"></a>02061         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02062"></a>02062           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(homonymsArray);
<a name="l02063"></a>02063         }
<a name="l02064"></a>02064       }
<a name="l02065"></a>02065 
<a name="l02066"></a>02066       <span class="comment">// Check if the storage is ready.</span>
<a name="l02067"></a>02067       <span class="keywordflow">if</span> (!this.isReady()) {
<a name="l02068"></a>02068         doCallback();
<a name="l02069"></a>02069         <span class="keywordflow">return</span>;
<a name="l02070"></a>02070       }
<a name="l02071"></a>02071 
<a name="l02072"></a>02072       var store = this._IDBDatabase.transaction([<span class="stringliteral">&#39;homonyms&#39;</span>], <span class="stringliteral">&#39;readonly&#39;</span>)
<a name="l02073"></a>02073         .objectStore(<span class="stringliteral">&#39;homonyms&#39;</span>);
<a name="l02074"></a>02074       var req = store.get(syllablesStr);
<a name="l02075"></a>02075 
<a name="l02076"></a>02076       req.onerror = <span class="keyword">function</span>(ev) {
<a name="l02077"></a>02077         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Database read error.&#39;</span>);
<a name="l02078"></a>02078         doCallback();
<a name="l02079"></a>02079       };
<a name="l02080"></a>02080 
<a name="l02081"></a>02081       req.onsuccess = <span class="keyword">function</span>(ev) {
<a name="l02082"></a>02082         var homonyms = ev.target.result;
<a name="l02083"></a>02083         <span class="keywordflow">if</span> (homonyms) {
<a name="l02084"></a>02084           homonymsArray.push(homonyms);
<a name="l02085"></a>02085         }
<a name="l02086"></a>02086         doCallback();
<a name="l02087"></a>02087       };
<a name="l02088"></a>02088     },
<a name="l02089"></a>02089     <span class="comment">/* getTermsByKana */</span>
<a name="l02090"></a>02090 
<a name="l02091"></a>02091     getTermsByKanaPrefix: <span class="keyword">function</span> indexedDBStorage_getTermsByKanaPrefix(
<a name="l02092"></a>02092                               <a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02093"></a>02093       var homonymsArray = [];
<a name="l02094"></a>02094       <span class="keyword">function</span> doCallback() {
<a name="l02095"></a>02095         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02096"></a>02096           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(homonymsArray);
<a name="l02097"></a>02097         }
<a name="l02098"></a>02098       }
<a name="l02099"></a>02099 
<a name="l02100"></a>02100       <span class="comment">// Check if the storage is ready.</span>
<a name="l02101"></a>02101       <span class="keywordflow">if</span> (!this.isReady()) {
<a name="l02102"></a>02102         doCallback();
<a name="l02103"></a>02103         <span class="keywordflow">return</span>;
<a name="l02104"></a>02104       }
<a name="l02105"></a>02105 
<a name="l02106"></a>02106       var upperBound = <a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>.substr(0, <a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>.length - 1) +
<a name="l02107"></a>02107         String.fromCharCode(<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>.substr(<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>.length - 1).charCodeAt(0) + 1);
<a name="l02108"></a>02108 
<a name="l02109"></a>02109       var store = this._IDBDatabase.transaction([<span class="stringliteral">&#39;homonyms&#39;</span>], <span class="stringliteral">&#39;readonly&#39;</span>)
<a name="l02110"></a>02110         .objectStore(<span class="stringliteral">&#39;homonyms&#39;</span>);
<a name="l02111"></a>02111       var req =
<a name="l02112"></a>02112         store.openCursor(IDBKeyRange.bound(<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>, upperBound, <span class="keyword">true</span>, <span class="keyword">true</span>));
<a name="l02113"></a>02113 
<a name="l02114"></a>02114       req.onerror = <span class="keyword">function</span>(ev) {
<a name="l02115"></a>02115         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Database read error.&#39;</span>);
<a name="l02116"></a>02116         doCallback();
<a name="l02117"></a>02117       };
<a name="l02118"></a>02118       req.onsuccess = <span class="keyword">function</span>(ev) {
<a name="l02119"></a>02119         var cursor = ev.target.result;
<a name="l02120"></a>02120         <span class="keywordflow">if</span> (cursor) {
<a name="l02121"></a>02121           var homonyms = cursor.value;
<a name="l02122"></a>02122           homonymsArray.push(homonyms);
<a name="l02123"></a>02123           cursor.continue();
<a name="l02124"></a>02124         } <span class="keywordflow">else</span> {
<a name="l02125"></a>02125           doCallback();
<a name="l02126"></a>02126         }
<a name="l02127"></a>02127       };
<a name="l02128"></a>02128     }
<a name="l02129"></a>02129   };
<a name="l02130"></a>02130 
<a name="l02131"></a>02131   <span class="comment">// ** IMEngineDatabase is exposed to IME **</span>
<a name="l02132"></a>02132   <span class="comment">// It contains both instances of `jsonStorage` and `indexedDBStorage`</span>
<a name="l02133"></a>02133   <span class="comment">// Query processes in indexedDBStorage if possible, otherwise in jsonStorage</span>
<a name="l02134"></a>02134   var IMEngineDatabase = <span class="keyword">function</span> imedb(dbName, jsonUrl) {
<a name="l02135"></a>02135     var settings;
<a name="l02136"></a>02136 
<a name="l02137"></a>02137     <span class="comment">// Dictionary words&#39; total frequency.</span>
<a name="l02138"></a>02138     var kDictTotalFreq = 770216270;
<a name="l02139"></a>02139 
<a name="l02140"></a>02140     var jsonStorage = <span class="keyword">new</span> JsonStorage(jsonUrl);
<a name="l02141"></a>02141     var indexedDBStorage = <span class="keyword">new</span> IndexedDBStorage(dbName);
<a name="l02142"></a>02142 
<a name="l02143"></a>02143     var iDBCache = {};
<a name="l02144"></a>02144     var cacheTimer;
<a name="l02145"></a>02145     var kCacheTimeout = 10000;
<a name="l02146"></a>02146 
<a name="l02147"></a>02147     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l02148"></a>02148 
<a name="l02149"></a>02149     <span class="comment">/* ==== init functions ==== */</span>
<a name="l02150"></a>02150     var populateDBFromJSON = <span class="keyword">function</span> imedb_populateDBFromJSON(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02151"></a>02151       jsonStorage.getAllTerms(<span class="keyword">function</span> getAllTermsCallback(homonymsArray) {
<a name="l02152"></a>02152         indexedDBStorage.setAllTerms(homonymsArray, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l02153"></a>02153       });
<a name="l02154"></a>02154     };
<a name="l02155"></a>02155 
<a name="l02156"></a>02156     <span class="comment">/* ==== helper functions ==== */</span>
<a name="l02157"></a>02157 
<a name="l02158"></a>02158     <span class="comment">/*</span>
<a name="l02159"></a>02159 <span class="comment">     * Data from IndexedDB gets to kept in iDBCache for kCacheTimeout seconds</span>
<a name="l02160"></a>02160 <span class="comment">     */</span>
<a name="l02161"></a>02161     var cacheSetTimeout = <span class="keyword">function</span> imedb_cacheSetTimeout() {
<a name="l02162"></a>02162       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Set iDBCache timeout.&#39;</span>);
<a name="l02163"></a>02163       <a class="code" href="../../da/da1/timers_8js.html#ab37ff0db33a3bf80b0163adc40a58424">clearTimeout</a>(cacheTimer);
<a name="l02164"></a>02164       cacheTimer = <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span> imedb_cacheTimeout() {
<a name="l02165"></a>02165         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Empty iDBCache.&#39;</span>);
<a name="l02166"></a>02166         iDBCache = {};
<a name="l02167"></a>02167       }, kCacheTimeout);
<a name="l02168"></a>02168     };
<a name="l02169"></a>02169 
<a name="l02170"></a>02170     <span class="comment">/* ==== init ==== */</span>
<a name="l02171"></a>02171     this.<a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a> = <span class="keyword">function</span> imedb_init(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>) {
<a name="l02172"></a>02172       settings = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>;
<a name="l02173"></a>02173 
<a name="l02174"></a>02174       var <a class="code" href="../../d5/dd7/apps_2communications_2ftu_2js_2app_8js.html#a7d18142e8b0bc568b1692cd28ba1d8a7">ready</a> = <span class="keyword">function</span>() {
<a name="l02175"></a>02175         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Ready.&#39;</span>);
<a name="l02176"></a>02176         <span class="keywordflow">if</span> (settings.ready)
<a name="l02177"></a>02177           settings.ready();
<a name="l02178"></a>02178       };
<a name="l02179"></a>02179 
<a name="l02180"></a>02180       <span class="keywordflow">if</span> (!settings.enableIndexedDB) {
<a name="l02181"></a>02181         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;IndexedDB disabled; Downloading JSON ...&#39;</span>);
<a name="l02182"></a>02182         jsonStorage.init(ready);
<a name="l02183"></a>02183         <span class="keywordflow">return</span>;
<a name="l02184"></a>02184       }
<a name="l02185"></a>02185 
<a name="l02186"></a>02186       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Probing IndexedDB ...&#39;</span>);
<a name="l02187"></a>02187       indexedDBStorage.init(<span class="keyword">function</span> indexedDBStorageInitCallback() {
<a name="l02188"></a>02188         <span class="keywordflow">if</span> (!indexedDBStorage.isReady()) {
<a name="l02189"></a>02189           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;IndexedDB not available; Downloading JSON ...&#39;</span>);
<a name="l02190"></a>02190           jsonStorage.init(ready);
<a name="l02191"></a>02191           <span class="keywordflow">return</span>;
<a name="l02192"></a>02192         }
<a name="l02193"></a>02193         <a class="code" href="../../d5/dd7/apps_2communications_2ftu_2js_2app_8js.html#a7d18142e8b0bc568b1692cd28ba1d8a7">ready</a>();
<a name="l02194"></a>02194         <span class="keywordflow">if</span> (indexedDBStorage.isEmpty()) {
<a name="l02195"></a>02195           jsonStorage.init(<span class="keyword">function</span> jsonStorageInitCallback() {
<a name="l02196"></a>02196             <span class="keywordflow">if</span> (!jsonStorage.isReady()) {
<a name="l02197"></a>02197               <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;JSON failed to download.&#39;</span>);
<a name="l02198"></a>02198               <span class="keywordflow">return</span>;
<a name="l02199"></a>02199             }
<a name="l02200"></a>02200 
<a name="l02201"></a>02201             <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(
<a name="l02202"></a>02202               <span class="stringliteral">&#39;JSON loaded,&#39;</span> +
<a name="l02203"></a>02203               <span class="stringliteral">&#39;IME is ready to use while inserting data into db ...&#39;</span>
<a name="l02204"></a>02204               );
<a name="l02205"></a>02205             populateDBFromJSON(<span class="keyword">function</span> populateDBFromJSONCallback() {
<a name="l02206"></a>02206               <span class="keywordflow">if</span> (!indexedDBStorage.isEmpty()) {
<a name="l02207"></a>02207                 <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;IndexedDB ready and switched to indexedDB backend.&#39;</span>);
<a name="l02208"></a>02208                 jsonStorage.uninit();
<a name="l02209"></a>02209               } <span class="keywordflow">else</span> {
<a name="l02210"></a>02210                 <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Failed to populate IndexedDB from JSON.&#39;</span>);
<a name="l02211"></a>02211               }
<a name="l02212"></a>02212             });
<a name="l02213"></a>02213           });
<a name="l02214"></a>02214         }
<a name="l02215"></a>02215       });
<a name="l02216"></a>02216     };
<a name="l02217"></a>02217 
<a name="l02218"></a>02218     <span class="comment">/* ==== uninit ==== */</span>
<a name="l02219"></a>02219     this.<a class="code" href="../../d3/d44/updatable_8js.html#a0a545f3fc3649048e3c5c41303a26cc3">uninit</a> = <span class="keyword">function</span> imedb_uninit() {
<a name="l02220"></a>02220       indexedDBStorage.uninit();
<a name="l02221"></a>02221       jsonStorage.uninit();
<a name="l02222"></a>02222     };
<a name="l02223"></a>02223 
<a name="l02224"></a>02224     <span class="comment">// return instance of indexedDBStorage if possible</span>
<a name="l02225"></a>02225     <span class="comment">//        otherwise jsonStorage</span>
<a name="l02226"></a>02226     <span class="comment">//        null if neither is not available</span>
<a name="l02227"></a>02227     var _getUsableStorage = <span class="keyword">function</span> imedb__getUsableStorage() {
<a name="l02228"></a>02228       <span class="keywordflow">if</span> (settings.enableIndexedDB &amp;&amp;
<a name="l02229"></a>02229           indexedDBStorage.isReady() &amp;&amp;
<a name="l02230"></a>02230           !indexedDBStorage.isEmpty()) {
<a name="l02231"></a>02231             <span class="keywordflow">return</span> indexedDBStorage;
<a name="l02232"></a>02232           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (jsonStorage.isReady() &amp;&amp; !jsonStorage.isEmpty()) {
<a name="l02233"></a>02233             <span class="keywordflow">return</span> jsonStorage;
<a name="l02234"></a>02234           } <span class="keywordflow">else</span> {
<a name="l02235"></a>02235             <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02236"></a>02236           }
<a name="l02237"></a>02237     };
<a name="l02238"></a>02238 
<a name="l02239"></a>02239     <span class="comment">/* ==== db lookup functions ==== */</span>
<a name="l02240"></a>02240 
<a name="l02241"></a>02241     <span class="comment">// syllables kana</span>
<a name="l02242"></a>02242     <span class="comment">// textStr kanji</span>
<a name="l02243"></a>02243     <span class="comment">// callback Function</span>
<a name="l02244"></a>02244     this.getSuggestions = <span class="keyword">function</span> imedb_getSuggestions(kanaStr, kanjiStr,
<a name="l02245"></a>02245                                                         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02246"></a>02246       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;getSuggestions &#39;</span> + kanjiStr + <span class="charliteral">&#39; &#39;</span> + kanaStr);
<a name="l02247"></a>02247       var storage = _getUsableStorage();
<a name="l02248"></a>02248       <span class="keywordflow">if</span> (!storage) {
<a name="l02249"></a>02249         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Database not ready.&#39;</span>);
<a name="l02250"></a>02250         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>([]);
<a name="l02251"></a>02251         <span class="keywordflow">return</span>;
<a name="l02252"></a>02252       }
<a name="l02253"></a>02253 
<a name="l02254"></a>02254       var <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a> = [];
<a name="l02255"></a>02255 
<a name="l02256"></a>02256       var _matchTerm = <span class="keyword">function</span> getSuggestions_matchTerm(term) {
<a name="l02257"></a>02257         <span class="keywordflow">if</span> (term.kanji.substr(0, kanjiStr.length) !== kanjiStr)
<a name="l02258"></a>02258           <span class="keywordflow">return</span>;
<a name="l02259"></a>02259         <span class="keywordflow">if</span> (term.kanji === kanjiStr)
<a name="l02260"></a>02260           <span class="keywordflow">return</span>;
<a name="l02261"></a>02261         result.push(term);
<a name="l02262"></a>02262       };
<a name="l02263"></a>02263 
<a name="l02264"></a>02264       var _processResult = <span class="keyword">function</span> getSuggestions_processResult(r) {
<a name="l02265"></a>02265         r = r.sort(
<a name="l02266"></a>02266             <span class="keyword">function</span> getSuggestions_sort(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) {
<a name="l02267"></a>02267               <span class="keywordflow">return</span> (<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.freq - <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.freq);
<a name="l02268"></a>02268             }
<a name="l02269"></a>02269             );
<a name="l02270"></a>02270         var result = [];
<a name="l02271"></a>02271         var t = [];
<a name="l02272"></a>02272         r.forEach(<span class="keyword">function</span> terms_foreach(term) {
<a name="l02273"></a>02273           <span class="keywordflow">if</span> (t.indexOf(term.kanji) !== -1) <span class="keywordflow">return</span>;
<a name="l02274"></a>02274           t.push(term.kanji);
<a name="l02275"></a>02275           result.push(term);
<a name="l02276"></a>02276         });
<a name="l02277"></a>02277         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>;
<a name="l02278"></a>02278       };
<a name="l02279"></a>02279 
<a name="l02280"></a>02280       var result = [];
<a name="l02281"></a>02281 
<a name="l02282"></a>02282       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Get suggestion for &#39;</span> + kanjiStr + <span class="charliteral">&#39;.&#39;</span>);
<a name="l02283"></a>02283 
<a name="l02284"></a>02284       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> iDBCache[<span class="stringliteral">&#39;SUGGESTION:&#39;</span> + kanjiStr] !== <span class="stringliteral">&#39;undefined&#39;</span>) {
<a name="l02285"></a>02285         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Found in iDBCache.&#39;</span>);
<a name="l02286"></a>02286         cacheSetTimeout();
<a name="l02287"></a>02287         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(iDBCache[<span class="stringliteral">&#39;SUGGESTION:&#39;</span> + kanjiStr]);
<a name="l02288"></a>02288         <span class="keywordflow">return</span>;
<a name="l02289"></a>02289       }
<a name="l02290"></a>02290 
<a name="l02291"></a>02291       <span class="comment">// by prefix</span>
<a name="l02292"></a>02292       storage.getTermsByKanaPrefix(kanaStr,
<a name="l02293"></a>02293         <span class="keyword">function</span> getTermsByKanaPrefix_callback(homonymsArray) {
<a name="l02294"></a>02294 
<a name="l02295"></a>02295         <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; homonymsArray.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l02296"></a>02296           var homonyms = homonymsArray[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l02297"></a>02297           homonyms.terms.forEach(_matchTerm);
<a name="l02298"></a>02298         }
<a name="l02299"></a>02299         <span class="keywordflow">if</span> (result.length) {
<a name="l02300"></a>02300           result = _processResult(result);
<a name="l02301"></a>02301         } <span class="keywordflow">else</span> {
<a name="l02302"></a>02302           result = [];
<a name="l02303"></a>02303         }
<a name="l02304"></a>02304         cacheSetTimeout();
<a name="l02305"></a>02305         iDBCache[<span class="stringliteral">&#39;SUGGESTION:&#39;</span> + kanjiStr] = <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>;
<a name="l02306"></a>02306         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(result);
<a name="l02307"></a>02307       });
<a name="l02308"></a>02308 
<a name="l02309"></a>02309     };
<a name="l02310"></a>02310     <span class="comment">/* end getSuggestions */</span>
<a name="l02311"></a>02311 
<a name="l02312"></a>02312     this.getTerms = <span class="keyword">function</span> imedb_getTerms(kanaArr, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02313"></a>02313 
<a name="l02314"></a>02314       var storage = _getUsableStorage();
<a name="l02315"></a>02315       <span class="keywordflow">if</span> (!storage) {
<a name="l02316"></a>02316         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Database not ready.&#39;</span>);
<a name="l02317"></a>02317         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>([]);
<a name="l02318"></a>02318         <span class="keywordflow">return</span>;
<a name="l02319"></a>02319       }
<a name="l02320"></a>02320 
<a name="l02321"></a>02321       var kanaStr = SyllableUtils.arrayToString(kanaArr);
<a name="l02322"></a>02322       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Get terms for &#39;</span> + kanaStr + <span class="charliteral">&#39;.&#39;</span>);
<a name="l02323"></a>02323 
<a name="l02324"></a>02324       var _processResult = <span class="keyword">function</span> processResult(r, limit) {
<a name="l02325"></a>02325         r = r.sort(
<a name="l02326"></a>02326           <span class="keyword">function</span> sort_result(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) {
<a name="l02327"></a>02327             <span class="keywordflow">return</span> (<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.freq - <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.freq);
<a name="l02328"></a>02328           }
<a name="l02329"></a>02329         );
<a name="l02330"></a>02330         var result = [];
<a name="l02331"></a>02331         var t = [];
<a name="l02332"></a>02332         r.forEach(<span class="keyword">function</span>(term) {
<a name="l02333"></a>02333           <span class="keywordflow">if</span> (t.indexOf(term.kanji) !== -1) <span class="keywordflow">return</span>;
<a name="l02334"></a>02334           t.push(term.kanji);
<a name="l02335"></a>02335           result.push(term);
<a name="l02336"></a>02336         });
<a name="l02337"></a>02337         <span class="keywordflow">if</span> (limit &gt; 0) {
<a name="l02338"></a>02338           result = result.slice(0, limit);
<a name="l02339"></a>02339         }
<a name="l02340"></a>02340         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>;
<a name="l02341"></a>02341       };
<a name="l02342"></a>02342 
<a name="l02343"></a>02343       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> iDBCache[kanaStr] !== <span class="stringliteral">&#39;undefined&#39;</span>) {
<a name="l02344"></a>02344         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Found in iDBCache.&#39;</span>);
<a name="l02345"></a>02345         cacheSetTimeout();
<a name="l02346"></a>02346         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(iDBCache[kanaStr]);
<a name="l02347"></a>02347         <span class="keywordflow">return</span>;
<a name="l02348"></a>02348       }
<a name="l02349"></a>02349 
<a name="l02350"></a>02350       storage.getTermsByKana(kanaStr,
<a name="l02351"></a>02351         <span class="keyword">function</span>(homonymsArray) {
<a name="l02352"></a>02352           var result = [];
<a name="l02353"></a>02353           <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; homonymsArray.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l02354"></a>02354             var homonyms = homonymsArray[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l02355"></a>02355             result = result.concat(homonyms.terms);
<a name="l02356"></a>02356           }
<a name="l02357"></a>02357           <span class="keywordflow">if</span> (result.length) {
<a name="l02358"></a>02358             result = _processResult(result, -1);
<a name="l02359"></a>02359           } <span class="keywordflow">else</span> {
<a name="l02360"></a>02360             result = [];
<a name="l02361"></a>02361           }
<a name="l02362"></a>02362           cacheSetTimeout();
<a name="l02363"></a>02363           iDBCache[kanaStr] = <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>;
<a name="l02364"></a>02364           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(result);
<a name="l02365"></a>02365         }
<a name="l02366"></a>02366       );
<a name="l02367"></a>02367 
<a name="l02368"></a>02368     };
<a name="l02369"></a>02369     <span class="comment">/* end getTerms */</span>
<a name="l02370"></a>02370 
<a name="l02371"></a>02371     this.getTermWithHighestScore =
<a name="l02372"></a>02372       <span class="keyword">function</span> imedb_getTermWithHighestScore(syllables, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02373"></a>02373 
<a name="l02374"></a>02374       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;getTermWithHighestScore &#39;</span> + syllables);
<a name="l02375"></a>02375       <span class="keyword">self</span>.getTerms(syllables,
<a name="l02376"></a>02376         <span class="keyword">function</span> getTermsCallback(terms) {
<a name="l02377"></a>02377           <span class="keywordflow">if</span> (terms.length == 0) {
<a name="l02378"></a>02378             debug(<span class="stringliteral">&#39;no terms&#39;</span>);
<a name="l02379"></a>02379             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="keyword">false</span>);
<a name="l02380"></a>02380             <span class="keywordflow">return</span>;
<a name="l02381"></a>02381           }
<a name="l02382"></a>02382           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(terms[0]);
<a name="l02383"></a>02383         }
<a name="l02384"></a>02384       );
<a name="l02385"></a>02385     };
<a name="l02386"></a>02386     <span class="comment">/* end getTermWithHighestScore */</span>
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     <span class="comment">// sentence is a list of terms</span>
<a name="l02389"></a>02389     this.getSentence = <span class="keyword">function</span> imedb_getSentence(kanaArr, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02390"></a>02390       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;getSentence &#39;</span> + kanaArr);
<a name="l02391"></a>02391       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l02392"></a>02392 
<a name="l02393"></a>02393       var doCallback = <span class="keyword">function</span> getSentence_doCallback(sentence) {
<a name="l02394"></a>02394         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02395"></a>02395           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(sentence);
<a name="l02396"></a>02396         }
<a name="l02397"></a>02397       };
<a name="l02398"></a>02398 
<a name="l02399"></a>02399       var n = kanaArr.length;
<a name="l02400"></a>02400 
<a name="l02401"></a>02401       <span class="keywordflow">if</span> (n == 0) {
<a name="l02402"></a>02402         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>([]);
<a name="l02403"></a>02403       }
<a name="l02404"></a>02404 
<a name="l02405"></a>02405       var taskQueue = <span class="keyword">new</span> TaskQueue(
<a name="l02406"></a>02406         <span class="keyword">function</span> taskQueueOnCompleteCallback(queueData) {
<a name="l02407"></a>02407           var sentences = queueData.sentences;
<a name="l02408"></a>02408           var sentence = sentences[sentences.length - 1];
<a name="l02409"></a>02409           doCallback(sentence);
<a name="l02410"></a>02410         }
<a name="l02411"></a>02411       );
<a name="l02412"></a>02412 
<a name="l02413"></a>02413       taskQueue.data = {
<a name="l02414"></a>02414         sentences: [[], []],
<a name="l02415"></a>02415         probabilities: [0, MAX_FREQUENCY],
<a name="l02416"></a>02416         sentenceLength: 1,
<a name="l02417"></a>02417         lastPhraseLength: 1
<a name="l02418"></a>02418       };
<a name="l02419"></a>02419 
<a name="l02420"></a>02420       var getSentenceSubTask = <span class="keyword">function</span> getSentence_subTask(taskQueue,
<a name="l02421"></a>02421                                                             taskData) {
<a name="l02422"></a>02422         var queueData = taskQueue.data;
<a name="l02423"></a>02423         var sentenceLength = queueData.sentenceLength;
<a name="l02424"></a>02424         var lastPhraseLength = queueData.lastPhraseLength;
<a name="l02425"></a>02425         var sentences = queueData.sentences;
<a name="l02426"></a>02426         var probabilities = queueData.probabilities;
<a name="l02427"></a>02427 
<a name="l02428"></a>02428         <span class="keywordflow">if</span> (probabilities.length &lt; sentenceLength + 1) {
<a name="l02429"></a>02429           probabilities.push(MAX_FREQUENCY);
<a name="l02430"></a>02430         }
<a name="l02431"></a>02431         <span class="keywordflow">if</span> (sentences.length &lt; sentenceLength + 1) {
<a name="l02432"></a>02432           sentences.push([]);
<a name="l02433"></a>02433         }
<a name="l02434"></a>02434         var maxProb = probabilities[sentenceLength];
<a name="l02435"></a>02435         var <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a> = kanaArr.slice(sentenceLength -
<a name="l02436"></a>02436             lastPhraseLength, sentenceLength);
<a name="l02437"></a>02437 
<a name="l02438"></a>02438         <span class="keyword">self</span>.getTermWithHighestScore(s,
<a name="l02439"></a>02439           <span class="keyword">function</span> getTermWithHighestScoreCallback(term) {
<a name="l02440"></a>02440             var syllable = s.join(<span class="stringliteral">&#39;&#39;</span>);
<a name="l02441"></a>02441 
<a name="l02442"></a>02442             <span class="keywordflow">if</span> (!term) {
<a name="l02443"></a>02443               term = {<a class="code" href="../../dd/d9f/namespaceconv.html#a01ac99bfe12d393fc7ccd765276989b0">kanji</a>: syllable, <a class="code" href="../../dd/d9f/namespaceconv.html#a704c20f94d48395d1ae0a44a780f9c6f">freq</a>: MAX_FREQUENCY, <a class="code" href="../../dd/d9f/namespaceconv.html#a314aa0b2fece93eadbac007d645bad7b">kana</a>: syllable};
<a name="l02444"></a>02444             }
<a name="l02445"></a>02445 
<a name="l02446"></a>02446             var prob = probabilities[sentenceLength -
<a name="l02447"></a>02447               lastPhraseLength] + term.freq;
<a name="l02448"></a>02448             <span class="keywordflow">if</span> (prob &lt; probabilities[sentenceLength]) {
<a name="l02449"></a>02449               probabilities[sentenceLength] = prob;
<a name="l02450"></a>02450               sentences[sentenceLength] =
<a name="l02451"></a>02451                 sentences[sentenceLength - lastPhraseLength].concat(term);
<a name="l02452"></a>02452             }
<a name="l02453"></a>02453 
<a name="l02454"></a>02454             <span class="comment">// process next step</span>
<a name="l02455"></a>02455             <span class="keywordflow">if</span> (lastPhraseLength &lt; sentenceLength) {
<a name="l02456"></a>02456               queueData.lastPhraseLength++;
<a name="l02457"></a>02457             } <span class="keywordflow">else</span> {
<a name="l02458"></a>02458               queueData.lastPhraseLength = 1;
<a name="l02459"></a>02459               <span class="keywordflow">if</span> (sentenceLength &lt; n) {
<a name="l02460"></a>02460                 queueData.sentenceLength++;
<a name="l02461"></a>02461               } <span class="keywordflow">else</span> {
<a name="l02462"></a>02462                 taskQueue.processNext();
<a name="l02463"></a>02463                 <span class="keywordflow">return</span>;
<a name="l02464"></a>02464               }
<a name="l02465"></a>02465             }
<a name="l02466"></a>02466             taskQueue.push(getSentenceSubTask, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02467"></a>02467             taskQueue.processNext();
<a name="l02468"></a>02468           }
<a name="l02469"></a>02469         );
<a name="l02470"></a>02470       };
<a name="l02471"></a>02471 
<a name="l02472"></a>02472       taskQueue.push(getSentenceSubTask, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02473"></a>02473       taskQueue.processNext();
<a name="l02474"></a>02474     };
<a name="l02475"></a>02475     <span class="comment">/* end getSentence */</span>
<a name="l02476"></a>02476   };
<a name="l02477"></a>02477   <span class="comment">/* end IMEngineDatabase */</span>
<a name="l02478"></a>02478 })();
<a name="l02479"></a>02479 
<a name="l02480"></a>02480 <span class="comment">// TODO current bugs</span>
<a name="l02481"></a>02481 <span class="comment">// 1. little case hiragana cannot convert to katakana</span>
<a name="l02482"></a>02482 <span class="comment">// 2. getSuggestion</span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../dc/d5f/jskanji_8js.html">jskanji.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:52:30に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
