<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: configurator.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('dc/d6d/build__stage_2email_2js_2ext_2mailapi_2composite_2configurator_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">configurator.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../dc/d6d/build__stage_2email_2js_2ext_2mailapi_2composite_2configurator_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00049"></a>00049 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/errbackoff&#39;</span>,
<a name="l00050"></a>00050   [
<a name="l00051"></a>00051     <span class="stringliteral">&#39;./date&#39;</span>,
<a name="l00052"></a>00052     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l00053"></a>00053     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l00054"></a>00054     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l00055"></a>00055   ],
<a name="l00056"></a>00056   <span class="keyword">function</span>(
<a name="l00057"></a>00057     $date,
<a name="l00058"></a>00058     $log,
<a name="l00059"></a>00059     $module,
<a name="l00060"></a>00060     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l00061"></a>00061   ) {
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 var BACKOFF_DURATIONS = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BACKOFF_DURATIONS = [
<a name="l00064"></a>00064   { fixedMS: 0,    randomMS: 0 },
<a name="l00065"></a>00065   { fixedMS: 800,  randomMS: 400 },
<a name="l00066"></a>00066   { fixedMS: 4500, randomMS: 1000 },
<a name="l00067"></a>00067 ];
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 var BAD_RESOURCE_RETRY_DELAYS_MS = [
<a name="l00070"></a>00070   1000,
<a name="l00071"></a>00071   60 * 1000,
<a name="l00072"></a>00072   2 * 60 * 1000,
<a name="l00073"></a>00073 ];
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 var setTimeoutFunc = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout.bind(<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_useTimeoutFunc = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#ad84b078786561118564537030cd7a8b1">func</a>) {
<a name="l00078"></a>00078   setTimeoutFunc = <a class="code" href="../../d2/d7d/jsapi_8h.html#ad84b078786561118564537030cd7a8b1">func</a>;
<a name="l00079"></a>00079   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; BACKOFF_DURATIONS.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00080"></a>00080     BACKOFF_DURATIONS[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].randomMS = 0;
<a name="l00081"></a>00081   }
<a name="l00082"></a>00082 };
<a name="l00083"></a>00083 
<a name="l00093"></a>00093 <span class="keyword">function</span> BackoffEndpoint(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, listener, parentLog) {
<a name="l00104"></a>00104   this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> = <span class="stringliteral">&#39;healthy&#39;</span>;
<a name="l00105"></a>00105   this._iNextBackoff = 0;
<a name="l00106"></a>00106   this._LOG = <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#af6bd479a55b8d304e23d9a96d199c3aa">LOGFAB</a>.BackoffEndpoint(<span class="keyword">this</span>, parentLog, <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l00107"></a>00107   this._LOG.state(this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   this._badResources = {};
<a name="l00110"></a>00110 
<a name="l00111"></a>00111   this.listener = listener;
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 BackoffEndpoint.prototype = {
<a name="l00114"></a>00114   _setState: <span class="keyword">function</span>(newState) {
<a name="l00115"></a>00115     <span class="keywordflow">if</span> (this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> === newState)
<a name="l00116"></a>00116       <span class="keywordflow">return</span>;
<a name="l00117"></a>00117     this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> = newState;
<a name="l00118"></a>00118     this._LOG.state(newState);
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (this.listener)
<a name="l00120"></a>00120       this.listener.onEndpointStateChange(newState);
<a name="l00121"></a>00121   },
<a name="l00122"></a>00122 
<a name="l00123"></a>00123   noteConnectSuccess: <span class="keyword">function</span>() {
<a name="l00124"></a>00124     this._setState(<span class="stringliteral">&#39;healthy&#39;</span>);
<a name="l00125"></a>00125     this._iNextBackoff = 0;
<a name="l00126"></a>00126   },
<a name="l00127"></a>00127 
<a name="l00143"></a>00143   noteConnectFailureMaybeRetry: <span class="keyword">function</span>(reachable) {
<a name="l00144"></a>00144     this._LOG.connectFailure(reachable);
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> === <span class="stringliteral">&#39;shutdown&#39;</span>)
<a name="l00146"></a>00146       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (reachable) {
<a name="l00149"></a>00149       this._setState(<span class="stringliteral">&#39;broken&#39;</span>);
<a name="l00150"></a>00150       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="keywordflow">if</span> (this._iNextBackoff &gt; 0)
<a name="l00154"></a>00154       this._setState(reachable ? <span class="stringliteral">&#39;broken&#39;</span> : <span class="stringliteral">&#39;unreachable&#39;</span>);
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     <span class="comment">// (Once this saturates, we never perform retries until the connection is</span>
<a name="l00157"></a>00157     <span class="comment">// healthy again.  We do attempt re-connections when triggered by user</span>
<a name="l00158"></a>00158     <span class="comment">// activity or synchronization logic; they just won&#39;t get retries.)</span>
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (this._iNextBackoff &gt;= BACKOFF_DURATIONS.length)
<a name="l00160"></a>00160       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00163"></a>00163   },
<a name="l00164"></a>00164 
<a name="l00173"></a>00173   noteBrokenConnection: <span class="keyword">function</span>() {
<a name="l00174"></a>00174     this._LOG.connectFailure(<span class="keyword">true</span>);
<a name="l00175"></a>00175     this._setState(<span class="stringliteral">&#39;broken&#39;</span>);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     this._iNextBackoff = BACKOFF_DURATIONS.length;
<a name="l00178"></a>00178   },
<a name="l00179"></a>00179 
<a name="l00180"></a>00180   scheduleConnectAttempt: <span class="keyword">function</span>(connectFunc) {
<a name="l00181"></a>00181     <span class="keywordflow">if</span> (this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> === <span class="stringliteral">&#39;shutdown&#39;</span>)
<a name="l00182"></a>00182       <span class="keywordflow">return</span>;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <span class="comment">// If we have already saturated our retries then there won&#39;t be any</span>
<a name="l00185"></a>00185     <span class="comment">// automatic retries and this request is assumed to want us to try and</span>
<a name="l00186"></a>00186     <span class="comment">// create a connection right now.</span>
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (this._iNextBackoff &gt;= BACKOFF_DURATIONS.length) {
<a name="l00188"></a>00188       connectFunc();
<a name="l00189"></a>00189       <span class="keywordflow">return</span>;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     var backoff = BACKOFF_DURATIONS[this._iNextBackoff++],
<a name="l00193"></a>00193         <a class="code" href="../../d2/db9/newnotification_8js.html#ad26070262d4c1d2238051d300ac46a8b">delay</a> = backoff.fixedMS +
<a name="l00194"></a>00194                 Math.floor(Math.random() * backoff.randomMS);
<a name="l00195"></a>00195     setTimeoutFunc(connectFunc, delay);
<a name="l00196"></a>00196   },
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   noteBadResource: <span class="keyword">function</span>(resourceId) {
<a name="l00199"></a>00199     var now = $date.NOW();
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (!this._badResources.hasOwnProperty(resourceId)) {
<a name="l00201"></a>00201       this._badResources[resourceId] = { <a class="code" href="../../de/deb/jsdbgapi_8h.html#af811e5c0ef06b777b160f87806b7285e">count</a>: 1, last: now };
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203     <span class="keywordflow">else</span> {
<a name="l00204"></a>00204       var <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a> = this._badResources[resourceId];
<a name="l00205"></a>00205       info.count++;
<a name="l00206"></a>00206       info.last = now;
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208   },
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   resourceIsOkayToUse: <span class="keyword">function</span>(resourceId) {
<a name="l00211"></a>00211     <span class="keywordflow">if</span> (!this._badResources.hasOwnProperty(resourceId))
<a name="l00212"></a>00212       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00213"></a>00213     var <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a> = this._badResources[resourceId], now = $date.NOW();
<a name="l00214"></a>00214   },
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>() {
<a name="l00217"></a>00217     this._setState(<span class="stringliteral">&#39;shutdown&#39;</span>);
<a name="l00218"></a>00218   },
<a name="l00219"></a>00219 };
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.createEndpoint = <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, listener, parentLog) {
<a name="l00222"></a>00222   <span class="keywordflow">return</span> <span class="keyword">new</span> BackoffEndpoint(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, listener, parentLog);
<a name="l00223"></a>00223 };
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 var <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#af6bd479a55b8d304e23d9a96d199c3aa">LOGFAB</a> = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l00226"></a>00226   BackoffEndpoint: {
<a name="l00227"></a>00227     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: $log.TASK,
<a name="l00228"></a>00228     subtype: $log.CLIENT,
<a name="l00229"></a>00229     stateVars: {
<a name="l00230"></a>00230       <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>: <span class="keyword">false</span>,
<a name="l00231"></a>00231     },
<a name="l00232"></a>00232     events: {
<a name="l00233"></a>00233       connectFailure: { reachable: <span class="keyword">true</span> },
<a name="l00234"></a>00234     },
<a name="l00235"></a>00235     errors: {
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237   },
<a name="l00238"></a>00238 });
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 }); <span class="comment">// end define</span>
<a name="l00241"></a>00241 ;
<a name="l00242"></a>00242 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/imap/folder&#39;</span>,
<a name="l00243"></a>00243   [
<a name="l00244"></a>00244     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l00245"></a>00245     <span class="stringliteral">&#39;../a64&#39;</span>,
<a name="l00246"></a>00246     <span class="stringliteral">&#39;../allback&#39;</span>,
<a name="l00247"></a>00247     <span class="stringliteral">&#39;../date&#39;</span>,
<a name="l00248"></a>00248     <span class="stringliteral">&#39;../syncbase&#39;</span>,
<a name="l00249"></a>00249     <span class="stringliteral">&#39;../util&#39;</span>,
<a name="l00250"></a>00250     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l00251"></a>00251     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l00252"></a>00252     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l00253"></a>00253   ],
<a name="l00254"></a>00254   <span class="keyword">function</span>(
<a name="l00255"></a>00255     $log,
<a name="l00256"></a>00256     $a64,
<a name="l00257"></a>00257     $allback,
<a name="l00258"></a>00258     $date,
<a name="l00259"></a>00259     $sync,
<a name="l00260"></a>00260     $util,
<a name="l00261"></a>00261     $module,
<a name="l00262"></a>00262     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l00263"></a>00263     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l00264"></a>00264   ) {
<a name="l00265"></a>00265 
<a name="l00269"></a>00269 var $imaptextparser = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00270"></a>00270 var $imapsnippetparser = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00271"></a>00271 var $imapbodyfetcher = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00272"></a>00272 var $imapchew = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00273"></a>00273 var $imapsync = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 var allbackMaker = $allback.allbackMaker,
<a name="l00276"></a>00276     bsearchForInsert = $util.bsearchForInsert,
<a name="l00277"></a>00277     bsearchMaybeExists = $util.bsearchMaybeExists,
<a name="l00278"></a>00278     cmpHeaderYoungToOld = $util.cmpHeaderYoungToOld,
<a name="l00279"></a>00279     DAY_MILLIS = $date.DAY_MILLIS,
<a name="l00280"></a>00280     NOW = $date.NOW,
<a name="l00281"></a>00281     BEFORE = $date.BEFORE,
<a name="l00282"></a>00282     ON_OR_BEFORE = $date.ON_OR_BEFORE,
<a name="l00283"></a>00283     SINCE = $date.SINCE,
<a name="l00284"></a>00284     TIME_DIR_AT_OR_BEYOND = $date.TIME_DIR_AT_OR_BEYOND,
<a name="l00285"></a>00285     TIME_DIR_ADD = $date.TIME_DIR_ADD,
<a name="l00286"></a>00286     TIME_DIR_DELTA = $date.TIME_DIR_DELTA,
<a name="l00287"></a>00287     makeDaysAgo = $date.makeDaysAgo,
<a name="l00288"></a>00288     makeDaysBefore = $date.makeDaysBefore,
<a name="l00289"></a>00289     quantizeDate = $date.quantizeDate,
<a name="l00290"></a>00290     PASTWARDS = 1, FUTUREWARDS = -1;
<a name="l00291"></a>00291 
<a name="l00297"></a>00297 <span class="keyword">function</span> compactArray(<a class="code" href="../../d9/d43/membuster_8js.html#a9219f6f481200e42d75e135845aeeb3b">arr</a>) {
<a name="l00298"></a>00298   <span class="comment">// this could also be done with a write pointer.</span>
<a name="l00299"></a>00299   var delta = 0, <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a> = <a class="code" href="../../d9/d43/membuster_8js.html#a9219f6f481200e42d75e135845aeeb3b">arr</a>.length;
<a name="l00300"></a>00300   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00301"></a>00301     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a> = <a class="code" href="../../d9/d43/membuster_8js.html#a9219f6f481200e42d75e135845aeeb3b">arr</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l00302"></a>00302     <span class="keywordflow">if</span> (obj === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l00303"></a>00303       delta++;
<a name="l00304"></a>00304       <span class="keywordflow">continue</span>;
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (delta)
<a name="l00307"></a>00307       <a class="code" href="../../d9/d43/membuster_8js.html#a9219f6f481200e42d75e135845aeeb3b">arr</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> - delta] = <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>;
<a name="l00308"></a>00308   }
<a name="l00309"></a>00309   <span class="keywordflow">if</span> (delta)
<a name="l00310"></a>00310     <a class="code" href="../../d9/d43/membuster_8js.html#a9219f6f481200e42d75e135845aeeb3b">arr</a>.splice(len - delta, delta);
<a name="l00311"></a>00311   <span class="keywordflow">return</span> <a class="code" href="../../d9/d43/membuster_8js.html#a9219f6f481200e42d75e135845aeeb3b">arr</a>;
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00320"></a>00320 var BASELINE_SEARCH_OPTIONS = [<span class="stringliteral">&#39;!DELETED&#39;</span>];
<a name="l00321"></a>00321 
<a name="l00325"></a>00325 var NUMBER_OF_SNIPPET_BYTES = 256;
<a name="l00326"></a>00326 
<a name="l00330"></a>00330 var MAX_FETCH_BYTES = (Math.pow(2, 32) - 1);
<a name="l00331"></a>00331 
<a name="l00365"></a>00365 <span class="keyword">function</span> ImapFolderConn(account, storage, _parentLog) {
<a name="l00366"></a>00366   this._account = account;
<a name="l00367"></a>00367   this._storage = storage;
<a name="l00368"></a>00368   this._LOG = LOGFAB.ImapFolderConn(<span class="keyword">this</span>, _parentLog, storage.folderId);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   this._conn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00371"></a>00371   this.box = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   this._deathback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 ImapFolderConn.prototype = {
<a name="l00399"></a>00399   acquireConn: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deathback, label, dieOnConnectFailure) {
<a name="l00400"></a>00400     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00401"></a>00401     this._deathback = deathback;
<a name="l00402"></a>00402     this._account.__folderDemandsConnection(
<a name="l00403"></a>00403       this._storage.folderId, label,
<a name="l00404"></a>00404       <span class="keyword">function</span> gotconn(conn) {
<a name="l00405"></a>00405         <span class="keyword">self</span>._conn = conn;
<a name="l00406"></a>00406         <span class="comment">// Now we have a connection, but it&#39;s not in the folder.</span>
<a name="l00407"></a>00407         <span class="comment">// (If we were doing fancier sync like QRESYNC, we would not enter</span>
<a name="l00408"></a>00408         <span class="comment">// in such a blase fashion.)</span>
<a name="l00409"></a>00409         <span class="keyword">self</span>._conn.openBox(<span class="keyword">self</span>._storage.folderMeta.path,
<a name="l00410"></a>00410                            <span class="keyword">function</span> openedBox(err, box) {
<a name="l00411"></a>00411             <span class="keywordflow">if</span> (err) {
<a name="l00412"></a>00412               <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Problem entering folder&#39;</span>,
<a name="l00413"></a>00413                             <span class="keyword">self</span>._storage.folderMeta.path);
<a name="l00414"></a>00414               <span class="keyword">self</span>._conn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00415"></a>00415               <span class="comment">// hand the connection back, noting a resource problem</span>
<a name="l00416"></a>00416               <span class="keyword">self</span>._account.__folderDoneWithConnection(
<a name="l00417"></a>00417                 <span class="keyword">self</span>._conn, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l00418"></a>00418               <span class="keywordflow">if</span> (<span class="keyword">self</span>._deathback) {
<a name="l00419"></a>00419                 var deathback = <span class="keyword">self</span>._deathback;
<a name="l00420"></a>00420                 <span class="keyword">self</span>.clearErrorHandler();
<a name="l00421"></a>00421                 deathback();
<a name="l00422"></a>00422               }
<a name="l00423"></a>00423               <span class="keywordflow">return</span>;
<a name="l00424"></a>00424             }
<a name="l00425"></a>00425             <span class="keyword">self</span>.box = box;
<a name="l00426"></a>00426             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="keyword">self</span>, <span class="keyword">self</span>._storage);
<a name="l00427"></a>00427           });
<a name="l00428"></a>00428       },
<a name="l00429"></a>00429       <span class="keyword">function</span> deadconn() {
<a name="l00430"></a>00430         <span class="keyword">self</span>._conn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00431"></a>00431         <span class="keywordflow">if</span> (<span class="keyword">self</span>._deathback) {
<a name="l00432"></a>00432           var deathback = <span class="keyword">self</span>._deathback;
<a name="l00433"></a>00433           <span class="keyword">self</span>.clearErrorHandler();
<a name="l00434"></a>00434           deathback();
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436       },
<a name="l00437"></a>00437       dieOnConnectFailure);
<a name="l00438"></a>00438   },
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   relinquishConn: <span class="keyword">function</span>() {
<a name="l00441"></a>00441     <span class="keywordflow">if</span> (!this._conn)
<a name="l00442"></a>00442       <span class="keywordflow">return</span>;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     this.clearErrorHandler();
<a name="l00445"></a>00445     this._account.__folderDoneWithConnection(this._conn, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l00446"></a>00446     this._conn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00447"></a>00447   },
<a name="l00448"></a>00448 
<a name="l00455"></a>00455   withConnection: <span class="keyword">function</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deathback, label, dieOnConnectFailure) {
<a name="l00456"></a>00456     <span class="keywordflow">if</span> (!this._conn) {
<a name="l00457"></a>00457       this.acquireConn(<span class="keyword">function</span> () {
<a name="l00458"></a>00458         this.withConnection(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deathback, label);
<a name="l00459"></a>00459       }.bind(<span class="keyword">this</span>), deathback, label, dieOnConnectFailure);
<a name="l00460"></a>00460       <span class="keywordflow">return</span>;
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     this._deathback = deathback;
<a name="l00464"></a>00464     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="keyword">this</span>);
<a name="l00465"></a>00465   },
<a name="l00466"></a>00466 
<a name="l00471"></a>00471   clearErrorHandler: <span class="keyword">function</span> () {
<a name="l00472"></a>00472     this._deathback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00473"></a>00473   },
<a name="l00474"></a>00474 
<a name="l00475"></a>00475   reselectBox: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00476"></a>00476     this._conn.openBox(this._storage.folderMeta.path, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00477"></a>00477   },
<a name="l00478"></a>00478 
<a name="l00485"></a>00485   _timelySyncSearch: <span class="keyword">function</span>(searchOptions, searchedCallback,
<a name="l00486"></a>00486                               abortedCallback, progressCallback) {
<a name="l00487"></a>00487     <span class="comment">// If we don&#39;t have a connection, get one, then re-call.</span>
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (!this._conn) {
<a name="l00489"></a>00489       <span class="comment">// XXX the abortedCallback should really only be used for the duration</span>
<a name="l00490"></a>00490       <span class="comment">// of this request, but it will end up being used for the entire duration</span>
<a name="l00491"></a>00491       <span class="comment">// our folder holds on to the connection.  This is not a great idea as</span>
<a name="l00492"></a>00492       <span class="comment">// long as we are leaving the IMAP connection idling in the folder (which</span>
<a name="l00493"></a>00493       <span class="comment">// causes us to not release the connection back to the account).  We</span>
<a name="l00494"></a>00494       <span class="comment">// should tie this to the mutex or something else transactional.</span>
<a name="l00495"></a>00495       this.acquireConn(
<a name="l00496"></a>00496         this._timelySyncSearch.bind(<span class="keyword">this</span>, searchOptions, searchedCallback,
<a name="l00497"></a>00497                                     abortedCallback, progressCallback),
<a name="l00498"></a>00498         abortedCallback, <span class="stringliteral">&#39;sync&#39;</span>, <span class="keyword">true</span>);
<a name="l00499"></a>00499       <span class="keywordflow">return</span>;
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501     <span class="comment">// We do have a connection, hook-up our abortedCallback</span>
<a name="l00502"></a>00502     <span class="keywordflow">else</span> {
<a name="l00503"></a>00503       this._deathback = abortedCallback;
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     <span class="comment">// Having a connection is 10% of the battle</span>
<a name="l00507"></a>00507     <span class="keywordflow">if</span> (progressCallback)
<a name="l00508"></a>00508       progressCallback(0.1);
<a name="l00509"></a>00509     this._conn.search(searchOptions, <span class="keyword">function</span>(err, uids) {
<a name="l00510"></a>00510         <span class="keywordflow">if</span> (err) {
<a name="l00511"></a>00511           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Search error on&#39;</span>, searchOptions, <span class="stringliteral">&#39;err:&#39;</span>, err);
<a name="l00512"></a>00512           abortedCallback();
<a name="l00513"></a>00513           <span class="keywordflow">return</span>;
<a name="l00514"></a>00514         }
<a name="l00515"></a>00515         searchedCallback(uids);
<a name="l00516"></a>00516       });
<a name="l00517"></a>00517   },
<a name="l00518"></a>00518 
<a name="l00519"></a>00519   syncDateRange: <span class="keyword">function</span>() {
<a name="l00520"></a>00520     var <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a> = Array.slice(arguments);
<a name="l00521"></a>00521     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;./protocol/sync&#39;</span>], <span class="keyword">function</span>(_sync) {
<a name="l00524"></a>00524       $imapsync = _sync;
<a name="l00525"></a>00525       (<span class="keyword">self</span>.syncDateRange = <span class="keyword">self</span>._lazySyncDateRange).apply(<span class="keyword">self</span>, args);
<a name="l00526"></a>00526     });
<a name="l00527"></a>00527   },
<a name="l00528"></a>00528 
<a name="l00560"></a>00560   _lazySyncDateRange: <span class="keyword">function</span>(startTS, endTS, accuracyStamp,
<a name="l00561"></a>00561                           doneCallback, progressCallback) {
<a name="l00562"></a>00562     <span class="keywordflow">if</span> (startTS &amp;&amp; endTS &amp;&amp; SINCE(startTS, endTS)) {
<a name="l00563"></a>00563       this._LOG.illegalSync(startTS, endTS);
<a name="l00564"></a>00564       doneCallback(<span class="stringliteral">&#39;invariant&#39;</span>);
<a name="l00565"></a>00565       <span class="keywordflow">return</span>;
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568 <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;syncDateRange:&quot;</span>, startTS, endTS);
<a name="l00569"></a>00569     var searchOptions = BASELINE_SEARCH_OPTIONS.concat(), <span class="keyword">self</span> = <span class="keyword">this</span>,
<a name="l00570"></a>00570       storage = <span class="keyword">self</span>._storage;
<a name="l00571"></a>00571     var useBisectLimit = $sync.BISECT_DATE_AT_N_MESSAGES;
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (startTS)
<a name="l00573"></a>00573       searchOptions.push([<span class="stringliteral">&#39;SINCE&#39;</span>, startTS]);
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (endTS)
<a name="l00575"></a>00575       searchOptions.push([<span class="stringliteral">&#39;BEFORE&#39;</span>, endTS]);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a> = allbackMaker(
<a name="l00578"></a>00578       [<span class="stringliteral">&#39;search&#39;</span>, <span class="stringliteral">&#39;db&#39;</span>],
<a name="l00579"></a>00579       <span class="keyword">function</span> syncDateRangeLogic(<a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>) {
<a name="l00580"></a>00580         var serverUIDs = <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.search, <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a> = <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.db,
<a name="l00581"></a>00581             knownUIDs = [], uid, numDeleted = 0,
<a name="l00582"></a>00582             modseq = <span class="keyword">self</span>._conn._state.box.highestModSeq || <span class="stringliteral">&#39;&#39;</span>;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584 <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;SERVER UIDS&#39;</span>, serverUIDs.length, useBisectLimit);
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (serverUIDs.length &gt; useBisectLimit) {
<a name="l00586"></a>00586           var effEndTS = endTS ||
<a name="l00587"></a>00587                          quantizeDate(NOW() + DAY_MILLIS + <span class="keyword">self</span>._account.tzOffset),
<a name="l00588"></a>00588               curDaysDelta = Math.round((effEndTS - startTS) / DAY_MILLIS);
<a name="l00589"></a>00589           <span class="comment">// We are searching more than one day, we can shrink our search.</span>
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;BISECT CASE&#39;</span>, serverUIDs.length, <span class="stringliteral">&#39;curDaysDelta&#39;</span>, curDaysDelta);
<a name="l00592"></a>00592           <span class="keywordflow">if</span> (curDaysDelta &gt; 1) {
<a name="l00593"></a>00593             <span class="comment">// mark the bisection abort...</span>
<a name="l00594"></a>00594             <span class="keyword">self</span>._LOG.syncDateRange_end(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, startTS, endTS,
<a name="l00595"></a>00595                                         <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00596"></a>00596             var bisectInfo = {
<a name="l00597"></a>00597               oldStartTS: startTS,
<a name="l00598"></a>00598               oldEndTS: endTS,
<a name="l00599"></a>00599               numHeaders: serverUIDs.length,
<a name="l00600"></a>00600               curDaysDelta: curDaysDelta,
<a name="l00601"></a>00601               newStartTS: startTS,
<a name="l00602"></a>00602               newEndTS: endTS,
<a name="l00603"></a>00603             };
<a name="l00604"></a>00604             <span class="comment">// If we were being used for a refresh, they may want us to stop</span>
<a name="l00605"></a>00605             <span class="comment">// and change their sync strategy.</span>
<a name="l00606"></a>00606             <span class="keywordflow">if</span> (doneCallback(<span class="stringliteral">&#39;bisect&#39;</span>, bisectInfo, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) === <span class="stringliteral">&#39;abort&#39;</span>) {
<a name="l00607"></a>00607               <span class="keyword">self</span>.clearErrorHandler();
<a name="l00608"></a>00608               doneCallback(<span class="stringliteral">&#39;bisect-aborted&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00609"></a>00609               <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00610"></a>00610             }
<a name="l00611"></a>00611             <span class="keywordflow">return</span> <span class="keyword">self</span>.syncDateRange(
<a name="l00612"></a>00612               bisectInfo.newStartTS, bisectInfo.newEndTS, accuracyStamp,
<a name="l00613"></a>00613               doneCallback, progressCallback);
<a name="l00614"></a>00614           }
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         <span class="keywordflow">if</span> (progressCallback)
<a name="l00618"></a>00618           progressCallback(0.25);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="comment">// -- infer deletion, flag to distinguish known messages</span>
<a name="l00621"></a>00621         <span class="comment">// rather than splicing lists and causing shifts, we null out values.</span>
<a name="l00622"></a>00622         <span class="keywordflow">for</span> (var iMsg = 0; iMsg &lt; <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length; iMsg++) {
<a name="l00623"></a>00623           var <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a> = <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[iMsg];
<a name="l00624"></a>00624           var idxUid = serverUIDs.indexOf(header.srvid);
<a name="l00625"></a>00625           <span class="comment">// deleted!</span>
<a name="l00626"></a>00626           <span class="keywordflow">if</span> (idxUid === -1) {
<a name="l00627"></a>00627             storage.deleteMessageHeaderAndBodyUsingHeader(header);
<a name="l00628"></a>00628             numDeleted++;
<a name="l00629"></a>00629             <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[iMsg] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00630"></a>00630             <span class="keywordflow">continue</span>;
<a name="l00631"></a>00631           }
<a name="l00632"></a>00632           <span class="comment">// null out the UID so the non-null values in the search are the</span>
<a name="l00633"></a>00633           <span class="comment">// new messages to us.</span>
<a name="l00634"></a>00634           serverUIDs[idxUid] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00635"></a>00635           <span class="comment">// but save the UID so we can do a flag-check.</span>
<a name="l00636"></a>00636           knownUIDs.push(header.srvid);
<a name="l00637"></a>00637         }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         var newUIDs = compactArray(serverUIDs); <span class="comment">// (re-labeling, same array)</span>
<a name="l00640"></a>00640         <span class="keywordflow">if</span> (numDeleted)
<a name="l00641"></a>00641           compactArray(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         var uidSync = <span class="keyword">new</span> $imapsync.Sync({
<a name="l00644"></a>00644           connection: <span class="keyword">self</span>._conn,
<a name="l00645"></a>00645           storage: <span class="keyword">self</span>._storage,
<a name="l00646"></a>00646           newUIDs: newUIDs,
<a name="l00647"></a>00647           knownUIDs: knownUIDs,
<a name="l00648"></a>00648           knownHeaders: <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>
<a name="l00649"></a>00649         });
<a name="l00650"></a>00650 
<a name="l00651"></a>00651         uidSync.onprogress = progressCallback;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         uidSync.oncomplete = <span class="keyword">function</span>(newCount, knownCount) {
<a name="l00654"></a>00654             <span class="keyword">self</span>._LOG.syncDateRange_end(newCount, knownCount, numDeleted,
<a name="l00655"></a>00655                                         startTS, endTS, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657             <span class="keyword">self</span>._storage.markSyncRange(startTS, endTS, modseq,
<a name="l00658"></a>00658                                         accuracyStamp);
<a name="l00659"></a>00659             <span class="keywordflow">if</span> (completed)
<a name="l00660"></a>00660               <span class="keywordflow">return</span>;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662             completed = <span class="keyword">true</span>;
<a name="l00663"></a>00663             <span class="keyword">self</span>.clearErrorHandler();
<a name="l00664"></a>00664             doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, newCount + knownCount,
<a name="l00665"></a>00665                          skewedStartTS, skewedEndTS);
<a name="l00666"></a>00666         };
<a name="l00667"></a>00667 
<a name="l00668"></a>00668         <span class="keywordflow">return</span>;
<a name="l00669"></a>00669       });
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     <span class="comment">// - Adjust DB time range for server skew on INTERNALDATE</span>
<a name="l00672"></a>00672     <span class="comment">// See https://github.com/mozilla-b2g/gaia-email-libs-and-more/issues/12</span>
<a name="l00673"></a>00673     <span class="comment">// for more in-depth details.  The nutshell is that the server will secretly</span>
<a name="l00674"></a>00674     <span class="comment">// apply a timezone to the question we ask it and will not actually tell us</span>
<a name="l00675"></a>00675     <span class="comment">// dates lined up with UTC.  Accordingly, we don&#39;t want our DB query to</span>
<a name="l00676"></a>00676     <span class="comment">// be lined up with UTC but instead the time zone.</span>
<a name="l00677"></a>00677     <span class="comment">//</span>
<a name="l00678"></a>00678     <span class="comment">// So if our timezone offset is UTC-4, that means that we will actually be</span>
<a name="l00679"></a>00679     <span class="comment">// getting results in that timezone, whose midnight is actually 4am UTC.</span>
<a name="l00680"></a>00680     <span class="comment">// In other words, we care about the time in UTC-0, so we subtract the</span>
<a name="l00681"></a>00681     <span class="comment">// offset.</span>
<a name="l00682"></a>00682     var skewedStartTS = startTS - this._account.tzOffset,
<a name="l00683"></a>00683         skewedEndTS = endTS ? endTS - this._account.tzOffset : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l00684"></a>00684         completed = <span class="keyword">false</span>;
<a name="l00685"></a>00685     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Skewed DB lookup. Start: &#39;</span>,
<a name="l00686"></a>00686                 skewedStartTS, <span class="keyword">new</span> Date(skewedStartTS).toUTCString(),
<a name="l00687"></a>00687                 <span class="stringliteral">&#39;End: &#39;</span>, skewedEndTS,
<a name="l00688"></a>00688                 skewedEndTS ? <span class="keyword">new</span> Date(skewedEndTS).toUTCString() : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00689"></a>00689     this._LOG.syncDateRange_begin(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, startTS, endTS,
<a name="l00690"></a>00690                                   skewedStartTS, skewedEndTS);
<a name="l00691"></a>00691     this._timelySyncSearch(
<a name="l00692"></a>00692       searchOptions, callbacks.search,
<a name="l00693"></a>00693       <span class="keyword">function</span> abortedSearch() {
<a name="l00694"></a>00694         <span class="keywordflow">if</span> (completed)
<a name="l00695"></a>00695           <span class="keywordflow">return</span>;
<a name="l00696"></a>00696         completed = <span class="keyword">true</span>;
<a name="l00697"></a>00697         this._LOG.syncDateRange_end(0, 0, 0, startTS, endTS, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00698"></a>00698         doneCallback(<span class="stringliteral">&#39;aborted&#39;</span>);
<a name="l00699"></a>00699       }.bind(<span class="keyword">this</span>),
<a name="l00700"></a>00700       progressCallback);
<a name="l00701"></a>00701     this._storage.getAllMessagesInImapDateRange(skewedStartTS, skewedEndTS,
<a name="l00702"></a>00702                                                 callbacks.db);
<a name="l00703"></a>00703   },
<a name="l00704"></a>00704 
<a name="l00705"></a>00705   searchDateRange: <span class="keyword">function</span>(endTS, startTS, searchParams,
<a name="l00706"></a>00706                             <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>) {
<a name="l00707"></a>00707     var searchOptions = BASELINE_SEARCH_OPTIONS.concat(searchParams);
<a name="l00708"></a>00708     <span class="keywordflow">if</span> (startTS)
<a name="l00709"></a>00709       searchOptions.push([<span class="stringliteral">&#39;SINCE&#39;</span>, startTS]);
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (endTS)
<a name="l00711"></a>00711       searchOptions.push([<span class="stringliteral">&#39;BEFORE&#39;</span>, endTS]);
<a name="l00712"></a>00712   },
<a name="l00713"></a>00713 
<a name="l00728"></a>00728   downloadBodyReps: <span class="keyword">function</span>() {
<a name="l00729"></a>00729     var args = Array.slice(arguments);
<a name="l00730"></a>00730     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(
<a name="l00733"></a>00733       [
<a name="l00734"></a>00734         <span class="stringliteral">&#39;./imapchew&#39;</span>,
<a name="l00735"></a>00735         <span class="stringliteral">&#39;./protocol/bodyfetcher&#39;</span>,
<a name="l00736"></a>00736         <span class="stringliteral">&#39;./protocol/textparser&#39;</span>,
<a name="l00737"></a>00737         <span class="stringliteral">&#39;./protocol/snippetparser&#39;</span>
<a name="l00738"></a>00738       ],
<a name="l00739"></a>00739       <span class="keyword">function</span>(
<a name="l00740"></a>00740         _imapchew,
<a name="l00741"></a>00741         _bodyfetcher,
<a name="l00742"></a>00742         _textparser,
<a name="l00743"></a>00743         _snippetparser
<a name="l00744"></a>00744       ) {
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         $imapchew =_imapchew;
<a name="l00747"></a>00747         $imapbodyfetcher = _bodyfetcher;
<a name="l00748"></a>00748         $imaptextparser = _textparser;
<a name="l00749"></a>00749         $imapsnippetparser = _snippetparser;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751         (<span class="keyword">self</span>.downloadBodyReps = <span class="keyword">self</span>._lazyDownloadBodyReps).apply(<span class="keyword">self</span>, args);
<a name="l00752"></a>00752     });
<a name="l00753"></a>00753   },
<a name="l00754"></a>00754 
<a name="l00759"></a>00759   _lazyDownloadBodyReps: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00760"></a>00760     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(options) === <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l00761"></a>00761       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>;
<a name="l00762"></a>00762       options = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     options = options || {};
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769     var gotBody = <span class="keyword">function</span> gotBody(bodyInfo) {
<a name="l00770"></a>00770       <span class="comment">// target for snippet generation</span>
<a name="l00771"></a>00771       var bodyRepIdx = $imapchew.selectSnippetBodyRep(header, bodyInfo);
<a name="l00772"></a>00772 
<a name="l00773"></a>00773       <span class="comment">// assume user always wants entire email unless option is given...</span>
<a name="l00774"></a>00774       var overallMaximumBytes = options.maximumBytesToFetch;
<a name="l00775"></a>00775 
<a name="l00776"></a>00776       var bodyParser = $imaptextparser.TextParser;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778       <span class="comment">// build the list of requests based on downloading required.</span>
<a name="l00779"></a>00779       var requests = [];
<a name="l00780"></a>00780       bodyInfo.bodyReps.forEach(<span class="keyword">function</span>(rep, idx) {
<a name="l00781"></a>00781 
<a name="l00782"></a>00782         <span class="comment">// attempt to be idempotent by only requesting the bytes we need if we</span>
<a name="l00783"></a>00783         <span class="comment">// actually need them...</span>
<a name="l00784"></a>00784         <span class="keywordflow">if</span> (rep.isDownloaded)
<a name="l00785"></a>00785           <span class="keywordflow">return</span>;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787         var <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a> = {
<a name="l00788"></a>00788           uid: header.srvid,
<a name="l00789"></a>00789           partInfo: rep._partInfo,
<a name="l00790"></a>00790           bodyRepIndex: idx,
<a name="l00791"></a>00791           createSnippet: idx === bodyRepIdx
<a name="l00792"></a>00792         };
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         <span class="comment">// default to the entire remaining email. We use the estimate * largish</span>
<a name="l00795"></a>00795         <span class="comment">// multiplier so even if the size estimate is wrong we should fetch more</span>
<a name="l00796"></a>00796         <span class="comment">// then the requested number of bytes which if truncated indicates the</span>
<a name="l00797"></a>00797         <span class="comment">// end of the bodies content.</span>
<a name="l00798"></a>00798         var bytesToFetch = Math.min(rep.sizeEstimate * 5, MAX_FETCH_BYTES);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         <span class="keywordflow">if</span> (overallMaximumBytes !== undefined) {
<a name="l00801"></a>00801           <span class="comment">// when we fetch partial results we need to use the snippet parser.</span>
<a name="l00802"></a>00802           bodyParser = $imapsnippetparser.SnippetParser;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804           <span class="comment">// issued enough downloads</span>
<a name="l00805"></a>00805           <span class="keywordflow">if</span> (overallMaximumBytes &lt;= 0) {
<a name="l00806"></a>00806             <span class="keywordflow">return</span>;
<a name="l00807"></a>00807           }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809           <span class="comment">// if our estimate is greater then expected number of bytes request the</span>
<a name="l00810"></a>00810           <span class="comment">// maximum allowed.</span>
<a name="l00811"></a>00811           <span class="keywordflow">if</span> (rep.sizeEstimate &gt; overallMaximumBytes) {
<a name="l00812"></a>00812             bytesToFetch = overallMaximumBytes;
<a name="l00813"></a>00813           }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815           <span class="comment">// subtract the estimated byte size</span>
<a name="l00816"></a>00816           overallMaximumBytes -= rep.sizeEstimate;
<a name="l00817"></a>00817         }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819         <span class="comment">// For a byte-serve request, we need to request at least 1 byte, so</span>
<a name="l00820"></a>00820         <span class="comment">// request some bytes.  This is a logic simplification that should not</span>
<a name="l00821"></a>00821         <span class="comment">// need to be used because imapchew.js should declare 0-byte files</span>
<a name="l00822"></a>00822         <span class="comment">// fully downloaded when their parts are created, but better a wasteful</span>
<a name="l00823"></a>00823         <span class="comment">// network request than breaking here.</span>
<a name="l00824"></a>00824         <span class="keywordflow">if</span> (bytesToFetch &lt;= 0)
<a name="l00825"></a>00825           bytesToFetch = 64;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827         <span class="comment">// we may only need a subset of the total number of bytes.</span>
<a name="l00828"></a>00828         <span class="keywordflow">if</span> (overallMaximumBytes !== undefined || rep.amountDownloaded) {
<a name="l00829"></a>00829           <span class="comment">// request the remainder</span>
<a name="l00830"></a>00830           <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a>.bytes = [
<a name="l00831"></a>00831             rep.amountDownloaded,
<a name="l00832"></a>00832             bytesToFetch
<a name="l00833"></a>00833           ];
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836         requests.push(<a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a>);
<a name="l00837"></a>00837       });
<a name="l00838"></a>00838 
<a name="l00839"></a>00839       <span class="comment">// we may not have any requests bail early if so.</span>
<a name="l00840"></a>00840       <span class="keywordflow">if</span> (!requests.length) {
<a name="l00841"></a>00841         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, bodyInfo); <span class="comment">// no requests === success</span>
<a name="l00842"></a>00842         <span class="keywordflow">return</span>;
<a name="l00843"></a>00843       }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845       var fetch = <span class="keyword">new</span> $imapbodyfetcher.BodyFetcher(
<a name="l00846"></a>00846         <span class="keyword">self</span>._conn,
<a name="l00847"></a>00847         bodyParser,
<a name="l00848"></a>00848         requests
<a name="l00849"></a>00849       );
<a name="l00850"></a>00850 
<a name="l00851"></a>00851       <span class="keyword">self</span>._handleBodyFetcher(fetch, header, bodyInfo, <span class="keyword">function</span>(err) {
<a name="l00852"></a>00852         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(err, bodyInfo);
<a name="l00853"></a>00853       });
<a name="l00854"></a>00854     };
<a name="l00855"></a>00855 
<a name="l00856"></a>00856     this._storage.getMessageBody(header.suid, header.date, gotBody);
<a name="l00857"></a>00857   },
<a name="l00858"></a>00858 
<a name="l00864"></a>00864   _downloadSnippet: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00865"></a>00865     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00866"></a>00866     this._storage.getMessageBody(header.suid, header.date, <span class="keyword">function</span>(body) {
<a name="l00867"></a>00867       <span class="comment">// attempt to find a rep</span>
<a name="l00868"></a>00868       var bodyRepIndex = $imapchew.selectSnippetBodyRep(header, body);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870       <span class="comment">// no suitable snippet we are done.</span>
<a name="l00871"></a>00871       <span class="keywordflow">if</span> (bodyRepIndex === -1)
<a name="l00872"></a>00872         <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l00873"></a>00873 
<a name="l00874"></a>00874       var rep = body.bodyReps[bodyRepIndex];
<a name="l00875"></a>00875       var requests = [{
<a name="l00876"></a>00876         uid: header.srvid,
<a name="l00877"></a>00877         bodyRepIndex: bodyRepIndex,
<a name="l00878"></a>00878         partInfo: rep._partInfo,
<a name="l00879"></a>00879         <a class="code" href="../../d2/d7d/jsapi_8h.html#a57d303dad1fd4039eecc9e7e5e8fd41f">bytes</a>: [0, NUMBER_OF_SNIPPET_BYTES],
<a name="l00880"></a>00880         createSnippet: <span class="keyword">true</span>
<a name="l00881"></a>00881       }];
<a name="l00882"></a>00882 
<a name="l00883"></a>00883       var fetch = <span class="keyword">new</span> $imapbodyfetcher.BodyFetcher(
<a name="l00884"></a>00884         <span class="keyword">self</span>._conn,
<a name="l00885"></a>00885         $imapsnippetparser.SnippetParser,
<a name="l00886"></a>00886         requests
<a name="l00887"></a>00887       );
<a name="l00888"></a>00888 
<a name="l00889"></a>00889       <span class="keyword">self</span>._handleBodyFetcher(
<a name="l00890"></a>00890         fetch,
<a name="l00891"></a>00891         header,
<a name="l00892"></a>00892         body,
<a name="l00893"></a>00893         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>
<a name="l00894"></a>00894       );
<a name="l00895"></a>00895     });
<a name="l00896"></a>00896   },
<a name="l00897"></a>00897 
<a name="l00901"></a>00901   _handleBodyFetcher: <span class="keyword">function</span>(fetcher, <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00902"></a>00902     var <span class="keyword">event</span> = {
<a name="l00903"></a>00903       changeType: <span class="stringliteral">&#39;bodyReps&#39;</span>,
<a name="l00904"></a>00904       indexes: []
<a name="l00905"></a>00905     };
<a name="l00906"></a>00906 
<a name="l00907"></a>00907     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     fetcher.onparsed = <span class="keyword">function</span>(<a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a>, resp) {
<a name="l00910"></a>00910       $imapchew.updateMessageWithFetch(header, body, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a>, resp, <span class="keyword">self</span>._LOG);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912       <span class="keywordflow">if</span> (<a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a>.createSnippet) {
<a name="l00913"></a>00913         <span class="keyword">self</span>._storage.updateMessageHeader(
<a name="l00914"></a>00914           header.date,
<a name="l00915"></a>00915           header.id,
<a name="l00916"></a>00916           <span class="keyword">false</span>,
<a name="l00917"></a>00917           header
<a name="l00918"></a>00918         );
<a name="l00919"></a>00919       }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921       <span class="keyword">event</span>.indexes.push(<a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a>.bodyRepIndex);
<a name="l00922"></a>00922     };
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     fetcher.onerror = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l00925"></a>00925       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l00926"></a>00926     };
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     fetcher.onend = <span class="keyword">function</span>() {
<a name="l00929"></a>00929       <span class="keyword">self</span>._storage.updateMessageBody(
<a name="l00930"></a>00930         header,
<a name="l00931"></a>00931         body,
<a name="l00932"></a>00932         <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>
<a name="l00933"></a>00933       );
<a name="l00934"></a>00934 
<a name="l00935"></a>00935       <span class="keyword">self</span>._storage.runAfterDeferredCalls(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00936"></a>00936     };
<a name="l00937"></a>00937   },
<a name="l00938"></a>00938 
<a name="l00943"></a>00943   _lazyDownloadBodies: <span class="keyword">function</span>(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00944"></a>00944     var pending = 1, downloadsNeeded = 0;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00947"></a>00947     var anyErr;
<a name="l00948"></a>00948     <span class="keyword">function</span> next(err) {
<a name="l00949"></a>00949       <span class="keywordflow">if</span> (err &amp;&amp; !anyErr)
<a name="l00950"></a>00950         anyErr = err;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952       <span class="keywordflow">if</span> (!--pending) {
<a name="l00953"></a>00953         <span class="keyword">self</span>._storage.runAfterDeferredCalls(<span class="keyword">function</span>() {
<a name="l00954"></a>00954           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(anyErr, <span class="comment">/* number downloaded */</span> downloadsNeeded - pending);
<a name="l00955"></a>00955         });
<a name="l00956"></a>00956       }
<a name="l00957"></a>00957     }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00960"></a>00960       <span class="comment">// We obviously can&#39;t do anything with null header references.</span>
<a name="l00961"></a>00961       <span class="comment">// To avoid redundant work, we also don&#39;t want to do any fetching if we</span>
<a name="l00962"></a>00962       <span class="comment">// already have a snippet.  This could happen because of the extreme</span>
<a name="l00963"></a>00963       <span class="comment">// potential for a caller to spam multiple requests at us before we</span>
<a name="l00964"></a>00964       <span class="comment">// service any of them.  (Callers should only have one or two outstanding</span>
<a name="l00965"></a>00965       <span class="comment">// jobs of this and do their own suppression tracking, but bugs happen.)</span>
<a name="l00966"></a>00966       <span class="keywordflow">if</span> (!<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] || <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].snippet !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l00967"></a>00967         <span class="keywordflow">continue</span>;
<a name="l00968"></a>00968       }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970       pending++;
<a name="l00971"></a>00971       <span class="comment">// This isn&#39;t absolutely guaranteed to be 100% correct, but is good enough</span>
<a name="l00972"></a>00972       <span class="comment">// for indicating to the caller that we did some work.</span>
<a name="l00973"></a>00973       downloadsNeeded++;
<a name="l00974"></a>00974       this.downloadBodyReps(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>], options, next);
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977     <span class="comment">// by having one pending item always this handles the case of not having any</span>
<a name="l00978"></a>00978     <span class="comment">// snippets needing a download and also returning in the next tick of the</span>
<a name="l00979"></a>00979     <span class="comment">// event loop.</span>
<a name="l00980"></a>00980     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setZeroTimeout(next);
<a name="l00981"></a>00981   },
<a name="l00982"></a>00982 
<a name="l00986"></a>00986   downloadBodies: <span class="keyword">function</span>() {
<a name="l00987"></a>00987     var args = Array.slice(arguments);
<a name="l00988"></a>00988     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(
<a name="l00991"></a>00991       [<span class="stringliteral">&#39;./imapchew&#39;</span>, <span class="stringliteral">&#39;./protocol/bodyfetcher&#39;</span>, <span class="stringliteral">&#39;./protocol/snippetparser&#39;</span>],
<a name="l00992"></a>00992       <span class="keyword">function</span>(
<a name="l00993"></a>00993         _imapchew,
<a name="l00994"></a>00994         _bodyfetcher,
<a name="l00995"></a>00995         _snippetparser
<a name="l00996"></a>00996       ) {
<a name="l00997"></a>00997 
<a name="l00998"></a>00998         $imapchew =_imapchew;
<a name="l00999"></a>00999         $imapbodyfetcher = _bodyfetcher;
<a name="l01000"></a>01000         $imapsnippetparser = _snippetparser;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         (<span class="keyword">self</span>.downloadBodies = <span class="keyword">self</span>._lazyDownloadBodies).apply(<span class="keyword">self</span>, args);
<a name="l01003"></a>01003     });
<a name="l01004"></a>01004   },
<a name="l01005"></a>01005 
<a name="l01006"></a>01006   downloadMessageAttachments: <span class="keyword">function</span>(uid, partInfos, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, progress) {
<a name="l01007"></a>01007     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;mailparser/mailparser&#39;</span>], <span class="keyword">function</span>($mailparser) {
<a name="l01008"></a>01008       var conn = this._conn;
<a name="l01009"></a>01009       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01010"></a>01010       var mparser = <span class="keyword">new</span> $mailparser.MailParser();
<a name="l01011"></a>01011 
<a name="l01012"></a>01012       <span class="comment">// I actually implemented a usable shim for the checksum purposes, but we</span>
<a name="l01013"></a>01013       <span class="comment">// don&#39;t actually care about the checksum, so why bother doing the work?</span>
<a name="l01014"></a>01014       var dummyChecksummer = {
<a name="l01015"></a>01015         <a class="code" href="../../dd/d6d/mock__spinner_8js.html#ab10b009b0da48f61217a18daf8e20cd8">update</a>: <span class="keyword">function</span>() {},
<a name="l01016"></a>01016         digest: <span class="keyword">function</span>() { <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>; },
<a name="l01017"></a>01017       };
<a name="l01018"></a>01018 
<a name="l01019"></a>01019       <span class="keyword">function</span> setupBodyParser(partInfo) {
<a name="l01020"></a>01020         mparser._state = 0x2; <span class="comment">// body</span>
<a name="l01021"></a>01021         mparser._remainder = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01022"></a>01022         mparser._currentNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01023"></a>01023         mparser._currentNode = mparser._createMimeNode(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l01024"></a>01024         mparser._currentNode.attachment = <span class="keyword">true</span>;
<a name="l01025"></a>01025         mparser._currentNode.checksum = dummyChecksummer;
<a name="l01026"></a>01026         mparser._currentNode.content = undefined;
<a name="l01027"></a>01027         <span class="comment">// nb: mparser._multipartTree is an empty list (always)</span>
<a name="l01028"></a>01028         mparser._currentNode.meta.contentType = partInfo.type;
<a name="l01029"></a>01029         mparser._currentNode.meta.transferEncoding = partInfo.encoding;
<a name="l01030"></a>01030         mparser._currentNode.meta.charset = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>; <span class="comment">//partInfo.charset;</span>
<a name="l01031"></a>01031         mparser._currentNode.meta.textFormat = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>; <span class="comment">//partInfo.textFormat;</span>
<a name="l01032"></a>01032       }
<a name="l01033"></a>01033       <span class="keyword">function</span> bodyParseBuffer(<a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>) {
<a name="l01034"></a>01034         <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.immediate = <span class="keyword">true</span>;
<a name="l01035"></a>01035         mparser.write(<a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>);
<a name="l01036"></a>01036         <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.immediate = <span class="keyword">false</span>;
<a name="l01037"></a>01037       }
<a name="l01038"></a>01038       <span class="keyword">function</span> finishBodyParsing() {
<a name="l01039"></a>01039         <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.immediate = <span class="keyword">true</span>;
<a name="l01040"></a>01040         mparser._process(<span class="keyword">true</span>);
<a name="l01041"></a>01041         <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.immediate = <span class="keyword">false</span>;
<a name="l01042"></a>01042         <span class="comment">// this is a Buffer!</span>
<a name="l01043"></a>01043         <span class="keywordflow">return</span> mparser._currentNode.content;
<a name="l01044"></a>01044       }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046       var anyError = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, pendingFetches = 0, bodies = [];
<a name="l01047"></a>01047       partInfos.forEach(<span class="keyword">function</span>(partInfo) {
<a name="l01048"></a>01048         var opts = {
<a name="l01049"></a>01049           <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a>: {
<a name="l01050"></a>01050             <span class="keyword">struct</span>: <span class="keyword">false</span>,
<a name="l01051"></a>01051             <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>: <span class="keyword">false</span>,
<a name="l01052"></a>01052             body: partInfo.part
<a name="l01053"></a>01053           }
<a name="l01054"></a>01054         };
<a name="l01055"></a>01055         pendingFetches++;
<a name="l01056"></a>01056         var fetcher = conn.fetch(uid, opts);
<a name="l01057"></a>01057 
<a name="l01058"></a>01058         setupBodyParser(partInfo);
<a name="l01059"></a>01059         fetcher.on(<span class="stringliteral">&#39;error&#39;</span>, <span class="keyword">function</span>(err) {
<a name="l01060"></a>01060           <span class="keywordflow">if</span> (!anyError)
<a name="l01061"></a>01061             anyError = err;
<a name="l01062"></a>01062           <span class="keywordflow">if</span> (--pendingFetches === 0) {
<a name="l01063"></a>01063             <span class="keywordflow">try</span> {
<a name="l01064"></a>01064               <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(anyError, bodies);
<a name="l01065"></a>01065             }
<a name="l01066"></a>01066             <span class="keywordflow">catch</span> (ex) {
<a name="l01067"></a>01067               <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l01068"></a>01068             }
<a name="l01069"></a>01069           }
<a name="l01070"></a>01070         });
<a name="l01071"></a>01071         fetcher.on(<span class="stringliteral">&#39;message&#39;</span>, <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l01072"></a>01072           setupBodyParser(partInfo);
<a name="l01073"></a>01073           <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.on(<span class="stringliteral">&#39;data&#39;</span>, bodyParseBuffer);
<a name="l01074"></a>01074           <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.on(<span class="stringliteral">&#39;end&#39;</span>, <span class="keyword">function</span>() {
<a name="l01075"></a>01075             bodies.push(<span class="keyword">new</span> <a class="code" href="../../d7/d4b/namespacemozilla_1_1dom.html#a739d106dcb2584188674bb530d99233e">Blob</a>([finishBodyParsing()], { <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: partInfo.type }));
<a name="l01076"></a>01076 
<a name="l01077"></a>01077             <span class="keywordflow">if</span> (--pendingFetches === 0) {
<a name="l01078"></a>01078               <span class="keywordflow">try</span> {
<a name="l01079"></a>01079                 <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(anyError, bodies);
<a name="l01080"></a>01080               }
<a name="l01081"></a>01081               <span class="keywordflow">catch</span> (ex) {
<a name="l01082"></a>01082                 <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l01083"></a>01083               }
<a name="l01084"></a>01084             }
<a name="l01085"></a>01085           });
<a name="l01086"></a>01086         });
<a name="l01087"></a>01087       });
<a name="l01088"></a>01088     }.bind(<span class="keyword">this</span>));
<a name="l01089"></a>01089   },
<a name="l01090"></a>01090 
<a name="l01091"></a>01091   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>() {
<a name="l01092"></a>01092     this._LOG.__die();
<a name="l01093"></a>01093   },
<a name="l01094"></a>01094 };
<a name="l01095"></a>01095 
<a name="l01096"></a>01096 <span class="keyword">function</span> ImapFolderSyncer(account, folderStorage, _parentLog) {
<a name="l01097"></a>01097   this._account = account;
<a name="l01098"></a>01098   this.folderStorage = folderStorage;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100   this._LOG = LOGFAB.ImapFolderSyncer(<span class="keyword">this</span>, _parentLog, folderStorage.folderId);
<a name="l01101"></a>01101 
<a name="l01102"></a>01102 
<a name="l01103"></a>01103   this._syncSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01110"></a>01110   this._curSyncAccuracyStamp = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01125"></a>01125   this._curSyncDir = 1;
<a name="l01132"></a>01132   this._curSyncIsGrow = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01136"></a>01136   this._nextSyncAnchorTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01141"></a>01141   this._fallbackOriginTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01146"></a>01146   this._syncThroughTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01150"></a>01150   this._curSyncDayStep = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01158"></a>01158   this._curSyncDoNotGrowBoundary = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01162"></a>01162   this._curSyncDoneCallback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01163"></a>01163 
<a name="l01164"></a>01164   this.folderConn = <span class="keyword">new</span> ImapFolderConn(account, folderStorage, this._LOG);
<a name="l01165"></a>01165 }
<a name="l01166"></a>01166 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ImapFolderSyncer = ImapFolderSyncer;
<a name="l01167"></a>01167 ImapFolderSyncer.prototype = {
<a name="l01172"></a>01172   syncable: <span class="keyword">true</span>,
<a name="l01173"></a>01173 
<a name="l01177"></a>01177   <span class="keyword">get</span> canGrowSync() {
<a name="l01178"></a>01178     <span class="comment">// localdrafts is offline-only, so we can&#39;t ask the server for messages.</span>
<a name="l01179"></a>01179     <span class="keywordflow">return</span> this.folderStorage.folderMeta.type !== <span class="stringliteral">&#39;localdrafts&#39;</span>;
<a name="l01180"></a>01180   },
<a name="l01181"></a>01181 
<a name="l01186"></a>01186   initialSync: <span class="keyword">function</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, initialDays, syncCallback,
<a name="l01187"></a>01187                         doneCallback, progressCallback) {
<a name="l01188"></a>01188     syncCallback(<span class="stringliteral">&#39;sync&#39;</span>, <span class="keyword">false</span>);
<a name="l01189"></a>01189     <span class="comment">// We want to enter the folder and get the box info so we can know if we</span>
<a name="l01190"></a>01190     <span class="comment">// should trigger our SYNC_WHOLE_FOLDER_AT_N_MESSAGES logic.</span>
<a name="l01191"></a>01191     <span class="comment">// _timelySyncSearch is what will get called next either way, and it will</span>
<a name="l01192"></a>01192     <span class="comment">// just reuse the connection and will correctly update the deathback so</span>
<a name="l01193"></a>01193     <span class="comment">// that our deathback is no longer active.</span>
<a name="l01194"></a>01194     this.folderConn.withConnection(
<a name="l01195"></a>01195       <span class="keyword">function</span>(folderConn, storage) {
<a name="l01196"></a>01196         <span class="comment">// Flag to sync the whole range if we</span>
<a name="l01197"></a>01197         var syncWholeTimeRange = <span class="keyword">false</span>;
<a name="l01198"></a>01198         <span class="keywordflow">if</span> (folderConn &amp;&amp; folderConn.box &amp;&amp;
<a name="l01199"></a>01199             folderConn.box.messages.total &lt;
<a name="l01200"></a>01200               $sync.SYNC_WHOLE_FOLDER_AT_N_MESSAGES) {
<a name="l01201"></a>01201           syncWholeTimeRange = <span class="keyword">true</span>;
<a name="l01202"></a>01202         }
<a name="l01203"></a>01203 
<a name="l01204"></a>01204         this._startSync(
<a name="l01205"></a>01205           <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, PASTWARDS, <span class="comment">// sync into the past</span>
<a name="l01206"></a>01206           <span class="stringliteral">&#39;grow&#39;</span>,
<a name="l01207"></a>01207           <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">// start syncing from the (unconstrained) future</span>
<a name="l01208"></a>01208           $sync.OLDEST_SYNC_DATE, <span class="comment">// sync no further back than this constant</span>
<a name="l01209"></a>01209           <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01210"></a>01210           syncWholeTimeRange ? <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> : initialDays,
<a name="l01211"></a>01211           doneCallback, progressCallback);
<a name="l01212"></a>01212       }.bind(<span class="keyword">this</span>),
<a name="l01213"></a>01213       <span class="keyword">function</span> died() {
<a name="l01214"></a>01214         doneCallback(<span class="stringliteral">&#39;aborted&#39;</span>);
<a name="l01215"></a>01215       },
<a name="l01216"></a>01216       <span class="stringliteral">&#39;initialSync&#39;</span>, <span class="keyword">true</span>);
<a name="l01217"></a>01217   },
<a name="l01218"></a>01218 
<a name="l01225"></a>01225   refreshSync: <span class="keyword">function</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a>, startTS, endTS, origStartTS,
<a name="l01226"></a>01226                         doneCallback, progressCallback) {
<a name="l01227"></a>01227     <span class="comment">// timezone compensation happens in the caller</span>
<a name="l01228"></a>01228     this._startSync(
<a name="l01229"></a>01229       <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, dir,
<a name="l01230"></a>01230       <span class="stringliteral">&#39;refresh&#39;</span>, <span class="comment">// this is a refresh, not a grow!</span>
<a name="l01231"></a>01231       dir === PASTWARDS ? endTS : startTS,
<a name="l01232"></a>01232       dir === PASTWARDS ? startTS : endTS,
<a name="l01233"></a>01233       origStartTS,
<a name="l01234"></a>01234       <span class="comment">/* syncStepDays */</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, doneCallback, progressCallback);
<a name="l01235"></a>01235   },
<a name="l01236"></a>01236 
<a name="l01253"></a>01253   growSync: <span class="keyword">function</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, growthDirection, anchorTS, syncStepDays,
<a name="l01254"></a>01254                      doneCallback, progressCallback) {
<a name="l01255"></a>01255     var syncThroughTS;
<a name="l01256"></a>01256     <span class="keywordflow">if</span> (growthDirection === PASTWARDS) {
<a name="l01257"></a>01257       syncThroughTS = $sync.OLDEST_SYNC_DATE;
<a name="l01258"></a>01258     }
<a name="l01259"></a>01259     <span class="keywordflow">else</span> { <span class="comment">// FUTUREWARDS</span>
<a name="l01260"></a>01260       syncThroughTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263     this._startSync(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, growthDirection, <span class="stringliteral">&#39;grow&#39;</span>,
<a name="l01264"></a>01264                     anchorTS, syncThroughTS, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, syncStepDays,
<a name="l01265"></a>01265                     doneCallback, progressCallback);
<a name="l01266"></a>01266   },
<a name="l01267"></a>01267 
<a name="l01268"></a>01268   _startSync: <span class="keyword">function</span> ifs__startSync(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, dir, syncTypeStr,
<a name="l01269"></a>01269                                       originTS, syncThroughTS, fallbackOriginTS,
<a name="l01270"></a>01270                                       syncStepDays,
<a name="l01271"></a>01271                                       doneCallback, progressCallback) {
<a name="l01272"></a>01272     var startTS, endTS;
<a name="l01273"></a>01273     this._syncSlice = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l01274"></a>01274     this._curSyncAccuracyStamp = NOW();
<a name="l01275"></a>01275     this._curSyncDir = <a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a>;
<a name="l01276"></a>01276     this._curSyncIsGrow = (syncTypeStr === <span class="stringliteral">&#39;grow&#39;</span>);
<a name="l01277"></a>01277     this._fallbackOriginTS = fallbackOriginTS;
<a name="l01278"></a>01278     <span class="keywordflow">if</span> (dir === PASTWARDS) {
<a name="l01279"></a>01279       endTS = originTS;
<a name="l01280"></a>01280       <span class="keywordflow">if</span> (syncStepDays) {
<a name="l01281"></a>01281         <span class="keywordflow">if</span> (endTS)
<a name="l01282"></a>01282           this._nextSyncAnchorTS = startTS = endTS - syncStepDays * DAY_MILLIS;
<a name="l01283"></a>01283         <span class="keywordflow">else</span>
<a name="l01284"></a>01284           this._nextSyncAnchorTS = startTS = makeDaysAgo(syncStepDays,
<a name="l01285"></a>01285                                                          this._account.tzOffset);
<a name="l01286"></a>01286       }
<a name="l01287"></a>01287       <span class="keywordflow">else</span> {
<a name="l01288"></a>01288         startTS = syncThroughTS;
<a name="l01289"></a>01289         this._nextSyncAnchorTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01290"></a>01290       }
<a name="l01291"></a>01291     }
<a name="l01292"></a>01292     <span class="keywordflow">else</span> { <span class="comment">// FUTUREWARDS</span>
<a name="l01293"></a>01293       startTS = originTS;
<a name="l01294"></a>01294       <span class="keywordflow">if</span> (syncStepDays) {
<a name="l01295"></a>01295         this._nextSyncAnchorTS = endTS = startTS + syncStepDays * DAY_MILLIS;
<a name="l01296"></a>01296       }
<a name="l01297"></a>01297       <span class="keywordflow">else</span> {
<a name="l01298"></a>01298         endTS = syncThroughTS;
<a name="l01299"></a>01299         this._nextSyncAnchorTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01300"></a>01300       }
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     this._syncThroughTS = syncThroughTS;
<a name="l01303"></a>01303     this._curSyncDayStep = syncStepDays;
<a name="l01304"></a>01304     this._curSyncDoNotGrowBoundary = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01305"></a>01305     this._curSyncDoneCallback = doneCallback;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307     this.folderConn.syncDateRange(startTS, endTS, this._curSyncAccuracyStamp,
<a name="l01308"></a>01308                                   this.onSyncCompleted.bind(<span class="keyword">this</span>),
<a name="l01309"></a>01309                                   progressCallback);
<a name="l01310"></a>01310   },
<a name="l01311"></a>01311 
<a name="l01312"></a>01312   _doneSync: <span class="keyword">function</span> ifs__doneSync(err) {
<a name="l01313"></a>01313     <span class="comment">// The desired number of headers is always a rough request value which is</span>
<a name="l01314"></a>01314     <span class="comment">// intended to be a new thing for each request.  So we don&#39;t want extra</span>
<a name="l01315"></a>01315     <span class="comment">// desire building up, so we set it to what we have every time.</span>
<a name="l01316"></a>01316     <span class="comment">//</span>
<a name="l01317"></a>01317     <span class="comment">// We don&#39;t want to affect this value in accumulating mode, however, since</span>
<a name="l01318"></a>01318     <span class="comment">// it could result in sending more headers than actually requested over the</span>
<a name="l01319"></a>01319     <span class="comment">// wire.</span>
<a name="l01320"></a>01320     <span class="keywordflow">if</span> (!this._syncSlice._accumulating)
<a name="l01321"></a>01321       this._syncSlice.desiredHeaders = this._syncSlice.headers.length;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     <span class="keywordflow">if</span> (this._curSyncDoneCallback)
<a name="l01324"></a>01324       this._curSyncDoneCallback(err);
<a name="l01325"></a>01325 
<a name="l01326"></a>01326     <span class="comment">// Save our state even if there was an error because we may have accumulated</span>
<a name="l01327"></a>01327     <span class="comment">// some partial state.</span>
<a name="l01328"></a>01328     this._account.__checkpointSyncCompleted();
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     this._syncSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01331"></a>01331     this._curSyncAccuracyStamp = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01332"></a>01332     this._curSyncDir = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01333"></a>01333     this._nextSyncAnchorTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01334"></a>01334     this._syncThroughTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01335"></a>01335     this._curSyncDayStep = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01336"></a>01336     this._curSyncDoNotGrowBoundary = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01337"></a>01337     this._curSyncDoneCallback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01338"></a>01338   },
<a name="l01339"></a>01339 
<a name="l01375"></a>01375   onSyncCompleted: <span class="keyword">function</span> ifs_onSyncCompleted(err, bisectInfo, messagesSeen,
<a name="l01376"></a>01376                                                 effStartTS, effEndTS) {
<a name="l01377"></a>01377     <span class="comment">// In the event the time range had to be bisected, update our info so if</span>
<a name="l01378"></a>01378     <span class="comment">// we need to take another step we do the right thing.</span>
<a name="l01379"></a>01379     <span class="keywordflow">if</span> (err === <span class="stringliteral">&#39;bisect&#39;</span>) {
<a name="l01380"></a>01380       var curDaysDelta = bisectInfo.curDaysDelta,
<a name="l01381"></a>01381           numHeaders = bisectInfo.numHeaders;
<a name="l01382"></a>01382 
<a name="l01383"></a>01383       <span class="comment">// If we had a fallback TS because we were synced to the dawn of time,</span>
<a name="l01384"></a>01384       <span class="comment">// use that and start by just cutting the range in thirds rather than</span>
<a name="l01385"></a>01385       <span class="comment">// doing a weighted bisection since the distribution might include</span>
<a name="l01386"></a>01386       <span class="comment">// a number of messages earlier than our fallback startTS.</span>
<a name="l01387"></a>01387       <span class="keywordflow">if</span> (this._curSyncDir === FUTUREWARDS &amp;&amp; this._fallbackOriginTS) {
<a name="l01388"></a>01388         this.folderStorage.clearSyncedToDawnOfTime(this._fallbackOriginTS);
<a name="l01389"></a>01389         bisectInfo.oldStartTS = this._fallbackOriginTS;
<a name="l01390"></a>01390         this._fallbackOriginTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01391"></a>01391         var effOldEndTS = bisectInfo.oldEndTS ||
<a name="l01392"></a>01392                           quantizeDate(NOW() + DAY_MILLIS +
<a name="l01393"></a>01393                                        this._account.tzOffset);
<a name="l01394"></a>01394         curDaysDelta = Math.round((effOldEndTS - bisectInfo.oldStartTS) /
<a name="l01395"></a>01395                                   DAY_MILLIS);
<a name="l01396"></a>01396         numHeaders = $sync.BISECT_DATE_AT_N_MESSAGES * 1.5;
<a name="l01397"></a>01397       }
<a name="l01398"></a>01398       <span class="comment">// Sanity check the time delta; if we grew the bounds to the dawn</span>
<a name="l01399"></a>01399       <span class="comment">// of time, then our interpolation is useless and it&#39;s better for</span>
<a name="l01400"></a>01400       <span class="comment">// us to crank things way down, even if it&#39;s erroneously so.</span>
<a name="l01401"></a>01401       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (curDaysDelta &gt; 1000)
<a name="l01402"></a>01402         curDaysDelta = 30;
<a name="l01403"></a>01403 
<a name="l01404"></a>01404       <span class="comment">// - Interpolate better time bounds.</span>
<a name="l01405"></a>01405       <span class="comment">// Assume a linear distribution of messages, but overestimated by</span>
<a name="l01406"></a>01406       <span class="comment">// a factor of two so we undershoot.  Also make sure that we subtract off</span>
<a name="l01407"></a>01407       <span class="comment">// at least 2 days at a time.  This is to ensure that in the case where</span>
<a name="l01408"></a>01408       <span class="comment">// endTS is null and we end up using makeDaysAgo that we actually shrink</span>
<a name="l01409"></a>01409       <span class="comment">// by at least 1 day (because of how rounding works for makeDaysAgo).</span>
<a name="l01410"></a>01410       var shrinkScale = $sync.BISECT_DATE_AT_N_MESSAGES /
<a name="l01411"></a>01411                           (numHeaders * 2),
<a name="l01412"></a>01412           dayStep = Math.max(1,
<a name="l01413"></a>01413                              Math.min(curDaysDelta - 2,
<a name="l01414"></a>01414                                       Math.ceil(shrinkScale * curDaysDelta)));
<a name="l01415"></a>01415       this._curSyncDayStep = dayStep;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417       <span class="keywordflow">if</span> (this._curSyncDir === PASTWARDS) {
<a name="l01418"></a>01418         bisectInfo.newEndTS = bisectInfo.oldEndTS;
<a name="l01419"></a>01419         this._nextSyncAnchorTS = bisectInfo.newStartTS =
<a name="l01420"></a>01420           makeDaysBefore(bisectInfo.newEndTS, dayStep, <span class="keyword">this</span>._account.tzOffset);
<a name="l01421"></a>01421         this._curSyncDoNotGrowBoundary = bisectInfo.oldStartTS;
<a name="l01422"></a>01422       }
<a name="l01423"></a>01423       <span class="keywordflow">else</span> { <span class="comment">// FUTUREWARDS</span>
<a name="l01424"></a>01424         bisectInfo.newStartTS = bisectInfo.oldStartTS;
<a name="l01425"></a>01425         this._nextSyncAnchorTS = bisectInfo.newEndTS =
<a name="l01426"></a>01426           makeDaysBefore(bisectInfo.newStartTS, -dayStep, <span class="keyword">this</span>._account.tzOffset);
<a name="l01427"></a>01427         this._curSyncDoNotGrowBoundary = bisectInfo.oldEndTS;
<a name="l01428"></a>01428       }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430       <span class="comment">// We return now without calling _doneSync because we are not done; the</span>
<a name="l01431"></a>01431       <span class="comment">// caller (syncDateRange) will re-trigger itself and keep going.</span>
<a name="l01432"></a>01432       <span class="keywordflow">return</span>;
<a name="l01433"></a>01433     }
<a name="l01434"></a>01434     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err) {
<a name="l01435"></a>01435       this._doneSync(err);
<a name="l01436"></a>01436       <span class="keywordflow">return</span>;
<a name="l01437"></a>01437     }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;Sync Completed!&quot;</span>, this._curSyncDayStep, <span class="stringliteral">&quot;days&quot;</span>,
<a name="l01440"></a>01440                 messagesSeen, <span class="stringliteral">&quot;messages synced&quot;</span>);
<a name="l01441"></a>01441 
<a name="l01442"></a>01442     <span class="comment">// - Slice is dead = we are done</span>
<a name="l01443"></a>01443     <span class="keywordflow">if</span> (this._syncSlice.isDead) {
<a name="l01444"></a>01444       this._doneSync();
<a name="l01445"></a>01445       <span class="keywordflow">return</span>;
<a name="l01446"></a>01446     }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448     <span class="comment">// If it now appears we know about all the messages in the folder, then we</span>
<a name="l01449"></a>01449     <span class="comment">// are done syncing and can mark the entire folder as synchronized.  This</span>
<a name="l01450"></a>01450     <span class="comment">// requires that:</span>
<a name="l01451"></a>01451     <span class="comment">// - The direction is pastwards. (We check the oldest header, so this</span>
<a name="l01452"></a>01452     <span class="comment">//   is important.  We don&#39;t really need to do a future-wards variant since</span>
<a name="l01453"></a>01453     <span class="comment">//   we always use pastwards for refreshes and the future-wards variant</span>
<a name="l01454"></a>01454     <span class="comment">//   really does not need a fast-path since the cost of stepping to &#39;today&#39;</span>
<a name="l01455"></a>01455     <span class="comment">//   is much cheaper thana the cost of walking all the way to 1990.)</span>
<a name="l01456"></a>01456     <span class="comment">// - The number of messages we know about is the same as the number the</span>
<a name="l01457"></a>01457     <span class="comment">//   server most recently told us are in the folder.</span>
<a name="l01458"></a>01458     <span class="comment">// - (There are no messages in the folder at all OR)</span>
<a name="l01459"></a>01459     <span class="comment">// - We have synchronized past the oldest known message header.  (This,</span>
<a name="l01460"></a>01460     <span class="comment">//   in combination with the fact that we always open from the most recent</span>
<a name="l01461"></a>01461     <span class="comment">//   set of messages we know about, that we fully synchronize all time</span>
<a name="l01462"></a>01462     <span class="comment">//   intervals (for now!), and our pastwards-direction for refreshes means</span>
<a name="l01463"></a>01463     <span class="comment">//   that we can conclude we have synchronized across all messages and</span>
<a name="l01464"></a>01464     <span class="comment">//   this is a sane conclusion to draw.)</span>
<a name="l01465"></a>01465     <span class="comment">//</span>
<a name="l01466"></a>01466     <span class="comment">// NB: If there are any deleted messages, this logic will not save us</span>
<a name="l01467"></a>01467     <span class="comment">// because we ignored those messages.  This is made less horrible by issuing</span>
<a name="l01468"></a>01468     <span class="comment">// a time-date that expands as we go further back in time.</span>
<a name="l01469"></a>01469     <span class="comment">//</span>
<a name="l01470"></a>01470     <span class="comment">// (I have considered asking to see deleted messages too and ignoring them;</span>
<a name="l01471"></a>01471     <span class="comment">// that might be suitable.  We could also just be a jerk and force an</span>
<a name="l01472"></a>01472     <span class="comment">// expunge.)</span>
<a name="l01473"></a>01473     var folderMessageCount = this.folderConn &amp;&amp; this.folderConn.box &amp;&amp;
<a name="l01474"></a>01474                              this.folderConn.box.messages.total,
<a name="l01475"></a>01475         dbCount = this.folderStorage.getKnownMessageCount(),
<a name="l01476"></a>01476         syncedThrough =
<a name="l01477"></a>01477           ((this._curSyncDir === PASTWARDS) ? effStartTS : effEndTS);
<a name="l01478"></a>01478 <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;folder message count&quot;</span>, folderMessageCount,
<a name="l01479"></a>01479             <span class="stringliteral">&quot;dbCount&quot;</span>, dbCount,
<a name="l01480"></a>01480             <span class="stringliteral">&quot;syncedThrough&quot;</span>, syncedThrough,
<a name="l01481"></a>01481             <span class="stringliteral">&quot;oldest known&quot;</span>, this.folderStorage.getOldestMessageTimestamp());
<a name="l01482"></a>01482     <span class="keywordflow">if</span> (this._curSyncDir === PASTWARDS &amp;&amp;
<a name="l01483"></a>01483         folderMessageCount === dbCount &amp;&amp;
<a name="l01484"></a>01484         (!folderMessageCount ||
<a name="l01485"></a>01485          TIME_DIR_AT_OR_BEYOND(this._curSyncDir, syncedThrough,
<a name="l01486"></a>01486                                this.folderStorage.getOldestMessageTimestamp()))
<a name="l01487"></a>01487        ) {
<a name="l01488"></a>01488       <span class="comment">// expand the accuracy range to cover everybody</span>
<a name="l01489"></a>01489       this.folderStorage.markSyncedToDawnOfTime();
<a name="l01490"></a>01490       this._doneSync();
<a name="l01491"></a>01491       <span class="keywordflow">return</span>;
<a name="l01492"></a>01492     }
<a name="l01493"></a>01493     <span class="comment">// If we&#39;ve synchronized to the limits of syncing in the given direction,</span>
<a name="l01494"></a>01494     <span class="comment">// we&#39;re done.</span>
<a name="l01495"></a>01495     <span class="keywordflow">if</span> (!this._nextSyncAnchorTS ||
<a name="l01496"></a>01496         TIME_DIR_AT_OR_BEYOND(this._curSyncDir, this._nextSyncAnchorTS,
<a name="l01497"></a>01497                               this._syncThroughTS)) {
<a name="l01498"></a>01498       this._doneSync();
<a name="l01499"></a>01499       <span class="keywordflow">return</span>;
<a name="l01500"></a>01500     }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502     <span class="comment">// - Done if this is a grow and we don&#39;t want/need any more headers.</span>
<a name="l01503"></a>01503     <span class="keywordflow">if</span> (this._curSyncIsGrow &amp;&amp;
<a name="l01504"></a>01504         this._syncSlice.headers.length &gt;= <span class="keyword">this</span>._syncSlice.desiredHeaders) {
<a name="l01505"></a>01505         <span class="comment">// (limited syncs aren&#39;t allowed to expand themselves)</span>
<a name="l01506"></a>01506       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;SYNCDONE Enough headers retrieved.&quot;</span>,
<a name="l01507"></a>01507                   <span class="stringliteral">&quot;have&quot;</span>, this._syncSlice.headers.length,
<a name="l01508"></a>01508                   <span class="stringliteral">&quot;want&quot;</span>, <span class="keyword">this</span>._syncSlice.desiredHeaders,
<a name="l01509"></a>01509                   <span class="stringliteral">&quot;conn knows about&quot;</span>, <span class="keyword">this</span>.folderConn.box.messages.total,
<a name="l01510"></a>01510                   <span class="stringliteral">&quot;sync date&quot;</span>, <span class="keyword">this</span>._curSyncStartTS,
<a name="l01511"></a>01511                   <span class="stringliteral">&quot;[oldest defined as&quot;</span>, $sync.OLDEST_SYNC_DATE, <span class="stringliteral">&quot;]&quot;</span>);
<a name="l01512"></a>01512       this._doneSync();
<a name="l01513"></a>01513       <span class="keywordflow">return</span>;
<a name="l01514"></a>01514     }
<a name="l01515"></a>01515     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (this._syncSlice._accumulating) {
<a name="l01516"></a>01516       <span class="comment">// flush the accumulated results thus far</span>
<a name="l01517"></a>01517       this._syncSlice.setStatus(<span class="stringliteral">&#39;synchronizing&#39;</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l01518"></a>01518     }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     <span class="comment">// - Increase our search window size if we aren&#39;t finding anything</span>
<a name="l01521"></a>01521     <span class="comment">// Our goal is that if we are going backwards in time and aren&#39;t finding</span>
<a name="l01522"></a>01522     <span class="comment">// anything, we want to keep expanding our window</span>
<a name="l01523"></a>01523     var daysToSearch, lastSyncDaysInPast;
<a name="l01524"></a>01524     <span class="comment">// If we saw messages, there is no need to increase the window size.  We</span>
<a name="l01525"></a>01525     <span class="comment">// also should not increase the size if we explicitly shrank the window and</span>
<a name="l01526"></a>01526     <span class="comment">// left a do-not-expand-until marker.</span>
<a name="l01527"></a>01527     <span class="keywordflow">if</span> (messagesSeen || (this._curSyncDoNotGrowBoundary !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> &amp;&amp;
<a name="l01528"></a>01528          !TIME_DIR_AT_OR_BEYOND(this._curSyncDir, this._nextSyncAnchorTS,
<a name="l01529"></a>01529                                 this._curSyncDoNotGrowBoundary))) {
<a name="l01530"></a>01530       daysToSearch = this._curSyncDayStep;
<a name="l01531"></a>01531     }
<a name="l01532"></a>01532     <span class="keywordflow">else</span> {
<a name="l01533"></a>01533       this._curSyncDoNotGrowBoundary = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01534"></a>01534       <span class="comment">// This may be a fractional value because of DST</span>
<a name="l01535"></a>01535       lastSyncDaysInPast = ((quantizeDate(NOW() + this._account.tzOffset)) -
<a name="l01536"></a>01536                            this._nextSyncAnchorTS) / DAY_MILLIS;
<a name="l01537"></a>01537       daysToSearch = Math.ceil(this._curSyncDayStep *
<a name="l01538"></a>01538                                $sync.TIME_SCALE_FACTOR_ON_NO_MESSAGES);
<a name="l01539"></a>01539 
<a name="l01540"></a>01540       <span class="comment">// These values used to be more conservative, but the importance of these</span>
<a name="l01541"></a>01541       <span class="comment">// guards was reduced when we switched to only syncing headers.</span>
<a name="l01542"></a>01542       <span class="comment">// At current constants (sync=3, scale=2), our doubling in the face of</span>
<a name="l01543"></a>01543       <span class="comment">// clamping is: 3, 6, 12, 24, 45, ... 90,</span>
<a name="l01544"></a>01544       <span class="keywordflow">if</span> (lastSyncDaysInPast &lt; 180) {
<a name="l01545"></a>01545         <span class="keywordflow">if</span> (daysToSearch &gt; 45)
<a name="l01546"></a>01546           daysToSearch = 45;
<a name="l01547"></a>01547       }
<a name="l01548"></a>01548       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastSyncDaysInPast &lt; 365) { <span class="comment">// 1 year</span>
<a name="l01549"></a>01549         <span class="keywordflow">if</span> (daysToSearch &gt; 90)
<a name="l01550"></a>01550           daysToSearch = 90;
<a name="l01551"></a>01551       }
<a name="l01552"></a>01552       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastSyncDaysInPast &lt; 730) { <span class="comment">// 2 years</span>
<a name="l01553"></a>01553         <span class="keywordflow">if</span> (daysToSearch &gt; 120)
<a name="l01554"></a>01554           daysToSearch = 120;
<a name="l01555"></a>01555       }
<a name="l01556"></a>01556       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastSyncDaysInPast &lt; 1825) { <span class="comment">// 5 years</span>
<a name="l01557"></a>01557         <span class="keywordflow">if</span> (daysToSearch &gt; 180)
<a name="l01558"></a>01558           daysToSearch = 180;
<a name="l01559"></a>01559       }
<a name="l01560"></a>01560       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastSyncDaysInPast &lt; 3650) { <span class="comment">// 10 years</span>
<a name="l01561"></a>01561         <span class="keywordflow">if</span> (daysToSearch &gt; 365)
<a name="l01562"></a>01562           daysToSearch = 365;
<a name="l01563"></a>01563       }
<a name="l01564"></a>01564       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (daysToSearch &gt; 730) {
<a name="l01565"></a>01565         daysToSearch = 730;
<a name="l01566"></a>01566       }
<a name="l01567"></a>01567       this._curSyncDayStep = daysToSearch;
<a name="l01568"></a>01568     }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570     <span class="comment">// - Move the time range back in time more.</span>
<a name="l01571"></a>01571     var startTS, endTS;
<a name="l01572"></a>01572     <span class="keywordflow">if</span> (this._curSyncDir === PASTWARDS) {
<a name="l01573"></a>01573       endTS = this._nextSyncAnchorTS;
<a name="l01574"></a>01574       this._nextSyncAnchorTS = startTS = makeDaysBefore(endTS, daysToSearch,
<a name="l01575"></a>01575                                                         this._account.tzOffset);
<a name="l01576"></a>01576     }
<a name="l01577"></a>01577     <span class="keywordflow">else</span> { <span class="comment">// FUTUREWARDS</span>
<a name="l01578"></a>01578       startTS = this._nextSyncAnchorTS;
<a name="l01579"></a>01579       this._nextSyncAnchorTS = endTS = makeDaysBefore(startTS, -daysToSearch,
<a name="l01580"></a>01580                                                       this._account.tzOffset);
<a name="l01581"></a>01581     }
<a name="l01582"></a>01582     this.folderConn.syncDateRange(startTS, endTS, this._curSyncAccuracyStamp,
<a name="l01583"></a>01583                                   this.onSyncCompleted.bind(<span class="keyword">this</span>));
<a name="l01584"></a>01584   },
<a name="l01585"></a>01585 
<a name="l01590"></a>01590   allConsumersDead: <span class="keyword">function</span>() {
<a name="l01591"></a>01591     this.folderConn.relinquishConn();
<a name="l01592"></a>01592   },
<a name="l01593"></a>01593 
<a name="l01594"></a>01594   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>() {
<a name="l01595"></a>01595     this.folderConn.shutdown();
<a name="l01596"></a>01596     this._LOG.__die();
<a name="l01597"></a>01597   },
<a name="l01598"></a>01598 };
<a name="l01599"></a>01599 
<a name="l01611"></a>01611 <span class="keyword">function</span> GmailMessageStorage() {
<a name="l01612"></a>01612 }
<a name="l01613"></a>01613 GmailMessageStorage.prototype = {
<a name="l01614"></a>01614 };
<a name="l01615"></a>01615 
<a name="l01616"></a>01616 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l01617"></a>01617   ImapFolderConn: {
<a name="l01618"></a>01618     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: $log.CONNECTION,
<a name="l01619"></a>01619     subtype: $log.CLIENT,
<a name="l01620"></a>01620     events: {
<a name="l01621"></a>01621     },
<a name="l01622"></a>01622     TEST_ONLY_events: {
<a name="l01623"></a>01623     },
<a name="l01624"></a>01624     errors: {
<a name="l01625"></a>01625       callbackErr: { ex: $log.EXCEPTION },
<a name="l01626"></a>01626 
<a name="l01627"></a>01627       htmlParseError: { ex: $log.EXCEPTION },
<a name="l01628"></a>01628       htmlSnippetError: { ex: $log.EXCEPTION },
<a name="l01629"></a>01629       textChewError: { ex: $log.EXCEPTION },
<a name="l01630"></a>01630       textSnippetError: { ex: $log.EXCEPTION },
<a name="l01631"></a>01631 
<a name="l01632"></a>01632       <span class="comment">// Attempted to sync with an empty or inverted range.</span>
<a name="l01633"></a>01633       illegalSync: { startTS: <span class="keyword">false</span>, endTS: <span class="keyword">false</span> },
<a name="l01634"></a>01634     },
<a name="l01635"></a>01635     asyncJobs: {
<a name="l01636"></a>01636       syncDateRange: {
<a name="l01637"></a>01637         newMessages: <span class="keyword">true</span>, existingMessages: <span class="keyword">true</span>, deletedMessages: <span class="keyword">true</span>,
<a name="l01638"></a>01638         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: <span class="keyword">false</span>, <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: <span class="keyword">false</span>, skewedStart: <span class="keyword">false</span>, skewedEnd: <span class="keyword">false</span>,
<a name="l01639"></a>01639       },
<a name="l01640"></a>01640     },
<a name="l01641"></a>01641   },
<a name="l01642"></a>01642   ImapFolderSyncer: {
<a name="l01643"></a>01643     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: $log.DATABASE,
<a name="l01644"></a>01644     events: {
<a name="l01645"></a>01645     }
<a name="l01646"></a>01646   },
<a name="l01647"></a>01647 }); <span class="comment">// end LOGFAB</span>
<a name="l01648"></a>01648 
<a name="l01649"></a>01649 }); <span class="comment">// end define</span>
<a name="l01650"></a>01650 ;
<a name="l01716"></a>01716 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/imap/jobs&#39;</span>,
<a name="l01717"></a>01717   [
<a name="l01718"></a>01718     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l01719"></a>01719     <span class="stringliteral">&#39;../jobmixins&#39;</span>,
<a name="l01720"></a>01720     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l01721"></a>01721     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l01722"></a>01722   ],
<a name="l01723"></a>01723   <span class="keyword">function</span>(
<a name="l01724"></a>01724     $log,
<a name="l01725"></a>01725     $jobmixins,
<a name="l01726"></a>01726     $module,
<a name="l01727"></a>01727     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l01728"></a>01728   ) {
<a name="l01729"></a>01729 
<a name="l01733"></a>01733 var CHECKED_NOTYET = <span class="stringliteral">&#39;checked-notyet&#39;</span>;
<a name="l01738"></a>01738 var UNCHECKED_IDEMPOTENT = <span class="stringliteral">&#39;idempotent&#39;</span>;
<a name="l01742"></a>01742 var CHECKED_HAPPENED = <span class="stringliteral">&#39;happened&#39;</span>;
<a name="l01748"></a>01748 var CHECKED_MOOT = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l01753"></a>01753 var UNCHECKED_BAILED = <span class="stringliteral">&#39;bailed&#39;</span>;
<a name="l01760"></a>01760 var UNCHECKED_COHERENT_NOTYET = <span class="stringliteral">&#39;coherent-notyet&#39;</span>;
<a name="l01761"></a>01761 
<a name="l01812"></a>01812 <span class="keyword">function</span> ImapJobDriver(account, <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>, _parentLog) {
<a name="l01813"></a>01813   this.account = account;
<a name="l01814"></a>01814   this.resilientServerIds = <span class="keyword">false</span>;
<a name="l01815"></a>01815   this._heldMutexReleasers = [];
<a name="l01816"></a>01816 
<a name="l01817"></a>01817   this._LOG = LOGFAB.ImapJobDriver(<span class="keyword">this</span>, _parentLog, this.account.id);
<a name="l01818"></a>01818 
<a name="l01819"></a>01819   this._state = <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>;
<a name="l01820"></a>01820   <span class="comment">// (we only need to use one as a proxy for initialization)</span>
<a name="l01821"></a>01821   <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.hasOwnProperty(<span class="stringliteral">&#39;suidToServerId&#39;</span>)) {
<a name="l01822"></a>01822     <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.suidToServerId = {};
<a name="l01823"></a>01823     <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.moveMap = {};
<a name="l01824"></a>01824   }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826   this._stateDelta = {
<a name="l01827"></a>01827     serverIdMap: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01828"></a>01828     moveMap: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01829"></a>01829   };
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ImapJobDriver = ImapJobDriver;
<a name="l01832"></a>01832 ImapJobDriver.prototype = {
<a name="l01865"></a>01865   _accessFolderForMutation: <span class="keyword">function</span>(folderId, needConn, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deathback,
<a name="l01866"></a>01866                                      label) {
<a name="l01867"></a>01867     var storage = this.account.getFolderStorageForFolderId(folderId),
<a name="l01868"></a>01868         <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01869"></a>01869     storage.runMutexed(label, <span class="keyword">function</span>(releaseMutex) {
<a name="l01870"></a>01870       var syncer = storage.folderSyncer;
<a name="l01871"></a>01871       var <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a4ef488940623c6d0eab866a64228de55">action</a> = <span class="keyword">function</span> () {
<a name="l01872"></a>01872         <span class="keyword">self</span>._heldMutexReleasers.push(releaseMutex);
<a name="l01873"></a>01873         <span class="keywordflow">try</span> {
<a name="l01874"></a>01874           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(syncer.folderConn, storage);
<a name="l01875"></a>01875         }
<a name="l01876"></a>01876         <span class="keywordflow">catch</span> (ex) {
<a name="l01877"></a>01877           <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l01878"></a>01878         }
<a name="l01879"></a>01879       };
<a name="l01880"></a>01880 
<a name="l01881"></a>01881       <span class="comment">// localdrafts is a synthetic folder and so we never want a connection</span>
<a name="l01882"></a>01882       <span class="comment">// for it.  This is a somewhat awkward place to make this decision, but</span>
<a name="l01883"></a>01883       <span class="comment">// it does work.</span>
<a name="l01884"></a>01884       <span class="keywordflow">if</span> (needConn &amp;&amp; storage.folderMeta.type !== <span class="stringliteral">&#39;localdrafts&#39;</span>) {
<a name="l01885"></a>01885         syncer.folderConn.withConnection(<span class="keyword">function</span> () {
<a name="l01886"></a>01886           <span class="comment">// When we release the mutex, the folder may not</span>
<a name="l01887"></a>01887           <span class="comment">// release its connection, so be sure to reset</span>
<a name="l01888"></a>01888           <span class="comment">// error handling (deathback).  We are slightly</span>
<a name="l01889"></a>01889           <span class="comment">// abusing the mutex releasing mutex mechanism</span>
<a name="l01890"></a>01890           <span class="comment">// here. And we do want to do this before calling</span>
<a name="l01891"></a>01891           <span class="comment">// the actual mutex releaser since we might</span>
<a name="l01892"></a>01892           <span class="comment">// otherwise interact with someone else who just</span>
<a name="l01893"></a>01893           <span class="comment">// acquired the mutex, (only) theoretically.</span>
<a name="l01894"></a>01894           <span class="keyword">self</span>._heldMutexReleasers.push(<span class="keyword">function</span>() {
<a name="l01895"></a>01895             syncer.folderConn.clearErrorHandler();
<a name="l01896"></a>01896           });
<a name="l01897"></a>01897 
<a name="l01898"></a>01898           <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a4ef488940623c6d0eab866a64228de55">action</a>();
<a name="l01899"></a>01899         },
<a name="l01900"></a>01900         <span class="comment">// Always pass true for dieOnConnectFailure; we don&#39;t want any of our</span>
<a name="l01901"></a>01901         <span class="comment">// operations hanging out waiting for retry backoffs.  The ops want to</span>
<a name="l01902"></a>01902         <span class="comment">// only run when we believe we are online with a good connection.</span>
<a name="l01903"></a>01903         deathback, label, <span class="keyword">true</span>);
<a name="l01904"></a>01904       } <span class="keywordflow">else</span> {
<a name="l01905"></a>01905         <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a4ef488940623c6d0eab866a64228de55">action</a>();
<a name="l01906"></a>01906       }
<a name="l01907"></a>01907     });
<a name="l01908"></a>01908   },
<a name="l01909"></a>01909 
<a name="l01910"></a>01910   _partitionAndAccessFoldersSequentially:
<a name="l01911"></a>01911     $jobmixins._partitionAndAccessFoldersSequentially,
<a name="l01912"></a>01912 
<a name="l01921"></a>01921   _acquireConnWithoutFolder: <span class="keyword">function</span>(label, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deathback) {
<a name="l01922"></a>01922     this._LOG.acquireConnWithoutFolder_begin(label);
<a name="l01923"></a>01923     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l01924"></a>01924     this.account.__folderDemandsConnection(
<a name="l01925"></a>01925       <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, label,
<a name="l01926"></a>01926       <span class="keyword">function</span>(conn) {
<a name="l01927"></a>01927         <span class="keyword">self</span>._LOG.acquireConnWithoutFolder_end(label);
<a name="l01928"></a>01928         <span class="keyword">self</span>._heldMutexReleasers.push(<span class="keyword">function</span>() {
<a name="l01929"></a>01929           <span class="keyword">self</span>.account.__folderDoneWithConnection(conn, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l01930"></a>01930         });
<a name="l01931"></a>01931         <span class="keywordflow">try</span> {
<a name="l01932"></a>01932           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(conn);
<a name="l01933"></a>01933         }
<a name="l01934"></a>01934         <span class="keywordflow">catch</span> (ex) {
<a name="l01935"></a>01935           <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l01936"></a>01936         }
<a name="l01937"></a>01937       },
<a name="l01938"></a>01938       deathback
<a name="l01939"></a>01939     );
<a name="l01940"></a>01940   },
<a name="l01941"></a>01941 
<a name="l01942"></a>01942   postJobCleanup: $jobmixins.postJobCleanup,
<a name="l01943"></a>01943 
<a name="l01944"></a>01944   allJobsDone: $jobmixins.allJobsDone,
<a name="l01945"></a>01945 
<a name="l01947"></a>01947   <span class="comment">// downloadBodies: Download the bodies from a list of messages</span>
<a name="l01948"></a>01948 
<a name="l01949"></a>01949   local_do_downloadBodies: $jobmixins.local_do_downloadBodies,
<a name="l01950"></a>01950 
<a name="l01951"></a>01951   do_downloadBodies: $jobmixins.do_downloadBodies,
<a name="l01952"></a>01952 
<a name="l01953"></a>01953   check_downloadBodies: $jobmixins.check_downloadBodies,
<a name="l01954"></a>01954 
<a name="l01956"></a>01956   <span class="comment">// downloadBodyReps: Download the bodies from a single message</span>
<a name="l01957"></a>01957 
<a name="l01958"></a>01958   local_do_downloadBodyReps: $jobmixins.local_do_downloadBodyReps,
<a name="l01959"></a>01959 
<a name="l01960"></a>01960   do_downloadBodyReps: $jobmixins.do_downloadBodyReps,
<a name="l01961"></a>01961 
<a name="l01962"></a>01962   check_downloadBodyReps: $jobmixins.check_downloadBodyReps,
<a name="l01963"></a>01963 
<a name="l01965"></a>01965   <span class="comment">// download: Download one or more attachments from a single message</span>
<a name="l01966"></a>01966 
<a name="l01967"></a>01967   local_do_download: $jobmixins.local_do_download,
<a name="l01968"></a>01968 
<a name="l01969"></a>01969   do_download: $jobmixins.do_download,
<a name="l01970"></a>01970 
<a name="l01971"></a>01971   check_download: $jobmixins.check_download,
<a name="l01972"></a>01972 
<a name="l01973"></a>01973   local_undo_download: $jobmixins.local_undo_download,
<a name="l01974"></a>01974 
<a name="l01975"></a>01975   undo_download: $jobmixins.undo_download,
<a name="l01976"></a>01976 
<a name="l01978"></a>01978   <span class="comment">// saveDraft</span>
<a name="l01979"></a>01979 
<a name="l01980"></a>01980   local_do_saveDraft: $jobmixins.local_do_saveDraft,
<a name="l01981"></a>01981 
<a name="l01982"></a>01982   do_saveDraft: $jobmixins.do_saveDraft,
<a name="l01983"></a>01983 
<a name="l01984"></a>01984   check_saveDraft: $jobmixins.check_saveDraft,
<a name="l01985"></a>01985 
<a name="l01986"></a>01986   local_undo_saveDraft: $jobmixins.local_undo_saveDraft,
<a name="l01987"></a>01987 
<a name="l01988"></a>01988   undo_saveDraft: $jobmixins.undo_saveDraft,
<a name="l01989"></a>01989 
<a name="l01991"></a>01991   <span class="comment">// deleteDraft</span>
<a name="l01992"></a>01992 
<a name="l01993"></a>01993   local_do_deleteDraft: $jobmixins.local_do_deleteDraft,
<a name="l01994"></a>01994 
<a name="l01995"></a>01995   do_deleteDraft: $jobmixins.do_deleteDraft,
<a name="l01996"></a>01996 
<a name="l01997"></a>01997   check_deleteDraft: $jobmixins.check_deleteDraft,
<a name="l01998"></a>01998 
<a name="l01999"></a>01999   local_undo_deleteDraft: $jobmixins.local_undo_deleteDraft,
<a name="l02000"></a>02000 
<a name="l02001"></a>02001   undo_deleteDraft: $jobmixins.undo_deleteDraft,
<a name="l02002"></a>02002 
<a name="l02004"></a>02004   <span class="comment">// modtags: Modify tags on messages</span>
<a name="l02005"></a>02005 
<a name="l02006"></a>02006   local_do_modtags: $jobmixins.local_do_modtags,
<a name="l02007"></a>02007 
<a name="l02008"></a>02008   do_modtags: <span class="keyword">function</span>(op, jobDoneCallback, undo) {
<a name="l02009"></a>02009     var addTags = undo ? op.removeTags : op.addTags,
<a name="l02010"></a>02010         removeTags = undo ? op.addTags : op.removeTags;
<a name="l02011"></a>02011 
<a name="l02012"></a>02012     var aggrErr = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02013"></a>02013 
<a name="l02014"></a>02014     this._partitionAndAccessFoldersSequentially(
<a name="l02015"></a>02015       op.messages, <span class="keyword">true</span>,
<a name="l02016"></a>02016       <span class="keyword">function</span> perFolder(folderConn, storage, serverIds, namers, callWhenDone) {
<a name="l02017"></a>02017         var modsToGo = 0;
<a name="l02018"></a>02018         <span class="keyword">function</span> tagsModded(err) {
<a name="l02019"></a>02019           <span class="keywordflow">if</span> (err) {
<a name="l02020"></a>02020             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;failure modifying tags&#39;</span>, err);
<a name="l02021"></a>02021             aggrErr = <span class="stringliteral">&#39;unknown&#39;</span>;
<a name="l02022"></a>02022             <span class="keywordflow">return</span>;
<a name="l02023"></a>02023           }
<a name="l02024"></a>02024           op.progress += (undo ? -serverIds.length : serverIds.length);
<a name="l02025"></a>02025           <span class="keywordflow">if</span> (--modsToGo === 0)
<a name="l02026"></a>02026             callWhenDone();
<a name="l02027"></a>02027         }
<a name="l02028"></a>02028         var uids = [];
<a name="l02029"></a>02029         <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; serverIds.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l02030"></a>02030           var srvid = serverIds[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l02031"></a>02031           <span class="comment">// The header may have disappeared from the server, in which case the</span>
<a name="l02032"></a>02032           <span class="comment">// header is moot.</span>
<a name="l02033"></a>02033           <span class="keywordflow">if</span> (srvid)
<a name="l02034"></a>02034             uids.push(srvid);
<a name="l02035"></a>02035         }
<a name="l02036"></a>02036         <span class="comment">// Be done if all of the headers were moot.</span>
<a name="l02037"></a>02037         <span class="keywordflow">if</span> (!uids.length) {
<a name="l02038"></a>02038           callWhenDone();
<a name="l02039"></a>02039           <span class="keywordflow">return</span>;
<a name="l02040"></a>02040         }
<a name="l02041"></a>02041         <span class="keywordflow">if</span> (addTags) {
<a name="l02042"></a>02042           modsToGo++;
<a name="l02043"></a>02043           folderConn._conn.addFlags(uids, addTags, tagsModded);
<a name="l02044"></a>02044         }
<a name="l02045"></a>02045         <span class="keywordflow">if</span> (removeTags) {
<a name="l02046"></a>02046           modsToGo++;
<a name="l02047"></a>02047           folderConn._conn.delFlags(uids, removeTags, tagsModded);
<a name="l02048"></a>02048         }
<a name="l02049"></a>02049       },
<a name="l02050"></a>02050       <span class="keyword">function</span> allDone() {
<a name="l02051"></a>02051         jobDoneCallback(aggrErr);
<a name="l02052"></a>02052       },
<a name="l02053"></a>02053       <span class="keyword">function</span> deadConn() {
<a name="l02054"></a>02054         aggrErr = <span class="stringliteral">&#39;aborted-retry&#39;</span>;
<a name="l02055"></a>02055       },
<a name="l02056"></a>02056       <span class="comment">/* reverse if we&#39;re undoing */</span> undo,
<a name="l02057"></a>02057       <span class="stringliteral">&#39;modtags&#39;</span>);
<a name="l02058"></a>02058   },
<a name="l02059"></a>02059 
<a name="l02060"></a>02060   check_modtags: <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02061"></a>02061     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, UNCHECKED_IDEMPOTENT);
<a name="l02062"></a>02062   },
<a name="l02063"></a>02063 
<a name="l02064"></a>02064   local_undo_modtags: $jobmixins.local_undo_modtags,
<a name="l02065"></a>02065 
<a name="l02066"></a>02066   undo_modtags: <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02067"></a>02067     <span class="comment">// Undoing is just a question of flipping the add and remove lists.</span>
<a name="l02068"></a>02068     <span class="keywordflow">return</span> this.do_modtags(op, callback, <span class="keyword">true</span>);
<a name="l02069"></a>02069   },
<a name="l02070"></a>02070 
<a name="l02072"></a>02072   <span class="comment">// delete: Delete messages</span>
<a name="l02073"></a>02073 
<a name="l02074"></a>02074   local_do_delete: $jobmixins.local_do_delete,
<a name="l02075"></a>02075 
<a name="l02080"></a>02080   do_delete: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02081"></a>02081     var trashFolder = this.account.getFirstFolderWithType(<span class="stringliteral">&#39;trash&#39;</span>);
<a name="l02082"></a>02082     this.do_move(op, doneCallback, trashFolder.id);
<a name="l02083"></a>02083   },
<a name="l02084"></a>02084 
<a name="l02085"></a>02085   check_delete: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02086"></a>02086     var trashFolder = this.account.getFirstFolderWithType(<span class="stringliteral">&#39;trash&#39;</span>);
<a name="l02087"></a>02087     this.check_move(op, doneCallback, trashFolder.id);
<a name="l02088"></a>02088   },
<a name="l02089"></a>02089 
<a name="l02090"></a>02090   local_undo_delete: $jobmixins.local_undo_delete,
<a name="l02091"></a>02091 
<a name="l02092"></a>02092   undo_delete: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02093"></a>02093   },
<a name="l02094"></a>02094 
<a name="l02096"></a>02096   <span class="comment">// move: Move messages between folders (in a single account)</span>
<a name="l02097"></a>02097   <span class="comment">//</span>
<a name="l02098"></a>02098   <span class="comment">// ## General Strategy ##</span>
<a name="l02099"></a>02099   <span class="comment">//</span>
<a name="l02100"></a>02100   <span class="comment">// Local Do:</span>
<a name="l02101"></a>02101   <span class="comment">//</span>
<a name="l02102"></a>02102   <span class="comment">// - Move the header to the target folder&#39;s storage, updating the op with the</span>
<a name="l02103"></a>02103   <span class="comment">//   message-id header of the message for each message so that the check</span>
<a name="l02104"></a>02104   <span class="comment">//   operation has them available.</span>
<a name="l02105"></a>02105   <span class="comment">//</span>
<a name="l02106"></a>02106   <span class="comment">//   This requires acquiring a write mutex to the target folder while also</span>
<a name="l02107"></a>02107   <span class="comment">//   holding one on the source folder.  We are assured there is no deadlock</span>
<a name="l02108"></a>02108   <span class="comment">//   because only operations are allowed to manipulate multiple folders at</span>
<a name="l02109"></a>02109   <span class="comment">//   once, and only one operation is in-flight per an account at a time.</span>
<a name="l02110"></a>02110   <span class="comment">//   (And cross-account moves are not handled by this operation.)</span>
<a name="l02111"></a>02111   <span class="comment">//</span>
<a name="l02112"></a>02112   <span class="comment">//   Insertion is done using the INTERNALDATE (which must be maintained by the</span>
<a name="l02113"></a>02113   <span class="comment">//   COPY operation) and a freshly allocated id, just like if we had heard</span>
<a name="l02114"></a>02114   <span class="comment">//   about the header from the server.</span>
<a name="l02115"></a>02115   <span class="comment">//</span>
<a name="l02116"></a>02116   <span class="comment">// Do:</span>
<a name="l02117"></a>02117   <span class="comment">//</span>
<a name="l02118"></a>02118   <span class="comment">// - Acquire a connection to the target folder so that we can know the UIDNEXT</span>
<a name="l02119"></a>02119   <span class="comment">//   value prior to performing the copy.  FUTURE: Don&#39;t do this if the server</span>
<a name="l02120"></a>02120   <span class="comment">//   supports UIDPLUS.</span>
<a name="l02121"></a>02121   <span class="comment">//</span>
<a name="l02122"></a>02122   <span class="comment">// (Do the following in a loop per-source folder)</span>
<a name="l02123"></a>02123   <span class="comment">//</span>
<a name="l02124"></a>02124   <span class="comment">// - Copy the messages to the target folder via COPY.</span>
<a name="l02125"></a>02125   <span class="comment">//</span>
<a name="l02126"></a>02126   <span class="comment">// - Figure out the UIDs of our moved messages.  FUTURE: If the server is</span>
<a name="l02127"></a>02127   <span class="comment">//   UIDPLUS, we already know these from the results of the previous command.</span>
<a name="l02128"></a>02128   <span class="comment">//   NOW: Issue a fetch on the message-id headers of the messages in the</span>
<a name="l02129"></a>02129   <span class="comment">//   range UIDNEXT:*.  Use these results to map the UIDs to the messages we</span>
<a name="l02130"></a>02130   <span class="comment">//   copied above.  In the event of duplicate message-id&#39;s, ordering doesn&#39;t</span>
<a name="l02131"></a>02131   <span class="comment">//   matter, we just pick the first one.  Update our UIDNEXT value in case</span>
<a name="l02132"></a>02132   <span class="comment">//   there is another pass through the loop.</span>
<a name="l02133"></a>02133   <span class="comment">//</span>
<a name="l02134"></a>02134   <span class="comment">// - Issue deletes on the messages from the source folder.</span>
<a name="l02135"></a>02135   <span class="comment">//</span>
<a name="l02136"></a>02136   <span class="comment">// Check: XXX TODO POSTPONED FOR PRELIMINARY LANDING</span>
<a name="l02137"></a>02137   <span class="comment">//</span>
<a name="l02138"></a>02138   <span class="comment">// NB: Our check implementation actually is a correcting check implemenation;</span>
<a name="l02139"></a>02139   <span class="comment">// we will make things end up the way they should be.  We do this because it</span>
<a name="l02140"></a>02140   <span class="comment">// is simpler than</span>
<a name="l02141"></a>02141   <span class="comment">//</span>
<a name="l02142"></a>02142   <span class="comment">// - Acquire a connection to the target folder.  Issue broad message-id</span>
<a name="l02143"></a>02143   <span class="comment">//   header searches to find if the messages appear to be in the folder</span>
<a name="l02144"></a>02144   <span class="comment">//   already, note which are already present.  This needs to take the form</span>
<a name="l02145"></a>02145   <span class="comment">//   of a SEARCH followed by a FETCH to map UIDs to message-id&#39;s.  In theory</span>
<a name="l02146"></a>02146   <span class="comment">//   the IMAP copy command should be atomic, but I&#39;m not sure we can trust</span>
<a name="l02147"></a>02147   <span class="comment">//   that and we also have the problem where there could already be duplicate</span>
<a name="l02148"></a>02148   <span class="comment">//   message-id headers in the target which could confuse us if our check is</span>
<a name="l02149"></a>02149   <span class="comment">//   insufficiently thorough.  The FETCH needs to also retrieve the flags</span>
<a name="l02150"></a>02150   <span class="comment">//   for the message so we can track deletion state.</span>
<a name="l02151"></a>02151   <span class="comment">//</span>
<a name="l02152"></a>02152   <span class="comment">// (Do the following in a loop per source folder)</span>
<a name="l02153"></a>02153   <span class="comment">//</span>
<a name="l02154"></a>02154   <span class="comment">// - Acquire connections for each source folder.  Issue message-id searches</span>
<a name="l02155"></a>02155   <span class="comment">//   like we did for the target including header results.  In theory we might</span>
<a name="l02156"></a>02156   <span class="comment">//   remember the UIDs for check acceleration purposes, but that would not</span>
<a name="l02157"></a>02157   <span class="comment">//   cover if we tried to perform an undo, so we go for thorough.</span>
<a name="l02158"></a>02158   <span class="comment">//</span>
<a name="l02159"></a>02159   <span class="comment">// -</span>
<a name="l02160"></a>02160   <span class="comment">//</span>
<a name="l02161"></a>02161   <span class="comment">// ## Possible Problems and their Solutions ##</span>
<a name="l02162"></a>02162   <span class="comment">//</span>
<a name="l02163"></a>02163   <span class="comment">// Moves are fairly complicated in terms of moving parts, so let&#39;s enumate the</span>
<a name="l02164"></a>02164   <span class="comment">// way things could go wrong so we can make sure we address them and describe</span>
<a name="l02165"></a>02165   <span class="comment">// how we address them.  Note that it&#39;s a given that we will have run our</span>
<a name="l02166"></a>02166   <span class="comment">// local modifications prior to trying to talk to the server, which reduces</span>
<a name="l02167"></a>02167   <span class="comment">// the potential badness.</span>
<a name="l02168"></a>02168   <span class="comment">//</span>
<a name="l02169"></a>02169   <span class="comment">// #1: We attempt to resynchronize the source folder for a move prior to</span>
<a name="l02170"></a>02170   <span class="comment">//     running the operation against the server, resulting in us synchronizing</span>
<a name="l02171"></a>02171   <span class="comment">//     a duplicate header into existence that will not be detected until the</span>
<a name="l02172"></a>02172   <span class="comment">//     next resync of the time range (which will be strictly after when we</span>
<a name="l02173"></a>02173   <span class="comment">//     actually run the mutation.</span>
<a name="l02174"></a>02174   <span class="comment">//</span>
<a name="l02175"></a>02175   <span class="comment">// #2: Operations scheduled against speculative headers.  It is quite possible</span>
<a name="l02176"></a>02176   <span class="comment">//     for the user to perform actions against one of the locally /</span>
<a name="l02177"></a>02177   <span class="comment">//     speculatively moved headers while we are offline/have not yet played</span>
<a name="l02178"></a>02178   <span class="comment">//     the operation/are racing the UI while playing the operation.  We</span>
<a name="l02179"></a>02179   <span class="comment">//     obviously want these changes to succeed.</span>
<a name="l02180"></a>02180   <span class="comment">//</span>
<a name="l02181"></a>02181   <span class="comment">// Our solutions:</span>
<a name="l02182"></a>02182   <span class="comment">//</span>
<a name="l02183"></a>02183   <span class="comment">// #1: Prior to resynchronizing a folder, we check if there are any operations</span>
<a name="l02184"></a>02184   <span class="comment">//     that block synchronization.  An un-run move with a source of that</span>
<a name="l02185"></a>02185   <span class="comment">//     folder counts as such an operation.  We can determine this by either</span>
<a name="l02186"></a>02186   <span class="comment">//     having sufficient knowledge to inspect an operation or have operations</span>
<a name="l02187"></a>02187   <span class="comment">//     directly modify book-keeping structures in the folders as part of their</span>
<a name="l02188"></a>02188   <span class="comment">//     actions.  (Add blocker on local_(un)do, remove on (un)do.)  We choose</span>
<a name="l02189"></a>02189   <span class="comment">//     to implement the inspection operation by having all operations</span>
<a name="l02190"></a>02190   <span class="comment">//     implement a simple helper to tell us if the operation blocks entry.</span>
<a name="l02191"></a>02191   <span class="comment">//     The theory is this will be less prone to bugs since it will be clear</span>
<a name="l02192"></a>02192   <span class="comment">//     that operations need to implement the method, whereas it would be less</span>
<a name="l02193"></a>02193   <span class="comment">//     clear that operations need to do call the folder-state mutating</span>
<a name="l02194"></a>02194   <span class="comment">//     options.</span>
<a name="l02195"></a>02195   <span class="comment">//</span>
<a name="l02196"></a>02196   <span class="comment">// #2: Operations against speculative headers are a concern only from a naming</span>
<a name="l02197"></a>02197   <span class="comment">//     perspective for operations.  Operations are strictly run in the order</span>
<a name="l02198"></a>02198   <span class="comment">//     they are enqueued, so we know that the header will have been moved and</span>
<a name="l02199"></a>02199   <span class="comment">//     be in the right folder.  Additionally, because both the UI and</span>
<a name="l02200"></a>02200   <span class="comment">//     operations name messages using an id we issue rather than the server</span>
<a name="l02201"></a>02201   <span class="comment">//     UID, there is no potential for naming inconsistencies.  The UID will be</span>
<a name="l02202"></a>02202   <span class="comment">//     resolved at operation run-time which only requires that the move</span>
<a name="l02203"></a>02203   <span class="comment">//     operation either was UIDPLUS or we manually sussed out the target id</span>
<a name="l02204"></a>02204   <span class="comment">//     (which we do for simplicity).</span>
<a name="l02205"></a>02205   <span class="comment">//</span>
<a name="l02206"></a>02206   <span class="comment">// XXX problem: repeated moves and UIDs.</span>
<a name="l02207"></a>02207   <span class="comment">// what we do know:</span>
<a name="l02208"></a>02208   <span class="comment">// - in order to know about a message, we must have a current UID of the</span>
<a name="l02209"></a>02209   <span class="comment">//   message on the server where it currently lives.</span>
<a name="l02210"></a>02210   <span class="comment">// what we could do:</span>
<a name="l02211"></a>02211   <span class="comment">// - have successor move operations moot/replace their predecessor.  So a</span>
<a name="l02212"></a>02212   <span class="comment">//   move from A to B, and then from B to C will just become a move from A to</span>
<a name="l02213"></a>02213   <span class="comment">//   C from the perspective of the online op that will eventually be run.  We</span>
<a name="l02214"></a>02214   <span class="comment">//   could potentially build this on top of a renaming strategy.  So if we</span>
<a name="l02215"></a>02215   <span class="comment">//   move z-in-A to z-in-B, and then change a tag on z-in-B, and then move</span>
<a name="l02216"></a>02216   <span class="comment">//   z-in-B to z-in-C, renaming and consolidatin would make this a move of</span>
<a name="l02217"></a>02217   <span class="comment">//   z-in-A to z-in-C followed by a tag change on z-in-C.</span>
<a name="l02218"></a>02218   <span class="comment">// - produce micro-IMAP-ops as a byproduct of our local actions that are</span>
<a name="l02219"></a>02219   <span class="comment">//   stored on the operation.  So in the A/move to B/tag/move to C case above,</span>
<a name="l02220"></a>02220   <span class="comment">//   we would not consolidate anything, just produce a transaction journal.</span>
<a name="l02221"></a>02221   <span class="comment">//   The A-move-to-B case would be covered by serializing the information</span>
<a name="l02222"></a>02222   <span class="comment">//   for the IMAP COPY and deletion.  In the UIDPLUS case, we have an</span>
<a name="l02223"></a>02223   <span class="comment">//   automatic knowledge of the resulting new target UID; in the non-UIDPLUS</span>
<a name="l02224"></a>02224   <span class="comment">//   case we can open the target folder and find out the new UID as part of</span>
<a name="l02225"></a>02225   <span class="comment">//   the micro-op.  The question here is then how we chain these various</span>
<a name="l02226"></a>02226   <span class="comment">//   results together in the multi-move case, or when we write the result to</span>
<a name="l02227"></a>02227   <span class="comment">//   the target:</span>
<a name="l02228"></a>02228   <span class="comment">//   - maintain an output value map for the operations.  When there is just</span>
<a name="l02229"></a>02229   <span class="comment">//     the one move, the output for the UID for each move is the current</span>
<a name="l02230"></a>02230   <span class="comment">//     header name of the message, which we will load and write the value</span>
<a name="l02231"></a>02231   <span class="comment">//     into.  When there are multiple moves, the output map is adjusted and</span>
<a name="l02232"></a>02232   <span class="comment">//     used to indicate that we should stash the UID in quasi-persistent</span>
<a name="l02233"></a>02233   <span class="comment">//     storage for a subsequent move operation.  (This could be thought of</span>
<a name="l02234"></a>02234   <span class="comment">//     as similar to the renaming logic, but explicit.)</span>
<a name="l02235"></a>02235 
<a name="l02236"></a>02236 
<a name="l02237"></a>02237   local_do_move: $jobmixins.local_do_move,
<a name="l02238"></a>02238 
<a name="l02239"></a>02239   do_move: <span class="keyword">function</span>(op, jobDoneCallback, targetFolderId) {
<a name="l02240"></a>02240     var <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> = this._state, stateDelta = this._stateDelta, aggrErr = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02241"></a>02241     <span class="keywordflow">if</span> (!stateDelta.serverIdMap)
<a name="l02242"></a>02242       stateDelta.serverIdMap = {};
<a name="l02243"></a>02243     <span class="keywordflow">if</span> (!targetFolderId)
<a name="l02244"></a>02244       targetFolderId = op.targetFolder;
<a name="l02245"></a>02245 
<a name="l02246"></a>02246     this._partitionAndAccessFoldersSequentially(
<a name="l02247"></a>02247       op.messages, <span class="keyword">true</span>,
<a name="l02248"></a>02248       <span class="keyword">function</span> perFolder(folderConn, sourceStorage, serverIds, namers,
<a name="l02249"></a>02249                          perFolderDone){
<a name="l02250"></a>02250         <span class="comment">// XXX process UIDPLUS output when present, avoiding this step.</span>
<a name="l02251"></a>02251         var guidToNamer = {}, waitingOnHeaders = namers.length,
<a name="l02252"></a>02252             reportedHeaders = 0, retriesLeft = 3, targetConn;
<a name="l02253"></a>02253 
<a name="l02254"></a>02254         <span class="comment">// - got the target folder conn, now do the copies</span>
<a name="l02255"></a>02255         <span class="keyword">function</span> gotTargetConn(targetConn, targetStorage) {
<a name="l02256"></a>02256           var uidnext = targetConn.box._uidnext;
<a name="l02257"></a>02257           folderConn._conn.copy(serverIds, targetStorage.folderMeta.path,
<a name="l02258"></a>02258                                 copiedMessages_reselect);
<a name="l02259"></a>02259 
<a name="l02260"></a>02260           <span class="keyword">function</span> copiedMessages_reselect() {
<a name="l02261"></a>02261             <span class="comment">// Force a re-select of the folder to try and force the server to</span>
<a name="l02262"></a>02262             <span class="comment">// perceive the move.  This was necessary for me at least on my</span>
<a name="l02263"></a>02263             <span class="comment">// dovceot test setup.  Although we had heard that the COPY</span>
<a name="l02264"></a>02264             <span class="comment">// completed, our FETCH was too fast, although an IDLE did report</span>
<a name="l02265"></a>02265             <span class="comment">// the new messages after that.</span>
<a name="l02266"></a>02266 
<a name="l02267"></a>02267             <span class="comment">// We need to use a callback here because imap.js&#39;s state</span>
<a name="l02268"></a>02268             <span class="comment">// checking is immediate, so it&#39;s very possible to race the folder</span>
<a name="l02269"></a>02269             <span class="comment">// selection and lose.</span>
<a name="l02270"></a>02270             targetConn.reselectBox(copiedMessages_findNewUIDs);
<a name="l02271"></a>02271           }
<a name="l02272"></a>02272           <span class="comment">// - copies are done, find the UIDs</span>
<a name="l02273"></a>02273           <span class="keyword">function</span> copiedMessages_findNewUIDs() {
<a name="l02274"></a>02274             var fetcher = targetConn._conn.fetch(
<a name="l02275"></a>02275               uidnext + <span class="stringliteral">&#39;:*&#39;</span>,
<a name="l02276"></a>02276               {
<a name="l02277"></a>02277                 <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a>: {
<a name="l02278"></a>02278                   <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>: [<span class="stringliteral">&#39;MESSAGE-ID&#39;</span>],
<a name="l02279"></a>02279                   <span class="keyword">struct</span>: <span class="keyword">false</span>,
<a name="l02280"></a>02280                   body: <span class="keyword">false</span>
<a name="l02281"></a>02281                 }
<a name="l02282"></a>02282               });
<a name="l02283"></a>02283             <span class="comment">// because we aren&#39;t waiting for body data, we can just process the</span>
<a name="l02284"></a>02284             <span class="comment">// &#39;message&#39; event directly without registering for an &#39;end&#39; event</span>
<a name="l02285"></a>02285             <span class="comment">// on it.</span>
<a name="l02286"></a>02286             fetcher.on(<span class="stringliteral">&#39;message&#39;</span>, <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02287"></a>02287               <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.on(<span class="stringliteral">&#39;end&#39;</span>, fetchedMessageData);
<a name="l02288"></a>02288             });
<a name="l02289"></a>02289             <span class="comment">// We don&#39;t need to wait for &#39;end&#39; since we know how many of these</span>
<a name="l02290"></a>02290             <span class="comment">// we care about.</span>
<a name="l02291"></a>02291             fetcher.on(<span class="stringliteral">&#39;error&#39;</span>, <span class="keyword">function</span>(err) {
<a name="l02292"></a>02292               aggrErr = err;
<a name="l02293"></a>02293               perFolderDone();
<a name="l02294"></a>02294             });
<a name="l02295"></a>02295             fetcher.on(<span class="stringliteral">&#39;end&#39;</span>, <span class="keyword">function</span>() {
<a name="l02296"></a>02296               <span class="keywordflow">if</span> (reportedHeaders &lt; namers.length) {
<a name="l02297"></a>02297                 <span class="comment">// If we didn&#39;t hear about all the headers, let&#39;s retry in</span>
<a name="l02298"></a>02298                 <span class="comment">// a little bit.</span>
<a name="l02299"></a>02299                 <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (--retriesLeft === 0) {
<a name="l02300"></a>02300                   aggrErr = <span class="stringliteral">&#39;aborted-retry&#39;</span>;
<a name="l02301"></a>02301                   perFolderDone();
<a name="l02302"></a>02302                   <span class="keywordflow">return</span>;
<a name="l02303"></a>02303                 }
<a name="l02304"></a>02304 
<a name="l02305"></a>02305                 <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(copiedMessages_findNewUIDs, 500);
<a name="l02306"></a>02306               }
<a name="l02307"></a>02307             });
<a name="l02308"></a>02308           }
<a name="l02309"></a>02309           <span class="keyword">function</span> fetchedMessageData(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02310"></a>02310             var guid = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.msg.meta.messageId;
<a name="l02311"></a>02311             <span class="keywordflow">if</span> (!guidToNamer.hasOwnProperty(guid))
<a name="l02312"></a>02312               <span class="keywordflow">return</span>;
<a name="l02313"></a>02313             reportedHeaders++;
<a name="l02314"></a>02314             var namer = guidToNamer[guid];
<a name="l02315"></a>02315             stateDelta.serverIdMap[namer.suid] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.id;
<a name="l02316"></a>02316             uidnext = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.id + 1;
<a name="l02317"></a>02317             var newSuid = state.moveMap[namer.suid];
<a name="l02318"></a>02318             var newId =
<a name="l02319"></a>02319                   parseInt(newSuid.substring(newSuid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>) + 1));
<a name="l02320"></a>02320             targetStorage.updateMessageHeader(
<a name="l02321"></a>02321               namer.date, newId, <span class="keyword">false</span>,
<a name="l02322"></a>02322               <span class="keyword">function</span>(header) {
<a name="l02323"></a>02323                 <span class="comment">// If the header isn&#39;t there because it got moved, then null</span>
<a name="l02324"></a>02324                 <span class="comment">// will be returned and it&#39;s up to the next move operation to</span>
<a name="l02325"></a>02325                 <span class="comment">// fix this up.</span>
<a name="l02326"></a>02326                 <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (header)
<a name="l02327"></a>02327                   header.srvid = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.id;
<a name="l02328"></a>02328                 <span class="keywordflow">else</span>
<a name="l02329"></a>02329                   <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;did not find header for&#39;</span>, namer.suid,
<a name="l02330"></a>02330                                newSuid, namer.date, newId);
<a name="l02331"></a>02331                 <span class="keywordflow">if</span> (--waitingOnHeaders === 0)
<a name="l02332"></a>02332                   foundUIDs_deleteOriginals();
<a name="l02333"></a>02333                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02334"></a>02334               });
<a name="l02335"></a>02335           }
<a name="l02336"></a>02336         }
<a name="l02337"></a>02337 
<a name="l02338"></a>02338         <span class="keyword">function</span> foundUIDs_deleteOriginals() {
<a name="l02339"></a>02339           folderConn._conn.addFlags(serverIds, [<span class="stringliteral">&#39;\\Deleted&#39;</span>],
<a name="l02340"></a>02340                                     deletedMessages);
<a name="l02341"></a>02341         }
<a name="l02342"></a>02342         <span class="keyword">function</span> deletedMessages(err) {
<a name="l02343"></a>02343           <span class="keywordflow">if</span> (err)
<a name="l02344"></a>02344             aggrErr = <span class="keyword">true</span>;
<a name="l02345"></a>02345           perFolderDone();
<a name="l02346"></a>02346         }
<a name="l02347"></a>02347 
<a name="l02348"></a>02348         <span class="comment">// Build a guid-to-namer map and deal with any messages that no longer</span>
<a name="l02349"></a>02349         <span class="comment">// exist on the server.  Do it backwards so we can splice.</span>
<a name="l02350"></a>02350         <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = namers.length - 1; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &gt;= 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>--) {
<a name="l02351"></a>02351           var srvid = serverIds[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l02352"></a>02352           <span class="keywordflow">if</span> (!srvid) {
<a name="l02353"></a>02353             serverIds.splice(<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, 1);
<a name="l02354"></a>02354             namers.splice(<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, 1);
<a name="l02355"></a>02355             <span class="keywordflow">continue</span>;
<a name="l02356"></a>02356           }
<a name="l02357"></a>02357           var namer = namers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l02358"></a>02358           guidToNamer[namer.guid] = namer;
<a name="l02359"></a>02359         }
<a name="l02360"></a>02360         <span class="comment">// it&#39;s possible all the messages could be gone, in which case we</span>
<a name="l02361"></a>02361         <span class="comment">// are done with this folder already!</span>
<a name="l02362"></a>02362         <span class="keywordflow">if</span> (serverIds.length === 0) {
<a name="l02363"></a>02363           perFolderDone();
<a name="l02364"></a>02364           <span class="keywordflow">return</span>;
<a name="l02365"></a>02365         }
<a name="l02366"></a>02366 
<a name="l02367"></a>02367         <span class="comment">// There is nothing to do on localdrafts folders, server-wise.</span>
<a name="l02368"></a>02368         <span class="keywordflow">if</span> (sourceStorage.folderMeta.type === <span class="stringliteral">&#39;localdrafts&#39;</span>) {
<a name="l02369"></a>02369           perFolderDone();
<a name="l02370"></a>02370         }
<a name="l02371"></a>02371         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sourceStorage.folderId === targetFolderId) {
<a name="l02372"></a>02372           <span class="keywordflow">if</span> (op.type === <span class="stringliteral">&#39;move&#39;</span>) {
<a name="l02373"></a>02373             <span class="comment">// A move from a folder to itself is a no-op.</span>
<a name="l02374"></a>02374             perFolderDone();
<a name="l02375"></a>02375           }
<a name="l02376"></a>02376           <span class="keywordflow">else</span> { <span class="comment">// op.type === &#39;delete&#39;</span>
<a name="l02377"></a>02377             <span class="comment">// If the op is a delete and the source and destination folders</span>
<a name="l02378"></a>02378             <span class="comment">// match, we&#39;re deleting from trash, so just perma-delete it.</span>
<a name="l02379"></a>02379             foundUIDs_deleteOriginals();
<a name="l02380"></a>02380           }
<a name="l02381"></a>02381         }
<a name="l02382"></a>02382         <span class="keywordflow">else</span> {
<a name="l02383"></a>02383           <span class="comment">// Resolve the target folder again.</span>
<a name="l02384"></a>02384           this._accessFolderForMutation(targetFolderId, <span class="keyword">true</span>, gotTargetConn,
<a name="l02385"></a>02385                                         <span class="keyword">function</span> targetFolderDead() {},
<a name="l02386"></a>02386                                         <span class="stringliteral">&#39;move target&#39;</span>);
<a name="l02387"></a>02387         }
<a name="l02388"></a>02388       }.bind(<span class="keyword">this</span>),
<a name="l02389"></a>02389       <span class="keyword">function</span>() {
<a name="l02390"></a>02390         jobDoneCallback(aggrErr);
<a name="l02391"></a>02391       },
<a name="l02392"></a>02392       <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02393"></a>02393       <span class="keyword">false</span>,
<a name="l02394"></a>02394       <span class="stringliteral">&#39;local move source&#39;</span>);
<a name="l02395"></a>02395   },
<a name="l02396"></a>02396 
<a name="l02402"></a>02402   check_move: <span class="keyword">function</span>(op, doneCallback, targetFolderId) {
<a name="l02403"></a>02403     <span class="comment">// get a connection in the target folder</span>
<a name="l02404"></a>02404     <span class="comment">// do a search on message-id&#39;s to check if the messages got copied across.</span>
<a name="l02405"></a>02405     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02406"></a>02406   },
<a name="l02407"></a>02407 
<a name="l02408"></a>02408   local_undo_move: $jobmixins.local_undo_move,
<a name="l02409"></a>02409 
<a name="l02421"></a>02421   undo_move: <span class="keyword">function</span>(op, doneCallback, targetFolderId) {
<a name="l02422"></a>02422     doneCallback(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02423"></a>02423   },
<a name="l02424"></a>02424 
<a name="l02426"></a>02426   <span class="comment">// append: Add a message to a folder</span>
<a name="l02427"></a>02427   <span class="comment">//</span>
<a name="l02428"></a>02428   <span class="comment">// Message should look like:</span>
<a name="l02429"></a>02429   <span class="comment">// {</span>
<a name="l02430"></a>02430   <span class="comment">//    messageText: the message body,</span>
<a name="l02431"></a>02431   <span class="comment">//    date: the date to use as the INTERNALDATE of the message,</span>
<a name="l02432"></a>02432   <span class="comment">//    flags: the initial set of flags for the message</span>
<a name="l02433"></a>02433   <span class="comment">// }</span>
<a name="l02434"></a>02434 
<a name="l02435"></a>02435   local_do_append: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02436"></a>02436     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02437"></a>02437   },
<a name="l02438"></a>02438 
<a name="l02442"></a>02442   do_append: <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02443"></a>02443     var folderConn, <span class="keyword">self</span> = <span class="keyword">this</span>,
<a name="l02444"></a>02444         storage = this.account.getFolderStorageForFolderId(op.folderId),
<a name="l02445"></a>02445         folderMeta = storage.folderMeta,
<a name="l02446"></a>02446         iNextMessage = 0;
<a name="l02447"></a>02447 
<a name="l02448"></a>02448     var gotFolderConn = <span class="keyword">function</span> gotFolderConn(_folderConn) {
<a name="l02449"></a>02449       <span class="keywordflow">if</span> (!_folderConn) {
<a name="l02450"></a>02450         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l02451"></a>02451         <span class="keywordflow">return</span>;
<a name="l02452"></a>02452       }
<a name="l02453"></a>02453       folderConn = _folderConn;
<a name="l02454"></a>02454       <span class="keywordflow">if</span> (folderConn._conn.hasCapability(<span class="stringliteral">&#39;MULTIAPPEND&#39;</span>))
<a name="l02455"></a>02455         multiappend();
<a name="l02456"></a>02456       <span class="keywordflow">else</span>
<a name="l02457"></a>02457         <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#afe45b12054b6269d2537c8e0e4233b68">append</a>();
<a name="l02458"></a>02458     };
<a name="l02459"></a>02459     var deadConn = <span class="keyword">function</span> deadConn() {
<a name="l02460"></a>02460       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;aborted-retry&#39;</span>);
<a name="l02461"></a>02461     };
<a name="l02462"></a>02462     var multiappend = <span class="keyword">function</span> multiappend() {
<a name="l02463"></a>02463       iNextMessage = op.messages.length;
<a name="l02464"></a>02464       folderConn._conn.multiappend(op.messages, appended);
<a name="l02465"></a>02465     };
<a name="l02466"></a>02466     var <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#afe45b12054b6269d2537c8e0e4233b68">append</a> = <span class="keyword">function</span> <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#afe45b12054b6269d2537c8e0e4233b68">append</a>() {
<a name="l02467"></a>02467       var <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a> = op.messages[iNextMessage++];
<a name="l02468"></a>02468       folderConn._conn.append(
<a name="l02469"></a>02469         message.messageText,
<a name="l02470"></a>02470         message, <span class="comment">// (it will ignore messageText)</span>
<a name="l02471"></a>02471         appended);
<a name="l02472"></a>02472     };
<a name="l02473"></a>02473     var appended = <span class="keyword">function</span> appended(err) {
<a name="l02474"></a>02474       <span class="keywordflow">if</span> (err) {
<a name="l02475"></a>02475         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;failure appending message&#39;</span>, err);
<a name="l02476"></a>02476         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l02477"></a>02477         <span class="keywordflow">return</span>;
<a name="l02478"></a>02478       }
<a name="l02479"></a>02479       <span class="keywordflow">if</span> (iNextMessage &lt; op.messages.length)
<a name="l02480"></a>02480         <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#afe45b12054b6269d2537c8e0e4233b68">append</a>();
<a name="l02481"></a>02481       <span class="keywordflow">else</span>
<a name="l02482"></a>02482         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02483"></a>02483     };
<a name="l02484"></a>02484     var <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a> = <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(errString) {
<a name="l02485"></a>02485       <span class="keywordflow">if</span> (folderConn)
<a name="l02486"></a>02486         folderConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02487"></a>02487       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(errString);
<a name="l02488"></a>02488     };
<a name="l02489"></a>02489 
<a name="l02490"></a>02490     this._accessFolderForMutation(op.folderId, <span class="keyword">true</span>, gotFolderConn, deadConn,
<a name="l02491"></a>02491                                   <span class="stringliteral">&#39;append&#39;</span>);
<a name="l02492"></a>02492   },
<a name="l02493"></a>02493 
<a name="l02499"></a>02499   check_append: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02500"></a>02500     <span class="comment">// XXX search on the message-id in the folder to verify its presence.</span>
<a name="l02501"></a>02501     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02502"></a>02502   },
<a name="l02503"></a>02503 
<a name="l02504"></a>02504   <span class="comment">// TODO implement</span>
<a name="l02505"></a>02505   local_undo_append: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02506"></a>02506     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02507"></a>02507   },
<a name="l02508"></a>02508 
<a name="l02509"></a>02509   <span class="comment">// TODO implement</span>
<a name="l02510"></a>02510   undo_append: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02511"></a>02511     doneCallback(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02512"></a>02512   },
<a name="l02513"></a>02513 
<a name="l02515"></a>02515   <span class="comment">// syncFolderList</span>
<a name="l02516"></a>02516   <span class="comment">//</span>
<a name="l02517"></a>02517   <span class="comment">// Synchronize our folder list.  This should always be an idempotent operation</span>
<a name="l02518"></a>02518   <span class="comment">// that makes no sense to undo/redo/etc.</span>
<a name="l02519"></a>02519 
<a name="l02520"></a>02520   local_do_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02521"></a>02521     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02522"></a>02522   },
<a name="l02523"></a>02523 
<a name="l02524"></a>02524   do_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02525"></a>02525     var account = this.account, reported = <span class="keyword">false</span>;
<a name="l02526"></a>02526     this._acquireConnWithoutFolder(
<a name="l02527"></a>02527       <span class="stringliteral">&#39;syncFolderList&#39;</span>,
<a name="l02528"></a>02528       <span class="keyword">function</span> gotConn(conn) {
<a name="l02529"></a>02529         account._syncFolderList(conn, <span class="keyword">function</span>(err) {
<a name="l02530"></a>02530             <span class="keywordflow">if</span> (!err)
<a name="l02531"></a>02531               account.meta.lastFolderSyncAt = Date.now();
<a name="l02532"></a>02532             <span class="comment">// request an account save</span>
<a name="l02533"></a>02533             <span class="keywordflow">if</span> (!reported)
<a name="l02534"></a>02534               doneCallback(err ? <span class="stringliteral">&#39;aborted-retry&#39;</span> : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, null, !err);
<a name="l02535"></a>02535             reported = <span class="keyword">true</span>;
<a name="l02536"></a>02536           });
<a name="l02537"></a>02537       },
<a name="l02538"></a>02538       <span class="keyword">function</span> deadConn() {
<a name="l02539"></a>02539         <span class="keywordflow">if</span> (!reported)
<a name="l02540"></a>02540           doneCallback(<span class="stringliteral">&#39;aborted-retry&#39;</span>);
<a name="l02541"></a>02541         reported = <span class="keyword">true</span>;
<a name="l02542"></a>02542       });
<a name="l02543"></a>02543   },
<a name="l02544"></a>02544 
<a name="l02545"></a>02545   check_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02546"></a>02546     doneCallback(<span class="stringliteral">&#39;idempotent&#39;</span>);
<a name="l02547"></a>02547   },
<a name="l02548"></a>02548 
<a name="l02549"></a>02549   local_undo_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02550"></a>02550     doneCallback(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02551"></a>02551   },
<a name="l02552"></a>02552 
<a name="l02553"></a>02553   undo_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02554"></a>02554     doneCallback(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02555"></a>02555   },
<a name="l02556"></a>02556 
<a name="l02558"></a>02558   <span class="comment">// createFolder: Create a folder</span>
<a name="l02559"></a>02559 
<a name="l02560"></a>02560   local_do_createFolder: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02561"></a>02561     <span class="comment">// we never locally perform this operation.</span>
<a name="l02562"></a>02562     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02563"></a>02563   },
<a name="l02564"></a>02564 
<a name="l02565"></a>02565   do_createFolder: <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02566"></a>02566     var <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>, delim, parentFolderId = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02567"></a>02567     <span class="keywordflow">if</span> (op.parentFolderId) {
<a name="l02568"></a>02568       <span class="keywordflow">if</span> (!this.account._folderInfos.hasOwnProperty(op.parentFolderId))
<a name="l02569"></a>02569         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;No such folder: &quot;</span> + op.parentFolderId);
<a name="l02570"></a>02570       var parentFolder = this.account._folderInfos[op.parentFolderId];
<a name="l02571"></a>02571       delim = parentFolder.$meta.delim;
<a name="l02572"></a>02572       path = parentFolder.$meta.path + delim;
<a name="l02573"></a>02573       parentFolderId = parentFolder.$meta.id;
<a name="l02574"></a>02574     }
<a name="l02575"></a>02575     <span class="keywordflow">else</span> {
<a name="l02576"></a>02576       path = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02577"></a>02577       delim = this.account.meta.rootDelim;
<a name="l02578"></a>02578     }
<a name="l02579"></a>02579     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(op.folderName) === <span class="stringliteral">&#39;string&#39;</span>)
<a name="l02580"></a>02580       path += op.folderName;
<a name="l02581"></a>02581     <span class="keywordflow">else</span>
<a name="l02582"></a>02582       path += op.folderName.join(delim);
<a name="l02583"></a>02583     <span class="keywordflow">if</span> (op.containOnlyOtherFolders)
<a name="l02584"></a>02584       path += delim;
<a name="l02585"></a>02585 
<a name="l02586"></a>02586     var rawConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l02587"></a>02587     <span class="keyword">function</span> gotConn(conn) {
<a name="l02588"></a>02588       <span class="comment">// create the box</span>
<a name="l02589"></a>02589       rawConn = conn;
<a name="l02590"></a>02590       rawConn.addBox(path, addBoxCallback);
<a name="l02591"></a>02591     }
<a name="l02592"></a>02592     <span class="keyword">function</span> addBoxCallback(err) {
<a name="l02593"></a>02593       <span class="keywordflow">if</span> (err) {
<a name="l02594"></a>02594         <span class="comment">// If the folder already exists, we are done.</span>
<a name="l02595"></a>02595         <span class="keywordflow">if</span> (err.serverResponse &amp;&amp;
<a name="l02596"></a>02596             /\[ALREADYEXISTS\]/.test(err.serverResponse)) {
<a name="l02597"></a>02597           <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02598"></a>02598           <span class="keywordflow">return</span>;
<a name="l02599"></a>02599         }
<a name="l02600"></a>02600         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error creating box:&#39;</span>, err);
<a name="l02601"></a>02601         <span class="comment">// XXX implement the already-exists check...</span>
<a name="l02602"></a>02602         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l02603"></a>02603         <span class="keywordflow">return</span>;
<a name="l02604"></a>02604       }
<a name="l02605"></a>02605       <span class="comment">// Do a list on the folder so that we get the right attributes and any</span>
<a name="l02606"></a>02606       <span class="comment">// magical case normalization performed by the server gets observed by</span>
<a name="l02607"></a>02607       <span class="comment">// us.</span>
<a name="l02608"></a>02608       rawConn.getBoxes(<span class="stringliteral">&#39;&#39;</span>, path, gotBoxes);
<a name="l02609"></a>02609     }
<a name="l02610"></a>02610     <span class="keyword">function</span> gotBoxes(err, boxesRoot) {
<a name="l02611"></a>02611       <span class="keywordflow">if</span> (err) {
<a name="l02612"></a>02612         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error looking up box:&#39;</span>, err);
<a name="l02613"></a>02613         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l02614"></a>02614         <span class="keywordflow">return</span>;
<a name="l02615"></a>02615       }
<a name="l02616"></a>02616       <span class="comment">// We need to re-derive the path.  The hierarchy will only be that</span>
<a name="l02617"></a>02617       <span class="comment">// required for our new folder, so we traverse all children and create</span>
<a name="l02618"></a>02618       <span class="comment">// the leaf-node when we see it.</span>
<a name="l02619"></a>02619       var folderMeta = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02620"></a>02620       <span class="keyword">function</span> walkBoxes(boxLevel, pathSoFar, pathDepth) {
<a name="l02621"></a>02621         <span class="keywordflow">for</span> (var boxName in boxLevel) {
<a name="l02622"></a>02622           var box = boxLevel[boxName],
<a name="l02623"></a>02623               boxPath = pathSoFar ? (pathSoFar + boxName) : boxName;
<a name="l02624"></a>02624           <span class="keywordflow">if</span> (box.children) {
<a name="l02625"></a>02625             walkBoxes(box.children, boxPath + box.delim, pathDepth + 1);
<a name="l02626"></a>02626           }
<a name="l02627"></a>02627           <span class="keywordflow">else</span> {
<a name="l02628"></a>02628             var <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = <span class="keyword">self</span>.account._determineFolderType(box, boxPath, rawConn);
<a name="l02629"></a>02629             folderMeta = <span class="keyword">self</span>.account._learnAboutFolder(
<a name="l02630"></a>02630               boxName, boxPath, parentFolderId, type, box.delim, pathDepth);
<a name="l02631"></a>02631           }
<a name="l02632"></a>02632         }
<a name="l02633"></a>02633       }
<a name="l02634"></a>02634       walkBoxes(boxesRoot, <span class="stringliteral">&#39;&#39;</span>, 0);
<a name="l02635"></a>02635       <span class="keywordflow">if</span> (folderMeta)
<a name="l02636"></a>02636         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, folderMeta);
<a name="l02637"></a>02637       <span class="keywordflow">else</span>
<a name="l02638"></a>02638         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l02639"></a>02639     }
<a name="l02640"></a>02640     <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(errString, folderMeta) {
<a name="l02641"></a>02641       <span class="keywordflow">if</span> (rawConn)
<a name="l02642"></a>02642         rawConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02643"></a>02643       <span class="keywordflow">if</span> (callback)
<a name="l02644"></a>02644         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(errString, folderMeta);
<a name="l02645"></a>02645     }
<a name="l02646"></a>02646     <span class="keyword">function</span> deadConn() {
<a name="l02647"></a>02647       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;aborted-retry&#39;</span>);
<a name="l02648"></a>02648     }
<a name="l02649"></a>02649     this._acquireConnWithoutFolder(<span class="stringliteral">&#39;createFolder&#39;</span>, gotConn, deadConn);
<a name="l02650"></a>02650   },
<a name="l02651"></a>02651 
<a name="l02652"></a>02652   check_createFolder: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02653"></a>02653   },
<a name="l02654"></a>02654 
<a name="l02655"></a>02655   local_undo_createFolder: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02656"></a>02656     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02657"></a>02657   },
<a name="l02658"></a>02658 
<a name="l02659"></a>02659   <span class="comment">// TODO: port deleteFolder to be an op and invoke it here</span>
<a name="l02660"></a>02660   undo_createFolder: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02661"></a>02661     doneCallback(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02662"></a>02662   },
<a name="l02663"></a>02663 
<a name="l02665"></a>02665   <span class="comment">// purgeExcessMessages</span>
<a name="l02666"></a>02666 
<a name="l02667"></a>02667   local_do_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02668"></a>02668     this._accessFolderForMutation(
<a name="l02669"></a>02669       op.folderId, <span class="keyword">false</span>,
<a name="l02670"></a>02670       <span class="keyword">function</span> withMutex(_ignoredConn, storage) {
<a name="l02671"></a>02671         storage.purgeExcessMessages(<span class="keyword">function</span>(numDeleted, cutTS) {
<a name="l02672"></a>02672           <span class="comment">// Indicate that we want a save performed if any messages got deleted.</span>
<a name="l02673"></a>02673           doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, numDeleted &gt; 0);
<a name="l02674"></a>02674         });
<a name="l02675"></a>02675       },
<a name="l02676"></a>02676       <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02677"></a>02677       <span class="stringliteral">&#39;purgeExcessMessages&#39;</span>);
<a name="l02678"></a>02678   },
<a name="l02679"></a>02679 
<a name="l02680"></a>02680   do_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02681"></a>02681     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02682"></a>02682   },
<a name="l02683"></a>02683 
<a name="l02684"></a>02684   check_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02685"></a>02685     <span class="comment">// this is a local-only modification, so this doesn&#39;t really matter</span>
<a name="l02686"></a>02686     <span class="keywordflow">return</span> UNCHECKED_IDEMPOTENT;
<a name="l02687"></a>02687   },
<a name="l02688"></a>02688 
<a name="l02689"></a>02689   local_undo_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02690"></a>02690     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02691"></a>02691   },
<a name="l02692"></a>02692 
<a name="l02693"></a>02693   undo_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02694"></a>02694     doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l02695"></a>02695   },
<a name="l02696"></a>02696 
<a name="l02698"></a>02698 };
<a name="l02699"></a>02699 
<a name="l02700"></a>02700 <span class="keyword">function</span> HighLevelJobDriver() {
<a name="l02701"></a>02701 }
<a name="l02702"></a>02702 HighLevelJobDriver.prototype = {
<a name="l02710"></a>02710   do_xmove: <span class="keyword">function</span>() {
<a name="l02711"></a>02711   },
<a name="l02712"></a>02712 
<a name="l02713"></a>02713   check_xmove: <span class="keyword">function</span>() {
<a name="l02714"></a>02714 
<a name="l02715"></a>02715   },
<a name="l02716"></a>02716 
<a name="l02722"></a>02722   undo_xmove: <span class="keyword">function</span>() {
<a name="l02723"></a>02723   },
<a name="l02724"></a>02724 
<a name="l02730"></a>02730   do_xcopy: <span class="keyword">function</span>() {
<a name="l02731"></a>02731   },
<a name="l02732"></a>02732 
<a name="l02733"></a>02733   check_xcopy: <span class="keyword">function</span>() {
<a name="l02734"></a>02734   },
<a name="l02735"></a>02735 
<a name="l02739"></a>02739   undo_xcopy: <span class="keyword">function</span>() {
<a name="l02740"></a>02740   },
<a name="l02741"></a>02741 };
<a name="l02742"></a>02742 
<a name="l02743"></a>02743 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l02744"></a>02744   ImapJobDriver: {
<a name="l02745"></a>02745     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: $log.DAEMON,
<a name="l02746"></a>02746     events: {
<a name="l02747"></a>02747       savedAttachment: { storage: <span class="keyword">true</span>, mimeType: <span class="keyword">true</span>, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a6d7e27eaec1e5f6600e65858be43c18b">size</a>: <span class="keyword">true</span> },
<a name="l02748"></a>02748       saveFailure: { storage: <span class="keyword">false</span>, mimeType: <span class="keyword">false</span>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>: <span class="keyword">false</span> },
<a name="l02749"></a>02749     },
<a name="l02750"></a>02750     TEST_ONLY_events: {
<a name="l02751"></a>02751       saveFailure: { <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>: <span class="keyword">false</span> },
<a name="l02752"></a>02752     },
<a name="l02753"></a>02753     asyncJobs: {
<a name="l02754"></a>02754       acquireConnWithoutFolder: { label: <span class="keyword">false</span> },
<a name="l02755"></a>02755     },
<a name="l02756"></a>02756     errors: {
<a name="l02757"></a>02757       callbackErr: { ex: $log.EXCEPTION },
<a name="l02758"></a>02758     },
<a name="l02759"></a>02759   },
<a name="l02760"></a>02760 });
<a name="l02761"></a>02761 
<a name="l02762"></a>02762 }); <span class="comment">// end define</span>
<a name="l02763"></a>02763 ;
<a name="l02768"></a>02768 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/imap/account&#39;</span>,
<a name="l02769"></a>02769   [
<a name="l02770"></a>02770     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l02771"></a>02771     <span class="stringliteral">&#39;../a64&#39;</span>,
<a name="l02772"></a>02772     <span class="stringliteral">&#39;../allback&#39;</span>,
<a name="l02773"></a>02773     <span class="stringliteral">&#39;../accountmixins&#39;</span>,
<a name="l02774"></a>02774     <span class="stringliteral">&#39;../errbackoff&#39;</span>,
<a name="l02775"></a>02775     <span class="stringliteral">&#39;../mailslice&#39;</span>,
<a name="l02776"></a>02776     <span class="stringliteral">&#39;../searchfilter&#39;</span>,
<a name="l02777"></a>02777     <span class="stringliteral">&#39;../util&#39;</span>,
<a name="l02778"></a>02778     <span class="stringliteral">&#39;./folder&#39;</span>,
<a name="l02779"></a>02779     <span class="stringliteral">&#39;./jobs&#39;</span>,
<a name="l02780"></a>02780     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l02781"></a>02781     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l02782"></a>02782     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l02783"></a>02783   ],
<a name="l02784"></a>02784   <span class="keyword">function</span>(
<a name="l02785"></a>02785     $log,
<a name="l02786"></a>02786     $a64,
<a name="l02787"></a>02787     $allback,
<a name="l02788"></a>02788     $acctmixins,
<a name="l02789"></a>02789     $errbackoff,
<a name="l02790"></a>02790     $mailslice,
<a name="l02791"></a>02791     $searchfilter,
<a name="l02792"></a>02792     $util,
<a name="l02793"></a>02793     $imapfolder,
<a name="l02794"></a>02794     $imapjobs,
<a name="l02795"></a>02795     $module,
<a name="l02796"></a>02796     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l02797"></a>02797     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l02798"></a>02798   ) {
<a name="l02799"></a>02799 var bsearchForInsert = $util.bsearchForInsert;
<a name="l02800"></a>02800 var allbackMaker = $allback.allbackMaker;
<a name="l02801"></a>02801 
<a name="l02802"></a>02802 <span class="keyword">function</span> cmpFolderPubPath(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) {
<a name="l02803"></a>02803   <span class="keywordflow">return</span> <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.path.localeCompare(<a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.path);
<a name="l02804"></a>02804 }
<a name="l02805"></a>02805 
<a name="l02814"></a>02814 <span class="keyword">function</span> ImapAccount(universe, compositeAccount, accountId, credentials,
<a name="l02815"></a>02815                      connInfo, folderInfos,
<a name="l02816"></a>02816                      dbConn,
<a name="l02817"></a>02817                      _parentLog, existingProtoConn) {
<a name="l02818"></a>02818   this.universe = universe;
<a name="l02819"></a>02819   this.compositeAccount = compositeAccount;
<a name="l02820"></a>02820   this.<span class="keywordtype">id</span> = accountId;
<a name="l02821"></a>02821   this.accountDef = compositeAccount.accountDef;
<a name="l02822"></a>02822 
<a name="l02823"></a>02823   this.<a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a> = <span class="keyword">true</span>;
<a name="l02824"></a>02824   this._alive = <span class="keyword">true</span>;
<a name="l02825"></a>02825 
<a name="l02826"></a>02826   this._LOG = LOGFAB.ImapAccount(<span class="keyword">this</span>, _parentLog, this.<span class="keywordtype">id</span>);
<a name="l02827"></a>02827 
<a name="l02828"></a>02828   this._credentials = credentials;
<a name="l02829"></a>02829   this._connInfo = connInfo;
<a name="l02830"></a>02830   this._db = dbConn;
<a name="l02831"></a>02831 
<a name="l02851"></a>02851   this._maxConnsAllowed = 3;
<a name="l02856"></a>02856   this._pendingConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02857"></a>02857   this._ownedConns = [];
<a name="l02866"></a>02866   this._demandedConns = [];
<a name="l02867"></a>02867   this._backoffEndpoint = $errbackoff.createEndpoint(<span class="stringliteral">&#39;imap:&#39;</span> + this.<span class="keywordtype">id</span>, <span class="keyword">this</span>,
<a name="l02868"></a>02868                                                      this._LOG);
<a name="l02869"></a>02869 
<a name="l02870"></a>02870   <span class="keywordflow">if</span> (existingProtoConn)
<a name="l02871"></a>02871     this._reuseConnection(existingProtoConn);
<a name="l02872"></a>02872 
<a name="l02873"></a>02873   <span class="comment">// Yes, the pluralization is suspect, but unambiguous.</span>
<a name="l02875"></a>02875 <span class="comment"></span>  var folderStorages = this._folderStorages = {};
<a name="l02877"></a>02877   var folderPubs = this.folders = [];
<a name="l02878"></a>02878 
<a name="l02883"></a>02883   this._deadFolderIds = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02884"></a>02884 
<a name="l02888"></a>02888   this._folderInfos = folderInfos;
<a name="l02913"></a>02913   this.meta = this._folderInfos.$meta;
<a name="l02927"></a>02927   this.mutations = this._folderInfos.$mutations;
<a name="l02928"></a>02928   this.tzOffset = compositeAccount.accountDef.tzOffset;
<a name="l02929"></a>02929   <span class="keywordflow">for</span> (var folderId in folderInfos) {
<a name="l02930"></a>02930     <span class="keywordflow">if</span> (folderId[0] === <span class="charliteral">&#39;$&#39;</span>)
<a name="l02931"></a>02931       <span class="keywordflow">continue</span>;
<a name="l02932"></a>02932     var folderInfo = folderInfos[folderId];
<a name="l02933"></a>02933 
<a name="l02934"></a>02934     folderStorages[folderId] =
<a name="l02935"></a>02935       <span class="keyword">new</span> $mailslice.FolderStorage(<span class="keyword">this</span>, folderId, folderInfo, this._db,
<a name="l02936"></a>02936                                    $imapfolder.ImapFolderSyncer, <span class="keyword">this</span>._LOG);
<a name="l02937"></a>02937     folderPubs.push(folderInfo.$meta);
<a name="l02938"></a>02938   }
<a name="l02939"></a>02939   this.folders.sort(<span class="keyword">function</span>(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) {
<a name="l02940"></a>02940     <span class="keywordflow">return</span> <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.path.localeCompare(<a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.path);
<a name="l02941"></a>02941   });
<a name="l02942"></a>02942 
<a name="l02943"></a>02943   this._jobDriver = <span class="keyword">new</span> $imapjobs.ImapJobDriver(
<a name="l02944"></a>02944                           <span class="keyword">this</span>, this._folderInfos.$mutationState, <span class="keyword">this</span>._LOG);
<a name="l02945"></a>02945 
<a name="l02950"></a>02950   this._TEST_doNotCloseFolder = <span class="keyword">false</span>;
<a name="l02951"></a>02951 
<a name="l02952"></a>02952   <span class="comment">// Ensure we have an inbox.  This is a folder that must exist with a standard</span>
<a name="l02953"></a>02953   <span class="comment">// name, so we can create it without talking to the server.</span>
<a name="l02954"></a>02954   var inboxFolder = this.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>);
<a name="l02955"></a>02955   <span class="keywordflow">if</span> (!inboxFolder) {
<a name="l02956"></a>02956     <span class="comment">// XXX localized inbox string (bug 805834)</span>
<a name="l02957"></a>02957     this._learnAboutFolder(<span class="stringliteral">&#39;INBOX&#39;</span>, <span class="stringliteral">&#39;INBOX&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;inbox&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, 0, <span class="keyword">true</span>);
<a name="l02958"></a>02958   }
<a name="l02959"></a>02959 }
<a name="l02960"></a>02960 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.Account = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ImapAccount = ImapAccount;
<a name="l02961"></a>02961 ImapAccount.prototype = {
<a name="l02962"></a>02962   <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;imap&#39;</span>,
<a name="l02963"></a>02963   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l02964"></a>02964     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[ImapAccount: &#39;</span> + this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l02965"></a>02965   },
<a name="l02966"></a>02966 
<a name="l02967"></a>02967   <span class="keyword">get</span> isGmail() {
<a name="l02968"></a>02968     <span class="keywordflow">return</span> this.meta.capability.indexOf(<span class="stringliteral">&#39;X-GM-EXT-1&#39;</span>) !== -1;
<a name="l02969"></a>02969   },
<a name="l02970"></a>02970 
<a name="l02974"></a>02974   _learnAboutFolder: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>, parentId, <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, delim, depth,
<a name="l02975"></a>02975                               suppressNotification) {
<a name="l02976"></a>02976     var folderId = this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;/&#39;</span> + $a64.encodeInt(this.meta.nextFolderNum++);
<a name="l02977"></a>02977     var folderInfo = this._folderInfos[folderId] = {
<a name="l02978"></a>02978       $meta: {
<a name="l02979"></a>02979         <span class="keywordtype">id</span>: folderId,
<a name="l02980"></a>02980         <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>,
<a name="l02981"></a>02981         type: <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>,
<a name="l02982"></a>02982         path: <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>,
<a name="l02983"></a>02983         parentId: parentId,
<a name="l02984"></a>02984         delim: delim,
<a name="l02985"></a>02985         depth: depth,
<a name="l02986"></a>02986         lastSyncedAt: 0
<a name="l02987"></a>02987       },
<a name="l02988"></a>02988       $impl: {
<a name="l02989"></a>02989         nextId: 0,
<a name="l02990"></a>02990         nextHeaderBlock: 0,
<a name="l02991"></a>02991         nextBodyBlock: 0,
<a name="l02992"></a>02992       },
<a name="l02993"></a>02993       accuracy: [],
<a name="l02994"></a>02994       headerBlocks: [],
<a name="l02995"></a>02995       bodyBlocks: [],
<a name="l02996"></a>02996       serverIdHeaderBlockMapping: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">// IMAP does not need the mapping</span>
<a name="l02997"></a>02997     };
<a name="l02998"></a>02998     this._folderStorages[folderId] =
<a name="l02999"></a>02999       <span class="keyword">new</span> $mailslice.FolderStorage(<span class="keyword">this</span>, folderId, folderInfo, this._db,
<a name="l03000"></a>03000                                    $imapfolder.ImapFolderSyncer, <span class="keyword">this</span>._LOG);
<a name="l03001"></a>03001 
<a name="l03002"></a>03002     var folderMeta = folderInfo.$meta;
<a name="l03003"></a>03003     var idx = bsearchForInsert(this.folders, folderMeta, cmpFolderPubPath);
<a name="l03004"></a>03004     this.folders.splice(idx, 0, folderMeta);
<a name="l03005"></a>03005 
<a name="l03006"></a>03006     <span class="keywordflow">if</span> (!suppressNotification)
<a name="l03007"></a>03007       this.universe.__notifyAddedFolder(<span class="keyword">this</span>, folderMeta);
<a name="l03008"></a>03008     <span class="keywordflow">return</span> folderMeta;
<a name="l03009"></a>03009   },
<a name="l03010"></a>03010 
<a name="l03011"></a>03011   _forgetFolder: <span class="keyword">function</span>(folderId, suppressNotification) {
<a name="l03012"></a>03012     var folderInfo = this._folderInfos[folderId],
<a name="l03013"></a>03013         folderMeta = folderInfo.$meta;
<a name="l03014"></a>03014     <span class="keyword">delete</span> this._folderInfos[folderId];
<a name="l03015"></a>03015     var folderStorage = this._folderStorages[folderId];
<a name="l03016"></a>03016     <span class="keyword">delete</span> this._folderStorages[folderId];
<a name="l03017"></a>03017     var idx = this.folders.indexOf(folderMeta);
<a name="l03018"></a>03018     this.folders.splice(idx, 1);
<a name="l03019"></a>03019     <span class="keywordflow">if</span> (this._deadFolderIds === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l03020"></a>03020       this._deadFolderIds = [];
<a name="l03021"></a>03021     this._deadFolderIds.push(folderId);
<a name="l03022"></a>03022     folderStorage.youAreDeadCleanupAfterYourself();
<a name="l03023"></a>03023 
<a name="l03024"></a>03024     <span class="keywordflow">if</span> (!suppressNotification)
<a name="l03025"></a>03025       this.universe.__notifyRemovedFolder(<span class="keyword">this</span>, folderMeta);
<a name="l03026"></a>03026   },
<a name="l03027"></a>03027 
<a name="l03036"></a>03036   _recreateFolder: <span class="keyword">function</span>(folderId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03037"></a>03037     this._LOG.recreateFolder(folderId);
<a name="l03038"></a>03038     var folderInfo = this._folderInfos[folderId];
<a name="l03039"></a>03039     folderInfo.$impl = {
<a name="l03040"></a>03040       nextId: 0,
<a name="l03041"></a>03041       nextHeaderBlock: 0,
<a name="l03042"></a>03042       nextBodyBlock: 0,
<a name="l03043"></a>03043     };
<a name="l03044"></a>03044     folderInfo.accuracy = [];
<a name="l03045"></a>03045     folderInfo.headerBlocks = [];
<a name="l03046"></a>03046     folderInfo.bodyBlocks = [];
<a name="l03047"></a>03047     <span class="comment">// IMAP does not use serverIdHeaderBlockMapping</span>
<a name="l03048"></a>03048 
<a name="l03049"></a>03049     <span class="keywordflow">if</span> (this._deadFolderIds === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l03050"></a>03050       this._deadFolderIds = [];
<a name="l03051"></a>03051     this._deadFolderIds.push(folderId);
<a name="l03052"></a>03052 
<a name="l03053"></a>03053     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l03054"></a>03054     this.saveAccountState(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="keyword">function</span>() {
<a name="l03055"></a>03055       var newStorage =
<a name="l03056"></a>03056         <span class="keyword">new</span> $mailslice.FolderStorage(<span class="keyword">self</span>, folderId, folderInfo, <span class="keyword">self</span>._db,
<a name="l03057"></a>03057                                      $imapfolder.ImapFolderSyncer,
<a name="l03058"></a>03058                                      <span class="keyword">self</span>._LOG);
<a name="l03059"></a>03059       <span class="keywordflow">for</span> (var iter in Iterator(<span class="keyword">self</span>._folderStorages[folderId]._slices)) {
<a name="l03060"></a>03060         var <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a> = iter[1];
<a name="l03061"></a>03061         slice._storage = newStorage;
<a name="l03062"></a>03062         slice.reset();
<a name="l03063"></a>03063         newStorage.sliceOpenMostRecent(slice);
<a name="l03064"></a>03064       }
<a name="l03065"></a>03065       <span class="keyword">self</span>._folderStorages[folderId]._slices = [];
<a name="l03066"></a>03066       <span class="keyword">self</span>._folderStorages[folderId] = newStorage;
<a name="l03067"></a>03067 
<a name="l03068"></a>03068       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(newStorage);
<a name="l03069"></a>03069     }, <span class="stringliteral">&#39;recreateFolder&#39;</span>);
<a name="l03070"></a>03070   },
<a name="l03071"></a>03071 
<a name="l03076"></a>03076   __checkpointSyncCompleted: <span class="keyword">function</span>() {
<a name="l03077"></a>03077     this.saveAccountState(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;checkpointSync&#39;</span>);
<a name="l03078"></a>03078   },
<a name="l03079"></a>03079 
<a name="l03086"></a>03086   <a class="code" href="../../df/d99/namespacevariant.html#ab05c7931468d628f4294600987d629f2">deleteFolder</a>: <span class="keyword">function</span>(folderId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03087"></a>03087     <span class="keywordflow">if</span> (!this._folderInfos.hasOwnProperty(folderId))
<a name="l03088"></a>03088       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;No such folder: &quot;</span> + folderId);
<a name="l03089"></a>03089 
<a name="l03090"></a>03090     <span class="keywordflow">if</span> (!this.universe.online) {
<a name="l03091"></a>03091       <span class="keywordflow">if</span> (callback)
<a name="l03092"></a>03092         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;offline&#39;</span>);
<a name="l03093"></a>03093       <span class="keywordflow">return</span>;
<a name="l03094"></a>03094     }
<a name="l03095"></a>03095 
<a name="l03096"></a>03096     var folderMeta = this._folderInfos[folderId].$meta;
<a name="l03097"></a>03097 
<a name="l03098"></a>03098     var rawConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l03099"></a>03099     <span class="keyword">function</span> gotConn(conn) {
<a name="l03100"></a>03100       rawConn = conn;
<a name="l03101"></a>03101       rawConn.delBox(folderMeta.path, deletionCallback);
<a name="l03102"></a>03102     }
<a name="l03103"></a>03103     <span class="keyword">function</span> deletionCallback(err) {
<a name="l03104"></a>03104       <span class="keywordflow">if</span> (err)
<a name="l03105"></a>03105         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l03106"></a>03106       <span class="keywordflow">else</span>
<a name="l03107"></a>03107         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03108"></a>03108     }
<a name="l03109"></a>03109     <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>(errString) {
<a name="l03110"></a>03110       <span class="keywordflow">if</span> (rawConn) {
<a name="l03111"></a>03111         <span class="keyword">self</span>.__folderDoneWithConnection(rawConn, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l03112"></a>03112         rawConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03113"></a>03113       }
<a name="l03114"></a>03114       <span class="keywordflow">if</span> (!errString) {
<a name="l03115"></a>03115         <span class="keyword">self</span>._LOG.deleteFolder(folderMeta.path);
<a name="l03116"></a>03116         <span class="keyword">self</span>._forgetFolder(folderId);
<a name="l03117"></a>03117       }
<a name="l03118"></a>03118       <span class="keywordflow">if</span> (callback)
<a name="l03119"></a>03119         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(errString, folderMeta);
<a name="l03120"></a>03120     }
<a name="l03121"></a>03121     this.__folderDemandsConnection(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;deleteFolder&#39;</span>, gotConn);
<a name="l03122"></a>03122   },
<a name="l03123"></a>03123 
<a name="l03124"></a>03124   getFolderStorageForFolderId: <span class="keyword">function</span>(folderId) {
<a name="l03125"></a>03125     <span class="keywordflow">if</span> (this._folderStorages.hasOwnProperty(folderId))
<a name="l03126"></a>03126       <span class="keywordflow">return</span> this._folderStorages[folderId];
<a name="l03127"></a>03127     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;No folder with id: &#39;</span> + folderId);
<a name="l03128"></a>03128   },
<a name="l03129"></a>03129 
<a name="l03130"></a>03130   getFolderStorageForMessageSuid: <span class="keyword">function</span>(messageSuid) {
<a name="l03131"></a>03131     var folderId = messageSuid.substring(0, messageSuid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>));
<a name="l03132"></a>03132     <span class="keywordflow">if</span> (this._folderStorages.hasOwnProperty(folderId))
<a name="l03133"></a>03133       <span class="keywordflow">return</span> this._folderStorages[folderId];
<a name="l03134"></a>03134     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;No folder with id: &#39;</span> + folderId);
<a name="l03135"></a>03135   },
<a name="l03136"></a>03136 
<a name="l03137"></a>03137   getFolderMetaForFolderId: <span class="keyword">function</span>(folderId) {
<a name="l03138"></a>03138     <span class="keywordflow">if</span> (this._folderInfos.hasOwnProperty(folderId))
<a name="l03139"></a>03139       <span class="keywordflow">return</span> this._folderInfos[folderId].$meta;
<a name="l03140"></a>03140     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03141"></a>03141   },
<a name="l03142"></a>03142 
<a name="l03147"></a>03147   sliceFolderMessages: <span class="keyword">function</span>(folderId, bridgeHandle) {
<a name="l03148"></a>03148     var storage = this._folderStorages[folderId],
<a name="l03149"></a>03149         <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a> = <span class="keyword">new</span> $mailslice.MailSlice(bridgeHandle, storage, this._LOG);
<a name="l03150"></a>03150 
<a name="l03151"></a>03151     storage.sliceOpenMostRecent(slice);
<a name="l03152"></a>03152   },
<a name="l03153"></a>03153 
<a name="l03154"></a>03154   searchFolderMessages: <span class="keyword">function</span>(folderId, bridgeHandle, phrase, whatToSearch) {
<a name="l03155"></a>03155     var storage = this._folderStorages[folderId],
<a name="l03156"></a>03156         slice = <span class="keyword">new</span> $searchfilter.SearchSlice(bridgeHandle, storage, phrase,
<a name="l03157"></a>03157                                               whatToSearch, this._LOG);
<a name="l03158"></a>03158     <span class="comment">// the slice is self-starting, we don&#39;t need to call anything on storage</span>
<a name="l03159"></a>03159   },
<a name="l03160"></a>03160 
<a name="l03161"></a>03161   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03162"></a>03162     <span class="comment">// - kill all folder storages (for their loggers)</span>
<a name="l03163"></a>03163     <span class="keywordflow">for</span> (var iFolder = 0; iFolder &lt; this.folders.length; iFolder++) {
<a name="l03164"></a>03164       var folderPub = this.folders[iFolder],
<a name="l03165"></a>03165           folderStorage = this._folderStorages[folderPub.id];
<a name="l03166"></a>03166       folderStorage.shutdown();
<a name="l03167"></a>03167     }
<a name="l03168"></a>03168 
<a name="l03169"></a>03169     this._backoffEndpoint.shutdown();
<a name="l03170"></a>03170 
<a name="l03171"></a>03171     <span class="comment">// - close all connections</span>
<a name="l03172"></a>03172     var liveConns = this._ownedConns.length;
<a name="l03173"></a>03173     <span class="keyword">function</span> connDead() {
<a name="l03174"></a>03174       <span class="keywordflow">if</span> (--liveConns === 0)
<a name="l03175"></a>03175         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l03176"></a>03176     }
<a name="l03177"></a>03177     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; this._ownedConns.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03178"></a>03178       var connInfo = this._ownedConns[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03179"></a>03179       <span class="keywordflow">if</span> (callback) {
<a name="l03180"></a>03180         connInfo.inUseBy = { deathback: connDead };
<a name="l03181"></a>03181         <span class="keywordflow">try</span> {
<a name="l03182"></a>03182           connInfo.conn.logout();
<a name="l03183"></a>03183         }
<a name="l03184"></a>03184         <span class="keywordflow">catch</span> (ex) {
<a name="l03185"></a>03185           liveConns--;
<a name="l03186"></a>03186         }
<a name="l03187"></a>03187       }
<a name="l03188"></a>03188       <span class="keywordflow">else</span> {
<a name="l03189"></a>03189         connInfo.conn.die();
<a name="l03190"></a>03190       }
<a name="l03191"></a>03191     }
<a name="l03192"></a>03192 
<a name="l03193"></a>03193     this._LOG.__die();
<a name="l03194"></a>03194     <span class="keywordflow">if</span> (!liveConns &amp;&amp; callback)
<a name="l03195"></a>03195       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l03196"></a>03196   },
<a name="l03197"></a>03197 
<a name="l03198"></a>03198   accountDeleted: <span class="keyword">function</span>() {
<a name="l03199"></a>03199     this._alive = <span class="keyword">false</span>;
<a name="l03200"></a>03200     this.<a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>();
<a name="l03201"></a>03201   },
<a name="l03202"></a>03202 
<a name="l03203"></a>03203   checkAccount: <span class="keyword">function</span>(listener) {
<a name="l03204"></a>03204     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l03205"></a>03205     this._makeConnection(listener, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;check&#39;</span>);
<a name="l03206"></a>03206   },
<a name="l03207"></a>03207 
<a name="l03209"></a>03209   <span class="comment">// Connection Pool-ish stuff</span>
<a name="l03210"></a>03210 
<a name="l03211"></a>03211   <span class="keyword">get</span> numActiveConns() {
<a name="l03212"></a>03212     <span class="keywordflow">return</span> this._ownedConns.length;
<a name="l03213"></a>03213   },
<a name="l03214"></a>03214 
<a name="l03253"></a>03253   __folderDemandsConnection: <span class="keyword">function</span>(folderId, label, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deathback,
<a name="l03254"></a>03254                                       dieOnConnectFailure) {
<a name="l03255"></a>03255     <span class="comment">// If we are offline, invoke the deathback soon and don&#39;t bother trying to</span>
<a name="l03256"></a>03256     <span class="comment">// get a connection.</span>
<a name="l03257"></a>03257     <span class="keywordflow">if</span> (dieOnConnectFailure &amp;&amp; !this.universe.online) {
<a name="l03258"></a>03258       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setZeroTimeout(deathback);
<a name="l03259"></a>03259       <span class="keywordflow">return</span>;
<a name="l03260"></a>03260     }
<a name="l03261"></a>03261 
<a name="l03262"></a>03262     var demand = {
<a name="l03263"></a>03263       folderId: folderId,
<a name="l03264"></a>03264       label: label,
<a name="l03265"></a>03265       callback: <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>,
<a name="l03266"></a>03266       deathback: deathback,
<a name="l03267"></a>03267       dieOnConnectFailure: Boolean(dieOnConnectFailure)
<a name="l03268"></a>03268     };
<a name="l03269"></a>03269     this._demandedConns.push(demand);
<a name="l03270"></a>03270 
<a name="l03271"></a>03271     <span class="comment">// No line-cutting; bail if there was someone ahead of us.</span>
<a name="l03272"></a>03272     <span class="keywordflow">if</span> (this._demandedConns.length &gt; 1)
<a name="l03273"></a>03273       <span class="keywordflow">return</span>;
<a name="l03274"></a>03274 
<a name="l03275"></a>03275     <span class="comment">// - try and reuse an existing connection</span>
<a name="l03276"></a>03276     <span class="keywordflow">if</span> (this._allocateExistingConnection())
<a name="l03277"></a>03277       <span class="keywordflow">return</span>;
<a name="l03278"></a>03278 
<a name="l03279"></a>03279     <span class="comment">// - we need to wait for a new conn or one to free up</span>
<a name="l03280"></a>03280     this._makeConnectionIfPossible();
<a name="l03281"></a>03281 
<a name="l03282"></a>03282     <span class="keywordflow">return</span>;
<a name="l03283"></a>03283   },
<a name="l03284"></a>03284 
<a name="l03289"></a>03289   _killDieOnConnectFailureDemands: <span class="keyword">function</span>() {
<a name="l03290"></a>03290     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; this._demandedConns.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03291"></a>03291       var demand = this._demandedConns[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03292"></a>03292       <span class="keywordflow">if</span> (demand.dieOnConnectFailure) {
<a name="l03293"></a>03293         demand.deathback.call(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03294"></a>03294         this._demandedConns.splice(<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>--, 1);
<a name="l03295"></a>03295       }
<a name="l03296"></a>03296     }
<a name="l03297"></a>03297   },
<a name="l03298"></a>03298 
<a name="l03307"></a>03307   _allocateExistingConnection: <span class="keyword">function</span>() {
<a name="l03308"></a>03308     <span class="keywordflow">if</span> (!this._demandedConns.length)
<a name="l03309"></a>03309       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03310"></a>03310     var demandInfo = this._demandedConns[0];
<a name="l03311"></a>03311 
<a name="l03312"></a>03312     var reusableConnInfo = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03313"></a>03313     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; this._ownedConns.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03314"></a>03314       var connInfo = this._ownedConns[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03315"></a>03315       <span class="comment">// It&#39;s concerning if the folder already has a connection...</span>
<a name="l03316"></a>03316       <span class="keywordflow">if</span> (demandInfo.folderId &amp;&amp; connInfo.folderId === demandInfo.folderId)
<a name="l03317"></a>03317         this._LOG.folderAlreadyHasConn(demandInfo.folderId);
<a name="l03318"></a>03318 
<a name="l03319"></a>03319       <span class="keywordflow">if</span> (connInfo.inUseBy)
<a name="l03320"></a>03320         <span class="keywordflow">continue</span>;
<a name="l03321"></a>03321 
<a name="l03322"></a>03322       connInfo.inUseBy = demandInfo;
<a name="l03323"></a>03323       this._demandedConns.shift();
<a name="l03324"></a>03324       this._LOG.reuseConnection(demandInfo.folderId, demandInfo.label);
<a name="l03325"></a>03325       demandInfo.callback(connInfo.conn);
<a name="l03326"></a>03326       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03327"></a>03327     }
<a name="l03328"></a>03328 
<a name="l03329"></a>03329     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03330"></a>03330   },
<a name="l03331"></a>03331 
<a name="l03335"></a>03335   closeUnusedConnections: <span class="keyword">function</span>() {
<a name="l03336"></a>03336     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = this._ownedConns.length - 1; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &gt;= 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>--) {
<a name="l03337"></a>03337       var connInfo = this._ownedConns[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03338"></a>03338       <span class="keywordflow">if</span> (connInfo.inUseBy)
<a name="l03339"></a>03339         <span class="keywordflow">continue</span>;
<a name="l03340"></a>03340       <span class="comment">// this eats all future notifications, so we need to splice...</span>
<a name="l03341"></a>03341       connInfo.conn.die();
<a name="l03342"></a>03342       this._ownedConns.splice(<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, 1);
<a name="l03343"></a>03343       this._LOG.deadConnection();
<a name="l03344"></a>03344     }
<a name="l03345"></a>03345   },
<a name="l03346"></a>03346 
<a name="l03347"></a>03347   _makeConnectionIfPossible: <span class="keyword">function</span>() {
<a name="l03348"></a>03348     <span class="keywordflow">if</span> (this._ownedConns.length &gt;= <span class="keyword">this</span>._maxConnsAllowed) {
<a name="l03349"></a>03349       this._LOG.maximumConnsNoNew();
<a name="l03350"></a>03350       <span class="keywordflow">return</span>;
<a name="l03351"></a>03351     }
<a name="l03352"></a>03352     <span class="keywordflow">if</span> (this._pendingConn)
<a name="l03353"></a>03353       <span class="keywordflow">return</span>;
<a name="l03354"></a>03354 
<a name="l03355"></a>03355     this._pendingConn = <span class="keyword">true</span>;
<a name="l03356"></a>03356     var boundMakeConnection = this._makeConnection.bind(<span class="keyword">this</span>);
<a name="l03357"></a>03357     this._backoffEndpoint.scheduleConnectAttempt(boundMakeConnection);
<a name="l03358"></a>03358   },
<a name="l03359"></a>03359 
<a name="l03360"></a>03360   _makeConnection: <span class="keyword">function</span>(listener, whyFolderId, whyLabel) {
<a name="l03361"></a>03361     <span class="comment">// Mark a pending connection synchronously; the require call will not return</span>
<a name="l03362"></a>03362     <span class="comment">// until at least the next turn of the event loop.</span>
<a name="l03363"></a>03363     this._pendingConn = <span class="keyword">true</span>;
<a name="l03364"></a>03364     <span class="comment">// Dynamically load the probe/imap code to speed up startup.</span>
<a name="l03365"></a>03365     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;imap&#39;</span>, <span class="stringliteral">&#39;./probe&#39;</span>], <span class="keyword">function</span> ($imap, $imapprobe) {
<a name="l03366"></a>03366       this._LOG.createConnection(whyFolderId, whyLabel);
<a name="l03367"></a>03367       var opts = {
<a name="l03368"></a>03368         host: this._connInfo.hostname,
<a name="l03369"></a>03369         <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: this._connInfo.port,
<a name="l03370"></a>03370         crypto: this._connInfo.crypto,
<a name="l03371"></a>03371 
<a name="l03372"></a>03372         username: this._credentials.username,
<a name="l03373"></a>03373         password: this._credentials.password,
<a name="l03374"></a>03374 
<a name="l03375"></a>03375         blacklistedCapabilities: this._connInfo.blacklistedCapabilities,
<a name="l03376"></a>03376       };
<a name="l03377"></a>03377       <span class="keywordflow">if</span> (this._LOG) opts._logParent = this._LOG;
<a name="l03378"></a>03378       var conn = this._pendingConn = <span class="keyword">new</span> $imap.ImapConnection(opts);
<a name="l03379"></a>03379       var connectCallbackTriggered = <span class="keyword">false</span>;
<a name="l03380"></a>03380       <span class="comment">// The login callback should get invoked in all cases, but a recent code</span>
<a name="l03381"></a>03381       <span class="comment">// inspection for the prober suggested that there may be some cases where</span>
<a name="l03382"></a>03382       <span class="comment">// things might fall-through, so let&#39;s just convert them.  We need some</span>
<a name="l03383"></a>03383       <span class="comment">// type of handler since imap.js currently calls the login callback and</span>
<a name="l03384"></a>03384       <span class="comment">// then the &#39;error&#39; handler, generating an error if there is no error</span>
<a name="l03385"></a>03385       <span class="comment">// handler.</span>
<a name="l03386"></a>03386       conn.on(<span class="stringliteral">&#39;error&#39;</span>, <span class="keyword">function</span>(err) {
<a name="l03387"></a>03387         <span class="keywordflow">if</span> (!connectCallbackTriggered)
<a name="l03388"></a>03388           loginCb(err);
<a name="l03389"></a>03389       });
<a name="l03390"></a>03390       var loginCb;
<a name="l03391"></a>03391       conn.connect(loginCb = <span class="keyword">function</span>(err) {
<a name="l03392"></a>03392         connectCallbackTriggered = <span class="keyword">true</span>;
<a name="l03393"></a>03393         this._pendingConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03394"></a>03394         <span class="keywordflow">if</span> (err) {
<a name="l03395"></a>03395           var normErr = $imapprobe.normalizeError(err);
<a name="l03396"></a>03396           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Connect error:&#39;</span>, normErr.name, <span class="stringliteral">&#39;formal:&#39;</span>, err, <span class="stringliteral">&#39;on&#39;</span>,
<a name="l03397"></a>03397                         <span class="keyword">this</span>._connInfo.hostname, <span class="keyword">this</span>._connInfo.port);
<a name="l03398"></a>03398           <span class="keywordflow">if</span> (normErr.reportProblem)
<a name="l03399"></a>03399             this.universe.__reportAccountProblem(this.compositeAccount,
<a name="l03400"></a>03400                                                  normErr.name);
<a name="l03401"></a>03401 
<a name="l03402"></a>03402 
<a name="l03403"></a>03403           <span class="keywordflow">if</span> (listener)
<a name="l03404"></a>03404             listener(normErr.name);
<a name="l03405"></a>03405           conn.die();
<a name="l03406"></a>03406 
<a name="l03407"></a>03407           <span class="comment">// track this failure for backoff purposes</span>
<a name="l03408"></a>03408           <span class="keywordflow">if</span> (normErr.retry) {
<a name="l03409"></a>03409             <span class="keywordflow">if</span> (this._backoffEndpoint.noteConnectFailureMaybeRetry(
<a name="l03410"></a>03410                                         normErr.reachable))
<a name="l03411"></a>03411               this._makeConnectionIfPossible();
<a name="l03412"></a>03412             <span class="keywordflow">else</span>
<a name="l03413"></a>03413               this._killDieOnConnectFailureDemands();
<a name="l03414"></a>03414           }
<a name="l03415"></a>03415           <span class="keywordflow">else</span> {
<a name="l03416"></a>03416             this._backoffEndpoint.noteBrokenConnection();
<a name="l03417"></a>03417             this._killDieOnConnectFailureDemands();
<a name="l03418"></a>03418           }
<a name="l03419"></a>03419         }
<a name="l03420"></a>03420         <span class="keywordflow">else</span> {
<a name="l03421"></a>03421           this._bindConnectionDeathHandlers(conn);
<a name="l03422"></a>03422           this._backoffEndpoint.noteConnectSuccess();
<a name="l03423"></a>03423           this._ownedConns.push({
<a name="l03424"></a>03424             conn: conn,
<a name="l03425"></a>03425             inUseBy: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03426"></a>03426           });
<a name="l03427"></a>03427           this._allocateExistingConnection();
<a name="l03428"></a>03428           <span class="keywordflow">if</span> (listener)
<a name="l03429"></a>03429             listener(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03430"></a>03430           <span class="comment">// Keep opening connections if there is more work to do</span>
<a name="l03431"></a>03431           <span class="comment">// (and possible).</span>
<a name="l03432"></a>03432           <span class="keywordflow">if</span> (this._demandedConns.length)
<a name="l03433"></a>03433             this._makeConnectionIfPossible();
<a name="l03434"></a>03434         }
<a name="l03435"></a>03435       }.bind(<span class="keyword">this</span>));
<a name="l03436"></a>03436     }.bind(<span class="keyword">this</span>));
<a name="l03437"></a>03437   },
<a name="l03438"></a>03438 
<a name="l03443"></a>03443   _reuseConnection: <span class="keyword">function</span>(existingProtoConn) {
<a name="l03444"></a>03444     <span class="comment">// We don&#39;t want the probe being kept alive and we certainly don&#39;t need its</span>
<a name="l03445"></a>03445     <span class="comment">// listeners.</span>
<a name="l03446"></a>03446     existingProtoConn.removeAllListeners();
<a name="l03447"></a>03447     this._ownedConns.push({
<a name="l03448"></a>03448         conn: existingProtoConn,
<a name="l03449"></a>03449         inUseBy: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03450"></a>03450       });
<a name="l03451"></a>03451     this._bindConnectionDeathHandlers(existingProtoConn);
<a name="l03452"></a>03452   },
<a name="l03453"></a>03453 
<a name="l03454"></a>03454   _bindConnectionDeathHandlers: <span class="keyword">function</span>(conn) {
<a name="l03455"></a>03455     <span class="comment">// on close, stop tracking the connection in our list of live connections</span>
<a name="l03456"></a>03456     conn.on(<span class="stringliteral">&#39;close&#39;</span>, <span class="keyword">function</span>() {
<a name="l03457"></a>03457       <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; this._ownedConns.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03458"></a>03458         var connInfo = this._ownedConns[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03459"></a>03459         <span class="keywordflow">if</span> (connInfo.conn === conn) {
<a name="l03460"></a>03460           <span class="keyword">this</span>._LOG.deadConnection(connInfo.inUseBy &amp;&amp;
<a name="l03461"></a>03461                                    connInfo.inUseBy.folderId);
<a name="l03462"></a>03462           <span class="keywordflow">if</span> (connInfo.inUseBy &amp;&amp; connInfo.inUseBy.deathback)
<a name="l03463"></a>03463             connInfo.inUseBy.deathback(conn);
<a name="l03464"></a>03464           connInfo.inUseBy = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03465"></a>03465           this._ownedConns.splice(<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, 1);
<a name="l03466"></a>03466           <span class="keywordflow">return</span>;
<a name="l03467"></a>03467         }
<a name="l03468"></a>03468       }
<a name="l03469"></a>03469       this._LOG.unknownDeadConnection();
<a name="l03470"></a>03470     }.bind(<span class="keyword">this</span>));
<a name="l03471"></a>03471     conn.on(<span class="stringliteral">&#39;error&#39;</span>, <span class="keyword">function</span>(err) {
<a name="l03472"></a>03472       this._LOG.connectionError(err);
<a name="l03473"></a>03473       <span class="comment">// this hears about connection errors too</span>
<a name="l03474"></a>03474       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;Conn steady error:&#39;</span>, err, <span class="stringliteral">&#39;on&#39;</span>,
<a name="l03475"></a>03475                    this._connInfo.hostname, <span class="keyword">this</span>._connInfo.port);
<a name="l03476"></a>03476     }.bind(<span class="keyword">this</span>));
<a name="l03477"></a>03477   },
<a name="l03478"></a>03478 
<a name="l03479"></a>03479   __folderDoneWithConnection: <span class="keyword">function</span>(conn, closeFolder, resourceProblem) {
<a name="l03480"></a>03480     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; this._ownedConns.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03481"></a>03481       var connInfo = this._ownedConns[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03482"></a>03482       <span class="keywordflow">if</span> (connInfo.conn === conn) {
<a name="l03483"></a>03483         <span class="keywordflow">if</span> (resourceProblem)
<a name="l03484"></a>03484           this._backoffEndpoint(connInfo.inUseBy.folderId);
<a name="l03485"></a>03485         this._LOG.releaseConnection(connInfo.inUseBy.folderId,
<a name="l03486"></a>03486                                     connInfo.inUseBy.label);
<a name="l03487"></a>03487         connInfo.inUseBy = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03488"></a>03488         <span class="comment">// (this will trigger an expunge if not read-only...)</span>
<a name="l03489"></a>03489         <span class="keywordflow">if</span> (closeFolder &amp;&amp; !resourceProblem &amp;&amp; !this._TEST_doNotCloseFolder)
<a name="l03490"></a>03490           conn.closeBox(<span class="keyword">function</span>() {});
<a name="l03491"></a>03491         <span class="keywordflow">return</span>;
<a name="l03492"></a>03492       }
<a name="l03493"></a>03493     }
<a name="l03494"></a>03494     this._LOG.connectionMismatch();
<a name="l03495"></a>03495   },
<a name="l03496"></a>03496 
<a name="l03500"></a>03500   onEndpointStateChange: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>) {
<a name="l03501"></a>03501     <span class="keywordflow">switch</span> (state) {
<a name="l03502"></a>03502       <span class="keywordflow">case</span> <span class="stringliteral">&#39;healthy&#39;</span>:
<a name="l03503"></a>03503         this.universe.__removeAccountProblem(this.compositeAccount,
<a name="l03504"></a>03504                                              <span class="stringliteral">&#39;connection&#39;</span>);
<a name="l03505"></a>03505         <span class="keywordflow">break</span>;
<a name="l03506"></a>03506       <span class="keywordflow">case</span> <span class="stringliteral">&#39;unreachable&#39;</span>:
<a name="l03507"></a>03507       <span class="keywordflow">case</span> <span class="stringliteral">&#39;broken&#39;</span>:
<a name="l03508"></a>03508         this.universe.__reportAccountProblem(this.compositeAccount,
<a name="l03509"></a>03509                                              <span class="stringliteral">&#39;connection&#39;</span>);
<a name="l03510"></a>03510         <span class="keywordflow">break</span>;
<a name="l03511"></a>03511     }
<a name="l03512"></a>03512   },
<a name="l03513"></a>03513 
<a name="l03515"></a>03515   <span class="comment">// Folder synchronization</span>
<a name="l03516"></a>03516 
<a name="l03522"></a>03522   _syncFolderList: <span class="keyword">function</span>(conn, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03523"></a>03523     conn.getBoxes(this._syncFolderComputeDeltas.bind(<span class="keyword">this</span>, conn, callback));
<a name="l03524"></a>03524   },
<a name="l03525"></a>03525   _determineFolderType: <span class="keyword">function</span>(box, <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>, conn) {
<a name="l03526"></a>03526     var type = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03527"></a>03527     <span class="comment">// NoSelect trumps everything.</span>
<a name="l03528"></a>03528     <span class="keywordflow">if</span> (box.attribs.indexOf(<span class="stringliteral">&#39;NOSELECT&#39;</span>) !== -1) {
<a name="l03529"></a>03529       type = <span class="stringliteral">&#39;nomail&#39;</span>;
<a name="l03530"></a>03530     }
<a name="l03531"></a>03531     <span class="keywordflow">else</span> {
<a name="l03532"></a>03532       <span class="comment">// Standards-ish:</span>
<a name="l03533"></a>03533       <span class="comment">// - special-use: http://tools.ietf.org/html/rfc6154</span>
<a name="l03534"></a>03534       <span class="comment">//   IANA registrations:</span>
<a name="l03535"></a>03535       <span class="comment">//   http://www.iana.org/assignments/imap4-list-extended</span>
<a name="l03536"></a>03536       <span class="comment">// - xlist:</span>
<a name="l03537"></a>03537       <span class="comment">//   https://developers.google.com/google-apps/gmail/imap_extensions</span>
<a name="l03538"></a>03538 
<a name="l03539"></a>03539       <span class="comment">// Process the attribs for goodness.</span>
<a name="l03540"></a>03540       <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; box.attribs.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03541"></a>03541         <span class="keywordflow">switch</span> (box.attribs[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]) {
<a name="l03542"></a>03542           <span class="comment">// TODO: split the &#39;all&#39; cases into their own type!</span>
<a name="l03543"></a>03543           <span class="keywordflow">case</span> <span class="stringliteral">&#39;ALL&#39;</span>: <span class="comment">// special-use</span>
<a name="l03544"></a>03544           <span class="keywordflow">case</span> <span class="stringliteral">&#39;ALLMAIL&#39;</span>: <span class="comment">// xlist</span>
<a name="l03545"></a>03545           <span class="keywordflow">case</span> <span class="stringliteral">&#39;ARCHIVE&#39;</span>: <span class="comment">// special-use</span>
<a name="l03546"></a>03546             type = <span class="stringliteral">&#39;archive&#39;</span>;
<a name="l03547"></a>03547             <span class="keywordflow">break</span>;
<a name="l03548"></a>03548           <span class="keywordflow">case</span> <span class="stringliteral">&#39;DRAFTS&#39;</span>: <span class="comment">// special-use xlist</span>
<a name="l03549"></a>03549             type = <span class="stringliteral">&#39;drafts&#39;</span>;
<a name="l03550"></a>03550             <span class="keywordflow">break</span>;
<a name="l03551"></a>03551           <span class="keywordflow">case</span> <span class="stringliteral">&#39;FLAGGED&#39;</span>: <span class="comment">// special-use</span>
<a name="l03552"></a>03552             type = <span class="stringliteral">&#39;starred&#39;</span>;
<a name="l03553"></a>03553             <span class="keywordflow">break</span>;
<a name="l03554"></a>03554           <span class="keywordflow">case</span> <span class="stringliteral">&#39;IMPORTANT&#39;</span>: <span class="comment">// (undocumented) xlist</span>
<a name="l03555"></a>03555             type = <span class="stringliteral">&#39;important&#39;</span>;
<a name="l03556"></a>03556             <span class="keywordflow">break</span>;
<a name="l03557"></a>03557           <span class="keywordflow">case</span> <span class="stringliteral">&#39;INBOX&#39;</span>: <span class="comment">// xlist</span>
<a name="l03558"></a>03558             type = <span class="stringliteral">&#39;inbox&#39;</span>;
<a name="l03559"></a>03559             <span class="keywordflow">break</span>;
<a name="l03560"></a>03560           <span class="keywordflow">case</span> <span class="stringliteral">&#39;JUNK&#39;</span>: <span class="comment">// special-use</span>
<a name="l03561"></a>03561             type = <span class="stringliteral">&#39;junk&#39;</span>;
<a name="l03562"></a>03562             <span class="keywordflow">break</span>;
<a name="l03563"></a>03563           <span class="keywordflow">case</span> <span class="stringliteral">&#39;SENT&#39;</span>: <span class="comment">// special-use xlist</span>
<a name="l03564"></a>03564             type = <span class="stringliteral">&#39;sent&#39;</span>;
<a name="l03565"></a>03565             <span class="keywordflow">break</span>;
<a name="l03566"></a>03566           <span class="keywordflow">case</span> <span class="stringliteral">&#39;SPAM&#39;</span>: <span class="comment">// xlist</span>
<a name="l03567"></a>03567             type = <span class="stringliteral">&#39;junk&#39;</span>;
<a name="l03568"></a>03568             <span class="keywordflow">break</span>;
<a name="l03569"></a>03569           <span class="keywordflow">case</span> <span class="stringliteral">&#39;STARRED&#39;</span>: <span class="comment">// xlist</span>
<a name="l03570"></a>03570             type = <span class="stringliteral">&#39;starred&#39;</span>;
<a name="l03571"></a>03571             <span class="keywordflow">break</span>;
<a name="l03572"></a>03572 
<a name="l03573"></a>03573           <span class="keywordflow">case</span> <span class="stringliteral">&#39;TRASH&#39;</span>: <span class="comment">// special-use xlist</span>
<a name="l03574"></a>03574             type = <span class="stringliteral">&#39;trash&#39;</span>;
<a name="l03575"></a>03575             <span class="keywordflow">break</span>;
<a name="l03576"></a>03576 
<a name="l03577"></a>03577           <span class="keywordflow">case</span> <span class="stringliteral">&#39;HASCHILDREN&#39;</span>: <span class="comment">// 3348</span>
<a name="l03578"></a>03578           <span class="keywordflow">case</span> <span class="stringliteral">&#39;HASNOCHILDREN&#39;</span>: <span class="comment">// 3348</span>
<a name="l03579"></a>03579 
<a name="l03580"></a>03580           <span class="comment">// - standard bits we don&#39;t care about</span>
<a name="l03581"></a>03581           <span class="keywordflow">case</span> <span class="stringliteral">&#39;MARKED&#39;</span>: <span class="comment">// 3501</span>
<a name="l03582"></a>03582           <span class="keywordflow">case</span> <span class="stringliteral">&#39;UNMARKED&#39;</span>: <span class="comment">// 3501</span>
<a name="l03583"></a>03583           <span class="keywordflow">case</span> <span class="stringliteral">&#39;NOINFERIORS&#39;</span>: <span class="comment">// 3501</span>
<a name="l03584"></a>03584             <span class="comment">// XXX use noinferiors to prohibit folder creation under it.</span>
<a name="l03585"></a>03585           <span class="comment">// NOSELECT</span>
<a name="l03586"></a>03586 
<a name="l03587"></a>03587           <span class="keywordflow">default</span>:
<a name="l03588"></a>03588         }
<a name="l03589"></a>03589       }
<a name="l03590"></a>03590 
<a name="l03591"></a>03591       <span class="comment">// heuristic based type assignment based on the name</span>
<a name="l03592"></a>03592       <span class="keywordflow">if</span> (!type) {
<a name="l03593"></a>03593         <span class="comment">// ensure that we treat folders at the root, see bug 854128</span>
<a name="l03594"></a>03594         var personalNS = conn.namespaces.personal;
<a name="l03595"></a>03595         var <a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a> = personalNS.length ? personalNS[0].prefix : <span class="stringliteral">&#39;&#39;</span>;
<a name="l03596"></a>03596         var isAtNamespaceRoot = path === (prefix + box.displayName);
<a name="l03597"></a>03597         <span class="comment">// If our name is our path, we are at the absolute root of the tree.</span>
<a name="l03598"></a>03598         <span class="comment">// This will be the case for INBOX even if there is a namespace.</span>
<a name="l03599"></a>03599         <span class="keywordflow">if</span> (isAtNamespaceRoot || path === box.displayName) {
<a name="l03600"></a>03600           <span class="keywordflow">switch</span> (box.displayName.toUpperCase()) {
<a name="l03601"></a>03601             <span class="keywordflow">case</span> <span class="stringliteral">&#39;DRAFT&#39;</span>:
<a name="l03602"></a>03602             <span class="keywordflow">case</span> <span class="stringliteral">&#39;DRAFTS&#39;</span>:
<a name="l03603"></a>03603               type = <span class="stringliteral">&#39;drafts&#39;</span>;
<a name="l03604"></a>03604               <span class="keywordflow">break</span>;
<a name="l03605"></a>03605             <span class="keywordflow">case</span> <span class="stringliteral">&#39;INBOX&#39;</span>:
<a name="l03606"></a>03606               <span class="comment">// Inbox is special; the path needs to case-insensitively match.</span>
<a name="l03607"></a>03607               <span class="keywordflow">if</span> (path.toUpperCase() === <span class="stringliteral">&#39;INBOX&#39;</span>)
<a name="l03608"></a>03608                 type = <span class="stringliteral">&#39;inbox&#39;</span>;
<a name="l03609"></a>03609               <span class="keywordflow">break</span>;
<a name="l03610"></a>03610             <span class="comment">// Yahoo provides &quot;Bulk Mail&quot; for yahoo.fr.</span>
<a name="l03611"></a>03611             <span class="keywordflow">case</span> <span class="stringliteral">&#39;BULK MAIL&#39;</span>:
<a name="l03612"></a>03612             <span class="keywordflow">case</span> <span class="stringliteral">&#39;JUNK&#39;</span>:
<a name="l03613"></a>03613             <span class="keywordflow">case</span> <span class="stringliteral">&#39;SPAM&#39;</span>:
<a name="l03614"></a>03614               type = <span class="stringliteral">&#39;junk&#39;</span>;
<a name="l03615"></a>03615               <span class="keywordflow">break</span>;
<a name="l03616"></a>03616             <span class="keywordflow">case</span> <span class="stringliteral">&#39;SENT&#39;</span>:
<a name="l03617"></a>03617               type = <span class="stringliteral">&#39;sent&#39;</span>;
<a name="l03618"></a>03618               <span class="keywordflow">break</span>;
<a name="l03619"></a>03619             <span class="keywordflow">case</span> <span class="stringliteral">&#39;TRASH&#39;</span>:
<a name="l03620"></a>03620               type = <span class="stringliteral">&#39;trash&#39;</span>;
<a name="l03621"></a>03621               <span class="keywordflow">break</span>;
<a name="l03622"></a>03622             <span class="comment">// This currently only exists for consistency with Thunderbird, but</span>
<a name="l03623"></a>03623             <span class="comment">// may become useful in the future when we need an outbox.</span>
<a name="l03624"></a>03624             <span class="keywordflow">case</span> <span class="stringliteral">&#39;UNSENT MESSAGES&#39;</span>:
<a name="l03625"></a>03625               type = <span class="stringliteral">&#39;queue&#39;</span>;
<a name="l03626"></a>03626               <span class="keywordflow">break</span>;
<a name="l03627"></a>03627           }
<a name="l03628"></a>03628     }
<a name="l03629"></a>03629       }
<a name="l03630"></a>03630 
<a name="l03631"></a>03631       <span class="keywordflow">if</span> (!type)
<a name="l03632"></a>03632         type = <span class="stringliteral">&#39;normal&#39;</span>;
<a name="l03633"></a>03633     }
<a name="l03634"></a>03634     <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>;
<a name="l03635"></a>03635   },
<a name="l03636"></a>03636   _syncFolderComputeDeltas: <span class="keyword">function</span>(conn, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, err, boxesRoot) {
<a name="l03637"></a>03637     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l03638"></a>03638     <span class="keywordflow">if</span> (err) {
<a name="l03639"></a>03639       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(err);
<a name="l03640"></a>03640       <span class="keywordflow">return</span>;
<a name="l03641"></a>03641     }
<a name="l03642"></a>03642 
<a name="l03643"></a>03643     <span class="comment">// - build a map of known existing folders</span>
<a name="l03644"></a>03644     var folderPubsByPath = {};
<a name="l03645"></a>03645     var folderPub;
<a name="l03646"></a>03646     <span class="keywordflow">for</span> (var iFolder = 0; iFolder &lt; this.folders.length; iFolder++) {
<a name="l03647"></a>03647       folderPub = this.folders[iFolder];
<a name="l03648"></a>03648       folderPubsByPath[folderPub.path] = folderPub;
<a name="l03649"></a>03649     }
<a name="l03650"></a>03650 
<a name="l03651"></a>03651     <span class="comment">// - walk the boxes</span>
<a name="l03652"></a>03652     <span class="keyword">function</span> walkBoxes(boxLevel, pathSoFar, pathDepth, parentId) {
<a name="l03653"></a>03653       <span class="keywordflow">for</span> (var boxName in boxLevel) {
<a name="l03654"></a>03654         var box = boxLevel[boxName], meta,
<a name="l03655"></a>03655             path = pathSoFar ? (pathSoFar + boxName) : boxName,
<a name="l03656"></a>03656             folderId;
<a name="l03657"></a>03657 
<a name="l03658"></a>03658         <span class="comment">// - normalize jerk-moves</span>
<a name="l03659"></a>03659         var type = <span class="keyword">self</span>._determineFolderType(box, path, conn);
<a name="l03660"></a>03660         <span class="comment">// gmail finds it amusing to give us the localized name/path of its</span>
<a name="l03661"></a>03661         <span class="comment">// inbox, but still expects us to ask for it as INBOX.</span>
<a name="l03662"></a>03662         <span class="keywordflow">if</span> (type === <span class="stringliteral">&#39;inbox&#39;</span>)
<a name="l03663"></a>03663           path = <span class="stringliteral">&#39;INBOX&#39;</span>;
<a name="l03664"></a>03664 
<a name="l03665"></a>03665         <span class="comment">// - already known folder</span>
<a name="l03666"></a>03666         <span class="keywordflow">if</span> (folderPubsByPath.hasOwnProperty(path)) {
<a name="l03667"></a>03667           <span class="comment">// Because we speculatively create the Inbox, both its display name</span>
<a name="l03668"></a>03668           <span class="comment">// and delimiter may be incorrect and need to be updated.</span>
<a name="l03669"></a>03669           meta = folderPubsByPath[<a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>];
<a name="l03670"></a>03670           meta.name = box.displayName;
<a name="l03671"></a>03671           meta.delim = box.delim;
<a name="l03672"></a>03672 
<a name="l03673"></a>03673           <span class="comment">// mark it with true to show that we&#39;ve seen it.</span>
<a name="l03674"></a>03674           folderPubsByPath[<a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>] = <span class="keyword">true</span>;
<a name="l03675"></a>03675         }
<a name="l03676"></a>03676         <span class="comment">// - new to us!</span>
<a name="l03677"></a>03677         <span class="keywordflow">else</span> {
<a name="l03678"></a>03678           meta = <span class="keyword">self</span>._learnAboutFolder(box.displayName, path, parentId, type,
<a name="l03679"></a>03679                                         box.delim, pathDepth);
<a name="l03680"></a>03680         }
<a name="l03681"></a>03681 
<a name="l03682"></a>03682         <span class="keywordflow">if</span> (box.children)
<a name="l03683"></a>03683           walkBoxes(box.children, pathSoFar + boxName + box.delim,
<a name="l03684"></a>03684                     pathDepth + 1, meta.id);
<a name="l03685"></a>03685       }
<a name="l03686"></a>03686     }
<a name="l03687"></a>03687     walkBoxes(boxesRoot, <span class="stringliteral">&#39;&#39;</span>, 0, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03688"></a>03688 
<a name="l03689"></a>03689     <span class="comment">// - detect deleted folders</span>
<a name="l03690"></a>03690     <span class="comment">// track dead folder id&#39;s so we can issue a</span>
<a name="l03691"></a>03691     var deadFolderIds = [];
<a name="l03692"></a>03692     <span class="keywordflow">for</span> (var folderPath in folderPubsByPath) {
<a name="l03693"></a>03693       folderPub = folderPubsByPath[folderPath];
<a name="l03694"></a>03694       <span class="comment">// (skip those we found above)</span>
<a name="l03695"></a>03695       <span class="keywordflow">if</span> (folderPub === <span class="keyword">true</span>)
<a name="l03696"></a>03696         <span class="keywordflow">continue</span>;
<a name="l03697"></a>03697       <span class="comment">// Never delete our localdrafts folder.</span>
<a name="l03698"></a>03698       <span class="keywordflow">if</span> (folderPub.type === <span class="stringliteral">&#39;localdrafts&#39;</span>)
<a name="l03699"></a>03699         <span class="keywordflow">continue</span>;
<a name="l03700"></a>03700       <span class="comment">// It must have gotten deleted!</span>
<a name="l03701"></a>03701       this._forgetFolder(folderPub.id);
<a name="l03702"></a>03702     }
<a name="l03703"></a>03703 
<a name="l03704"></a>03704     <span class="comment">// Add a localdrafts folder if we don&#39;t have one.</span>
<a name="l03705"></a>03705     var localDrafts = this.getFirstFolderWithType(<span class="stringliteral">&#39;localdrafts&#39;</span>);
<a name="l03706"></a>03706     <span class="keywordflow">if</span> (!localDrafts) {
<a name="l03707"></a>03707       <span class="comment">// Try and add the folder next to the existing drafts folder, or the</span>
<a name="l03708"></a>03708       <span class="comment">// sent folder if there is no drafts folder.  Otherwise we must have an</span>
<a name="l03709"></a>03709       <span class="comment">// inbox and we want to live under that.</span>
<a name="l03710"></a>03710       var sibling = this.getFirstFolderWithType(<span class="stringliteral">&#39;drafts&#39;</span>) ||
<a name="l03711"></a>03711                     this.getFirstFolderWithType(<span class="stringliteral">&#39;sent&#39;</span>);
<a name="l03712"></a>03712       var parentId = sibling ? sibling.parentId
<a name="l03713"></a>03713                              : this.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>).id;
<a name="l03714"></a>03714       <span class="comment">// parentId will be null if we are already top-level</span>
<a name="l03715"></a>03715       var parentFolder;
<a name="l03716"></a>03716       <span class="keywordflow">if</span> (parentId) {
<a name="l03717"></a>03717         parentFolder = this._folderInfos[parentId].$meta;
<a name="l03718"></a>03718       }
<a name="l03719"></a>03719       <span class="keywordflow">else</span> {
<a name="l03720"></a>03720         parentFolder = {
<a name="l03721"></a>03721           path: <span class="stringliteral">&#39;&#39;</span>, delim: <span class="stringliteral">&#39;&#39;</span>, depth: -1
<a name="l03722"></a>03722         };
<a name="l03723"></a>03723       }
<a name="l03724"></a>03724       var localDraftPath = parentFolder.path + parentFolder.delim +
<a name="l03725"></a>03725             <span class="stringliteral">&#39;localdrafts&#39;</span>;
<a name="l03726"></a>03726       <span class="comment">// Since this is a synthetic folder; we just directly choose the name</span>
<a name="l03727"></a>03727       <span class="comment">// that our l10n mapping will transform.</span>
<a name="l03728"></a>03728       this._learnAboutFolder(<span class="stringliteral">&#39;localdrafts&#39;</span>, localDraftPath,  parentId,
<a name="l03729"></a>03729                              <span class="stringliteral">&#39;localdrafts&#39;</span>, parentFolder.delim,
<a name="l03730"></a>03730                              parentFolder.depth + 1);
<a name="l03731"></a>03731     }
<a name="l03732"></a>03732 
<a name="l03733"></a>03733     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03734"></a>03734   },
<a name="l03735"></a>03735 
<a name="l03743"></a>03743   ensureEssentialFolders: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03744"></a>03744     var trashFolder = this.getFirstFolderWithType(<span class="stringliteral">&#39;trash&#39;</span>),
<a name="l03745"></a>03745         sentFolder = this.getFirstFolderWithType(<span class="stringliteral">&#39;sent&#39;</span>);
<a name="l03746"></a>03746 
<a name="l03747"></a>03747     <span class="keywordflow">if</span> (trashFolder &amp;&amp; sentFolder) {
<a name="l03748"></a>03748       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03749"></a>03749       <span class="keywordflow">return</span>;
<a name="l03750"></a>03750     }
<a name="l03751"></a>03751 
<a name="l03752"></a>03752     var callbacks = allbackMaker(
<a name="l03753"></a>03753       [<span class="stringliteral">&#39;sent&#39;</span>, <span class="stringliteral">&#39;trash&#39;</span>],
<a name="l03754"></a>03754       <span class="keyword">function</span> foldersCreated(<a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>) {
<a name="l03755"></a>03755         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03756"></a>03756       });
<a name="l03757"></a>03757 
<a name="l03758"></a>03758     <span class="keywordflow">if</span> (!sentFolder)
<a name="l03759"></a>03759       this.universe.createFolder(this.<span class="keywordtype">id</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;Sent&#39;</span>, <span class="keyword">false</span>);
<a name="l03760"></a>03760     <span class="keywordflow">else</span>
<a name="l03761"></a>03761       callbacks.sent(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03762"></a>03762 
<a name="l03763"></a>03763     <span class="keywordflow">if</span> (!trashFolder)
<a name="l03764"></a>03764       this.universe.createFolder(this.<span class="keywordtype">id</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;Trash&#39;</span>, <span class="keyword">false</span>);
<a name="l03765"></a>03765     <span class="keywordflow">else</span>
<a name="l03766"></a>03766       callbacks.trash(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03767"></a>03767   },
<a name="l03768"></a>03768 
<a name="l03769"></a>03769   scheduleMessagePurge: <span class="keyword">function</span>(folderId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03770"></a>03770     this.universe.purgeExcessMessages(this.compositeAccount, folderId,
<a name="l03771"></a>03771                                       callback);
<a name="l03772"></a>03772   },
<a name="l03773"></a>03773 
<a name="l03775"></a>03775 
<a name="l03776"></a>03776   runOp: $acctmixins.runOp,
<a name="l03777"></a>03777   getFirstFolderWithType: $acctmixins.getFirstFolderWithType,
<a name="l03778"></a>03778   getFolderByPath: $acctmixins.getFolderByPath,
<a name="l03779"></a>03779   saveAccountState: $acctmixins.saveAccountState,
<a name="l03780"></a>03780   runAfterSaves: $acctmixins.runAfterSaves
<a name="l03781"></a>03781 };
<a name="l03782"></a>03782 
<a name="l03787"></a>03787 <span class="keyword">function</span> GmailAccount() {
<a name="l03788"></a>03788 }
<a name="l03789"></a>03789 GmailAccount.prototype = {
<a name="l03790"></a>03790   type: <span class="stringliteral">&#39;gmail-imap&#39;</span>,
<a name="l03791"></a>03791 
<a name="l03792"></a>03792 };
<a name="l03793"></a>03793 
<a name="l03794"></a>03794 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l03795"></a>03795   ImapAccount: {
<a name="l03796"></a>03796     type: $log.ACCOUNT,
<a name="l03797"></a>03797     events: {
<a name="l03798"></a>03798       createFolder: {},
<a name="l03799"></a>03799       <a class="code" href="../../df/d99/namespacevariant.html#ab05c7931468d628f4294600987d629f2">deleteFolder</a>: {},
<a name="l03800"></a>03800       recreateFolder: { <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l03801"></a>03801 
<a name="l03802"></a>03802       createConnection: {},
<a name="l03803"></a>03803       reuseConnection: {},
<a name="l03804"></a>03804       releaseConnection: {},
<a name="l03805"></a>03805       deadConnection: {},
<a name="l03806"></a>03806       unknownDeadConnection: {},
<a name="l03807"></a>03807       connectionMismatch: {},
<a name="l03808"></a>03808 
<a name="l03809"></a>03809       saveAccountState: { <a class="code" href="../../da/dd0/ns_i_d_o_m_close_event_8idl.html#aa538b14c961e4162ded76940b8f37507">reason</a>: <span class="keyword">false</span> },
<a name="l03814"></a>03814       accountDeleted: { where: <span class="keyword">false</span> },
<a name="l03815"></a>03815 
<a name="l03820"></a>03820       maximumConnsNoNew: {},
<a name="l03821"></a>03821     },
<a name="l03822"></a>03822     TEST_ONLY_events: {
<a name="l03823"></a>03823       <a class="code" href="../../df/d99/namespacevariant.html#ab05c7931468d628f4294600987d629f2">deleteFolder</a>: { path: <span class="keyword">false</span> },
<a name="l03824"></a>03824 
<a name="l03825"></a>03825       createConnection: { folderId: <span class="keyword">false</span>, label: <span class="keyword">false</span> },
<a name="l03826"></a>03826       reuseConnection: { folderId: <span class="keyword">false</span>, label: <span class="keyword">false</span> },
<a name="l03827"></a>03827       releaseConnection: { folderId: <span class="keyword">false</span>, label: <span class="keyword">false</span> },
<a name="l03828"></a>03828       deadConnection: { folderId: <span class="keyword">false</span> },
<a name="l03829"></a>03829       connectionMismatch: {},
<a name="l03830"></a>03830     },
<a name="l03831"></a>03831     errors: {
<a name="l03832"></a>03832       connectionError: {},
<a name="l03833"></a>03833       folderAlreadyHasConn: { folderId: <span class="keyword">false</span> },
<a name="l03834"></a>03834       opError: { <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>: <span class="keyword">false</span>, type: <span class="keyword">false</span>, ex: $log.EXCEPTION },
<a name="l03835"></a>03835     },
<a name="l03836"></a>03836     asyncJobs: {
<a name="l03837"></a>03837       runOp: { <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>: <span class="keyword">true</span>, type: <span class="keyword">true</span>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>: <span class="keyword">false</span>, op: <span class="keyword">false</span> },
<a name="l03838"></a>03838     },
<a name="l03839"></a>03839     TEST_ONLY_asyncJobs: {
<a name="l03840"></a>03840     },
<a name="l03841"></a>03841   },
<a name="l03842"></a>03842 });
<a name="l03843"></a>03843 
<a name="l03844"></a>03844 }); <span class="comment">// end define</span>
<a name="l03845"></a>03845 ;
<a name="l03850"></a>03850 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/smtp/account&#39;</span>,
<a name="l03851"></a>03851   [
<a name="l03852"></a>03852     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l03853"></a>03853     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l03854"></a>03854     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l03855"></a>03855     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l03856"></a>03856   ],
<a name="l03857"></a>03857   <span class="keyword">function</span>(
<a name="l03858"></a>03858     $log,
<a name="l03859"></a>03859     $module,
<a name="l03860"></a>03860     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l03861"></a>03861     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l03862"></a>03862   ) {
<a name="l03863"></a>03863 
<a name="l03869"></a>03869 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ENABLE_SMTP_LOGGING = <span class="keyword">false</span>;
<a name="l03870"></a>03870 
<a name="l03871"></a>03871 <span class="keyword">function</span> SmtpAccount(universe, compositeAccount, accountId, credentials,
<a name="l03872"></a>03872                      connInfo, _parentLog) {
<a name="l03873"></a>03873   this.universe = universe;
<a name="l03874"></a>03874   this.compositeAccount = compositeAccount;
<a name="l03875"></a>03875   this.accountId = accountId;
<a name="l03876"></a>03876   this.credentials = credentials;
<a name="l03877"></a>03877   this.connInfo = connInfo;
<a name="l03878"></a>03878 
<a name="l03879"></a>03879   this._LOG = LOGFAB.SmtpAccount(<span class="keyword">this</span>, _parentLog, accountId);
<a name="l03880"></a>03880 
<a name="l03881"></a>03881   this._activeConnections = [];
<a name="l03882"></a>03882 }
<a name="l03883"></a>03883 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.Account = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SmtpAccount = SmtpAccount;
<a name="l03884"></a>03884 SmtpAccount.prototype = {
<a name="l03885"></a>03885   type: <span class="stringliteral">&#39;smtp&#39;</span>,
<a name="l03886"></a>03886   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l03887"></a>03887     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[SmtpAccount: &#39;</span> + this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l03888"></a>03888   },
<a name="l03889"></a>03889 
<a name="l03890"></a>03890   <span class="keyword">get</span> numActiveConns() {
<a name="l03891"></a>03891     <span class="keywordflow">return</span> this._activeConnections.length;
<a name="l03892"></a>03892   },
<a name="l03893"></a>03893 
<a name="l03894"></a>03894   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03895"></a>03895     <span class="comment">// (there should be no live connections during a unit-test initiated</span>
<a name="l03896"></a>03896     <span class="comment">// shutdown.)</span>
<a name="l03897"></a>03897     this._LOG.__die();
<a name="l03898"></a>03898   },
<a name="l03899"></a>03899 
<a name="l03900"></a>03900   accountDeleted: <span class="keyword">function</span>() {
<a name="l03901"></a>03901     this.<a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>();
<a name="l03902"></a>03902   },
<a name="l03903"></a>03903 
<a name="l03962"></a>03962   sendMessage: <span class="keyword">function</span>(composer, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03963"></a>03963     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;simplesmtp/lib/client&#39;</span>], <span class="keyword">function</span> ($simplesmtp) {
<a name="l03964"></a>03964       var conn, bailed = <span class="keyword">false</span>, sendingMessage = <span class="keyword">false</span>;
<a name="l03965"></a>03965 
<a name="l03966"></a>03966       conn = $simplesmtp(
<a name="l03967"></a>03967         this.connInfo.port, <span class="keyword">this</span>.connInfo.hostname,
<a name="l03968"></a>03968         {
<a name="l03969"></a>03969           crypto: <span class="keyword">this</span>.connInfo.crypto,
<a name="l03970"></a>03970           auth: {
<a name="l03971"></a>03971             <a class="code" href="../../de/d8f/jsdebug_8h.html#ad8babe1ecde8f9f6d224a06ea1a99480">user</a>: <span class="keyword">this</span>.credentials.username,
<a name="l03972"></a>03972             pass: <span class="keyword">this</span>.credentials.password
<a name="l03973"></a>03973           },
<a name="l03974"></a>03974           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>: <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ENABLE_SMTP_LOGGING,
<a name="l03975"></a>03975         });
<a name="l03976"></a>03976 
<a name="l03977"></a>03977       this._activeConnections.push(conn);
<a name="l03978"></a>03978 
<a name="l03979"></a>03979       <span class="comment">// - Optimistic case</span>
<a name="l03980"></a>03980       <span class="comment">// Send the envelope once the connection is ready (fires again after</span>
<a name="l03981"></a>03981       <span class="comment">// ready too.)</span>
<a name="l03982"></a>03982       conn.once(<span class="stringliteral">&#39;idle&#39;</span>, <span class="keyword">function</span>() {
<a name="l03983"></a>03983           conn.useEnvelope(composer.getEnvelope());
<a name="l03984"></a>03984         });
<a name="l03985"></a>03985       <span class="comment">// Then send the actual message if everything was cool</span>
<a name="l03986"></a>03986       conn.on(<span class="stringliteral">&#39;message&#39;</span>, <span class="keyword">function</span>() {
<a name="l03987"></a>03987           <span class="keywordflow">if</span> (bailed)
<a name="l03988"></a>03988             <span class="keywordflow">return</span>;
<a name="l03989"></a>03989           sendingMessage = <span class="keyword">true</span>;
<a name="l03990"></a>03990           composer.withMessageBuffer({ includeBcc: <span class="keyword">false</span> }, <span class="keyword">function</span>(<a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>) {
<a name="l03991"></a>03991             conn.write(<a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>);
<a name="l03992"></a>03992             conn.end();
<a name="l03993"></a>03993           });
<a name="l03994"></a>03994         });
<a name="l03995"></a>03995       <span class="comment">// And close the connection and be done once it has been sent</span>
<a name="l03996"></a>03996       conn.on(<span class="stringliteral">&#39;ready&#39;</span>, <span class="keyword">function</span>() {
<a name="l03997"></a>03997           bailed = <span class="keyword">true</span>;
<a name="l03998"></a>03998           conn.close();
<a name="l03999"></a>03999           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l04000"></a>04000         });
<a name="l04001"></a>04001 
<a name="l04002"></a>04002       <span class="comment">// - Error cases</span>
<a name="l04003"></a>04003       <span class="comment">// It&#39;s possible for the server to decide some, but not all, of the</span>
<a name="l04004"></a>04004       <span class="comment">// recipients are gibberish.  Since we are a mail client and talking to</span>
<a name="l04005"></a>04005       <span class="comment">// a smarthost and not the final destination (most of the time), this</span>
<a name="l04006"></a>04006       <span class="comment">// is not super likely.</span>
<a name="l04007"></a>04007       <span class="comment">//</span>
<a name="l04008"></a>04008       <span class="comment">// We upgrade this to a full failure to send</span>
<a name="l04009"></a>04009       conn.on(<span class="stringliteral">&#39;rcptFailed&#39;</span>, <span class="keyword">function</span>(addresses) {
<a name="l04010"></a>04010           <span class="comment">// nb: this gets called all the time, even without any failures</span>
<a name="l04011"></a>04011           <span class="keywordflow">if</span> (addresses.length) {
<a name="l04012"></a>04012             bailed = <span class="keyword">true</span>;
<a name="l04013"></a>04013             <span class="comment">// simplesmtp does&#39;t view this as fatal, so we have to close it ourself</span>
<a name="l04014"></a>04014             conn.close();
<a name="l04015"></a>04015             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;bad-recipient&#39;</span>, addresses);
<a name="l04016"></a>04016           }
<a name="l04017"></a>04017         });
<a name="l04018"></a>04018       conn.on(<span class="stringliteral">&#39;error&#39;</span>, <span class="keyword">function</span>(err) {
<a name="l04019"></a>04019         <span class="keywordflow">if</span> (bailed) <span class="comment">// (paranoia, this shouldn&#39;t happen.)</span>
<a name="l04020"></a>04020           <span class="keywordflow">return</span>;
<a name="l04021"></a>04021         var reportAs = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04022"></a>04022         <span class="keywordflow">switch</span> (err.name) {
<a name="l04023"></a>04023           <span class="comment">// no explicit error type is given for: a bad greeting, failure to</span>
<a name="l04024"></a>04024           <span class="comment">// EHLO/HELO, bad login sequence, OR a data problem during send.</span>
<a name="l04025"></a>04025           <span class="comment">// The first 3 suggest a broken server or one that just doesn&#39;t want</span>
<a name="l04026"></a>04026           <span class="comment">// to talk to us right now.</span>
<a name="l04027"></a>04027           <span class="keywordflow">case</span> <span class="stringliteral">&#39;Error&#39;</span>:
<a name="l04028"></a>04028             <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (sendingMessage)
<a name="l04029"></a>04029               reportAs = <span class="stringliteral">&#39;bad-message&#39;</span>;
<a name="l04030"></a>04030             <span class="keywordflow">else</span>
<a name="l04031"></a>04031               reportAs = <span class="stringliteral">&#39;server-maybe-offline&#39;</span>;
<a name="l04032"></a>04032             <span class="keywordflow">break</span>;
<a name="l04033"></a>04033           <span class="keywordflow">case</span> <span class="stringliteral">&#39;AuthError&#39;</span>:
<a name="l04034"></a>04034             reportAs = <span class="stringliteral">&#39;auth&#39;</span>;
<a name="l04035"></a>04035             <span class="keywordflow">break</span>;
<a name="l04036"></a>04036           <span class="keywordflow">case</span> <span class="stringliteral">&#39;UnknownAuthError&#39;</span>:
<a name="l04037"></a>04037             reportAs = <span class="stringliteral">&#39;server-maybe-offline&#39;</span>;
<a name="l04038"></a>04038             <span class="keywordflow">break</span>;
<a name="l04039"></a>04039           <span class="keywordflow">case</span> <span class="stringliteral">&#39;TLSError&#39;</span>:
<a name="l04040"></a>04040             reportAs = <span class="stringliteral">&#39;insecure&#39;</span>;
<a name="l04041"></a>04041             <span class="keywordflow">break</span>;
<a name="l04042"></a>04042 
<a name="l04043"></a>04043           <span class="keywordflow">case</span> <span class="stringliteral">&#39;SenderError&#39;</span>:
<a name="l04044"></a>04044             reportAs = <span class="stringliteral">&#39;bad-sender&#39;</span>;
<a name="l04045"></a>04045             <span class="keywordflow">break</span>;
<a name="l04046"></a>04046           <span class="comment">// no recipients (bad message on us) or they all got rejected</span>
<a name="l04047"></a>04047           <span class="keywordflow">case</span> <span class="stringliteral">&#39;RecipientError&#39;</span>:
<a name="l04048"></a>04048             reportAs = <span class="stringliteral">&#39;bad-recipient&#39;</span>;
<a name="l04049"></a>04049             <span class="keywordflow">break</span>;
<a name="l04050"></a>04050 
<a name="l04051"></a>04051           <span class="keywordflow">default</span>:
<a name="l04052"></a>04052             reportAs = <span class="stringliteral">&#39;unknown&#39;</span>;
<a name="l04053"></a>04053             <span class="keywordflow">break</span>;
<a name="l04054"></a>04054         }
<a name="l04055"></a>04055         bailed = <span class="keyword">true</span>;
<a name="l04056"></a>04056         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(reportAs, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l04057"></a>04057         <span class="comment">// the connection gets automatically closed.</span>
<a name="l04058"></a>04058       });
<a name="l04059"></a>04059       conn.on(<span class="stringliteral">&#39;end&#39;</span>, <span class="keyword">function</span>() {
<a name="l04060"></a>04060         var idx = this._activeConnections.indexOf(conn);
<a name="l04061"></a>04061         <span class="keywordflow">if</span> (idx !== -1)
<a name="l04062"></a>04062           this._activeConnections.splice(idx, 1);
<a name="l04063"></a>04063         <span class="keywordflow">else</span>
<a name="l04064"></a>04064           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Dead unknown connection?&#39;</span>);
<a name="l04065"></a>04065         <span class="keywordflow">if</span> (bailed)
<a name="l04066"></a>04066           <span class="keywordflow">return</span>;
<a name="l04067"></a>04067         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;connection-lost&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l04068"></a>04068         bailed = <span class="keyword">true</span>;
<a name="l04069"></a>04069         <span class="comment">// (the connection is already closed if we are here)</span>
<a name="l04070"></a>04070       }.bind(<span class="keyword">this</span>));
<a name="l04071"></a>04071     }.bind(<span class="keyword">this</span>));
<a name="l04072"></a>04072   },
<a name="l04073"></a>04073 
<a name="l04074"></a>04074 
<a name="l04075"></a>04075 };
<a name="l04076"></a>04076 
<a name="l04077"></a>04077 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l04078"></a>04078   SmtpAccount: {
<a name="l04079"></a>04079     type: $log.ACCOUNT,
<a name="l04080"></a>04080     events: {
<a name="l04081"></a>04081     },
<a name="l04082"></a>04082     TEST_ONLY_events: {
<a name="l04083"></a>04083     },
<a name="l04084"></a>04084     errors: {
<a name="l04085"></a>04085       folderAlreadyHasConn: { folderId: <span class="keyword">false</span> },
<a name="l04086"></a>04086     },
<a name="l04087"></a>04087   },
<a name="l04088"></a>04088 });
<a name="l04089"></a>04089 
<a name="l04090"></a>04090 }); <span class="comment">// end define</span>
<a name="l04091"></a>04091 ;
<a name="l04096"></a>04096 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/composite/account&#39;</span>,
<a name="l04097"></a>04097   [
<a name="l04098"></a>04098     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l04099"></a>04099     <span class="stringliteral">&#39;../accountcommon&#39;</span>,
<a name="l04100"></a>04100     <span class="stringliteral">&#39;../a64&#39;</span>,
<a name="l04101"></a>04101     <span class="stringliteral">&#39;../accountmixins&#39;</span>,
<a name="l04102"></a>04102     <span class="stringliteral">&#39;../imap/account&#39;</span>,
<a name="l04103"></a>04103     <span class="stringliteral">&#39;../smtp/account&#39;</span>,
<a name="l04104"></a>04104     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l04105"></a>04105   ],
<a name="l04106"></a>04106   <span class="keyword">function</span>(
<a name="l04107"></a>04107     $log,
<a name="l04108"></a>04108     $accountcommon,
<a name="l04109"></a>04109     $a64,
<a name="l04110"></a>04110     $acctmixins,
<a name="l04111"></a>04111     $imapacct,
<a name="l04112"></a>04112     $smtpacct,
<a name="l04113"></a>04113     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l04114"></a>04114   ) {
<a name="l04115"></a>04115 
<a name="l04116"></a>04116 var PIECE_ACCOUNT_TYPE_TO_CLASS = {
<a name="l04117"></a>04117   <span class="stringliteral">&#39;imap&#39;</span>: $imapacct.ImapAccount,
<a name="l04118"></a>04118   <span class="stringliteral">&#39;smtp&#39;</span>: $smtpacct.SmtpAccount,
<a name="l04119"></a>04119   <span class="comment">//&#39;gmail-imap&#39;: GmailAccount,</span>
<a name="l04120"></a>04120 };
<a name="l04121"></a>04121 
<a name="l04128"></a>04128 <span class="keyword">function</span> CompositeAccount(universe, accountDef, folderInfo, dbConn,
<a name="l04129"></a>04129                           receiveProtoConn,
<a name="l04130"></a>04130                           _LOG) {
<a name="l04131"></a>04131   this.universe = universe;
<a name="l04132"></a>04132   this.<span class="keywordtype">id</span> = accountDef.id;
<a name="l04133"></a>04133   this.accountDef = accountDef;
<a name="l04134"></a>04134 
<a name="l04135"></a>04135   <span class="comment">// Currently we don&#39;t persist the disabled state of an account because it&#39;s</span>
<a name="l04136"></a>04136   <span class="comment">// easier for the UI to be edge-triggered right now and ensure that the</span>
<a name="l04137"></a>04137   <span class="comment">// triggering occurs once each session.</span>
<a name="l04138"></a>04138   this._enabled = <span class="keyword">true</span>;
<a name="l04139"></a>04139   this.problems = [];
<a name="l04140"></a>04140 
<a name="l04141"></a>04141   <span class="comment">// XXX for now we are stealing the universe&#39;s logger</span>
<a name="l04142"></a>04142   this._LOG = _LOG;
<a name="l04143"></a>04143 
<a name="l04144"></a>04144   this.identities = accountDef.identities;
<a name="l04145"></a>04145 
<a name="l04146"></a>04146   <span class="keywordflow">if</span> (!PIECE_ACCOUNT_TYPE_TO_CLASS.hasOwnProperty(accountDef.receiveType)) {
<a name="l04147"></a>04147     this._LOG.badAccountType(accountDef.receiveType);
<a name="l04148"></a>04148   }
<a name="l04149"></a>04149   <span class="keywordflow">if</span> (!PIECE_ACCOUNT_TYPE_TO_CLASS.hasOwnProperty(accountDef.sendType)) {
<a name="l04150"></a>04150     this._LOG.badAccountType(accountDef.sendType);
<a name="l04151"></a>04151   }
<a name="l04152"></a>04152 
<a name="l04153"></a>04153   this._receivePiece =
<a name="l04154"></a>04154     <span class="keyword">new</span> PIECE_ACCOUNT_TYPE_TO_CLASS[accountDef.receiveType](
<a name="l04155"></a>04155       universe, <span class="keyword">this</span>,
<a name="l04156"></a>04156       accountDef.id, accountDef.credentials, accountDef.receiveConnInfo,
<a name="l04157"></a>04157       folderInfo, dbConn, this._LOG, receiveProtoConn);
<a name="l04158"></a>04158   this._sendPiece =
<a name="l04159"></a>04159     <span class="keyword">new</span> PIECE_ACCOUNT_TYPE_TO_CLASS[accountDef.sendType](
<a name="l04160"></a>04160       universe, <span class="keyword">this</span>,
<a name="l04161"></a>04161       accountDef.id, accountDef.credentials,
<a name="l04162"></a>04162       accountDef.sendConnInfo, dbConn, this._LOG);
<a name="l04163"></a>04163 
<a name="l04164"></a>04164   <span class="comment">// expose public lists that are always manipulated in place.</span>
<a name="l04165"></a>04165   this.folders = this._receivePiece.folders;
<a name="l04166"></a>04166   this.meta = this._receivePiece.meta;
<a name="l04167"></a>04167   this.mutations = this._receivePiece.mutations;
<a name="l04168"></a>04168   this.tzOffset = accountDef.tzOffset;
<a name="l04169"></a>04169 }
<a name="l04170"></a>04170 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.Account = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.CompositeAccount = CompositeAccount;
<a name="l04171"></a>04171 CompositeAccount.prototype = {
<a name="l04172"></a>04172   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l04173"></a>04173     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[CompositeAccount: &#39;</span> + this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l04174"></a>04174   },
<a name="l04175"></a>04175   toBridgeWire: <span class="keyword">function</span>() {
<a name="l04176"></a>04176     <span class="keywordflow">return</span> {
<a name="l04177"></a>04177       <span class="keywordtype">id</span>: this.accountDef.id,
<a name="l04178"></a>04178       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: this.accountDef.name,
<a name="l04179"></a>04179       type: this.accountDef.type,
<a name="l04180"></a>04180 
<a name="l04181"></a>04181       defaultPriority: this.accountDef.defaultPriority,
<a name="l04182"></a>04182 
<a name="l04183"></a>04183       <a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a>: this.<a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a>,
<a name="l04184"></a>04184       problems: this.problems,
<a name="l04185"></a>04185 
<a name="l04186"></a>04186       syncRange: this.accountDef.syncRange,
<a name="l04187"></a>04187       syncInterval: this.accountDef.syncInterval,
<a name="l04188"></a>04188       notifyOnNew: this.accountDef.notifyOnNew,
<a name="l04189"></a>04189 
<a name="l04190"></a>04190       identities: this.identities,
<a name="l04191"></a>04191 
<a name="l04192"></a>04192       credentials: {
<a name="l04193"></a>04193         username: this.accountDef.credentials.username,
<a name="l04194"></a>04194         <span class="comment">// no need to send the password to the UI.</span>
<a name="l04195"></a>04195       },
<a name="l04196"></a>04196 
<a name="l04197"></a>04197       servers: [
<a name="l04198"></a>04198         {
<a name="l04199"></a>04199           type: this.accountDef.receiveType,
<a name="l04200"></a>04200           connInfo: this.accountDef.receiveConnInfo,
<a name="l04201"></a>04201           activeConns: this._receivePiece.numActiveConns,
<a name="l04202"></a>04202         },
<a name="l04203"></a>04203         {
<a name="l04204"></a>04204           type: this.accountDef.sendType,
<a name="l04205"></a>04205           connInfo: this.accountDef.sendConnInfo,
<a name="l04206"></a>04206           activeConns: this._sendPiece.numActiveConns,
<a name="l04207"></a>04207         }
<a name="l04208"></a>04208       ],
<a name="l04209"></a>04209     };
<a name="l04210"></a>04210   },
<a name="l04211"></a>04211   toBridgeFolder: <span class="keyword">function</span>() {
<a name="l04212"></a>04212     <span class="keywordflow">return</span> {
<a name="l04213"></a>04213       <span class="keywordtype">id</span>: this.accountDef.id,
<a name="l04214"></a>04214       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: this.accountDef.name,
<a name="l04215"></a>04215       path: this.accountDef.name,
<a name="l04216"></a>04216       type: <span class="stringliteral">&#39;account&#39;</span>,
<a name="l04217"></a>04217     };
<a name="l04218"></a>04218   },
<a name="l04219"></a>04219 
<a name="l04220"></a>04220   <span class="keyword">get</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a>() {
<a name="l04221"></a>04221     <span class="keywordflow">return</span> this._enabled;
<a name="l04222"></a>04222   },
<a name="l04223"></a>04223   <span class="keyword">set</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a>(<a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>) {
<a name="l04224"></a>04224     this._enabled = this._receivePiece.enabled = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l04225"></a>04225   },
<a name="l04226"></a>04226 
<a name="l04227"></a>04227   saveAccountState: <span class="keyword">function</span>(reuseTrans, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../da/dd0/ns_i_d_o_m_close_event_8idl.html#aa538b14c961e4162ded76940b8f37507">reason</a>) {
<a name="l04228"></a>04228     <span class="keywordflow">return</span> this._receivePiece.saveAccountState(reuseTrans, callback, <a class="code" href="../../da/dd0/ns_i_d_o_m_close_event_8idl.html#aa538b14c961e4162ded76940b8f37507">reason</a>);
<a name="l04229"></a>04229   },
<a name="l04230"></a>04230 
<a name="l04231"></a>04231   <span class="keyword">get</span> _saveAccountIsImminent() {
<a name="l04232"></a>04232     <span class="keywordflow">return</span> this.__saveAccountIsImminent;
<a name="l04233"></a>04233   },
<a name="l04234"></a>04234   <span class="keyword">set</span> _saveAccountIsImminent(<a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>) {
<a name="l04235"></a>04235     this.___saveAccountIsImminent =
<a name="l04236"></a>04236     this._receivePiece._saveAccountIsImminent = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l04237"></a>04237   },
<a name="l04238"></a>04238 
<a name="l04239"></a>04239   runAfterSaves: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04240"></a>04240     <span class="keywordflow">return</span> this._receivePiece.runAfterSaves(callback);
<a name="l04241"></a>04241   },
<a name="l04242"></a>04242 
<a name="l04246"></a>04246   checkAccount: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04247"></a>04247     <span class="comment">// Since we use the same credential for both cases, we can just have the</span>
<a name="l04248"></a>04248     <span class="comment">// IMAP account attempt to establish a connection and forget about SMTP.</span>
<a name="l04249"></a>04249     this._receivePiece.checkAccount(callback);
<a name="l04250"></a>04250   },
<a name="l04251"></a>04251 
<a name="l04255"></a>04255   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04256"></a>04256     this._sendPiece.shutdown();
<a name="l04257"></a>04257     this._receivePiece.shutdown(callback);
<a name="l04258"></a>04258   },
<a name="l04259"></a>04259 
<a name="l04260"></a>04260   accountDeleted: <span class="keyword">function</span>() {
<a name="l04261"></a>04261     this._sendPiece.accountDeleted();
<a name="l04262"></a>04262     this._receivePiece.accountDeleted();
<a name="l04263"></a>04263   },
<a name="l04264"></a>04264 
<a name="l04265"></a>04265   <a class="code" href="../../df/d99/namespacevariant.html#ab05c7931468d628f4294600987d629f2">deleteFolder</a>: <span class="keyword">function</span>(folderId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04266"></a>04266     <span class="keywordflow">return</span> this._receivePiece.deleteFolder(folderId, callback);
<a name="l04267"></a>04267   },
<a name="l04268"></a>04268 
<a name="l04269"></a>04269   sliceFolderMessages: <span class="keyword">function</span>(folderId, bridgeProxy) {
<a name="l04270"></a>04270     <span class="keywordflow">return</span> this._receivePiece.sliceFolderMessages(folderId, bridgeProxy);
<a name="l04271"></a>04271   },
<a name="l04272"></a>04272 
<a name="l04273"></a>04273   searchFolderMessages: <span class="keyword">function</span>(folderId, bridgeHandle, phrase, whatToSearch) {
<a name="l04274"></a>04274     <span class="keywordflow">return</span> this._receivePiece.searchFolderMessages(
<a name="l04275"></a>04275       folderId, bridgeHandle, phrase, whatToSearch);
<a name="l04276"></a>04276   },
<a name="l04277"></a>04277 
<a name="l04278"></a>04278   syncFolderList: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04279"></a>04279     <span class="keywordflow">return</span> this._receivePiece.syncFolderList(callback);
<a name="l04280"></a>04280   },
<a name="l04281"></a>04281 
<a name="l04282"></a>04282   sendMessage: <span class="keyword">function</span>(composer, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04283"></a>04283     <span class="keywordflow">return</span> this._sendPiece.sendMessage(
<a name="l04284"></a>04284       composer,
<a name="l04285"></a>04285       <span class="keyword">function</span>(err, errDetails) {
<a name="l04286"></a>04286         <span class="comment">// We need to append the message to the sent folder if we think we sent</span>
<a name="l04287"></a>04287         <span class="comment">// the message okay and this is not gmail.  gmail automatically crams</span>
<a name="l04288"></a>04288         <span class="comment">// the message in the sent folder for us, so if we do it, we&#39;re just</span>
<a name="l04289"></a>04289         <span class="comment">// going to create duplicates.</span>
<a name="l04290"></a>04290         <span class="keywordflow">if</span> (!err &amp;&amp; !this._receivePiece.isGmail) {
<a name="l04291"></a>04291           composer.withMessageBuffer({ includeBcc: <span class="keyword">true</span> }, <span class="keyword">function</span>(<a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>) {
<a name="l04292"></a>04292             var message = {
<a name="l04293"></a>04293               messageText: <a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>,
<a name="l04294"></a>04294               <span class="comment">// do not specify date; let the server use its own timestamping</span>
<a name="l04295"></a>04295               <span class="comment">// since we want the approximate value of &#39;now&#39; anyways.</span>
<a name="l04296"></a>04296               <a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>: [<span class="stringliteral">&#39;Seen&#39;</span>],
<a name="l04297"></a>04297             };
<a name="l04298"></a>04298 
<a name="l04299"></a>04299             var sentFolder = this.getFirstFolderWithType(<span class="stringliteral">&#39;sent&#39;</span>);
<a name="l04300"></a>04300             <span class="keywordflow">if</span> (sentFolder)
<a name="l04301"></a>04301               this.universe.appendMessages(sentFolder.id,
<a name="l04302"></a>04302                                            [message]);
<a name="l04303"></a>04303           }.bind(<span class="keyword">this</span>));
<a name="l04304"></a>04304         }
<a name="l04305"></a>04305         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(err, errDetails, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l04306"></a>04306       }.bind(<span class="keyword">this</span>));
<a name="l04307"></a>04307   },
<a name="l04308"></a>04308 
<a name="l04309"></a>04309   getFolderStorageForFolderId: <span class="keyword">function</span>(folderId) {
<a name="l04310"></a>04310     <span class="keywordflow">return</span> this._receivePiece.getFolderStorageForFolderId(folderId);
<a name="l04311"></a>04311   },
<a name="l04312"></a>04312 
<a name="l04313"></a>04313   getFolderMetaForFolderId: <span class="keyword">function</span>(folderId) {
<a name="l04314"></a>04314     <span class="keywordflow">return</span> this._receivePiece.getFolderMetaForFolderId(folderId);
<a name="l04315"></a>04315   },
<a name="l04316"></a>04316 
<a name="l04317"></a>04317   runOp: <span class="keyword">function</span>(op, <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04318"></a>04318     <span class="keywordflow">return</span> this._receivePiece.runOp(op, mode, callback);
<a name="l04319"></a>04319   },
<a name="l04320"></a>04320 
<a name="l04321"></a>04321   ensureEssentialFolders: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04322"></a>04322     <span class="keywordflow">return</span> this._receivePiece.ensureEssentialFolders(callback);
<a name="l04323"></a>04323   },
<a name="l04324"></a>04324 
<a name="l04325"></a>04325   getFirstFolderWithType: $acctmixins.getFirstFolderWithType,
<a name="l04326"></a>04326 };
<a name="l04327"></a>04327 
<a name="l04328"></a>04328 }); <span class="comment">// end define</span>
<a name="l04329"></a>04329 ;
<a name="l04334"></a>04334 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/composite/configurator&#39;</span>,
<a name="l04335"></a>04335   [
<a name="l04336"></a>04336     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l04337"></a>04337     <span class="stringliteral">&#39;../accountcommon&#39;</span>,
<a name="l04338"></a>04338     <span class="stringliteral">&#39;../a64&#39;</span>,
<a name="l04339"></a>04339     <span class="stringliteral">&#39;../allback&#39;</span>,
<a name="l04340"></a>04340     <span class="stringliteral">&#39;./account&#39;</span>,
<a name="l04341"></a>04341     <span class="stringliteral">&#39;../date&#39;</span>,
<a name="l04342"></a>04342     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l04343"></a>04343     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l04344"></a>04344   ],
<a name="l04345"></a>04345   <span class="keyword">function</span>(
<a name="l04346"></a>04346     $log,
<a name="l04347"></a>04347     $accountcommon,
<a name="l04348"></a>04348     $a64,
<a name="l04349"></a>04349     $allback,
<a name="l04350"></a>04350     $account,
<a name="l04351"></a>04351     $date,
<a name="l04352"></a>04352     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l04353"></a>04353     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l04354"></a>04354   ) {
<a name="l04355"></a>04355 
<a name="l04356"></a>04356 var allbackMaker = $allback.allbackMaker;
<a name="l04357"></a>04357 
<a name="l04358"></a>04358 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.account = $account;
<a name="l04359"></a>04359 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.configurator = {
<a name="l04360"></a>04360   tryToCreateAccount: <span class="keyword">function</span> cfg_is_ttca(universe, userDetails, domainInfo,
<a name="l04361"></a>04361                                            callback, _LOG) {
<a name="l04362"></a>04362     var credentials, imapConnInfo, smtpConnInfo;
<a name="l04363"></a>04363     <span class="keywordflow">if</span> (domainInfo) {
<a name="l04364"></a>04364       credentials = {
<a name="l04365"></a>04365         username: domainInfo.incoming.username,
<a name="l04366"></a>04366         password: userDetails.password,
<a name="l04367"></a>04367       };
<a name="l04368"></a>04368       imapConnInfo = {
<a name="l04369"></a>04369         hostname: domainInfo.incoming.hostname,
<a name="l04370"></a>04370         <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: domainInfo.incoming.port,
<a name="l04371"></a>04371         crypto: (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> domainInfo.incoming.socketType === <span class="stringliteral">&#39;string&#39;</span> ?
<a name="l04372"></a>04372                  domainInfo.incoming.socketType.toLowerCase() :
<a name="l04373"></a>04373                  domainInfo.incoming.socketType),
<a name="l04374"></a>04374         blacklistedCapabilities: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04375"></a>04375       };
<a name="l04376"></a>04376       smtpConnInfo = {
<a name="l04377"></a>04377         hostname: domainInfo.outgoing.hostname,
<a name="l04378"></a>04378         <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: domainInfo.outgoing.port,
<a name="l04379"></a>04379         crypto: (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> domainInfo.outgoing.socketType === <span class="stringliteral">&#39;string&#39;</span> ?
<a name="l04380"></a>04380                  domainInfo.outgoing.socketType.toLowerCase() :
<a name="l04381"></a>04381                  domainInfo.outgoing.socketType),
<a name="l04382"></a>04382       };
<a name="l04383"></a>04383     }
<a name="l04384"></a>04384 
<a name="l04385"></a>04385     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l04386"></a>04386     var callbacks = allbackMaker(
<a name="l04387"></a>04387       [<span class="stringliteral">&#39;imap&#39;</span>, <span class="stringliteral">&#39;smtp&#39;</span>],
<a name="l04388"></a>04388       <span class="keyword">function</span> probesDone(<a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>) {
<a name="l04389"></a>04389         <span class="comment">// -- both good?</span>
<a name="l04390"></a>04390         <span class="keywordflow">if</span> (<a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.imap[0] === null &amp;&amp; <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.smtp[0] === null) {
<a name="l04391"></a>04391           var imapConn = <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.imap[1],
<a name="l04392"></a>04392               imapTZOffset = <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.imap[2],
<a name="l04393"></a>04393               imapBlacklistedCapabilities = <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.imap[3];
<a name="l04394"></a>04394 
<a name="l04395"></a>04395           imapConnInfo.blacklistedCapabilities = imapBlacklistedCapabilities;
<a name="l04396"></a>04396 
<a name="l04397"></a>04397           var account = <span class="keyword">self</span>._defineImapAccount(
<a name="l04398"></a>04398             universe,
<a name="l04399"></a>04399             userDetails, credentials,
<a name="l04400"></a>04400             imapConnInfo, smtpConnInfo, imapConn,
<a name="l04401"></a>04401             imapTZOffset,
<a name="l04402"></a>04402             callback);
<a name="l04403"></a>04403         }
<a name="l04404"></a>04404         <span class="comment">// -- either/both bad</span>
<a name="l04405"></a>04405         <span class="keywordflow">else</span> {
<a name="l04406"></a>04406           <span class="comment">// clean up the imap connection if it was okay but smtp failed</span>
<a name="l04407"></a>04407           <span class="keywordflow">if</span> (<a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.imap[0] === null) {
<a name="l04408"></a>04408             <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.imap[1].die();
<a name="l04409"></a>04409             <span class="comment">// Failure was caused by SMTP, but who knows why</span>
<a name="l04410"></a>04410             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.smtp[0], null, <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.smtp[1]);
<a name="l04411"></a>04411           } <span class="keywordflow">else</span> {
<a name="l04412"></a>04412             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.imap[0], null, <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>.imap[2]);
<a name="l04413"></a>04413           }
<a name="l04414"></a>04414           <span class="keywordflow">return</span>;
<a name="l04415"></a>04415         }
<a name="l04416"></a>04416       });
<a name="l04417"></a>04417 
<a name="l04418"></a>04418     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;../imap/probe&#39;</span>, <span class="stringliteral">&#39;../smtp/probe&#39;</span>,], <span class="keyword">function</span> ($imapprobe, $smtpprobe) {
<a name="l04419"></a>04419 
<a name="l04420"></a>04420       var imapProber = <span class="keyword">new</span> $imapprobe.ImapProber(credentials, imapConnInfo,
<a name="l04421"></a>04421                                                  _LOG);
<a name="l04422"></a>04422       imapProber.onresult = callbacks.imap;
<a name="l04423"></a>04423 
<a name="l04424"></a>04424       var smtpProber = <span class="keyword">new</span> $smtpprobe.SmtpProber(credentials, smtpConnInfo,
<a name="l04425"></a>04425                                                  _LOG);
<a name="l04426"></a>04426       smtpProber.onresult = callbacks.smtp;
<a name="l04427"></a>04427     });
<a name="l04428"></a>04428   },
<a name="l04429"></a>04429 
<a name="l04430"></a>04430   recreateAccount: <span class="keyword">function</span> cfg_is_ra(universe, oldVersion, oldAccountInfo,
<a name="l04431"></a>04431                                       callback) {
<a name="l04432"></a>04432     var oldAccountDef = oldAccountInfo.def;
<a name="l04433"></a>04433 
<a name="l04434"></a>04434     var credentials = {
<a name="l04435"></a>04435       username: oldAccountDef.credentials.username,
<a name="l04436"></a>04436       password: oldAccountDef.credentials.password,
<a name="l04437"></a>04437     };
<a name="l04438"></a>04438     var accountId = $a64.encodeInt(universe.config.nextAccountNum++);
<a name="l04439"></a>04439     var accountDef = {
<a name="l04440"></a>04440       <span class="keywordtype">id</span>: accountId,
<a name="l04441"></a>04441       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: oldAccountDef.name,
<a name="l04442"></a>04442 
<a name="l04443"></a>04443       type: <span class="stringliteral">&#39;imap+smtp&#39;</span>,
<a name="l04444"></a>04444       receiveType: <span class="stringliteral">&#39;imap&#39;</span>,
<a name="l04445"></a>04445       sendType: <span class="stringliteral">&#39;smtp&#39;</span>,
<a name="l04446"></a>04446 
<a name="l04447"></a>04447       syncRange: oldAccountDef.syncRange,
<a name="l04448"></a>04448       syncInterval: oldAccountDef.syncInterval || 0,
<a name="l04449"></a>04449       notifyOnNew: oldAccountDef.hasOwnProperty(<span class="stringliteral">&#39;notifyOnNew&#39;</span>) ?
<a name="l04450"></a>04450                    oldAccountDef.notifyOnNew : <span class="keyword">true</span>,
<a name="l04451"></a>04451 
<a name="l04452"></a>04452       credentials: credentials,
<a name="l04453"></a>04453       receiveConnInfo: {
<a name="l04454"></a>04454         hostname: oldAccountDef.receiveConnInfo.hostname,
<a name="l04455"></a>04455         <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: oldAccountDef.receiveConnInfo.port,
<a name="l04456"></a>04456         crypto: oldAccountDef.receiveConnInfo.crypto,
<a name="l04457"></a>04457 
<a name="l04458"></a>04458         blacklistedCapabilities:
<a name="l04459"></a>04459           oldAccountDef.receiveConnInfo.blacklistedCapabilities || <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04460"></a>04460       },
<a name="l04461"></a>04461       sendConnInfo: {
<a name="l04462"></a>04462         hostname: oldAccountDef.sendConnInfo.hostname,
<a name="l04463"></a>04463         <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: oldAccountDef.sendConnInfo.port,
<a name="l04464"></a>04464         crypto: oldAccountDef.sendConnInfo.crypto,
<a name="l04465"></a>04465       },
<a name="l04466"></a>04466 
<a name="l04467"></a>04467       identities: $accountcommon.recreateIdentities(universe, accountId,
<a name="l04468"></a>04468                                      oldAccountDef.identities),
<a name="l04469"></a>04469       <span class="comment">// this default timezone here maintains things; but people are going to</span>
<a name="l04470"></a>04470       <span class="comment">// need to create new accounts at some point...</span>
<a name="l04471"></a>04471       tzOffset: oldAccountInfo.tzOffset !== undefined ?
<a name="l04472"></a>04472                   oldAccountInfo.tzOffset : -7 * 60 * 60 * 1000,
<a name="l04473"></a>04473     };
<a name="l04474"></a>04474 
<a name="l04475"></a>04475     this._loadAccount(universe, accountDef,
<a name="l04476"></a>04476                       oldAccountInfo.folderInfo, null, <a class="code" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> (account) {
<a name="l04477"></a>04477       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null, account, null);
<a name="l04478"></a>04478     });
<a name="l04479"></a>04479   },
<a name="l04480"></a>04480 
<a name="l04487"></a>04487   _defineImapAccount: <span class="keyword">function</span> cfg_is__defineImapAccount(
<a name="l04488"></a>04488                         universe,
<a name="l04489"></a>04489                         userDetails, credentials, imapConnInfo, smtpConnInfo,
<a name="l04490"></a>04490                         imapProtoConn, tzOffset, callback) {
<a name="l04491"></a>04491     var accountId = $a64.encodeInt(universe.config.nextAccountNum++);
<a name="l04492"></a>04492     var accountDef = {
<a name="l04493"></a>04493       <span class="keywordtype">id</span>: accountId,
<a name="l04494"></a>04494       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: userDetails.accountName || userDetails.emailAddress,
<a name="l04495"></a>04495       defaultPriority: $date.NOW(),
<a name="l04496"></a>04496 
<a name="l04497"></a>04497       type: <span class="stringliteral">&#39;imap+smtp&#39;</span>,
<a name="l04498"></a>04498       receiveType: <span class="stringliteral">&#39;imap&#39;</span>,
<a name="l04499"></a>04499       sendType: <span class="stringliteral">&#39;smtp&#39;</span>,
<a name="l04500"></a>04500 
<a name="l04501"></a>04501       syncRange: <span class="stringliteral">&#39;auto&#39;</span>,
<a name="l04502"></a>04502       syncInterval: userDetails.syncInterval || 0,
<a name="l04503"></a>04503       notifyOnNew: userDetails.hasOwnProperty(<span class="stringliteral">&#39;notifyOnNew&#39;</span>) ?
<a name="l04504"></a>04504                    userDetails.notifyOnNew : <span class="keyword">true</span>,
<a name="l04505"></a>04505 
<a name="l04506"></a>04506       credentials: credentials,
<a name="l04507"></a>04507       receiveConnInfo: imapConnInfo,
<a name="l04508"></a>04508       sendConnInfo: smtpConnInfo,
<a name="l04509"></a>04509 
<a name="l04510"></a>04510       identities: [
<a name="l04511"></a>04511         {
<a name="l04512"></a>04512           <span class="keywordtype">id</span>: accountId + <span class="charliteral">&#39;/&#39;</span> +
<a name="l04513"></a>04513                 $a64.encodeInt(universe.config.nextIdentityNum++),
<a name="l04514"></a>04514           <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: userDetails.displayName,
<a name="l04515"></a>04515           <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: userDetails.emailAddress,
<a name="l04516"></a>04516           replyTo: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04517"></a>04517           signature: null
<a name="l04518"></a>04518         },
<a name="l04519"></a>04519       ],
<a name="l04520"></a>04520       tzOffset: tzOffset,
<a name="l04521"></a>04521     };
<a name="l04522"></a>04522 
<a name="l04523"></a>04523     this._loadAccount(universe, accountDef, null,
<a name="l04524"></a>04524                       imapProtoConn, <span class="keyword">function</span> (account) {
<a name="l04525"></a>04525       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null, account, null);
<a name="l04526"></a>04526     });
<a name="l04527"></a>04527   },
<a name="l04528"></a>04528 
<a name="l04533"></a>04533   _loadAccount: <span class="keyword">function</span> cfg_is__loadAccount(universe, accountDef,
<a name="l04534"></a>04534                                              oldFolderInfo, imapProtoConn,
<a name="l04535"></a>04535                                              callback) {
<a name="l04536"></a>04536     <span class="comment">// XXX: Just reload the old folders when applicable instead of syncing the</span>
<a name="l04537"></a>04537     <span class="comment">// folder list again, which is slow.</span>
<a name="l04538"></a>04538     var folderInfo = {
<a name="l04539"></a>04539       $meta: {
<a name="l04540"></a>04540         nextFolderNum: 0,
<a name="l04541"></a>04541         nextMutationNum: 0,
<a name="l04542"></a>04542         lastFolderSyncAt: 0,
<a name="l04543"></a>04543         capability: (oldFolderInfo &amp;&amp; oldFolderInfo.$meta.capability) ||
<a name="l04544"></a>04544                     imapProtoConn.capabilities,
<a name="l04545"></a>04545         rootDelim: (oldFolderInfo &amp;&amp; oldFolderInfo.$meta.rootDelim) ||
<a name="l04546"></a>04546                    imapProtoConn.delim,
<a name="l04547"></a>04547       },
<a name="l04548"></a>04548       $mutations: [],
<a name="l04549"></a>04549       $mutationState: {},
<a name="l04550"></a>04550     };
<a name="l04551"></a>04551     universe.saveAccountDef(accountDef, folderInfo);
<a name="l04552"></a>04552     universe._loadAccount(accountDef, folderInfo, imapProtoConn, callback);
<a name="l04553"></a>04553   },
<a name="l04554"></a>04554 };
<a name="l04555"></a>04555 
<a name="l04556"></a>04556 }); <span class="comment">// end define</span>
<a name="l04557"></a>04557 ;
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../dc/d6d/build__stage_2email_2js_2ext_2mailapi_2composite_2configurator_8js.html">configurator.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:51:46に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
