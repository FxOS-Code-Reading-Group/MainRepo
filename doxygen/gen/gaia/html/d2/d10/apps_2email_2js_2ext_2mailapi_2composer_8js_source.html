<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: composer.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d2/d10/apps_2email_2js_2ext_2mailapi_2composer_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">composer.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d2/d10/apps_2email_2js_2ext_2mailapi_2composer_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailcomposer/lib/punycode&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>],<span class="keyword">function</span> (<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l00003"></a>00003 <span class="comment">//Javascript Punycode converter derived from example in RFC3492.</span>
<a name="l00004"></a>00004 <span class="comment">//This implementation is created by some@domain.name and released into public domain</span>
<a name="l00005"></a>00005 var punycode = <span class="keyword">new</span> <span class="keyword">function</span> Punycode() {
<a name="l00006"></a>00006     <span class="comment">// This object converts to and from puny-code used in IDN</span>
<a name="l00007"></a>00007     <span class="comment">//</span>
<a name="l00008"></a>00008     <span class="comment">// punycode.ToASCII ( domain )</span>
<a name="l00009"></a>00009     <span class="comment">// </span>
<a name="l00010"></a>00010     <span class="comment">// Returns a puny coded representation of &quot;domain&quot;.</span>
<a name="l00011"></a>00011     <span class="comment">// It only converts the part of the domain name that</span>
<a name="l00012"></a>00012     <span class="comment">// has non ASCII characters. I.e. it dosent matter if</span>
<a name="l00013"></a>00013     <span class="comment">// you call it with a domain that already is in ASCII.</span>
<a name="l00014"></a>00014     <span class="comment">//</span>
<a name="l00015"></a>00015     <span class="comment">// punycode.ToUnicode (domain)</span>
<a name="l00016"></a>00016     <span class="comment">//</span>
<a name="l00017"></a>00017     <span class="comment">// Converts a puny-coded domain name to unicode.</span>
<a name="l00018"></a>00018     <span class="comment">// It only converts the puny-coded parts of the domain name.</span>
<a name="l00019"></a>00019     <span class="comment">// I.e. it dosent matter if you call it on a string</span>
<a name="l00020"></a>00020     <span class="comment">// that already has been converted to unicode.</span>
<a name="l00021"></a>00021     <span class="comment">//</span>
<a name="l00022"></a>00022     <span class="comment">//</span>
<a name="l00023"></a>00023     this.utf16 = {
<a name="l00024"></a>00024         <span class="comment">// The utf16-class is necessary to convert from javascripts internal character representation to unicode and back.</span>
<a name="l00025"></a>00025         decode:<span class="keyword">function</span>(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>){
<a name="l00026"></a>00026             var <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a> = [], <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>=0, <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>=<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length,<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>,extra;
<a name="l00027"></a>00027             <span class="keywordflow">while</span> (<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>) {
<a name="l00028"></a>00028                 <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++);
<a name="l00029"></a>00029                 <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> &amp; 0xF800) === 0xD800) {
<a name="l00030"></a>00030                     extra = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++);
<a name="l00031"></a>00031                     <span class="keywordflow">if</span> ( ((<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> &amp; 0xFC00) !== 0xD800) || ((extra &amp; 0xFC00) !== 0xDC00) ) {
<a name="l00032"></a>00032                         <span class="keywordflow">throw</span> <span class="keyword">new</span> RangeError(<span class="stringliteral">&quot;UTF-16(decode): Illegal UTF-16 sequence&quot;</span>);
<a name="l00033"></a>00033                     }
<a name="l00034"></a>00034                     <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = ((<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> &amp; 0x3FF) &lt;&lt; 10) + (extra &amp; 0x3FF) + 0x10000;
<a name="l00035"></a>00035                 }
<a name="l00036"></a>00036                 output.push(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>);
<a name="l00037"></a>00037             }
<a name="l00038"></a>00038             <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l00039"></a>00039         },
<a name="l00040"></a>00040         encode:<span class="keyword">function</span>(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>){
<a name="l00041"></a>00041             var output = [], <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>=0, <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>=<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length,<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l00042"></a>00042             <span class="keywordflow">while</span> (<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>) {
<a name="l00043"></a>00043                 <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++];
<a name="l00044"></a>00044                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> &amp; 0xF800) === 0xD800 ) {
<a name="l00045"></a>00045                     <span class="keywordflow">throw</span> <span class="keyword">new</span> RangeError(<span class="stringliteral">&quot;UTF-16(encode): Illegal UTF-16 value&quot;</span>);
<a name="l00046"></a>00046                 }
<a name="l00047"></a>00047                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> &gt; 0xFFFF) {
<a name="l00048"></a>00048                     <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> -= 0x10000;
<a name="l00049"></a>00049                     output.push(String.fromCharCode(((<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> &gt;&gt;&gt;10) &amp; 0x3FF) | 0xD800));
<a name="l00050"></a>00050                     <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = 0xDC00 | (<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> &amp; 0x3FF);
<a name="l00051"></a>00051                 }
<a name="l00052"></a>00052                 output.push(String.fromCharCode(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>));
<a name="l00053"></a>00053             }
<a name="l00054"></a>00054             <span class="keywordflow">return</span> output.join(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00055"></a>00055         }
<a name="l00056"></a>00056     };
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     <span class="comment">//Default parameters</span>
<a name="l00059"></a>00059     var initial_n = 0x80;
<a name="l00060"></a>00060     var initial_bias = 72;
<a name="l00061"></a>00061     var delimiter = <span class="stringliteral">&quot;-&quot;</span>;
<a name="l00062"></a>00062     var <a class="code" href="../../d9/d04/expat_8h.html#a938e186c531ea86ae9adf3c0a649d8fc">base</a> = 36;
<a name="l00063"></a>00063     var damp = 700;
<a name="l00064"></a>00064     var tmin=1;
<a name="l00065"></a>00065     var tmax=26;
<a name="l00066"></a>00066     var skew=38;
<a name="l00067"></a>00067     var maxint = 0x7FFFFFFF;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     <span class="comment">// decode_digit(cp) returns the numeric value of a basic code </span>
<a name="l00070"></a>00070     <span class="comment">// point (for use in representing integers) in the range 0 to</span>
<a name="l00071"></a>00071     <span class="comment">// base-1, or base if cp is does not represent a value.</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     <span class="keyword">function</span> decode_digit(<a class="code" href="../../d3/d91/j3d_8js.html#a28ea320035417a662df08541fe1006c5">cp</a>) {
<a name="l00074"></a>00074         <span class="keywordflow">return</span> <a class="code" href="../../d3/d91/j3d_8js.html#a28ea320035417a662df08541fe1006c5">cp</a> - 48 &lt; 10 ? <a class="code" href="../../d3/d91/j3d_8js.html#a28ea320035417a662df08541fe1006c5">cp</a> - 22 : <a class="code" href="../../d3/d91/j3d_8js.html#a28ea320035417a662df08541fe1006c5">cp</a> - 65 &lt; 26 ? <a class="code" href="../../d3/d91/j3d_8js.html#a28ea320035417a662df08541fe1006c5">cp</a> - 65 : <a class="code" href="../../d3/d91/j3d_8js.html#a28ea320035417a662df08541fe1006c5">cp</a> - 97 &lt; 26 ? <a class="code" href="../../d3/d91/j3d_8js.html#a28ea320035417a662df08541fe1006c5">cp</a> - 97 : <a class="code" href="../../d9/d04/expat_8h.html#a938e186c531ea86ae9adf3c0a649d8fc">base</a>;
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="comment">// encode_digit(d,flag) returns the basic code point whose value</span>
<a name="l00078"></a>00078     <span class="comment">// (when used for representing integers) is d, which needs to be in</span>
<a name="l00079"></a>00079     <span class="comment">// the range 0 to base-1. The lowercase form is used unless flag is</span>
<a name="l00080"></a>00080     <span class="comment">// nonzero, in which case the uppercase form is used. The behavior</span>
<a name="l00081"></a>00081     <span class="comment">// is undefined if flag is nonzero and digit d has no uppercase form. </span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="keyword">function</span> encode_digit(d, flag) {
<a name="l00084"></a>00084         <span class="keywordflow">return</span> d + 22 + 75 * (d &lt; 26) - ((flag !== 0) &lt;&lt; 5);
<a name="l00085"></a>00085         <span class="comment">//  0..25 map to ASCII a..z or A..Z </span>
<a name="l00086"></a>00086         <span class="comment">// 26..35 map to ASCII 0..9</span>
<a name="l00087"></a>00087     }
<a name="l00088"></a>00088     <span class="comment">//** Bias adaptation function **</span>
<a name="l00089"></a>00089     <span class="keyword">function</span> adapt(delta, numpoints, firsttime ) {
<a name="l00090"></a>00090         var <a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>;
<a name="l00091"></a>00091         delta = firsttime ? Math.floor(delta / damp) : (delta &gt;&gt; 1);
<a name="l00092"></a>00092         delta += Math.floor(delta / numpoints);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         <span class="keywordflow">for</span> (k = 0; delta &gt; (((base - tmin) * tmax) &gt;&gt; 1); k += <a class="code" href="../../d9/d04/expat_8h.html#a938e186c531ea86ae9adf3c0a649d8fc">base</a>) {
<a name="l00095"></a>00095                 delta = Math.floor(delta / ( base - tmin ));
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097         <span class="keywordflow">return</span> Math.floor(k + (base - tmin + 1) * delta / (delta + skew));
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="comment">// encode_basic(bcp,flag) forces a basic code point to lowercase if flag is zero,</span>
<a name="l00101"></a>00101     <span class="comment">// uppercase if flag is nonzero, and returns the resulting code point.</span>
<a name="l00102"></a>00102     <span class="comment">// The code point is unchanged if it is caseless.</span>
<a name="l00103"></a>00103     <span class="comment">// The behavior is undefined if bcp is not a basic code point.</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <span class="keyword">function</span> encode_basic(bcp, flag) {
<a name="l00106"></a>00106         bcp -= (bcp - 97 &lt; 26) &lt;&lt; 5;
<a name="l00107"></a>00107         <span class="keywordflow">return</span> bcp + ((!flag &amp;&amp; (bcp - 65 &lt; 26)) &lt;&lt; 5);
<a name="l00108"></a>00108     }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <span class="comment">// Main decode</span>
<a name="l00111"></a>00111     this.decode=<span class="keyword">function</span>(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>,preserveCase) {
<a name="l00112"></a>00112         <span class="comment">// Dont use utf16</span>
<a name="l00113"></a>00113         var output=[];
<a name="l00114"></a>00114         var case_flags=[];
<a name="l00115"></a>00115         var input_length = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117         var <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, <a class="code" href="../../db/da2/namespacejs.html#ae38c69c83e560d6765bddb6b3d53cc46">out</a>, <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, bias, basic, <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>, ic, oldi, w, <a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>, digit, t, <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119         <span class="comment">// Initialize the state: </span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121         n = initial_n;
<a name="l00122"></a>00122         i = 0;
<a name="l00123"></a>00123         bias = initial_bias;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125         <span class="comment">// Handle the basic code points: Let basic be the number of input code </span>
<a name="l00126"></a>00126         <span class="comment">// points before the last delimiter, or 0 if there is none, then</span>
<a name="l00127"></a>00127         <span class="comment">// copy the first basic code points to the output.</span>
<a name="l00128"></a>00128 
<a name="l00129"></a>00129         basic = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.lastIndexOf(delimiter);
<a name="l00130"></a>00130         <span class="keywordflow">if</span> (basic &lt; 0) basic = 0;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132         <span class="keywordflow">for</span> (j = 0; j &lt; basic; ++<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>) {
<a name="l00133"></a>00133             <span class="keywordflow">if</span>(preserveCase) case_flags[output.length] = ( <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(j) -65 &lt; 26);
<a name="l00134"></a>00134             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(j) &gt;= 0x80) {
<a name="l00135"></a>00135                 <span class="keywordflow">throw</span> <span class="keyword">new</span> RangeError(<span class="stringliteral">&quot;Illegal input &gt;= 0x80&quot;</span>);
<a name="l00136"></a>00136             }
<a name="l00137"></a>00137             output.push( <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(j) );
<a name="l00138"></a>00138         }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140         <span class="comment">// Main decoding loop: Start just after the last delimiter if any</span>
<a name="l00141"></a>00141         <span class="comment">// basic code points were copied; start at the beginning otherwise. </span>
<a name="l00142"></a>00142 
<a name="l00143"></a>00143         <span class="keywordflow">for</span> (ic = basic &gt; 0 ? basic + 1 : 0; ic &lt; input_length; ) {
<a name="l00144"></a>00144 
<a name="l00145"></a>00145             <span class="comment">// ic is the index of the next character to be consumed,</span>
<a name="l00146"></a>00146 
<a name="l00147"></a>00147             <span class="comment">// Decode a generalized variable-length integer into delta,</span>
<a name="l00148"></a>00148             <span class="comment">// which gets added to i. The overflow checking is easier</span>
<a name="l00149"></a>00149             <span class="comment">// if we increase i as we go, then subtract off its starting </span>
<a name="l00150"></a>00150             <span class="comment">// value at the end to obtain delta.</span>
<a name="l00151"></a>00151             <span class="keywordflow">for</span> (oldi = i, w = 1, k = base; ; k += <a class="code" href="../../d9/d04/expat_8h.html#a938e186c531ea86ae9adf3c0a649d8fc">base</a>) {
<a name="l00152"></a>00152                     <span class="keywordflow">if</span> (ic &gt;= input_length) {
<a name="l00153"></a>00153                         <span class="keywordflow">throw</span> RangeError (<span class="stringliteral">&quot;punycode_bad_input(1)&quot;</span>);
<a name="l00154"></a>00154                     }
<a name="l00155"></a>00155                     digit = decode_digit(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(ic++));
<a name="l00156"></a>00156 
<a name="l00157"></a>00157                     <span class="keywordflow">if</span> (digit &gt;= base) {
<a name="l00158"></a>00158                         <span class="keywordflow">throw</span> RangeError(<span class="stringliteral">&quot;punycode_bad_input(2)&quot;</span>);
<a name="l00159"></a>00159                     }
<a name="l00160"></a>00160                     <span class="keywordflow">if</span> (digit &gt; Math.floor((maxint - i) / w)) {
<a name="l00161"></a>00161                         <span class="keywordflow">throw</span> RangeError (<span class="stringliteral">&quot;punycode_overflow(1)&quot;</span>);
<a name="l00162"></a>00162                     }
<a name="l00163"></a>00163                     i += digit * w;
<a name="l00164"></a>00164                     t = k &lt;= bias ? tmin : k &gt;= bias + tmax ? tmax : k - bias;
<a name="l00165"></a>00165                     <span class="keywordflow">if</span> (digit &lt; t) { <span class="keywordflow">break</span>; }
<a name="l00166"></a>00166                     <span class="keywordflow">if</span> (w &gt; Math.floor(maxint / (base - t))) {
<a name="l00167"></a>00167                         <span class="keywordflow">throw</span> RangeError(<span class="stringliteral">&quot;punycode_overflow(2)&quot;</span>);
<a name="l00168"></a>00168                     }
<a name="l00169"></a>00169                     w *= (base - t);
<a name="l00170"></a>00170             }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172             out = output.length + 1;
<a name="l00173"></a>00173             bias = adapt(i - oldi, out, oldi === 0);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175             <span class="comment">// i was supposed to wrap around from out to 0,</span>
<a name="l00176"></a>00176             <span class="comment">// incrementing n each time, so we&#39;ll fix that now: </span>
<a name="l00177"></a>00177             <span class="keywordflow">if</span> ( Math.floor(i / out) &gt; maxint - <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l00178"></a>00178                 <span class="keywordflow">throw</span> RangeError(<span class="stringliteral">&quot;punycode_overflow(3)&quot;</span>);
<a name="l00179"></a>00179             }
<a name="l00180"></a>00180             n += Math.floor( i / out ) ;
<a name="l00181"></a>00181             i %= <a class="code" href="../../db/da2/namespacejs.html#ae38c69c83e560d6765bddb6b3d53cc46">out</a>;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183             <span class="comment">// Insert n at position i of the output: </span>
<a name="l00184"></a>00184             <span class="comment">// Case of last character determines uppercase flag: </span>
<a name="l00185"></a>00185             <span class="keywordflow">if</span> (preserveCase) { case_flags.splice(i, 0, <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(ic -1) -65 &lt; 26);}
<a name="l00186"></a>00186 
<a name="l00187"></a>00187             output.splice(i, 0, n);
<a name="l00188"></a>00188             i++;
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190         <span class="keywordflow">if</span> (preserveCase) {
<a name="l00191"></a>00191             <span class="keywordflow">for</span> (i = 0, len = output.length; i &lt; len; i++) {
<a name="l00192"></a>00192                 <span class="keywordflow">if</span> (case_flags[i]) {
<a name="l00193"></a>00193                     output[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] = (String.fromCharCode(output[i]).toUpperCase()).charCodeAt(0);
<a name="l00194"></a>00194                 }
<a name="l00195"></a>00195             }
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197         <span class="keywordflow">return</span> this.utf16.encode(output);
<a name="l00198"></a>00198     };
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="comment">//** Main encode function **</span>
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     this.encode = <span class="keyword">function</span> (<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>,preserveCase) {
<a name="l00203"></a>00203         <span class="comment">//** Bias adaptation function **</span>
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         var <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, delta, h, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>, bias, <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>, m, q, <a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>, t, ijv, case_flags;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         <span class="keywordflow">if</span> (preserveCase) {
<a name="l00208"></a>00208             <span class="comment">// Preserve case, step1 of 2: Get a list of the unaltered string</span>
<a name="l00209"></a>00209             case_flags = this.utf16.decode(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>);
<a name="l00210"></a>00210         }
<a name="l00211"></a>00211         <span class="comment">// Converts the input in UTF-16 to Unicode</span>
<a name="l00212"></a>00212         <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a> = this.utf16.decode(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.toLowerCase());
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         var input_length = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length; <span class="comment">// Cache the length</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (preserveCase) {
<a name="l00217"></a>00217             <span class="comment">// Preserve case, step2 of 2: Modify the list to true/false</span>
<a name="l00218"></a>00218             <span class="keywordflow">for</span> (j=0; j &lt; input_length; j++) {
<a name="l00219"></a>00219                 case_flags[<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>] = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>] != case_flags[<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>];
<a name="l00220"></a>00220             }
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         var output=[];
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         <span class="comment">// Initialize the state: </span>
<a name="l00227"></a>00227         n = initial_n;
<a name="l00228"></a>00228         delta = 0;
<a name="l00229"></a>00229         bias = initial_bias;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="comment">// Handle the basic code points: </span>
<a name="l00232"></a>00232         <span class="keywordflow">for</span> (j = 0; j &lt; input_length; ++<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>) {
<a name="l00233"></a>00233             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>[j] &lt; 0x80) {
<a name="l00234"></a>00234                 output.push(
<a name="l00235"></a>00235                     String.fromCharCode(
<a name="l00236"></a>00236                         case_flags ? encode_basic(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>[j], case_flags[j]) : <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>[j]
<a name="l00237"></a>00237                     )
<a name="l00238"></a>00238                 );
<a name="l00239"></a>00239             }
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         h = b = output.length;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <span class="comment">// h is the number of code points that have been handled, b is the</span>
<a name="l00245"></a>00245         <span class="comment">// number of basic code points </span>
<a name="l00246"></a>00246 
<a name="l00247"></a>00247         <span class="keywordflow">if</span> (b &gt; 0) output.push(delimiter);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249         <span class="comment">// Main encoding loop: </span>
<a name="l00250"></a>00250         <span class="comment">//</span>
<a name="l00251"></a>00251         <span class="keywordflow">while</span> (h &lt; input_length) {
<a name="l00252"></a>00252             <span class="comment">// All non-basic code points &lt; n have been</span>
<a name="l00253"></a>00253             <span class="comment">// handled already. Find the next larger one: </span>
<a name="l00254"></a>00254 
<a name="l00255"></a>00255             <span class="keywordflow">for</span> (m = maxint, j = 0; j &lt; input_length; ++<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>) {
<a name="l00256"></a>00256                 ijv = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>];
<a name="l00257"></a>00257                 <span class="keywordflow">if</span> (ijv &gt;= n &amp;&amp; ijv &lt; m) m = ijv;
<a name="l00258"></a>00258             }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260             <span class="comment">// Increase delta enough to advance the decoder&#39;s</span>
<a name="l00261"></a>00261             <span class="comment">// &lt;n,i&gt; state to &lt;m,0&gt;, but guard against overflow: </span>
<a name="l00262"></a>00262 
<a name="l00263"></a>00263             <span class="keywordflow">if</span> (m - n &gt; Math.floor((maxint - delta) / (h + 1))) {
<a name="l00264"></a>00264                 <span class="keywordflow">throw</span> RangeError(<span class="stringliteral">&quot;punycode_overflow (1)&quot;</span>);
<a name="l00265"></a>00265             }
<a name="l00266"></a>00266             delta += (m - <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) * (h + 1);
<a name="l00267"></a>00267             n = m;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269             <span class="keywordflow">for</span> (j = 0; j &lt; input_length; ++<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>) {
<a name="l00270"></a>00270                 ijv = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>];
<a name="l00271"></a>00271 
<a name="l00272"></a>00272                 <span class="keywordflow">if</span> (ijv &lt; n ) {
<a name="l00273"></a>00273                     <span class="keywordflow">if</span> (++delta &gt; maxint) <span class="keywordflow">return</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;punycode_overflow(2)&quot;</span>);
<a name="l00274"></a>00274                 }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276                 <span class="keywordflow">if</span> (ijv == n) {
<a name="l00277"></a>00277                     <span class="comment">// Represent delta as a generalized variable-length integer: </span>
<a name="l00278"></a>00278                     <span class="keywordflow">for</span> (q = delta, k = base; ; k += <a class="code" href="../../d9/d04/expat_8h.html#a938e186c531ea86ae9adf3c0a649d8fc">base</a>) {
<a name="l00279"></a>00279                         t = k &lt;= bias ? tmin : k &gt;= bias + tmax ? tmax : k - bias;
<a name="l00280"></a>00280                         <span class="keywordflow">if</span> (q &lt; t) <span class="keywordflow">break</span>;
<a name="l00281"></a>00281                         output.push( String.fromCharCode(encode_digit(t + (q - t) % (base - t), 0)) );
<a name="l00282"></a>00282                         q = Math.floor( (q - t) / (base - t) );
<a name="l00283"></a>00283                     }
<a name="l00284"></a>00284                     output.push( String.fromCharCode(encode_digit(q, preserveCase &amp;&amp; case_flags[j] ? 1:0 )));
<a name="l00285"></a>00285                     bias = adapt(delta, h + 1, h == b);
<a name="l00286"></a>00286                     delta = 0;
<a name="l00287"></a>00287                     ++h;
<a name="l00288"></a>00288                 }
<a name="l00289"></a>00289             }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291             ++delta;
<a name="l00292"></a>00292             ++<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>;
<a name="l00293"></a>00293         }
<a name="l00294"></a>00294         <span class="keywordflow">return</span> output.join(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00295"></a>00295     };
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     this.ToASCII = <span class="keyword">function</span> ( domain ) {
<a name="l00298"></a>00298         var domain_array = domain.split(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00299"></a>00299         var out = [];
<a name="l00300"></a>00300         <span class="keywordflow">for</span> (var i=0; i &lt; domain_array.length; ++<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>) {
<a name="l00301"></a>00301             var <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a> = domain_array[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l00302"></a>00302             out.push(
<a name="l00303"></a>00303                 s.match(/[^A-Za-z0-9\-]/) ?
<a name="l00304"></a>00304                 <span class="stringliteral">&quot;xn--&quot;</span> + punycode.encode(s) :
<a name="l00305"></a>00305                 <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>
<a name="l00306"></a>00306             );
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308         <span class="keywordflow">return</span> out.join(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00309"></a>00309     };
<a name="l00310"></a>00310     
<a name="l00311"></a>00311     this.ToUnicode = <span class="keyword">function</span> ( domain ) {
<a name="l00312"></a>00312         var domain_array = domain.split(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00313"></a>00313         var out = [];
<a name="l00314"></a>00314         <span class="keywordflow">for</span> (var i=0; i &lt; domain_array.length; ++<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>) {
<a name="l00315"></a>00315             var s = domain_array[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l00316"></a>00316             out.push(
<a name="l00317"></a>00317                 s.match(/^xn--/) ?
<a name="l00318"></a>00318                 punycode.decode(s.slice(4)) :
<a name="l00319"></a>00319                 s
<a name="l00320"></a>00320             );
<a name="l00321"></a>00321         }
<a name="l00322"></a>00322         <span class="keywordflow">return</span> out.join(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00323"></a>00323     };
<a name="l00324"></a>00324 }();
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = <span class="keyword">function</span>(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>){
<a name="l00327"></a>00327     <span class="keywordflow">return</span> <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.replace(/((?:<a class="code" href="../../da/d88/mock__configurator_8js.html#a143d22e446a0feb4cbd35b8b5e3c8d94">https</a>?:\/\/)?.*\@)?([^\/]*)/, <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a>, <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>, domain){
<a name="l00328"></a>00328         var domainParts = domain.split(/\./).map(punycode.ToASCII);
<a name="l00329"></a>00329         <span class="keywordflow">return</span> (<a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a> || <span class="stringliteral">&quot;&quot;</span>) + domainParts.join(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00330"></a>00330     });
<a name="l00331"></a>00331 };
<a name="l00332"></a>00332 });
<a name="l00333"></a>00333 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailcomposer/lib/dkim&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;crypto&#39;</span>,<span class="stringliteral">&#39;mimelib&#39;</span>,<span class="stringliteral">&#39;./punycode&#39;</span>],<span class="keyword">function</span> (<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l00334"></a>00334 var crypto = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;crypto&#39;</span>),
<a name="l00335"></a>00335     mimelib = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;mimelib&#39;</span>),
<a name="l00336"></a>00336     toPunycode = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;./punycode&#39;</span>);
<a name="l00337"></a>00337 
<a name="l00342"></a>00342 <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports.DKIMSign = DKIMSign;
<a name="l00343"></a>00343 <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports.generateDKIMHeader = generateDKIMHeader;
<a name="l00344"></a>00344 <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports.sha256 = sha256;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 
<a name="l00360"></a>00360 <span class="keyword">function</span> DKIMSign(email, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>){
<a name="l00361"></a>00361     <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> || {};
<a name="l00362"></a>00362     email = (email || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>(<span class="stringliteral">&quot;utf-8&quot;</span>);
<a name="l00363"></a>00363     
<a name="l00364"></a>00364     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a> = email.match(/^\r?\n|(?:\r?\n){2}/),
<a name="l00365"></a>00365         <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a> = match &amp;&amp; email.substr(0, match.index) || <span class="stringliteral">&quot;&quot;</span>,
<a name="l00366"></a>00366         body = match &amp;&amp; email.substr(match.index + match[0].length) || email;
<a name="l00367"></a>00367     
<a name="l00368"></a>00368     <span class="comment">// all listed fields from RFC4871 #5.5</span>
<a name="l00369"></a>00369     var defaultFieldNames = <span class="stringliteral">&quot;From:Sender:Reply-To:Subject:Date:Message-ID:To:&quot;</span> +
<a name="l00370"></a>00370             <span class="stringliteral">&quot;Cc:MIME-Version:Content-Type:Content-Transfer-Encoding:Content-ID:&quot;</span> +
<a name="l00371"></a>00371             <span class="stringliteral">&quot;Content-Description:Resent-Date:Resent-From:Resent-Sender:&quot;</span> +
<a name="l00372"></a>00372             <span class="stringliteral">&quot;Resent-To:Resent-Cc:Resent-Message-ID:In-Reply-To:References:&quot;</span> +
<a name="l00373"></a>00373             <span class="stringliteral">&quot;List-Id:List-Help:List-Unsubscribe:List-Subscribe:List-Post:&quot;</span> +
<a name="l00374"></a>00374             <span class="stringliteral">&quot;List-Owner:List-Archive&quot;</span>;
<a name="l00375"></a>00375     
<a name="l00376"></a>00376     var dkim = generateDKIMHeader(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.domainName, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.keySelector, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.headerFieldNames || defaultFieldNames, <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, body),
<a name="l00377"></a>00377         canonicalizedHeaderData = DKIMCanonicalizer.relaxedHeaders(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.headerFieldNames || defaultFieldNames),
<a name="l00378"></a>00378         canonicalizedDKIMHeader = DKIMCanonicalizer.relaxedHeaderLine(dkim),
<a name="l00379"></a>00379         signer, signature;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     canonicalizedHeaderData.headers +=  canonicalizedDKIMHeader.key+<span class="stringliteral">&quot;:&quot;</span>+canonicalizedDKIMHeader.value;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     signer = crypto.createSign(<span class="stringliteral">&quot;RSA-SHA256&quot;</span>);
<a name="l00384"></a>00384     signer.update(canonicalizedHeaderData.headers);
<a name="l00385"></a>00385     signature = signer.sign(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.privateKey, <span class="stringliteral">&#39;base64&#39;</span>);
<a name="l00386"></a>00386     
<a name="l00387"></a>00387     <span class="keywordflow">return</span> dkim + signature.replace(/(.{76}(?!\r?\n|\r))/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>,<span class="stringliteral">&quot;$&amp;\r\n        &quot;</span>);
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 
<a name="l00403"></a>00403 <span class="keyword">function</span> generateDKIMHeader(domainName, keySelector, headerFieldNames, <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, body){
<a name="l00404"></a>00404     var canonicalizedBody = DKIMCanonicalizer.relaxedBody(body),
<a name="l00405"></a>00405         canonicalizedBodyHash = sha256(canonicalizedBody, <span class="stringliteral">&quot;base64&quot;</span>),
<a name="l00406"></a>00406         canonicalizedHeaderData = DKIMCanonicalizer.relaxedHeaders(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, headerFieldNames),
<a name="l00407"></a>00407         dkim;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="keywordflow">if</span>(hasUTFChars(domainName)){
<a name="l00410"></a>00410         domainName = toPunycode(domainName);
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     dkim = [
<a name="l00414"></a>00414         <span class="stringliteral">&quot;v=1&quot;</span>,
<a name="l00415"></a>00415         <span class="stringliteral">&quot;a=rsa-sha256&quot;</span>,
<a name="l00416"></a>00416         <span class="stringliteral">&quot;c=relaxed/relaxed&quot;</span>,
<a name="l00417"></a>00417         <span class="stringliteral">&quot;d=&quot;</span>+domainName,
<a name="l00418"></a>00418         <span class="stringliteral">&quot;q=dns/txt&quot;</span>,
<a name="l00419"></a>00419         <span class="stringliteral">&quot;s=&quot;</span>+keySelector,
<a name="l00420"></a>00420         <span class="stringliteral">&quot;bh=&quot;</span>+canonicalizedBodyHash,
<a name="l00421"></a>00421         <span class="stringliteral">&quot;h=&quot;</span>+canonicalizedHeaderData.fieldNames
<a name="l00422"></a>00422     ].join(<span class="stringliteral">&quot;; &quot;</span>);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="keywordflow">return</span> mimelib.foldLine(<span class="stringliteral">&quot;DKIM-Signature: &quot;</span> + dkim, 76)+<span class="stringliteral">&quot;;\r\n        b=&quot;</span>;
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00433"></a>00433 var DKIMCanonicalizer = {
<a name="l00434"></a>00434    
<a name="l00441"></a>00441     simpleBody: <span class="keyword">function</span>(body){
<a name="l00442"></a>00442         <span class="keywordflow">return</span> (body || <span class="stringliteral">&quot;&quot;</span>).toString().replace(/(?:\r?\n|\r)*$/, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l00443"></a>00443     },
<a name="l00444"></a>00444     
<a name="l00451"></a>00451     relaxedBody: <span class="keyword">function</span>(body){
<a name="l00452"></a>00452         <span class="keywordflow">return</span> (body || <span class="stringliteral">&quot;&quot;</span>).toString().
<a name="l00453"></a>00453                 <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/\r?\n|\r/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot;\n&quot;</span>).
<a name="l00454"></a>00454                 split(<span class="stringliteral">&quot;\n&quot;</span>).
<a name="l00455"></a>00455                 map(<span class="keyword">function</span>(<a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>){
<a name="l00456"></a>00456                     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>.replace(/\s*$/, <span class="stringliteral">&quot;&quot;</span>). <span class="comment">//rtrim</span>
<a name="l00457"></a>00457                                 <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/\s+/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot; &quot;</span>); <span class="comment">// only single spaces</span>
<a name="l00458"></a>00458                 }).
<a name="l00459"></a>00459                 <a class="code" href="../../de/d11/path_8js.html#a9c4b06c29cf28f47c4f54ed4e30c85b3">join</a>(<span class="stringliteral">&quot;\n&quot;</span>).
<a name="l00460"></a>00460                 <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/\n*$/, <span class="stringliteral">&quot;\n&quot;</span>).
<a name="l00461"></a>00461                 <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/\n/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l00462"></a>00462     },
<a name="l00463"></a>00463     
<a name="l00470"></a>00470     relaxedHeaders: <span class="keyword">function</span>(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, fieldNames){
<a name="l00471"></a>00471         var includedFields = (fieldNames || <span class="stringliteral">&quot;&quot;</span>).toLowerCase().
<a name="l00472"></a>00472                                 split(<span class="stringliteral">&quot;:&quot;</span>).
<a name="l00473"></a>00473                                 map(<span class="keyword">function</span>(field){
<a name="l00474"></a>00474                                     <span class="keywordflow">return</span> field.trim();
<a name="l00475"></a>00475                                 }),
<a name="l00476"></a>00476             headerFields = {},
<a name="l00477"></a>00477             headerLines = <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.split(/\r?\n|\r/),
<a name="l00478"></a>00478             <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>, <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l00479"></a>00479         
<a name="l00480"></a>00480         <span class="comment">// join lines</span>
<a name="l00481"></a>00481         <span class="keywordflow">for</span>(i = headerLines.length-1; i&gt;=0; i--){
<a name="l00482"></a>00482             <span class="keywordflow">if</span>(i &amp;&amp; headerLines[i].<a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>(/^\s/)){
<a name="l00483"></a>00483                 headerLines[i-1] += headerLines.splice(i,1);
<a name="l00484"></a>00484             }<span class="keywordflow">else</span>{
<a name="l00485"></a>00485                 <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a> = DKIMCanonicalizer.relaxedHeaderLine(headerLines[i]);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487                 <span class="comment">// on multiple values, include only the first one (the one in the bottom of the list)</span>
<a name="l00488"></a>00488                 <span class="keywordflow">if</span>(includedFields.indexOf(<a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>.key) &gt;= 0 &amp;&amp; !(<a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>.key in headerFields)){
<a name="l00489"></a>00489                     headerFields[<a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>.key] = <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>.value;
<a name="l00490"></a>00490                 }
<a name="l00491"></a>00491             }
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a> = [];
<a name="l00495"></a>00495         <span class="keywordflow">for</span>(i = includedFields.length-1; i&gt;=0; i--){
<a name="l00496"></a>00496             <span class="keywordflow">if</span>(!headerFields[includedFields[i]]){
<a name="l00497"></a>00497                 includedFields.splice(i,1);
<a name="l00498"></a>00498             }<span class="keywordflow">else</span>{
<a name="l00499"></a>00499                 <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.unshift(includedFields[i]+<span class="stringliteral">&quot;:&quot;</span>+headerFields[includedFields[i]]);
<a name="l00500"></a>00500             }
<a name="l00501"></a>00501         }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         <span class="keywordflow">return</span> {
<a name="l00504"></a>00504             <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>: <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.join(<span class="stringliteral">&quot;\r\n&quot;</span>)+<span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l00505"></a>00505             fieldNames: includedFields.join(<span class="stringliteral">&quot;:&quot;</span>)
<a name="l00506"></a>00506         };
<a name="l00507"></a>00507     },
<a name="l00508"></a>00508     
<a name="l00515"></a>00515     relaxedHeaderLine: <span class="keyword">function</span>(<a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>){
<a name="l00516"></a>00516         var <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>.split(<span class="stringliteral">&quot;:&quot;</span>),
<a name="l00517"></a>00517             <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = (value.shift() || <span class="stringliteral">&quot;&quot;</span>).toLowerCase().trim();
<a name="l00518"></a>00518         
<a name="l00519"></a>00519         value = value.join(<span class="stringliteral">&quot;:&quot;</span>).replace(/\s+/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot; &quot;</span>).trim();
<a name="l00520"></a>00520         
<a name="l00521"></a>00521         <span class="keywordflow">return</span> {<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>: <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, value: value};
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523 };
<a name="l00524"></a>00524 <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports.DKIMCanonicalizer = DKIMCanonicalizer;
<a name="l00525"></a>00525 
<a name="l00533"></a>00533 <span class="keyword">function</span> sha256(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, <a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>){
<a name="l00534"></a>00534     var shasum = crypto.createHash(<span class="stringliteral">&#39;sha256&#39;</span>);
<a name="l00535"></a>00535     shasum.update(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l00536"></a>00536     <span class="keywordflow">return</span> shasum.digest(<a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a> || <span class="stringliteral">&quot;hex&quot;</span>);
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 
<a name="l00540"></a>00540 
<a name="l00547"></a>00547 <span class="keyword">function</span> hasUTFChars(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>){
<a name="l00548"></a>00548     var rforeign = /[^\u0000-\u007f]/;
<a name="l00549"></a>00549     <span class="keywordflow">return</span> !!rforeign.test(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 });
<a name="l00552"></a>00552 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;http&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l00553"></a>00553 });
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;https&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l00556"></a>00556 });
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;url&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l00559"></a>00559 });
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailcomposer/lib/urlfetch&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;http&#39;</span>,<span class="stringliteral">&#39;https&#39;</span>,<span class="stringliteral">&#39;url&#39;</span>,<span class="stringliteral">&#39;stream&#39;</span>],<span class="keyword">function</span> (<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l00562"></a>00562 var <a class="code" href="../../da/d0f/server__child_8js.html#a55f22d498ca401fddca364855629d1d3">http</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;http&#39;</span>),
<a name="l00563"></a>00563     <a class="code" href="../../da/d88/mock__configurator_8js.html#a143d22e446a0feb4cbd35b8b5e3c8d94">https</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;https&#39;</span>),
<a name="l00564"></a>00564     urllib = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;url&#39;</span>),
<a name="l00565"></a>00565     Stream = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;stream&#39;</span>).Stream;
<a name="l00566"></a>00566 
<a name="l00571"></a>00571 <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = openUrlStream;
<a name="l00572"></a>00572 
<a name="l00582"></a>00582 <span class="keyword">function</span> openUrlStream(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>){
<a name="l00583"></a>00583     <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> || {};
<a name="l00584"></a>00584     var urlparts = urllib.parse(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>),
<a name="l00585"></a>00585         urloptions = {
<a name="l00586"></a>00586             host: urlparts.hostname,
<a name="l00587"></a>00587             <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: urlparts.port || (urlparts.protocol==<span class="stringliteral">&quot;https:&quot;</span>?443:80),
<a name="l00588"></a>00588             <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: urlparts.path || urlparts.pathname,
<a name="l00589"></a>00589             method: <span class="stringliteral">&quot;GET&quot;</span>,
<a name="l00590"></a>00590             <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>: {
<a name="l00591"></a>00591                 <span class="stringliteral">&quot;User-Agent&quot;</span>: <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.userAgent || <span class="stringliteral">&quot;mailcomposer&quot;</span>
<a name="l00592"></a>00592             }
<a name="l00593"></a>00593         },
<a name="l00594"></a>00594         client = (urlparts.protocol==<span class="stringliteral">&quot;https:&quot;</span>?<a class="code" href="../../da/d88/mock__configurator_8js.html#a143d22e446a0feb4cbd35b8b5e3c8d94">https</a>:<a class="code" href="../../da/d0f/server__child_8js.html#a55f22d498ca401fddca364855629d1d3">http</a>),
<a name="l00595"></a>00595         stream = <span class="keyword">new</span> Stream(),
<a name="l00596"></a>00596         <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a>;
<a name="l00597"></a>00597     
<a name="l00598"></a>00598     stream.resume = <span class="keyword">function</span>(){};
<a name="l00599"></a>00599         
<a name="l00600"></a>00600     <span class="keywordflow">if</span>(urlparts.auth){
<a name="l00601"></a>00601         urloptions.auth = urlparts.auth;
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603     
<a name="l00604"></a>00604     <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a> = client.request(urloptions, <span class="keyword">function</span>(response) {
<a name="l00605"></a>00605         <span class="keywordflow">if</span>((response.statusCode || 0).toString().charAt(0) != <span class="stringliteral">&quot;2&quot;</span>){
<a name="l00606"></a>00606             stream.emit(<span class="stringliteral">&quot;error&quot;</span>, <span class="stringliteral">&quot;Invalid status code &quot;</span> + (response.statusCode || 0));
<a name="l00607"></a>00607             <span class="keywordflow">return</span>;
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         response.on(<span class="stringliteral">&#39;error&#39;</span>, <span class="keyword">function</span>(err) {
<a name="l00611"></a>00611             stream.emit(<span class="stringliteral">&quot;error&quot;</span>, err);
<a name="l00612"></a>00612         });
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         response.on(<span class="stringliteral">&#39;data&#39;</span>, <span class="keyword">function</span>(chunk) {
<a name="l00615"></a>00615             stream.emit(<span class="stringliteral">&quot;data&quot;</span>, chunk);
<a name="l00616"></a>00616         });
<a name="l00617"></a>00617         
<a name="l00618"></a>00618         response.on(<span class="stringliteral">&#39;end&#39;</span>, <span class="keyword">function</span>(chunk) {
<a name="l00619"></a>00619             <span class="keywordflow">if</span>(chunk){
<a name="l00620"></a>00620                 stream.emit(<span class="stringliteral">&quot;data&quot;</span>, chunk);
<a name="l00621"></a>00621             }
<a name="l00622"></a>00622             stream.emit(<span class="stringliteral">&quot;end&quot;</span>);
<a name="l00623"></a>00623         });
<a name="l00624"></a>00624     });
<a name="l00625"></a>00625     <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a>.end();
<a name="l00626"></a>00626     
<a name="l00627"></a>00627     <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a>.on(<span class="stringliteral">&#39;error&#39;</span>, <span class="keyword">function</span>(err) {
<a name="l00628"></a>00628         stream.emit(<span class="stringliteral">&quot;error&quot;</span>, err);
<a name="l00629"></a>00629     });
<a name="l00630"></a>00630     
<a name="l00631"></a>00631     <span class="keywordflow">return</span> stream; 
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 });
<a name="l00634"></a>00634 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;fs&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l00635"></a>00635 });
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailcomposer/lib/mailcomposer&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;stream&#39;</span>,<span class="stringliteral">&#39;util&#39;</span>,<span class="stringliteral">&#39;mimelib&#39;</span>,<span class="stringliteral">&#39;./punycode&#39;</span>,<span class="stringliteral">&#39;./dkim&#39;</span>,<span class="stringliteral">&#39;./urlfetch&#39;</span>,<span class="stringliteral">&#39;fs&#39;</span>],<span class="keyword">function</span> (<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l00638"></a>00638 var Stream = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;stream&#39;</span>).Stream,
<a name="l00639"></a>00639     utillib = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;util&#39;</span>),
<a name="l00640"></a>00640     mimelib = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;mimelib&#39;</span>),
<a name="l00641"></a>00641     toPunycode = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;./punycode&#39;</span>),
<a name="l00642"></a>00642     DKIMSign = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;./dkim&#39;</span>).DKIMSign,
<a name="l00643"></a>00643     urlFetch = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;./urlfetch&#39;</span>),
<a name="l00644"></a>00644     <a class="code" href="../../dd/dfd/build__stage_2email_2shared_2test_2integration_2profile__builder_8js.html#a229733b8ea40200fae09e883376030bf">fs</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;fs&#39;</span>);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646 <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports.MailComposer = MailComposer;
<a name="l00647"></a>00647 
<a name="l00671"></a>00671 <span class="keyword">function</span> MailComposer(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>){
<a name="l00672"></a>00672     Stream.call(<span class="keyword">this</span>);
<a name="l00673"></a>00673     
<a name="l00674"></a>00674     this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> || {};
<a name="l00675"></a>00675     
<a name="l00676"></a>00676     this.<a class="code" href="../../de/dba/mock__keyboard__helper_8js.html#a5c1f8f127ecb0433e33894376d015109">_init</a>();
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 utillib.inherits(MailComposer, Stream);
<a name="l00679"></a>00679 
<a name="l00683"></a>00683 MailComposer.prototype._init = <span class="keyword">function</span>(){
<a name="l00688"></a>00688     this._headers = {};
<a name="l00689"></a>00689     
<a name="l00694"></a>00694     this._message = {};
<a name="l00695"></a>00695     
<a name="l00700"></a>00700     this._attachments = [];
<a name="l00701"></a>00701     
<a name="l00706"></a>00706     this._relatedAttachments = [];
<a name="l00707"></a>00707     
<a name="l00712"></a>00712     this._envelope = {};
<a name="l00713"></a>00713     
<a name="l00718"></a>00718     this._cacheOutput = <span class="keyword">false</span>;
<a name="l00719"></a>00719     
<a name="l00724"></a>00724     this._outputBuffer = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00725"></a>00725     
<a name="l00730"></a>00730     this._dkim = <span class="keyword">false</span>;
<a name="l00731"></a>00731     
<a name="l00736"></a>00736     this._gencounter = 0;
<a name="l00737"></a>00737     
<a name="l00738"></a>00738     this.addHeader(<span class="stringliteral">&quot;MIME-Version&quot;</span>, <span class="stringliteral">&quot;1.0&quot;</span>);
<a name="l00739"></a>00739 };
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 <span class="comment">/* PUBLIC API */</span>
<a name="l00742"></a>00742 
<a name="l00749"></a>00749 MailComposer.prototype.addHeader = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>){
<a name="l00750"></a>00750     <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = this._normalizeKey(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>);
<a name="l00751"></a>00751     
<a name="l00752"></a>00752     <span class="keywordflow">if</span>(value &amp;&amp; Object.prototype.toString.call(value) == <span class="stringliteral">&quot;[object Object]&quot;</span>){
<a name="l00753"></a>00753         value = this._encodeMimeWord(JSON.stringify(value), <span class="stringliteral">&quot;Q&quot;</span>, 52);
<a name="l00754"></a>00754     }<span class="keywordflow">else</span>{
<a name="l00755"></a>00755         value = (value || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>().trim();
<a name="l00756"></a>00756     }
<a name="l00757"></a>00757     
<a name="l00758"></a>00758     <span class="keywordflow">if</span>(!<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> || !value){
<a name="l00759"></a>00759         <span class="keywordflow">return</span>;
<a name="l00760"></a>00760     }
<a name="l00761"></a>00761     
<a name="l00762"></a>00762     <span class="keywordflow">if</span>(!(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in this._headers)){
<a name="l00763"></a>00763         this._headers[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l00764"></a>00764     }<span class="keywordflow">else</span>{
<a name="l00765"></a>00765         <span class="keywordflow">if</span>(!Array.isArray(<span class="keyword">this</span>._headers[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>])){
<a name="l00766"></a>00766             this._headers[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = [this._headers[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>], <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>];
<a name="l00767"></a>00767         }<span class="keywordflow">else</span>{
<a name="l00768"></a>00768             this._headers[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>].push(value);
<a name="l00769"></a>00769         }
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771 };
<a name="l00772"></a>00772 
<a name="l00793"></a>00793 MailComposer.prototype.setMessageOption = <span class="keyword">function</span>(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>){
<a name="l00794"></a>00794     var fields = [<span class="stringliteral">&quot;from&quot;</span>, <span class="stringliteral">&quot;to&quot;</span>, <span class="stringliteral">&quot;cc&quot;</span>, <span class="stringliteral">&quot;bcc&quot;</span>, <span class="stringliteral">&quot;replyTo&quot;</span>, <span class="stringliteral">&quot;inReplyTo&quot;</span>, <span class="stringliteral">&quot;references&quot;</span>, <span class="stringliteral">&quot;subject&quot;</span>, <span class="stringliteral">&quot;body&quot;</span>, <span class="stringliteral">&quot;html&quot;</span>, <span class="stringliteral">&quot;envelope&quot;</span>],
<a name="l00795"></a>00795         rewrite = {<span class="stringliteral">&quot;sender&quot;</span>:<span class="stringliteral">&quot;from&quot;</span>, <span class="stringliteral">&quot;reply_to&quot;</span>:<span class="stringliteral">&quot;replyTo&quot;</span>, <span class="stringliteral">&quot;text&quot;</span>:<span class="stringliteral">&quot;body&quot;</span>};
<a name="l00796"></a>00796     
<a name="l00797"></a>00797     <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> || {};
<a name="l00798"></a>00798     
<a name="l00799"></a>00799     var <a class="code" href="../../dc/d33/namespaceread_j_s_o_n.html#a5b3073959c18dcb060a912824297e59d">keys</a> = Object.keys(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>), <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l00800"></a>00800     <span class="keywordflow">for</span>(var i=0, len=keys.length; i&lt;len; i++){
<a name="l00801"></a>00801         <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = keys[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l00802"></a>00802         value = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l00803"></a>00803         
<a name="l00804"></a>00804         <span class="keywordflow">if</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in rewrite){
<a name="l00805"></a>00805             <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = rewrite[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l00806"></a>00806         }
<a name="l00807"></a>00807         
<a name="l00808"></a>00808         <span class="keywordflow">if</span>(fields.indexOf(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>) &gt;= 0){
<a name="l00809"></a>00809             this._message[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = this._handleValue(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, value);
<a name="l00810"></a>00810         }
<a name="l00811"></a>00811     }
<a name="l00812"></a>00812 };
<a name="l00813"></a>00813 
<a name="l00824"></a>00824 MailComposer.prototype.useDKIM = <span class="keyword">function</span>(dkim){
<a name="l00825"></a>00825     this._dkim = dkim || {};
<a name="l00826"></a>00826     this._cacheOutput = <span class="keyword">true</span>;
<a name="l00827"></a>00827 };
<a name="l00828"></a>00828 
<a name="l00848"></a>00848 MailComposer.prototype.addAttachment = <span class="keyword">function</span>(attachment){
<a name="l00849"></a>00849     attachment = attachment || {};
<a name="l00850"></a>00850     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>;
<a name="l00851"></a>00851     
<a name="l00852"></a>00852     <span class="comment">// Needed for Nodemailer compatibility</span>
<a name="l00853"></a>00853     <span class="keywordflow">if</span>(attachment.filename){
<a name="l00854"></a>00854         attachment.fileName = attachment.filename;
<a name="l00855"></a>00855         <span class="keyword">delete</span> attachment.filename;
<a name="l00856"></a>00856     }
<a name="l00857"></a>00857     
<a name="l00858"></a>00858     <span class="keywordflow">if</span>(!attachment.fileName &amp;&amp; attachment.filePath){
<a name="l00859"></a>00859         attachment.fileName = attachment.filePath.split(/[\/\\]/).pop();
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861     
<a name="l00862"></a>00862     <span class="keywordflow">if</span>(!attachment.contentType){
<a name="l00863"></a>00863         filename = attachment.fileName || attachment.filePath;
<a name="l00864"></a>00864         <span class="keywordflow">if</span>(filename){
<a name="l00865"></a>00865             attachment.contentType = this._getMimeType(filename);
<a name="l00866"></a>00866         }<span class="keywordflow">else</span>{
<a name="l00867"></a>00867             attachment.contentType = <span class="stringliteral">&quot;application/octet-stream&quot;</span>;
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869     }
<a name="l00870"></a>00870     
<a name="l00871"></a>00871     <span class="keywordflow">if</span>(attachment.streamSource){
<a name="l00872"></a>00872         <span class="comment">// check for pause and resume support</span>
<a name="l00873"></a>00873         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> attachment.streamSource.pause != <span class="stringliteral">&quot;function&quot;</span> || 
<a name="l00874"></a>00874           <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> attachment.streamSource.resume != <span class="stringliteral">&quot;function&quot;</span>){
<a name="l00875"></a>00875             <span class="comment">// Unsupported Stream source, skip it</span>
<a name="l00876"></a>00876             <span class="keywordflow">return</span>;
<a name="l00877"></a>00877         }
<a name="l00878"></a>00878         attachment.streamSource.pause();
<a name="l00879"></a>00879     }
<a name="l00880"></a>00880     
<a name="l00881"></a>00881     <span class="keywordflow">if</span>(attachment.filePath || attachment.contents || attachment.streamSource){
<a name="l00882"></a>00882         this._attachments.push(attachment);
<a name="l00883"></a>00883     }
<a name="l00884"></a>00884 };
<a name="l00885"></a>00885 
<a name="l00904"></a>00904 MailComposer.prototype.getEnvelope = <span class="keyword">function</span>(){
<a name="l00905"></a>00905     var envelope = {},
<a name="l00906"></a>00906         toKeys = [<span class="stringliteral">&quot;to&quot;</span>, <span class="stringliteral">&quot;cc&quot;</span>, <span class="stringliteral">&quot;bcc&quot;</span>],
<a name="l00907"></a>00907         <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>;
<a name="l00908"></a>00908     
<a name="l00909"></a>00909     <span class="comment">// If multiple addresses, only use the first one</span>
<a name="l00910"></a>00910     <span class="keywordflow">if</span>(this._envelope.from &amp;&amp; <span class="keyword">this</span>._envelope.from.length){
<a name="l00911"></a>00911         envelope.from = [].concat(this._envelope.from).shift();
<a name="l00912"></a>00912     }
<a name="l00913"></a>00913     
<a name="l00914"></a>00914     <span class="keywordflow">for</span>(var i=0, len=toKeys.length; i&lt;len; i++){
<a name="l00915"></a>00915         <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = toKeys[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l00916"></a>00916         <span class="keywordflow">if</span>(this._envelope[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] &amp;&amp; this._envelope[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>].<a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>){
<a name="l00917"></a>00917             <span class="keywordflow">if</span>(!envelope.to){
<a name="l00918"></a>00918                 envelope.to = [];
<a name="l00919"></a>00919             }
<a name="l00920"></a>00920             envelope.to = envelope.to.concat(this._envelope[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]);
<a name="l00921"></a>00921         }
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923     
<a name="l00924"></a>00924     <span class="comment">// every envelope needs a stamp :)</span>
<a name="l00925"></a>00925     envelope.stamp = <span class="stringliteral">&quot;Postage paid, Par Avion&quot;</span>;
<a name="l00926"></a>00926     
<a name="l00927"></a>00927     <span class="keywordflow">return</span> envelope;
<a name="l00928"></a>00928 };
<a name="l00929"></a>00929 
<a name="l00933"></a>00933 MailComposer.prototype.streamMessage = <span class="keyword">function</span>(){
<a name="l00934"></a>00934     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.nextTick(this._composeMessage.bind(<span class="keyword">this</span>));
<a name="l00935"></a>00935 };
<a name="l00936"></a>00936 
<a name="l00937"></a>00937 <span class="comment">/* PRIVATE API */</span>
<a name="l00938"></a>00938 
<a name="l00946"></a>00946 MailComposer.prototype._handleValue = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>){
<a name="l00947"></a>00947     <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = (<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>();
<a name="l00948"></a>00948     
<a name="l00949"></a>00949     var addresses;
<a name="l00950"></a>00950     
<a name="l00951"></a>00951     <span class="keywordflow">switch</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>){
<a name="l00952"></a>00952         <span class="keywordflow">case</span> <span class="stringliteral">&quot;from&quot;</span>:
<a name="l00953"></a>00953         <span class="keywordflow">case</span> <span class="stringliteral">&quot;to&quot;</span>:
<a name="l00954"></a>00954         <span class="keywordflow">case</span> <span class="stringliteral">&quot;cc&quot;</span>:
<a name="l00955"></a>00955         <span class="keywordflow">case</span> <span class="stringliteral">&quot;bcc&quot;</span>:
<a name="l00956"></a>00956         <span class="keywordflow">case</span> <span class="stringliteral">&quot;replyTo&quot;</span>:
<a name="l00957"></a>00957             value = (value || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>().replace(/\r?\n|\r/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00958"></a>00958             addresses = mimelib.parseAddresses(value);
<a name="l00959"></a>00959             <span class="keywordflow">if</span>(!this._envelope.userDefined){
<a name="l00960"></a>00960                 this._envelope[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = addresses.map((<span class="keyword">function</span>(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>){
<a name="l00961"></a>00961                     <span class="keywordflow">if</span>(this._hasUTFChars(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address)){
<a name="l00962"></a>00962                         <span class="keywordflow">return</span> toPunycode(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address);
<a name="l00963"></a>00963                     }<span class="keywordflow">else</span>{
<a name="l00964"></a>00964                         <span class="keywordflow">return</span> <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address;
<a name="l00965"></a>00965                     }
<a name="l00966"></a>00966                 }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l00967"></a>00967             }
<a name="l00968"></a>00968             <span class="keywordflow">return</span> this._convertAddresses(addresses);
<a name="l00969"></a>00969         
<a name="l00970"></a>00970         <span class="keywordflow">case</span> <span class="stringliteral">&quot;inReplyTo&quot;</span>:
<a name="l00971"></a>00971             value = (value || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>().replace(/\s/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00972"></a>00972             <span class="keywordflow">if</span>(value.charAt(0)!=<span class="stringliteral">&quot;&lt;&quot;</span>){
<a name="l00973"></a>00973                 value = <span class="stringliteral">&quot;&lt;&quot;</span>+<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l00974"></a>00974             }
<a name="l00975"></a>00975             <span class="keywordflow">if</span>(value.charAt(value.length-1)!=<span class="stringliteral">&quot;&gt;&quot;</span>){
<a name="l00976"></a>00976                 value = value + <span class="stringliteral">&quot;&gt;&quot;</span>;
<a name="l00977"></a>00977             }
<a name="l00978"></a>00978             <span class="keywordflow">return</span> <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980         <span class="keywordflow">case</span> <span class="stringliteral">&quot;references&quot;</span>:
<a name="l00981"></a>00981             value = [].concat.apply([], [].concat(value || <span class="stringliteral">&quot;&quot;</span>).map(<span class="keyword">function</span>(elm){
<a name="l00982"></a>00982                 elm = (elm || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>().<a class="code" href="../../d4/d23/binary__string__view_8js.html#ac7106a90f1d2ff063c3561a32c177ec0">trim</a>();
<a name="l00983"></a>00983                 <span class="keywordflow">return</span> elm.replace(/&lt;[^&gt;]*&gt;/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>,<span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>){
<a name="l00984"></a>00984                     <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.replace(/\s/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00985"></a>00985                 }).split(/\s+/);
<a name="l00986"></a>00986             })).map(<span class="keyword">function</span>(elm){
<a name="l00987"></a>00987                 elm = (elm || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>().trim();
<a name="l00988"></a>00988                 <span class="keywordflow">if</span>(elm.charAt(0) != <span class="stringliteral">&quot;&lt;&quot;</span>){
<a name="l00989"></a>00989                     elm = <span class="stringliteral">&quot;&lt;&quot;</span> + elm;
<a name="l00990"></a>00990                 }
<a name="l00991"></a>00991                 <span class="keywordflow">if</span>(elm.charAt(elm.length-1) != <span class="stringliteral">&quot;&gt;&quot;</span>){
<a name="l00992"></a>00992                     elm = elm + <span class="stringliteral">&quot;&gt;&quot;</span>;
<a name="l00993"></a>00993                 }
<a name="l00994"></a>00994                 <span class="keywordflow">return</span> elm;
<a name="l00995"></a>00995             });
<a name="l00996"></a>00996 
<a name="l00997"></a>00997             <span class="keywordflow">return</span> value.join(<span class="stringliteral">&quot; &quot;</span>).trim();
<a name="l00998"></a>00998 
<a name="l00999"></a>00999         <span class="keywordflow">case</span> <span class="stringliteral">&quot;subject&quot;</span>:
<a name="l01000"></a>01000             value = (value || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>().replace(/\r?\n|\r/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01001"></a>01001             <span class="keywordflow">return</span> this._encodeMimeWord(value, <span class="stringliteral">&quot;Q&quot;</span>, 52);
<a name="l01002"></a>01002             
<a name="l01003"></a>01003         <span class="keywordflow">case</span> <span class="stringliteral">&quot;envelope&quot;</span>:
<a name="l01004"></a>01004             
<a name="l01005"></a>01005             this._envelope = {
<a name="l01006"></a>01006                 userDefined: <span class="keyword">true</span>
<a name="l01007"></a>01007             };
<a name="l01008"></a>01008             
<a name="l01009"></a>01009             Object.keys(value).forEach((<span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>){
<a name="l01010"></a>01010                 
<a name="l01011"></a>01011                 this._envelope[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = [];
<a name="l01012"></a>01012                 
<a name="l01013"></a>01013                 [].concat(value[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]).forEach((<span class="keyword">function</span>(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>){
<a name="l01014"></a>01014                     var addresses = mimelib.parseAddresses(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>);
<a name="l01015"></a>01015                 
<a name="l01016"></a>01016                     this._envelope[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = this._envelope[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>].concat(addresses.map((<span class="keyword">function</span>(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>){
<a name="l01017"></a>01017                         <span class="keywordflow">if</span>(<span class="keyword">this</span>._hasUTFChars(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address)){
<a name="l01018"></a>01018                             <span class="keywordflow">return</span> toPunycode(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address);
<a name="l01019"></a>01019                         }<span class="keywordflow">else</span>{
<a name="l01020"></a>01020                             <span class="keywordflow">return</span> <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address;
<a name="l01021"></a>01021                         }
<a name="l01022"></a>01022                     }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>)));
<a name="l01023"></a>01023                     
<a name="l01024"></a>01024                 }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01025"></a>01025             }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01026"></a>01026             <span class="keywordflow">break</span>;
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028     
<a name="l01029"></a>01029     <span class="keywordflow">return</span> <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l01030"></a>01030 };
<a name="l01031"></a>01031 
<a name="l01038"></a>01038 MailComposer.prototype._convertAddresses = <span class="keyword">function</span>(addresses){
<a name="l01039"></a>01039     var values = [], <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>;
<a name="l01040"></a>01040     
<a name="l01041"></a>01041     <span class="keywordflow">for</span>(var i=0, len=addresses.length; i&lt;len; i++){
<a name="l01042"></a>01042         <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a> = addresses[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01043"></a>01043         
<a name="l01044"></a>01044         <span class="keywordflow">if</span>(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address){
<a name="l01045"></a>01045         
<a name="l01046"></a>01046             <span class="comment">// if user part of the address contains foreign symbols</span>
<a name="l01047"></a>01047             <span class="comment">// make a mime word of it</span>
<a name="l01048"></a>01048             <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address = <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address.replace(/^.*?(?=\@)/, (<span class="keyword">function</span>(<a class="code" href="../../de/d8f/jsdebug_8h.html#ad8babe1ecde8f9f6d224a06ea1a99480">user</a>){
<a name="l01049"></a>01049                 <span class="keywordflow">if</span>(this._hasUTFChars(<a class="code" href="../../de/d8f/jsdebug_8h.html#ad8babe1ecde8f9f6d224a06ea1a99480">user</a>)){
<a name="l01050"></a>01050                     <span class="keywordflow">return</span> mimelib.encodeMimeWord(<a class="code" href="../../de/d8f/jsdebug_8h.html#ad8babe1ecde8f9f6d224a06ea1a99480">user</a>, <span class="stringliteral">&quot;Q&quot;</span>);
<a name="l01051"></a>01051                 }<span class="keywordflow">else</span>{
<a name="l01052"></a>01052                     <span class="keywordflow">return</span> <a class="code" href="../../de/d8f/jsdebug_8h.html#ad8babe1ecde8f9f6d224a06ea1a99480">user</a>;
<a name="l01053"></a>01053                 }
<a name="l01054"></a>01054             }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01055"></a>01055             
<a name="l01056"></a>01056             <span class="comment">// If there&#39;s still foreign symbols, then punycode convert it</span>
<a name="l01057"></a>01057             <span class="keywordflow">if</span>(this._hasUTFChars(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address)){
<a name="l01058"></a>01058                 <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address = toPunycode(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address);
<a name="l01059"></a>01059             }
<a name="l01060"></a>01060         
<a name="l01061"></a>01061             <span class="keywordflow">if</span>(!<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.name){
<a name="l01062"></a>01062                 values.push(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address);
<a name="l01063"></a>01063             }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.name){
<a name="l01064"></a>01064                 <span class="keywordflow">if</span>(this._hasUTFChars(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.name)){
<a name="l01065"></a>01065                     <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.name = this._encodeMimeWord(<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.name, <span class="stringliteral">&quot;Q&quot;</span>, 52);
<a name="l01066"></a>01066                 }<span class="keywordflow">else</span>{
<a name="l01067"></a>01067                     <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.name = <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.name;
<a name="l01068"></a>01068                 }
<a name="l01069"></a>01069                 values.push(<span class="charliteral">&#39;&quot;&#39;</span> + <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.name+<span class="stringliteral">&#39;&quot; &lt;&#39;</span>+<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>.address+<span class="charliteral">&#39;&gt;&#39;</span>);
<a name="l01070"></a>01070             }
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073     <span class="keywordflow">return</span> values.join(<span class="stringliteral">&quot;, &quot;</span>);
<a name="l01074"></a>01074 };
<a name="l01075"></a>01075 
<a name="l01082"></a>01082 MailComposer.prototype._getHeader = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>){
<a name="l01083"></a>01083     var <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l01084"></a>01084     
<a name="l01085"></a>01085     key = this._normalizeKey(key);
<a name="l01086"></a>01086     value = this._headers[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] || <span class="stringliteral">&quot;&quot;</span>;
<a name="l01087"></a>01087     
<a name="l01088"></a>01088     <span class="keywordflow">return</span> <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l01089"></a>01089 };
<a name="l01090"></a>01090 
<a name="l01094"></a>01094 MailComposer.prototype._composeMessage = <span class="keyword">function</span>(){
<a name="l01095"></a>01095     
<a name="l01096"></a>01096     <span class="comment">// Generate headers for the message</span>
<a name="l01097"></a>01097     this._composeHeader();
<a name="l01098"></a>01098     
<a name="l01099"></a>01099     <span class="comment">// Make the mime tree flat</span>
<a name="l01100"></a>01100     this._flattenMimeTree();
<a name="l01101"></a>01101     
<a name="l01102"></a>01102     <span class="comment">// Compose message body</span>
<a name="l01103"></a>01103     this._composeBody();
<a name="l01104"></a>01104     
<a name="l01105"></a>01105 };
<a name="l01106"></a>01106 
<a name="l01119"></a>01119 MailComposer.prototype._composeHeader = <span class="keyword">function</span>(){
<a name="l01120"></a>01120     var <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a> = [], <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122     <span class="comment">// if an attachment uses content-id and is linked from the html</span>
<a name="l01123"></a>01123     <span class="comment">// then it should be placed in a separate &quot;related&quot; part with the html</span>
<a name="l01124"></a>01124     this._message.useRelated = <span class="keyword">false</span>;
<a name="l01125"></a>01125     <span class="keywordflow">if</span>(this._message.html &amp;&amp; (len = <span class="keyword">this</span>._attachments.length)){
<a name="l01126"></a>01126         
<a name="l01127"></a>01127         <span class="keywordflow">for</span>(i=len-1; i&gt;=0; i--){
<a name="l01128"></a>01128             <span class="keywordflow">if</span>(this._attachments[i].cid &amp;&amp; 
<a name="l01129"></a>01129               this._message.html.indexOf(<span class="stringliteral">&quot;cid:&quot;</span>+<span class="keyword">this</span>._attachments[i].cid)&gt;=0){
<a name="l01130"></a>01130                 this._message.useRelated = <span class="keyword">true</span>;
<a name="l01131"></a>01131                 this._relatedAttachments.unshift(this._attachments[i]);
<a name="l01132"></a>01132                 this._attachments.splice(i,1);
<a name="l01133"></a>01133             }
<a name="l01134"></a>01134         }
<a name="l01135"></a>01135         
<a name="l01136"></a>01136     }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138     <span class="keywordflow">if</span>(this._attachments.length){
<a name="l01139"></a>01139         this._message.useMixed = <span class="keyword">true</span>;
<a name="l01140"></a>01140         this._message.mixedBoundary = this._generateBoundary();
<a name="l01141"></a>01141     }<span class="keywordflow">else</span>{
<a name="l01142"></a>01142         this._message.useMixed = <span class="keyword">false</span>;
<a name="l01143"></a>01143     }
<a name="l01144"></a>01144     
<a name="l01145"></a>01145     <span class="keywordflow">if</span>(this._message.body &amp;&amp; <span class="keyword">this</span>._message.html){
<a name="l01146"></a>01146         this._message.useAlternative = <span class="keyword">true</span>;
<a name="l01147"></a>01147         this._message.alternativeBoundary = this._generateBoundary();
<a name="l01148"></a>01148     }<span class="keywordflow">else</span>{
<a name="l01149"></a>01149         this._message.useAlternative = <span class="keyword">false</span>;
<a name="l01150"></a>01150     }
<a name="l01151"></a>01151     
<a name="l01152"></a>01152     <span class="comment">// let&#39;s do it here, so the counter in the boundary would look better</span>
<a name="l01153"></a>01153     <span class="keywordflow">if</span>(this._message.useRelated){
<a name="l01154"></a>01154         this._message.relatedBoundary = this._generateBoundary();
<a name="l01155"></a>01155     }
<a name="l01156"></a>01156     
<a name="l01157"></a>01157     <span class="keywordflow">if</span>(!this._message.html &amp;&amp; !<span class="keyword">this</span>._message.body){
<a name="l01158"></a>01158         <span class="comment">// If there&#39;s nothing to show, show a linebreak</span>
<a name="l01159"></a>01159         this._message.body = <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l01160"></a>01160     }
<a name="l01161"></a>01161     
<a name="l01162"></a>01162     this._buildMessageHeaders();
<a name="l01163"></a>01163     this._generateBodyStructure();
<a name="l01164"></a>01164     
<a name="l01165"></a>01165     <span class="comment">// Compile header lines</span>
<a name="l01166"></a>01166     headers = this.compileHeaders(this._headers);
<a name="l01167"></a>01167     
<a name="l01168"></a>01168     <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01169"></a>01169         this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(headers.join(<span class="stringliteral">&quot;\r\n&quot;</span>)+<span class="stringliteral">&quot;\r\n\r\n&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01170"></a>01170     }<span class="keywordflow">else</span>{
<a name="l01171"></a>01171         this._outputBuffer += headers.join(<span class="stringliteral">&quot;\r\n&quot;</span>)+<span class="stringliteral">&quot;\r\n\r\n&quot;</span>;
<a name="l01172"></a>01172     }
<a name="l01173"></a>01173 };
<a name="l01174"></a>01174 
<a name="l01178"></a>01178 MailComposer.prototype._buildMessageHeaders = <span class="keyword">function</span>(){
<a name="l01179"></a>01179 
<a name="l01180"></a>01180     <span class="comment">// FROM</span>
<a name="l01181"></a>01181     <span class="keywordflow">if</span>(this._message.from &amp;&amp; <span class="keyword">this</span>._message.from.length){
<a name="l01182"></a>01182         [].concat(this._message.from).forEach((<span class="keyword">function</span>(from){
<a name="l01183"></a>01183             this.addHeader(<span class="stringliteral">&quot;From&quot;</span>, from);
<a name="l01184"></a>01184         }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01185"></a>01185     }
<a name="l01186"></a>01186     
<a name="l01187"></a>01187     <span class="comment">// TO</span>
<a name="l01188"></a>01188     <span class="keywordflow">if</span>(this._message.to &amp;&amp; <span class="keyword">this</span>._message.to.length){
<a name="l01189"></a>01189         [].concat(this._message.to).forEach((<span class="keyword">function</span>(<a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>){
<a name="l01190"></a>01190             this.addHeader(<span class="stringliteral">&quot;To&quot;</span>, <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>);
<a name="l01191"></a>01191         }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01192"></a>01192     }
<a name="l01193"></a>01193     
<a name="l01194"></a>01194     <span class="comment">// CC</span>
<a name="l01195"></a>01195     <span class="keywordflow">if</span>(this._message.cc &amp;&amp; <span class="keyword">this</span>._message.cc.length){
<a name="l01196"></a>01196         [].concat(this._message.cc).forEach((<span class="keyword">function</span>(<a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>){
<a name="l01197"></a>01197             this.addHeader(<span class="stringliteral">&quot;Cc&quot;</span>, <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>);
<a name="l01198"></a>01198         }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01199"></a>01199     }
<a name="l01200"></a>01200     
<a name="l01201"></a>01201     <span class="comment">// BCC</span>
<a name="l01202"></a>01202     <span class="comment">// By default not included, set options.keepBcc to true to keep</span>
<a name="l01203"></a>01203     <span class="keywordflow">if</span>(this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.keepBcc){
<a name="l01204"></a>01204         <span class="keywordflow">if</span>(this._message.bcc &amp;&amp; <span class="keyword">this</span>._message.bcc.length){
<a name="l01205"></a>01205             [].concat(this._message.bcc).forEach((<span class="keyword">function</span>(bcc){
<a name="l01206"></a>01206                 this.addHeader(<span class="stringliteral">&quot;Bcc&quot;</span>, bcc);
<a name="l01207"></a>01207             }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01208"></a>01208         }    
<a name="l01209"></a>01209     }
<a name="l01210"></a>01210     
<a name="l01211"></a>01211     <span class="comment">// REPLY-TO</span>
<a name="l01212"></a>01212     <span class="keywordflow">if</span>(this._message.replyTo &amp;&amp; <span class="keyword">this</span>._message.replyTo.length){
<a name="l01213"></a>01213         [].concat(this._message.replyTo).forEach((<span class="keyword">function</span>(replyTo){
<a name="l01214"></a>01214             this.addHeader(<span class="stringliteral">&quot;Reply-To&quot;</span>, replyTo);
<a name="l01215"></a>01215         }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <span class="comment">// REFERENCES</span>
<a name="l01219"></a>01219     <span class="keywordflow">if</span>(this._message.references &amp;&amp; <span class="keyword">this</span>._message.references.length){
<a name="l01220"></a>01220         this.addHeader(<span class="stringliteral">&quot;References&quot;</span>, this._message.references);
<a name="l01221"></a>01221     }
<a name="l01222"></a>01222     
<a name="l01223"></a>01223     <span class="comment">// IN-REPLY-TO</span>
<a name="l01224"></a>01224     <span class="keywordflow">if</span>(this._message.inReplyTo &amp;&amp; <span class="keyword">this</span>._message.inReplyTo.length){
<a name="l01225"></a>01225         this.addHeader(<span class="stringliteral">&quot;In-Reply-To&quot;</span>, this._message.inReplyTo);
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <span class="comment">// SUBJECT</span>
<a name="l01229"></a>01229     <span class="keywordflow">if</span>(this._message.subject){
<a name="l01230"></a>01230         this.addHeader(<span class="stringliteral">&quot;Subject&quot;</span>, this._message.subject);
<a name="l01231"></a>01231     }
<a name="l01232"></a>01232 };
<a name="l01233"></a>01233 
<a name="l01241"></a>01241 MailComposer.prototype._generateBodyStructure = <span class="keyword">function</span>(){
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     var <a class="code" href="../../da/df2/namespacexml2dict.html#aa8dec942af2c6d4b6c6053526383cbd8">tree</a> = this._createMimeNode(), 
<a name="l01244"></a>01244         currentNode, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>,
<a name="l01245"></a>01245         <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>;
<a name="l01246"></a>01246     
<a name="l01247"></a>01247     <span class="keywordflow">if</span>(this._message.useMixed){
<a name="l01248"></a>01248         
<a name="l01249"></a>01249         node = this._createMimeNode();
<a name="l01250"></a>01250         node.boundary = this._message.mixedBoundary;
<a name="l01251"></a>01251         node.headers.push([<span class="stringliteral">&quot;Content-Type&quot;</span>, <span class="stringliteral">&quot;multipart/mixed; boundary=\&quot;&quot;</span>+node.boundary+<span class="stringliteral">&quot;\&quot;&quot;</span>]);
<a name="l01252"></a>01252         
<a name="l01253"></a>01253         <span class="keywordflow">if</span>(currentNode){
<a name="l01254"></a>01254             currentNode.childNodes.push(node);
<a name="l01255"></a>01255             node.parentNode = currentNode;
<a name="l01256"></a>01256         }<span class="keywordflow">else</span>{
<a name="l01257"></a>01257             tree = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01258"></a>01258         }
<a name="l01259"></a>01259         currentNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01260"></a>01260     
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262     
<a name="l01263"></a>01263     <span class="keywordflow">if</span>(this._message.useAlternative){
<a name="l01264"></a>01264     
<a name="l01265"></a>01265         node = this._createMimeNode();
<a name="l01266"></a>01266         node.boundary = this._message.alternativeBoundary;
<a name="l01267"></a>01267         node.headers.push([<span class="stringliteral">&quot;Content-Type&quot;</span>, <span class="stringliteral">&quot;multipart/alternative; boundary=\&quot;&quot;</span>+node.boundary+<span class="stringliteral">&quot;\&quot;&quot;</span>]);
<a name="l01268"></a>01268         <span class="keywordflow">if</span>(currentNode){
<a name="l01269"></a>01269             currentNode.childNodes.push(node);
<a name="l01270"></a>01270             node.parentNode = currentNode;
<a name="l01271"></a>01271         }<span class="keywordflow">else</span>{
<a name="l01272"></a>01272             tree = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01273"></a>01273         }
<a name="l01274"></a>01274         currentNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01275"></a>01275         
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277     
<a name="l01278"></a>01278     <span class="keywordflow">if</span>(this._message.body){
<a name="l01279"></a>01279         node = this._createTextComponent(this._message.body, <span class="stringliteral">&quot;text/plain&quot;</span>);
<a name="l01280"></a>01280         <span class="keywordflow">if</span>(currentNode){
<a name="l01281"></a>01281             currentNode.childNodes.push(node);
<a name="l01282"></a>01282             node.parentNode = currentNode;
<a name="l01283"></a>01283         }<span class="keywordflow">else</span>{
<a name="l01284"></a>01284             tree = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01285"></a>01285         }
<a name="l01286"></a>01286     }
<a name="l01287"></a>01287     
<a name="l01288"></a>01288     <span class="keywordflow">if</span>(this._message.useRelated){
<a name="l01289"></a>01289     
<a name="l01290"></a>01290         node = this._createMimeNode();
<a name="l01291"></a>01291         node.boundary = this._message.relatedBoundary;
<a name="l01292"></a>01292         node.headers.push([<span class="stringliteral">&quot;Content-Type&quot;</span>, <span class="stringliteral">&quot;multipart/related; boundary=\&quot;&quot;</span>+node.boundary+<span class="stringliteral">&quot;\&quot;&quot;</span>]);
<a name="l01293"></a>01293         <span class="keywordflow">if</span>(currentNode){
<a name="l01294"></a>01294             currentNode.childNodes.push(node);
<a name="l01295"></a>01295             node.parentNode = currentNode;
<a name="l01296"></a>01296         }<span class="keywordflow">else</span>{
<a name="l01297"></a>01297             tree = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01298"></a>01298         }
<a name="l01299"></a>01299         currentNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01300"></a>01300         
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     
<a name="l01303"></a>01303     <span class="keywordflow">if</span>(this._message.html){
<a name="l01304"></a>01304         node = this._createTextComponent(this._message.html, <span class="stringliteral">&quot;text/html&quot;</span>);
<a name="l01305"></a>01305         <span class="keywordflow">if</span>(currentNode){
<a name="l01306"></a>01306             currentNode.childNodes.push(node);
<a name="l01307"></a>01307             node.parentNode = currentNode;
<a name="l01308"></a>01308         }<span class="keywordflow">else</span>{
<a name="l01309"></a>01309             tree = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01310"></a>01310         }
<a name="l01311"></a>01311     }
<a name="l01312"></a>01312     
<a name="l01313"></a>01313     <span class="comment">// Related attachments are added to the multipart/related part</span>
<a name="l01314"></a>01314     <span class="keywordflow">if</span>(this._relatedAttachments &amp;&amp; this._relatedAttachments){
<a name="l01315"></a>01315         <span class="keywordflow">for</span>(i=0, len = this._relatedAttachments.length; i&lt;len; i++){
<a name="l01316"></a>01316             node = this._createAttachmentComponent(this._relatedAttachments[i]);
<a name="l01317"></a>01317             node.parentNode = currentNode;
<a name="l01318"></a>01318             currentNode.childNodes.push(node);
<a name="l01319"></a>01319         }
<a name="l01320"></a>01320     }
<a name="l01321"></a>01321     
<a name="l01322"></a>01322     <span class="comment">// Attachments are added to the first element (should be multipart/mixed)</span>
<a name="l01323"></a>01323     currentNode = <a class="code" href="../../da/df2/namespacexml2dict.html#aa8dec942af2c6d4b6c6053526383cbd8">tree</a>;
<a name="l01324"></a>01324     <span class="keywordflow">if</span>(this._attachments &amp;&amp; this._attachments.length){
<a name="l01325"></a>01325         <span class="keywordflow">for</span>(i=0, len = this._attachments.length; i&lt;len; i++){
<a name="l01326"></a>01326             node = this._createAttachmentComponent(this._attachments[i]);
<a name="l01327"></a>01327             node.parentNode = currentNode;
<a name="l01328"></a>01328             currentNode.childNodes.push(node);
<a name="l01329"></a>01329         }
<a name="l01330"></a>01330     }
<a name="l01331"></a>01331     
<a name="l01332"></a>01332     <span class="comment">// Add the headers from the root element to the main headers list</span>
<a name="l01333"></a>01333     <span class="keywordflow">for</span>(i=0, len=tree.headers.length; i&lt;len; i++){
<a name="l01334"></a>01334         this.addHeader(tree.headers[i][0], tree.headers[i][1]);
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336     
<a name="l01337"></a>01337     this._message.tree = <a class="code" href="../../da/df2/namespacexml2dict.html#aa8dec942af2c6d4b6c6053526383cbd8">tree</a>;
<a name="l01338"></a>01338 };
<a name="l01339"></a>01339 
<a name="l01347"></a>01347 MailComposer.prototype._createTextComponent = <span class="keyword">function</span>(<a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>, contentType){
<a name="l01348"></a>01348     var node = this._createMimeNode();
<a name="l01349"></a>01349     
<a name="l01350"></a>01350     node.contentEncoding = (this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.encoding || <span class="stringliteral">&quot;quoted-printable&quot;</span>).toLowerCase().trim();
<a name="l01351"></a>01351     node.useTextType = <span class="keyword">true</span>;
<a name="l01352"></a>01352     
<a name="l01353"></a>01353     contentType = [contentType || <span class="stringliteral">&quot;text/plain&quot;</span>];
<a name="l01354"></a>01354     contentType.push(<span class="stringliteral">&quot;charset=utf-8&quot;</span>);
<a name="l01355"></a>01355     
<a name="l01356"></a>01356     <span class="keywordflow">if</span>([<span class="stringliteral">&quot;7bit&quot;</span>, <span class="stringliteral">&quot;8bit&quot;</span>, <span class="stringliteral">&quot;binary&quot;</span>].<a class="code" href="../../d4/d23/binary__string__view_8js.html#a78826d1185ecdcfc63deffaedf15c7bd">indexOf</a>(node.contentEncoding)&gt;=0){
<a name="l01357"></a>01357         node.textFormat = <span class="stringliteral">&quot;flowed&quot;</span>;
<a name="l01358"></a>01358         contentType.push(<span class="stringliteral">&quot;format=&quot;</span> + node.textFormat);
<a name="l01359"></a>01359     }
<a name="l01360"></a>01360     
<a name="l01361"></a>01361     node.headers.push([<span class="stringliteral">&quot;Content-Type&quot;</span>, contentType.join(<span class="stringliteral">&quot;; &quot;</span>)]);
<a name="l01362"></a>01362     node.headers.push([<span class="stringliteral">&quot;Content-Transfer-Encoding&quot;</span>, node.contentEncoding]);
<a name="l01363"></a>01363     
<a name="l01364"></a>01364     node.contents = <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>;
<a name="l01365"></a>01365     
<a name="l01366"></a>01366     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01367"></a>01367 };
<a name="l01368"></a>01368 
<a name="l01375"></a>01375 MailComposer.prototype._createAttachmentComponent = <span class="keyword">function</span>(attachment){
<a name="l01376"></a>01376     var node = this._createMimeNode(),
<a name="l01377"></a>01377         contentType = [attachment.contentType],
<a name="l01378"></a>01378         contentDisposition = [attachment.contentDisposition || <span class="stringliteral">&quot;attachment&quot;</span>],
<a name="l01379"></a>01379         fileName;
<a name="l01380"></a>01380     
<a name="l01381"></a>01381     node.contentEncoding = <span class="stringliteral">&quot;base64&quot;</span>;
<a name="l01382"></a>01382     node.useAttachmentType = <span class="keyword">true</span>;
<a name="l01383"></a>01383     
<a name="l01384"></a>01384     <span class="keywordflow">if</span>(attachment.fileName){
<a name="l01385"></a>01385         fileName = this._encodeMimeWord(attachment.fileName, <span class="stringliteral">&quot;Q&quot;</span>, 1024).replace(/<span class="stringliteral">&quot;/g,&quot;</span>\\\<span class="stringliteral">&quot;&quot;</span>);
<a name="l01386"></a>01386         contentType.push(<span class="stringliteral">&quot;name=\&quot;&quot;</span> +fileName+ <span class="stringliteral">&quot;\&quot;&quot;</span>);
<a name="l01387"></a>01387         contentDisposition.push(<span class="stringliteral">&quot;filename=\&quot;&quot;</span> +fileName+ <span class="stringliteral">&quot;\&quot;&quot;</span>);
<a name="l01388"></a>01388     }
<a name="l01389"></a>01389     
<a name="l01390"></a>01390     node.headers.push([<span class="stringliteral">&quot;Content-Type&quot;</span>, contentType.join(<span class="stringliteral">&quot;; &quot;</span>)]);
<a name="l01391"></a>01391     node.headers.push([<span class="stringliteral">&quot;Content-Disposition&quot;</span>, contentDisposition.join(<span class="stringliteral">&quot;; &quot;</span>)]);
<a name="l01392"></a>01392     node.headers.push([<span class="stringliteral">&quot;Content-Transfer-Encoding&quot;</span>, node.contentEncoding]);
<a name="l01393"></a>01393     
<a name="l01394"></a>01394     <span class="keywordflow">if</span>(attachment.cid){
<a name="l01395"></a>01395         node.headers.push([<span class="stringliteral">&quot;Content-Id&quot;</span>, <span class="stringliteral">&quot;&lt;&quot;</span> + this._encodeMimeWord(attachment.cid) + <span class="stringliteral">&quot;&gt;&quot;</span>]);
<a name="l01396"></a>01396     }
<a name="l01397"></a>01397     
<a name="l01398"></a>01398     <span class="keywordflow">if</span>(attachment.contents){
<a name="l01399"></a>01399         node.contents = attachment.contents;
<a name="l01400"></a>01400     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(attachment.filePath){
<a name="l01401"></a>01401         node.filePath = attachment.filePath;
<a name="l01402"></a>01402         <span class="keywordflow">if</span>(attachment.userAgent){
<a name="l01403"></a>01403             node.userAgent = attachment.userAgent;
<a name="l01404"></a>01404         }
<a name="l01405"></a>01405     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(attachment.streamSource){
<a name="l01406"></a>01406         node.streamSource = attachment.streamSource;
<a name="l01407"></a>01407     }
<a name="l01408"></a>01408 
<a name="l01409"></a>01409     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l01410"></a>01410 };
<a name="l01411"></a>01411 
<a name="l01417"></a>01417 MailComposer.prototype._createMimeNode = <span class="keyword">function</span>(){
<a name="l01418"></a>01418     <span class="keywordflow">return</span> {
<a name="l01419"></a>01419         childNodes: [],
<a name="l01420"></a>01420         headers: [],
<a name="l01421"></a>01421         parentNode: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>
<a name="l01422"></a>01422     };
<a name="l01423"></a>01423 };
<a name="l01424"></a>01424 
<a name="l01434"></a>01434 MailComposer.prototype.compileHeaders = <span class="keyword">function</span>(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>){
<a name="l01435"></a>01435     var headersArr = [], <a class="code" href="../../dc/d33/namespaceread_j_s_o_n.html#a5b3073959c18dcb060a912824297e59d">keys</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>;
<a name="l01436"></a>01436 
<a name="l01437"></a>01437     <span class="keywordflow">if</span>(Array.isArray(headers)){
<a name="l01438"></a>01438         headersArr = headers.map(<span class="keyword">function</span>(field){
<a name="l01439"></a>01439             <span class="keywordflow">return</span> mimelib.foldLine((field.key || field[0])+<span class="stringliteral">&quot;: &quot;</span>+(field.value || field[1]), 76, <span class="keyword">false</span>, <span class="keyword">false</span>, 52);
<a name="l01440"></a>01440         });
<a name="l01441"></a>01441     }<span class="keywordflow">else</span>{
<a name="l01442"></a>01442         keys = Object.keys(headers);
<a name="l01443"></a>01443         <span class="keywordflow">for</span>(var i=0, len = keys.length; i&lt;len; i++){
<a name="l01444"></a>01444             key = this._normalizeKey(keys[i]);
<a name="l01445"></a>01445             
<a name="l01446"></a>01446             headersArr = headersArr.concat([].concat(headers[key]).map(<span class="keyword">function</span>(field){
<a name="l01447"></a>01447                 <span class="keywordflow">return</span> mimelib.foldLine(key+<span class="stringliteral">&quot;: &quot;</span>+field, 76, <span class="keyword">false</span>, <span class="keyword">false</span>, 52);
<a name="l01448"></a>01448             }));
<a name="l01449"></a>01449         }
<a name="l01450"></a>01450     }
<a name="l01451"></a>01451     
<a name="l01452"></a>01452     <span class="keywordflow">return</span> headersArr;
<a name="l01453"></a>01453 };
<a name="l01454"></a>01454 
<a name="l01460"></a>01460 MailComposer.prototype._flattenMimeTree = <span class="keyword">function</span>(){
<a name="l01461"></a>01461     var flatTree = [];
<a name="l01462"></a>01462     
<a name="l01463"></a>01463     <span class="keyword">function</span> walkTree(node, level){
<a name="l01464"></a>01464         var contentObject = {};
<a name="l01465"></a>01465         level = level || 0;
<a name="l01466"></a>01466         
<a name="l01467"></a>01467         <span class="comment">// if not root element, include headers</span>
<a name="l01468"></a>01468         <span class="keywordflow">if</span>(level){
<a name="l01469"></a>01469             flatTree = flatTree.concat(this.compileHeaders(node.headers));
<a name="l01470"></a>01470             flatTree.push(<span class="stringliteral">&#39;&#39;</span>);
<a name="l01471"></a>01471         }
<a name="l01472"></a>01472         
<a name="l01473"></a>01473         <span class="keywordflow">if</span>(node.textFormat){
<a name="l01474"></a>01474             contentObject.textFormat = node.textFormat;
<a name="l01475"></a>01475         }
<a name="l01476"></a>01476         
<a name="l01477"></a>01477         <span class="keywordflow">if</span>(node.contentEncoding){
<a name="l01478"></a>01478             contentObject.contentEncoding = node.contentEncoding;
<a name="l01479"></a>01479         }
<a name="l01480"></a>01480         
<a name="l01481"></a>01481         <span class="keywordflow">if</span>(node.contents){
<a name="l01482"></a>01482             contentObject.contents = node.contents;
<a name="l01483"></a>01483         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(node.filePath){
<a name="l01484"></a>01484             contentObject.filePath = node.filePath;
<a name="l01485"></a>01485             <span class="keywordflow">if</span>(node.userAgent){
<a name="l01486"></a>01486                 contentObject.userAgent = node.userAgent;
<a name="l01487"></a>01487             }
<a name="l01488"></a>01488         }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(node.streamSource){
<a name="l01489"></a>01489             contentObject.streamSource = node.streamSource;
<a name="l01490"></a>01490         }
<a name="l01491"></a>01491         
<a name="l01492"></a>01492         <span class="keywordflow">if</span>(node.contents || node.filePath || node.streamSource){
<a name="l01493"></a>01493             flatTree.push(contentObject);
<a name="l01494"></a>01494         }
<a name="l01495"></a>01495         
<a name="l01496"></a>01496         <span class="comment">// walk children</span>
<a name="l01497"></a>01497         <span class="keywordflow">for</span>(var i=0, len = node.childNodes.length; i&lt;len; i++){
<a name="l01498"></a>01498             <span class="keywordflow">if</span>(node.boundary){
<a name="l01499"></a>01499                 flatTree.push(<span class="stringliteral">&quot;--&quot;</span>+node.boundary);
<a name="l01500"></a>01500             }
<a name="l01501"></a>01501             walkTree.call(<span class="keyword">this</span>, node.childNodes[i], level+1);
<a name="l01502"></a>01502         }
<a name="l01503"></a>01503         <span class="keywordflow">if</span>(node.boundary &amp;&amp; node.childNodes.length){
<a name="l01504"></a>01504             flatTree.push(<span class="stringliteral">&quot;--&quot;</span>+node.boundary+<span class="stringliteral">&quot;--&quot;</span>);
<a name="l01505"></a>01505             flatTree.push(<span class="stringliteral">&#39;&#39;</span>);
<a name="l01506"></a>01506         }
<a name="l01507"></a>01507     }
<a name="l01508"></a>01508     
<a name="l01509"></a>01509     walkTree.call(<span class="keyword">this</span>, this._message.tree);
<a name="l01510"></a>01510     
<a name="l01511"></a>01511     <span class="keywordflow">if</span>(flatTree.length &amp;&amp; flatTree[flatTree.length-1]===<span class="stringliteral">&#39;&#39;</span>){
<a name="l01512"></a>01512         flatTree.pop();
<a name="l01513"></a>01513     }
<a name="l01514"></a>01514     
<a name="l01515"></a>01515     this._message.flatTree = flatTree;
<a name="l01516"></a>01516 };
<a name="l01517"></a>01517 
<a name="l01526"></a>01526 MailComposer.prototype._composeBody = <span class="keyword">function</span>(){
<a name="l01527"></a>01527     var flatTree = this._message.flatTree,
<a name="l01528"></a>01528         <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, isObject = <span class="keyword">false</span>, isEnd = <span class="keyword">false</span>,
<a name="l01529"></a>01529         curObject;
<a name="l01530"></a>01530     
<a name="l01531"></a>01531     this._message.processingStart = this._message.processingStart || 0;
<a name="l01532"></a>01532     this._message.processingPos = this._message.processingPos || 0;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534     <span class="keywordflow">for</span>(var len = flatTree.length; <span class="keyword">this</span>._message.processingPos &lt; len; <span class="keyword">this</span>._message.processingPos++){
<a name="l01535"></a>01535         
<a name="l01536"></a>01536         isEnd = this._message.processingPos &gt;= len-1;
<a name="l01537"></a>01537         isObject = <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> flatTree[this._message.processingPos] == <span class="stringliteral">&quot;object&quot;</span>;
<a name="l01538"></a>01538         
<a name="l01539"></a>01539         <span class="keywordflow">if</span>(isEnd || isObject){
<a name="l01540"></a>01540             
<a name="l01541"></a>01541             <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a> = flatTree.slice(this._message.processingStart, isEnd &amp;&amp; !isObject?undefined:<span class="keyword">this</span>._message.processingPos);
<a name="l01542"></a>01542             <span class="keywordflow">if</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a> &amp;&amp; <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>.length){
<a name="l01543"></a>01543                 <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01544"></a>01544                     this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>.join(<span class="stringliteral">&quot;\r\n&quot;</span>)+<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01545"></a>01545                 }<span class="keywordflow">else</span>{
<a name="l01546"></a>01546                     this._outputBuffer += <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>.join(<span class="stringliteral">&quot;\r\n&quot;</span>)+<span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l01547"></a>01547                 }
<a name="l01548"></a>01548             }
<a name="l01549"></a>01549             
<a name="l01550"></a>01550             <span class="keywordflow">if</span>(isObject){
<a name="l01551"></a>01551                 curObject = flatTree[this._message.processingPos];
<a name="l01552"></a>01552             
<a name="l01553"></a>01553                 this._message.processingPos++;
<a name="l01554"></a>01554                 this._message.processingStart = this._message.processingPos;
<a name="l01555"></a>01555             
<a name="l01556"></a>01556                 this._emitDataElement(curObject, (<span class="keyword">function</span>(){
<a name="l01557"></a>01557                     <span class="keywordflow">if</span>(!isEnd){
<a name="l01558"></a>01558                         <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.nextTick(this._composeBody.bind(<span class="keyword">this</span>));
<a name="l01559"></a>01559                     }<span class="keywordflow">else</span>{
<a name="l01560"></a>01560                         <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01561"></a>01561                             this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;end&quot;</span>);
<a name="l01562"></a>01562                         }<span class="keywordflow">else</span>{
<a name="l01563"></a>01563                             this._processBufferedOutput();
<a name="l01564"></a>01564                         }
<a name="l01565"></a>01565                     }
<a name="l01566"></a>01566                 }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01567"></a>01567                 
<a name="l01568"></a>01568             }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(isEnd){
<a name="l01569"></a>01569                 <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01570"></a>01570                     this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;end&quot;</span>);
<a name="l01571"></a>01571                 }<span class="keywordflow">else</span>{
<a name="l01572"></a>01572                     this._processBufferedOutput();
<a name="l01573"></a>01573                 }
<a name="l01574"></a>01574             }
<a name="l01575"></a>01575             <span class="keywordflow">break</span>;
<a name="l01576"></a>01576         }
<a name="l01577"></a>01577         
<a name="l01578"></a>01578     }
<a name="l01579"></a>01579 };
<a name="l01580"></a>01580 
<a name="l01591"></a>01591 MailComposer.prototype._emitDataElement = <span class="keyword">function</span>(element, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>){
<a name="l01592"></a>01592     
<a name="l01593"></a>01593     var <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01594"></a>01594     
<a name="l01595"></a>01595     <span class="keywordflow">if</span>(element.contents){
<a name="l01596"></a>01596         <span class="keywordflow">switch</span>(element.contentEncoding){
<a name="l01597"></a>01597             <span class="keywordflow">case</span> <span class="stringliteral">&quot;quoted-printable&quot;</span>:
<a name="l01598"></a>01598                 data = mimelib.encodeQuotedPrintable(element.contents);
<a name="l01599"></a>01599                 <span class="keywordflow">break</span>;
<a name="l01600"></a>01600             <span class="keywordflow">case</span> <span class="stringliteral">&quot;base64&quot;</span>:
<a name="l01601"></a>01601                 data = <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(element.contents, <span class="stringliteral">&quot;utf-8&quot;</span>).toString(<span class="stringliteral">&quot;base64&quot;</span>).replace(/.{76}/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>,<span class="stringliteral">&quot;$&amp;\r\n&quot;</span>);
<a name="l01602"></a>01602                 <span class="keywordflow">break</span>;
<a name="l01603"></a>01603             <span class="keywordflow">case</span> <span class="stringliteral">&quot;7bit&quot;</span>:
<a name="l01604"></a>01604             <span class="keywordflow">case</span> <span class="stringliteral">&quot;8bit&quot;</span>:
<a name="l01605"></a>01605             <span class="keywordflow">case</span> <span class="stringliteral">&quot;binary&quot;</span>:
<a name="l01606"></a>01606             <span class="keywordflow">default</span>:
<a name="l01607"></a>01607                 data = mimelib.foldLine(element.contents, 76, <span class="keyword">false</span>, element.textFormat==<span class="stringliteral">&quot;flowed&quot;</span>);
<a name="l01608"></a>01608                  <span class="comment">//mimelib puts a long whitespace to the beginning of the lines</span>
<a name="l01609"></a>01609                 data = data.replace(/^[ ]{7}/mg, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01610"></a>01610                 <span class="keywordflow">break</span>;
<a name="l01611"></a>01611         }
<a name="l01612"></a>01612         
<a name="l01613"></a>01613         <span class="keywordflow">if</span>(this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.escapeSMTP){
<a name="l01614"></a>01614             data = data.replace(/^\./gm,<span class="stringliteral">&#39;..&#39;</span>);
<a name="l01615"></a>01615         }
<a name="l01616"></a>01616         
<a name="l01617"></a>01617         <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01618"></a>01618             this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(data + <span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01619"></a>01619         }<span class="keywordflow">else</span>{
<a name="l01620"></a>01620             this._outputBuffer += data + <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l01621"></a>01621         }
<a name="l01622"></a>01622         <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.nextTick(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01623"></a>01623         <span class="keywordflow">return</span>;
<a name="l01624"></a>01624     }
<a name="l01625"></a>01625 
<a name="l01626"></a>01626     <span class="keywordflow">if</span>(element.filePath){
<a name="l01627"></a>01627         <span class="keywordflow">if</span>(element.filePath.match(/^<a class="code" href="../../da/d88/mock__configurator_8js.html#a143d22e446a0feb4cbd35b8b5e3c8d94">https</a>?:\/\<span class="comment">//)){</span>
<a name="l01628"></a>01628             <span class="keyword">this</span>._serveStream(urlFetch(element.filePath, {userAgent: element.userAgent}), <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01629"></a>01629         }<span class="keywordflow">else</span>{
<a name="l01630"></a>01630             this._serveFile(element.filePath, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01631"></a>01631         }
<a name="l01632"></a>01632         <span class="keywordflow">return</span>;
<a name="l01633"></a>01633     }<span class="keywordflow">else</span> <span class="keywordflow">if</span>(element.streamSource){
<a name="l01634"></a>01634         this._serveStream(element.streamSource, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01635"></a>01635         <span class="keywordflow">return</span>;
<a name="l01636"></a>01636     }
<a name="l01637"></a>01637 
<a name="l01638"></a>01638     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l01639"></a>01639 };
<a name="l01640"></a>01640 
<a name="l01647"></a>01647 MailComposer.prototype._serveFile = <span class="keyword">function</span>(filePath, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>){
<a name="l01648"></a>01648     <a class="code" href="../../dd/dfd/build__stage_2email_2shared_2test_2integration_2profile__builder_8js.html#a229733b8ea40200fae09e883376030bf">fs</a>.stat(filePath, (<span class="keyword">function</span>(err, <a class="code" href="../../df/db4/_h_i_s_t_o_r_y_8md.html#a6ac0a01571195d629db7aa0727b90fd9">stat</a>){
<a name="l01649"></a>01649         <span class="keywordflow">if</span>(err || !<a class="code" href="../../df/db4/_h_i_s_t_o_r_y_8md.html#a6ac0a01571195d629db7aa0727b90fd9">stat</a>.isFile()){
<a name="l01650"></a>01650             
<a name="l01651"></a>01651 
<a name="l01652"></a>01652             <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01653"></a>01653                 this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<span class="stringliteral">&quot;&lt;ERROR OPENING FILE&gt;&quot;</span>, 
<a name="l01654"></a>01654                                 <span class="stringliteral">&quot;utf-8&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>(<span class="stringliteral">&quot;base64&quot;</span>)+<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01655"></a>01655             }<span class="keywordflow">else</span>{
<a name="l01656"></a>01656                 this._outputBuffer += <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<span class="stringliteral">&quot;&lt;ERROR OPENING FILE&gt;&quot;</span>, 
<a name="l01657"></a>01657                                 <span class="stringliteral">&quot;utf-8&quot;</span>).toString(<span class="stringliteral">&quot;base64&quot;</span>)+<span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l01658"></a>01658             }
<a name="l01659"></a>01659                                 
<a name="l01660"></a>01660             <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.nextTick(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01661"></a>01661             <span class="keywordflow">return</span>;
<a name="l01662"></a>01662         }
<a name="l01663"></a>01663         
<a name="l01664"></a>01664         var stream = <a class="code" href="../../dd/dfd/build__stage_2email_2shared_2test_2integration_2profile__builder_8js.html#a229733b8ea40200fae09e883376030bf">fs</a>.createReadStream(filePath);
<a name="l01665"></a>01665         
<a name="l01666"></a>01666         this._serveStream(stream, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01667"></a>01667         
<a name="l01668"></a>01668     }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01669"></a>01669 };
<a name="l01670"></a>01670 
<a name="l01682"></a>01682 MailComposer.prototype._serveStream = <span class="keyword">function</span>(stream, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>){
<a name="l01683"></a>01683     var remainder = <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(0);
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     stream.on(<span class="stringliteral">&quot;error&quot;</span>, (<span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>){
<a name="l01686"></a>01686         <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01687"></a>01687             this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<span class="stringliteral">&quot;&lt;ERROR READING STREAM&gt;&quot;</span>, 
<a name="l01688"></a>01688                             <span class="stringliteral">&quot;utf-8&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>(<span class="stringliteral">&quot;base64&quot;</span>)+<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01689"></a>01689         }<span class="keywordflow">else</span>{
<a name="l01690"></a>01690             this._outputBuffer += <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<span class="stringliteral">&quot;&lt;ERROR READING STREAM&gt;&quot;</span>, 
<a name="l01691"></a>01691                             <span class="stringliteral">&quot;utf-8&quot;</span>).toString(<span class="stringliteral">&quot;base64&quot;</span>)+<span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l01692"></a>01692         }
<a name="l01693"></a>01693         <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.nextTick(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01694"></a>01694     }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01695"></a>01695     
<a name="l01696"></a>01696     stream.on(<span class="stringliteral">&quot;data&quot;</span>, (<span class="keyword">function</span>(chunk){
<a name="l01697"></a>01697         var data = <span class="stringliteral">&quot;&quot;</span>,
<a name="l01698"></a>01698             len = remainder.length + chunk.length,
<a name="l01699"></a>01699             remainderLength = len % 57, <span class="comment">// we use 57 bytes as it composes</span>
<a name="l01700"></a>01700                                         <span class="comment">// a 76 bytes long base64 string</span>
<a name="l01701"></a>01701             <a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a> = <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(len);
<a name="l01702"></a>01702         
<a name="l01703"></a>01703         remainder.copy(<a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>); <span class="comment">// copy remainder into the beginning of the new buffer</span>
<a name="l01704"></a>01704         chunk.copy(<a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>, remainder.length); <span class="comment">// copy data chunk after the remainder</span>
<a name="l01705"></a>01705         remainder = <a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>.slice(len - remainderLength); <span class="comment">// create a new remainder</span>
<a name="l01706"></a>01706         
<a name="l01707"></a>01707         data = <a class="code" href="../../d6/da5/libpinyin_8js.html#abd91b1aab0a10c5027ca2eb5577f759f">buffer</a>.slice(0, len - remainderLength).toString(<span class="stringliteral">&quot;base64&quot;</span>).replace(/.{76}/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>,<span class="stringliteral">&quot;$&amp;\r\n&quot;</span>);
<a name="l01708"></a>01708         
<a name="l01709"></a>01709         <span class="keywordflow">if</span>(data.length){
<a name="l01710"></a>01710             <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01711"></a>01711                 this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(data.trim()+<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01712"></a>01712             }<span class="keywordflow">else</span>{
<a name="l01713"></a>01713                 this._outputBuffer += data.trim()+<span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l01714"></a>01714             }
<a name="l01715"></a>01715         }
<a name="l01716"></a>01716     }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01717"></a>01717     
<a name="l01718"></a>01718     stream.on(<span class="stringliteral">&quot;end&quot;</span>, (<span class="keyword">function</span>(chunk){
<a name="l01719"></a>01719         var <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>;
<a name="l01720"></a>01720         
<a name="l01721"></a>01721         <span class="comment">// stream the remainder (if any)</span>
<a name="l01722"></a>01722         <span class="keywordflow">if</span>(remainder.length){
<a name="l01723"></a>01723             data = remainder.toString(<span class="stringliteral">&quot;base64&quot;</span>).replace(/.{76}/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>,<span class="stringliteral">&quot;$&amp;\r\n&quot;</span>);
<a name="l01724"></a>01724             <span class="keywordflow">if</span>(!this._cacheOutput){
<a name="l01725"></a>01725                 this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(data.trim()+<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01726"></a>01726             }<span class="keywordflow">else</span>{
<a name="l01727"></a>01727                 this._outputBuffer += data.trim()+<span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l01728"></a>01728             }
<a name="l01729"></a>01729         }
<a name="l01730"></a>01730         <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.nextTick(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01731"></a>01731     }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>));
<a name="l01732"></a>01732     
<a name="l01733"></a>01733     <span class="comment">// resume streaming if paused</span>
<a name="l01734"></a>01734     stream.resume();
<a name="l01735"></a>01735 };
<a name="l01736"></a>01736 
<a name="l01740"></a>01740 MailComposer.prototype._processBufferedOutput = <span class="keyword">function</span>(){
<a name="l01741"></a>01741     var dkimSignature;
<a name="l01742"></a>01742     
<a name="l01743"></a>01743     <span class="keywordflow">if</span>(this._dkim){        
<a name="l01744"></a>01744         <span class="keywordflow">if</span>((dkimSignature = DKIMSign(this._outputBuffer, this._dkim))){
<a name="l01745"></a>01745             this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(dkimSignature+<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01746"></a>01746         }
<a name="l01747"></a>01747     }
<a name="l01748"></a>01748     
<a name="l01749"></a>01749     this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&quot;data&quot;</span>, <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(this._outputBuffer, <span class="stringliteral">&quot;utf-8&quot;</span>));
<a name="l01750"></a>01750     
<a name="l01751"></a>01751     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.nextTick(this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>.bind(<span class="keyword">this</span>,<span class="stringliteral">&quot;end&quot;</span>));
<a name="l01752"></a>01752 };
<a name="l01753"></a>01753 
<a name="l01754"></a>01754 <span class="comment">/* HELPER FUNCTIONS */</span>
<a name="l01755"></a>01755 
<a name="l01768"></a>01768 MailComposer.prototype._normalizeKey = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>){
<a name="l01769"></a>01769     key = (key || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>().trim();
<a name="l01770"></a>01770     
<a name="l01771"></a>01771     <span class="comment">// If only uppercase letters, leave everything as is</span>
<a name="l01772"></a>01772     <span class="keywordflow">if</span>(key.match(/^<a class="code" href="../../da/d7d/sylvester_8js.html#af2f144226eef01a80d1ad95fc2c088d8">X</a>\-[A-Z0-9\-]+$/)){
<a name="l01773"></a>01773         <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>;
<a name="l01774"></a>01774     }
<a name="l01775"></a>01775     
<a name="l01776"></a>01776     <span class="comment">// Convert first letter upper case, others lower case </span>
<a name="l01777"></a>01777     <span class="keywordflow">return</span> key.
<a name="l01778"></a>01778         toLowerCase().
<a name="l01779"></a>01779         <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/^\S|[\-\s]\S/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a348d5281ca0f01adebb262bee8baf788">c</a>){
<a name="l01780"></a>01780             <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a348d5281ca0f01adebb262bee8baf788">c</a>.toUpperCase();
<a name="l01781"></a>01781         }).
<a name="l01782"></a>01782         <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/^MIME\-/i, <span class="stringliteral">&quot;MIME-&quot;</span>).
<a name="l01783"></a>01783         <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/^DKIM\-/i, <span class="stringliteral">&quot;DKIM-&quot;</span>);
<a name="l01784"></a>01784 };
<a name="l01785"></a>01785 
<a name="l01792"></a>01792 MailComposer.prototype._hasUTFChars = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>){
<a name="l01793"></a>01793     var rforeign = /[^\u0000-\u007f]/;
<a name="l01794"></a>01794     <span class="keywordflow">return</span> !!rforeign.test(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l01795"></a>01795 };
<a name="l01796"></a>01796 
<a name="l01802"></a>01802 MailComposer.prototype._generateBoundary = <span class="keyword">function</span>(){
<a name="l01803"></a>01803     <span class="comment">// &quot;_&quot; is not allowed in quoted-printable and &quot;?&quot; not in base64</span>
<a name="l01804"></a>01804     <span class="keywordflow">return</span> <span class="stringliteral">&quot;----mailcomposer-?=_&quot;</span>+(++this._gencounter)+<span class="stringliteral">&quot;-&quot;</span>+Date.now();
<a name="l01805"></a>01805 };
<a name="l01806"></a>01806 
<a name="l01820"></a>01820 MailComposer.prototype._encodeMimeWord = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, <a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>, maxlen){
<a name="l01821"></a>01821     <span class="keywordflow">return</span> mimelib.encodeMimeWords(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, encoding, maxlen);
<a name="l01822"></a>01822 };
<a name="l01823"></a>01823 
<a name="l01831"></a>01831 MailComposer.prototype._splitEncodedString = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, maxlen){
<a name="l01832"></a>01832     var curLine, <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>, chr, <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>,
<a name="l01833"></a>01833         <a class="code" href="../../de/deb/jsdbgapi_8h.html#a8e2960b7346236feeabed4635c5d39d6">lines</a> = [];
<a name="l01834"></a>01834 
<a name="l01835"></a>01835     <span class="keywordflow">while</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.length){
<a name="l01836"></a>01836         curLine = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.substr(0, maxlen);
<a name="l01837"></a>01837         
<a name="l01838"></a>01838         <span class="comment">// move incomplete escaped char back to main</span>
<a name="l01839"></a>01839         <span class="keywordflow">if</span>((match = curLine.match(/\=[0-9A-<a class="code" href="../../d9/d19/import__vcard__test_8js.html#a1fd406685cbdee605d0a7bebed56fdb0">F</a>]?$/i))){
<a name="l01840"></a>01840             curLine = curLine.substr(0, match.index);
<a name="l01841"></a>01841         }
<a name="l01842"></a>01842 
<a name="l01843"></a>01843         done = <span class="keyword">false</span>;
<a name="l01844"></a>01844         <span class="keywordflow">while</span>(!done){
<a name="l01845"></a>01845             done = <span class="keyword">true</span>;
<a name="l01846"></a>01846             <span class="comment">// check if not middle of a unicode char sequence</span>
<a name="l01847"></a>01847             <span class="keywordflow">if</span>((match = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.substr(curLine.length).match(/^\=([0-9A-<a class="code" href="../../d9/d19/import__vcard__test_8js.html#a1fd406685cbdee605d0a7bebed56fdb0">F</a>]{2})/i))){
<a name="l01848"></a>01848                 chr = parseInt(match[1], 16);
<a name="l01849"></a>01849                 <span class="comment">// invalid sequence, move one char back anc recheck</span>
<a name="l01850"></a>01850                 <span class="keywordflow">if</span>(chr &lt; 0xC2 &amp;&amp; chr &gt; 0x7F){
<a name="l01851"></a>01851                     curLine = curLine.substr(0, curLine.length-3);
<a name="l01852"></a>01852                     done = <span class="keyword">false</span>;
<a name="l01853"></a>01853                 }
<a name="l01854"></a>01854             }
<a name="l01855"></a>01855         }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857         <span class="keywordflow">if</span>(curLine.length){
<a name="l01858"></a>01858             lines.push(curLine);
<a name="l01859"></a>01859         }
<a name="l01860"></a>01860         <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.substr(curLine.length);
<a name="l01861"></a>01861     }
<a name="l01862"></a>01862 
<a name="l01863"></a>01863     <span class="keywordflow">return</span> <a class="code" href="../../de/deb/jsdbgapi_8h.html#a8e2960b7346236feeabed4635c5d39d6">lines</a>;
<a name="l01864"></a>01864 };
<a name="l01865"></a>01865 
<a name="l01866"></a>01866 
<a name="l01873"></a>01873 MailComposer.prototype._getMimeType = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>){
<a name="l01874"></a>01874     var defaultMime = <span class="stringliteral">&quot;application/octet-stream&quot;</span>,
<a name="l01875"></a>01875         extension = filename &amp;&amp; filename.substr(filename.lastIndexOf(<span class="stringliteral">&quot;.&quot;</span>)+1).<a class="code" href="../../d4/d23/binary__string__view_8js.html#ac7106a90f1d2ff063c3561a32c177ec0">trim</a>().toLowerCase();
<a name="l01876"></a>01876     <span class="keywordflow">return</span> extension &amp;&amp; mimelib.contentTypes[extension] || defaultMime;
<a name="l01877"></a>01877 };
<a name="l01878"></a>01878 });
<a name="l01879"></a>01879 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailcomposer&#39;</span>,[<span class="stringliteral">&#39;./mailcomposer/lib/mailcomposer&#39;</span>], <span class="keyword">function</span> (<a class="code" href="../../db/d0b/_image_editor_8js.html#a8fd8f854b393f98b5469a29042d701d1">main</a>) {
<a name="l01880"></a>01880     <span class="keywordflow">return</span> <a class="code" href="../../db/d0b/_image_editor_8js.html#a8fd8f854b393f98b5469a29042d701d1">main</a>;
<a name="l01881"></a>01881 });
<a name="l01886"></a>01886 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/composer&#39;</span>,
<a name="l01887"></a>01887   [
<a name="l01888"></a>01888     <span class="stringliteral">&#39;mailcomposer&#39;</span>,
<a name="l01889"></a>01889     <span class="stringliteral">&#39;./mailchew&#39;</span>,
<a name="l01890"></a>01890     <span class="stringliteral">&#39;./util&#39;</span>,
<a name="l01891"></a>01891     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l01892"></a>01892   ],
<a name="l01893"></a>01893   <span class="keyword">function</span>(
<a name="l01894"></a>01894     $mailcomposer,
<a name="l01895"></a>01895     $mailchew,
<a name="l01896"></a>01896     $imaputil,
<a name="l01897"></a>01897     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l01898"></a>01898   ) {
<a name="l01899"></a>01899 
<a name="l01900"></a>01900 <span class="comment">// Exports to make it easier for other modules to just require</span>
<a name="l01901"></a>01901 <span class="comment">// this module, but get access to these useful dependencies.</span>
<a name="l01902"></a>01902 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.mailchew = $mailchew;
<a name="l01903"></a>01903 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MailComposer = $mailcomposer;
<a name="l01904"></a>01904 
<a name="l01917"></a>01917 <span class="keyword">function</span> Composer(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>, wireRep, account, <a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>) {
<a name="l01918"></a>01918   this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> = <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>;
<a name="l01919"></a>01919   this.wireRep = wireRep;
<a name="l01920"></a>01920   this.account = account;
<a name="l01921"></a>01921   this.<a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a> = <a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923   this._asyncPending = 0;
<a name="l01924"></a>01924   this._deferredCalls = [];
<a name="l01925"></a>01925 
<a name="l01926"></a>01926   <span class="comment">// - snapshot data we create for consistency</span>
<a name="l01927"></a>01927   <span class="comment">// we create now so multiple MailComposer creations will</span>
<a name="l01928"></a>01928   <span class="comment">// have the same values.</span>
<a name="l01929"></a>01929   this.sentDate = <span class="keyword">new</span> Date();
<a name="l01930"></a>01930   <span class="comment">// we&#39;re copying nodemailer here; we might want to include some more...</span>
<a name="l01931"></a>01931   this.messageId =
<a name="l01932"></a>01932     <span class="charliteral">&#39;&lt;&#39;</span> + Date.now() + Math.random().toString(16).substr(1) + <span class="stringliteral">&#39;@mozgaia&gt;&#39;</span>;
<a name="l01933"></a>01933 
<a name="l01934"></a>01934   this._mcomposer = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01935"></a>01935   this._mcomposerOpts = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01936"></a>01936   this._buildMailComposer();
<a name="l01937"></a>01937 
<a name="l01938"></a>01938   this._attachments = [];
<a name="l01939"></a>01939 
<a name="l01940"></a>01940   <span class="comment">// - fetch attachments if sending</span>
<a name="l01941"></a>01941   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === <span class="stringliteral">&#39;send&#39;</span> &amp;&amp; wireRep.attachments) {
<a name="l01942"></a>01942     wireRep.attachments.forEach(<span class="keyword">function</span>(attachmentDef) {
<a name="l01943"></a>01943       var reader = <span class="keyword">new</span> FileReaderSync();
<a name="l01944"></a>01944       <span class="keywordflow">try</span> {
<a name="l01945"></a>01945         this._attachments.push({
<a name="l01946"></a>01946           filename: attachmentDef.name,
<a name="l01947"></a>01947           contentType: attachmentDef.blob.type,
<a name="l01948"></a>01948           <a class="code" href="../../d2/d7d/jsapi_8h.html#a0b8f0c0e9994662d9e96627991a9cbf1">contents</a>: <span class="keyword">new</span> <a class="code" href="../../d7/d4b/namespacemozilla_1_1dom.html#afb47a616d85cb1a7267e4ccdf85c0f94">Uint8Array</a>(reader.readAsArrayBuffer(attachmentDef.blob)),
<a name="l01949"></a>01949         });
<a name="l01950"></a>01950       }
<a name="l01951"></a>01951       <span class="keywordflow">catch</span> (ex) {
<a name="l01952"></a>01952         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Problem attaching attachment:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l01953"></a>01953       }
<a name="l01954"></a>01954     }.bind(<span class="keyword">this</span>));
<a name="l01955"></a>01955   }
<a name="l01956"></a>01956 }
<a name="l01957"></a>01957 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.Composer = Composer;
<a name="l01958"></a>01958 Composer.prototype = {
<a name="l01959"></a>01959   _buildMailComposer: <span class="keyword">function</span>() {
<a name="l01960"></a>01960     var wireRep = this.wireRep, body = wireRep.body;
<a name="l01961"></a>01961     var mcomposer = this._mcomposer = <span class="keyword">new</span> $mailcomposer.MailComposer();
<a name="l01962"></a>01962 
<a name="l01963"></a>01963     var messageOpts = {
<a name="l01964"></a>01964       from: $imaputil.formatAddresses([this.<a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>]),
<a name="l01965"></a>01965       <a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a>: wireRep.subject,
<a name="l01966"></a>01966     };
<a name="l01967"></a>01967     <span class="keywordflow">if</span> (body.html) {
<a name="l01968"></a>01968       messageOpts.html = $mailchew.mergeUserTextWithHTML(body.text, body.html);
<a name="l01969"></a>01969     }
<a name="l01970"></a>01970     <span class="keywordflow">else</span> {
<a name="l01971"></a>01971       messageOpts.body = body.text;
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973 
<a name="l01974"></a>01974     <span class="keywordflow">if</span> (this.<a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>.replyTo)
<a name="l01975"></a>01975       messageOpts.replyTo = this.<a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>.replyTo;
<a name="l01976"></a>01976     <span class="keywordflow">if</span> (wireRep.to &amp;&amp; wireRep.to.length)
<a name="l01977"></a>01977       messageOpts.to = $imaputil.formatAddresses(wireRep.to);
<a name="l01978"></a>01978     <span class="keywordflow">if</span> (wireRep.cc &amp;&amp; wireRep.cc.length)
<a name="l01979"></a>01979       messageOpts.cc = $imaputil.formatAddresses(wireRep.cc);
<a name="l01980"></a>01980     <span class="keywordflow">if</span> (wireRep.bcc &amp;&amp; wireRep.bcc.length)
<a name="l01981"></a>01981       messageOpts.bcc = $imaputil.formatAddresses(wireRep.bcc);
<a name="l01982"></a>01982     mcomposer.setMessageOption(messageOpts);
<a name="l01983"></a>01983 
<a name="l01984"></a>01984     <span class="keywordflow">if</span> (wireRep.customHeaders) {
<a name="l01985"></a>01985       <span class="keywordflow">for</span> (var iHead = 0; iHead &lt; wireRep.customHeaders.length; iHead += 2){
<a name="l01986"></a>01986         mcomposer.addHeader(wireRep.customHeaders[iHead],
<a name="l01987"></a>01987                            wireRep.customHeaders[iHead+1]);
<a name="l01988"></a>01988       }
<a name="l01989"></a>01989     }
<a name="l01990"></a>01990     mcomposer.addHeader(<span class="stringliteral">&#39;User-Agent&#39;</span>, <span class="stringliteral">&#39;Mozilla Gaia Email Client 0.1alpha2&#39;</span>);
<a name="l01991"></a>01991     mcomposer.addHeader(<span class="stringliteral">&#39;Date&#39;</span>, this.sentDate.toUTCString());
<a name="l01992"></a>01992 
<a name="l01993"></a>01993     mcomposer.addHeader(<span class="stringliteral">&#39;Message-Id&#39;</span>, this.messageId);
<a name="l01994"></a>01994     <span class="keywordflow">if</span> (wireRep.referencesStr)
<a name="l01995"></a>01995       mcomposer.addHeader(<span class="stringliteral">&#39;References&#39;</span>, wireRep.referencesStr);
<a name="l01996"></a>01996   },
<a name="l01997"></a>01997 
<a name="l02005"></a>02005   _ensureBodyWithOpts: <span class="keyword">function</span>(opts) {
<a name="l02006"></a>02006     <span class="comment">// reuse the existing body if possible</span>
<a name="l02007"></a>02007     <span class="keywordflow">if</span> (this._mcomposerOpts &amp;&amp;
<a name="l02008"></a>02008         this._mcomposerOpts.includeBcc === opts.includeBcc) {
<a name="l02009"></a>02009       <span class="keywordflow">return</span>;
<a name="l02010"></a>02010     }
<a name="l02011"></a>02011     <span class="comment">// if we already build a body, we need to create a new mcomposer</span>
<a name="l02012"></a>02012     <span class="keywordflow">if</span> (this._mcomposerOpts !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l02013"></a>02013       this._buildMailComposer();
<a name="l02014"></a>02014     <span class="comment">// save the opts for next time</span>
<a name="l02015"></a>02015     this._mcomposerOpts = opts;
<a name="l02016"></a>02016     <span class="comment">// it&#39;s fine to directly clobber this in</span>
<a name="l02017"></a>02017     this._mcomposer.options.keepBcc = opts.includeBcc;
<a name="l02018"></a>02018 
<a name="l02019"></a>02019     <span class="keywordflow">for</span> (var iAtt = 0; iAtt &lt; this._attachments.length; iAtt++) {
<a name="l02020"></a>02020       this._mcomposer.addAttachment(this._attachments[iAtt]);
<a name="l02021"></a>02021     }
<a name="l02022"></a>02022 
<a name="l02023"></a>02023     <span class="comment">// Render the message to its output buffer.</span>
<a name="l02024"></a>02024     var mcomposer = this._mcomposer;
<a name="l02025"></a>02025     mcomposer._cacheOutput = <span class="keyword">true</span>;
<a name="l02026"></a>02026     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.immediate = <span class="keyword">true</span>;
<a name="l02027"></a>02027     mcomposer._processBufferedOutput = <span class="keyword">function</span>() {
<a name="l02028"></a>02028       <span class="comment">// we are stopping the DKIM logic from firing.</span>
<a name="l02029"></a>02029     };
<a name="l02030"></a>02030     mcomposer._composeMessage();
<a name="l02031"></a>02031     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.immediate = <span class="keyword">false</span>;
<a name="l02032"></a>02032 
<a name="l02033"></a>02033     <span class="comment">// (the data is now in mcomposer._outputBuffer)</span>
<a name="l02034"></a>02034   },
<a name="l02035"></a>02035 
<a name="l02036"></a>02036   _asyncLoadsCompleted: <span class="keyword">function</span>() {
<a name="l02037"></a>02037     <span class="keywordflow">while</span> (this._deferredCalls.length) {
<a name="l02038"></a>02038       var toCall = this._deferredCalls.shift();
<a name="l02039"></a>02039       toCall();
<a name="l02040"></a>02040     }
<a name="l02041"></a>02041   },
<a name="l02042"></a>02042 
<a name="l02043"></a>02043   getEnvelope: <span class="keyword">function</span>() {
<a name="l02044"></a>02044     <span class="keywordflow">return</span> this._mcomposer.getEnvelope();
<a name="l02045"></a>02045   },
<a name="l02046"></a>02046 
<a name="l02069"></a>02069   withMessageBuffer: <span class="keyword">function</span>(opts, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02070"></a>02070     <span class="keywordflow">if</span> (this._asyncPending) {
<a name="l02071"></a>02071       this._deferredCalls.push(
<a name="l02072"></a>02072         this.withMessageBuffer.bind(<span class="keyword">this</span>, opts, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>));
<a name="l02073"></a>02073       <span class="keywordflow">return</span>;
<a name="l02074"></a>02074     }
<a name="l02075"></a>02075 
<a name="l02076"></a>02076     this._ensureBodyWithOpts(opts);
<a name="l02077"></a>02077     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(this._mcomposer._outputBuffer);
<a name="l02078"></a>02078   },
<a name="l02079"></a>02079 };
<a name="l02080"></a>02080 
<a name="l02081"></a>02081 }); <span class="comment">// end define</span>
<a name="l02082"></a>02082 ;
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d2/d10/apps_2email_2js_2ext_2mailapi_2composer_8js.html">composer.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:51:44に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
