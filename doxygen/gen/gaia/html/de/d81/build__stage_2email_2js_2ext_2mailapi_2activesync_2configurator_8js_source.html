<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: configurator.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('de/d81/build__stage_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">configurator.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../de/d81/build__stage_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">/* Copyright 2012 Mozilla Foundation</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00005"></a>00005 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00006"></a>00006 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00011"></a>00011 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00012"></a>00012 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00013"></a>00013 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00014"></a>00014 <span class="comment"> * limitations under the License.</span>
<a name="l00015"></a>00015 <span class="comment"> */</span>
<a name="l00016"></a>00016 
<a name="l00017"></a><a class="code" href="../../de/d81/build__stage_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">00017</a> (<span class="keyword">function</span> (<a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>, factory) {
<a name="l00018"></a>00018   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a> === <span class="stringliteral">&#39;object&#39;</span>)
<a name="l00019"></a>00019     <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = factory();
<a name="l00020"></a>00020   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a> === <span class="stringliteral">&#39;function&#39;</span> &amp;&amp; <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>.amd)
<a name="l00021"></a>00021     <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;activesync/codepages/FolderHierarchy&#39;</span>,[], factory);
<a name="l00022"></a>00022   <span class="keywordflow">else</span>
<a name="l00023"></a>00023     <a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>.ASCPHierarchy = factory();
<a name="l00024"></a>00024 }(<span class="keyword">this</span>, <span class="keyword">function</span>() {
<a name="l00025"></a>00025   
<a name="l00026"></a>00026 
<a name="l00027"></a>00027   <span class="keywordflow">return</span> {
<a name="l00028"></a>00028     Tags: {
<a name="l00029"></a>00029       Folders:      0x0705,
<a name="l00030"></a>00030       Folder:       0x0706,
<a name="l00031"></a>00031       DisplayName:  0x0707,
<a name="l00032"></a>00032       ServerId:     0x0708,
<a name="l00033"></a>00033       ParentId:     0x0709,
<a name="l00034"></a>00034       <a class="code" href="../../d3/d0f/ns_display_item_types_8h.html#a1d1cfd8ffb84e947f82999c682b666a7">Type</a>:         0x070A,
<a name="l00035"></a>00035       Response:     0x070B,
<a name="l00036"></a>00036       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>:       0x070C,
<a name="l00037"></a>00037       ContentClass: 0x070D,
<a name="l00038"></a>00038       Changes:      0x070E,
<a name="l00039"></a>00039       Add:          0x070F,
<a name="l00040"></a>00040       Delete:       0x0710,
<a name="l00041"></a>00041       Update:       0x0711,
<a name="l00042"></a>00042       SyncKey:      0x0712,
<a name="l00043"></a>00043       FolderCreate: 0x0713,
<a name="l00044"></a>00044       FolderDelete: 0x0714,
<a name="l00045"></a>00045       FolderUpdate: 0x0715,
<a name="l00046"></a>00046       FolderSync:   0x0716,
<a name="l00047"></a>00047       Count:        0x0717,
<a name="l00048"></a>00048     },
<a name="l00049"></a>00049     Enums: {
<a name="l00050"></a>00050       <a class="code" href="../../d3/d0f/ns_display_item_types_8h.html#a1d1cfd8ffb84e947f82999c682b666a7">Type</a>: {
<a name="l00051"></a>00051         <a class="code" href="../../d0/dbd/namespacemozilla_1_1threads.html#abed925db1ce870c04cef57bb3ef86a77a0823274ce03c12ea79d8b8490dfeb8ff">Generic</a>:         <span class="charliteral">&#39;1&#39;</span>,
<a name="l00052"></a>00052         DefaultInbox:    <span class="charliteral">&#39;2&#39;</span>,
<a name="l00053"></a>00053         DefaultDrafts:   <span class="charliteral">&#39;3&#39;</span>,
<a name="l00054"></a>00054         DefaultDeleted:  <span class="charliteral">&#39;4&#39;</span>,
<a name="l00055"></a>00055         DefaultSent:     <span class="charliteral">&#39;5&#39;</span>,
<a name="l00056"></a>00056         DefaultOutbox:   <span class="charliteral">&#39;6&#39;</span>,
<a name="l00057"></a>00057         DefaultTasks:    <span class="charliteral">&#39;7&#39;</span>,
<a name="l00058"></a>00058         DefaultCalendar: <span class="charliteral">&#39;8&#39;</span>,
<a name="l00059"></a>00059         DefaultContacts: <span class="charliteral">&#39;9&#39;</span>,
<a name="l00060"></a>00060         DefaultNotes:   <span class="stringliteral">&#39;10&#39;</span>,
<a name="l00061"></a>00061         DefaultJournal: <span class="stringliteral">&#39;11&#39;</span>,
<a name="l00062"></a>00062         Mail:           <span class="stringliteral">&#39;12&#39;</span>,
<a name="l00063"></a>00063         <a class="code" href="../../d4/d99/create__event__test_8js.html#a4a0f6a3a1b73d50ac6e8a34fe754f79f">Calendar</a>:       <span class="stringliteral">&#39;13&#39;</span>,
<a name="l00064"></a>00064         <a class="code" href="../../d7/d68/apps_2communications_2contacts_2js_2contacts_8js.html#a55257a4a6c5aab93045fd427504a1c95">Contacts</a>:       <span class="stringliteral">&#39;14&#39;</span>,
<a name="l00065"></a>00065         Tasks:          <span class="stringliteral">&#39;15&#39;</span>,
<a name="l00066"></a>00066         Journal:        <span class="stringliteral">&#39;16&#39;</span>,
<a name="l00067"></a>00067         Notes:          <span class="stringliteral">&#39;17&#39;</span>,
<a name="l00068"></a>00068         <a class="code" href="../../d8/d00/namespacemozilla_1_1gl.html#ab5b0d7a0e0b562dfa17e536a3e788071">Unknown</a>:        <span class="stringliteral">&#39;18&#39;</span>,
<a name="l00069"></a>00069         RecipientCache: <span class="stringliteral">&#39;19&#39;</span>,
<a name="l00070"></a>00070       },
<a name="l00071"></a>00071       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>: {
<a name="l00072"></a>00072         Success:              <span class="charliteral">&#39;1&#39;</span>,
<a name="l00073"></a>00073         FolderExists:         <span class="charliteral">&#39;2&#39;</span>,
<a name="l00074"></a>00074         SystemFolder:         <span class="charliteral">&#39;3&#39;</span>,
<a name="l00075"></a>00075         FolderNotFound:       <span class="charliteral">&#39;4&#39;</span>,
<a name="l00076"></a>00076         ParentFolderNotFound: <span class="charliteral">&#39;5&#39;</span>,
<a name="l00077"></a>00077         ServerError:          <span class="charliteral">&#39;6&#39;</span>,
<a name="l00078"></a>00078         InvalidSyncKey:       <span class="charliteral">&#39;9&#39;</span>,
<a name="l00079"></a>00079         MalformedRequest:    <span class="stringliteral">&#39;10&#39;</span>,
<a name="l00080"></a>00080         UnknownError:        <span class="stringliteral">&#39;11&#39;</span>,
<a name="l00081"></a>00081         CodeUnknown:         <span class="stringliteral">&#39;12&#39;</span>,
<a name="l00082"></a>00082       }
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084   };
<a name="l00085"></a>00085 }));
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">/* Copyright 2012 Mozilla Foundation</span>
<a name="l00088"></a>00088 <span class="comment"> *</span>
<a name="l00089"></a>00089 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00090"></a>00090 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00091"></a>00091 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00092"></a>00092 <span class="comment"> *</span>
<a name="l00093"></a>00093 <span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00094"></a>00094 <span class="comment"> *</span>
<a name="l00095"></a>00095 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00096"></a>00096 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00097"></a>00097 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00098"></a>00098 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00099"></a>00099 <span class="comment"> * limitations under the License.</span>
<a name="l00100"></a>00100 <span class="comment"> */</span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 (<span class="keyword">function</span> (<a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>, factory) {
<a name="l00103"></a>00103   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a> === <span class="stringliteral">&#39;object&#39;</span>)
<a name="l00104"></a>00104     <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = factory();
<a name="l00105"></a>00105   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a> === <span class="stringliteral">&#39;function&#39;</span> &amp;&amp; <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>.amd)
<a name="l00106"></a>00106     <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;activesync/codepages/AirSync&#39;</span>,[], factory);
<a name="l00107"></a>00107   <span class="keywordflow">else</span>
<a name="l00108"></a>00108     <a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>.ASCPAirSync = factory();
<a name="l00109"></a>00109 }(<span class="keyword">this</span>, <span class="keyword">function</span>() {
<a name="l00110"></a>00110   
<a name="l00111"></a>00111   <span class="keywordflow">return</span> {
<a name="l00112"></a>00112     Tags: {
<a name="l00113"></a>00113       <a class="code" href="../../db/d94/fb__sync__init_8js.html#a1fd6364597d4fb96e95ad0dae3c46dc5">Sync</a>:              0x0005,
<a name="l00114"></a>00114       Responses:         0x0006,
<a name="l00115"></a>00115       Add:               0x0007,
<a name="l00116"></a>00116       Change:            0x0008,
<a name="l00117"></a>00117       Delete:            0x0009,
<a name="l00118"></a>00118       Fetch:             0x000A,
<a name="l00119"></a>00119       SyncKey:           0x000B,
<a name="l00120"></a>00120       ClientId:          0x000C,
<a name="l00121"></a>00121       ServerId:          0x000D,
<a name="l00122"></a>00122       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>:            0x000E,
<a name="l00123"></a>00123       <a class="code" href="../../df/d44/grid__components_8js.html#acc6de2d70f945bc253e6fdf2a35e72ad">Collection</a>:        0x000F,
<a name="l00124"></a>00124       <a class="code" href="../../dc/d00/namespacemozilla_1_1dom_1_1_analyser_node_binding.html#a146b502b5cb5700cee67d7d16d6a981c">Class</a>:             0x0010,
<a name="l00125"></a>00125       Version:           0x0011,
<a name="l00126"></a>00126       CollectionId:      0x0012,
<a name="l00127"></a>00127       GetChanges:        0x0013,
<a name="l00128"></a>00128       MoreAvailable:     0x0014,
<a name="l00129"></a>00129       WindowSize:        0x0015,
<a name="l00130"></a>00130       <a class="code" href="../../d3/da8/worker_8js.html#a21d4036b3d8a8b53e7fec2cc4c72b83c">Commands</a>:          0x0016,
<a name="l00131"></a>00131       Options:           0x0017,
<a name="l00132"></a>00132       FilterType:        0x0018,
<a name="l00133"></a>00133       Truncation:        0x0019,
<a name="l00134"></a>00134       RtfTruncation:     0x001A,
<a name="l00135"></a>00135       Conflict:          0x001B,
<a name="l00136"></a>00136       Collections:       0x001C,
<a name="l00137"></a>00137       ApplicationData:   0x001D,
<a name="l00138"></a>00138       DeletesAsMoves:    0x001E,
<a name="l00139"></a>00139       NotifyGUID:        0x001F,
<a name="l00140"></a>00140       Supported:         0x0020,
<a name="l00141"></a>00141       SoftDelete:        0x0021,
<a name="l00142"></a>00142       MIMESupport:       0x0022,
<a name="l00143"></a>00143       MIMETruncation:    0x0023,
<a name="l00144"></a>00144       Wait:              0x0024,
<a name="l00145"></a>00145       Limit:             0x0025,
<a name="l00146"></a>00146       Partial:           0x0026,
<a name="l00147"></a>00147       ConversationMode:  0x0027,
<a name="l00148"></a>00148       MaxItems:          0x0028,
<a name="l00149"></a>00149       HeartbeatInterval: 0x0029,
<a name="l00150"></a>00150     },
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     Enums: {
<a name="l00153"></a>00153       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>: {
<a name="l00154"></a>00154         Success:            <span class="charliteral">&#39;1&#39;</span>,
<a name="l00155"></a>00155         InvalidSyncKey:     <span class="charliteral">&#39;3&#39;</span>,
<a name="l00156"></a>00156         ProtocolError:      <span class="charliteral">&#39;4&#39;</span>,
<a name="l00157"></a>00157         ServerError:        <span class="charliteral">&#39;5&#39;</span>,
<a name="l00158"></a>00158         ConversionError:    <span class="charliteral">&#39;6&#39;</span>,
<a name="l00159"></a>00159         MatchingConflict:   <span class="charliteral">&#39;7&#39;</span>,
<a name="l00160"></a>00160         ObjectNotFound:     <span class="charliteral">&#39;8&#39;</span>,
<a name="l00161"></a>00161         OutOfSpace:         <span class="charliteral">&#39;9&#39;</span>,
<a name="l00162"></a>00162         HierarchyChanged:  <span class="stringliteral">&#39;12&#39;</span>,
<a name="l00163"></a>00163         IncompleteRequest: <span class="stringliteral">&#39;13&#39;</span>,
<a name="l00164"></a>00164         InvalidInterval:   <span class="stringliteral">&#39;14&#39;</span>,
<a name="l00165"></a>00165         InvalidRequest:    <span class="stringliteral">&#39;15&#39;</span>,
<a name="l00166"></a>00166         Retry:             <span class="stringliteral">&#39;16&#39;</span>,
<a name="l00167"></a>00167       },
<a name="l00168"></a>00168       FilterType: {
<a name="l00169"></a>00169         NoFilter:        <span class="charliteral">&#39;0&#39;</span>,
<a name="l00170"></a>00170         OneDayBack:      <span class="charliteral">&#39;1&#39;</span>,
<a name="l00171"></a>00171         ThreeDaysBack:   <span class="charliteral">&#39;2&#39;</span>,
<a name="l00172"></a>00172         OneWeekBack:     <span class="charliteral">&#39;3&#39;</span>,
<a name="l00173"></a>00173         TwoWeeksBack:    <span class="charliteral">&#39;4&#39;</span>,
<a name="l00174"></a>00174         OneMonthBack:    <span class="charliteral">&#39;5&#39;</span>,
<a name="l00175"></a>00175         ThreeMonthsBack: <span class="charliteral">&#39;6&#39;</span>,
<a name="l00176"></a>00176         SixMonthsBack:   <span class="charliteral">&#39;7&#39;</span>,
<a name="l00177"></a>00177         IncompleteTasks: <span class="charliteral">&#39;8&#39;</span>,
<a name="l00178"></a>00178       },
<a name="l00179"></a>00179       Conflict: {
<a name="l00180"></a>00180         ClientReplacesServer: <span class="charliteral">&#39;0&#39;</span>,
<a name="l00181"></a>00181         ServerReplacesClient: <span class="charliteral">&#39;1&#39;</span>,
<a name="l00182"></a>00182       },
<a name="l00183"></a>00183       MIMESupport: {
<a name="l00184"></a>00184         Never:     <span class="charliteral">&#39;0&#39;</span>,
<a name="l00185"></a>00185         SMIMEOnly: <span class="charliteral">&#39;1&#39;</span>,
<a name="l00186"></a>00186         Always:    <span class="charliteral">&#39;2&#39;</span>,
<a name="l00187"></a>00187       },
<a name="l00188"></a>00188       MIMETruncation: {
<a name="l00189"></a>00189         TruncateAll:  <span class="charliteral">&#39;0&#39;</span>,
<a name="l00190"></a>00190         Truncate4K:   <span class="charliteral">&#39;1&#39;</span>,
<a name="l00191"></a>00191         Truncate5K:   <span class="charliteral">&#39;2&#39;</span>,
<a name="l00192"></a>00192         Truncate7K:   <span class="charliteral">&#39;3&#39;</span>,
<a name="l00193"></a>00193         Truncate10K:  <span class="charliteral">&#39;4&#39;</span>,
<a name="l00194"></a>00194         Truncate20K:  <span class="charliteral">&#39;5&#39;</span>,
<a name="l00195"></a>00195         Truncate50K:  <span class="charliteral">&#39;6&#39;</span>,
<a name="l00196"></a>00196         Truncate100K: <span class="charliteral">&#39;7&#39;</span>,
<a name="l00197"></a>00197         NoTruncate:   <span class="charliteral">&#39;8&#39;</span>,
<a name="l00198"></a>00198       },
<a name="l00199"></a>00199     },
<a name="l00200"></a>00200   };
<a name="l00201"></a>00201 }));
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="comment">/* Copyright 2012 Mozilla Foundation</span>
<a name="l00204"></a>00204 <span class="comment"> *</span>
<a name="l00205"></a>00205 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00206"></a>00206 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00207"></a>00207 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00208"></a>00208 <span class="comment"> *</span>
<a name="l00209"></a>00209 <span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00210"></a>00210 <span class="comment"> *</span>
<a name="l00211"></a>00211 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00212"></a>00212 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00213"></a>00213 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00214"></a>00214 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00215"></a>00215 <span class="comment"> * limitations under the License.</span>
<a name="l00216"></a>00216 <span class="comment"> */</span>
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 (<span class="keyword">function</span> (<a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>, factory) {
<a name="l00219"></a>00219   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a> === <span class="stringliteral">&#39;object&#39;</span>)
<a name="l00220"></a>00220     <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = factory();
<a name="l00221"></a>00221   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a> === <span class="stringliteral">&#39;function&#39;</span> &amp;&amp; <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>.amd)
<a name="l00222"></a>00222     <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;activesync/codepages/AirSyncBase&#39;</span>,[], factory);
<a name="l00223"></a>00223   <span class="keywordflow">else</span>
<a name="l00224"></a>00224     <a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>.ASCPAirSyncBase = factory();
<a name="l00225"></a>00225 }(<span class="keyword">this</span>, <span class="keyword">function</span>() {
<a name="l00226"></a>00226   
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="keywordflow">return</span> {
<a name="l00229"></a>00229     Tags: {
<a name="l00230"></a>00230       BodyPreference:     0x1105,
<a name="l00231"></a>00231       <a class="code" href="../../d3/d0f/ns_display_item_types_8h.html#a1d1cfd8ffb84e947f82999c682b666a7">Type</a>:               0x1106,
<a name="l00232"></a>00232       TruncationSize:     0x1107,
<a name="l00233"></a>00233       AllOrNone:          0x1108,
<a name="l00234"></a>00234       Reserved:           0x1109,
<a name="l00235"></a>00235       Body:               0x110A,
<a name="l00236"></a>00236       Data:               0x110B,
<a name="l00237"></a>00237       EstimatedDataSize:  0x110C,
<a name="l00238"></a>00238       Truncated:          0x110D,
<a name="l00239"></a>00239       Attachments:        0x110E,
<a name="l00240"></a>00240       Attachment:         0x110F,
<a name="l00241"></a>00241       DisplayName:        0x1110,
<a name="l00242"></a>00242       FileReference:      0x1111,
<a name="l00243"></a>00243       Method:             0x1112,
<a name="l00244"></a>00244       ContentId:          0x1113,
<a name="l00245"></a>00245       ContentLocation:    0x1114,
<a name="l00246"></a>00246       IsInline:           0x1115,
<a name="l00247"></a>00247       NativeBodyType:     0x1116,
<a name="l00248"></a>00248       ContentType:        0x1117,
<a name="l00249"></a>00249       Preview:            0x1118,
<a name="l00250"></a>00250       BodyPartPreference: 0x1119,
<a name="l00251"></a>00251       BodyPart:           0x111A,
<a name="l00252"></a>00252       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>:             0x111B,
<a name="l00253"></a>00253     },
<a name="l00254"></a>00254     Enums: {
<a name="l00255"></a>00255       <a class="code" href="../../d3/d0f/ns_display_item_types_8h.html#a1d1cfd8ffb84e947f82999c682b666a7">Type</a>: {
<a name="l00256"></a>00256         PlainText: <span class="charliteral">&#39;1&#39;</span>,
<a name="l00257"></a>00257         HTML:      <span class="charliteral">&#39;2&#39;</span>,
<a name="l00258"></a>00258         RTF:       <span class="charliteral">&#39;3&#39;</span>,
<a name="l00259"></a>00259         MIME:      <span class="charliteral">&#39;4&#39;</span>,
<a name="l00260"></a>00260       },
<a name="l00261"></a>00261       Method: {
<a name="l00262"></a>00262         Normal:          <span class="charliteral">&#39;1&#39;</span>,
<a name="l00263"></a>00263         EmbeddedMessage: <span class="charliteral">&#39;5&#39;</span>,
<a name="l00264"></a>00264         AttachOLE:       <span class="charliteral">&#39;6&#39;</span>,
<a name="l00265"></a>00265       },
<a name="l00266"></a>00266       NativeBodyType: {
<a name="l00267"></a>00267         PlainText: <span class="charliteral">&#39;1&#39;</span>,
<a name="l00268"></a>00268         HTML:      <span class="charliteral">&#39;2&#39;</span>,
<a name="l00269"></a>00269         RTF:       <span class="charliteral">&#39;3&#39;</span>,
<a name="l00270"></a>00270       },
<a name="l00271"></a>00271       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>: {
<a name="l00272"></a>00272         Success: <span class="charliteral">&#39;1&#39;</span>,
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275   };
<a name="l00276"></a>00276 }));
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="comment">/* Copyright 2012 Mozilla Foundation</span>
<a name="l00279"></a>00279 <span class="comment"> *</span>
<a name="l00280"></a>00280 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00281"></a>00281 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00282"></a>00282 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00283"></a>00283 <span class="comment"> *</span>
<a name="l00284"></a>00284 <span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00285"></a>00285 <span class="comment"> *</span>
<a name="l00286"></a>00286 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00287"></a>00287 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00288"></a>00288 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00289"></a>00289 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00290"></a>00290 <span class="comment"> * limitations under the License.</span>
<a name="l00291"></a>00291 <span class="comment"> */</span>
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 (<span class="keyword">function</span> (<a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>, factory) {
<a name="l00294"></a>00294   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a> === <span class="stringliteral">&#39;object&#39;</span>)
<a name="l00295"></a>00295     <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = factory();
<a name="l00296"></a>00296   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a> === <span class="stringliteral">&#39;function&#39;</span> &amp;&amp; <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>.amd)
<a name="l00297"></a>00297     <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;activesync/codepages/ItemEstimate&#39;</span>,[], factory);
<a name="l00298"></a>00298   <span class="keywordflow">else</span>
<a name="l00299"></a>00299     <a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>.ASCPItemEstimate = factory();
<a name="l00300"></a>00300 }(<span class="keyword">this</span>, <span class="keyword">function</span>() {
<a name="l00301"></a>00301   
<a name="l00302"></a>00302 
<a name="l00303"></a>00303   <span class="keywordflow">return</span> {
<a name="l00304"></a>00304     Tags: {
<a name="l00305"></a>00305       GetItemEstimate: 0x0605,
<a name="l00306"></a>00306       Version:         0x0606,
<a name="l00307"></a>00307       Collections:     0x0607,
<a name="l00308"></a>00308       <a class="code" href="../../df/d44/grid__components_8js.html#acc6de2d70f945bc253e6fdf2a35e72ad">Collection</a>:      0x0608,
<a name="l00309"></a>00309       <a class="code" href="../../dc/d00/namespacemozilla_1_1dom_1_1_analyser_node_binding.html#a146b502b5cb5700cee67d7d16d6a981c">Class</a>:           0x0609,
<a name="l00310"></a>00310       CollectionId:    0x060A,
<a name="l00311"></a>00311       DateTime:        0x060B,
<a name="l00312"></a>00312       Estimate:        0x060C,
<a name="l00313"></a>00313       Response:        0x060D,
<a name="l00314"></a>00314       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>:          0x060E,
<a name="l00315"></a>00315     },
<a name="l00316"></a>00316     Enums: {
<a name="l00317"></a>00317       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>: {
<a name="l00318"></a>00318         Success:           <span class="charliteral">&#39;1&#39;</span>,
<a name="l00319"></a>00319         InvalidCollection: <span class="charliteral">&#39;2&#39;</span>,
<a name="l00320"></a>00320         NoSyncState:       <span class="charliteral">&#39;3&#39;</span>,
<a name="l00321"></a>00321         InvalidSyncKey:    <span class="charliteral">&#39;4&#39;</span>,
<a name="l00322"></a>00322       },
<a name="l00323"></a>00323     },
<a name="l00324"></a>00324   };
<a name="l00325"></a>00325 }));
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 <span class="comment">/* Copyright 2012 Mozilla Foundation</span>
<a name="l00328"></a>00328 <span class="comment"> *</span>
<a name="l00329"></a>00329 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00330"></a>00330 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00331"></a>00331 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00332"></a>00332 <span class="comment"> *</span>
<a name="l00333"></a>00333 <span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00334"></a>00334 <span class="comment"> *</span>
<a name="l00335"></a>00335 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00336"></a>00336 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00337"></a>00337 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00338"></a>00338 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00339"></a>00339 <span class="comment"> * limitations under the License.</span>
<a name="l00340"></a>00340 <span class="comment"> */</span>
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 (<span class="keyword">function</span> (<a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>, factory) {
<a name="l00343"></a>00343   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a> === <span class="stringliteral">&#39;object&#39;</span>)
<a name="l00344"></a>00344     <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = factory();
<a name="l00345"></a>00345   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a> === <span class="stringliteral">&#39;function&#39;</span> &amp;&amp; <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>.amd)
<a name="l00346"></a>00346     <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;activesync/codepages/Email&#39;</span>,[], factory);
<a name="l00347"></a>00347   <span class="keywordflow">else</span>
<a name="l00348"></a>00348     <a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>.ASCPEmail = factory();
<a name="l00349"></a>00349 }(<span class="keyword">this</span>, <span class="keyword">function</span>() {
<a name="l00350"></a>00350   
<a name="l00351"></a>00351 
<a name="l00352"></a>00352   <span class="keywordflow">return</span> {
<a name="l00353"></a>00353     Tags: {
<a name="l00354"></a>00354       Attachment:              0x0205,
<a name="l00355"></a>00355       Attachments:             0x0206,
<a name="l00356"></a>00356       AttName:                 0x0207,
<a name="l00357"></a>00357       AttSize:                 0x0208,
<a name="l00358"></a>00358       Att0Id:                  0x0209,
<a name="l00359"></a>00359       AttMethod:               0x020A,
<a name="l00360"></a>00360       AttRemoved:              0x020B,
<a name="l00361"></a>00361       Body:                    0x020C,
<a name="l00362"></a>00362       BodySize:                0x020D,
<a name="l00363"></a>00363       BodyTruncated:           0x020E,
<a name="l00364"></a>00364       DateReceived:            0x020F,
<a name="l00365"></a>00365       DisplayName:             0x0210,
<a name="l00366"></a>00366       DisplayTo:               0x0211,
<a name="l00367"></a>00367       Importance:              0x0212,
<a name="l00368"></a>00368       <a class="code" href="../../db/db2/namespacemozilla_1_1dom_1_1mobilemessage.html#a012ad125867222bbb5bd5e33d4ab39c5">MessageClass</a>:            0x0213,
<a name="l00369"></a>00369       Subject:                 0x0214,
<a name="l00370"></a>00370       Read:                    0x0215,
<a name="l00371"></a>00371       To:                      0x0216,
<a name="l00372"></a>00372       <a class="code" href="../../d8/d30/xpcshell-commonjs_8js.html#aaab345ebd6e7cd0de0e09fa6bef9ee3e">Cc</a>:                      0x0217,
<a name="l00373"></a>00373       From:                    0x0218,
<a name="l00374"></a>00374       ReplyTo:                 0x0219,
<a name="l00375"></a>00375       AllDayEvent:             0x021A,
<a name="l00376"></a>00376       Categories:              0x021B,
<a name="l00377"></a>00377       Category:                0x021C,
<a name="l00378"></a>00378       DTStamp:                 0x021D,
<a name="l00379"></a>00379       EndTime:                 0x021E,
<a name="l00380"></a>00380       InstanceType:            0x021F,
<a name="l00381"></a>00381       BusyStatus:              0x0220,
<a name="l00382"></a>00382       <a class="code" href="../../db/d58/_location_8js.html#a7366a814bfa5054e86e9064d6b20e058">Location</a>:                0x0221,
<a name="l00383"></a>00383       MeetingRequest:          0x0222,
<a name="l00384"></a>00384       Organizer:               0x0223,
<a name="l00385"></a>00385       RecurrenceId:            0x0224,
<a name="l00386"></a>00386       Reminder:                0x0225,
<a name="l00387"></a>00387       ResponseRequested:       0x0226,
<a name="l00388"></a>00388       Recurrences:             0x0227,
<a name="l00389"></a>00389       Recurrence:              0x0228,
<a name="l00390"></a>00390       Recurrence_Type:         0x0229,
<a name="l00391"></a>00391       Recurrence_Until:        0x022A,
<a name="l00392"></a>00392       Recurrence_Occurrences:  0x022B,
<a name="l00393"></a>00393       Recurrence_Interval:     0x022C,
<a name="l00394"></a>00394       Recurrence_DayOfWeek:    0x022D,
<a name="l00395"></a>00395       Recurrence_DayOfMonth:   0x022E,
<a name="l00396"></a>00396       Recurrence_WeekOfMonth:  0x022F,
<a name="l00397"></a>00397       Recurrence_MonthOfYear:  0x0230,
<a name="l00398"></a>00398       StartTime:               0x0231,
<a name="l00399"></a>00399       Sensitivity:             0x0232,
<a name="l00400"></a>00400       TimeZone:                0x0233,
<a name="l00401"></a>00401       GlobalObjId:             0x0234,
<a name="l00402"></a>00402       ThreadTopic:             0x0235,
<a name="l00403"></a>00403       MIMEData:                0x0236,
<a name="l00404"></a>00404       MIMETruncated:           0x0237,
<a name="l00405"></a>00405       MIMESize:                0x0238,
<a name="l00406"></a>00406       InternetCPID:            0x0239,
<a name="l00407"></a>00407       Flag:                    0x023A,
<a name="l00408"></a>00408       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>:                  0x023B,
<a name="l00409"></a>00409       ContentClass:            0x023C,
<a name="l00410"></a>00410       FlagType:                0x023D,
<a name="l00411"></a>00411       CompleteTime:            0x023E,
<a name="l00412"></a>00412       DisallowNewTimeProposal: 0x023F,
<a name="l00413"></a>00413     },
<a name="l00414"></a>00414     Enums: {
<a name="l00415"></a>00415       Importance: {
<a name="l00416"></a>00416         Low:    <span class="charliteral">&#39;0&#39;</span>,
<a name="l00417"></a>00417         Normal: <span class="charliteral">&#39;1&#39;</span>,
<a name="l00418"></a>00418         High:   <span class="charliteral">&#39;2&#39;</span>,
<a name="l00419"></a>00419       },
<a name="l00420"></a>00420       InstanceType: {
<a name="l00421"></a>00421         Single:             <span class="charliteral">&#39;0&#39;</span>,
<a name="l00422"></a>00422         RecurringMaster:    <span class="charliteral">&#39;1&#39;</span>,
<a name="l00423"></a>00423         RecurringInstance:  <span class="charliteral">&#39;2&#39;</span>,
<a name="l00424"></a>00424         RecurringException: <span class="charliteral">&#39;3&#39;</span>,
<a name="l00425"></a>00425       },
<a name="l00426"></a>00426       BusyStatus: {
<a name="l00427"></a>00427         Free:      <span class="charliteral">&#39;0&#39;</span>,
<a name="l00428"></a>00428         Tentative: <span class="charliteral">&#39;1&#39;</span>,
<a name="l00429"></a>00429         Busy:      <span class="charliteral">&#39;2&#39;</span>,
<a name="l00430"></a>00430         Oof:       <span class="charliteral">&#39;3&#39;</span>,
<a name="l00431"></a>00431       },
<a name="l00432"></a>00432       Recurrence_Type: {
<a name="l00433"></a>00433         Daily:             <span class="charliteral">&#39;0&#39;</span>,
<a name="l00434"></a>00434         Weekly:             <span class="charliteral">&#39;1&#39;</span>,
<a name="l00435"></a>00435         MonthlyNthDay:      <span class="charliteral">&#39;2&#39;</span>,
<a name="l00436"></a>00436         Monthly:            <span class="charliteral">&#39;3&#39;</span>,
<a name="l00437"></a>00437         YearlyNthDay:       <span class="charliteral">&#39;5&#39;</span>,
<a name="l00438"></a>00438         YearlyNthDayOfWeek: <span class="charliteral">&#39;6&#39;</span>,
<a name="l00439"></a>00439       },
<a name="l00440"></a>00440       <span class="comment">/* XXX: missing Recurrence_DayOfWeek */</span>
<a name="l00441"></a>00441       Sensitivity: {
<a name="l00442"></a>00442         Normal:       <span class="charliteral">&#39;0&#39;</span>,
<a name="l00443"></a>00443         Personal:     <span class="charliteral">&#39;1&#39;</span>,
<a name="l00444"></a>00444         Private:      <span class="charliteral">&#39;2&#39;</span>,
<a name="l00445"></a>00445         Confidential: <span class="charliteral">&#39;3&#39;</span>,
<a name="l00446"></a>00446       },
<a name="l00447"></a>00447       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>: {
<a name="l00448"></a>00448         Cleared:  <span class="charliteral">&#39;0&#39;</span>,
<a name="l00449"></a>00449         Complete: <span class="charliteral">&#39;1&#39;</span>,
<a name="l00450"></a>00450         Active:   <span class="charliteral">&#39;2&#39;</span>,
<a name="l00451"></a>00451       },
<a name="l00452"></a>00452     },
<a name="l00453"></a>00453   };
<a name="l00454"></a>00454 }));
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="comment">/* Copyright 2012 Mozilla Foundation</span>
<a name="l00457"></a>00457 <span class="comment"> *</span>
<a name="l00458"></a>00458 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00459"></a>00459 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00460"></a>00460 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00461"></a>00461 <span class="comment"> *</span>
<a name="l00462"></a>00462 <span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00463"></a>00463 <span class="comment"> *</span>
<a name="l00464"></a>00464 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00465"></a>00465 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00466"></a>00466 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00467"></a>00467 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00468"></a>00468 <span class="comment"> * limitations under the License.</span>
<a name="l00469"></a>00469 <span class="comment"> */</span>
<a name="l00470"></a>00470 
<a name="l00471"></a>00471 (<span class="keyword">function</span> (<a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>, factory) {
<a name="l00472"></a>00472   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a> === <span class="stringliteral">&#39;object&#39;</span>)
<a name="l00473"></a>00473     <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = factory();
<a name="l00474"></a>00474   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a> === <span class="stringliteral">&#39;function&#39;</span> &amp;&amp; <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>.amd)
<a name="l00475"></a>00475     <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;activesync/codepages/ItemOperations&#39;</span>,[], factory);
<a name="l00476"></a>00476   <span class="keywordflow">else</span>
<a name="l00477"></a>00477     <a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>.ASCPItemOperations = factory();
<a name="l00478"></a>00478 }(<span class="keyword">this</span>, <span class="keyword">function</span>() {
<a name="l00479"></a>00479   
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <span class="keywordflow">return</span> {
<a name="l00482"></a>00482     Tags: {
<a name="l00483"></a>00483       ItemOperations:      0x1405,
<a name="l00484"></a>00484       Fetch:               0x1406,
<a name="l00485"></a>00485       Store:               0x1407,
<a name="l00486"></a>00486       Options:             0x1408,
<a name="l00487"></a>00487       <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a613dc03693abce1debd83ef11ea83237">Range</a>:               0x1409,
<a name="l00488"></a>00488       Total:               0x140A,
<a name="l00489"></a>00489       Properties:          0x140B,
<a name="l00490"></a>00490       Data:                0x140C,
<a name="l00491"></a>00491       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>:              0x140D,
<a name="l00492"></a>00492       Response:            0x140E,
<a name="l00493"></a>00493       Version:             0x140F,
<a name="l00494"></a>00494       Schema:              0x1410,
<a name="l00495"></a>00495       Part:                0x1411,
<a name="l00496"></a>00496       EmptyFolderContents: 0x1412,
<a name="l00497"></a>00497       DeleteSubFolders:    0x1413,
<a name="l00498"></a>00498       UserName:            0x1414,
<a name="l00499"></a>00499       Password:            0x1415,
<a name="l00500"></a>00500       <a class="code" href="../../d2/d93/namespacemozilla.html#aff4754243ccc78444027ffa55c6762da">Move</a>:                0x1416,
<a name="l00501"></a>00501       DstFldId:            0x1417,
<a name="l00502"></a>00502       ConversationId:      0x1418,
<a name="l00503"></a>00503       MoveAlways:          0x1419,
<a name="l00504"></a>00504     },
<a name="l00505"></a>00505     Enums: {
<a name="l00506"></a>00506       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>: {
<a name="l00507"></a>00507         Success:               <span class="charliteral">&#39;1&#39;</span>,
<a name="l00508"></a>00508         ProtocolError:         <span class="charliteral">&#39;2&#39;</span>,
<a name="l00509"></a>00509         ServerError:           <span class="charliteral">&#39;3&#39;</span>,
<a name="l00510"></a>00510         BadURI:                <span class="charliteral">&#39;4&#39;</span>,
<a name="l00511"></a>00511         AccessDenied:          <span class="charliteral">&#39;5&#39;</span>,
<a name="l00512"></a>00512         ObjectNotFound:        <span class="charliteral">&#39;6&#39;</span>,
<a name="l00513"></a>00513         ConnectionFailure:     <span class="charliteral">&#39;7&#39;</span>,
<a name="l00514"></a>00514         InvalidByteRange:      <span class="charliteral">&#39;8&#39;</span>,
<a name="l00515"></a>00515         UnknownStore:          <span class="charliteral">&#39;9&#39;</span>,
<a name="l00516"></a>00516         EmptyFile:            <span class="stringliteral">&#39;10&#39;</span>,
<a name="l00517"></a>00517         DataTooLarge:         <span class="stringliteral">&#39;11&#39;</span>,
<a name="l00518"></a>00518         IOFailure:            <span class="stringliteral">&#39;12&#39;</span>,
<a name="l00519"></a>00519         ConversionFailure:    <span class="stringliteral">&#39;14&#39;</span>,
<a name="l00520"></a>00520         InvalidAttachment:    <span class="stringliteral">&#39;15&#39;</span>,
<a name="l00521"></a>00521         ResourceAccessDenied: <span class="stringliteral">&#39;16&#39;</span>,
<a name="l00522"></a>00522       },
<a name="l00523"></a>00523     },
<a name="l00524"></a>00524   };
<a name="l00525"></a>00525 }));
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/activesync/folder&#39;</span>,
<a name="l00528"></a>00528   [
<a name="l00529"></a>00529     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l00530"></a>00530     <span class="stringliteral">&#39;../date&#39;</span>,
<a name="l00531"></a>00531     <span class="stringliteral">&#39;../syncbase&#39;</span>,
<a name="l00532"></a>00532     <span class="stringliteral">&#39;../util&#39;</span>,
<a name="l00533"></a>00533     <span class="stringliteral">&#39;activesync/codepages/AirSync&#39;</span>,
<a name="l00534"></a>00534     <span class="stringliteral">&#39;activesync/codepages/AirSyncBase&#39;</span>,
<a name="l00535"></a>00535     <span class="stringliteral">&#39;activesync/codepages/ItemEstimate&#39;</span>,
<a name="l00536"></a>00536     <span class="stringliteral">&#39;activesync/codepages/Email&#39;</span>,
<a name="l00537"></a>00537     <span class="stringliteral">&#39;activesync/codepages/ItemOperations&#39;</span>,
<a name="l00538"></a>00538     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l00539"></a>00539     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l00540"></a>00540     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l00541"></a>00541   ],
<a name="l00542"></a>00542   <span class="keyword">function</span>(
<a name="l00543"></a>00543     $log,
<a name="l00544"></a>00544     $date,
<a name="l00545"></a>00545     $sync,
<a name="l00546"></a>00546     $util,
<a name="l00547"></a>00547     $AirSync,
<a name="l00548"></a>00548     $AirSyncBase,
<a name="l00549"></a>00549     $ItemEstimate,
<a name="l00550"></a>00550     $Email,
<a name="l00551"></a>00551     $ItemOperations,
<a name="l00552"></a>00552     $module,
<a name="l00553"></a>00553     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l00554"></a>00554     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l00555"></a>00555   ) {
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 
<a name="l00562"></a>00562 var DESIRED_TEXT_SNIPPET_BYTES = 512;
<a name="l00563"></a>00563 
<a name="l00569"></a>00569 var DESIRED_MESSAGE_COUNT = 50;
<a name="l00570"></a>00570 
<a name="l00574"></a>00574 var FILTER_TYPE, SYNC_RANGE_TO_FILTER_TYPE, FILTER_TYPE_TO_STRING;
<a name="l00575"></a>00575 <span class="keyword">function</span> initFilterTypes() {
<a name="l00576"></a>00576   FILTER_TYPE = $AirSync.Enums.FilterType;
<a name="l00577"></a>00577 
<a name="l00585"></a>00585   SYNC_RANGE_TO_FILTER_TYPE = {
<a name="l00586"></a>00586     <span class="stringliteral">&#39;auto&#39;</span>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l00587"></a>00587       <span class="stringliteral">&#39;1d&#39;</span>: FILTER_TYPE.OneDayBack,
<a name="l00588"></a>00588       <span class="stringliteral">&#39;3d&#39;</span>: FILTER_TYPE.ThreeDaysBack,
<a name="l00589"></a>00589       <span class="stringliteral">&#39;1w&#39;</span>: FILTER_TYPE.OneWeekBack,
<a name="l00590"></a>00590       <span class="stringliteral">&#39;2w&#39;</span>: FILTER_TYPE.TwoWeeksBack,
<a name="l00591"></a>00591       <span class="stringliteral">&#39;1m&#39;</span>: FILTER_TYPE.OneMonthBack,
<a name="l00592"></a>00592      <span class="stringliteral">&#39;all&#39;</span>: FILTER_TYPE.NoFilter,
<a name="l00593"></a>00593   };
<a name="l00594"></a>00594 
<a name="l00598"></a>00598   FILTER_TYPE_TO_STRING = {
<a name="l00599"></a>00599     0: <span class="stringliteral">&#39;all messages&#39;</span>,
<a name="l00600"></a>00600     1: <span class="stringliteral">&#39;one day&#39;</span>,
<a name="l00601"></a>00601     2: <span class="stringliteral">&#39;three days&#39;</span>,
<a name="l00602"></a>00602     3: <span class="stringliteral">&#39;one week&#39;</span>,
<a name="l00603"></a>00603     4: <span class="stringliteral">&#39;two weeks&#39;</span>,
<a name="l00604"></a>00604     5: <span class="stringliteral">&#39;one month&#39;</span>,
<a name="l00605"></a>00605   };
<a name="l00606"></a>00606 }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 var $wbxml, $mimelib, $mailchew;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610 <span class="keyword">function</span> lazyConnection(cbIndex, fn, failString) {
<a name="l00611"></a>00611   <span class="keywordflow">return</span> <span class="keyword">function</span> lazyRun() {
<a name="l00612"></a>00612     var <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a> = Array.slice(arguments),
<a name="l00613"></a>00613         errback = args[cbIndex],
<a name="l00614"></a>00614         <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;wbxml&#39;</span>, <span class="stringliteral">&#39;mimelib&#39;</span>, <span class="stringliteral">&#39;../mailchew&#39;</span>],
<a name="l00617"></a>00617     <span class="keyword">function</span> (wbxml, mimelib, mailchew) {
<a name="l00618"></a>00618       <span class="keywordflow">if</span> (!$wbxml) {
<a name="l00619"></a>00619         $wbxml = wbxml;
<a name="l00620"></a>00620         $mimelib = mimelib;
<a name="l00621"></a>00621         $mailchew = mailchew;
<a name="l00622"></a>00622         initFilterTypes();
<a name="l00623"></a>00623       }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625       <span class="keyword">self</span>._account.withConnection(errback, <span class="keyword">function</span> () {
<a name="l00626"></a>00626         fn.apply(<span class="keyword">self</span>, args);
<a name="l00627"></a>00627       }, failString);
<a name="l00628"></a>00628     });
<a name="l00629"></a>00629   };
<a name="l00630"></a>00630 }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="keyword">function</span> ActiveSyncFolderConn(account, storage, _parentLog) {
<a name="l00634"></a>00634   this._account = account;
<a name="l00635"></a>00635   this._storage = storage;
<a name="l00636"></a>00636   this._LOG = <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#af6bd479a55b8d304e23d9a96d199c3aa">LOGFAB</a>.ActiveSyncFolderConn(<span class="keyword">this</span>, _parentLog, storage.folderId);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638   this.folderMeta = storage.folderMeta;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640   <span class="keywordflow">if</span> (!this.syncKey)
<a name="l00641"></a>00641     this.syncKey = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 ActiveSyncFolderConn.prototype = {
<a name="l00644"></a>00644   <span class="keyword">get</span> syncKey() {
<a name="l00645"></a>00645     <span class="keywordflow">return</span> this.folderMeta.syncKey;
<a name="l00646"></a>00646   },
<a name="l00647"></a>00647 
<a name="l00648"></a>00648   <span class="keyword">set</span> syncKey(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>) {
<a name="l00649"></a>00649     <span class="keywordflow">return</span> this.folderMeta.syncKey = <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l00650"></a>00650   },
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   <span class="keyword">get</span> serverId() {
<a name="l00653"></a>00653     <span class="keywordflow">return</span> this.folderMeta.serverId;
<a name="l00654"></a>00654   },
<a name="l00655"></a>00655 
<a name="l00665"></a>00665   <span class="keyword">get</span> filterType() {
<a name="l00666"></a>00666     var syncRange = this._account.accountDef.syncRange;
<a name="l00667"></a>00667     <span class="keywordflow">if</span> (SYNC_RANGE_TO_FILTER_TYPE.hasOwnProperty(syncRange)) {
<a name="l00668"></a>00668       var accountFilterType = SYNC_RANGE_TO_FILTER_TYPE[syncRange];
<a name="l00669"></a>00669       <span class="keywordflow">if</span> (accountFilterType)
<a name="l00670"></a>00670         <span class="keywordflow">return</span> accountFilterType;
<a name="l00671"></a>00671       <span class="keywordflow">else</span>
<a name="l00672"></a>00672         <span class="keywordflow">return</span> this.folderMeta.filterType;
<a name="l00673"></a>00673     }
<a name="l00674"></a>00674     <span class="keywordflow">else</span> {
<a name="l00675"></a>00675       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;Got an invalid syncRange (&#39;</span> + syncRange +
<a name="l00676"></a>00676                    <span class="stringliteral">&#39;) using three days back instead&#39;</span>);
<a name="l00677"></a>00677       <span class="keywordflow">return</span> $AirSync.Enums.FilterType.ThreeDaysBack;
<a name="l00678"></a>00678     }
<a name="l00679"></a>00679   },
<a name="l00680"></a>00680 
<a name="l00688"></a>00688   _getSyncKey: lazyConnection(1, <span class="keyword">function</span> asfc__getSyncKey(filterType,
<a name="l00689"></a>00689                                                            <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00690"></a>00690     var folderConn = <span class="keyword">this</span>;
<a name="l00691"></a>00691     var account = this._account;
<a name="l00692"></a>00692     var as = $AirSync.Tags;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l00695"></a>00695     w.stag(as.Sync)
<a name="l00696"></a>00696        .stag(as.Collections)
<a name="l00697"></a>00697          .stag(as.Collection)
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <span class="keywordflow">if</span> (account.conn.currentVersion.lt(<span class="stringliteral">&#39;12.1&#39;</span>))
<a name="l00700"></a>00700           w.tag(as.Class, <span class="stringliteral">&#39;Email&#39;</span>);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702           w.tag(as.SyncKey, <span class="charliteral">&#39;0&#39;</span>)
<a name="l00703"></a>00703            .tag(as.CollectionId, <span class="keyword">this</span>.serverId)
<a name="l00704"></a>00704            .stag(as.Options)
<a name="l00705"></a>00705              .tag(as.FilterType, filterType)
<a name="l00706"></a>00706            .etag()
<a name="l00707"></a>00707          .etag()
<a name="l00708"></a>00708        .etag()
<a name="l00709"></a>00709      .etag();
<a name="l00710"></a>00710 
<a name="l00711"></a>00711     account.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l00712"></a>00712       <span class="keywordflow">if</span> (aError) {
<a name="l00713"></a>00713         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(aError);
<a name="l00714"></a>00714         account._reportErrorIfNecessary(aError);
<a name="l00715"></a>00715         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l00716"></a>00716         <span class="keywordflow">return</span>;
<a name="l00717"></a>00717       }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719       <span class="comment">// Reset the SyncKey, just in case we don&#39;t see a sync key in the</span>
<a name="l00720"></a>00720       <span class="comment">// response.</span>
<a name="l00721"></a>00721       folderConn.syncKey = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723       var <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a> = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l00724"></a>00724       e.addEventListener([as.Sync, as.Collections, as.Collection, as.SyncKey],
<a name="l00725"></a>00725                          <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l00726"></a>00726         folderConn.syncKey = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l00727"></a>00727       });
<a name="l00728"></a>00728 
<a name="l00729"></a>00729       e.onerror = <span class="keyword">function</span>() {}; <span class="comment">// Ignore errors.</span>
<a name="l00730"></a>00730       e.run(aResponse);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732       <span class="keywordflow">if</span> (folderConn.syncKey === <span class="charliteral">&#39;0&#39;</span>) {
<a name="l00733"></a>00733         <span class="comment">// We should never actually hit this, since it would mean that the</span>
<a name="l00734"></a>00734         <span class="comment">// server is refusing to give us a sync key. On the off chance that we</span>
<a name="l00735"></a>00735         <span class="comment">// do hit it, just bail.</span>
<a name="l00736"></a>00736         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Unable to get sync key for folder&#39;</span>);
<a name="l00737"></a>00737         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l00738"></a>00738       }
<a name="l00739"></a>00739       <span class="keywordflow">else</span> {
<a name="l00740"></a>00740         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l00741"></a>00741       }
<a name="l00742"></a>00742     });
<a name="l00743"></a>00743   }),
<a name="l00744"></a>00744 
<a name="l00752"></a>00752   _getItemEstimate: lazyConnection(1, <span class="keyword">function</span> asfc__getItemEstimate(filterType,
<a name="l00753"></a>00753                                                                      <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00754"></a>00754     var ie = $ItemEstimate.Tags;
<a name="l00755"></a>00755     var as = $AirSync.Tags;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     var account = this._account;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l00760"></a>00760     w.stag(ie.GetItemEstimate)
<a name="l00761"></a>00761        .stag(ie.Collections)
<a name="l00762"></a>00762          .stag(ie.Collection);
<a name="l00763"></a>00763 
<a name="l00764"></a>00764     <span class="keywordflow">if</span> (this._account.conn.currentVersion.gte(<span class="stringliteral">&#39;14.0&#39;</span>)) {
<a name="l00765"></a>00765           w.tag(as.SyncKey, <span class="keyword">this</span>.syncKey)
<a name="l00766"></a>00766            .tag(ie.CollectionId, <span class="keyword">this</span>.serverId)
<a name="l00767"></a>00767            .stag(as.Options)
<a name="l00768"></a>00768              .tag(as.FilterType, filterType)
<a name="l00769"></a>00769            .etag();
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (this._account.conn.currentVersion.gte(<span class="stringliteral">&#39;12.0&#39;</span>)) {
<a name="l00772"></a>00772           w.tag(ie.CollectionId, <span class="keyword">this</span>.serverId)
<a name="l00773"></a>00773            .tag(as.FilterType, filterType)
<a name="l00774"></a>00774            .tag(as.SyncKey, <span class="keyword">this</span>.syncKey);
<a name="l00775"></a>00775     }
<a name="l00776"></a>00776     <span class="keywordflow">else</span> {
<a name="l00777"></a>00777           w.tag(ie.Class, <span class="stringliteral">&#39;Email&#39;</span>)
<a name="l00778"></a>00778            .tag(as.SyncKey, <span class="keyword">this</span>.syncKey)
<a name="l00779"></a>00779            .tag(ie.CollectionId, <span class="keyword">this</span>.serverId)
<a name="l00780"></a>00780            .tag(as.FilterType, filterType);
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783         w.etag(ie.Collection)
<a name="l00784"></a>00784        .etag(ie.Collections)
<a name="l00785"></a>00785      .etag(ie.GetItemEstimate);
<a name="l00786"></a>00786 
<a name="l00787"></a>00787     account.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l00788"></a>00788       <span class="keywordflow">if</span> (aError) {
<a name="l00789"></a>00789         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(aError);
<a name="l00790"></a>00790         account._reportErrorIfNecessary(aError);
<a name="l00791"></a>00791         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l00792"></a>00792         <span class="keywordflow">return</span>;
<a name="l00793"></a>00793       }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795       var e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l00796"></a>00796       var <a class="code" href="../../d9/d04/expat_8h.html#a938e186c531ea86ae9adf3c0a649d8fc">base</a> = [ie.GetItemEstimate, ie.Response];
<a name="l00797"></a>00797 
<a name="l00798"></a>00798       var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, estimate;
<a name="l00799"></a>00799       e.addEventListener(base.concat(ie.Status), <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l00800"></a>00800         status = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l00801"></a>00801       });
<a name="l00802"></a>00802       e.addEventListener(base.concat(ie.Collection, ie.Estimate),
<a name="l00803"></a>00803                          <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l00804"></a>00804         estimate = parseInt(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent, 10);
<a name="l00805"></a>00805       });
<a name="l00806"></a>00806 
<a name="l00807"></a>00807       <span class="keywordflow">try</span> {
<a name="l00808"></a>00808         e.run(aResponse);
<a name="l00809"></a>00809       }
<a name="l00810"></a>00810       <span class="keywordflow">catch</span> (ex) {
<a name="l00811"></a>00811         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error parsing GetItemEstimate response&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l00812"></a>00812                       ex.stack);
<a name="l00813"></a>00813         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l00814"></a>00814         <span class="keywordflow">return</span>;
<a name="l00815"></a>00815       }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817       <span class="keywordflow">if</span> (status !== $ItemEstimate.Enums.Status.Success) {
<a name="l00818"></a>00818         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error getting item estimate:&#39;</span>, status);
<a name="l00819"></a>00819         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l00820"></a>00820       }
<a name="l00821"></a>00821       <span class="keywordflow">else</span> {
<a name="l00822"></a>00822         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, estimate);
<a name="l00823"></a>00823       }
<a name="l00824"></a>00824     });
<a name="l00825"></a>00825   }),
<a name="l00826"></a>00826 
<a name="l00834"></a>00834   _inferFilterType: lazyConnection(0, <span class="keyword">function</span> asfc__inferFilterType(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00835"></a>00835     var folderConn = <span class="keyword">this</span>;
<a name="l00836"></a>00836     var <a class="code" href="../../d3/d0f/ns_display_item_types_8h.html#a1d1cfd8ffb84e947f82999c682b666a7">Type</a> = $AirSync.Enums.FilterType;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     var getEstimate = <span class="keyword">function</span>(filterType, onSuccess) {
<a name="l00839"></a>00839       folderConn._getSyncKey(filterType, <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00840"></a>00840         <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00841"></a>00841           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l00842"></a>00842           <span class="keywordflow">return</span>;
<a name="l00843"></a>00843         }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845         folderConn._getItemEstimate(filterType, <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, estimate) {
<a name="l00846"></a>00846           <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00847"></a>00847             <span class="comment">// If we couldn&#39;t get an estimate, just tell the main callback that</span>
<a name="l00848"></a>00848             <span class="comment">// we want three days back.</span>
<a name="l00849"></a>00849             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, Type.ThreeDaysBack);
<a name="l00850"></a>00850             <span class="keywordflow">return</span>;
<a name="l00851"></a>00851           }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853           onSuccess(estimate);
<a name="l00854"></a>00854         });
<a name="l00855"></a>00855       });
<a name="l00856"></a>00856     };
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     getEstimate(Type.TwoWeeksBack, <span class="keyword">function</span>(estimate) {
<a name="l00859"></a>00859       var messagesPerDay = estimate / 14; <span class="comment">// Two weeks. Twoooo weeeeeeks.</span>
<a name="l00860"></a>00860       var filterType;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862       <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (estimate &lt; 0)
<a name="l00863"></a>00863         filterType = Type.ThreeDaysBack;
<a name="l00864"></a>00864       <span class="keywordflow">else</span> <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (messagesPerDay &gt;= DESIRED_MESSAGE_COUNT)
<a name="l00865"></a>00865         filterType = Type.OneDayBack;
<a name="l00866"></a>00866       <span class="keywordflow">else</span> <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (messagesPerDay * 3 &gt;= DESIRED_MESSAGE_COUNT)
<a name="l00867"></a>00867         filterType = Type.ThreeDaysBack;
<a name="l00868"></a>00868       <span class="keywordflow">else</span> <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (messagesPerDay * 7 &gt;= DESIRED_MESSAGE_COUNT)
<a name="l00869"></a>00869         filterType = Type.OneWeekBack;
<a name="l00870"></a>00870       <span class="keywordflow">else</span> <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (messagesPerDay * 14 &gt;= DESIRED_MESSAGE_COUNT)
<a name="l00871"></a>00871         filterType = Type.TwoWeeksBack;
<a name="l00872"></a>00872       <span class="keywordflow">else</span> <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (messagesPerDay * 30 &gt;= DESIRED_MESSAGE_COUNT)
<a name="l00873"></a>00873         filterType = Type.OneMonthBack;
<a name="l00874"></a>00874       <span class="keywordflow">else</span> {
<a name="l00875"></a>00875         getEstimate(Type.NoFilter, <span class="keyword">function</span>(estimate) {
<a name="l00876"></a>00876           var filterType;
<a name="l00877"></a>00877           <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (estimate &gt; DESIRED_MESSAGE_COUNT) {
<a name="l00878"></a>00878             filterType = Type.OneMonthBack;
<a name="l00879"></a>00879             <span class="comment">// Reset the sync key since we&#39;re changing filter types. This avoids</span>
<a name="l00880"></a>00880             <span class="comment">// a round-trip where we&#39;d normally get a zero syncKey from the</span>
<a name="l00881"></a>00881             <span class="comment">// server.</span>
<a name="l00882"></a>00882             folderConn.syncKey = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00883"></a>00883           }
<a name="l00884"></a>00884           <span class="keywordflow">else</span> {
<a name="l00885"></a>00885             filterType = Type.NoFilter;
<a name="l00886"></a>00886           }
<a name="l00887"></a>00887           folderConn._LOG.inferFilterType(filterType);
<a name="l00888"></a>00888           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, filterType);
<a name="l00889"></a>00889         });
<a name="l00890"></a>00890         <span class="keywordflow">return</span>;
<a name="l00891"></a>00891       }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893       <span class="keywordflow">if</span> (filterType !== Type.TwoWeeksBack) {
<a name="l00894"></a>00894         <span class="comment">// Reset the sync key since we&#39;re changing filter types. This avoids a</span>
<a name="l00895"></a>00895         <span class="comment">// round-trip where we&#39;d normally get a zero syncKey from the server.</span>
<a name="l00896"></a>00896         folderConn.syncKey = <span class="charliteral">&#39;0&#39;</span>;
<a name="l00897"></a>00897       }
<a name="l00898"></a>00898       folderConn._LOG.inferFilterType(filterType);
<a name="l00899"></a>00899       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, filterType);
<a name="l00900"></a>00900     });
<a name="l00901"></a>00901   }),
<a name="l00902"></a>00902 
<a name="l00913"></a>00913   _enumerateFolderChanges: lazyConnection(0,
<a name="l00914"></a>00914     <span class="keyword">function</span> asfc__enumerateFolderChanges(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, progress) {
<a name="l00915"></a>00915     var folderConn = <span class="keyword">this</span>, storage = this._storage;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     <span class="keywordflow">if</span> (!this.filterType) {
<a name="l00918"></a>00918       this._inferFilterType(<span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, filterType) {
<a name="l00919"></a>00919         <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00920"></a>00920           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l00921"></a>00921           <span class="keywordflow">return</span>;
<a name="l00922"></a>00922         }
<a name="l00923"></a>00923         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;We want a filter of&#39;</span>, FILTER_TYPE_TO_STRING[filterType]);
<a name="l00924"></a>00924         folderConn.folderMeta.filterType = filterType;
<a name="l00925"></a>00925         folderConn._enumerateFolderChanges(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, progress);
<a name="l00926"></a>00926       });
<a name="l00927"></a>00927       <span class="keywordflow">return</span>;
<a name="l00928"></a>00928     }
<a name="l00929"></a>00929     <span class="keywordflow">if</span> (this.syncKey === <span class="charliteral">&#39;0&#39;</span>) {
<a name="l00930"></a>00930       this._getSyncKey(this.filterType, <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00931"></a>00931         <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l00932"></a>00932           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;aborted&#39;</span>);
<a name="l00933"></a>00933           <span class="keywordflow">return</span>;
<a name="l00934"></a>00934         }
<a name="l00935"></a>00935         folderConn._enumerateFolderChanges(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, progress);
<a name="l00936"></a>00936       });
<a name="l00937"></a>00937       <span class="keywordflow">return</span>;
<a name="l00938"></a>00938     }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940     var as = $AirSync.Tags;
<a name="l00941"></a>00941     var asEnum = $AirSync.Enums;
<a name="l00942"></a>00942     var asb = $AirSyncBase.Tags;
<a name="l00943"></a>00943     var asbEnum = $AirSyncBase.Enums;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     var w;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     <span class="comment">// If the last sync was ours and we got an empty response back, we can send</span>
<a name="l00948"></a>00948     <span class="comment">// an empty request to repeat our request. This saves a little bandwidth.</span>
<a name="l00949"></a>00949     <span class="keywordflow">if</span> (this._account._syncsInProgress++ === 0 &amp;&amp;
<a name="l00950"></a>00950         <span class="keyword">this</span>._account._lastSyncKey === <span class="keyword">this</span>.syncKey &amp;&amp;
<a name="l00951"></a>00951         <span class="keyword">this</span>._account._lastSyncFilterType === <span class="keyword">this</span>.filterType &amp;&amp;
<a name="l00952"></a>00952         <span class="keyword">this</span>._account._lastSyncResponseWasEmpty) {
<a name="l00953"></a>00953       w = as.Sync;
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955     <span class="keywordflow">else</span> {
<a name="l00956"></a>00956       w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l00957"></a>00957       w.stag(as.Sync)
<a name="l00958"></a>00958          .stag(as.Collections)
<a name="l00959"></a>00959            .stag(as.Collection);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961       <span class="keywordflow">if</span> (this._account.conn.currentVersion.lt(<span class="stringliteral">&#39;12.1&#39;</span>))
<a name="l00962"></a>00962             w.tag(as.Class, <span class="stringliteral">&#39;Email&#39;</span>);
<a name="l00963"></a>00963 
<a name="l00964"></a>00964             w.tag(as.SyncKey, <span class="keyword">this</span>.syncKey)
<a name="l00965"></a>00965              .tag(as.CollectionId, <span class="keyword">this</span>.serverId)
<a name="l00966"></a>00966              .tag(as.GetChanges)
<a name="l00967"></a>00967              .stag(as.Options)
<a name="l00968"></a>00968                .tag(as.FilterType, <span class="keyword">this</span>.filterType)
<a name="l00969"></a>00969 
<a name="l00970"></a>00970       <span class="comment">// Older versions of ActiveSync give us the body by default. Ensure they</span>
<a name="l00971"></a>00971       <span class="comment">// omit it.</span>
<a name="l00972"></a>00972       <span class="keywordflow">if</span> (this._account.conn.currentVersion.lte(<span class="stringliteral">&#39;12.0&#39;</span>)) {
<a name="l00973"></a>00973               w.tag(as.MIMESupport, asEnum.MIMESupport.Never)
<a name="l00974"></a>00974                .tag(as.Truncation, asEnum.MIMETruncation.TruncateAll);
<a name="l00975"></a>00975       }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977             w.etag()
<a name="l00978"></a>00978            .etag()
<a name="l00979"></a>00979          .etag()
<a name="l00980"></a>00980        .etag();
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     this._account.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l00984"></a>00984       var added   = [];
<a name="l00985"></a>00985       var <a class="code" href="../../d2/dc5/homescreen__launcher__test_8js.html#aea526ac279d0b19b1c082209fc199b73">changed</a> = [];
<a name="l00986"></a>00986       var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a90aa0230f3430f1172f8646802a5dd35">deleted</a> = [];
<a name="l00987"></a>00987       var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>;
<a name="l00988"></a>00988       var moreAvailable = <span class="keyword">false</span>;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990       folderConn._account._syncsInProgress--;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992       <span class="keywordflow">if</span> (aError) {
<a name="l00993"></a>00993         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error syncing folder:&#39;</span>, aError);
<a name="l00994"></a>00994         folderConn._account._reportErrorIfNecessary(aError);
<a name="l00995"></a>00995         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;aborted&#39;</span>);
<a name="l00996"></a>00996         <span class="keywordflow">return</span>;
<a name="l00997"></a>00997       }
<a name="l00998"></a>00998 
<a name="l00999"></a>00999       folderConn._account._lastSyncKey = folderConn.syncKey;
<a name="l01000"></a>01000       folderConn._account._lastSyncFilterType = folderConn.filterType;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002       <span class="keywordflow">if</span> (!aResponse) {
<a name="l01003"></a>01003         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Sync completed with empty response&#39;</span>);
<a name="l01004"></a>01004         folderConn._account._lastSyncResponseWasEmpty = <span class="keyword">true</span>;
<a name="l01005"></a>01005         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, added, changed, deleted);
<a name="l01006"></a>01006         <span class="keywordflow">return</span>;
<a name="l01007"></a>01007       }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009       folderConn._account._lastSyncResponseWasEmpty = <span class="keyword">false</span>;
<a name="l01010"></a>01010       var e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l01011"></a>01011       var base = [as.Sync, as.Collections, as.Collection];
<a name="l01012"></a>01012 
<a name="l01013"></a>01013       e.addEventListener(base.concat(as.SyncKey), <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01014"></a>01014         folderConn.syncKey = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01015"></a>01015       });
<a name="l01016"></a>01016 
<a name="l01017"></a>01017       e.addEventListener(base.concat(as.Status), <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01018"></a>01018         status = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01019"></a>01019       });
<a name="l01020"></a>01020 
<a name="l01021"></a>01021       e.addEventListener(base.concat(as.MoreAvailable), <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01022"></a>01022         moreAvailable = <span class="keyword">true</span>;
<a name="l01023"></a>01023       });
<a name="l01024"></a>01024 
<a name="l01025"></a>01025       e.addEventListener(base.concat(as.Commands, [[as.Add, as.Change]]),
<a name="l01026"></a>01026                          <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01027"></a>01027         var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>, guid, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>;
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <span class="keywordflow">for</span> (var iter in Iterator(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children)) {
<a name="l01030"></a>01030           var child = iter[1];
<a name="l01031"></a>01031           <span class="keywordflow">switch</span> (child.tag) {
<a name="l01032"></a>01032           <span class="keywordflow">case</span> as.ServerId:
<a name="l01033"></a>01033             guid = child.children[0].textContent;
<a name="l01034"></a>01034             <span class="keywordflow">break</span>;
<a name="l01035"></a>01035           <span class="keywordflow">case</span> as.ApplicationData:
<a name="l01036"></a>01036             <span class="keywordflow">try</span> {
<a name="l01037"></a>01037               msg = folderConn._parseMessage(child, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.tag === as.Add);
<a name="l01038"></a>01038             }
<a name="l01039"></a>01039             <span class="keywordflow">catch</span> (ex) {
<a name="l01040"></a>01040               <span class="comment">// If we get an error, just log it and skip this message.</span>
<a name="l01041"></a>01041               <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Failed to parse a message:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l01042"></a>01042               <span class="keywordflow">return</span>;
<a name="l01043"></a>01043             }
<a name="l01044"></a>01044             <span class="keywordflow">break</span>;
<a name="l01045"></a>01045           }
<a name="l01046"></a>01046         }
<a name="l01047"></a>01047 
<a name="l01048"></a>01048         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.tag === as.Add) {
<a name="l01049"></a>01049           msg.header.id = <span class="keywordtype">id</span> = storage._issueNewHeaderId();
<a name="l01050"></a>01050           msg.header.suid = folderConn._storage.folderId + <span class="charliteral">&#39;/&#39;</span> + <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>;
<a name="l01051"></a>01051           msg.header.guid = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01052"></a>01052         }
<a name="l01053"></a>01053         msg.header.srvid = guid;
<a name="l01054"></a>01054         <span class="comment">// XXX need to get the message&#39;s message-id header value!</span>
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         var collection = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.tag === as.Add ? added : <a class="code" href="../../d2/dc5/homescreen__launcher__test_8js.html#aea526ac279d0b19b1c082209fc199b73">changed</a>;
<a name="l01057"></a>01057         collection.push(msg);
<a name="l01058"></a>01058       });
<a name="l01059"></a>01059 
<a name="l01060"></a>01060       e.addEventListener(base.concat(as.Commands, [[as.Delete, as.SoftDelete]]),
<a name="l01061"></a>01061                          <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01062"></a>01062         var guid;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064         <span class="keywordflow">for</span> (var iter in Iterator(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children)) {
<a name="l01065"></a>01065           var child = iter[1];
<a name="l01066"></a>01066           <span class="keywordflow">switch</span> (child.tag) {
<a name="l01067"></a>01067           <span class="keywordflow">case</span> as.ServerId:
<a name="l01068"></a>01068             guid = child.children[0].textContent;
<a name="l01069"></a>01069             <span class="keywordflow">break</span>;
<a name="l01070"></a>01070           }
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073         deleted.push(guid);
<a name="l01074"></a>01074       });
<a name="l01075"></a>01075 
<a name="l01076"></a>01076       <span class="keywordflow">try</span> {
<a name="l01077"></a>01077         e.run(aResponse);
<a name="l01078"></a>01078       }
<a name="l01079"></a>01079       <span class="keywordflow">catch</span> (ex) {
<a name="l01080"></a>01080         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error parsing Sync response:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l01081"></a>01081         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01082"></a>01082         <span class="keywordflow">return</span>;
<a name="l01083"></a>01083       }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085       <span class="keywordflow">if</span> (status === asEnum.Status.Success) {
<a name="l01086"></a>01086         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Sync completed: added &#39;</span> + added.length + <span class="stringliteral">&#39;, changed &#39;</span> +
<a name="l01087"></a>01087                     changed.length + <span class="stringliteral">&#39;, deleted &#39;</span> + deleted.length);
<a name="l01088"></a>01088         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, added, changed, deleted, moreAvailable);
<a name="l01089"></a>01089         <span class="keywordflow">if</span> (moreAvailable)
<a name="l01090"></a>01090           folderConn._enumerateFolderChanges(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, progress);
<a name="l01091"></a>01091       }
<a name="l01092"></a>01092       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status === asEnum.Status.InvalidSyncKey) {
<a name="l01093"></a>01093         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;ActiveSync had a bad sync key&#39;</span>);
<a name="l01094"></a>01094         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;badkey&#39;</span>);
<a name="l01095"></a>01095       }
<a name="l01096"></a>01096       <span class="keywordflow">else</span> {
<a name="l01097"></a>01097         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Something went wrong during ActiveSync syncing and we &#39;</span> +
<a name="l01098"></a>01098                       <span class="stringliteral">&#39;got a status of &#39;</span> + status);
<a name="l01099"></a>01099         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01100"></a>01100       }
<a name="l01101"></a>01101     }, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01102"></a>01102     <span class="keyword">function</span> progressData(bytesSoFar, totalBytes) {
<a name="l01103"></a>01103       <span class="comment">// We get the XHR progress status and convert it into progress in the</span>
<a name="l01104"></a>01104       <span class="comment">// range [0.10, 0.80].  The remaining 20% is processing the specific</span>
<a name="l01105"></a>01105       <span class="comment">// messages, but we don&#39;t bother to generate notifications since that</span>
<a name="l01106"></a>01106       <span class="comment">// is done synchronously.</span>
<a name="l01107"></a>01107       <span class="keywordflow">if</span> (!totalBytes)
<a name="l01108"></a>01108         totalBytes = Math.max(1000000, bytesSoFar);
<a name="l01109"></a>01109       progress(0.1 + 0.7 * bytesSoFar / totalBytes);
<a name="l01110"></a>01110     });
<a name="l01111"></a>01111   }, <span class="stringliteral">&#39;aborted&#39;</span>),
<a name="l01112"></a>01112 
<a name="l01123"></a>01123   _parseMessage: <span class="keyword">function</span> asfc__parseMessage(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>, isAdded) {
<a name="l01124"></a>01124     var em = $Email.Tags;
<a name="l01125"></a>01125     var asb = $AirSyncBase.Tags;
<a name="l01126"></a>01126     var asbEnum = $AirSyncBase.Enums;
<a name="l01127"></a>01127 
<a name="l01128"></a>01128     var <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body, flagHeader;
<a name="l01129"></a>01129 
<a name="l01130"></a>01130     <span class="keywordflow">if</span> (isAdded) {
<a name="l01131"></a>01131       header = {
<a name="l01132"></a>01132         <span class="keywordtype">id</span>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01133"></a>01133         srvid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01134"></a>01134         suid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01135"></a>01135         guid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01136"></a>01136         <a class="code" href="../../dd/dc4/namespacesetup.html#a7b92894168460f935bc49467954c4a92">author</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01137"></a>01137         <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01138"></a>01138         <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01139"></a>01139         bcc: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01140"></a>01140         replyTo: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01141"></a>01141         <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01142"></a>01142         <a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>: [],
<a name="l01143"></a>01143         hasAttachments: <span class="keyword">false</span>,
<a name="l01144"></a>01144         <a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01145"></a>01145         snippet: null
<a name="l01146"></a>01146       };
<a name="l01147"></a>01147 
<a name="l01148"></a>01148       body = {
<a name="l01149"></a>01149         <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01150"></a>01150         <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a6d7e27eaec1e5f6600e65858be43c18b">size</a>: 0,
<a name="l01151"></a>01151         attachments: [],
<a name="l01152"></a>01152         relatedParts: [],
<a name="l01153"></a>01153         references: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01154"></a>01154         bodyReps: null
<a name="l01155"></a>01155       };
<a name="l01156"></a>01156 
<a name="l01157"></a>01157       flagHeader = <span class="keyword">function</span>(flag, <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>) {
<a name="l01158"></a>01158         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>)
<a name="l01159"></a>01159           header.flags.push(flag);
<a name="l01160"></a>01160       }
<a name="l01161"></a>01161     }
<a name="l01162"></a>01162     <span class="keywordflow">else</span> {
<a name="l01163"></a>01163       header = {
<a name="l01164"></a>01164         <a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>: [],
<a name="l01165"></a>01165         mergeInto: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a>) {
<a name="l01166"></a>01166           <span class="comment">// Merge flags</span>
<a name="l01167"></a>01167           <span class="keywordflow">for</span> (var iter in Iterator(this.<a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>)) {
<a name="l01168"></a>01168             var flagstate = iter[1];
<a name="l01169"></a>01169             <span class="keywordflow">if</span> (flagstate[1]) {
<a name="l01170"></a>01170               <a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a>.flags.push(flagstate[0]);
<a name="l01171"></a>01171             }
<a name="l01172"></a>01172             <span class="keywordflow">else</span> {
<a name="l01173"></a>01173               var <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> = <a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a>.flags.indexOf(flagstate[0]);
<a name="l01174"></a>01174               <span class="keywordflow">if</span> (index !== -1)
<a name="l01175"></a>01175                 <a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a>.flags.splice(index, 1);
<a name="l01176"></a>01176             }
<a name="l01177"></a>01177           }
<a name="l01178"></a>01178 
<a name="l01179"></a>01179           <span class="comment">// Merge everything else</span>
<a name="l01180"></a>01180           var skip = [<span class="stringliteral">&#39;mergeInto&#39;</span>, <span class="stringliteral">&#39;suid&#39;</span>, <span class="stringliteral">&#39;srvid&#39;</span>, <span class="stringliteral">&#39;guid&#39;</span>, <span class="stringliteral">&#39;id&#39;</span>, <span class="stringliteral">&#39;flags&#39;</span>];
<a name="l01181"></a>01181           <span class="keywordflow">for</span> (var iter in Iterator(<span class="keyword">this</span>)) {
<a name="l01182"></a>01182             var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = iter[0], <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = iter[1];
<a name="l01183"></a>01183             <span class="keywordflow">if</span> (skip.indexOf(key) !== -1)
<a name="l01184"></a>01184               <span class="keywordflow">continue</span>;
<a name="l01185"></a>01185 
<a name="l01186"></a>01186             <a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l01187"></a>01187           }
<a name="l01188"></a>01188         },
<a name="l01189"></a>01189       };
<a name="l01190"></a>01190 
<a name="l01191"></a>01191       body = {
<a name="l01192"></a>01192         mergeInto: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a>) {
<a name="l01193"></a>01193           <span class="keywordflow">for</span> (var iter in Iterator(<span class="keyword">this</span>)) {
<a name="l01194"></a>01194             var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = iter[0], <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = iter[1];
<a name="l01195"></a>01195             <span class="keywordflow">if</span> (key === <span class="stringliteral">&#39;mergeInto&#39;</span>) <span class="keywordflow">continue</span>;
<a name="l01196"></a>01196             <a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l01197"></a>01197           }
<a name="l01198"></a>01198         },
<a name="l01199"></a>01199       };
<a name="l01200"></a>01200 
<a name="l01201"></a>01201       flagHeader = <span class="keyword">function</span>(flag, <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>) {
<a name="l01202"></a>01202         header.flags.push([flag, <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>]);
<a name="l01203"></a>01203       }
<a name="l01204"></a>01204     }
<a name="l01205"></a>01205 
<a name="l01206"></a>01206     var bodyType, bodySize;
<a name="l01207"></a>01207 
<a name="l01208"></a>01208     <span class="keywordflow">for</span> (var iter in Iterator(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children)) {
<a name="l01209"></a>01209       var child = iter[1];
<a name="l01210"></a>01210       var childText = child.children.length ? child.children[0].textContent :
<a name="l01211"></a>01211                                               <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213       <span class="keywordflow">switch</span> (child.tag) {
<a name="l01214"></a>01214       <span class="keywordflow">case</span> em.Subject:
<a name="l01215"></a>01215         header.subject = childText;
<a name="l01216"></a>01216         <span class="keywordflow">break</span>;
<a name="l01217"></a>01217       <span class="keywordflow">case</span> em.From:
<a name="l01218"></a>01218         header.author = $mimelib.parseAddresses(childText)[0] || <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01219"></a>01219         <span class="keywordflow">break</span>;
<a name="l01220"></a>01220       <span class="keywordflow">case</span> em.To:
<a name="l01221"></a>01221         header.to = $mimelib.parseAddresses(childText);
<a name="l01222"></a>01222         <span class="keywordflow">break</span>;
<a name="l01223"></a>01223       <span class="keywordflow">case</span> em.Cc:
<a name="l01224"></a>01224         header.cc = $mimelib.parseAddresses(childText);
<a name="l01225"></a>01225         <span class="keywordflow">break</span>;
<a name="l01226"></a>01226       <span class="keywordflow">case</span> em.ReplyTo:
<a name="l01227"></a>01227         header.replyTo = $mimelib.parseAddresses(childText);
<a name="l01228"></a>01228         <span class="keywordflow">break</span>;
<a name="l01229"></a>01229       <span class="keywordflow">case</span> em.DateReceived:
<a name="l01230"></a>01230         body.date = header.date = <span class="keyword">new</span> Date(childText).valueOf();
<a name="l01231"></a>01231         <span class="keywordflow">break</span>;
<a name="l01232"></a>01232       <span class="keywordflow">case</span> em.Read:
<a name="l01233"></a>01233         flagHeader(<span class="stringliteral">&#39;\\Seen&#39;</span>, childText === <span class="charliteral">&#39;1&#39;</span>);
<a name="l01234"></a>01234         <span class="keywordflow">break</span>;
<a name="l01235"></a>01235       <span class="keywordflow">case</span> em.Flag:
<a name="l01236"></a>01236         <span class="keywordflow">for</span> (var iter2 in Iterator(child.children)) {
<a name="l01237"></a>01237           var grandchild = iter2[1];
<a name="l01238"></a>01238           <span class="keywordflow">if</span> (grandchild.tag === em.Status)
<a name="l01239"></a>01239             flagHeader(<span class="stringliteral">&#39;\\Flagged&#39;</span>, grandchild.children[0].textContent !== <span class="charliteral">&#39;0&#39;</span>);
<a name="l01240"></a>01240         }
<a name="l01241"></a>01241         <span class="keywordflow">break</span>;
<a name="l01242"></a>01242       <span class="keywordflow">case</span> asb.Body: <span class="comment">// ActiveSync 12.0+</span>
<a name="l01243"></a>01243         <span class="keywordflow">for</span> (var iter2 in Iterator(child.children)) {
<a name="l01244"></a>01244           var grandchild = iter2[1];
<a name="l01245"></a>01245           <span class="keywordflow">switch</span> (grandchild.tag) {
<a name="l01246"></a>01246           <span class="keywordflow">case</span> asb.Type:
<a name="l01247"></a>01247             var <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = grandchild.children[0].textContent;
<a name="l01248"></a>01248             <span class="keywordflow">if</span> (type === asbEnum.Type.HTML)
<a name="l01249"></a>01249               bodyType = <span class="stringliteral">&#39;html&#39;</span>;
<a name="l01250"></a>01250             <span class="keywordflow">else</span> {
<a name="l01251"></a>01251               <span class="comment">// I&#39;ve seen a handful of extra-weird messages with body types</span>
<a name="l01252"></a>01252               <span class="comment">// that aren&#39;t plain or html. Let&#39;s assume they&#39;re plain, though.</span>
<a name="l01253"></a>01253               <span class="keywordflow">if</span> (type !== asbEnum.Type.PlainText)
<a name="l01254"></a>01254                 <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;A message had a strange body type:&#39;</span>, type)
<a name="l01255"></a>01255               bodyType = <span class="stringliteral">&#39;plain&#39;</span>;
<a name="l01256"></a>01256             }
<a name="l01257"></a>01257             <span class="keywordflow">break</span>;
<a name="l01258"></a>01258           <span class="keywordflow">case</span> asb.EstimatedDataSize:
<a name="l01259"></a>01259             bodySize = grandchild.children[0].textContent;
<a name="l01260"></a>01260             <span class="keywordflow">break</span>;
<a name="l01261"></a>01261           }
<a name="l01262"></a>01262         }
<a name="l01263"></a>01263         <span class="keywordflow">break</span>;
<a name="l01264"></a>01264       <span class="keywordflow">case</span> em.BodySize: <span class="comment">// pre-ActiveSync 12.0</span>
<a name="l01265"></a>01265         bodyType = <span class="stringliteral">&#39;plain&#39;</span>;
<a name="l01266"></a>01266         bodySize = childText;
<a name="l01267"></a>01267         <span class="keywordflow">break</span>;
<a name="l01268"></a>01268       <span class="keywordflow">case</span> asb.Attachments: <span class="comment">// ActiveSync 12.0+</span>
<a name="l01269"></a>01269       <span class="keywordflow">case</span> em.Attachments:  <span class="comment">// pre-ActiveSync 12.0</span>
<a name="l01270"></a>01270         <span class="keywordflow">for</span> (var iter2 in Iterator(child.children)) {
<a name="l01271"></a>01271           var attachmentNode = iter2[1];
<a name="l01272"></a>01272           <span class="keywordflow">if</span> (attachmentNode.tag !== asb.Attachment &amp;&amp;
<a name="l01273"></a>01273               attachmentNode.tag !== em.Attachment)
<a name="l01274"></a>01274             <span class="keywordflow">continue</span>;
<a name="l01275"></a>01275 
<a name="l01276"></a>01276           var attachment = {
<a name="l01277"></a>01277             <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01278"></a>01278             contentId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01279"></a>01279             type: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01280"></a>01280             part: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01281"></a>01281             <a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01282"></a>01282             sizeEstimate: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01283"></a>01283             <a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l01284"></a>01284           };
<a name="l01285"></a>01285 
<a name="l01286"></a>01286           var isInline = <span class="keyword">false</span>;
<a name="l01287"></a>01287           <span class="keywordflow">for</span> (var iter3 in Iterator(attachmentNode.children)) {
<a name="l01288"></a>01288             var attachData = iter3[1];
<a name="l01289"></a>01289             var <a class="code" href="../../d3/d91/j3d_8js.html#a38127c0f0b1c8ef2f2bfa445024e51fd">dot</a>, ext;
<a name="l01290"></a>01290             var attachDataText = attachData.children.length ?
<a name="l01291"></a>01291                                  attachData.children[0].textContent : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293             <span class="keywordflow">switch</span> (attachData.tag) {
<a name="l01294"></a>01294             <span class="keywordflow">case</span> asb.DisplayName:
<a name="l01295"></a>01295             <span class="keywordflow">case</span> em.DisplayName:
<a name="l01296"></a>01296               attachment.name = attachDataText;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298               <span class="comment">// Get the file&#39;s extension to look up a mimetype, but ignore it</span>
<a name="l01299"></a>01299               <span class="comment">// if the filename is of the form &#39;.bashrc&#39;.</span>
<a name="l01300"></a>01300               dot = attachment.name.lastIndexOf(<span class="charliteral">&#39;.&#39;</span>);
<a name="l01301"></a>01301               ext = dot &gt; 0 ? attachment.name.substring(dot + 1).toLowerCase() :
<a name="l01302"></a>01302                               <span class="stringliteral">&#39;&#39;</span>;
<a name="l01303"></a>01303               attachment.type = $mimelib.contentTypes[ext] ||
<a name="l01304"></a>01304                                 <span class="stringliteral">&#39;application/octet-stream&#39;</span>;
<a name="l01305"></a>01305               <span class="keywordflow">break</span>;
<a name="l01306"></a>01306             <span class="keywordflow">case</span> asb.FileReference:
<a name="l01307"></a>01307             <span class="keywordflow">case</span> em.AttName:
<a name="l01308"></a>01308               attachment.part = attachDataText;
<a name="l01309"></a>01309               <span class="keywordflow">break</span>;
<a name="l01310"></a>01310             <span class="keywordflow">case</span> asb.EstimatedDataSize:
<a name="l01311"></a>01311             <span class="keywordflow">case</span> em.AttSize:
<a name="l01312"></a>01312               attachment.sizeEstimate = parseInt(attachDataText, 10);
<a name="l01313"></a>01313               <span class="keywordflow">break</span>;
<a name="l01314"></a>01314             <span class="keywordflow">case</span> asb.ContentId:
<a name="l01315"></a>01315               attachment.contentId = attachDataText;
<a name="l01316"></a>01316               <span class="keywordflow">break</span>;
<a name="l01317"></a>01317             <span class="keywordflow">case</span> asb.IsInline:
<a name="l01318"></a>01318               isInline = (attachDataText === <span class="charliteral">&#39;1&#39;</span>);
<a name="l01319"></a>01319               <span class="keywordflow">break</span>;
<a name="l01320"></a>01320             <span class="keywordflow">case</span> asb.FileReference:
<a name="l01321"></a>01321             <span class="keywordflow">case</span> em.Att0Id:
<a name="l01322"></a>01322               attachment.part = attachData.children[0].textContent;
<a name="l01323"></a>01323               <span class="keywordflow">break</span>;
<a name="l01324"></a>01324             }
<a name="l01325"></a>01325           }
<a name="l01326"></a>01326 
<a name="l01327"></a>01327           <span class="keywordflow">if</span> (isInline)
<a name="l01328"></a>01328             body.relatedParts.push(attachment);
<a name="l01329"></a>01329           <span class="keywordflow">else</span>
<a name="l01330"></a>01330             body.attachments.push(attachment);
<a name="l01331"></a>01331         }
<a name="l01332"></a>01332         header.hasAttachments = body.attachments.length &gt; 0;
<a name="l01333"></a>01333         <span class="keywordflow">break</span>;
<a name="l01334"></a>01334       }
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337     body.bodyReps = [{
<a name="l01338"></a>01338       type: bodyType,
<a name="l01339"></a>01339       sizeEstimate: bodySize,
<a name="l01340"></a>01340       amountDownloaded: 0,
<a name="l01341"></a>01341       isDownloaded: <span class="keyword">false</span>
<a name="l01342"></a>01342     }];
<a name="l01343"></a>01343 
<a name="l01344"></a>01344     <span class="keywordflow">return</span> { header: <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body: body };
<a name="l01345"></a>01345   },
<a name="l01346"></a>01346 
<a name="l01354"></a>01354   downloadBodies: <span class="keyword">function</span>(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01355"></a>01355     <span class="keywordflow">if</span> (this._account.conn.currentVersion.lt(<span class="stringliteral">&#39;12.0&#39;</span>))
<a name="l01356"></a>01356       <span class="keywordflow">return</span> this._syncBodies(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01357"></a>01357 
<a name="l01358"></a>01358     var anyErr,
<a name="l01359"></a>01359         pending = 1,
<a name="l01360"></a>01360         downloadsNeeded = 0,
<a name="l01361"></a>01361         folderConn = <span class="keyword">this</span>;
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     <span class="keyword">function</span> next(err) {
<a name="l01364"></a>01364       <span class="keywordflow">if</span> (err &amp;&amp; !anyErr)
<a name="l01365"></a>01365         anyErr = err;
<a name="l01366"></a>01366 
<a name="l01367"></a>01367       <span class="keywordflow">if</span> (!--pending) {
<a name="l01368"></a>01368         folderConn._storage.runAfterDeferredCalls(<span class="keyword">function</span>() {
<a name="l01369"></a>01369           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(anyErr, <span class="comment">/* number downloaded */</span> downloadsNeeded - pending);
<a name="l01370"></a>01370         });
<a name="l01371"></a>01371       }
<a name="l01372"></a>01372     }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l01375"></a>01375       <span class="comment">// We obviously can&#39;t do anything with null header references.</span>
<a name="l01376"></a>01376       <span class="comment">// To avoid redundant work, we also don&#39;t want to do any fetching if we</span>
<a name="l01377"></a>01377       <span class="comment">// already have a snippet.  This could happen because of the extreme</span>
<a name="l01378"></a>01378       <span class="comment">// potential for a caller to spam multiple requests at us before we</span>
<a name="l01379"></a>01379       <span class="comment">// service any of them.  (Callers should only have one or two outstanding</span>
<a name="l01380"></a>01380       <span class="comment">// jobs of this and do their own suppression tracking, but bugs happen.)</span>
<a name="l01381"></a>01381       <span class="keywordflow">if</span> (!<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] || <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].snippet !== null) {
<a name="l01382"></a>01382         <span class="keywordflow">continue</span>;
<a name="l01383"></a>01383       }
<a name="l01384"></a>01384 
<a name="l01385"></a>01385       pending++;
<a name="l01386"></a>01386       <span class="comment">// This isn&#39;t absolutely guaranteed to be 100% correct, but is good enough</span>
<a name="l01387"></a>01387       <span class="comment">// for indicating to the caller that we did some work.</span>
<a name="l01388"></a>01388       downloadsNeeded++;
<a name="l01389"></a>01389       this.downloadBodyReps(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>], options, next);
<a name="l01390"></a>01390     }
<a name="l01391"></a>01391 
<a name="l01392"></a>01392     <span class="comment">// by having one pending item always this handles the case of not having any</span>
<a name="l01393"></a>01393     <span class="comment">// snippets needing a download and also returning in the next tick of the</span>
<a name="l01394"></a>01394     <span class="comment">// event loop.</span>
<a name="l01395"></a>01395     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setZeroTimeout(next);
<a name="l01396"></a>01396   },
<a name="l01397"></a>01397 
<a name="l01398"></a>01398   downloadBodyReps: lazyConnection(1, <span class="keyword">function</span>(header, options, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01399"></a>01399     var folderConn = <span class="keyword">this</span>;
<a name="l01400"></a>01400     var account = this._account;
<a name="l01401"></a>01401 
<a name="l01402"></a>01402     <span class="keywordflow">if</span> (account.conn.currentVersion.lt(<span class="stringliteral">&#39;12.0&#39;</span>))
<a name="l01403"></a>01403       <span class="keywordflow">return</span> this._syncBodies([header], <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(options) === <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l01406"></a>01406       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>;
<a name="l01407"></a>01407       options = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01408"></a>01408     }
<a name="l01409"></a>01409     options = options || {};
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     var io = $ItemOperations.Tags;
<a name="l01412"></a>01412     var ioEnum = $ItemOperations.Enums;
<a name="l01413"></a>01413     var as = $AirSync.Tags;
<a name="l01414"></a>01414     var asEnum = $AirSync.Enums;
<a name="l01415"></a>01415     var asb = $AirSyncBase.Tags;
<a name="l01416"></a>01416     var Type = $AirSyncBase.Enums.Type;
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     var gotBody = <span class="keyword">function</span> gotBody(bodyInfo) {
<a name="l01419"></a>01419       <span class="comment">// ActiveSync only stores one body rep, no matter how many body parts the</span>
<a name="l01420"></a>01420       <span class="comment">// MIME message actually has.</span>
<a name="l01421"></a>01421       var bodyRep = bodyInfo.bodyReps[0];
<a name="l01422"></a>01422       var bodyType = bodyRep.type === <span class="stringliteral">&#39;html&#39;</span> ? Type.HTML : Type.PlainText;
<a name="l01423"></a>01423       var truncationSize;
<a name="l01424"></a>01424 
<a name="l01425"></a>01425       <span class="comment">// If the body is bigger than the max size, grab a small bit of plain text</span>
<a name="l01426"></a>01426       <span class="comment">// to show as the snippet.</span>
<a name="l01427"></a>01427       <span class="keywordflow">if</span> (options.maximumBytesToFetch &lt; bodyRep.sizeEstimate) {
<a name="l01428"></a>01428         bodyType = Type.PlainText;
<a name="l01429"></a>01429         truncationSize = DESIRED_TEXT_SNIPPET_BYTES;
<a name="l01430"></a>01430       }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432       var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l01433"></a>01433       w.stag(io.ItemOperations)
<a name="l01434"></a>01434          .stag(io.Fetch)
<a name="l01435"></a>01435            .tag(io.Store, <span class="stringliteral">&#39;Mailbox&#39;</span>)
<a name="l01436"></a>01436            .tag(as.CollectionId, folderConn.serverId)
<a name="l01437"></a>01437            .tag(as.ServerId, header.srvid)
<a name="l01438"></a>01438            .stag(io.Options)
<a name="l01439"></a>01439              <span class="comment">// Only get the AirSyncBase:Body element to minimize bandwidth.</span>
<a name="l01440"></a>01440              .stag(io.Schema)
<a name="l01441"></a>01441                .tag(asb.Body)
<a name="l01442"></a>01442              .etag()
<a name="l01443"></a>01443              .stag(asb.BodyPreference)
<a name="l01444"></a>01444                .tag(asb.Type, bodyType);
<a name="l01445"></a>01445 
<a name="l01446"></a>01446       <span class="keywordflow">if</span> (truncationSize)
<a name="l01447"></a>01447               w.tag(asb.TruncationSize, truncationSize);
<a name="l01448"></a>01448 
<a name="l01449"></a>01449             w.etag()
<a name="l01450"></a>01450            .etag()
<a name="l01451"></a>01451          .etag()
<a name="l01452"></a>01452        .etag();
<a name="l01453"></a>01453 
<a name="l01454"></a>01454       account.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l01455"></a>01455         <span class="keywordflow">if</span> (aError) {
<a name="l01456"></a>01456           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(aError);
<a name="l01457"></a>01457           account._reportErrorIfNecessary(aError);
<a name="l01458"></a>01458           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01459"></a>01459           <span class="keywordflow">return</span>;
<a name="l01460"></a>01460         }
<a name="l01461"></a>01461 
<a name="l01462"></a>01462         var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, bodyContent,
<a name="l01463"></a>01463             e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l01464"></a>01464         e.addEventListener([io.ItemOperations, io.Status], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01465"></a>01465           status = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01466"></a>01466         });
<a name="l01467"></a>01467         e.addEventListener([io.ItemOperations, io.Response, io.Fetch,
<a name="l01468"></a>01468                             io.Properties, asb.Body, asb.Data], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01469"></a>01469           bodyContent = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01470"></a>01470         });
<a name="l01471"></a>01471         e.run(aResponse);
<a name="l01472"></a>01472 
<a name="l01473"></a>01473         <span class="keywordflow">if</span> (status !== ioEnum.Status.Success)
<a name="l01474"></a>01474           <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01475"></a>01475 
<a name="l01476"></a>01476         folderConn._updateBody(header, bodyInfo, bodyContent, !!truncationSize,
<a name="l01477"></a>01477                                <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01478"></a>01478       });
<a name="l01479"></a>01479     };
<a name="l01480"></a>01480 
<a name="l01481"></a>01481     this._storage.getMessageBody(header.suid, header.date, gotBody);
<a name="l01482"></a>01482   }),
<a name="l01483"></a>01483 
<a name="l01489"></a>01489   _syncBodies: <span class="keyword">function</span>(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01490"></a>01490     var as = $AirSync.Tags;
<a name="l01491"></a>01491     var asEnum = $AirSync.Enums;
<a name="l01492"></a>01492     var em = $Email.Tags;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494     var folderConn = <span class="keyword">this</span>;
<a name="l01495"></a>01495     var account = this._account;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l01498"></a>01498     w.stag(as.Sync)
<a name="l01499"></a>01499        .stag(as.Collections)
<a name="l01500"></a>01500          .stag(as.Collection)
<a name="l01501"></a>01501            .tag(as.Class, <span class="stringliteral">&#39;Email&#39;</span>)
<a name="l01502"></a>01502            .tag(as.SyncKey, <span class="keyword">this</span>.syncKey)
<a name="l01503"></a>01503            .tag(as.CollectionId, <span class="keyword">this</span>.serverId)
<a name="l01504"></a>01504            .stag(as.Options)
<a name="l01505"></a>01505              .tag(as.MIMESupport, asEnum.MIMESupport.Never)
<a name="l01506"></a>01506            .etag()
<a name="l01507"></a>01507            .stag(as.Commands);
<a name="l01508"></a>01508 
<a name="l01509"></a>01509     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l01510"></a>01510             w.stag(as.Fetch)
<a name="l01511"></a>01511                .tag(as.ServerId, <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].srvid)
<a name="l01512"></a>01512              .etag();
<a name="l01513"></a>01513     }
<a name="l01514"></a>01514 
<a name="l01515"></a>01515           w.etag()
<a name="l01516"></a>01516          .etag()
<a name="l01517"></a>01517        .etag()
<a name="l01518"></a>01518      .etag();
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     account.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l01521"></a>01521       <span class="keywordflow">if</span> (aError) {
<a name="l01522"></a>01522         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(aError);
<a name="l01523"></a>01523         account._reportErrorIfNecessary(aError);
<a name="l01524"></a>01524         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01525"></a>01525         <span class="keywordflow">return</span>;
<a name="l01526"></a>01526       }
<a name="l01527"></a>01527 
<a name="l01528"></a>01528       var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, anyErr,
<a name="l01529"></a>01529           i = 0,
<a name="l01530"></a>01530           pending = 1;
<a name="l01531"></a>01531 
<a name="l01532"></a>01532       <span class="keyword">function</span> next(err) {
<a name="l01533"></a>01533         <span class="keywordflow">if</span> (err &amp;&amp; !anyErr)
<a name="l01534"></a>01534           anyErr = err;
<a name="l01535"></a>01535 
<a name="l01536"></a>01536         <span class="keywordflow">if</span> (!--pending) {
<a name="l01537"></a>01537           folderConn._storage.runAfterDeferredCalls(<span class="keyword">function</span>() {
<a name="l01538"></a>01538             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(anyErr);
<a name="l01539"></a>01539           });
<a name="l01540"></a>01540         }
<a name="l01541"></a>01541       }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543       var e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l01544"></a>01544       var base = [as.Sync, as.Collections, as.Collection];
<a name="l01545"></a>01545       e.addEventListener(base.concat(as.SyncKey), <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01546"></a>01546         folderConn.syncKey = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01547"></a>01547       });
<a name="l01548"></a>01548       e.addEventListener(base.concat(as.Status), <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01549"></a>01549         status = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01550"></a>01550       });
<a name="l01551"></a>01551       e.addEventListener(base.concat(as.Responses, as.Fetch,
<a name="l01552"></a>01552                                      as.ApplicationData, em.Body),
<a name="l01553"></a>01553                          <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01554"></a>01554         <span class="comment">// We assume the response is in the same order as the request!</span>
<a name="l01555"></a>01555         var header = <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[i++];
<a name="l01556"></a>01556         var bodyContent = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01557"></a>01557 
<a name="l01558"></a>01558         pending++;
<a name="l01559"></a>01559         folderConn._storage.getMessageBody(header.suid, header.date,
<a name="l01560"></a>01560                                            <span class="keyword">function</span>(body) {
<a name="l01561"></a>01561           folderConn._updateBody(header, body, bodyContent, <span class="keyword">false</span>, next);
<a name="l01562"></a>01562         });
<a name="l01563"></a>01563       });
<a name="l01564"></a>01564       e.run(aResponse);
<a name="l01565"></a>01565 
<a name="l01566"></a>01566       <span class="keywordflow">if</span> (status !== asEnum.Status.Success)
<a name="l01567"></a>01567         <span class="keywordflow">return</span> next(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01568"></a>01568 
<a name="l01569"></a>01569       next(null);
<a name="l01570"></a>01570     });
<a name="l01571"></a>01571   },
<a name="l01572"></a>01572 
<a name="l01573"></a>01573   _updateBody: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, bodyInfo, bodyContent, snippetOnly, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01574"></a>01574     var bodyRep = bodyInfo.bodyReps[0];
<a name="l01575"></a>01575 
<a name="l01576"></a>01576     <span class="comment">// XXX We don&#39;t want a trailing newline, primarily for unit test reasons</span>
<a name="l01577"></a>01577     <span class="comment">// right now... This might be a problem on our compose-side for activesync.</span>
<a name="l01578"></a>01578     <span class="keywordflow">if</span> (bodyContent.length &amp;&amp; bodyContent[bodyContent.length - 1] === <span class="charliteral">&#39;\n&#39;</span>)
<a name="l01579"></a>01579       bodyContent = bodyContent.slice(0, -1);
<a name="l01580"></a>01580 
<a name="l01581"></a>01581     <span class="comment">// We neither need to store or want to deal with \r in the processing of</span>
<a name="l01582"></a>01582     <span class="comment">// the body.</span>
<a name="l01583"></a>01583     bodyContent = bodyContent.replace(/\r/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l01584"></a>01584 
<a name="l01585"></a>01585     var type = snippetOnly ? <span class="stringliteral">&#39;plain&#39;</span> : bodyRep.type;
<a name="l01586"></a>01586     var <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = $mailchew.processMessageContent(bodyContent, type, !snippetOnly,
<a name="l01587"></a>01587                                                <span class="keyword">true</span>, this._LOG);
<a name="l01588"></a>01588 
<a name="l01589"></a>01589     header.snippet = data.snippet;
<a name="l01590"></a>01590     bodyRep.isDownloaded = !snippetOnly;
<a name="l01591"></a>01591     bodyRep.amountDownloaded = bodyContent.length;
<a name="l01592"></a>01592     <span class="keywordflow">if</span> (!snippetOnly)
<a name="l01593"></a>01593       bodyRep.content = data.content;
<a name="l01594"></a>01594 
<a name="l01595"></a>01595     var <span class="keyword">event</span> = {
<a name="l01596"></a>01596       changeType: <span class="stringliteral">&#39;bodyReps&#39;</span>,
<a name="l01597"></a>01597       indexes: [0]
<a name="l01598"></a>01598     };
<a name="l01599"></a>01599 
<a name="l01600"></a>01600     this._storage.updateMessageHeader(header.date, header.id, <span class="keyword">false</span>, header);
<a name="l01601"></a>01601     this._storage.updateMessageBody(header, bodyInfo, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>);
<a name="l01602"></a>01602     this._storage.runAfterDeferredCalls(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>.bind(null, null, bodyInfo));
<a name="l01603"></a>01603   },
<a name="l01604"></a>01604 
<a name="l01605"></a>01605   <a class="code" href="../../db/d94/fb__sync__init_8js.html#a92f9ed688f8e2bcb54a904b559fd0d57">sync</a>: lazyConnection(1, <span class="keyword">function</span> asfc_sync(accuracyStamp, doneCallback,
<a name="l01606"></a>01606                                     progressCallback) {
<a name="l01607"></a>01607     var folderConn = <span class="keyword">this</span>,
<a name="l01608"></a>01608         addedMessages = 0,
<a name="l01609"></a>01609         changedMessages = 0,
<a name="l01610"></a>01610         deletedMessages = 0;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612     this._LOG.sync_begin(null, null, null);
<a name="l01613"></a>01613     this._enumerateFolderChanges(<span class="keyword">function</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, added, changed, deleted,
<a name="l01614"></a>01614                                            moreAvailable) {
<a name="l01615"></a>01615       var storage = folderConn._storage;
<a name="l01616"></a>01616 
<a name="l01617"></a>01617       <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a> === <span class="stringliteral">&#39;badkey&#39;</span>) {
<a name="l01618"></a>01618         folderConn._account._recreateFolder(storage.folderId, <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>) {
<a name="l01619"></a>01619           <span class="comment">// If we got a bad sync key, we&#39;ll end up creating a new connection,</span>
<a name="l01620"></a>01620           <span class="comment">// so just clear out the old storage to make this connection unusable.</span>
<a name="l01621"></a>01621           folderConn._storage = null;
<a name="l01622"></a>01622           folderConn._LOG.sync_end(null, null, null);
<a name="l01623"></a>01623         });
<a name="l01624"></a>01624         <span class="keywordflow">return</span>;
<a name="l01625"></a>01625       }
<a name="l01626"></a>01626       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l01627"></a>01627         <span class="comment">// Sync is over!</span>
<a name="l01628"></a>01628         folderConn._LOG.sync_end(null, null, null);
<a name="l01629"></a>01629         doneCallback(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>);
<a name="l01630"></a>01630         <span class="keywordflow">return</span>;
<a name="l01631"></a>01631       }
<a name="l01632"></a>01632 
<a name="l01633"></a>01633       <span class="keywordflow">for</span> (var iter in Iterator(added)) {
<a name="l01634"></a>01634         var <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a> = iter[1];
<a name="l01635"></a>01635         <span class="comment">// If we already have this message, it&#39;s probably because we moved it as</span>
<a name="l01636"></a>01636         <span class="comment">// part of a local op, so let&#39;s assume that the data we already have is</span>
<a name="l01637"></a>01637         <span class="comment">// ok. XXX: We might want to verify this, to be safe.</span>
<a name="l01638"></a>01638         <span class="keywordflow">if</span> (storage.hasMessageWithServerId(message.header.srvid))
<a name="l01639"></a>01639           <span class="keywordflow">continue</span>;
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         storage.addMessageHeader(message.header);
<a name="l01642"></a>01642         storage.addMessageBody(message.header, message.body);
<a name="l01643"></a>01643         addedMessages++;
<a name="l01644"></a>01644       }
<a name="l01645"></a>01645 
<a name="l01646"></a>01646       <span class="keywordflow">for</span> (var iter in Iterator(changed)) {
<a name="l01647"></a>01647         var message = iter[1];
<a name="l01648"></a>01648         <span class="comment">// If we don&#39;t know about this message, just bail out.</span>
<a name="l01649"></a>01649         <span class="keywordflow">if</span> (!storage.hasMessageWithServerId(message.header.srvid))
<a name="l01650"></a>01650           <span class="keywordflow">continue</span>;
<a name="l01651"></a>01651 
<a name="l01652"></a>01652         storage.updateMessageHeaderByServerId(message.header.srvid, <span class="keyword">true</span>,
<a name="l01653"></a>01653                                               <span class="keyword">function</span>(oldHeader) {
<a name="l01654"></a>01654           message.header.mergeInto(oldHeader);
<a name="l01655"></a>01655           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01656"></a>01656         });
<a name="l01657"></a>01657         changedMessages++;
<a name="l01658"></a>01658         <span class="comment">// XXX: update bodies</span>
<a name="l01659"></a>01659       }
<a name="l01660"></a>01660 
<a name="l01661"></a>01661       <span class="keywordflow">for</span> (var iter in Iterator(deleted)) {
<a name="l01662"></a>01662         var messageGuid = iter[1];
<a name="l01663"></a>01663         <span class="comment">// If we don&#39;t know about this message, it&#39;s probably because we already</span>
<a name="l01664"></a>01664         <span class="comment">// deleted it.</span>
<a name="l01665"></a>01665         <span class="keywordflow">if</span> (!storage.hasMessageWithServerId(messageGuid))
<a name="l01666"></a>01666           <span class="keywordflow">continue</span>;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668         storage.deleteMessageByServerId(messageGuid);
<a name="l01669"></a>01669         deletedMessages++;
<a name="l01670"></a>01670       }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672       <span class="keywordflow">if</span> (!moreAvailable) {
<a name="l01673"></a>01673         var messagesSeen = addedMessages + changedMessages + deletedMessages;
<a name="l01674"></a>01674 
<a name="l01675"></a>01675         <span class="comment">// Do not report completion of sync until all of our operations have</span>
<a name="l01676"></a>01676         <span class="comment">// been persisted to our in-memory database.  (We do not wait for</span>
<a name="l01677"></a>01677         <span class="comment">// things to hit the disk.)</span>
<a name="l01678"></a>01678         storage.runAfterDeferredCalls(<span class="keyword">function</span>() {
<a name="l01679"></a>01679           <span class="comment">// Note: For the second argument here, we report the number of</span>
<a name="l01680"></a>01680           <span class="comment">// messages we saw that *changed*. This differs from IMAP, which</span>
<a name="l01681"></a>01681           <span class="comment">// reports the number of messages it *saw*.</span>
<a name="l01682"></a>01682           folderConn._LOG.sync_end(addedMessages, changedMessages,
<a name="l01683"></a>01683                                    deletedMessages);
<a name="l01684"></a>01684           storage.markSyncRange($sync.OLDEST_SYNC_DATE, accuracyStamp, <span class="stringliteral">&#39;XXX&#39;</span>,
<a name="l01685"></a>01685                                 accuracyStamp);
<a name="l01686"></a>01686           doneCallback(null, null, messagesSeen);
<a name="l01687"></a>01687         });
<a name="l01688"></a>01688       }
<a name="l01689"></a>01689     },
<a name="l01690"></a>01690     progressCallback);
<a name="l01691"></a>01691   }),
<a name="l01692"></a>01692 
<a name="l01693"></a>01693   performMutation: lazyConnection(1, <span class="keyword">function</span>(invokeWithWriter, callWhenDone) {
<a name="l01694"></a>01694     var folderConn = <span class="keyword">this</span>;
<a name="l01695"></a>01695 
<a name="l01696"></a>01696     var as = $AirSync.Tags;
<a name="l01697"></a>01697     var account = this._account;
<a name="l01698"></a>01698 
<a name="l01699"></a>01699     var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l01700"></a>01700     w.stag(as.Sync)
<a name="l01701"></a>01701        .stag(as.Collections)
<a name="l01702"></a>01702          .stag(as.Collection);
<a name="l01703"></a>01703 
<a name="l01704"></a>01704     <span class="keywordflow">if</span> (account.conn.currentVersion.lt(<span class="stringliteral">&#39;12.1&#39;</span>))
<a name="l01705"></a>01705           w.tag(as.Class, <span class="stringliteral">&#39;Email&#39;</span>);
<a name="l01706"></a>01706 
<a name="l01707"></a>01707           w.tag(as.SyncKey, <span class="keyword">this</span>.syncKey)
<a name="l01708"></a>01708            .tag(as.CollectionId, <span class="keyword">this</span>.serverId)
<a name="l01709"></a>01709            <span class="comment">// Use DeletesAsMoves in non-trash folders. Don&#39;t use it in trash</span>
<a name="l01710"></a>01710            <span class="comment">// folders because that doesn&#39;t make any sense.</span>
<a name="l01711"></a>01711            .tag(as.DeletesAsMoves, <span class="keyword">this</span>.folderMeta.type === <span class="stringliteral">&#39;trash&#39;</span> ? <span class="charliteral">&#39;0&#39;</span> : <span class="charliteral">&#39;1&#39;</span>)
<a name="l01712"></a>01712            <span class="comment">// GetChanges defaults to true, so we must explicitly disable it to</span>
<a name="l01713"></a>01713            <span class="comment">// avoid hearing about changes.</span>
<a name="l01714"></a>01714            .tag(as.GetChanges, <span class="charliteral">&#39;0&#39;</span>)
<a name="l01715"></a>01715            .stag(as.Commands);
<a name="l01716"></a>01716 
<a name="l01717"></a>01717     <span class="keywordflow">try</span> {
<a name="l01718"></a>01718       invokeWithWriter(w);
<a name="l01719"></a>01719     }
<a name="l01720"></a>01720     <span class="keywordflow">catch</span> (ex) {
<a name="l01721"></a>01721       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Exception in performMutation callee:&#39;</span>, ex,
<a name="l01722"></a>01722                     <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l01723"></a>01723       callWhenDone(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01724"></a>01724       <span class="keywordflow">return</span>;
<a name="l01725"></a>01725     }
<a name="l01726"></a>01726 
<a name="l01727"></a>01727            w.etag(as.Commands)
<a name="l01728"></a>01728          .etag(as.Collection)
<a name="l01729"></a>01729        .etag(as.Collections)
<a name="l01730"></a>01730      .etag(as.Sync);
<a name="l01731"></a>01731 
<a name="l01732"></a>01732     account.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l01733"></a>01733       <span class="keywordflow">if</span> (aError) {
<a name="l01734"></a>01734         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;postCommand error:&#39;</span>, aError);
<a name="l01735"></a>01735         account._reportErrorIfNecessary(aError);
<a name="l01736"></a>01736         callWhenDone(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01737"></a>01737         <span class="keywordflow">return</span>;
<a name="l01738"></a>01738       }
<a name="l01739"></a>01739 
<a name="l01740"></a>01740       var e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l01741"></a>01741       var syncKey, <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>;
<a name="l01742"></a>01742 
<a name="l01743"></a>01743       var base = [as.Sync, as.Collections, as.Collection];
<a name="l01744"></a>01744       e.addEventListener(base.concat(as.SyncKey), <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01745"></a>01745         syncKey = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01746"></a>01746       });
<a name="l01747"></a>01747       e.addEventListener(base.concat(as.Status), <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01748"></a>01748         status = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01749"></a>01749       });
<a name="l01750"></a>01750 
<a name="l01751"></a>01751       <span class="keywordflow">try</span> {
<a name="l01752"></a>01752         e.run(aResponse);
<a name="l01753"></a>01753       }
<a name="l01754"></a>01754       <span class="keywordflow">catch</span> (ex) {
<a name="l01755"></a>01755         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error parsing Sync response:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l01756"></a>01756         callWhenDone(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01757"></a>01757         <span class="keywordflow">return</span>;
<a name="l01758"></a>01758       }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760       <span class="keywordflow">if</span> (status === $AirSync.Enums.Status.Success) {
<a name="l01761"></a>01761         folderConn.syncKey = syncKey;
<a name="l01762"></a>01762         <span class="keywordflow">if</span> (callWhenDone)
<a name="l01763"></a>01763           callWhenDone(null);
<a name="l01764"></a>01764       }
<a name="l01765"></a>01765       <span class="keywordflow">else</span> {
<a name="l01766"></a>01766         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Something went wrong during ActiveSync syncing and we &#39;</span> +
<a name="l01767"></a>01767                       <span class="stringliteral">&#39;got a status of &#39;</span> + status);
<a name="l01768"></a>01768         callWhenDone(<span class="stringliteral">&#39;status:&#39;</span> + status);
<a name="l01769"></a>01769       }
<a name="l01770"></a>01770     });
<a name="l01771"></a>01771   }),
<a name="l01772"></a>01772 
<a name="l01773"></a>01773   <span class="comment">// XXX: take advantage of multipart responses here.</span>
<a name="l01774"></a>01774   <span class="comment">// See http://msdn.microsoft.com/en-us/library/ee159875%28v=exchg.80%29.aspx</span>
<a name="l01775"></a>01775   downloadMessageAttachments: lazyConnection(2, <span class="keyword">function</span>(uid,
<a name="l01776"></a>01776                                                          partInfos,
<a name="l01777"></a>01777                                                          <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>,
<a name="l01778"></a>01778                                                          progress) {
<a name="l01779"></a>01779     var folderConn = <span class="keyword">this</span>;
<a name="l01780"></a>01780 
<a name="l01781"></a>01781     var io = $ItemOperations.Tags;
<a name="l01782"></a>01782     var ioStatus = $ItemOperations.Enums.Status;
<a name="l01783"></a>01783     var asb = $AirSyncBase.Tags;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785     var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l01786"></a>01786     w.stag(io.ItemOperations);
<a name="l01787"></a>01787     <span class="keywordflow">for</span> (var iter in Iterator(partInfos)) {
<a name="l01788"></a>01788       var part = iter[1];
<a name="l01789"></a>01789       w.stag(io.Fetch)
<a name="l01790"></a>01790          .tag(io.Store, <span class="stringliteral">&#39;Mailbox&#39;</span>)
<a name="l01791"></a>01791          .tag(asb.FileReference, part.part)
<a name="l01792"></a>01792        .etag();
<a name="l01793"></a>01793     }
<a name="l01794"></a>01794     w.etag();
<a name="l01795"></a>01795 
<a name="l01796"></a>01796     this._account.conn.postCommand(w, <span class="keyword">function</span>(aError, <a class="code" href="../../d9/d6a/ns_color_8h.html#a820357f645d7b0eaf62fd4994dda5a24">aResult</a>) {
<a name="l01797"></a>01797       <span class="keywordflow">if</span> (aError) {
<a name="l01798"></a>01798         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;postCommand error:&#39;</span>, aError);
<a name="l01799"></a>01799         folderConn._account._reportErrorIfNecessary(aError);
<a name="l01800"></a>01800         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l01801"></a>01801         <span class="keywordflow">return</span>;
<a name="l01802"></a>01802       }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804       var globalStatus;
<a name="l01805"></a>01805       var attachments = {};
<a name="l01806"></a>01806 
<a name="l01807"></a>01807       var e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l01808"></a>01808       e.addEventListener([io.ItemOperations, io.Status], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01809"></a>01809         globalStatus = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l01810"></a>01810       });
<a name="l01811"></a>01811       e.addEventListener([io.ItemOperations, io.Response, io.Fetch],
<a name="l01812"></a>01812                          <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l01813"></a>01813         var part = null, attachment = {};
<a name="l01814"></a>01814 
<a name="l01815"></a>01815         <span class="keywordflow">for</span> (var iter in Iterator(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children)) {
<a name="l01816"></a>01816           var child = iter[1];
<a name="l01817"></a>01817           <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a6e4d98b7c4557bf9c2e3600f5f42a2f8">switch</a> (child.tag) {
<a name="l01818"></a>01818           <span class="keywordflow">case</span> io.Status:
<a name="l01819"></a>01819             attachment.status = child.children[0].textContent;
<a name="l01820"></a>01820             <span class="keywordflow">break</span>;
<a name="l01821"></a>01821           <span class="keywordflow">case</span> asb.FileReference:
<a name="l01822"></a>01822             part = child.children[0].textContent;
<a name="l01823"></a>01823             <span class="keywordflow">break</span>;
<a name="l01824"></a>01824           <span class="keywordflow">case</span> io.Properties:
<a name="l01825"></a>01825             var contentType = null, data = null;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827             <a class="code" href="../../da/d7d/cook_8js.html#a418be7b86002fda137e5310961853062">for</a> (var iter2 in Iterator(child.children)) {
<a name="l01828"></a>01828               var grandchild = iter2[1];
<a name="l01829"></a>01829               var <a class="code" href="../../d1/d04/app__install__manager_8js.html#a231b448a4b70e9035748897db2fa1c2a">textContent</a> = grandchild.children[0].textContent;
<a name="l01830"></a>01830 
<a name="l01831"></a>01831               <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a6e4d98b7c4557bf9c2e3600f5f42a2f8">switch</a> (grandchild.tag) {
<a name="l01832"></a>01832               <span class="keywordflow">case</span> asb.ContentType:
<a name="l01833"></a>01833                 contentType = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a231b448a4b70e9035748897db2fa1c2a">textContent</a>;
<a name="l01834"></a>01834                 <span class="keywordflow">break</span>;
<a name="l01835"></a>01835               <span class="keywordflow">case</span> io.Data:
<a name="l01836"></a>01836                 data = <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a231b448a4b70e9035748897db2fa1c2a">textContent</a>, <span class="stringliteral">&#39;base64&#39;</span>);
<a name="l01837"></a>01837                 <span class="keywordflow">break</span>;
<a name="l01838"></a>01838               }
<a name="l01839"></a>01839             }
<a name="l01840"></a>01840 
<a name="l01841"></a>01841             <span class="keywordflow">if</span> (contentType &amp;&amp; data)
<a name="l01842"></a>01842               attachment.data = <span class="keyword">new</span> <a class="code" href="../../d7/d4b/namespacemozilla_1_1dom.html#a739d106dcb2584188674bb530d99233e">Blob</a>([data], { type: contentType });
<a name="l01843"></a>01843             <span class="keywordflow">break</span>;
<a name="l01844"></a>01844           }
<a name="l01845"></a>01845 
<a name="l01846"></a>01846           <span class="keywordflow">if</span> (part)
<a name="l01847"></a>01847             attachments[part] = attachment;
<a name="l01848"></a>01848         }
<a name="l01849"></a>01849       });
<a name="l01850"></a>01850       e.run(<a class="code" href="../../d9/d6a/ns_color_8h.html#a820357f645d7b0eaf62fd4994dda5a24">aResult</a>);
<a name="l01851"></a>01851 
<a name="l01852"></a>01852       var <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a> = globalStatus !== ioStatus.Success ? <span class="stringliteral">&#39;unknown&#39;</span> : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01853"></a>01853       var bodies = [];
<a name="l01854"></a>01854       <span class="keywordflow">for</span> (var iter in Iterator(partInfos)) {
<a name="l01855"></a>01855         var part = iter[1];
<a name="l01856"></a>01856         <span class="keywordflow">if</span> (attachments.hasOwnProperty(part.part) &amp;&amp;
<a name="l01857"></a>01857             attachments[part.part].status === ioStatus.Success) {
<a name="l01858"></a>01858           bodies.push(attachments[part.part].data);
<a name="l01859"></a>01859         }
<a name="l01860"></a>01860         <span class="keywordflow">else</span> {
<a name="l01861"></a>01861           error = <span class="stringliteral">&#39;unknown&#39;</span>;
<a name="l01862"></a>01862           bodies.push(null);
<a name="l01863"></a>01863         }
<a name="l01864"></a>01864       }
<a name="l01865"></a>01865       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(error, bodies);
<a name="l01866"></a>01866     });
<a name="l01867"></a>01867   }),
<a name="l01868"></a>01868 };
<a name="l01869"></a>01869 
<a name="l01870"></a>01870 <span class="keyword">function</span> ActiveSyncFolderSyncer(account, folderStorage, _parentLog) {
<a name="l01871"></a>01871   this._account = account;
<a name="l01872"></a>01872   this.folderStorage = folderStorage;
<a name="l01873"></a>01873 
<a name="l01874"></a>01874   this._LOG = <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#af6bd479a55b8d304e23d9a96d199c3aa">LOGFAB</a>.ActiveSyncFolderSyncer(<span class="keyword">this</span>, _parentLog,
<a name="l01875"></a>01875                                             folderStorage.folderId);
<a name="l01876"></a>01876 
<a name="l01877"></a>01877   this.folderConn = <span class="keyword">new</span> ActiveSyncFolderConn(account, folderStorage, this._LOG);
<a name="l01878"></a>01878 }
<a name="l01879"></a>01879 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ActiveSyncFolderSyncer = ActiveSyncFolderSyncer;
<a name="l01880"></a>01880 ActiveSyncFolderSyncer.prototype = {
<a name="l01885"></a>01885   <span class="keyword">get</span> syncable() {
<a name="l01886"></a>01886     <span class="keywordflow">return</span> this.folderConn.serverId !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01887"></a>01887   },
<a name="l01888"></a>01888 
<a name="l01892"></a>01892   <span class="keyword">get</span> canGrowSync() {
<a name="l01893"></a>01893     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01894"></a>01894   },
<a name="l01895"></a>01895 
<a name="l01896"></a>01896   initialSync: <span class="keyword">function</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, initialDays, syncCallback,
<a name="l01897"></a>01897                         doneCallback, progressCallback) {
<a name="l01898"></a>01898     syncCallback(<span class="stringliteral">&#39;sync&#39;</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l01899"></a>01899     this.folderConn.sync(
<a name="l01900"></a>01900       $date.NOW(),
<a name="l01901"></a>01901       this.onSyncCompleted.bind(<span class="keyword">this</span>, doneCallback, <span class="keyword">true</span>),
<a name="l01902"></a>01902       progressCallback);
<a name="l01903"></a>01903   },
<a name="l01904"></a>01904 
<a name="l01905"></a>01905   refreshSync: <span class="keyword">function</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a>, startTS, endTS, origStartTS,
<a name="l01906"></a>01906                         doneCallback, progressCallback) {
<a name="l01907"></a>01907     this.folderConn.sync(
<a name="l01908"></a>01908       $date.NOW(),
<a name="l01909"></a>01909       this.onSyncCompleted.bind(<span class="keyword">this</span>, doneCallback, <span class="keyword">false</span>),
<a name="l01910"></a>01910       progressCallback);
<a name="l01911"></a>01911   },
<a name="l01912"></a>01912 
<a name="l01913"></a>01913   <span class="comment">// Returns false if no sync is necessary.</span>
<a name="l01914"></a>01914   growSync: <span class="keyword">function</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, growthDirection, anchorTS, syncStepDays,
<a name="l01915"></a>01915                      doneCallback, progressCallback) {
<a name="l01916"></a>01916     <span class="comment">// ActiveSync is different, and trying to sync more doesn&#39;t work with it.</span>
<a name="l01917"></a>01917     <span class="comment">// Just assume we&#39;ve got all we need.</span>
<a name="l01918"></a>01918     <span class="comment">// (There is no need to invoke the callbacks; by returning false, we</span>
<a name="l01919"></a>01919     <span class="comment">// indicate that we did no work.)</span>
<a name="l01920"></a>01920     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01921"></a>01921   },
<a name="l01922"></a>01922 
<a name="l01928"></a>01928   onSyncCompleted: <span class="keyword">function</span> ifs_onSyncCompleted(doneCallback, initialSync,
<a name="l01929"></a>01929                                                 err, bisectInfo, messagesSeen) {
<a name="l01930"></a>01930     var storage = this.folderStorage;
<a name="l01931"></a>01931     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;Sync Completed!&quot;</span>, messagesSeen, <span class="stringliteral">&quot;messages synced&quot;</span>);
<a name="l01932"></a>01932 
<a name="l01933"></a>01933     <span class="comment">// Expand the accuracy range to cover everybody.</span>
<a name="l01934"></a>01934     <span class="keywordflow">if</span> (!err)
<a name="l01935"></a>01935       storage.markSyncedToDawnOfTime();
<a name="l01936"></a>01936     <span class="comment">// Always save state, although as an optimization, we could avoid saving state</span>
<a name="l01937"></a>01937     <span class="comment">// if we were sure that our state with the server did not advance.</span>
<a name="l01938"></a>01938     this._account.__checkpointSyncCompleted();
<a name="l01939"></a>01939 
<a name="l01940"></a>01940     <span class="keywordflow">if</span> (err) {
<a name="l01941"></a>01941       doneCallback(err);
<a name="l01942"></a>01942       <span class="keywordflow">return</span>;
<a name="l01943"></a>01943     }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945     <span class="keywordflow">if</span> (initialSync) {
<a name="l01946"></a>01946       storage._curSyncSlice.ignoreHeaders = <span class="keyword">false</span>;
<a name="l01947"></a>01947       storage._curSyncSlice.waitingOnData = <span class="stringliteral">&#39;db&#39;</span>;
<a name="l01948"></a>01948 
<a name="l01949"></a>01949       storage.getMessagesInImapDateRange(
<a name="l01950"></a>01950         0, null, $sync.INITIAL_FILL_SIZE, $sync.INITIAL_FILL_SIZE,
<a name="l01951"></a>01951         <span class="comment">// Don&#39;t trigger a refresh; we just synced.  Accordingly, releaseMutex can</span>
<a name="l01952"></a>01952         <span class="comment">// be null.</span>
<a name="l01953"></a>01953         storage.onFetchDBHeaders.bind(storage, storage._curSyncSlice, <span class="keyword">false</span>,
<a name="l01954"></a>01954                                       doneCallback, null)
<a name="l01955"></a>01955       );
<a name="l01956"></a>01956     }
<a name="l01957"></a>01957     <span class="keywordflow">else</span> {
<a name="l01958"></a>01958       doneCallback(err);
<a name="l01959"></a>01959     }
<a name="l01960"></a>01960   },
<a name="l01961"></a>01961 
<a name="l01962"></a>01962   allConsumersDead: <span class="keyword">function</span>() {
<a name="l01963"></a>01963   },
<a name="l01964"></a>01964 
<a name="l01965"></a>01965   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>() {
<a name="l01966"></a>01966     this.folderConn.shutdown();
<a name="l01967"></a>01967     this._LOG.__die();
<a name="l01968"></a>01968   },
<a name="l01969"></a>01969 };
<a name="l01970"></a>01970 
<a name="l01971"></a>01971 var <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#af6bd479a55b8d304e23d9a96d199c3aa">LOGFAB</a> = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l01972"></a>01972   ActiveSyncFolderConn: {
<a name="l01973"></a>01973     type: $log.CONNECTION,
<a name="l01974"></a>01974     subtype: $log.CLIENT,
<a name="l01975"></a>01975     events: {
<a name="l01976"></a>01976       inferFilterType: { filterType: <span class="keyword">false</span> },
<a name="l01977"></a>01977     },
<a name="l01978"></a>01978     asyncJobs: {
<a name="l01979"></a>01979       <a class="code" href="../../db/d94/fb__sync__init_8js.html#a92f9ed688f8e2bcb54a904b559fd0d57">sync</a>: {
<a name="l01980"></a>01980         newMessages: <span class="keyword">true</span>, changedMessages: <span class="keyword">true</span>, deletedMessages: <span class="keyword">true</span>,
<a name="l01981"></a>01981       },
<a name="l01982"></a>01982     },
<a name="l01983"></a>01983     errors: {
<a name="l01984"></a>01984       htmlParseError: { ex: $log.EXCEPTION },
<a name="l01985"></a>01985       htmlSnippetError: { ex: $log.EXCEPTION },
<a name="l01986"></a>01986       textChewError: { ex: $log.EXCEPTION },
<a name="l01987"></a>01987       textSnippetError: { ex: $log.EXCEPTION },
<a name="l01988"></a>01988     },
<a name="l01989"></a>01989   },
<a name="l01990"></a>01990   ActiveSyncFolderSyncer: {
<a name="l01991"></a>01991     type: $log.DATABASE,
<a name="l01992"></a>01992     events: {
<a name="l01993"></a>01993     }
<a name="l01994"></a>01994   },
<a name="l01995"></a>01995 });
<a name="l01996"></a>01996 
<a name="l01997"></a>01997 }); <span class="comment">// end define</span>
<a name="l01998"></a>01998 ;
<a name="l01999"></a>01999 <span class="comment">/* Copyright 2012 Mozilla Foundation</span>
<a name="l02000"></a>02000 <span class="comment"> *</span>
<a name="l02001"></a>02001 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l02002"></a>02002 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l02003"></a>02003 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l02004"></a>02004 <span class="comment"> *</span>
<a name="l02005"></a>02005 <span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l02006"></a>02006 <span class="comment"> *</span>
<a name="l02007"></a>02007 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l02008"></a>02008 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l02009"></a>02009 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l02010"></a>02010 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l02011"></a>02011 <span class="comment"> * limitations under the License.</span>
<a name="l02012"></a>02012 <span class="comment"> */</span>
<a name="l02013"></a>02013 
<a name="l02014"></a>02014 (<span class="keyword">function</span> (<a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>, factory) {
<a name="l02015"></a>02015   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a> === <span class="stringliteral">&#39;object&#39;</span>)
<a name="l02016"></a>02016     <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = factory();
<a name="l02017"></a>02017   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a> === <span class="stringliteral">&#39;function&#39;</span> &amp;&amp; <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>.amd)
<a name="l02018"></a>02018     <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;activesync/codepages/Move&#39;</span>,[], factory);
<a name="l02019"></a>02019   <span class="keywordflow">else</span>
<a name="l02020"></a>02020     <a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>.ASCPMove = factory();
<a name="l02021"></a>02021 }(<span class="keyword">this</span>, <span class="keyword">function</span>() {
<a name="l02022"></a>02022   
<a name="l02023"></a>02023 
<a name="l02024"></a>02024   <span class="keywordflow">return</span> {
<a name="l02025"></a>02025     Tags: {
<a name="l02026"></a>02026       MoveItems: 0x0505,
<a name="l02027"></a>02027       <a class="code" href="../../d2/d93/namespacemozilla.html#aff4754243ccc78444027ffa55c6762da">Move</a>:      0x0506,
<a name="l02028"></a>02028       SrcMsgId:  0x0507,
<a name="l02029"></a>02029       SrcFldId:  0x0508,
<a name="l02030"></a>02030       DstFldId:  0x0509,
<a name="l02031"></a>02031       Response:  0x050A,
<a name="l02032"></a>02032       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>:    0x050B,
<a name="l02033"></a>02033       DstMsgId:  0x050C,
<a name="l02034"></a>02034     },
<a name="l02035"></a>02035     Enums: {
<a name="l02036"></a>02036       <a class="code" href="../../d5/d76/_worker_feature_8h.html#a67a0db04d321a74b7e7fcfd3f1a3f70b">Status</a>: {
<a name="l02037"></a>02037         InvalidSourceID: <span class="charliteral">&#39;1&#39;</span>,
<a name="l02038"></a>02038         InvalidDestID:   <span class="charliteral">&#39;2&#39;</span>,
<a name="l02039"></a>02039         Success:         <span class="charliteral">&#39;3&#39;</span>,
<a name="l02040"></a>02040         SourceIsDest:    <span class="charliteral">&#39;4&#39;</span>,
<a name="l02041"></a>02041         MoveFailure:     <span class="charliteral">&#39;5&#39;</span>,
<a name="l02042"></a>02042         ItemLocked:      <span class="charliteral">&#39;7&#39;</span>,
<a name="l02043"></a>02043       },
<a name="l02044"></a>02044     },
<a name="l02045"></a>02045   };
<a name="l02046"></a>02046 }));
<a name="l02047"></a>02047 
<a name="l02048"></a>02048 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/activesync/jobs&#39;</span>,
<a name="l02049"></a>02049   [
<a name="l02050"></a>02050     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l02051"></a>02051     <span class="stringliteral">&#39;../jobmixins&#39;</span>,
<a name="l02052"></a>02052     <span class="stringliteral">&#39;activesync/codepages/AirSync&#39;</span>,
<a name="l02053"></a>02053     <span class="stringliteral">&#39;activesync/codepages/Email&#39;</span>,
<a name="l02054"></a>02054     <span class="stringliteral">&#39;activesync/codepages/Move&#39;</span>,
<a name="l02055"></a>02055     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l02056"></a>02056     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l02057"></a>02057     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l02058"></a>02058   ],
<a name="l02059"></a>02059   <span class="keyword">function</span>(
<a name="l02060"></a>02060     $log,
<a name="l02061"></a>02061     $jobmixins,
<a name="l02062"></a>02062     $AirSync,
<a name="l02063"></a>02063     $Email,
<a name="l02064"></a>02064     $Move,
<a name="l02065"></a>02065     $module,
<a name="l02066"></a>02066     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l02067"></a>02067     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l02068"></a>02068   ) {
<a name="l02069"></a>02069 
<a name="l02070"></a>02070 
<a name="l02071"></a>02071 var $wbxml;
<a name="l02072"></a>02072 
<a name="l02073"></a>02073 <span class="keyword">function</span> lazyConnection(cbIndex, fn, failString) {
<a name="l02074"></a>02074   <span class="keywordflow">return</span> <span class="keyword">function</span> lazyRun() {
<a name="l02075"></a>02075     var args = Array.slice(arguments),
<a name="l02076"></a>02076         errback = args[cbIndex],
<a name="l02077"></a>02077         <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l02078"></a>02078 
<a name="l02079"></a>02079     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;wbxml&#39;</span>], <span class="keyword">function</span> (wbxml) {
<a name="l02080"></a>02080       <span class="keywordflow">if</span> (!$wbxml) {
<a name="l02081"></a>02081         $wbxml = wbxml;
<a name="l02082"></a>02082       }
<a name="l02083"></a>02083 
<a name="l02084"></a>02084       <span class="keyword">self</span>.account.withConnection(errback, <span class="keyword">function</span> () {
<a name="l02085"></a>02085         fn.apply(<span class="keyword">self</span>, args);
<a name="l02086"></a>02086       }, failString);
<a name="l02087"></a>02087     });
<a name="l02088"></a>02088   };
<a name="l02089"></a>02089 }
<a name="l02090"></a>02090 
<a name="l02091"></a>02091 <span class="keyword">function</span> ActiveSyncJobDriver(account, <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>, _parentLog) {
<a name="l02092"></a>02092   this.account = account;
<a name="l02093"></a>02093   <span class="comment">// XXX for simplicity for now, let&#39;s assume that ActiveSync GUID&#39;s are</span>
<a name="l02094"></a>02094   <span class="comment">// maintained across folder moves.</span>
<a name="l02095"></a>02095   this.resilientServerIds = <span class="keyword">true</span>;
<a name="l02096"></a>02096   this._heldMutexReleasers = [];
<a name="l02097"></a>02097 
<a name="l02098"></a>02098   this._LOG = LOGFAB.ActiveSyncJobDriver(<span class="keyword">this</span>, _parentLog, this.account.id);
<a name="l02099"></a>02099 
<a name="l02100"></a>02100   this._state = <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>;
<a name="l02101"></a>02101   <span class="comment">// (we only need to use one as a proxy for initialization)</span>
<a name="l02102"></a>02102   <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.hasOwnProperty(<span class="stringliteral">&#39;suidToServerId&#39;</span>)) {
<a name="l02103"></a>02103     <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.suidToServerId = {};
<a name="l02104"></a>02104     <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.moveMap = {};
<a name="l02105"></a>02105   }
<a name="l02106"></a>02106 
<a name="l02107"></a>02107   this._stateDelta = {
<a name="l02108"></a>02108     serverIdMap: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02109"></a>02109     moveMap: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02110"></a>02110   };
<a name="l02111"></a>02111 }
<a name="l02112"></a>02112 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ActiveSyncJobDriver = ActiveSyncJobDriver;
<a name="l02113"></a>02113 ActiveSyncJobDriver.prototype = {
<a name="l02115"></a>02115   <span class="comment">// helpers</span>
<a name="l02116"></a>02116 
<a name="l02117"></a>02117   postJobCleanup: $jobmixins.postJobCleanup,
<a name="l02118"></a>02118 
<a name="l02119"></a>02119   allJobsDone: $jobmixins.allJobsDone,
<a name="l02120"></a>02120 
<a name="l02121"></a>02121   _accessFolderForMutation: <span class="keyword">function</span>(folderId, needConn, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, deathback,
<a name="l02122"></a>02122                                      label) {
<a name="l02123"></a>02123     var storage = this.account.getFolderStorageForFolderId(folderId),
<a name="l02124"></a>02124         <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l02125"></a>02125     storage.runMutexed(label, <span class="keyword">function</span>(releaseMutex) {
<a name="l02126"></a>02126       <span class="keyword">self</span>._heldMutexReleasers.push(releaseMutex);
<a name="l02127"></a>02127 
<a name="l02128"></a>02128       var syncer = storage.folderSyncer;
<a name="l02129"></a>02129       <span class="keywordflow">if</span> (needConn) {
<a name="l02130"></a>02130         <span class="keyword">self</span>.account.withConnection(callback, <span class="keyword">function</span> () {
<a name="l02131"></a>02131           <span class="keywordflow">try</span> {
<a name="l02132"></a>02132             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(syncer.folderConn, storage);
<a name="l02133"></a>02133           }
<a name="l02134"></a>02134           <span class="keywordflow">catch</span> (ex) {
<a name="l02135"></a>02135             <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l02136"></a>02136           }
<a name="l02137"></a>02137         });
<a name="l02138"></a>02138       } <span class="keywordflow">else</span> {
<a name="l02139"></a>02139         <span class="keywordflow">try</span> {
<a name="l02140"></a>02140           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(syncer.folderConn, storage);
<a name="l02141"></a>02141         }
<a name="l02142"></a>02142         <span class="keywordflow">catch</span> (ex) {
<a name="l02143"></a>02143           <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l02144"></a>02144         }
<a name="l02145"></a>02145       }
<a name="l02146"></a>02146     });
<a name="l02147"></a>02147   },
<a name="l02148"></a>02148 
<a name="l02149"></a>02149   _partitionAndAccessFoldersSequentially:
<a name="l02150"></a>02150     $jobmixins._partitionAndAccessFoldersSequentially,
<a name="l02151"></a>02151 
<a name="l02153"></a>02153   <span class="comment">// modtags</span>
<a name="l02154"></a>02154 
<a name="l02155"></a>02155   local_do_modtags: $jobmixins.local_do_modtags,
<a name="l02156"></a>02156 
<a name="l02157"></a>02157   do_modtags: lazyConnection(1, <span class="keyword">function</span>(op, jobDoneCallback, undo) {
<a name="l02158"></a>02158     <span class="comment">// Note: this method is derived from the IMAP implementation.</span>
<a name="l02159"></a>02159     var addTags = undo ? op.removeTags : op.addTags,
<a name="l02160"></a>02160         removeTags = undo ? op.addTags : op.removeTags;
<a name="l02161"></a>02161 
<a name="l02162"></a>02162     <span class="keyword">function</span> getMark(tag) {
<a name="l02163"></a>02163       <span class="keywordflow">if</span> (addTags &amp;&amp; addTags.indexOf(tag) !== -1)
<a name="l02164"></a>02164         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02165"></a>02165       <span class="keywordflow">if</span> (removeTags &amp;&amp; removeTags.indexOf(tag) !== -1)
<a name="l02166"></a>02166         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02167"></a>02167       <span class="keywordflow">return</span> undefined;
<a name="l02168"></a>02168     }
<a name="l02169"></a>02169 
<a name="l02170"></a>02170     var markRead = getMark(<span class="stringliteral">&#39;\\Seen&#39;</span>);
<a name="l02171"></a>02171     var markFlagged = getMark(<span class="stringliteral">&#39;\\Flagged&#39;</span>);
<a name="l02172"></a>02172 
<a name="l02173"></a>02173     var as = $AirSync.Tags;
<a name="l02174"></a>02174     var em = $Email.Tags;
<a name="l02175"></a>02175 
<a name="l02176"></a>02176     var aggrErr = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02177"></a>02177 
<a name="l02178"></a>02178     this._partitionAndAccessFoldersSequentially(
<a name="l02179"></a>02179       op.messages, <span class="keyword">true</span>,
<a name="l02180"></a>02180       <span class="keyword">function</span> perFolder(folderConn, storage, serverIds, namers, callWhenDone) {
<a name="l02181"></a>02181         var modsToGo = 0;
<a name="l02182"></a>02182         <span class="keyword">function</span> tagsModded(err) {
<a name="l02183"></a>02183           <span class="keywordflow">if</span> (err) {
<a name="l02184"></a>02184             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;failure modifying tags&#39;</span>, err);
<a name="l02185"></a>02185             aggrErr = <span class="stringliteral">&#39;unknown&#39;</span>;
<a name="l02186"></a>02186             <span class="keywordflow">return</span>;
<a name="l02187"></a>02187           }
<a name="l02188"></a>02188           op.progress += (undo ? -serverIds.length : serverIds.length);
<a name="l02189"></a>02189           <span class="keywordflow">if</span> (--modsToGo === 0)
<a name="l02190"></a>02190             callWhenDone();
<a name="l02191"></a>02191         }
<a name="l02192"></a>02192 
<a name="l02193"></a>02193         <span class="comment">// Filter out any offline headers, since the server naturally can&#39;t do</span>
<a name="l02194"></a>02194         <span class="comment">// anything for them. If this means we have no headers at all, just bail</span>
<a name="l02195"></a>02195         <span class="comment">// out.</span>
<a name="l02196"></a>02196         serverIds = serverIds.filter(<span class="keyword">function</span>(srvid) { <span class="keywordflow">return</span> !!srvid; });
<a name="l02197"></a>02197         <span class="keywordflow">if</span> (!serverIds.length) {
<a name="l02198"></a>02198           callWhenDone();
<a name="l02199"></a>02199           <span class="keywordflow">return</span>;
<a name="l02200"></a>02200         }
<a name="l02201"></a>02201 
<a name="l02202"></a>02202         folderConn.performMutation(
<a name="l02203"></a>02203           <span class="keyword">function</span> withWriter(w) {
<a name="l02204"></a>02204             <span class="keywordflow">for</span> (var i = 0; i &lt; serverIds.length; i++) {
<a name="l02205"></a>02205               w.stag(as.Change)
<a name="l02206"></a>02206                  .tag(as.ServerId, serverIds[i])
<a name="l02207"></a>02207                  .stag(as.ApplicationData);
<a name="l02208"></a>02208 
<a name="l02209"></a>02209               <span class="keywordflow">if</span> (markRead !== undefined)
<a name="l02210"></a>02210                 w.tag(em.Read, markRead ? <span class="charliteral">&#39;1&#39;</span> : <span class="charliteral">&#39;0&#39;</span>);
<a name="l02211"></a>02211 
<a name="l02212"></a>02212               <span class="keywordflow">if</span> (markFlagged !== undefined)
<a name="l02213"></a>02213                 w.stag(em.Flag)
<a name="l02214"></a>02214                    .tag(em.Status, markFlagged ? <span class="charliteral">&#39;2&#39;</span> : <span class="charliteral">&#39;0&#39;</span>)
<a name="l02215"></a>02215                  .etag();
<a name="l02216"></a>02216 
<a name="l02217"></a>02217                 w.etag(as.ApplicationData)
<a name="l02218"></a>02218              .etag(as.Change);
<a name="l02219"></a>02219             }
<a name="l02220"></a>02220           },
<a name="l02221"></a>02221           <span class="keyword">function</span> mutationPerformed(err) {
<a name="l02222"></a>02222             <span class="keywordflow">if</span> (err)
<a name="l02223"></a>02223               aggrErr = err;
<a name="l02224"></a>02224             callWhenDone();
<a name="l02225"></a>02225           });
<a name="l02226"></a>02226       },
<a name="l02227"></a>02227       <span class="keyword">function</span> allDone() {
<a name="l02228"></a>02228         jobDoneCallback(aggrErr);
<a name="l02229"></a>02229       },
<a name="l02230"></a>02230       <span class="keyword">function</span> deadConn() {
<a name="l02231"></a>02231         aggrErr = <span class="stringliteral">&#39;aborted-retry&#39;</span>;
<a name="l02232"></a>02232       },
<a name="l02233"></a>02233       <span class="comment">/* reverse if we&#39;re undoing */</span> undo,
<a name="l02234"></a>02234       <span class="stringliteral">&#39;modtags&#39;</span>);
<a name="l02235"></a>02235   }),
<a name="l02236"></a>02236 
<a name="l02237"></a>02237   check_modtags: <span class="keyword">function</span>(op, callback) {
<a name="l02238"></a>02238     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null, <span class="stringliteral">&#39;idempotent&#39;</span>);
<a name="l02239"></a>02239   },
<a name="l02240"></a>02240 
<a name="l02241"></a>02241   local_undo_modtags: $jobmixins.local_undo_modtags,
<a name="l02242"></a>02242 
<a name="l02243"></a>02243   undo_modtags: <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02244"></a>02244     this.do_modtags(op, callback, <span class="keyword">true</span>);
<a name="l02245"></a>02245   },
<a name="l02246"></a>02246 
<a name="l02248"></a>02248   <span class="comment">// move</span>
<a name="l02249"></a>02249 
<a name="l02250"></a>02250   local_do_move: $jobmixins.local_do_move,
<a name="l02251"></a>02251 
<a name="l02252"></a>02252   do_move: lazyConnection(1, <span class="keyword">function</span>(op, jobDoneCallback) {
<a name="l02253"></a>02253     <span class="comment">/*</span>
<a name="l02254"></a>02254 <span class="comment">     * The ActiveSync command for this does not produce or consume SyncKeys.</span>
<a name="l02255"></a>02255 <span class="comment">     * As such, we don&#39;t need to acquire mutexes for the source folders for</span>
<a name="l02256"></a>02256 <span class="comment">     * synchronization correctness, although it is helpful for ordering</span>
<a name="l02257"></a>02257 <span class="comment">     * purposes and reducing confusion.</span>
<a name="l02258"></a>02258 <span class="comment">     *</span>
<a name="l02259"></a>02259 <span class="comment">     * For the target folder a similar logic exists as long as the server-issued</span>
<a name="l02260"></a>02260 <span class="comment">     * GUID&#39;s are resilient against folder moves.  However, we do require in</span>
<a name="l02261"></a>02261 <span class="comment">     * all cases that before synchronizing the target folder that we make sure</span>
<a name="l02262"></a>02262 <span class="comment">     * all move operations to the folder have completed so we message doesn&#39;t</span>
<a name="l02263"></a>02263 <span class="comment">     * disappear and then show up again. XXX we are not currently enforcing this</span>
<a name="l02264"></a>02264 <span class="comment">     * yet.</span>
<a name="l02265"></a>02265 <span class="comment">     */</span>
<a name="l02266"></a>02266     var aggrErr = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, account = this.account,
<a name="l02267"></a>02267         targetFolderStorage = this.account.getFolderStorageForFolderId(
<a name="l02268"></a>02268                                 op.targetFolder);
<a name="l02269"></a>02269     var mo = $Move.Tags;
<a name="l02270"></a>02270 
<a name="l02271"></a>02271     this._partitionAndAccessFoldersSequentially(
<a name="l02272"></a>02272       op.messages, <span class="keyword">true</span>,
<a name="l02273"></a>02273       <span class="keyword">function</span> perFolder(folderConn, storage, serverIds, namers, callWhenDone) {
<a name="l02274"></a>02274         <span class="comment">// Filter out any offline headers, since the server naturally can&#39;t do</span>
<a name="l02275"></a>02275         <span class="comment">// anything for them. If this means we have no headers at all, just bail</span>
<a name="l02276"></a>02276         <span class="comment">// out.</span>
<a name="l02277"></a>02277         serverIds = serverIds.filter(<span class="keyword">function</span>(srvid) { <span class="keywordflow">return</span> !!srvid; });
<a name="l02278"></a>02278         <span class="keywordflow">if</span> (!serverIds.length) {
<a name="l02279"></a>02279           callWhenDone();
<a name="l02280"></a>02280           <span class="keywordflow">return</span>;
<a name="l02281"></a>02281         }
<a name="l02282"></a>02282 
<a name="l02283"></a>02283         <span class="comment">// Filter out any offline headers, since the server naturally can&#39;t do</span>
<a name="l02284"></a>02284         <span class="comment">// anything for them. If this means we have no headers at all, just bail</span>
<a name="l02285"></a>02285         <span class="comment">// out.</span>
<a name="l02286"></a>02286         serverIds = serverIds.filter(<span class="keyword">function</span>(srvid) { <span class="keywordflow">return</span> !!srvid; });
<a name="l02287"></a>02287         <span class="keywordflow">if</span> (!serverIds.length) {
<a name="l02288"></a>02288           callWhenDone();
<a name="l02289"></a>02289           <span class="keywordflow">return</span>;
<a name="l02290"></a>02290         }
<a name="l02291"></a>02291 
<a name="l02292"></a>02292         var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l02293"></a>02293         w.stag(mo.MoveItems);
<a name="l02294"></a>02294         <span class="keywordflow">for</span> (var i = 0; i &lt; serverIds.length; i++) {
<a name="l02295"></a>02295           w.stag(mo.Move)
<a name="l02296"></a>02296              .tag(mo.SrcMsgId, serverIds[i])
<a name="l02297"></a>02297              .tag(mo.SrcFldId, storage.folderMeta.serverId)
<a name="l02298"></a>02298              .tag(mo.DstFldId, targetFolderStorage.folderMeta.serverId)
<a name="l02299"></a>02299            .etag(mo.Move);
<a name="l02300"></a>02300         }
<a name="l02301"></a>02301         w.etag(mo.MoveItems);
<a name="l02302"></a>02302 
<a name="l02303"></a>02303         account.conn.postCommand(w, <span class="keyword">function</span>(err, response) {
<a name="l02304"></a>02304           <span class="keywordflow">if</span> (err) {
<a name="l02305"></a>02305             aggrErr = err;
<a name="l02306"></a>02306             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;failure moving messages:&#39;</span>, err);
<a name="l02307"></a>02307           }
<a name="l02308"></a>02308           callWhenDone();
<a name="l02309"></a>02309         });
<a name="l02310"></a>02310       },
<a name="l02311"></a>02311       <span class="keyword">function</span> allDone() {
<a name="l02312"></a>02312         jobDoneCallback(aggrErr, null, <span class="keyword">true</span>);
<a name="l02313"></a>02313       },
<a name="l02314"></a>02314       <span class="keyword">function</span> deadConn() {
<a name="l02315"></a>02315         aggrErr = <span class="stringliteral">&#39;aborted-retry&#39;</span>;
<a name="l02316"></a>02316       },
<a name="l02317"></a>02317       <span class="keyword">false</span>,
<a name="l02318"></a>02318       <span class="stringliteral">&#39;move&#39;</span>);
<a name="l02319"></a>02319   }),
<a name="l02320"></a>02320 
<a name="l02321"></a>02321   check_move: <span class="keyword">function</span>(op, jobDoneCallback) {
<a name="l02322"></a>02322 
<a name="l02323"></a>02323   },
<a name="l02324"></a>02324 
<a name="l02325"></a>02325   local_undo_move: $jobmixins.local_undo_move,
<a name="l02326"></a>02326 
<a name="l02327"></a>02327   undo_move: <span class="keyword">function</span>(op, jobDoneCallback) {
<a name="l02328"></a>02328   },
<a name="l02329"></a>02329 
<a name="l02331"></a>02331   <span class="comment">// delete</span>
<a name="l02332"></a>02332 
<a name="l02333"></a>02333   local_do_delete: $jobmixins.local_do_delete,
<a name="l02334"></a>02334 
<a name="l02335"></a>02335   do_delete: lazyConnection(1, <span class="keyword">function</span>(op, jobDoneCallback) {
<a name="l02336"></a>02336     var aggrErr = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02337"></a>02337     var as = $AirSync.Tags;
<a name="l02338"></a>02338     var em = $Email.Tags;
<a name="l02339"></a>02339 
<a name="l02340"></a>02340     this._partitionAndAccessFoldersSequentially(
<a name="l02341"></a>02341       op.messages, <span class="keyword">true</span>,
<a name="l02342"></a>02342       <span class="keyword">function</span> perFolder(folderConn, storage, serverIds, namers, callWhenDone) {
<a name="l02343"></a>02343         <span class="comment">// Filter out any offline headers, since the server naturally can&#39;t do</span>
<a name="l02344"></a>02344         <span class="comment">// anything for them. If this means we have no headers at all, just bail</span>
<a name="l02345"></a>02345         <span class="comment">// out.</span>
<a name="l02346"></a>02346         serverIds = serverIds.filter(<span class="keyword">function</span>(srvid) { <span class="keywordflow">return</span> !!srvid; });
<a name="l02347"></a>02347         <span class="keywordflow">if</span> (!serverIds.length) {
<a name="l02348"></a>02348           callWhenDone();
<a name="l02349"></a>02349           <span class="keywordflow">return</span>;
<a name="l02350"></a>02350         }
<a name="l02351"></a>02351 
<a name="l02352"></a>02352         folderConn.performMutation(
<a name="l02353"></a>02353           <span class="keyword">function</span> withWriter(w) {
<a name="l02354"></a>02354             <span class="keywordflow">for</span> (var i = 0; i &lt; serverIds.length; i++) {
<a name="l02355"></a>02355               w.stag(as.Delete)
<a name="l02356"></a>02356                  .tag(as.ServerId, serverIds[i])
<a name="l02357"></a>02357                .etag(as.Delete);
<a name="l02358"></a>02358             }
<a name="l02359"></a>02359           },
<a name="l02360"></a>02360           <span class="keyword">function</span> mutationPerformed(err) {
<a name="l02361"></a>02361             <span class="keywordflow">if</span> (err) {
<a name="l02362"></a>02362               aggrErr = err;
<a name="l02363"></a>02363               <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;failure deleting messages:&#39;</span>, err);
<a name="l02364"></a>02364             }
<a name="l02365"></a>02365             callWhenDone();
<a name="l02366"></a>02366           });
<a name="l02367"></a>02367       },
<a name="l02368"></a>02368       <span class="keyword">function</span> allDone() {
<a name="l02369"></a>02369         jobDoneCallback(aggrErr, null, <span class="keyword">true</span>);
<a name="l02370"></a>02370       },
<a name="l02371"></a>02371       <span class="keyword">function</span> deadConn() {
<a name="l02372"></a>02372         aggrErr = <span class="stringliteral">&#39;aborted-retry&#39;</span>;
<a name="l02373"></a>02373       },
<a name="l02374"></a>02374       <span class="keyword">false</span>,
<a name="l02375"></a>02375       <span class="stringliteral">&#39;delete&#39;</span>);
<a name="l02376"></a>02376   }),
<a name="l02377"></a>02377 
<a name="l02378"></a>02378   check_delete: <span class="keyword">function</span>(op, callback) {
<a name="l02379"></a>02379     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null, <span class="stringliteral">&#39;idempotent&#39;</span>);
<a name="l02380"></a>02380   },
<a name="l02381"></a>02381 
<a name="l02382"></a>02382   local_undo_delete: $jobmixins.local_undo_delete,
<a name="l02383"></a>02383 
<a name="l02384"></a>02384   <span class="comment">// TODO implement</span>
<a name="l02385"></a>02385   undo_delete: <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02386"></a>02386     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02387"></a>02387   },
<a name="l02388"></a>02388 
<a name="l02390"></a>02390   <span class="comment">// syncFolderList</span>
<a name="l02391"></a>02391   <span class="comment">//</span>
<a name="l02392"></a>02392   <span class="comment">// Synchronize our folder list.  This should always be an idempotent operation</span>
<a name="l02393"></a>02393   <span class="comment">// that makes no sense to undo/redo/etc.</span>
<a name="l02394"></a>02394 
<a name="l02395"></a>02395   local_do_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02396"></a>02396     doneCallback(null);
<a name="l02397"></a>02397   },
<a name="l02398"></a>02398 
<a name="l02399"></a>02399   do_syncFolderList: lazyConnection(1, <span class="keyword">function</span>(op, doneCallback) {
<a name="l02400"></a>02400     var account = this.account, <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l02401"></a>02401 
<a name="l02402"></a>02402     <span class="comment">// The inbox needs to be resynchronized if there was no server id and we</span>
<a name="l02403"></a>02403     <span class="comment">// have active slices displaying the contents of the folder.  (No server id</span>
<a name="l02404"></a>02404     <span class="comment">// means the sync will not happen.)</span>
<a name="l02405"></a>02405     var inboxFolder = account.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>),
<a name="l02406"></a>02406         inboxStorage;
<a name="l02407"></a>02407     <span class="keywordflow">if</span> (inboxFolder &amp;&amp; inboxFolder.serverId === null)
<a name="l02408"></a>02408       inboxStorage = account.getFolderStorageForFolderId(inboxFolder.id);
<a name="l02409"></a>02409 
<a name="l02410"></a>02410     account.syncFolderList(<span class="keyword">function</span>(err) {
<a name="l02411"></a>02411       <span class="keywordflow">if</span> (!err)
<a name="l02412"></a>02412         account.meta.lastFolderSyncAt = Date.now();
<a name="l02413"></a>02413       <span class="comment">// save if it worked</span>
<a name="l02414"></a>02414       doneCallback(err ? <span class="stringliteral">&#39;aborted-retry&#39;</span> : null, null, !err);
<a name="l02415"></a>02415 
<a name="l02416"></a>02416       <span class="keywordflow">if</span> (inboxStorage &amp;&amp; inboxStorage.hasActiveSlices) {
<a name="l02417"></a>02417         <span class="keywordflow">if</span> (!err) {
<a name="l02418"></a>02418           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;Refreshing fake inbox&quot;</span>);
<a name="l02419"></a>02419           inboxStorage.resetAndRefreshActiveSlices();
<a name="l02420"></a>02420         }
<a name="l02421"></a>02421         <span class="comment">// XXX: If we do have an error here, we should probably report</span>
<a name="l02422"></a>02422         <span class="comment">// syncfailed on the slices to let the user retry. However, what needs</span>
<a name="l02423"></a>02423         <span class="comment">// retrying is syncFolderList, not syncing the messages in a folder.</span>
<a name="l02424"></a>02424         <span class="comment">// Since that&#39;s complicated to handle, and syncFolderList will retry</span>
<a name="l02425"></a>02425         <span class="comment">// automatically, we can ignore that case for now.</span>
<a name="l02426"></a>02426       }
<a name="l02427"></a>02427     });
<a name="l02428"></a>02428   }, <span class="stringliteral">&#39;aborted-retry&#39;</span>),
<a name="l02429"></a>02429 
<a name="l02430"></a>02430   check_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02431"></a>02431     doneCallback(<span class="stringliteral">&#39;idempotent&#39;</span>);
<a name="l02432"></a>02432   },
<a name="l02433"></a>02433 
<a name="l02434"></a>02434   local_undo_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02435"></a>02435     doneCallback(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02436"></a>02436   },
<a name="l02437"></a>02437 
<a name="l02438"></a>02438   undo_syncFolderList: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02439"></a>02439     doneCallback(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l02440"></a>02440   },
<a name="l02441"></a>02441 
<a name="l02443"></a>02443   <span class="comment">// downloadBodies: Download the bodies from a list of messages</span>
<a name="l02444"></a>02444 
<a name="l02445"></a>02445   local_do_downloadBodies: $jobmixins.local_do_downloadBodies,
<a name="l02446"></a>02446 
<a name="l02447"></a>02447   do_downloadBodies: $jobmixins.do_downloadBodies,
<a name="l02448"></a>02448 
<a name="l02449"></a>02449   check_downloadBodies: $jobmixins.check_downloadBodies,
<a name="l02450"></a>02450 
<a name="l02452"></a>02452   <span class="comment">// downloadBodyReps: Download the bodies from a single message</span>
<a name="l02453"></a>02453 
<a name="l02454"></a>02454   local_do_downloadBodyReps: $jobmixins.local_do_downloadBodyReps,
<a name="l02455"></a>02455 
<a name="l02456"></a>02456   do_downloadBodyReps: $jobmixins.do_downloadBodyReps,
<a name="l02457"></a>02457 
<a name="l02458"></a>02458   check_downloadBodyReps: $jobmixins.check_downloadBodyReps,
<a name="l02459"></a>02459 
<a name="l02461"></a>02461   <span class="comment">// download: Download one or more attachments from a single message</span>
<a name="l02462"></a>02462 
<a name="l02463"></a>02463   local_do_download: $jobmixins.local_do_download,
<a name="l02464"></a>02464 
<a name="l02465"></a>02465   do_download: $jobmixins.do_download,
<a name="l02466"></a>02466 
<a name="l02467"></a>02467   check_download: $jobmixins.check_download,
<a name="l02468"></a>02468 
<a name="l02469"></a>02469   local_undo_download: $jobmixins.local_undo_download,
<a name="l02470"></a>02470 
<a name="l02471"></a>02471   undo_download: $jobmixins.undo_download,
<a name="l02472"></a>02472 
<a name="l02474"></a>02474   <span class="comment">// saveDraft</span>
<a name="l02475"></a>02475 
<a name="l02476"></a>02476   local_do_saveDraft: $jobmixins.local_do_saveDraft,
<a name="l02477"></a>02477 
<a name="l02478"></a>02478   do_saveDraft: $jobmixins.do_saveDraft,
<a name="l02479"></a>02479 
<a name="l02480"></a>02480   check_saveDraft: $jobmixins.check_saveDraft,
<a name="l02481"></a>02481 
<a name="l02482"></a>02482   local_undo_saveDraft: $jobmixins.local_undo_saveDraft,
<a name="l02483"></a>02483 
<a name="l02484"></a>02484   undo_saveDraft: $jobmixins.undo_saveDraft,
<a name="l02485"></a>02485 
<a name="l02487"></a>02487   <span class="comment">// deleteDraft</span>
<a name="l02488"></a>02488 
<a name="l02489"></a>02489   local_do_deleteDraft: $jobmixins.local_do_deleteDraft,
<a name="l02490"></a>02490 
<a name="l02491"></a>02491   do_deleteDraft: $jobmixins.do_deleteDraft,
<a name="l02492"></a>02492 
<a name="l02493"></a>02493   check_deleteDraft: $jobmixins.check_deleteDraft,
<a name="l02494"></a>02494 
<a name="l02495"></a>02495   local_undo_deleteDraft: $jobmixins.local_undo_deleteDraft,
<a name="l02496"></a>02496 
<a name="l02497"></a>02497   undo_deleteDraft: $jobmixins.undo_deleteDraft,
<a name="l02498"></a>02498 
<a name="l02500"></a>02500   <span class="comment">// purgeExcessMessages is a NOP for activesync</span>
<a name="l02501"></a>02501 
<a name="l02502"></a>02502   local_do_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02503"></a>02503     doneCallback(null);
<a name="l02504"></a>02504   },
<a name="l02505"></a>02505 
<a name="l02506"></a>02506   do_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02507"></a>02507     doneCallback(null);
<a name="l02508"></a>02508   },
<a name="l02509"></a>02509 
<a name="l02510"></a>02510   check_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02511"></a>02511     <span class="keywordflow">return</span> <span class="stringliteral">&#39;idempotent&#39;</span>;
<a name="l02512"></a>02512   },
<a name="l02513"></a>02513 
<a name="l02514"></a>02514   local_undo_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02515"></a>02515     doneCallback(null);
<a name="l02516"></a>02516   },
<a name="l02517"></a>02517 
<a name="l02518"></a>02518   undo_purgeExcessMessages: <span class="keyword">function</span>(op, doneCallback) {
<a name="l02519"></a>02519     doneCallback(null);
<a name="l02520"></a>02520   },
<a name="l02521"></a>02521 
<a name="l02523"></a>02523 };
<a name="l02524"></a>02524 
<a name="l02525"></a>02525 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l02526"></a>02526   ActiveSyncJobDriver: {
<a name="l02527"></a>02527     type: $log.DAEMON,
<a name="l02528"></a>02528     events: {
<a name="l02529"></a>02529       savedAttachment: { storage: <span class="keyword">true</span>, mimeType: <span class="keyword">true</span>, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a6d7e27eaec1e5f6600e65858be43c18b">size</a>: <span class="keyword">true</span> },
<a name="l02530"></a>02530       saveFailure: { storage: <span class="keyword">false</span>, mimeType: <span class="keyword">false</span>, error: <span class="keyword">false</span> },
<a name="l02531"></a>02531     },
<a name="l02532"></a>02532     TEST_ONLY_events: {
<a name="l02533"></a>02533       saveFailure: { <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>: <span class="keyword">false</span> },
<a name="l02534"></a>02534     },
<a name="l02535"></a>02535     errors: {
<a name="l02536"></a>02536       callbackErr: { ex: $log.EXCEPTION },
<a name="l02537"></a>02537     },
<a name="l02538"></a>02538 
<a name="l02539"></a>02539   },
<a name="l02540"></a>02540 });
<a name="l02541"></a>02541 
<a name="l02542"></a>02542 }); <span class="comment">// end define</span>
<a name="l02543"></a>02543 ;
<a name="l02548"></a>02548 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/activesync/account&#39;</span>,
<a name="l02549"></a>02549   [
<a name="l02550"></a>02550     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l02551"></a>02551     <span class="stringliteral">&#39;../a64&#39;</span>,
<a name="l02552"></a>02552     <span class="stringliteral">&#39;../accountmixins&#39;</span>,
<a name="l02553"></a>02553     <span class="stringliteral">&#39;../mailslice&#39;</span>,
<a name="l02554"></a>02554     <span class="stringliteral">&#39;../searchfilter&#39;</span>,
<a name="l02555"></a>02555     <span class="comment">// We potentially create the synthetic inbox while offline, so this can&#39;t be</span>
<a name="l02556"></a>02556     <span class="comment">// lazy-loaded.</span>
<a name="l02557"></a>02557     <span class="stringliteral">&#39;activesync/codepages/FolderHierarchy&#39;</span>,
<a name="l02558"></a>02558     <span class="stringliteral">&#39;./folder&#39;</span>,
<a name="l02559"></a>02559     <span class="stringliteral">&#39;./jobs&#39;</span>,
<a name="l02560"></a>02560     <span class="stringliteral">&#39;../util&#39;</span>,
<a name="l02561"></a>02561     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l02562"></a>02562     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l02563"></a>02563     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l02564"></a>02564   ],
<a name="l02565"></a>02565   <span class="keyword">function</span>(
<a name="l02566"></a>02566     $log,
<a name="l02567"></a>02567     $a64,
<a name="l02568"></a>02568     $acctmixins,
<a name="l02569"></a>02569     $mailslice,
<a name="l02570"></a>02570     $searchfilter,
<a name="l02571"></a>02571     $FolderHierarchy,
<a name="l02572"></a>02572     $asfolder,
<a name="l02573"></a>02573     $asjobs,
<a name="l02574"></a>02574     $util,
<a name="l02575"></a>02575     $module,
<a name="l02576"></a>02576     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l02577"></a>02577     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l02578"></a>02578   ) {
<a name="l02579"></a>02579 
<a name="l02580"></a>02580 
<a name="l02581"></a>02581 <span class="comment">// Lazy loaded vars.</span>
<a name="l02582"></a>02582 var $wbxml, $asproto, ASCP;
<a name="l02583"></a>02583 
<a name="l02584"></a>02584 var bsearchForInsert = $util.bsearchForInsert;
<a name="l02585"></a>02585 
<a name="l02586"></a>02586 var DEFAULT_TIMEOUT_MS = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DEFAULT_TIMEOUT_MS = 30 * 1000;
<a name="l02587"></a>02587 
<a name="l02593"></a>02593 <span class="keyword">function</span> lazyConnection(cbIndex, fn, failString) {
<a name="l02594"></a>02594   <span class="keywordflow">return</span> <span class="keyword">function</span> lazyRun() {
<a name="l02595"></a>02595     var args = Array.slice(arguments),
<a name="l02596"></a>02596         errback = args[cbIndex],
<a name="l02597"></a>02597         <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l02598"></a>02598 
<a name="l02599"></a>02599     this.withConnection(errback, <span class="keyword">function</span> () {
<a name="l02600"></a>02600       fn.apply(<span class="keyword">self</span>, args);
<a name="l02601"></a>02601     }, failString);
<a name="l02602"></a>02602   };
<a name="l02603"></a>02603 }
<a name="l02604"></a>02604 
<a name="l02605"></a>02605 <span class="keyword">function</span> ActiveSyncAccount(universe, accountDef, folderInfos, dbConn,
<a name="l02606"></a>02606                            receiveProtoConn, _parentLog) {
<a name="l02607"></a>02607   this.universe = universe;
<a name="l02608"></a>02608   this.<span class="keywordtype">id</span> = accountDef.id;
<a name="l02609"></a>02609   this.accountDef = accountDef;
<a name="l02610"></a>02610 
<a name="l02611"></a>02611   this._db = dbConn;
<a name="l02612"></a>02612 
<a name="l02613"></a>02613   this._LOG = LOGFAB.ActiveSyncAccount(<span class="keyword">this</span>, _parentLog, this.<span class="keywordtype">id</span>);
<a name="l02614"></a>02614 
<a name="l02615"></a>02615   <span class="keywordflow">if</span> (receiveProtoConn) {
<a name="l02616"></a>02616     this.conn = receiveProtoConn;
<a name="l02617"></a>02617     this._attachLoggerToConnection(this.conn);
<a name="l02618"></a>02618   }
<a name="l02619"></a>02619   <span class="keywordflow">else</span> {
<a name="l02620"></a>02620     this.conn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02621"></a>02621   }
<a name="l02622"></a>02622 
<a name="l02623"></a>02623   this.<a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a> = <span class="keyword">true</span>;
<a name="l02624"></a>02624   this.problems = [];
<a name="l02625"></a>02625   this._alive = <span class="keyword">true</span>;
<a name="l02626"></a>02626 
<a name="l02627"></a>02627   this.identities = accountDef.identities;
<a name="l02628"></a>02628 
<a name="l02629"></a>02629   this.folders = [];
<a name="l02630"></a>02630   this._folderStorages = {};
<a name="l02631"></a>02631   this._folderInfos = folderInfos;
<a name="l02632"></a>02632   this._serverIdToFolderId = {};
<a name="l02633"></a>02633   this._deadFolderIds = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02634"></a>02634 
<a name="l02635"></a>02635   this._syncsInProgress = 0;
<a name="l02636"></a>02636   this._lastSyncKey = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02637"></a>02637   this._lastSyncResponseWasEmpty = <span class="keyword">false</span>;
<a name="l02638"></a>02638 
<a name="l02639"></a>02639   this.meta = folderInfos.$meta;
<a name="l02640"></a>02640   this.mutations = folderInfos.$mutations;
<a name="l02641"></a>02641 
<a name="l02642"></a>02642   <span class="comment">// ActiveSync has no need of a timezone offset, but it simplifies things for</span>
<a name="l02643"></a>02643   <span class="comment">// FolderStorage to be able to rely on this.</span>
<a name="l02644"></a>02644   this.tzOffset = 0;
<a name="l02645"></a>02645 
<a name="l02646"></a>02646   <span class="comment">// Sync existing folders</span>
<a name="l02647"></a>02647   <span class="keywordflow">for</span> (var folderId in folderInfos) {
<a name="l02648"></a>02648     <span class="keywordflow">if</span> (folderId[0] === <span class="charliteral">&#39;$&#39;</span>)
<a name="l02649"></a>02649       <span class="keywordflow">continue</span>;
<a name="l02650"></a>02650     var folderInfo = folderInfos[folderId];
<a name="l02651"></a>02651 
<a name="l02652"></a>02652     this._folderStorages[folderId] =
<a name="l02653"></a>02653       <span class="keyword">new</span> $mailslice.FolderStorage(<span class="keyword">this</span>, folderId, folderInfo, this._db,
<a name="l02654"></a>02654                                    $asfolder.ActiveSyncFolderSyncer, <span class="keyword">this</span>._LOG);
<a name="l02655"></a>02655     this._serverIdToFolderId[folderInfo.$meta.serverId] = folderId;
<a name="l02656"></a>02656     this.folders.push(folderInfo.$meta);
<a name="l02657"></a>02657   }
<a name="l02658"></a>02658 
<a name="l02659"></a>02659   this.folders.sort(<span class="keyword">function</span>(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) { <span class="keywordflow">return</span> <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.path.localeCompare(<a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.path); });
<a name="l02660"></a>02660 
<a name="l02661"></a>02661   this._jobDriver = <span class="keyword">new</span> $asjobs.ActiveSyncJobDriver(
<a name="l02662"></a>02662                           <span class="keyword">this</span>,
<a name="l02663"></a>02663                           this._folderInfos.$mutationState);
<a name="l02664"></a>02664 
<a name="l02665"></a>02665   <span class="comment">// Ensure we have an inbox.  The server id cannot be magically known, so we</span>
<a name="l02666"></a>02666   <span class="comment">// create it with a null id.  When we actually sync the folder list, the</span>
<a name="l02667"></a>02667   <span class="comment">// server id will be updated.</span>
<a name="l02668"></a>02668   var inboxFolder = this.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>);
<a name="l02669"></a>02669   <span class="keywordflow">if</span> (!inboxFolder) {
<a name="l02670"></a>02670     <span class="comment">// XXX localized Inbox string (bug 805834)</span>
<a name="l02671"></a>02671     this._addedFolder(null, <span class="charliteral">&#39;0&#39;</span>, <span class="stringliteral">&#39;Inbox&#39;</span>,
<a name="l02672"></a>02672                       $FolderHierarchy.Enums.Type.DefaultInbox, null, <span class="keyword">true</span>);
<a name="l02673"></a>02673   }
<a name="l02674"></a>02674 }
<a name="l02675"></a>02675 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.Account = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ActiveSyncAccount = ActiveSyncAccount;
<a name="l02676"></a>02676 ActiveSyncAccount.prototype = {
<a name="l02677"></a>02677   type: <span class="stringliteral">&#39;activesync&#39;</span>,
<a name="l02678"></a>02678   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span> asa_toString() {
<a name="l02679"></a>02679     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[ActiveSyncAccount: &#39;</span> + this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l02680"></a>02680   },
<a name="l02681"></a>02681 
<a name="l02686"></a>02686   withConnection: <span class="keyword">function</span> (errback, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, failString) {
<a name="l02687"></a>02687     <span class="comment">// lazy load our dependencies if they haven&#39;t already been fetched.  This</span>
<a name="l02688"></a>02688     <span class="comment">// occurs regardless of whether we have a connection already or not.  We</span>
<a name="l02689"></a>02689     <span class="comment">// do this because the connection may have been passed-in to us as a</span>
<a name="l02690"></a>02690     <span class="comment">// leftover of the account creation process.</span>
<a name="l02691"></a>02691     <span class="keywordflow">if</span> (!$wbxml) {
<a name="l02692"></a>02692       <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;wbxml&#39;</span>, <span class="stringliteral">&#39;activesync/protocol&#39;</span>, <span class="stringliteral">&#39;activesync/codepages&#39;</span>],
<a name="l02693"></a>02693               <span class="keyword">function</span> (_wbxml, _asproto, _ASCP) {
<a name="l02694"></a>02694         $wbxml = _wbxml;
<a name="l02695"></a>02695         $asproto = _asproto;
<a name="l02696"></a>02696         ASCP = _ASCP;
<a name="l02697"></a>02697 
<a name="l02698"></a>02698         this.withConnection(errback, callback, failString);
<a name="l02699"></a>02699       }.bind(<span class="keyword">this</span>));
<a name="l02700"></a>02700       <span class="keywordflow">return</span>;
<a name="l02701"></a>02701     }
<a name="l02702"></a>02702 
<a name="l02703"></a>02703     <span class="keywordflow">if</span> (!this.conn) {
<a name="l02704"></a>02704       var accountDef = this.accountDef;
<a name="l02705"></a>02705       this.conn = <span class="keyword">new</span> $asproto.Connection();
<a name="l02706"></a>02706       this._attachLoggerToConnection(this.conn);
<a name="l02707"></a>02707       this.conn.open(accountDef.connInfo.server,
<a name="l02708"></a>02708                      accountDef.credentials.username,
<a name="l02709"></a>02709                      accountDef.credentials.password);
<a name="l02710"></a>02710       this.conn.timeout = DEFAULT_TIMEOUT_MS;
<a name="l02711"></a>02711     }
<a name="l02712"></a>02712 
<a name="l02713"></a>02713     <span class="keywordflow">if</span> (!this.conn.connected) {
<a name="l02714"></a>02714       this.conn.connect(<span class="keyword">function</span>(error) {
<a name="l02715"></a>02715         <span class="keywordflow">if</span> (error) {
<a name="l02716"></a>02716           this._reportErrorIfNecessary(error);
<a name="l02717"></a>02717           errback(failString || <span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l02718"></a>02718           <span class="keywordflow">return</span>;
<a name="l02719"></a>02719         }
<a name="l02720"></a>02720         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l02721"></a>02721       }.bind(<span class="keyword">this</span>));
<a name="l02722"></a>02722     } <span class="keywordflow">else</span> {
<a name="l02723"></a>02723       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l02724"></a>02724     }
<a name="l02725"></a>02725   },
<a name="l02726"></a>02726 
<a name="l02730"></a>02730   _reportErrorIfNecessary: <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l02731"></a>02731     <span class="keywordflow">if</span> (!error) {
<a name="l02732"></a>02732       <span class="keywordflow">return</span>;
<a name="l02733"></a>02733     }
<a name="l02734"></a>02734 
<a name="l02735"></a>02735     <span class="keywordflow">if</span> (error instanceof $asproto.HttpError &amp;&amp; error.status === 401) {
<a name="l02736"></a>02736       <span class="comment">// prompt the user to try a different password</span>
<a name="l02737"></a>02737       this.universe.__reportAccountProblem(<span class="keyword">this</span>, <span class="stringliteral">&#39;bad-user-or-pass&#39;</span>);
<a name="l02738"></a>02738     }
<a name="l02739"></a>02739   },
<a name="l02740"></a>02740 
<a name="l02741"></a>02741 
<a name="l02742"></a>02742   _attachLoggerToConnection: <span class="keyword">function</span>(conn) {
<a name="l02743"></a>02743     <span class="comment">// Use a somewhat unique-ish value for the id so that if we re-create the</span>
<a name="l02744"></a>02744     <span class="comment">// connection it&#39;s obvious it&#39;s different from the previous connection.</span>
<a name="l02745"></a>02745     var logger = LOGFAB.ActiveSyncConnection(conn, this._LOG,
<a name="l02746"></a>02746                                              Date.now() % 1000);
<a name="l02747"></a>02747     <span class="keywordflow">if</span> (logger.logLevel === <span class="stringliteral">&#39;safe&#39;</span>) {
<a name="l02748"></a>02748       conn.onmessage = this._onmessage_safe.bind(<span class="keyword">this</span>, logger);
<a name="l02749"></a>02749     }
<a name="l02750"></a>02750     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (logger.logLevel === <span class="stringliteral">&#39;dangerous&#39;</span>) {
<a name="l02751"></a>02751       conn.onmessage = this._onmessage_dangerous.bind(<span class="keyword">this</span>, logger);
<a name="l02752"></a>02752     }
<a name="l02753"></a>02753   },
<a name="l02754"></a>02754 
<a name="l02759"></a>02759   _onmessage_safe: <span class="keyword">function</span> <a class="code" href="../../d3/da8/worker_8js.html#a57b3967ed151f7c228f67a6b1666a3e1">onmessage</a>(logger,
<a name="l02760"></a>02760       type, special, <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a>, <a class="code" href="../../d6/d54/parameters_8js.html#a4ad646d0ee2fc69a53b50783ca7465dc">params</a>, extraHeaders, sentData, response) {
<a name="l02761"></a>02761     <span class="keywordflow">if</span> (type === <span class="stringliteral">&#39;options&#39;</span>) {
<a name="l02762"></a>02762       logger.options(special, <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a>.status, response);
<a name="l02763"></a>02763     }
<a name="l02764"></a>02764     <span class="keywordflow">else</span> {
<a name="l02765"></a>02765       logger.command(type, special, <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a>.status);
<a name="l02766"></a>02766     }
<a name="l02767"></a>02767   },
<a name="l02768"></a>02768 
<a name="l02774"></a>02774   _onmessage_dangerous: <span class="keyword">function</span> <a class="code" href="../../d3/da8/worker_8js.html#a57b3967ed151f7c228f67a6b1666a3e1">onmessage</a>(logger,
<a name="l02775"></a>02775       type, special, <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a>, <a class="code" href="../../d6/d54/parameters_8js.html#a4ad646d0ee2fc69a53b50783ca7465dc">params</a>, extraHeaders, sentData, response) {
<a name="l02776"></a>02776     <span class="keywordflow">if</span> (type === <span class="stringliteral">&#39;options&#39;</span>) {
<a name="l02777"></a>02777       logger.options(special, <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a>.status, response);
<a name="l02778"></a>02778     }
<a name="l02779"></a>02779     <span class="keywordflow">else</span> {
<a name="l02780"></a>02780       var sentXML, receivedXML;
<a name="l02781"></a>02781       <span class="keywordflow">if</span> (sentData) {
<a name="l02782"></a>02782         <span class="keywordflow">try</span> {
<a name="l02783"></a>02783           var sentReader = <span class="keyword">new</span> $wbxml.Reader(<span class="keyword">new</span> <a class="code" href="../../d7/d4b/namespacemozilla_1_1dom.html#afb47a616d85cb1a7267e4ccdf85c0f94">Uint8Array</a>(sentData), ASCP);
<a name="l02784"></a>02784           sentXML = sentReader.dump();
<a name="l02785"></a>02785         }
<a name="l02786"></a>02786         <span class="keywordflow">catch</span> (ex) {
<a name="l02787"></a>02787           sentXML = <span class="stringliteral">&#39;parse problem&#39;</span>;
<a name="l02788"></a>02788         }
<a name="l02789"></a>02789       }
<a name="l02790"></a>02790       <span class="keywordflow">if</span> (response) {
<a name="l02791"></a>02791         <span class="keywordflow">try</span> {
<a name="l02792"></a>02792           receivedXML = response.dump();
<a name="l02793"></a>02793           response.rewind();
<a name="l02794"></a>02794         }
<a name="l02795"></a>02795         <span class="keywordflow">catch</span> (ex) {
<a name="l02796"></a>02796           receivedXML = <span class="stringliteral">&#39;parse problem&#39;</span>;
<a name="l02797"></a>02797         }
<a name="l02798"></a>02798       }
<a name="l02799"></a>02799       logger.command(type, special, <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a>.status, <a class="code" href="../../d6/d54/parameters_8js.html#a4ad646d0ee2fc69a53b50783ca7465dc">params</a>, extraHeaders, sentXML,
<a name="l02800"></a>02800                      receivedXML);
<a name="l02801"></a>02801     }
<a name="l02802"></a>02802   },
<a name="l02803"></a>02803 
<a name="l02804"></a>02804   toBridgeWire: <span class="keyword">function</span> asa_toBridgeWire() {
<a name="l02805"></a>02805     <span class="keywordflow">return</span> {
<a name="l02806"></a>02806       <span class="keywordtype">id</span>: this.accountDef.id,
<a name="l02807"></a>02807       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: this.accountDef.name,
<a name="l02808"></a>02808       <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: this.accountDef.name,
<a name="l02809"></a>02809       type: this.accountDef.type,
<a name="l02810"></a>02810 
<a name="l02811"></a>02811       defaultPriority: this.accountDef.defaultPriority,
<a name="l02812"></a>02812 
<a name="l02813"></a>02813       <a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a>: this.<a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a>,
<a name="l02814"></a>02814       problems: this.problems,
<a name="l02815"></a>02815 
<a name="l02816"></a>02816       syncRange: this.accountDef.syncRange,
<a name="l02817"></a>02817       syncInterval: this.accountDef.syncInterval,
<a name="l02818"></a>02818       notifyOnNew: this.accountDef.notifyOnNew,
<a name="l02819"></a>02819 
<a name="l02820"></a>02820       identities: this.identities,
<a name="l02821"></a>02821 
<a name="l02822"></a>02822       credentials: {
<a name="l02823"></a>02823         username: this.accountDef.credentials.username,
<a name="l02824"></a>02824       },
<a name="l02825"></a>02825 
<a name="l02826"></a>02826       servers: [
<a name="l02827"></a>02827         {
<a name="l02828"></a>02828           type: this.accountDef.type,
<a name="l02829"></a>02829           connInfo: this.accountDef.connInfo
<a name="l02830"></a>02830         },
<a name="l02831"></a>02831       ]
<a name="l02832"></a>02832     };
<a name="l02833"></a>02833   },
<a name="l02834"></a>02834 
<a name="l02835"></a>02835   toBridgeFolder: <span class="keyword">function</span> asa_toBridgeFolder() {
<a name="l02836"></a>02836     <span class="keywordflow">return</span> {
<a name="l02837"></a>02837       <span class="keywordtype">id</span>: this.accountDef.id,
<a name="l02838"></a>02838       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: this.accountDef.name,
<a name="l02839"></a>02839       <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: this.accountDef.name,
<a name="l02840"></a>02840       type: <span class="stringliteral">&#39;account&#39;</span>,
<a name="l02841"></a>02841     };
<a name="l02842"></a>02842   },
<a name="l02843"></a>02843 
<a name="l02844"></a>02844   <span class="keyword">get</span> numActiveConns() {
<a name="l02845"></a>02845     <span class="keywordflow">return</span> 0;
<a name="l02846"></a>02846   },
<a name="l02847"></a>02847 
<a name="l02851"></a>02851   checkAccount: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02852"></a>02852     <span class="comment">// disconnect first so as to properly check credentials</span>
<a name="l02853"></a>02853     <span class="keywordflow">if</span> (this.conn != null) {
<a name="l02854"></a>02854       <span class="keywordflow">if</span> (this.conn.connected) {
<a name="l02855"></a>02855         this.conn.disconnect();
<a name="l02856"></a>02856       }
<a name="l02857"></a>02857       this.conn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02858"></a>02858     }
<a name="l02859"></a>02859     this.withConnection(<span class="keyword">function</span>(err) {
<a name="l02860"></a>02860       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(err);
<a name="l02861"></a>02861     }, <span class="keyword">function</span>() {
<a name="l02862"></a>02862       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l02863"></a>02863     });
<a name="l02864"></a>02864   },
<a name="l02865"></a>02865 
<a name="l02870"></a>02870   __checkpointSyncCompleted: <span class="keyword">function</span>() {
<a name="l02871"></a>02871     this.saveAccountState(null, null, <span class="stringliteral">&#39;checkpointSync&#39;</span>);
<a name="l02872"></a>02872   },
<a name="l02873"></a>02873 
<a name="l02874"></a>02874   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span> asa_shutdown(callback) {
<a name="l02875"></a>02875     this._LOG.__die();
<a name="l02876"></a>02876     <span class="keywordflow">if</span> (callback)
<a name="l02877"></a>02877       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l02878"></a>02878   },
<a name="l02879"></a>02879 
<a name="l02880"></a>02880   accountDeleted: <span class="keyword">function</span> asa_accountDeleted() {
<a name="l02881"></a>02881     this._alive = <span class="keyword">false</span>;
<a name="l02882"></a>02882     this.<a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>();
<a name="l02883"></a>02883   },
<a name="l02884"></a>02884 
<a name="l02885"></a>02885   sliceFolderMessages: <span class="keyword">function</span> asa_sliceFolderMessages(folderId,
<a name="l02886"></a>02886                                                         bridgeHandle) {
<a name="l02887"></a>02887     var storage = this._folderStorages[folderId],
<a name="l02888"></a>02888         <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a> = <span class="keyword">new</span> $mailslice.MailSlice(bridgeHandle, storage, this._LOG);
<a name="l02889"></a>02889 
<a name="l02890"></a>02890     storage.sliceOpenMostRecent(slice);
<a name="l02891"></a>02891   },
<a name="l02892"></a>02892 
<a name="l02893"></a>02893   searchFolderMessages: <span class="keyword">function</span>(folderId, bridgeHandle, phrase, whatToSearch) {
<a name="l02894"></a>02894     var storage = this._folderStorages[folderId],
<a name="l02895"></a>02895         slice = <span class="keyword">new</span> $searchfilter.SearchSlice(bridgeHandle, storage, phrase,
<a name="l02896"></a>02896                                               whatToSearch, this._LOG);
<a name="l02897"></a>02897     <span class="comment">// the slice is self-starting, we don&#39;t need to call anything on storage</span>
<a name="l02898"></a>02898   },
<a name="l02899"></a>02899 
<a name="l02900"></a>02900   syncFolderList: lazyConnection(0, <span class="keyword">function</span> asa_syncFolderList(callback) {
<a name="l02901"></a>02901     var account = <span class="keyword">this</span>;
<a name="l02902"></a>02902 
<a name="l02903"></a>02903     var fh = ASCP.FolderHierarchy.Tags;
<a name="l02904"></a>02904     var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l02905"></a>02905     w.stag(fh.FolderSync)
<a name="l02906"></a>02906        .tag(fh.SyncKey, <span class="keyword">this</span>.meta.syncKey)
<a name="l02907"></a>02907      .etag();
<a name="l02908"></a>02908 
<a name="l02909"></a>02909     this.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l02910"></a>02910       <span class="keywordflow">if</span> (aError) {
<a name="l02911"></a>02911         account._reportErrorIfNecessary(aError);
<a name="l02912"></a>02912         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(aError);
<a name="l02913"></a>02913         <span class="keywordflow">return</span>;
<a name="l02914"></a>02914       }
<a name="l02915"></a>02915       var e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l02916"></a>02916       var deferredAddedFolders = [];
<a name="l02917"></a>02917 
<a name="l02918"></a>02918       e.addEventListener([fh.FolderSync, fh.SyncKey], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l02919"></a>02919         account.meta.syncKey = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l02920"></a>02920       });
<a name="l02921"></a>02921 
<a name="l02922"></a>02922       e.addEventListener([fh.FolderSync, fh.Changes, [fh.Add, fh.Delete]],
<a name="l02923"></a>02923                          <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l02924"></a>02924         var folder = {};
<a name="l02925"></a>02925         <span class="keywordflow">for</span> (var iter in Iterator(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children)) {
<a name="l02926"></a>02926           var child = iter[1];
<a name="l02927"></a>02927           folder[child.localTagName] = child.children[0].textContent;
<a name="l02928"></a>02928         }
<a name="l02929"></a>02929 
<a name="l02930"></a>02930         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.tag === fh.Add) {
<a name="l02931"></a>02931           <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (!account._addedFolder(folder.ServerId, folder.ParentId,
<a name="l02932"></a>02932                                     folder.DisplayName, folder.Type))
<a name="l02933"></a>02933             deferredAddedFolders.push(folder);
<a name="l02934"></a>02934         }
<a name="l02935"></a>02935         <span class="keywordflow">else</span> {
<a name="l02936"></a>02936           account._deletedFolder(folder.ServerId);
<a name="l02937"></a>02937         }
<a name="l02938"></a>02938       });
<a name="l02939"></a>02939 
<a name="l02940"></a>02940       <span class="keywordflow">try</span> {
<a name="l02941"></a>02941         e.run(aResponse);
<a name="l02942"></a>02942       }
<a name="l02943"></a>02943       <span class="keywordflow">catch</span> (ex) {
<a name="l02944"></a>02944         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error parsing FolderSync response:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l02945"></a>02945                       ex.stack);
<a name="l02946"></a>02946         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l02947"></a>02947         <span class="keywordflow">return</span>;
<a name="l02948"></a>02948       }
<a name="l02949"></a>02949 
<a name="l02950"></a>02950       <span class="comment">// It&#39;s possible we got some folders in an inconvenient order (i.e. child</span>
<a name="l02951"></a>02951       <span class="comment">// folders before their parents). Keep trying to add folders until we&#39;re</span>
<a name="l02952"></a>02952       <span class="comment">// done.</span>
<a name="l02953"></a>02953       <span class="keywordflow">while</span> (deferredAddedFolders.length) {
<a name="l02954"></a>02954         var moreDeferredAddedFolders = [];
<a name="l02955"></a>02955         <span class="keywordflow">for</span> (var iter in Iterator(deferredAddedFolders)) {
<a name="l02956"></a>02956           var folder = iter[1];
<a name="l02957"></a>02957           <span class="keywordflow">if</span> (!account._addedFolder(folder.ServerId, folder.ParentId,
<a name="l02958"></a>02958                                     folder.DisplayName, folder.Type))
<a name="l02959"></a>02959             moreDeferredAddedFolders.push(folder);
<a name="l02960"></a>02960         }
<a name="l02961"></a>02961         <span class="keywordflow">if</span> (moreDeferredAddedFolders.length === deferredAddedFolders.length)
<a name="l02962"></a>02962           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;got some orphaned folders&#39;</span>);
<a name="l02963"></a>02963         deferredAddedFolders = moreDeferredAddedFolders;
<a name="l02964"></a>02964       }
<a name="l02965"></a>02965 
<a name="l02966"></a>02966       <span class="comment">// - create local drafts folder (if needed)</span>
<a name="l02967"></a>02967       var localDrafts = account.getFirstFolderWithType(<span class="stringliteral">&#39;localdrafts&#39;</span>);
<a name="l02968"></a>02968       <span class="keywordflow">if</span> (!localDrafts) {
<a name="l02969"></a>02969         <span class="comment">// Try and add the folder next to the existing drafts folder, or the</span>
<a name="l02970"></a>02970         <span class="comment">// sent folder if there is no drafts folder.  Otherwise we must have an</span>
<a name="l02971"></a>02971         <span class="comment">// inbox and we want to live under that.</span>
<a name="l02972"></a>02972         var sibling = account.getFirstFolderWithType(<span class="stringliteral">&#39;drafts&#39;</span>) ||
<a name="l02973"></a>02973                       account.getFirstFolderWithType(<span class="stringliteral">&#39;sent&#39;</span>);
<a name="l02974"></a>02974         <span class="comment">// If we have a sibling, it can tell us our gelam parent folder id</span>
<a name="l02975"></a>02975         <span class="comment">// which is different from our parent server id.  From there, we can</span>
<a name="l02976"></a>02976         <span class="comment">// map to the serverId.  Note that top-level folders will not have a</span>
<a name="l02977"></a>02977         <span class="comment">// parentId, in which case we want to just go with the top level.</span>
<a name="l02978"></a>02978         var parentServerId;
<a name="l02979"></a>02979         <span class="keywordflow">if</span> (sibling) {
<a name="l02980"></a>02980           <span class="keywordflow">if</span> (sibling.parentId)
<a name="l02981"></a>02981             parentServerId =
<a name="l02982"></a>02982               account._folderInfos[sibling.parentId].$meta.serverId;
<a name="l02983"></a>02983           <span class="keywordflow">else</span>
<a name="l02984"></a>02984             parentServerId = <span class="charliteral">&#39;0&#39;</span>;
<a name="l02985"></a>02985         }
<a name="l02986"></a>02986         <span class="comment">// Otherwise try and make the Inbox our parent.</span>
<a name="l02987"></a>02987         <span class="keywordflow">else</span> {
<a name="l02988"></a>02988           parentServerId = account.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>).serverId;
<a name="l02989"></a>02989         }
<a name="l02990"></a>02990         <span class="comment">// Since this is a synthetic folder; we just directly choose the name</span>
<a name="l02991"></a>02991         <span class="comment">// that our l10n mapping will transform.</span>
<a name="l02992"></a>02992         account._addedFolder(null, parentServerId, <span class="stringliteral">&#39;localdrafts&#39;</span>, null,
<a name="l02993"></a>02993                              <span class="stringliteral">&#39;localdrafts&#39;</span>);
<a name="l02994"></a>02994       }
<a name="l02995"></a>02995 
<a name="l02996"></a>02996       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Synced folder list&#39;</span>);
<a name="l02997"></a>02997       <span class="keywordflow">if</span> (callback)
<a name="l02998"></a>02998         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null);
<a name="l02999"></a>02999     });
<a name="l03000"></a>03000   }),
<a name="l03001"></a>03001 
<a name="l03002"></a>03002   <span class="comment">// Map folder type numbers from ActiveSync to Gaia&#39;s types</span>
<a name="l03003"></a>03003   _folderTypes: {
<a name="l03004"></a>03004      1: <span class="stringliteral">&#39;normal&#39;</span>, <span class="comment">// Generic</span>
<a name="l03005"></a>03005      2: <span class="stringliteral">&#39;inbox&#39;</span>,  <span class="comment">// DefaultInbox</span>
<a name="l03006"></a>03006      3: <span class="stringliteral">&#39;drafts&#39;</span>, <span class="comment">// DefaultDrafts</span>
<a name="l03007"></a>03007      4: <span class="stringliteral">&#39;trash&#39;</span>,  <span class="comment">// DefaultDeleted</span>
<a name="l03008"></a>03008      5: <span class="stringliteral">&#39;sent&#39;</span>,   <span class="comment">// DefaultSent</span>
<a name="l03009"></a>03009      6: <span class="stringliteral">&#39;normal&#39;</span>, <span class="comment">// DefaultOutbox</span>
<a name="l03010"></a>03010     12: <span class="stringliteral">&#39;normal&#39;</span>, <span class="comment">// Mail</span>
<a name="l03011"></a>03011   },
<a name="l03012"></a>03012 
<a name="l03031"></a>03031   _addedFolder: <span class="keyword">function</span> asa__addedFolder(serverId, parentServerId, displayName,
<a name="l03032"></a>03032                                           typeNum, forceType,
<a name="l03033"></a>03033                                           suppressNotification) {
<a name="l03034"></a>03034     <span class="keywordflow">if</span> (!forceType &amp;&amp; !(typeNum in this._folderTypes))
<a name="l03035"></a>03035       <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// Not a folder type we care about.</span>
<a name="l03036"></a>03036 
<a name="l03037"></a>03037     var folderType = $FolderHierarchy.Enums.Type;
<a name="l03038"></a>03038 
<a name="l03039"></a>03039     var <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a> = displayName;
<a name="l03040"></a>03040     var parentFolderId = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03041"></a>03041     var depth = 0;
<a name="l03042"></a>03042     <span class="keywordflow">if</span> (parentServerId !== <span class="charliteral">&#39;0&#39;</span>) {
<a name="l03043"></a>03043       parentFolderId = this._serverIdToFolderId[parentServerId];
<a name="l03044"></a>03044       <span class="comment">// We haven&#39;t learned about the parent folder. Just return, and wait until</span>
<a name="l03045"></a>03045       <span class="comment">// we do.</span>
<a name="l03046"></a>03046       <span class="keywordflow">if</span> (parentFolderId === undefined)
<a name="l03047"></a>03047         <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03048"></a>03048       var <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a> = this._folderInfos[parentFolderId];
<a name="l03049"></a>03049       path = parent.$meta.path + <span class="charliteral">&#39;/&#39;</span> + <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>;
<a name="l03050"></a>03050       depth = parent.$meta.depth + 1;
<a name="l03051"></a>03051     }
<a name="l03052"></a>03052 
<a name="l03053"></a>03053     <span class="comment">// Handle sentinel Inbox.</span>
<a name="l03054"></a>03054     <span class="keywordflow">if</span> (typeNum === folderType.DefaultInbox) {
<a name="l03055"></a>03055       var existingInboxMeta = this.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>);
<a name="l03056"></a>03056       <span class="keywordflow">if</span> (existingInboxMeta) {
<a name="l03057"></a>03057         <span class="comment">// Update the server ID to folder ID mapping.</span>
<a name="l03058"></a>03058         <span class="keyword">delete</span> this._serverIdToFolderId[existingInboxMeta.serverId];
<a name="l03059"></a>03059         this._serverIdToFolderId[serverId] = existingInboxMeta.id;
<a name="l03060"></a>03060 
<a name="l03061"></a>03061         <span class="comment">// Update everything about the folder meta.</span>
<a name="l03062"></a>03062         existingInboxMeta.serverId = serverId;
<a name="l03063"></a>03063         existingInboxMeta.name = displayName;
<a name="l03064"></a>03064         existingInboxMeta.path = <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>;
<a name="l03065"></a>03065         existingInboxMeta.depth = depth;
<a name="l03066"></a>03066         <span class="keywordflow">return</span> existingInboxMeta;
<a name="l03067"></a>03067       }
<a name="l03068"></a>03068     }
<a name="l03069"></a>03069 
<a name="l03070"></a>03070     var folderId = this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;/&#39;</span> + $a64.encodeInt(this.meta.nextFolderNum++);
<a name="l03071"></a>03071     var folderInfo = this._folderInfos[folderId] = {
<a name="l03072"></a>03072       $meta: {
<a name="l03073"></a>03073         <span class="keywordtype">id</span>: folderId,
<a name="l03074"></a>03074         serverId: serverId,
<a name="l03075"></a>03075         <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: displayName,
<a name="l03076"></a>03076         type: forceType || this._folderTypes[typeNum],
<a name="l03077"></a>03077         path: <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>,
<a name="l03078"></a>03078         parentId: parentFolderId,
<a name="l03079"></a>03079         depth: depth,
<a name="l03080"></a>03080         lastSyncedAt: 0,
<a name="l03081"></a>03081         syncKey: <span class="charliteral">&#39;0&#39;</span>,
<a name="l03082"></a>03082       },
<a name="l03083"></a>03083       <span class="comment">// any changes to the structure here must be reflected in _recreateFolder!</span>
<a name="l03084"></a>03084       $impl: {
<a name="l03085"></a>03085         nextId: 0,
<a name="l03086"></a>03086         nextHeaderBlock: 0,
<a name="l03087"></a>03087         nextBodyBlock: 0,
<a name="l03088"></a>03088       },
<a name="l03089"></a>03089       accuracy: [],
<a name="l03090"></a>03090       headerBlocks: [],
<a name="l03091"></a>03091       bodyBlocks: [],
<a name="l03092"></a>03092       serverIdHeaderBlockMapping: {},
<a name="l03093"></a>03093     };
<a name="l03094"></a>03094 
<a name="l03095"></a>03095     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Added folder &#39;</span> + displayName + <span class="stringliteral">&#39; (&#39;</span> + folderId + <span class="charliteral">&#39;)&#39;</span>);
<a name="l03096"></a>03096     this._folderStorages[folderId] =
<a name="l03097"></a>03097       <span class="keyword">new</span> $mailslice.FolderStorage(<span class="keyword">this</span>, folderId, folderInfo, this._db,
<a name="l03098"></a>03098                                    $asfolder.ActiveSyncFolderSyncer, <span class="keyword">this</span>._LOG);
<a name="l03099"></a>03099     this._serverIdToFolderId[serverId] = folderId;
<a name="l03100"></a>03100 
<a name="l03101"></a>03101     var folderMeta = folderInfo.$meta;
<a name="l03102"></a>03102     var idx = bsearchForInsert(this.folders, folderMeta, <span class="keyword">function</span>(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) {
<a name="l03103"></a>03103       <span class="keywordflow">return</span> <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.path.localeCompare(<a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.path);
<a name="l03104"></a>03104     });
<a name="l03105"></a>03105     this.folders.splice(idx, 0, folderMeta);
<a name="l03106"></a>03106 
<a name="l03107"></a>03107     <span class="keywordflow">if</span> (!suppressNotification)
<a name="l03108"></a>03108       this.universe.__notifyAddedFolder(<span class="keyword">this</span>, folderMeta);
<a name="l03109"></a>03109 
<a name="l03110"></a>03110     <span class="keywordflow">return</span> folderMeta;
<a name="l03111"></a>03111   },
<a name="l03112"></a>03112 
<a name="l03121"></a>03121   _deletedFolder: <span class="keyword">function</span> asa__deletedFolder(serverId, suppressNotification) {
<a name="l03122"></a>03122     var folderId = this._serverIdToFolderId[serverId],
<a name="l03123"></a>03123         folderInfo = this._folderInfos[folderId],
<a name="l03124"></a>03124         folderMeta = folderInfo.$meta;
<a name="l03125"></a>03125 
<a name="l03126"></a>03126     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Deleted folder &#39;</span> + folderMeta.name + <span class="stringliteral">&#39; (&#39;</span> + folderId + <span class="charliteral">&#39;)&#39;</span>);
<a name="l03127"></a>03127     <span class="keyword">delete</span> this._serverIdToFolderId[serverId];
<a name="l03128"></a>03128     <span class="keyword">delete</span> this._folderInfos[folderId];
<a name="l03129"></a>03129     <span class="keyword">delete</span> this._folderStorages[folderId];
<a name="l03130"></a>03130 
<a name="l03131"></a>03131     var idx = this.folders.indexOf(folderMeta);
<a name="l03132"></a>03132     this.folders.splice(idx, 1);
<a name="l03133"></a>03133 
<a name="l03134"></a>03134     <span class="keywordflow">if</span> (this._deadFolderIds === null)
<a name="l03135"></a>03135       this._deadFolderIds = [];
<a name="l03136"></a>03136     this._deadFolderIds.push(folderId);
<a name="l03137"></a>03137 
<a name="l03138"></a>03138     <span class="keywordflow">if</span> (!suppressNotification)
<a name="l03139"></a>03139       this.universe.__notifyRemovedFolder(<span class="keyword">this</span>, folderMeta);
<a name="l03140"></a>03140   },
<a name="l03141"></a>03141 
<a name="l03153"></a>03153   _recreateFolder: <span class="keyword">function</span> asa__recreateFolder(folderId, callback) {
<a name="l03154"></a>03154     this._LOG.recreateFolder(folderId);
<a name="l03155"></a>03155     var folderInfo = this._folderInfos[folderId];
<a name="l03156"></a>03156     folderInfo.$impl = {
<a name="l03157"></a>03157       nextId: 0,
<a name="l03158"></a>03158       nextHeaderBlock: 0,
<a name="l03159"></a>03159       nextBodyBlock: 0,
<a name="l03160"></a>03160     };
<a name="l03161"></a>03161     folderInfo.accuracy = [];
<a name="l03162"></a>03162     folderInfo.headerBlocks = [];
<a name="l03163"></a>03163     folderInfo.bodyBlocks = [];
<a name="l03164"></a>03164     folderInfo.serverIdHeaderBlockMapping = {};
<a name="l03165"></a>03165 
<a name="l03166"></a>03166     <span class="keywordflow">if</span> (this._deadFolderIds === null)
<a name="l03167"></a>03167       this._deadFolderIds = [];
<a name="l03168"></a>03168     this._deadFolderIds.push(folderId);
<a name="l03169"></a>03169 
<a name="l03170"></a>03170     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l03171"></a>03171     this.saveAccountState(null, <span class="keyword">function</span>() {
<a name="l03172"></a>03172       var newStorage =
<a name="l03173"></a>03173         <span class="keyword">new</span> $mailslice.FolderStorage(<span class="keyword">self</span>, folderId, folderInfo, <span class="keyword">self</span>._db,
<a name="l03174"></a>03174                                      $asfolder.ActiveSyncFolderSyncer,
<a name="l03175"></a>03175                                      <span class="keyword">self</span>._LOG);
<a name="l03176"></a>03176       <span class="keywordflow">for</span> (var iter in Iterator(<span class="keyword">self</span>._folderStorages[folderId]._slices)) {
<a name="l03177"></a>03177         var slice = iter[1];
<a name="l03178"></a>03178         slice._storage = newStorage;
<a name="l03179"></a>03179         slice.reset();
<a name="l03180"></a>03180         newStorage.sliceOpenMostRecent(slice);
<a name="l03181"></a>03181       }
<a name="l03182"></a>03182       <span class="keyword">self</span>._folderStorages[folderId]._slices = [];
<a name="l03183"></a>03183       <span class="keyword">self</span>._folderStorages[folderId] = newStorage;
<a name="l03184"></a>03184 
<a name="l03185"></a>03185       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(newStorage);
<a name="l03186"></a>03186     }, <span class="stringliteral">&#39;recreateFolder&#39;</span>);
<a name="l03187"></a>03187   },
<a name="l03188"></a>03188 
<a name="l03225"></a>03225   createFolder: lazyConnection(3, <span class="keyword">function</span> asa_createFolder(parentFolderId,
<a name="l03226"></a>03226                                                       folderName,
<a name="l03227"></a>03227                                                       containOnlyOtherFolders,
<a name="l03228"></a>03228                                                       callback) {
<a name="l03229"></a>03229     var account = <span class="keyword">this</span>;
<a name="l03230"></a>03230 
<a name="l03231"></a>03231     var parentFolderServerId = parentFolderId ?
<a name="l03232"></a>03232       this._folderInfos[parentFolderId] : <span class="charliteral">&#39;0&#39;</span>;
<a name="l03233"></a>03233 
<a name="l03234"></a>03234     var fh = ASCP.FolderHierarchy.Tags;
<a name="l03235"></a>03235     var fhStatus = ASCP.FolderHierarchy.Enums.Status;
<a name="l03236"></a>03236     var folderType = ASCP.FolderHierarchy.Enums.Type.Mail;
<a name="l03237"></a>03237 
<a name="l03238"></a>03238     var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l03239"></a>03239     w.stag(fh.FolderCreate)
<a name="l03240"></a>03240        .tag(fh.SyncKey, <span class="keyword">this</span>.meta.syncKey)
<a name="l03241"></a>03241        .tag(fh.ParentId, parentFolderServerId)
<a name="l03242"></a>03242        .tag(fh.DisplayName, folderName)
<a name="l03243"></a>03243        .tag(fh.Type, folderType)
<a name="l03244"></a>03244      .etag();
<a name="l03245"></a>03245 
<a name="l03246"></a>03246     this.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l03247"></a>03247       account._reportErrorIfNecessary(aError);
<a name="l03248"></a>03248 
<a name="l03249"></a>03249       var e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l03250"></a>03250       var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, serverId;
<a name="l03251"></a>03251 
<a name="l03252"></a>03252       e.addEventListener([fh.FolderCreate, fh.Status], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l03253"></a>03253         status = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l03254"></a>03254       });
<a name="l03255"></a>03255       e.addEventListener([fh.FolderCreate, fh.SyncKey], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l03256"></a>03256         account.meta.syncKey = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l03257"></a>03257       });
<a name="l03258"></a>03258       e.addEventListener([fh.FolderCreate, fh.ServerId], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l03259"></a>03259         serverId = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l03260"></a>03260       });
<a name="l03261"></a>03261 
<a name="l03262"></a>03262       <span class="keywordflow">try</span> {
<a name="l03263"></a>03263         e.run(aResponse);
<a name="l03264"></a>03264       }
<a name="l03265"></a>03265       <span class="keywordflow">catch</span> (ex) {
<a name="l03266"></a>03266         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error parsing FolderCreate response:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l03267"></a>03267                       ex.stack);
<a name="l03268"></a>03268         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l03269"></a>03269         <span class="keywordflow">return</span>;
<a name="l03270"></a>03270       }
<a name="l03271"></a>03271 
<a name="l03272"></a>03272       <span class="keywordflow">if</span> (status === fhStatus.Success) {
<a name="l03273"></a>03273         var folderMeta = account._addedFolder(serverId, parentFolderServerId,
<a name="l03274"></a>03274                                               folderName, folderType);
<a name="l03275"></a>03275         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null, folderMeta);
<a name="l03276"></a>03276       }
<a name="l03277"></a>03277       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status === fhStatus.FolderExists) {
<a name="l03278"></a>03278         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;already-exists&#39;</span>);
<a name="l03279"></a>03279       }
<a name="l03280"></a>03280       <span class="keywordflow">else</span> {
<a name="l03281"></a>03281         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l03282"></a>03282       }
<a name="l03283"></a>03283     });
<a name="l03284"></a>03284   }),
<a name="l03285"></a>03285 
<a name="l03292"></a>03292   <a class="code" href="../../df/d99/namespacevariant.html#ab05c7931468d628f4294600987d629f2">deleteFolder</a>: lazyConnection(1, <span class="keyword">function</span> asa_deleteFolder(folderId,
<a name="l03293"></a>03293                                                             callback) {
<a name="l03294"></a>03294     var account = <span class="keyword">this</span>;
<a name="l03295"></a>03295 
<a name="l03296"></a>03296     var folderMeta = this._folderInfos[folderId].$meta;
<a name="l03297"></a>03297 
<a name="l03298"></a>03298     var fh = ASCP.FolderHierarchy.Tags;
<a name="l03299"></a>03299     var fhStatus = ASCP.FolderHierarchy.Enums.Status;
<a name="l03300"></a>03300     var folderType = ASCP.FolderHierarchy.Enums.Type.Mail;
<a name="l03301"></a>03301 
<a name="l03302"></a>03302     var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l03303"></a>03303     w.stag(fh.FolderDelete)
<a name="l03304"></a>03304        .tag(fh.SyncKey, <span class="keyword">this</span>.meta.syncKey)
<a name="l03305"></a>03305        .tag(fh.ServerId, folderMeta.serverId)
<a name="l03306"></a>03306      .etag();
<a name="l03307"></a>03307 
<a name="l03308"></a>03308     this.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l03309"></a>03309       account._reportErrorIfNecessary(aError);
<a name="l03310"></a>03310 
<a name="l03311"></a>03311       var e = <span class="keyword">new</span> $wbxml.EventParser();
<a name="l03312"></a>03312       var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>;
<a name="l03313"></a>03313 
<a name="l03314"></a>03314       e.addEventListener([fh.FolderDelete, fh.Status], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l03315"></a>03315         status = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l03316"></a>03316       });
<a name="l03317"></a>03317       e.addEventListener([fh.FolderDelete, fh.SyncKey], <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
<a name="l03318"></a>03318         account.meta.syncKey = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.children[0].textContent;
<a name="l03319"></a>03319       });
<a name="l03320"></a>03320 
<a name="l03321"></a>03321       <span class="keywordflow">try</span> {
<a name="l03322"></a>03322 
<a name="l03323"></a>03323         e.run(aResponse);
<a name="l03324"></a>03324       }
<a name="l03325"></a>03325       <span class="keywordflow">catch</span> (ex) {
<a name="l03326"></a>03326         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error parsing FolderDelete response:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l03327"></a>03327                       ex.stack);
<a name="l03328"></a>03328         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l03329"></a>03329         <span class="keywordflow">return</span>;
<a name="l03330"></a>03330       }
<a name="l03331"></a>03331 
<a name="l03332"></a>03332       <span class="keywordflow">if</span> (status === fhStatus.Success) {
<a name="l03333"></a>03333         account._deletedFolder(folderMeta.serverId);
<a name="l03334"></a>03334         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null, folderMeta);
<a name="l03335"></a>03335       }
<a name="l03336"></a>03336       <span class="keywordflow">else</span> {
<a name="l03337"></a>03337         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l03338"></a>03338       }
<a name="l03339"></a>03339     });
<a name="l03340"></a>03340   }),
<a name="l03341"></a>03341 
<a name="l03342"></a>03342   sendMessage: lazyConnection(1, <span class="keyword">function</span> asa_sendMessage(composer, callback) {
<a name="l03343"></a>03343     var account = <span class="keyword">this</span>;
<a name="l03344"></a>03344 
<a name="l03345"></a>03345     <span class="comment">// we want the bcc included because that&#39;s how we tell the server the bcc</span>
<a name="l03346"></a>03346     <span class="comment">// results.</span>
<a name="l03347"></a>03347     composer.withMessageBuffer({ includeBcc: <span class="keyword">true</span> }, <span class="keyword">function</span>(mimeBuffer) {
<a name="l03348"></a>03348       <span class="comment">// ActiveSync 14.0 has a completely different API for sending email. Make</span>
<a name="l03349"></a>03349       <span class="comment">// sure we format things the right way.</span>
<a name="l03350"></a>03350       <span class="keywordflow">if</span> (this.conn.currentVersion.gte(<span class="stringliteral">&#39;14.0&#39;</span>)) {
<a name="l03351"></a>03351         var cm = ASCP.ComposeMail.Tags;
<a name="l03352"></a>03352         var w = <span class="keyword">new</span> $wbxml.Writer(<span class="stringliteral">&#39;1.3&#39;</span>, 1, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l03353"></a>03353         w.stag(cm.SendMail)
<a name="l03354"></a>03354            <span class="comment">// The ClientId is defined to be for duplicate messages suppression</span>
<a name="l03355"></a>03355            <span class="comment">// and does not need to have any uniqueness constraints apart from</span>
<a name="l03356"></a>03356            <span class="comment">// not being similar to (recently sent) messages by this client.</span>
<a name="l03357"></a>03357            .tag(cm.ClientId, Date.now().toString()+<span class="stringliteral">&#39;@mozgaia&#39;</span>)
<a name="l03358"></a>03358            .tag(cm.SaveInSentItems)
<a name="l03359"></a>03359            .stag(cm.Mime)
<a name="l03360"></a>03360              .opaque(mimeBuffer)
<a name="l03361"></a>03361            .etag()
<a name="l03362"></a>03362          .etag();
<a name="l03363"></a>03363 
<a name="l03364"></a>03364         this.conn.postCommand(w, <span class="keyword">function</span>(aError, aResponse) {
<a name="l03365"></a>03365           <span class="keywordflow">if</span> (aError) {
<a name="l03366"></a>03366             account._reportErrorIfNecessary(aError);
<a name="l03367"></a>03367             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(aError);
<a name="l03368"></a>03368             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l03369"></a>03369             <span class="keywordflow">return</span>;
<a name="l03370"></a>03370           }
<a name="l03371"></a>03371 
<a name="l03372"></a>03372           <span class="keywordflow">if</span> (aResponse === null) {
<a name="l03373"></a>03373             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Sent message successfully!&#39;</span>);
<a name="l03374"></a>03374             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null);
<a name="l03375"></a>03375           }
<a name="l03376"></a>03376           <span class="keywordflow">else</span> {
<a name="l03377"></a>03377             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error sending message. XML dump follows:\n&#39;</span> +
<a name="l03378"></a>03378                           aResponse.dump());
<a name="l03379"></a>03379             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l03380"></a>03380           }
<a name="l03381"></a>03381         });
<a name="l03382"></a>03382       }
<a name="l03383"></a>03383       <span class="keywordflow">else</span> { <span class="comment">// ActiveSync 12.x and lower</span>
<a name="l03384"></a>03384         var encoder = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a992caf3b993bd7025dad3c150b51fb1b">TextEncoder</a>(<span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l03385"></a>03385 
<a name="l03386"></a>03386         <span class="comment">// On B2G 18, XHRs expect ArrayBuffers and will barf on Uint8Arrays. In</span>
<a name="l03387"></a>03387         <span class="comment">// the future, we can remove the last |.buffer| bit below.</span>
<a name="l03388"></a>03388         this.conn.postData(<span class="stringliteral">&#39;SendMail&#39;</span>, <span class="stringliteral">&#39;message/rfc822&#39;</span>,
<a name="l03389"></a>03389                            encoder.encode(mimeBuffer).buffer,
<a name="l03390"></a>03390                            <span class="keyword">function</span>(aError, aResponse) {
<a name="l03391"></a>03391           <span class="keywordflow">if</span> (aError) {
<a name="l03392"></a>03392             account._reportErrorIfNecessary(aError);
<a name="l03393"></a>03393             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(aError);
<a name="l03394"></a>03394             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l03395"></a>03395             <span class="keywordflow">return</span>;
<a name="l03396"></a>03396           }
<a name="l03397"></a>03397 
<a name="l03398"></a>03398           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Sent message successfully!&#39;</span>);
<a name="l03399"></a>03399           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null);
<a name="l03400"></a>03400         }, { SaveInSent: <span class="charliteral">&#39;T&#39;</span> });
<a name="l03401"></a>03401       }
<a name="l03402"></a>03402     }.bind(<span class="keyword">this</span>));
<a name="l03403"></a>03403   }),
<a name="l03404"></a>03404 
<a name="l03405"></a>03405   getFolderStorageForFolderId: <span class="keyword">function</span> asa_getFolderStorageForFolderId(
<a name="l03406"></a>03406                                folderId) {
<a name="l03407"></a>03407     <span class="keywordflow">return</span> this._folderStorages[folderId];
<a name="l03408"></a>03408   },
<a name="l03409"></a>03409 
<a name="l03410"></a>03410   getFolderStorageForServerId: <span class="keyword">function</span> asa_getFolderStorageForServerId(
<a name="l03411"></a>03411                                serverId) {
<a name="l03412"></a>03412     <span class="keywordflow">return</span> this._folderStorages[this._serverIdToFolderId[serverId]];
<a name="l03413"></a>03413   },
<a name="l03414"></a>03414 
<a name="l03415"></a>03415   getFolderMetaForFolderId: <span class="keyword">function</span>(folderId) {
<a name="l03416"></a>03416     <span class="keywordflow">if</span> (this._folderInfos.hasOwnProperty(folderId))
<a name="l03417"></a>03417       <span class="keywordflow">return</span> this._folderInfos[folderId].$meta;
<a name="l03418"></a>03418     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03419"></a>03419   },
<a name="l03420"></a>03420 
<a name="l03421"></a>03421   ensureEssentialFolders: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03422"></a>03422     <span class="comment">// XXX I am assuming ActiveSync servers are smart enough to already come</span>
<a name="l03423"></a>03423     <span class="comment">// with these folders.  If not, we should move IMAP&#39;s ensureEssentialFolders</span>
<a name="l03424"></a>03424     <span class="comment">// into the mixins class.</span>
<a name="l03425"></a>03425     <span class="keywordflow">if</span> (callback)
<a name="l03426"></a>03426       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l03427"></a>03427   },
<a name="l03428"></a>03428 
<a name="l03429"></a>03429   scheduleMessagePurge: <span class="keyword">function</span>(folderId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03430"></a>03430     <span class="comment">// ActiveSync servers have no incremental folder growth, so message purging</span>
<a name="l03431"></a>03431     <span class="comment">// makes no sense for them.</span>
<a name="l03432"></a>03432     <span class="keywordflow">if</span> (callback)
<a name="l03433"></a>03433       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l03434"></a>03434   },
<a name="l03435"></a>03435 
<a name="l03436"></a>03436   runOp: $acctmixins.runOp,
<a name="l03437"></a>03437   getFirstFolderWithType: $acctmixins.getFirstFolderWithType,
<a name="l03438"></a>03438   getFolderByPath: $acctmixins.getFolderByPath,
<a name="l03439"></a>03439   saveAccountState: $acctmixins.saveAccountState,
<a name="l03440"></a>03440   runAfterSaves: $acctmixins.runAfterSaves
<a name="l03441"></a>03441 };
<a name="l03442"></a>03442 
<a name="l03443"></a>03443 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l03444"></a>03444   ActiveSyncAccount: {
<a name="l03445"></a>03445     type: $log.ACCOUNT,
<a name="l03446"></a>03446     events: {
<a name="l03447"></a>03447       createFolder: {},
<a name="l03448"></a>03448       <a class="code" href="../../df/d99/namespacevariant.html#ab05c7931468d628f4294600987d629f2">deleteFolder</a>: {},
<a name="l03449"></a>03449       recreateFolder: { <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l03450"></a>03450       saveAccountState: { <a class="code" href="../../da/dd0/ns_i_d_o_m_close_event_8idl.html#aa538b14c961e4162ded76940b8f37507">reason</a>: <span class="keyword">false</span> },
<a name="l03455"></a>03455       accountDeleted: { where: <span class="keyword">false</span> },
<a name="l03456"></a>03456     },
<a name="l03457"></a>03457     asyncJobs: {
<a name="l03458"></a>03458       runOp: { <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>: <span class="keyword">true</span>, type: <span class="keyword">true</span>, error: <span class="keyword">false</span>, op: <span class="keyword">false</span> },
<a name="l03459"></a>03459     },
<a name="l03460"></a>03460     errors: {
<a name="l03461"></a>03461       opError: { <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>: <span class="keyword">false</span>, type: <span class="keyword">false</span>, ex: $log.EXCEPTION },
<a name="l03462"></a>03462     }
<a name="l03463"></a>03463   },
<a name="l03464"></a>03464 
<a name="l03465"></a>03465   ActiveSyncConnection: {
<a name="l03466"></a>03466     type: $log.CONNECTION,
<a name="l03467"></a>03467     events: {
<a name="l03468"></a>03468       options: { special: <span class="keyword">false</span>, status: <span class="keyword">false</span>, <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>: <span class="keyword">false</span> },
<a name="l03469"></a>03469       command: { <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="keyword">false</span>, special: <span class="keyword">false</span>, status: <span class="keyword">false</span> },
<a name="l03470"></a>03470     },
<a name="l03471"></a>03471     TEST_ONLY_events: {
<a name="l03472"></a>03472       options: {},
<a name="l03473"></a>03473       command: { <a class="code" href="../../d6/d54/parameters_8js.html#a4ad646d0ee2fc69a53b50783ca7465dc">params</a>: <span class="keyword">false</span>, extraHeaders: <span class="keyword">false</span>, sent: <span class="keyword">false</span>,
<a name="l03474"></a>03474                  response: <span class="keyword">false</span> },
<a name="l03475"></a>03475     },
<a name="l03476"></a>03476   },
<a name="l03477"></a>03477 });
<a name="l03478"></a>03478 
<a name="l03479"></a>03479 }); <span class="comment">// end define</span>
<a name="l03480"></a>03480 ;
<a name="l03485"></a>03485 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/activesync/configurator&#39;</span>,
<a name="l03486"></a>03486   [
<a name="l03487"></a>03487     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l03488"></a>03488     <span class="stringliteral">&#39;../accountcommon&#39;</span>,
<a name="l03489"></a>03489     <span class="stringliteral">&#39;../a64&#39;</span>,
<a name="l03490"></a>03490     <span class="stringliteral">&#39;./account&#39;</span>,
<a name="l03491"></a>03491     <span class="stringliteral">&#39;../date&#39;</span>,
<a name="l03492"></a>03492     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l03493"></a>03493     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l03494"></a>03494   ],
<a name="l03495"></a>03495   <span class="keyword">function</span>(
<a name="l03496"></a>03496     $log,
<a name="l03497"></a>03497     $accountcommon,
<a name="l03498"></a>03498     $a64,
<a name="l03499"></a>03499     $asacct,
<a name="l03500"></a>03500     $date,
<a name="l03501"></a>03501     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l03502"></a>03502     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l03503"></a>03503   ) {
<a name="l03504"></a>03504 
<a name="l03505"></a>03505 <span class="keyword">function</span> checkServerCertificate(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, callback) {
<a name="l03506"></a>03506   var <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a> = /^<a class="code" href="../../da/d88/mock__configurator_8js.html#a143d22e446a0feb4cbd35b8b5e3c8d94">https</a>:\/\/([^:/]+)(?::(\d+))?/.<a class="code" href="../../dd/dfd/build__stage_2email_2shared_2test_2integration_2profile__builder_8js.html#a2f76ddb4f47454e20c129320c48d846d">exec</a>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>);
<a name="l03507"></a>03507   <span class="comment">// probably unit test http case?</span>
<a name="l03508"></a>03508   <span class="keywordflow">if</span> (!match) {
<a name="l03509"></a>03509     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null);
<a name="l03510"></a>03510     <span class="keywordflow">return</span>;
<a name="l03511"></a>03511   }
<a name="l03512"></a>03512   var <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a> = match[2] ? parseInt(match[2], 10) : 443,
<a name="l03513"></a>03513       host = match[1];
<a name="l03514"></a>03514 
<a name="l03515"></a>03515   <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;checking&#39;</span>, host, port, <span class="stringliteral">&#39;for security problem&#39;</span>);
<a name="l03516"></a>03516 
<a name="l03517"></a>03517   <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;tls&#39;</span>], <span class="keyword">function</span>($tls) {
<a name="l03518"></a>03518     var sock = $tls.connect(port, host);
<a name="l03519"></a>03519     <span class="keyword">function</span> reportAndClose(err) {
<a name="l03520"></a>03520       <span class="keywordflow">if</span> (sock) {
<a name="l03521"></a>03521         var wasSock = sock;
<a name="l03522"></a>03522         sock = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03523"></a>03523         <span class="keywordflow">try</span> {
<a name="l03524"></a>03524           wasSock.end();
<a name="l03525"></a>03525         }
<a name="l03526"></a>03526         <span class="keywordflow">catch</span> (ex) {
<a name="l03527"></a>03527         }
<a name="l03528"></a>03528         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(err);
<a name="l03529"></a>03529       }
<a name="l03530"></a>03530     }
<a name="l03531"></a>03531     <span class="comment">// this is a little dumb, but since we don&#39;t actually get an event right now</span>
<a name="l03532"></a>03532     <span class="comment">// that tells us when our secure connection is established, and connect always</span>
<a name="l03533"></a>03533     <span class="comment">// happens, we write data when we connect to help trigger an error or have us</span>
<a name="l03534"></a>03534     <span class="comment">// receive data to indicate we successfully connected.</span>
<a name="l03535"></a>03535     <span class="comment">// so, the deal is that connect is going to happen.</span>
<a name="l03536"></a>03536     sock.on(<span class="stringliteral">&#39;connect&#39;</span>, <span class="keyword">function</span>() {
<a name="l03537"></a>03537       sock.write(<span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<span class="stringliteral">&#39;GET /images/logo.png HTTP/1.1\n\n&#39;</span>));
<a name="l03538"></a>03538     });
<a name="l03539"></a>03539     sock.on(<span class="stringliteral">&#39;error&#39;</span>, <span class="keyword">function</span>(err) {
<a name="l03540"></a>03540       var reportErr = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03541"></a>03541       <span class="keywordflow">if</span> (err &amp;&amp; <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(err) === <span class="stringliteral">&#39;object&#39;</span> &amp;&amp;
<a name="l03542"></a>03542           /^<a class="code" href="../../d2/d88/security__privacy_8js.html#a80dee7e5a5e4ab0abb1fb9fe91e6e0dc">Security</a>/.<a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a4fe50fa16c059b33ed172c344bb3fc74">test</a>(err.name))
<a name="l03543"></a>03543         reportErr = <span class="stringliteral">&#39;bad-security&#39;</span>;
<a name="l03544"></a>03544       reportAndClose(reportErr);
<a name="l03545"></a>03545     });
<a name="l03546"></a>03546     sock.on(<span class="stringliteral">&#39;data&#39;</span>, <span class="keyword">function</span>(data) {
<a name="l03547"></a>03547       reportAndClose(null);
<a name="l03548"></a>03548     });
<a name="l03549"></a>03549   });
<a name="l03550"></a>03550 }
<a name="l03551"></a>03551 
<a name="l03552"></a>03552 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.account = $asacct;
<a name="l03553"></a>03553 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.configurator = {
<a name="l03554"></a>03554   tryToCreateAccount: <span class="keyword">function</span> cfg_as_ttca(universe, userDetails, domainInfo,
<a name="l03555"></a>03555                                            callback, _LOG) {
<a name="l03556"></a>03556     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;activesync/protocol&#39;</span>], <span class="keyword">function</span> ($asproto) {
<a name="l03557"></a>03557       var credentials = {
<a name="l03558"></a>03558         username: domainInfo.incoming.username,
<a name="l03559"></a>03559         password: userDetails.password,
<a name="l03560"></a>03560       };
<a name="l03561"></a>03561 
<a name="l03562"></a>03562       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l03563"></a>03563       var conn = <span class="keyword">new</span> $asproto.Connection();
<a name="l03564"></a>03564       conn.open(domainInfo.incoming.server, credentials.username,
<a name="l03565"></a>03565                 credentials.password);
<a name="l03566"></a>03566       conn.timeout = $asacct.DEFAULT_TIMEOUT_MS;
<a name="l03567"></a>03567 
<a name="l03568"></a>03568       conn.connect(<span class="keyword">function</span>(error, options) {
<a name="l03569"></a>03569         <span class="keywordflow">if</span> (error) {
<a name="l03570"></a>03570           <span class="comment">// This error is basically an indication of whether we were able to</span>
<a name="l03571"></a>03571           <span class="comment">// call getOptions or not.  If the XHR request completed, we get an</span>
<a name="l03572"></a>03572           <span class="comment">// HttpError.  If we timed out or an XHR error occurred, we get a</span>
<a name="l03573"></a>03573           <span class="comment">// general Error.</span>
<a name="l03574"></a>03574           var failureType,
<a name="l03575"></a>03575               failureDetails = { <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a>: domainInfo.incoming.server };
<a name="l03576"></a>03576 
<a name="l03577"></a>03577           <span class="keywordflow">if</span> (error instanceof $asproto.HttpError) {
<a name="l03578"></a>03578             <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (error.status === 401) {
<a name="l03579"></a>03579               failureType = <span class="stringliteral">&#39;bad-user-or-pass&#39;</span>;
<a name="l03580"></a>03580             }
<a name="l03581"></a>03581             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (error.status === 403) {
<a name="l03582"></a>03582               failureType = <span class="stringliteral">&#39;not-authorized&#39;</span>;
<a name="l03583"></a>03583             }
<a name="l03584"></a>03584             <span class="comment">// Treat any other errors where we talked to the server as a problem</span>
<a name="l03585"></a>03585             <span class="comment">// with the server.</span>
<a name="l03586"></a>03586             <span class="keywordflow">else</span> {
<a name="l03587"></a>03587               failureType = <span class="stringliteral">&#39;server-problem&#39;</span>;
<a name="l03588"></a>03588               failureDetails.status = error.status;
<a name="l03589"></a>03589             }
<a name="l03590"></a>03590           }
<a name="l03591"></a>03591           <span class="keywordflow">else</span> {
<a name="l03592"></a>03592             <span class="comment">// We didn&#39;t talk to the server, so it&#39;s either an unresponsive</span>
<a name="l03593"></a>03593             <span class="comment">// server or a server with a bad certificate.  (We require https</span>
<a name="l03594"></a>03594             <span class="comment">// outside of unit tests so there&#39;s no need to branch here.)</span>
<a name="l03595"></a>03595             checkServerCertificate(
<a name="l03596"></a>03596               domainInfo.incoming.server,
<a name="l03597"></a>03597               <span class="keyword">function</span>(securityError) {
<a name="l03598"></a>03598                 var failureType;
<a name="l03599"></a>03599                 <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (securityError)
<a name="l03600"></a>03600                   failureType = <span class="stringliteral">&#39;bad-security&#39;</span>;
<a name="l03601"></a>03601                 <span class="keywordflow">else</span>
<a name="l03602"></a>03602                   failureType = <span class="stringliteral">&#39;unresponsive-server&#39;</span>;
<a name="l03603"></a>03603                 <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(failureType, null, failureDetails);
<a name="l03604"></a>03604               });
<a name="l03605"></a>03605             <span class="keywordflow">return</span>;
<a name="l03606"></a>03606           }
<a name="l03607"></a>03607           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(failureType, null, failureDetails);
<a name="l03608"></a>03608           <span class="keywordflow">return</span>;
<a name="l03609"></a>03609         }
<a name="l03610"></a>03610 
<a name="l03611"></a>03611         var accountId = $a64.encodeInt(universe.config.nextAccountNum++);
<a name="l03612"></a>03612         var accountDef = {
<a name="l03613"></a>03613           <span class="keywordtype">id</span>: accountId,
<a name="l03614"></a>03614           <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: userDetails.accountName || userDetails.emailAddress,
<a name="l03615"></a>03615           defaultPriority: $date.NOW(),
<a name="l03616"></a>03616 
<a name="l03617"></a>03617           type: <span class="stringliteral">&#39;activesync&#39;</span>,
<a name="l03618"></a>03618           syncRange: <span class="stringliteral">&#39;auto&#39;</span>,
<a name="l03619"></a>03619 
<a name="l03620"></a>03620           syncInterval: userDetails.syncInterval || 0,
<a name="l03621"></a>03621           notifyOnNew: userDetails.hasOwnProperty(<span class="stringliteral">&#39;notifyOnNew&#39;</span>) ?
<a name="l03622"></a>03622                        userDetails.notifyOnNew : <span class="keyword">true</span>,
<a name="l03623"></a>03623 
<a name="l03624"></a>03624           credentials: credentials,
<a name="l03625"></a>03625           connInfo: {
<a name="l03626"></a>03626             <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a>: domainInfo.incoming.server
<a name="l03627"></a>03627           },
<a name="l03628"></a>03628 
<a name="l03629"></a>03629           identities: [
<a name="l03630"></a>03630             {
<a name="l03631"></a>03631               <span class="keywordtype">id</span>: accountId + <span class="charliteral">&#39;/&#39;</span> +
<a name="l03632"></a>03632                   $a64.encodeInt(universe.config.nextIdentityNum++),
<a name="l03633"></a>03633               <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: userDetails.displayName || domainInfo.displayName,
<a name="l03634"></a>03634               <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: userDetails.emailAddress,
<a name="l03635"></a>03635               replyTo: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03636"></a>03636               signature: null
<a name="l03637"></a>03637             },
<a name="l03638"></a>03638           ]
<a name="l03639"></a>03639         };
<a name="l03640"></a>03640 
<a name="l03641"></a>03641         <span class="keyword">self</span>._loadAccount(universe, accountDef, conn, <span class="keyword">function</span> (account) {
<a name="l03642"></a>03642           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null, account, null);
<a name="l03643"></a>03643         });
<a name="l03644"></a>03644       });
<a name="l03645"></a>03645     }.bind(<span class="keyword">this</span>));
<a name="l03646"></a>03646   },
<a name="l03647"></a>03647 
<a name="l03648"></a>03648   recreateAccount: <span class="keyword">function</span> cfg_as_ra(universe, oldVersion, oldAccountInfo,
<a name="l03649"></a>03649                                       callback) {
<a name="l03650"></a>03650     var oldAccountDef = oldAccountInfo.def;
<a name="l03651"></a>03651     var credentials = {
<a name="l03652"></a>03652       username: oldAccountDef.credentials.username,
<a name="l03653"></a>03653       password: oldAccountDef.credentials.password,
<a name="l03654"></a>03654     };
<a name="l03655"></a>03655     var accountId = $a64.encodeInt(universe.config.nextAccountNum++);
<a name="l03656"></a>03656     var accountDef = {
<a name="l03657"></a>03657       <span class="keywordtype">id</span>: accountId,
<a name="l03658"></a>03658       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: oldAccountDef.name,
<a name="l03659"></a>03659 
<a name="l03660"></a>03660       type: <span class="stringliteral">&#39;activesync&#39;</span>,
<a name="l03661"></a>03661       syncRange: oldAccountDef.syncRange,
<a name="l03662"></a>03662       syncInterval: oldAccountDef.syncInterval || 0,
<a name="l03663"></a>03663       notifyOnNew: oldAccountDef.hasOwnProperty(<span class="stringliteral">&#39;notifyOnNew&#39;</span>) ?
<a name="l03664"></a>03664                    oldAccountDef.notifyOnNew : <span class="keyword">true</span>,
<a name="l03665"></a>03665 
<a name="l03666"></a>03666       credentials: credentials,
<a name="l03667"></a>03667       connInfo: {
<a name="l03668"></a>03668         <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a>: oldAccountDef.connInfo.server
<a name="l03669"></a>03669       },
<a name="l03670"></a>03670 
<a name="l03671"></a>03671       identities: $accountcommon.recreateIdentities(universe, accountId,
<a name="l03672"></a>03672                                      oldAccountDef.identities)
<a name="l03673"></a>03673     };
<a name="l03674"></a>03674 
<a name="l03675"></a>03675     this._loadAccount(universe, accountDef, null, <span class="keyword">function</span> (account) {
<a name="l03676"></a>03676       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(null, account, null);
<a name="l03677"></a>03677     });
<a name="l03678"></a>03678   },
<a name="l03679"></a>03679 
<a name="l03684"></a>03684   _loadAccount: <span class="keyword">function</span> cfg_as__loadAccount(universe, accountDef,
<a name="l03685"></a>03685                                              protoConn, callback) {
<a name="l03686"></a>03686     <span class="comment">// XXX: Just reload the old folders when applicable instead of syncing the</span>
<a name="l03687"></a>03687     <span class="comment">// folder list again, which is slow.</span>
<a name="l03688"></a>03688     var folderInfo = {
<a name="l03689"></a>03689       $meta: {
<a name="l03690"></a>03690         nextFolderNum: 0,
<a name="l03691"></a>03691         nextMutationNum: 0,
<a name="l03692"></a>03692         lastFolderSyncAt: 0,
<a name="l03693"></a>03693         syncKey: <span class="charliteral">&#39;0&#39;</span>,
<a name="l03694"></a>03694       },
<a name="l03695"></a>03695       $mutations: [],
<a name="l03696"></a>03696       $mutationState: {},
<a name="l03697"></a>03697     };
<a name="l03698"></a>03698     universe.saveAccountDef(accountDef, folderInfo);
<a name="l03699"></a>03699     universe._loadAccount(accountDef, folderInfo, protoConn, callback);
<a name="l03700"></a>03700   },
<a name="l03701"></a>03701 };
<a name="l03702"></a>03702 
<a name="l03703"></a>03703 }); <span class="comment">// end define</span>
<a name="l03704"></a>03704 ;
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../de/d81/build__stage_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html">configurator.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:51:46に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
