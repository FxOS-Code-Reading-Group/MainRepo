<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: worker-bootstrap.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">worker-bootstrap.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00007"></a>00007 <span class="comment">//Going sloppy to avoid &#39;use strict&#39; string cost, but strict practices should</span>
<a name="l00008"></a>00008 <span class="comment">//be followed.</span>
<a name="l00009"></a>00009 <span class="comment">/*jslint sloppy: true, nomen: true, regexp: true */</span>
<a name="l00010"></a>00010 <span class="comment">/*global setTimeout, process, document, navigator, importScripts */</span>
<a name="l00011"></a>00011 
<a name="l00012"></a><a class="code" href="../../de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a44c2a92e377407b0af593e79fa27596f">00012</a> var <a class="code" href="../../d9/d2e/alameda_8js.html#a44c2a92e377407b0af593e79fa27596f">requirejs</a>, <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>;
<a name="l00013"></a><a class="code" href="../../de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a57efe929cc6b44042891d05e15cec785">00013</a> (<span class="keyword">function</span> (<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a5363025b2c2d773292f0f064aeb11f9e">global</a>, <a class="code" href="../../d6/da5/libpinyin_8js.html#a15c298ba1ef694b2dfafb07508cb8645">undef</a>) {
<a name="l00014"></a>00014     var prim, topReq, dataMain,
<a name="l00015"></a>00015         bootstrapConfig = <a class="code" href="../../d9/d2e/alameda_8js.html#a44c2a92e377407b0af593e79fa27596f">requirejs</a> || <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l00016"></a>00016         hasOwn = Object.prototype.hasOwnProperty,
<a name="l00017"></a>00017         contexts = {},
<a name="l00018"></a>00018         queue = [],
<a name="l00019"></a>00019         currDirRegExp = /^\.\<span class="comment">//,</span>
<a name="l00020"></a>00020         urlRegExp = /^\/|\:|\?|\.js$/,
<a name="l00021"></a>00021         commentRegExp = /(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg,
<a name="l00022"></a>00022         cjsRequireRegExp = /[^.]\s*require\s*\(\s*[<span class="stringliteral">&quot;&#39;]([^&#39;&quot;</span>\s]+)[<span class="stringliteral">&quot;&#39;]\s*\)/g,</span>
<a name="l00023"></a>00023 <span class="stringliteral">        jsSuffixRegExp = /\.js$/;</span>
<a name="l00024"></a>00024 <span class="stringliteral"></span>
<a name="l00025"></a>00025 <span class="stringliteral">    if (typeof requirejs === &#39;function&#39;) {</span>
<a name="l00026"></a>00026 <span class="stringliteral">        return;</span>
<a name="l00027"></a>00027 <span class="stringliteral">    }</span>
<a name="l00028"></a>00028 <span class="stringliteral"></span>
<a name="l00029"></a>00029 <span class="stringliteral">    function hasProp(obj, prop) {</span>
<a name="l00030"></a>00030 <span class="stringliteral">        return hasOwn.call(obj, prop);</span>
<a name="l00031"></a>00031 <span class="stringliteral">    }</span>
<a name="l00032"></a>00032 <span class="stringliteral"></span>
<a name="l00033"></a>00033 <span class="stringliteral">    function getOwn(obj, prop) {</span>
<a name="l00034"></a>00034 <span class="stringliteral">        return obj &amp;&amp; hasProp(obj, prop) &amp;&amp; obj[prop];</span>
<a name="l00035"></a>00035 <span class="stringliteral">    }</span>
<a name="l00036"></a>00036 <span class="stringliteral"></span>
<a name="l00042"></a>00042 <span class="stringliteral">    function eachProp(obj, func) {</span>
<a name="l00043"></a>00043 <span class="stringliteral">        var prop;</span>
<a name="l00044"></a>00044 <span class="stringliteral">        for (prop in obj) {</span>
<a name="l00045"></a>00045 <span class="stringliteral">            if (hasProp(obj, prop)) {</span>
<a name="l00046"></a>00046 <span class="stringliteral">                if (func(obj[prop], prop)) {</span>
<a name="l00047"></a>00047 <span class="stringliteral">                    break;</span>
<a name="l00048"></a>00048 <span class="stringliteral">                }</span>
<a name="l00049"></a>00049 <span class="stringliteral">            }</span>
<a name="l00050"></a>00050 <span class="stringliteral">        }</span>
<a name="l00051"></a>00051 <span class="stringliteral">    }</span>
<a name="l00052"></a>00052 <span class="stringliteral"></span>
<a name="l00057"></a>00057 <span class="stringliteral">    function mixin(target, source, force, deepStringMixin) {</span>
<a name="l00058"></a>00058 <span class="stringliteral">        if (source) {</span>
<a name="l00059"></a>00059 <span class="stringliteral">            eachProp(source, function (value, prop) {</span>
<a name="l00060"></a>00060 <span class="stringliteral">                if (force || !hasProp(target, prop)) {</span>
<a name="l00061"></a>00061 <span class="stringliteral">                    if (deepStringMixin &amp;&amp; typeof value !== &#39;string&#39;) {</span>
<a name="l00062"></a>00062 <span class="stringliteral">                        if (!target[prop]) {</span>
<a name="l00063"></a>00063 <span class="stringliteral">                            target[prop] = {};</span>
<a name="l00064"></a>00064 <span class="stringliteral">                        }</span>
<a name="l00065"></a>00065 <span class="stringliteral">                        mixin(target[prop], value, force, deepStringMixin);</span>
<a name="l00066"></a>00066 <span class="stringliteral">                    } else {</span>
<a name="l00067"></a>00067 <span class="stringliteral">                        target[prop] = value;</span>
<a name="l00068"></a>00068 <span class="stringliteral">                    }</span>
<a name="l00069"></a>00069 <span class="stringliteral">                }</span>
<a name="l00070"></a>00070 <span class="stringliteral">            });</span>
<a name="l00071"></a>00071 <span class="stringliteral">        }</span>
<a name="l00072"></a>00072 <span class="stringliteral">        return target;</span>
<a name="l00073"></a>00073 <span class="stringliteral">    }</span>
<a name="l00074"></a>00074 <span class="stringliteral"></span>
<a name="l00075"></a>00075 <span class="stringliteral">    //Allow getting a global that expressed in</span>
<a name="l00076"></a>00076 <span class="stringliteral">    //dot notation, like &#39;a.b.c&#39;.</span>
<a name="l00077"></a>00077 <span class="stringliteral">    function getGlobal(value) {</span>
<a name="l00078"></a>00078 <span class="stringliteral">        if (!value) {</span>
<a name="l00079"></a>00079 <span class="stringliteral">            return value;</span>
<a name="l00080"></a>00080 <span class="stringliteral">        }</span>
<a name="l00081"></a>00081 <span class="stringliteral">        var g = global;</span>
<a name="l00082"></a>00082 <span class="stringliteral">        value.split(&#39;.&#39;).forEach(function (part) {</span>
<a name="l00083"></a>00083 <span class="stringliteral">            g = g[part];</span>
<a name="l00084"></a>00084 <span class="stringliteral">        });</span>
<a name="l00085"></a>00085 <span class="stringliteral">        return g;</span>
<a name="l00086"></a>00086 <span class="stringliteral">    }</span>
<a name="l00087"></a>00087 <span class="stringliteral"></span>
<a name="l00088"></a>00088 <span class="stringliteral">    //START prim</span>
<a name="l00102"></a>00102 <span class="stringliteral">    /*global setImmediate, process, setTimeout */</span>
<a name="l00103"></a>00103 <span class="stringliteral">    (function () {</span>
<a name="l00104"></a>00104 <span class="stringliteral">        </span>
<a name="l00105"></a>00105 <span class="stringliteral">        var waitingId,</span>
<a name="l00106"></a>00106 <span class="stringliteral">            waiting = [];</span>
<a name="l00107"></a>00107 <span class="stringliteral"></span>
<a name="l00108"></a>00108 <span class="stringliteral">        function check(p) {</span>
<a name="l00109"></a>00109 <span class="stringliteral">            if (hasProp(p, &#39;e&#39;) || hasProp(p, &#39;v&#39;)) {</span>
<a name="l00110"></a>00110 <span class="stringliteral">                throw new Error(&#39;nope&#39;);</span>
<a name="l00111"></a>00111 <span class="stringliteral">            }</span>
<a name="l00112"></a>00112 <span class="stringliteral">            return true;</span>
<a name="l00113"></a>00113 <span class="stringliteral">        }</span>
<a name="l00114"></a>00114 <span class="stringliteral"></span>
<a name="l00115"></a>00115 <span class="stringliteral">        function callWaiting() {</span>
<a name="l00116"></a>00116 <span class="stringliteral">            waitingId = 0;</span>
<a name="l00117"></a>00117 <span class="stringliteral">            var w = waiting;</span>
<a name="l00118"></a>00118 <span class="stringliteral">            waiting = [];</span>
<a name="l00119"></a>00119 <span class="stringliteral">            while (w.length) {</span>
<a name="l00120"></a>00120 <span class="stringliteral">                w.shift()();</span>
<a name="l00121"></a>00121 <span class="stringliteral">            }</span>
<a name="l00122"></a>00122 <span class="stringliteral">        }</span>
<a name="l00123"></a>00123 <span class="stringliteral"></span>
<a name="l00124"></a>00124 <span class="stringliteral">        function asyncTick(fn) {</span>
<a name="l00125"></a>00125 <span class="stringliteral">            waiting.push(fn);</span>
<a name="l00126"></a>00126 <span class="stringliteral">            if (!waitingId) {</span>
<a name="l00127"></a>00127 <span class="stringliteral">                waitingId = setTimeout(callWaiting, 0);</span>
<a name="l00128"></a>00128 <span class="stringliteral">            }</span>
<a name="l00129"></a>00129 <span class="stringliteral">        }</span>
<a name="l00130"></a>00130 <span class="stringliteral"></span>
<a name="l00131"></a>00131 <span class="stringliteral">        function notify(ary, value) {</span>
<a name="l00132"></a>00132 <span class="stringliteral">            prim.nextTick(function () {</span>
<a name="l00133"></a>00133 <span class="stringliteral">                ary.forEach(function (item) {</span>
<a name="l00134"></a>00134 <span class="stringliteral">                    item(value);</span>
<a name="l00135"></a>00135 <span class="stringliteral">                });</span>
<a name="l00136"></a>00136 <span class="stringliteral">            });</span>
<a name="l00137"></a>00137 <span class="stringliteral">        }</span>
<a name="l00138"></a>00138 <span class="stringliteral"></span>
<a name="l00139"></a>00139 <span class="stringliteral">        prim = function prim() {</span>
<a name="l00140"></a>00140 <span class="stringliteral">            var p,</span>
<a name="l00141"></a>00141 <span class="stringliteral">                ok = [],</span>
<a name="l00142"></a>00142 <span class="stringliteral">                fail = [];</span>
<a name="l00143"></a>00143 <span class="stringliteral"></span>
<a name="l00144"></a>00144 <span class="stringliteral">            return (p = {</span>
<a name="l00145"></a>00145 <span class="stringliteral">                callback: function (yes, no) {</span>
<a name="l00146"></a>00146 <span class="stringliteral">                    if (no) {</span>
<a name="l00147"></a>00147 <span class="stringliteral">                        p.errback(no);</span>
<a name="l00148"></a>00148 <span class="stringliteral">                    }</span>
<a name="l00149"></a>00149 <span class="stringliteral"></span>
<a name="l00150"></a>00150 <span class="stringliteral">                    if (hasProp(p, &#39;v&#39;)) {</span>
<a name="l00151"></a>00151 <span class="stringliteral">                        prim.nextTick(function () {</span>
<a name="l00152"></a>00152 <span class="stringliteral">                            yes(p.v);</span>
<a name="l00153"></a>00153 <span class="stringliteral">                        });</span>
<a name="l00154"></a>00154 <span class="stringliteral">                    } else {</span>
<a name="l00155"></a>00155 <span class="stringliteral">                        ok.push(yes);</span>
<a name="l00156"></a>00156 <span class="stringliteral">                    }</span>
<a name="l00157"></a>00157 <span class="stringliteral">                },</span>
<a name="l00158"></a>00158 <span class="stringliteral"></span>
<a name="l00159"></a>00159 <span class="stringliteral">                errback: function (no) {</span>
<a name="l00160"></a>00160 <span class="stringliteral">                    if (hasProp(p, &#39;e&#39;)) {</span>
<a name="l00161"></a>00161 <span class="stringliteral">                        prim.nextTick(function () {</span>
<a name="l00162"></a>00162 <span class="stringliteral">                            no(p.e);</span>
<a name="l00163"></a>00163 <span class="stringliteral">                        });</span>
<a name="l00164"></a>00164 <span class="stringliteral">                    } else {</span>
<a name="l00165"></a>00165 <span class="stringliteral">                        fail.push(no);</span>
<a name="l00166"></a>00166 <span class="stringliteral">                    }</span>
<a name="l00167"></a>00167 <span class="stringliteral">                },</span>
<a name="l00168"></a>00168 <span class="stringliteral"></span>
<a name="l00169"></a>00169 <span class="stringliteral">                finished: function () {</span>
<a name="l00170"></a>00170 <span class="stringliteral">                    return hasProp(p, &#39;e&#39;) || hasProp(p, &#39;v&#39;);</span>
<a name="l00171"></a>00171 <span class="stringliteral">                },</span>
<a name="l00172"></a>00172 <span class="stringliteral"></span>
<a name="l00173"></a>00173 <span class="stringliteral">                rejected: function () {</span>
<a name="l00174"></a>00174 <span class="stringliteral">                    return hasProp(p, &#39;e&#39;);</span>
<a name="l00175"></a>00175 <span class="stringliteral">                },</span>
<a name="l00176"></a>00176 <span class="stringliteral"></span>
<a name="l00177"></a>00177 <span class="stringliteral">                resolve: function (v) {</span>
<a name="l00178"></a>00178 <span class="stringliteral">                    if (check(p)) {</span>
<a name="l00179"></a>00179 <span class="stringliteral">                        p.v = v;</span>
<a name="l00180"></a>00180 <span class="stringliteral">                        notify(ok, v);</span>
<a name="l00181"></a>00181 <span class="stringliteral">                    }</span>
<a name="l00182"></a>00182 <span class="stringliteral">                    return p;</span>
<a name="l00183"></a>00183 <span class="stringliteral">                },</span>
<a name="l00184"></a>00184 <span class="stringliteral">                reject: function (e) {</span>
<a name="l00185"></a>00185 <span class="stringliteral">                    if (check(p)) {</span>
<a name="l00186"></a>00186 <span class="stringliteral">                        p.e = e;</span>
<a name="l00187"></a>00187 <span class="stringliteral">                        notify(fail, e);</span>
<a name="l00188"></a>00188 <span class="stringliteral">                    }</span>
<a name="l00189"></a>00189 <span class="stringliteral">                    return p;</span>
<a name="l00190"></a>00190 <span class="stringliteral">                },</span>
<a name="l00191"></a>00191 <span class="stringliteral"></span>
<a name="l00192"></a>00192 <span class="stringliteral">                start: function (fn) {</span>
<a name="l00193"></a>00193 <span class="stringliteral">                    p.resolve();</span>
<a name="l00194"></a>00194 <span class="stringliteral">                    return p.promise.then(fn);</span>
<a name="l00195"></a>00195 <span class="stringliteral">                },</span>
<a name="l00196"></a>00196 <span class="stringliteral"></span>
<a name="l00197"></a>00197 <span class="stringliteral">                promise: {</span>
<a name="l00198"></a>00198 <span class="stringliteral">                    then: function (yes, no) {</span>
<a name="l00199"></a>00199 <span class="stringliteral">                        var next = prim();</span>
<a name="l00200"></a>00200 <span class="stringliteral"></span>
<a name="l00201"></a>00201 <span class="stringliteral">                        p.callback(function (v) {</span>
<a name="l00202"></a>00202 <span class="stringliteral">                            try {</span>
<a name="l00203"></a>00203 <span class="stringliteral">                                if (yes &amp;&amp; typeof yes === &#39;function&#39;) {</span>
<a name="l00204"></a>00204 <span class="stringliteral">                                    v = yes(v);</span>
<a name="l00205"></a>00205 <span class="stringliteral">                                }</span>
<a name="l00206"></a>00206 <span class="stringliteral"></span>
<a name="l00207"></a>00207 <span class="stringliteral">                                if (v &amp;&amp; typeof v.then === &#39;function&#39;) {</span>
<a name="l00208"></a>00208 <span class="stringliteral">                                    v.then(next.resolve, next.reject);</span>
<a name="l00209"></a>00209 <span class="stringliteral">                                } else {</span>
<a name="l00210"></a>00210 <span class="stringliteral">                                    next.resolve(v);</span>
<a name="l00211"></a>00211 <span class="stringliteral">                                }</span>
<a name="l00212"></a>00212 <span class="stringliteral">                            } catch (e) {</span>
<a name="l00213"></a>00213 <span class="stringliteral">                                next.reject(e);</span>
<a name="l00214"></a>00214 <span class="stringliteral">                            }</span>
<a name="l00215"></a>00215 <span class="stringliteral">                        }, function (e) {</span>
<a name="l00216"></a>00216 <span class="stringliteral">                            var err;</span>
<a name="l00217"></a>00217 <span class="stringliteral"></span>
<a name="l00218"></a>00218 <span class="stringliteral">                            try {</span>
<a name="l00219"></a>00219 <span class="stringliteral">                                if (!no || typeof no !== &#39;function&#39;) {</span>
<a name="l00220"></a>00220 <span class="stringliteral">                                    next.reject(e);</span>
<a name="l00221"></a>00221 <span class="stringliteral">                                } else {</span>
<a name="l00222"></a>00222 <span class="stringliteral">                                    err = no(e);</span>
<a name="l00223"></a>00223 <span class="stringliteral"></span>
<a name="l00224"></a>00224 <span class="stringliteral">                                    if (err &amp;&amp; typeof err.then === &#39;function&#39;) {</span>
<a name="l00225"></a>00225 <span class="stringliteral">                                        err.then(next.resolve, next.reject);</span>
<a name="l00226"></a>00226 <span class="stringliteral">                                    } else {</span>
<a name="l00227"></a>00227 <span class="stringliteral">                                        next.resolve(err);</span>
<a name="l00228"></a>00228 <span class="stringliteral">                                    }</span>
<a name="l00229"></a>00229 <span class="stringliteral">                                }</span>
<a name="l00230"></a>00230 <span class="stringliteral">                            } catch (e2) {</span>
<a name="l00231"></a>00231 <span class="stringliteral">                                next.reject(e2);</span>
<a name="l00232"></a>00232 <span class="stringliteral">                            }</span>
<a name="l00233"></a>00233 <span class="stringliteral">                        });</span>
<a name="l00234"></a>00234 <span class="stringliteral"></span>
<a name="l00235"></a>00235 <span class="stringliteral">                        return next.promise;</span>
<a name="l00236"></a>00236 <span class="stringliteral">                    },</span>
<a name="l00237"></a>00237 <span class="stringliteral"></span>
<a name="l00238"></a>00238 <span class="stringliteral">                    fail: function (no) {</span>
<a name="l00239"></a>00239 <span class="stringliteral">                        return p.promise.then(null, no);</span>
<a name="l00240"></a>00240 <span class="stringliteral">                    },</span>
<a name="l00241"></a>00241 <span class="stringliteral"></span>
<a name="l00242"></a>00242 <span class="stringliteral">                    end: function () {</span>
<a name="l00243"></a>00243 <span class="stringliteral">                        p.errback(function (e) {</span>
<a name="l00244"></a>00244 <span class="stringliteral">                            throw e;</span>
<a name="l00245"></a>00245 <span class="stringliteral">                        });</span>
<a name="l00246"></a>00246 <span class="stringliteral">                    }</span>
<a name="l00247"></a>00247 <span class="stringliteral">                }</span>
<a name="l00248"></a>00248 <span class="stringliteral">            });</span>
<a name="l00249"></a>00249 <span class="stringliteral">        };</span>
<a name="l00250"></a>00250 <span class="stringliteral"></span>
<a name="l00251"></a>00251 <span class="stringliteral">        prim.serial = function (ary) {</span>
<a name="l00252"></a>00252 <span class="stringliteral">            var result = prim().resolve().promise;</span>
<a name="l00253"></a>00253 <span class="stringliteral">            ary.forEach(function (item) {</span>
<a name="l00254"></a>00254 <span class="stringliteral">                result = result.then(function () {</span>
<a name="l00255"></a>00255 <span class="stringliteral">                    return item();</span>
<a name="l00256"></a>00256 <span class="stringliteral">                });</span>
<a name="l00257"></a>00257 <span class="stringliteral">            });</span>
<a name="l00258"></a>00258 <span class="stringliteral">            return result;</span>
<a name="l00259"></a>00259 <span class="stringliteral">        };</span>
<a name="l00260"></a>00260 <span class="stringliteral"></span>
<a name="l00261"></a>00261 <span class="stringliteral">        prim.nextTick = typeof setImmediate === &#39;function&#39; ? setImmediate :</span>
<a name="l00262"></a>00262 <span class="stringliteral">            (typeof process !== &#39;undefined&#39; &amp;&amp; process.nextTick ?</span>
<a name="l00263"></a>00263 <span class="stringliteral">                process.nextTick : (typeof setTimeout !== &#39;undefined&#39; ?</span>
<a name="l00264"></a>00264 <span class="stringliteral">                    asyncTick : function (fn) {</span>
<a name="l00265"></a>00265 <span class="stringliteral">            fn();</span>
<a name="l00266"></a>00266 <span class="stringliteral">        }));</span>
<a name="l00267"></a>00267 <span class="stringliteral">    }());</span>
<a name="l00268"></a>00268 <span class="stringliteral">    //END prim</span>
<a name="l00269"></a>00269 <span class="stringliteral"></span>
<a name="l00270"></a>00270 <span class="stringliteral">    function newContext(contextName) {</span>
<a name="l00271"></a>00271 <span class="stringliteral">        var req, main, makeMap, callDep, handlers, loadTimeId, load, context,</span>
<a name="l00272"></a>00272 <span class="stringliteral">            defined = {},</span>
<a name="l00273"></a>00273 <span class="stringliteral">            waiting = {},</span>
<a name="l00274"></a>00274 <span class="stringliteral">            config = {</span>
<a name="l00275"></a>00275 <span class="stringliteral">                //Defaults. Do not set a default for map</span>
<a name="l00276"></a>00276 <span class="stringliteral">                //config to speed up normalize(), which</span>
<a name="l00277"></a>00277 <span class="stringliteral">                //will run faster if there is no default.</span>
<a name="l00278"></a>00278 <span class="stringliteral">                waitSeconds: 7,</span>
<a name="l00279"></a>00279 <span class="stringliteral">                baseUrl: &#39;./&#39;,</span>
<a name="l00280"></a>00280 <span class="stringliteral">                paths: {},</span>
<a name="l00281"></a>00281 <span class="stringliteral">                pkgs: {},</span>
<a name="l00282"></a>00282 <span class="stringliteral">                shim: {},</span>
<a name="l00283"></a>00283 <span class="stringliteral">                config: {}</span>
<a name="l00284"></a>00284 <span class="stringliteral">            },</span>
<a name="l00285"></a>00285 <span class="stringliteral">            requireDeferreds = [],</span>
<a name="l00286"></a>00286 <span class="stringliteral">            deferreds = {},</span>
<a name="l00287"></a>00287 <span class="stringliteral">            calledDefine = {},</span>
<a name="l00288"></a>00288 <span class="stringliteral">            calledPlugin = {},</span>
<a name="l00289"></a>00289 <span class="stringliteral">            loadCount = 0,</span>
<a name="l00290"></a>00290 <span class="stringliteral">            startTime = (new Date()).getTime(),</span>
<a name="l00291"></a>00291 <span class="stringliteral">            errCount = 0,</span>
<a name="l00292"></a>00292 <span class="stringliteral">            trackedErrors = {},</span>
<a name="l00293"></a>00293 <span class="stringliteral">            urlFetched = {};</span>
<a name="l00294"></a>00294 <span class="stringliteral"></span>
<a name="l00304"></a>00304 <span class="stringliteral">        function trimDots(ary) {</span>
<a name="l00305"></a>00305 <span class="stringliteral">            var i, part;</span>
<a name="l00306"></a>00306 <span class="stringliteral">            for (i = 0; ary[i]; i += 1) {</span>
<a name="l00307"></a>00307 <span class="stringliteral">                part = ary[i];</span>
<a name="l00308"></a>00308 <span class="stringliteral">                if (part === &#39;.&#39;) {</span>
<a name="l00309"></a>00309 <span class="stringliteral">                    ary.splice(i, 1);</span>
<a name="l00310"></a>00310 <span class="stringliteral">                    i -= 1;</span>
<a name="l00311"></a>00311 <span class="stringliteral">                } else if (part === &#39;..&#39;) {</span>
<a name="l00312"></a>00312 <span class="stringliteral">                    if (i === 1 &amp;&amp; (ary[2] === &#39;..&#39; || ary[0] === &#39;..&#39;)) {</span>
<a name="l00313"></a>00313 <span class="stringliteral">                        //End of the line. Keep at least one non-dot</span>
<a name="l00314"></a>00314 <span class="stringliteral">                        //path segment at the front so it can be mapped</span>
<a name="l00315"></a>00315 <span class="stringliteral">                        //correctly to disk. Otherwise, there is likely</span>
<a name="l00316"></a>00316 <span class="stringliteral">                        //no path mapping for a path starting with &#39;..&#39;.</span>
<a name="l00317"></a>00317 <span class="stringliteral">                        //This can still fail, but catches the most reasonable</span>
<a name="l00318"></a>00318 <span class="stringliteral">                        //uses of ..</span>
<a name="l00319"></a>00319 <span class="stringliteral">                        break;</span>
<a name="l00320"></a>00320 <span class="stringliteral">                    } else if (i &gt; 0) {</span>
<a name="l00321"></a>00321 <span class="stringliteral">                        ary.splice(i - 1, 2);</span>
<a name="l00322"></a>00322 <span class="stringliteral">                        i -= 2;</span>
<a name="l00323"></a>00323 <span class="stringliteral">                    }</span>
<a name="l00324"></a>00324 <span class="stringliteral">                }</span>
<a name="l00325"></a>00325 <span class="stringliteral">            }</span>
<a name="l00326"></a>00326 <span class="stringliteral">        }</span>
<a name="l00327"></a>00327 <span class="stringliteral"></span>
<a name="l00338"></a>00338 <span class="stringliteral">        function normalize(name, baseName, applyMap) {</span>
<a name="l00339"></a>00339 <span class="stringliteral">            var pkgName, pkgConfig, mapValue, nameParts, i, j, nameSegment,</span>
<a name="l00340"></a>00340 <span class="stringliteral">                foundMap, foundI, foundStarMap, starI,</span>
<a name="l00341"></a>00341 <span class="stringliteral">                baseParts = baseName &amp;&amp; baseName.split(&#39;/&#39;),</span>
<a name="l00342"></a>00342 <span class="stringliteral">                normalizedBaseParts = baseParts,</span>
<a name="l00343"></a>00343 <span class="stringliteral">                map = applyMap &amp;&amp; config.map,</span>
<a name="l00344"></a>00344 <span class="stringliteral">                starMap = map &amp;&amp; map[&#39;*&#39;];</span>
<a name="l00345"></a>00345 <span class="stringliteral"></span>
<a name="l00346"></a>00346 <span class="stringliteral">            //Adjust any relative paths.</span>
<a name="l00347"></a>00347 <span class="stringliteral">            if (name &amp;&amp; name.charAt(0) === &#39;.&#39;) {</span>
<a name="l00348"></a>00348 <span class="stringliteral">                //If have a base name, try to normalize against it,</span>
<a name="l00349"></a>00349 <span class="stringliteral">                //otherwise, assume it is a top-level require that will</span>
<a name="l00350"></a>00350 <span class="stringliteral">                //be relative to baseUrl in the end.</span>
<a name="l00351"></a>00351 <span class="stringliteral">                if (baseName) {</span>
<a name="l00352"></a>00352 <span class="stringliteral">                    if (getOwn(config.pkgs, baseName)) {</span>
<a name="l00353"></a>00353 <span class="stringliteral">                        //If the baseName is a package name, then just treat it as one</span>
<a name="l00354"></a>00354 <span class="stringliteral">                        //name to concat the name with.</span>
<a name="l00355"></a>00355 <span class="stringliteral">                        normalizedBaseParts = baseParts = [baseName];</span>
<a name="l00356"></a>00356 <span class="stringliteral">                    } else {</span>
<a name="l00357"></a>00357 <span class="stringliteral">                        //Convert baseName to array, and lop off the last part,</span>
<a name="l00358"></a>00358 <span class="stringliteral">                        //so that . matches that &#39;directory&#39; and not name of the baseName&#39;s</span>
<a name="l00359"></a>00359 <span class="stringliteral">                        //module. For instance, baseName of &#39;one/two/three&#39;, maps to</span>
<a name="l00360"></a>00360 <span class="stringliteral">                        //&#39;one/two/three.js&#39;, but we want the directory, &#39;one/two&#39; for</span>
<a name="l00361"></a>00361 <span class="stringliteral">                        //this normalization.</span>
<a name="l00362"></a>00362 <span class="stringliteral">                        normalizedBaseParts = baseParts.slice(0, baseParts.length - 1);</span>
<a name="l00363"></a>00363 <span class="stringliteral">                    }</span>
<a name="l00364"></a>00364 <span class="stringliteral"></span>
<a name="l00365"></a>00365 <span class="stringliteral">                    name = normalizedBaseParts.concat(name.split(&#39;/&#39;));</span>
<a name="l00366"></a>00366 <span class="stringliteral">                    trimDots(name);</span>
<a name="l00367"></a>00367 <span class="stringliteral"></span>
<a name="l00368"></a>00368 <span class="stringliteral">                    //Some use of packages may use a . path to reference the</span>
<a name="l00369"></a>00369 <span class="stringliteral">                    //&#39;main&#39; module name, so normalize for that.</span>
<a name="l00370"></a>00370 <span class="stringliteral">                    pkgConfig = getOwn(config.pkgs, (pkgName = name[0]));</span>
<a name="l00371"></a>00371 <span class="stringliteral">                    name = name.join(&#39;/&#39;);</span>
<a name="l00372"></a>00372 <span class="stringliteral">                    if (pkgConfig &amp;&amp; name === pkgName + &#39;/&#39; + pkgConfig.main) {</span>
<a name="l00373"></a>00373 <span class="stringliteral">                        name = pkgName;</span>
<a name="l00374"></a>00374 <span class="stringliteral">                    }</span>
<a name="l00375"></a>00375 <span class="stringliteral">                } else if (name.indexOf(&#39;./&#39;) === 0) {</span>
<a name="l00376"></a>00376 <span class="stringliteral">                    // No baseName, so this is ID is resolved relative</span>
<a name="l00377"></a>00377 <span class="stringliteral">                    // to baseUrl, pull off the leading dot.</span>
<a name="l00378"></a>00378 <span class="stringliteral">                    name = name.substring(2);</span>
<a name="l00379"></a>00379 <span class="stringliteral">                }</span>
<a name="l00380"></a>00380 <span class="stringliteral">            }</span>
<a name="l00381"></a>00381 <span class="stringliteral"></span>
<a name="l00382"></a>00382 <span class="stringliteral">            //Apply map config if available.</span>
<a name="l00383"></a>00383 <span class="stringliteral">            if (applyMap &amp;&amp; (baseParts || starMap) &amp;&amp; map) {</span>
<a name="l00384"></a>00384 <span class="stringliteral">                nameParts = name.split(&#39;/&#39;);</span>
<a name="l00385"></a>00385 <span class="stringliteral"></span>
<a name="l00386"></a>00386 <span class="stringliteral">                for (i = nameParts.length; i &gt; 0; i -= 1) {</span>
<a name="l00387"></a>00387 <span class="stringliteral">                    nameSegment = nameParts.slice(0, i).join(&#39;/&#39;);</span>
<a name="l00388"></a>00388 <span class="stringliteral"></span>
<a name="l00389"></a>00389 <span class="stringliteral">                    if (baseParts) {</span>
<a name="l00390"></a>00390 <span class="stringliteral">                        //Find the longest baseName segment match in the config.</span>
<a name="l00391"></a>00391 <span class="stringliteral">                        //So, do joins on the biggest to smallest lengths of baseParts.</span>
<a name="l00392"></a>00392 <span class="stringliteral">                        for (j = baseParts.length; j &gt; 0; j -= 1) {</span>
<a name="l00393"></a>00393 <span class="stringliteral">                            mapValue = getOwn(map, baseParts.slice(0, j).join(&#39;/&#39;));</span>
<a name="l00394"></a>00394 <span class="stringliteral"></span>
<a name="l00395"></a>00395 <span class="stringliteral">                            //baseName segment has config, find if it has one for</span>
<a name="l00396"></a>00396 <span class="stringliteral">                            //this name.</span>
<a name="l00397"></a>00397 <span class="stringliteral">                            if (mapValue) {</span>
<a name="l00398"></a>00398 <span class="stringliteral">                                mapValue = getOwn(mapValue, nameSegment);</span>
<a name="l00399"></a>00399 <span class="stringliteral">                                if (mapValue) {</span>
<a name="l00400"></a>00400 <span class="stringliteral">                                    //Match, update name to the new value.</span>
<a name="l00401"></a>00401 <span class="stringliteral">                                    foundMap = mapValue;</span>
<a name="l00402"></a>00402 <span class="stringliteral">                                    foundI = i;</span>
<a name="l00403"></a>00403 <span class="stringliteral">                                    break;</span>
<a name="l00404"></a>00404 <span class="stringliteral">                                }</span>
<a name="l00405"></a>00405 <span class="stringliteral">                            }</span>
<a name="l00406"></a>00406 <span class="stringliteral">                        }</span>
<a name="l00407"></a>00407 <span class="stringliteral">                    }</span>
<a name="l00408"></a>00408 <span class="stringliteral"></span>
<a name="l00409"></a>00409 <span class="stringliteral">                    if (foundMap) {</span>
<a name="l00410"></a>00410 <span class="stringliteral">                        break;</span>
<a name="l00411"></a>00411 <span class="stringliteral">                    }</span>
<a name="l00412"></a>00412 <span class="stringliteral"></span>
<a name="l00413"></a>00413 <span class="stringliteral">                    //Check for a star map match, but just hold on to it,</span>
<a name="l00414"></a>00414 <span class="stringliteral">                    //if there is a shorter segment match later in a matching</span>
<a name="l00415"></a>00415 <span class="stringliteral">                    //config, then favor over this star map.</span>
<a name="l00416"></a>00416 <span class="stringliteral">                    if (!foundStarMap &amp;&amp; starMap &amp;&amp; getOwn(starMap, nameSegment)) {</span>
<a name="l00417"></a>00417 <span class="stringliteral">                        foundStarMap = getOwn(starMap, nameSegment);</span>
<a name="l00418"></a>00418 <span class="stringliteral">                        starI = i;</span>
<a name="l00419"></a>00419 <span class="stringliteral">                    }</span>
<a name="l00420"></a>00420 <span class="stringliteral">                }</span>
<a name="l00421"></a>00421 <span class="stringliteral"></span>
<a name="l00422"></a>00422 <span class="stringliteral">                if (!foundMap &amp;&amp; foundStarMap) {</span>
<a name="l00423"></a>00423 <span class="stringliteral">                    foundMap = foundStarMap;</span>
<a name="l00424"></a>00424 <span class="stringliteral">                    foundI = starI;</span>
<a name="l00425"></a>00425 <span class="stringliteral">                }</span>
<a name="l00426"></a>00426 <span class="stringliteral"></span>
<a name="l00427"></a>00427 <span class="stringliteral">                if (foundMap) {</span>
<a name="l00428"></a>00428 <span class="stringliteral">                    nameParts.splice(0, foundI, foundMap);</span>
<a name="l00429"></a>00429 <span class="stringliteral">                    name = nameParts.join(&#39;/&#39;);</span>
<a name="l00430"></a>00430 <span class="stringliteral">                }</span>
<a name="l00431"></a>00431 <span class="stringliteral">            }</span>
<a name="l00432"></a>00432 <span class="stringliteral"></span>
<a name="l00433"></a>00433 <span class="stringliteral">            return name;</span>
<a name="l00434"></a>00434 <span class="stringliteral">        }</span>
<a name="l00435"></a>00435 <span class="stringliteral"></span>
<a name="l00436"></a>00436 <span class="stringliteral"></span>
<a name="l00437"></a>00437 <span class="stringliteral">        function makeShimExports(value) {</span>
<a name="l00438"></a>00438 <span class="stringliteral">            function fn() {</span>
<a name="l00439"></a>00439 <span class="stringliteral">                var ret;</span>
<a name="l00440"></a>00440 <span class="stringliteral">                if (value.init) {</span>
<a name="l00441"></a>00441 <span class="stringliteral">                    ret = value.init.apply(global, arguments);</span>
<a name="l00442"></a>00442 <span class="stringliteral">                }</span>
<a name="l00443"></a>00443 <span class="stringliteral">                return ret || (value.exports &amp;&amp; getGlobal(value.exports));</span>
<a name="l00444"></a>00444 <span class="stringliteral">            }</span>
<a name="l00445"></a>00445 <span class="stringliteral">            return fn;</span>
<a name="l00446"></a>00446 <span class="stringliteral">        }</span>
<a name="l00447"></a>00447 <span class="stringliteral"></span>
<a name="l00448"></a>00448 <span class="stringliteral">        function takeQueue(anonId) {</span>
<a name="l00449"></a>00449 <span class="stringliteral">            var i, id, args, shim;</span>
<a name="l00450"></a>00450 <span class="stringliteral">            for (i = 0; i &lt; queue.length; i += 1) {</span>
<a name="l00451"></a>00451 <span class="stringliteral">                //Peek to see if anon</span>
<a name="l00452"></a>00452 <span class="stringliteral">                if (typeof queue[i][0] !== &#39;string&#39;) {</span>
<a name="l00453"></a>00453 <span class="stringliteral">                    if (anonId) {</span>
<a name="l00454"></a>00454 <span class="stringliteral">                        queue[i].unshift(anonId);</span>
<a name="l00455"></a>00455 <span class="stringliteral">                        anonId = undef;</span>
<a name="l00456"></a>00456 <span class="stringliteral">                    } else {</span>
<a name="l00457"></a>00457 <span class="stringliteral">                        //Not our anon module, stop.</span>
<a name="l00458"></a>00458 <span class="stringliteral">                        break;</span>
<a name="l00459"></a>00459 <span class="stringliteral">                    }</span>
<a name="l00460"></a>00460 <span class="stringliteral">                }</span>
<a name="l00461"></a>00461 <span class="stringliteral">                args = queue.shift();</span>
<a name="l00462"></a>00462 <span class="stringliteral">                id = args[0];</span>
<a name="l00463"></a>00463 <span class="stringliteral">                i -= 1;</span>
<a name="l00464"></a>00464 <span class="stringliteral"></span>
<a name="l00465"></a>00465 <span class="stringliteral">                if (!hasProp(defined, id) &amp;&amp; !hasProp(waiting, id)) {</span>
<a name="l00466"></a>00466 <span class="stringliteral">                    if (hasProp(deferreds, id)) {</span>
<a name="l00467"></a>00467 <span class="stringliteral">                        main.apply(undef, args);</span>
<a name="l00468"></a>00468 <span class="stringliteral">                    } else {</span>
<a name="l00469"></a>00469 <span class="stringliteral">                        waiting[id] = args;</span>
<a name="l00470"></a>00470 <span class="stringliteral">                    }</span>
<a name="l00471"></a>00471 <span class="stringliteral">                }</span>
<a name="l00472"></a>00472 <span class="stringliteral">            }</span>
<a name="l00473"></a>00473 <span class="stringliteral"></span>
<a name="l00474"></a>00474 <span class="stringliteral">            //if get to the end and still have anonId, then could be</span>
<a name="l00475"></a>00475 <span class="stringliteral">            //a shimmed dependency.</span>
<a name="l00476"></a>00476 <span class="stringliteral">            if (anonId) {</span>
<a name="l00477"></a>00477 <span class="stringliteral">                shim = getOwn(config.shim, anonId) || {};</span>
<a name="l00478"></a>00478 <span class="stringliteral">                main(anonId, shim.deps || [], shim.exportsFn);</span>
<a name="l00479"></a>00479 <span class="stringliteral">            }</span>
<a name="l00480"></a>00480 <span class="stringliteral">        }</span>
<a name="l00481"></a>00481 <span class="stringliteral"></span>
<a name="l00482"></a>00482 <span class="stringliteral">        function makeRequire(relName, topLevel) {</span>
<a name="l00483"></a>00483 <span class="stringliteral">            var req = function (deps, callback, errback, alt) {</span>
<a name="l00484"></a>00484 <span class="stringliteral">                var name, cfg;</span>
<a name="l00485"></a>00485 <span class="stringliteral"></span>
<a name="l00486"></a>00486 <span class="stringliteral">                if (topLevel) {</span>
<a name="l00487"></a>00487 <span class="stringliteral">                    takeQueue();</span>
<a name="l00488"></a>00488 <span class="stringliteral">                }</span>
<a name="l00489"></a>00489 <span class="stringliteral"></span>
<a name="l00490"></a>00490 <span class="stringliteral">                if (typeof deps === &quot;</span><span class="keywordtype">string</span><span class="stringliteral">&quot;) {</span>
<a name="l00491"></a>00491 <span class="stringliteral">                    if (handlers[deps]) {</span>
<a name="l00492"></a>00492 <span class="stringliteral">                        return handlers[deps](relName);</span>
<a name="l00493"></a>00493 <span class="stringliteral">                    }</span>
<a name="l00494"></a>00494 <span class="stringliteral">                    //Just return the module wanted. In this scenario, the</span>
<a name="l00495"></a>00495 <span class="stringliteral">                    //deps arg is the module name, and second arg (if passed)</span>
<a name="l00496"></a>00496 <span class="stringliteral">                    //is just the relName.</span>
<a name="l00497"></a>00497 <span class="stringliteral">                    //Normalize module name, if it contains . or ..</span>
<a name="l00498"></a>00498 <span class="stringliteral">                    name = makeMap(deps, relName, true).id;</span>
<a name="l00499"></a>00499 <span class="stringliteral">                    if (!hasProp(defined, name)) {</span>
<a name="l00500"></a>00500 <span class="stringliteral">                        throw new Error(&#39;Not loaded: &#39; + name);</span>
<a name="l00501"></a>00501 <span class="stringliteral">                    }</span>
<a name="l00502"></a>00502 <span class="stringliteral">                    return defined[name];</span>
<a name="l00503"></a>00503 <span class="stringliteral">                } else if (deps &amp;&amp; !Array.isArray(deps)) {</span>
<a name="l00504"></a>00504 <span class="stringliteral">                    //deps is a config object, not an array.</span>
<a name="l00505"></a>00505 <span class="stringliteral">                    cfg = deps;</span>
<a name="l00506"></a>00506 <span class="stringliteral">                    deps = undef;</span>
<a name="l00507"></a>00507 <span class="stringliteral"></span>
<a name="l00508"></a>00508 <span class="stringliteral">                    if (Array.isArray(callback)) {</span>
<a name="l00509"></a>00509 <span class="stringliteral">                        //callback is an array, which means it is a dependency list.</span>
<a name="l00510"></a>00510 <span class="stringliteral">                        //Adjust args if there are dependencies</span>
<a name="l00511"></a>00511 <span class="stringliteral">                        deps = callback;</span>
<a name="l00512"></a>00512 <span class="stringliteral">                        callback = errback;</span>
<a name="l00513"></a>00513 <span class="stringliteral">                        errback = alt;</span>
<a name="l00514"></a>00514 <span class="stringliteral">                    }</span>
<a name="l00515"></a>00515 <span class="stringliteral"></span>
<a name="l00516"></a>00516 <span class="stringliteral">                    if (topLevel) {</span>
<a name="l00517"></a>00517 <span class="stringliteral">                        //Could be a new context, so call returned require</span>
<a name="l00518"></a>00518 <span class="stringliteral">                        return req.config(cfg)(deps, callback, errback);</span>
<a name="l00519"></a>00519 <span class="stringliteral">                    }</span>
<a name="l00520"></a>00520 <span class="stringliteral">                }</span>
<a name="l00521"></a>00521 <span class="stringliteral"></span>
<a name="l00522"></a>00522 <span class="stringliteral">                //Support require([&#39;a&#39;])</span>
<a name="l00523"></a>00523 <span class="stringliteral">                callback = callback || function () {};</span>
<a name="l00524"></a>00524 <span class="stringliteral"></span>
<a name="l00525"></a>00525 <span class="stringliteral">                //Simulate async callback;</span>
<a name="l00526"></a>00526 <span class="stringliteral">                prim.nextTick(function () {</span>
<a name="l00527"></a>00527 <span class="stringliteral">                    //Grab any modules that were defined after a</span>
<a name="l00528"></a>00528 <span class="stringliteral">                    //require call.</span>
<a name="l00529"></a>00529 <span class="stringliteral">                    takeQueue();</span>
<a name="l00530"></a>00530 <span class="stringliteral">                    main(undef, deps || [], callback, errback, relName);</span>
<a name="l00531"></a>00531 <span class="stringliteral">                });</span>
<a name="l00532"></a>00532 <span class="stringliteral"></span>
<a name="l00533"></a>00533 <span class="stringliteral">                return req;</span>
<a name="l00534"></a>00534 <span class="stringliteral">            };</span>
<a name="l00535"></a>00535 <span class="stringliteral"></span>
<a name="l00536"></a>00536 <span class="stringliteral">            req.isBrowser = typeof document !== &#39;undefined&#39; &amp;&amp;</span>
<a name="l00537"></a>00537 <span class="stringliteral">                typeof navigator !== &#39;undefined&#39;;</span>
<a name="l00538"></a>00538 <span class="stringliteral"></span>
<a name="l00539"></a>00539 <span class="stringliteral">            req.nameToUrl = function (moduleName, ext) {</span>
<a name="l00540"></a>00540 <span class="stringliteral">                var paths, pkgs, pkg, pkgPath, syms, i, parentModule, url,</span>
<a name="l00541"></a>00541 <span class="stringliteral">                    parentPath;</span>
<a name="l00542"></a>00542 <span class="stringliteral"></span>
<a name="l00543"></a>00543 <span class="stringliteral">                //If a colon is in the URL, it indicates a protocol is used and it is just</span>
<a name="l00544"></a>00544 <span class="stringliteral">                //an URL to a file, or if it starts with a slash, contains a query arg (i.e. ?)</span>
<a name="l00545"></a>00545 <span class="stringliteral">                //or ends with .js, then assume the user meant to use an url and not a module id.</span>
<a name="l00546"></a>00546 <span class="stringliteral">                //The slash is important for protocol-less URLs as well as full paths.</span>
<a name="l00547"></a>00547 <span class="stringliteral">                if (urlRegExp.test(moduleName)) {</span>
<a name="l00548"></a>00548 <span class="stringliteral">                    //Just a plain path, not module name lookup, so just return it.</span>
<a name="l00549"></a>00549 <span class="stringliteral">                    //Add extension if it is included. This is a bit wonky, only non-.js things pass</span>
<a name="l00550"></a>00550 <span class="stringliteral">                    //an extension, this method probably needs to be reworked.</span>
<a name="l00551"></a>00551 <span class="stringliteral">                    url = moduleName + (ext || &#39;&#39;);</span>
<a name="l00552"></a>00552 <span class="stringliteral">                } else {</span>
<a name="l00553"></a>00553 <span class="stringliteral">                    //A module that needs to be converted to a path.</span>
<a name="l00554"></a>00554 <span class="stringliteral">                    paths = config.paths;</span>
<a name="l00555"></a>00555 <span class="stringliteral">                    pkgs = config.pkgs;</span>
<a name="l00556"></a>00556 <span class="stringliteral"></span>
<a name="l00557"></a>00557 <span class="stringliteral">                    syms = moduleName.split(&#39;/&#39;);</span>
<a name="l00558"></a>00558 <span class="stringliteral">                    //For each module name segment, see if there is a path</span>
<a name="l00559"></a>00559 <span class="stringliteral">                    //registered for it. Start with most specific name</span>
<a name="l00560"></a>00560 <span class="stringliteral">                    //and work up from it.</span>
<a name="l00561"></a>00561 <span class="stringliteral">                    for (i = syms.length; i &gt; 0; i -= 1) {</span>
<a name="l00562"></a>00562 <span class="stringliteral">                        parentModule = syms.slice(0, i).join(&#39;/&#39;);</span>
<a name="l00563"></a>00563 <span class="stringliteral">                        pkg = getOwn(pkgs, parentModule);</span>
<a name="l00564"></a>00564 <span class="stringliteral">                        parentPath = getOwn(paths, parentModule);</span>
<a name="l00565"></a>00565 <span class="stringliteral">                        if (parentPath) {</span>
<a name="l00566"></a>00566 <span class="stringliteral">                            //If an array, it means there are a few choices,</span>
<a name="l00567"></a>00567 <span class="stringliteral">                            //Choose the one that is desired</span>
<a name="l00568"></a>00568 <span class="stringliteral">                            if (Array.isArray(parentPath)) {</span>
<a name="l00569"></a>00569 <span class="stringliteral">                                parentPath = parentPath[0];</span>
<a name="l00570"></a>00570 <span class="stringliteral">                            }</span>
<a name="l00571"></a>00571 <span class="stringliteral">                            syms.splice(0, i, parentPath);</span>
<a name="l00572"></a>00572 <span class="stringliteral">                            break;</span>
<a name="l00573"></a>00573 <span class="stringliteral">                        } else if (pkg) {</span>
<a name="l00574"></a>00574 <span class="stringliteral">                            //If module name is just the package name, then looking</span>
<a name="l00575"></a>00575 <span class="stringliteral">                            //for the main module.</span>
<a name="l00576"></a>00576 <span class="stringliteral">                            if (moduleName === pkg.name) {</span>
<a name="l00577"></a>00577 <span class="stringliteral">                                pkgPath = pkg.location + &#39;/&#39; + pkg.main;</span>
<a name="l00578"></a>00578 <span class="stringliteral">                            } else {</span>
<a name="l00579"></a>00579 <span class="stringliteral">                                pkgPath = pkg.location;</span>
<a name="l00580"></a>00580 <span class="stringliteral">                            }</span>
<a name="l00581"></a>00581 <span class="stringliteral">                            syms.splice(0, i, pkgPath);</span>
<a name="l00582"></a>00582 <span class="stringliteral">                            break;</span>
<a name="l00583"></a>00583 <span class="stringliteral">                        }</span>
<a name="l00584"></a>00584 <span class="stringliteral">                    }</span>
<a name="l00585"></a>00585 <span class="stringliteral"></span>
<a name="l00586"></a>00586 <span class="stringliteral">                    //Join the path parts together, then figure out if baseUrl is needed.</span>
<a name="l00587"></a>00587 <span class="stringliteral">                    url = syms.join(&#39;/&#39;);</span>
<a name="l00588"></a>00588 <span class="stringliteral">                    url += (ext || (/\?/.test(url) ? &#39;&#39; : &#39;.js&#39;));</span>
<a name="l00589"></a>00589 <span class="stringliteral">                    url = (url.charAt(0) === &#39;/&#39; || url.match(/^[\w\+\.\-]+:/) ? &#39;&#39; : config.baseUrl) + url;</span>
<a name="l00590"></a>00590 <span class="stringliteral">                }</span>
<a name="l00591"></a>00591 <span class="stringliteral"></span>
<a name="l00592"></a>00592 <span class="stringliteral">                return config.urlArgs ? url +</span>
<a name="l00593"></a>00593 <span class="stringliteral">                                        ((url.indexOf(&#39;?&#39;) === -1 ? &#39;?&#39; : &#39;&amp;&#39;) +</span>
<a name="l00594"></a>00594 <span class="stringliteral">                                         config.urlArgs) : url;</span>
<a name="l00595"></a>00595 <span class="stringliteral">            };</span>
<a name="l00596"></a>00596 <span class="stringliteral"></span>
<a name="l00602"></a>00602 <span class="stringliteral">            req.toUrl = function (moduleNamePlusExt) {</span>
<a name="l00603"></a>00603 <span class="stringliteral">                var index = moduleNamePlusExt.lastIndexOf(&#39;.&#39;),</span>
<a name="l00604"></a>00604 <span class="stringliteral">                    ext = null;</span>
<a name="l00605"></a>00605 <span class="stringliteral"></span>
<a name="l00606"></a>00606 <span class="stringliteral">                if (index !== -1) {</span>
<a name="l00607"></a>00607 <span class="stringliteral">                    ext = moduleNamePlusExt.substring(index, moduleNamePlusExt.length);</span>
<a name="l00608"></a>00608 <span class="stringliteral">                    moduleNamePlusExt = moduleNamePlusExt.substring(0, index);</span>
<a name="l00609"></a>00609 <span class="stringliteral">                }</span>
<a name="l00610"></a>00610 <span class="stringliteral"></span>
<a name="l00611"></a>00611 <span class="stringliteral">                return req.nameToUrl(normalize(moduleNamePlusExt, relName), ext);</span>
<a name="l00612"></a>00612 <span class="stringliteral">            };</span>
<a name="l00613"></a>00613 <span class="stringliteral"></span>
<a name="l00614"></a>00614 <span class="stringliteral">            req.defined = function (id) {</span>
<a name="l00615"></a>00615 <span class="stringliteral">                return hasProp(defined, makeMap(id, relName, true).id);</span>
<a name="l00616"></a>00616 <span class="stringliteral">            };</span>
<a name="l00617"></a>00617 <span class="stringliteral"></span>
<a name="l00618"></a>00618 <span class="stringliteral">            req.specified = function (id) {</span>
<a name="l00619"></a>00619 <span class="stringliteral">                id = makeMap(id, relName, true).id;</span>
<a name="l00620"></a>00620 <span class="stringliteral">                return hasProp(defined, id) || hasProp(deferreds, id);</span>
<a name="l00621"></a>00621 <span class="stringliteral">            };</span>
<a name="l00622"></a>00622 <span class="stringliteral"></span>
<a name="l00623"></a>00623 <span class="stringliteral">            return req;</span>
<a name="l00624"></a>00624 <span class="stringliteral">        }</span>
<a name="l00625"></a>00625 <span class="stringliteral"></span>
<a name="l00626"></a>00626 <span class="stringliteral">        function resolve(name, d, value) {</span>
<a name="l00627"></a>00627 <span class="stringliteral">            if (name) {</span>
<a name="l00628"></a>00628 <span class="stringliteral">                defined[name] = value;</span>
<a name="l00629"></a>00629 <span class="stringliteral">            }</span>
<a name="l00630"></a>00630 <span class="stringliteral">            d.resolve(value);</span>
<a name="l00631"></a>00631 <span class="stringliteral">        }</span>
<a name="l00632"></a>00632 <span class="stringliteral"></span>
<a name="l00633"></a>00633 <span class="stringliteral">        function makeNormalize(relName) {</span>
<a name="l00634"></a>00634 <span class="stringliteral">            return function (name) {</span>
<a name="l00635"></a>00635 <span class="stringliteral">                return normalize(name, relName, true);</span>
<a name="l00636"></a>00636 <span class="stringliteral">            };</span>
<a name="l00637"></a>00637 <span class="stringliteral">        }</span>
<a name="l00638"></a>00638 <span class="stringliteral"></span>
<a name="l00639"></a>00639 <span class="stringliteral">        function defineModule(d) {</span>
<a name="l00640"></a>00640 <span class="stringliteral">            var name = d.map.id,</span>
<a name="l00641"></a>00641 <span class="stringliteral">                ret = d.factory.apply(defined[name], d.values);</span>
<a name="l00642"></a>00642 <span class="stringliteral"></span>
<a name="l00643"></a>00643 <span class="stringliteral">            if (name) {</span>
<a name="l00644"></a>00644 <span class="stringliteral">                //If setting exports via &quot;</span><a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a><span class="stringliteral">&quot; is in play,</span>
<a name="l00645"></a>00645 <span class="stringliteral">                //favor that over return value and exports.</span>
<a name="l00646"></a>00646 <span class="stringliteral">                //After that, favor a non-undefined return</span>
<a name="l00647"></a>00647 <span class="stringliteral">                //value over exports use.</span>
<a name="l00648"></a>00648 <span class="stringliteral">                if (d.cjsModule &amp;&amp; d.cjsModule.exports !== undef &amp;&amp;</span>
<a name="l00649"></a>00649 <span class="stringliteral">                        d.cjsModule.exports !== defined[name]) {</span>
<a name="l00650"></a>00650 <span class="stringliteral">                    ret = d.cjsModule.exports;</span>
<a name="l00651"></a>00651 <span class="stringliteral">                } else if (ret === undef &amp;&amp; d.usingExports) {</span>
<a name="l00652"></a>00652 <span class="stringliteral">                    ret = defined[name];</span>
<a name="l00653"></a>00653 <span class="stringliteral">                }</span>
<a name="l00654"></a>00654 <span class="stringliteral">                resolve(name, d, ret);</span>
<a name="l00655"></a>00655 <span class="stringliteral">            } else {</span>
<a name="l00656"></a>00656 <span class="stringliteral">                d.resolve();</span>
<a name="l00657"></a>00657 <span class="stringliteral">            }</span>
<a name="l00658"></a>00658 <span class="stringliteral">        }</span>
<a name="l00659"></a>00659 <span class="stringliteral"></span>
<a name="l00660"></a>00660 <span class="stringliteral">        //This method is attached to every module deferred,</span>
<a name="l00661"></a>00661 <span class="stringliteral">        //so the &quot;</span><span class="keyword">this</span><span class="stringliteral">&quot; in here is the module deferred object.</span>
<a name="l00662"></a>00662 <span class="stringliteral">        function depFinished(val, i) {</span>
<a name="l00663"></a>00663 <span class="stringliteral">            if (!this.rejected() &amp;&amp; !this.depDefined[i]) {</span>
<a name="l00664"></a>00664 <span class="stringliteral">                this.depDefined[i] = true;</span>
<a name="l00665"></a>00665 <span class="stringliteral">                this.depCount += 1;</span>
<a name="l00666"></a>00666 <span class="stringliteral">                this.values[i] = val;</span>
<a name="l00667"></a>00667 <span class="stringliteral">                if (this.depCount === this.depMax) {</span>
<a name="l00668"></a>00668 <span class="stringliteral">                    defineModule(this);</span>
<a name="l00669"></a>00669 <span class="stringliteral">                }</span>
<a name="l00670"></a>00670 <span class="stringliteral">            }</span>
<a name="l00671"></a>00671 <span class="stringliteral">        }</span>
<a name="l00672"></a>00672 <span class="stringliteral"></span>
<a name="l00673"></a>00673 <span class="stringliteral">        function makeDefer(name) {</span>
<a name="l00674"></a>00674 <span class="stringliteral">            var d = prim();</span>
<a name="l00675"></a>00675 <span class="stringliteral">            d.map = name ? makeMap(name, null, true) : {};</span>
<a name="l00676"></a>00676 <span class="stringliteral">            d.depCount = 0;</span>
<a name="l00677"></a>00677 <span class="stringliteral">            d.depMax = 0;</span>
<a name="l00678"></a>00678 <span class="stringliteral">            d.values = [];</span>
<a name="l00679"></a>00679 <span class="stringliteral">            d.depDefined = [];</span>
<a name="l00680"></a>00680 <span class="stringliteral">            d.depFinished = depFinished;</span>
<a name="l00681"></a>00681 <span class="stringliteral">            if (d.map.pr) {</span>
<a name="l00682"></a>00682 <span class="stringliteral">                //Plugin resource ID, implicitly</span>
<a name="l00683"></a>00683 <span class="stringliteral">                //depends on plugin. Track it in deps</span>
<a name="l00684"></a>00684 <span class="stringliteral">                //so cycle breaking can work</span>
<a name="l00685"></a>00685 <span class="stringliteral">                d.deps = [makeMap(d.map.pr)];</span>
<a name="l00686"></a>00686 <span class="stringliteral">            }</span>
<a name="l00687"></a>00687 <span class="stringliteral">            return d;</span>
<a name="l00688"></a>00688 <span class="stringliteral">        }</span>
<a name="l00689"></a>00689 <span class="stringliteral"></span>
<a name="l00690"></a>00690 <span class="stringliteral">        function getDefer(name) {</span>
<a name="l00691"></a>00691 <span class="stringliteral">            var d;</span>
<a name="l00692"></a>00692 <span class="stringliteral">            if (name) {</span>
<a name="l00693"></a>00693 <span class="stringliteral">                d = hasProp(deferreds, name) &amp;&amp; deferreds[name];</span>
<a name="l00694"></a>00694 <span class="stringliteral">                if (!d) {</span>
<a name="l00695"></a>00695 <span class="stringliteral">                    d = deferreds[name] = makeDefer(name);</span>
<a name="l00696"></a>00696 <span class="stringliteral">                }</span>
<a name="l00697"></a>00697 <span class="stringliteral">            } else {</span>
<a name="l00698"></a>00698 <span class="stringliteral">                d = makeDefer();</span>
<a name="l00699"></a>00699 <span class="stringliteral">                requireDeferreds.push(d);</span>
<a name="l00700"></a>00700 <span class="stringliteral">            }</span>
<a name="l00701"></a>00701 <span class="stringliteral">            return d;</span>
<a name="l00702"></a>00702 <span class="stringliteral">        }</span>
<a name="l00703"></a>00703 <span class="stringliteral"></span>
<a name="l00704"></a>00704 <span class="stringliteral">        function makeErrback(d, name) {</span>
<a name="l00705"></a>00705 <span class="stringliteral">            return function (err) {</span>
<a name="l00706"></a>00706 <span class="stringliteral">                if (!d.rejected()) {</span>
<a name="l00707"></a>00707 <span class="stringliteral">                    if (!err.dynaId) {</span>
<a name="l00708"></a>00708 <span class="stringliteral">                        err.dynaId = &#39;id&#39; + (errCount += 1);</span>
<a name="l00709"></a>00709 <span class="stringliteral">                        err.requireModules = [name];</span>
<a name="l00710"></a>00710 <span class="stringliteral">                    }</span>
<a name="l00711"></a>00711 <span class="stringliteral">                    d.reject(err);</span>
<a name="l00712"></a>00712 <span class="stringliteral">                }</span>
<a name="l00713"></a>00713 <span class="stringliteral">            };</span>
<a name="l00714"></a>00714 <span class="stringliteral">        }</span>
<a name="l00715"></a>00715 <span class="stringliteral"></span>
<a name="l00716"></a>00716 <span class="stringliteral">        function waitForDep(depMap, relName, d, i) {</span>
<a name="l00717"></a>00717 <span class="stringliteral">            d.depMax += 1;</span>
<a name="l00718"></a>00718 <span class="stringliteral"></span>
<a name="l00719"></a>00719 <span class="stringliteral">            //Do the fail at the end to catch errors</span>
<a name="l00720"></a>00720 <span class="stringliteral">            //in the then callback execution.</span>
<a name="l00721"></a>00721 <span class="stringliteral">            callDep(depMap, relName).then(function (val) {</span>
<a name="l00722"></a>00722 <span class="stringliteral">                d.depFinished(val, i);</span>
<a name="l00723"></a>00723 <span class="stringliteral">            }, makeErrback(d, depMap.id)).fail(makeErrback(d, d.map.id));</span>
<a name="l00724"></a>00724 <span class="stringliteral">        }</span>
<a name="l00725"></a>00725 <span class="stringliteral"></span>
<a name="l00726"></a>00726 <span class="stringliteral">        function makeLoad(id) {</span>
<a name="l00727"></a>00727 <span class="stringliteral">            var fromTextCalled;</span>
<a name="l00728"></a>00728 <span class="stringliteral">            function load(value) {</span>
<a name="l00729"></a>00729 <span class="stringliteral">                //Protect against older plugins that call load after</span>
<a name="l00730"></a>00730 <span class="stringliteral">                //calling load.fromText</span>
<a name="l00731"></a>00731 <span class="stringliteral">                if (!fromTextCalled) {</span>
<a name="l00732"></a>00732 <span class="stringliteral">                    resolve(id, getDefer(id), value);</span>
<a name="l00733"></a>00733 <span class="stringliteral">                }</span>
<a name="l00734"></a>00734 <span class="stringliteral">            }</span>
<a name="l00735"></a>00735 <span class="stringliteral"></span>
<a name="l00736"></a>00736 <span class="stringliteral">            load.error = function (err) {</span>
<a name="l00737"></a>00737 <span class="stringliteral">                getDefer(id).reject(err);</span>
<a name="l00738"></a>00738 <span class="stringliteral">            };</span>
<a name="l00739"></a>00739 <span class="stringliteral"></span>
<a name="l00740"></a>00740 <span class="stringliteral">            load.fromText = function (text, textAlt) {</span>
<a name="l00741"></a>00741 <span class="stringliteral">                /*jslint evil: true */</span>
<a name="l00742"></a>00742 <span class="stringliteral">                var d = getDefer(id),</span>
<a name="l00743"></a>00743 <span class="stringliteral">                    map = makeMap(makeMap(id).n),</span>
<a name="l00744"></a>00744 <span class="stringliteral">                    plainId = map.id;</span>
<a name="l00745"></a>00745 <span class="stringliteral"></span>
<a name="l00746"></a>00746 <span class="stringliteral">                fromTextCalled = true;</span>
<a name="l00747"></a>00747 <span class="stringliteral"></span>
<a name="l00748"></a>00748 <span class="stringliteral">                //Set up the factory just to be a return of the value from</span>
<a name="l00749"></a>00749 <span class="stringliteral">                //plainId.</span>
<a name="l00750"></a>00750 <span class="stringliteral">                d.factory = function (p, val) {</span>
<a name="l00751"></a>00751 <span class="stringliteral">                    return val;</span>
<a name="l00752"></a>00752 <span class="stringliteral">                };</span>
<a name="l00753"></a>00753 <span class="stringliteral"></span>
<a name="l00754"></a>00754 <span class="stringliteral">                //As of requirejs 2.1.0, support just passing the text, to reinforce</span>
<a name="l00755"></a>00755 <span class="stringliteral">                //fromText only being called once per resource. Still</span>
<a name="l00756"></a>00756 <span class="stringliteral">                //support old style of passing moduleName but discard</span>
<a name="l00757"></a>00757 <span class="stringliteral">                //that moduleName in favor of the internal ref.</span>
<a name="l00758"></a>00758 <span class="stringliteral">                if (textAlt) {</span>
<a name="l00759"></a>00759 <span class="stringliteral">                    text = textAlt;</span>
<a name="l00760"></a>00760 <span class="stringliteral">                }</span>
<a name="l00761"></a>00761 <span class="stringliteral"></span>
<a name="l00762"></a>00762 <span class="stringliteral">                //Transfer any config to this other module.</span>
<a name="l00763"></a>00763 <span class="stringliteral">                if (hasProp(config.config, id)) {</span>
<a name="l00764"></a>00764 <span class="stringliteral">                    config.config[plainId] = config.config[id];</span>
<a name="l00765"></a>00765 <span class="stringliteral">                }</span>
<a name="l00766"></a>00766 <span class="stringliteral"></span>
<a name="l00767"></a>00767 <span class="stringliteral">                try {</span>
<a name="l00768"></a>00768 <span class="stringliteral">                    req.exec(text);</span>
<a name="l00769"></a>00769 <span class="stringliteral">                } catch (e) {</span>
<a name="l00770"></a>00770 <span class="stringliteral">                    throw new Error(&#39;fromText eval for &#39; + plainId +</span>
<a name="l00771"></a>00771 <span class="stringliteral">                                    &#39; failed: &#39; + e);</span>
<a name="l00772"></a>00772 <span class="stringliteral">                }</span>
<a name="l00773"></a>00773 <span class="stringliteral"></span>
<a name="l00774"></a>00774 <span class="stringliteral">                //Execute any waiting define created by the plainId</span>
<a name="l00775"></a>00775 <span class="stringliteral">                takeQueue(plainId);</span>
<a name="l00776"></a>00776 <span class="stringliteral"></span>
<a name="l00777"></a>00777 <span class="stringliteral">                //Mark this as a dependency for the plugin</span>
<a name="l00778"></a>00778 <span class="stringliteral">                //resource</span>
<a name="l00779"></a>00779 <span class="stringliteral">                d.deps = [map];</span>
<a name="l00780"></a>00780 <span class="stringliteral">                waitForDep(map, null, d, d.deps.length);</span>
<a name="l00781"></a>00781 <span class="stringliteral">            };</span>
<a name="l00782"></a>00782 <span class="stringliteral"></span>
<a name="l00783"></a>00783 <span class="stringliteral">            return load;</span>
<a name="l00784"></a>00784 <span class="stringliteral">        }</span>
<a name="l00785"></a>00785 <span class="stringliteral"></span>
<a name="l00786"></a>00786 <span class="stringliteral">        load = typeof importScripts === &#39;function&#39; ?</span>
<a name="l00787"></a>00787 <span class="stringliteral">                function (map) {</span>
<a name="l00788"></a>00788 <span class="stringliteral">                    var url = map.url;</span>
<a name="l00789"></a>00789 <span class="stringliteral">                    if (urlFetched[url]) {</span>
<a name="l00790"></a>00790 <span class="stringliteral">                        return;</span>
<a name="l00791"></a>00791 <span class="stringliteral">                    }</span>
<a name="l00792"></a>00792 <span class="stringliteral">                    urlFetched[url] = true;</span>
<a name="l00793"></a>00793 <span class="stringliteral"></span>
<a name="l00794"></a>00794 <span class="stringliteral">                    //Ask for the deferred so loading is triggered.</span>
<a name="l00795"></a>00795 <span class="stringliteral">                    //Do this before loading, since loading is sync.</span>
<a name="l00796"></a>00796 <span class="stringliteral">                    getDefer(map.id);</span>
<a name="l00797"></a>00797 <span class="stringliteral">                    importScripts(url);</span>
<a name="l00798"></a>00798 <span class="stringliteral">                    takeQueue(map.id);</span>
<a name="l00799"></a>00799 <span class="stringliteral">                } :</span>
<a name="l00800"></a>00800 <span class="stringliteral">                function (map) {</span>
<a name="l00801"></a>00801 <span class="stringliteral">                    var script,</span>
<a name="l00802"></a>00802 <span class="stringliteral">                        id = map.id,</span>
<a name="l00803"></a>00803 <span class="stringliteral">                        url = map.url;</span>
<a name="l00804"></a>00804 <span class="stringliteral"></span>
<a name="l00805"></a>00805 <span class="stringliteral">                    if (urlFetched[url]) {</span>
<a name="l00806"></a>00806 <span class="stringliteral">                        return;</span>
<a name="l00807"></a>00807 <span class="stringliteral">                    }</span>
<a name="l00808"></a>00808 <span class="stringliteral">                    urlFetched[url] = true;</span>
<a name="l00809"></a>00809 <span class="stringliteral"></span>
<a name="l00810"></a>00810 <span class="stringliteral">                    script = document.createElement(&#39;script&#39;);</span>
<a name="l00811"></a>00811 <span class="stringliteral">                    script.setAttribute(&#39;data-requiremodule&#39;, id);</span>
<a name="l00812"></a>00812 <span class="stringliteral">                    script.type = config.scriptType || &#39;text/javascript&#39;;</span>
<a name="l00813"></a>00813 <span class="stringliteral">                    script.charset = &#39;utf-8&#39;;</span>
<a name="l00814"></a>00814 <span class="stringliteral">                    script.async = true;</span>
<a name="l00815"></a>00815 <span class="stringliteral"></span>
<a name="l00816"></a>00816 <span class="stringliteral">                    loadCount += 1;</span>
<a name="l00817"></a>00817 <span class="stringliteral"></span>
<a name="l00818"></a>00818 <span class="stringliteral">                    script.addEventListener(&#39;load&#39;, function () {</span>
<a name="l00819"></a>00819 <span class="stringliteral">                        loadCount -= 1;</span>
<a name="l00820"></a>00820 <span class="stringliteral">                        takeQueue(id);</span>
<a name="l00821"></a>00821 <span class="stringliteral">                    }, false);</span>
<a name="l00822"></a>00822 <span class="stringliteral">                    script.addEventListener(&#39;error&#39;, function () {</span>
<a name="l00823"></a>00823 <span class="stringliteral">                        loadCount -= 1;</span>
<a name="l00824"></a>00824 <span class="stringliteral">                        var err,</span>
<a name="l00825"></a>00825 <span class="stringliteral">                            pathConfig = getOwn(config.paths, id),</span>
<a name="l00826"></a>00826 <span class="stringliteral">                            d = getOwn(deferreds, id);</span>
<a name="l00827"></a>00827 <span class="stringliteral">                        if (pathConfig &amp;&amp; Array.isArray(pathConfig) &amp;&amp; pathConfig.length &gt; 1) {</span>
<a name="l00828"></a>00828 <span class="stringliteral">                            script.parentNode.removeChild(script);</span>
<a name="l00829"></a>00829 <span class="stringliteral">                            //Pop off the first array value, since it failed, and</span>
<a name="l00830"></a>00830 <span class="stringliteral">                            //retry</span>
<a name="l00831"></a>00831 <span class="stringliteral">                            pathConfig.shift();</span>
<a name="l00832"></a>00832 <span class="stringliteral">                            d.map = makeMap(id);</span>
<a name="l00833"></a>00833 <span class="stringliteral">                            load(d.map);</span>
<a name="l00834"></a>00834 <span class="stringliteral">                        } else {</span>
<a name="l00835"></a>00835 <span class="stringliteral">                            err = new Error(&#39;Load failed: &#39; + id + &#39;: &#39; + script.url);</span>
<a name="l00836"></a>00836 <span class="stringliteral">                            err.requireModules = [id];</span>
<a name="l00837"></a>00837 <span class="stringliteral">                            getDefer(id).reject(err);</span>
<a name="l00838"></a>00838 <span class="stringliteral">                        }</span>
<a name="l00839"></a>00839 <span class="stringliteral">                    }, false);</span>
<a name="l00840"></a>00840 <span class="stringliteral"></span>
<a name="l00841"></a>00841 <span class="stringliteral">                    script.src = url;</span>
<a name="l00842"></a>00842 <span class="stringliteral"></span>
<a name="l00843"></a>00843 <span class="stringliteral">                    document.head.appendChild(script);</span>
<a name="l00844"></a>00844 <span class="stringliteral">                };</span>
<a name="l00845"></a>00845 <span class="stringliteral"></span>
<a name="l00846"></a>00846 <span class="stringliteral">        function callPlugin(plugin, map, relName) {</span>
<a name="l00847"></a>00847 <span class="stringliteral">            plugin.load(map.n, makeRequire(relName), makeLoad(map.id), {});</span>
<a name="l00848"></a>00848 <span class="stringliteral">        }</span>
<a name="l00849"></a>00849 <span class="stringliteral"></span>
<a name="l00850"></a>00850 <span class="stringliteral">        callDep = function (map, relName) {</span>
<a name="l00851"></a>00851 <span class="stringliteral">            var args,</span>
<a name="l00852"></a>00852 <span class="stringliteral">                name = map.id,</span>
<a name="l00853"></a>00853 <span class="stringliteral">                shim = config.shim[name];</span>
<a name="l00854"></a>00854 <span class="stringliteral"></span>
<a name="l00855"></a>00855 <span class="stringliteral">            if (hasProp(waiting, name)) {</span>
<a name="l00856"></a>00856 <span class="stringliteral">                args = waiting[name];</span>
<a name="l00857"></a>00857 <span class="stringliteral">                delete waiting[name];</span>
<a name="l00858"></a>00858 <span class="stringliteral">                main.apply(undef, args);</span>
<a name="l00859"></a>00859 <span class="stringliteral">            } else if (!hasProp(deferreds, name)) {</span>
<a name="l00860"></a>00860 <span class="stringliteral">                if (map.pr) {</span>
<a name="l00861"></a>00861 <span class="stringliteral">                    return callDep(makeMap(map.pr)).then(function (plugin) {</span>
<a name="l00862"></a>00862 <span class="stringliteral">                        //Redo map now that plugin is known to be loaded</span>
<a name="l00863"></a>00863 <span class="stringliteral">                        var newMap = makeMap(name, relName, true),</span>
<a name="l00864"></a>00864 <span class="stringliteral">                            newId = newMap.id,</span>
<a name="l00865"></a>00865 <span class="stringliteral">                            shim = getOwn(config.shim, newId);</span>
<a name="l00866"></a>00866 <span class="stringliteral"></span>
<a name="l00867"></a>00867 <span class="stringliteral">                        //Make sure to only call load once per resource. Many</span>
<a name="l00868"></a>00868 <span class="stringliteral">                        //calls could have been queued waiting for plugin to load.</span>
<a name="l00869"></a>00869 <span class="stringliteral">                        if (!hasProp(calledPlugin, newId)) {</span>
<a name="l00870"></a>00870 <span class="stringliteral">                            calledPlugin[newId] = true;</span>
<a name="l00871"></a>00871 <span class="stringliteral">                            if (shim &amp;&amp; shim.deps) {</span>
<a name="l00872"></a>00872 <span class="stringliteral">                                req(shim.deps, function () {</span>
<a name="l00873"></a>00873 <span class="stringliteral">                                    callPlugin(plugin, newMap, relName);</span>
<a name="l00874"></a>00874 <span class="stringliteral">                                });</span>
<a name="l00875"></a>00875 <span class="stringliteral">                            } else {</span>
<a name="l00876"></a>00876 <span class="stringliteral">                                callPlugin(plugin, newMap, relName);</span>
<a name="l00877"></a>00877 <span class="stringliteral">                            }</span>
<a name="l00878"></a>00878 <span class="stringliteral">                        }</span>
<a name="l00879"></a>00879 <span class="stringliteral">                        return getDefer(newId).promise;</span>
<a name="l00880"></a>00880 <span class="stringliteral">                    });</span>
<a name="l00881"></a>00881 <span class="stringliteral">                } else if (shim &amp;&amp; shim.deps) {</span>
<a name="l00882"></a>00882 <span class="stringliteral">                    req(shim.deps, function () {</span>
<a name="l00883"></a>00883 <span class="stringliteral">                        load(map);</span>
<a name="l00884"></a>00884 <span class="stringliteral">                    });</span>
<a name="l00885"></a>00885 <span class="stringliteral">                } else {</span>
<a name="l00886"></a>00886 <span class="stringliteral">                    load(map);</span>
<a name="l00887"></a>00887 <span class="stringliteral">                }</span>
<a name="l00888"></a>00888 <span class="stringliteral">            }</span>
<a name="l00889"></a>00889 <span class="stringliteral"></span>
<a name="l00890"></a>00890 <span class="stringliteral">            return getDefer(name).promise;</span>
<a name="l00891"></a>00891 <span class="stringliteral">        };</span>
<a name="l00892"></a>00892 <span class="stringliteral"></span>
<a name="l00893"></a>00893 <span class="stringliteral">        //Turns a plugin!resource to [plugin, resource]</span>
<a name="l00894"></a>00894 <span class="stringliteral">        //with the plugin being undefined if the name</span>
<a name="l00895"></a>00895 <span class="stringliteral">        //did not have a plugin prefix.</span>
<a name="l00896"></a>00896 <span class="stringliteral">        function splitPrefix(name) {</span>
<a name="l00897"></a>00897 <span class="stringliteral">            var prefix,</span>
<a name="l00898"></a>00898 <span class="stringliteral">                index = name ? name.indexOf(&#39;!&#39;) : -1;</span>
<a name="l00899"></a>00899 <span class="stringliteral">            if (index &gt; -1) {</span>
<a name="l00900"></a>00900 <span class="stringliteral">                prefix = name.substring(0, index);</span>
<a name="l00901"></a>00901 <span class="stringliteral">                name = name.substring(index + 1, name.length);</span>
<a name="l00902"></a>00902 <span class="stringliteral">            }</span>
<a name="l00903"></a>00903 <span class="stringliteral">            return [prefix, name];</span>
<a name="l00904"></a>00904 <span class="stringliteral">        }</span>
<a name="l00905"></a>00905 <span class="stringliteral"></span>
<a name="l00911"></a>00911 <span class="stringliteral">        makeMap = function (name, relName, applyMap) {</span>
<a name="l00912"></a>00912 <span class="stringliteral">            if (typeof name !== &#39;string&#39;) {</span>
<a name="l00913"></a>00913 <span class="stringliteral">                return name;</span>
<a name="l00914"></a>00914 <span class="stringliteral">            }</span>
<a name="l00915"></a>00915 <span class="stringliteral"></span>
<a name="l00916"></a>00916 <span class="stringliteral">            var plugin, url,</span>
<a name="l00917"></a>00917 <span class="stringliteral">                parts = splitPrefix(name),</span>
<a name="l00918"></a>00918 <span class="stringliteral">                prefix = parts[0];</span>
<a name="l00919"></a>00919 <span class="stringliteral"></span>
<a name="l00920"></a>00920 <span class="stringliteral">            name = parts[1];</span>
<a name="l00921"></a>00921 <span class="stringliteral"></span>
<a name="l00922"></a>00922 <span class="stringliteral">            if (prefix) {</span>
<a name="l00923"></a>00923 <span class="stringliteral">                prefix = normalize(prefix, relName, applyMap);</span>
<a name="l00924"></a>00924 <span class="stringliteral">                plugin = hasProp(defined, prefix) &amp;&amp; defined[prefix];</span>
<a name="l00925"></a>00925 <span class="stringliteral">            }</span>
<a name="l00926"></a>00926 <span class="stringliteral"></span>
<a name="l00927"></a>00927 <span class="stringliteral">            //Normalize according</span>
<a name="l00928"></a>00928 <span class="stringliteral">            if (prefix) {</span>
<a name="l00929"></a>00929 <span class="stringliteral">                if (plugin &amp;&amp; plugin.normalize) {</span>
<a name="l00930"></a>00930 <span class="stringliteral">                    name = plugin.normalize(name, makeNormalize(relName));</span>
<a name="l00931"></a>00931 <span class="stringliteral">                } else {</span>
<a name="l00932"></a>00932 <span class="stringliteral">                    name = normalize(name, relName, applyMap);</span>
<a name="l00933"></a>00933 <span class="stringliteral">                }</span>
<a name="l00934"></a>00934 <span class="stringliteral">            } else {</span>
<a name="l00935"></a>00935 <span class="stringliteral">                name = normalize(name, relName, applyMap);</span>
<a name="l00936"></a>00936 <span class="stringliteral">                parts = splitPrefix(name);</span>
<a name="l00937"></a>00937 <span class="stringliteral">                prefix = parts[0];</span>
<a name="l00938"></a>00938 <span class="stringliteral">                name = parts[1];</span>
<a name="l00939"></a>00939 <span class="stringliteral"></span>
<a name="l00940"></a>00940 <span class="stringliteral">                url = req.nameToUrl(name);</span>
<a name="l00941"></a>00941 <span class="stringliteral">            }</span>
<a name="l00942"></a>00942 <span class="stringliteral"></span>
<a name="l00943"></a>00943 <span class="stringliteral">            //Using ridiculous property names for space reasons</span>
<a name="l00944"></a>00944 <span class="stringliteral">            return {</span>
<a name="l00945"></a>00945 <span class="stringliteral">                id: prefix ? prefix + &#39;!&#39; + name : name, //fullName</span>
<a name="l00946"></a>00946 <span class="stringliteral">                n: name,</span>
<a name="l00947"></a>00947 <span class="stringliteral">                pr: prefix,</span>
<a name="l00948"></a>00948 <span class="stringliteral">                url: url</span>
<a name="l00949"></a>00949 <span class="stringliteral">            };</span>
<a name="l00950"></a>00950 <span class="stringliteral">        };</span>
<a name="l00951"></a>00951 <span class="stringliteral"></span>
<a name="l00952"></a>00952 <span class="stringliteral">        function makeConfig(name) {</span>
<a name="l00953"></a>00953 <span class="stringliteral">            return function () {</span>
<a name="l00954"></a>00954 <span class="stringliteral">                return config.config[name] || {};</span>
<a name="l00955"></a>00955 <span class="stringliteral">            };</span>
<a name="l00956"></a>00956 <span class="stringliteral">        }</span>
<a name="l00957"></a>00957 <span class="stringliteral"></span>
<a name="l00958"></a>00958 <span class="stringliteral">        handlers = {</span>
<a name="l00959"></a>00959 <span class="stringliteral">            require: function (name) {</span>
<a name="l00960"></a>00960 <span class="stringliteral">                return makeRequire(name);</span>
<a name="l00961"></a>00961 <span class="stringliteral">            },</span>
<a name="l00962"></a>00962 <span class="stringliteral">            exports: function (name) {</span>
<a name="l00963"></a>00963 <span class="stringliteral">                var e = defined[name];</span>
<a name="l00964"></a>00964 <span class="stringliteral">                if (typeof e !== &#39;undefined&#39;) {</span>
<a name="l00965"></a>00965 <span class="stringliteral">                    return e;</span>
<a name="l00966"></a>00966 <span class="stringliteral">                } else {</span>
<a name="l00967"></a>00967 <span class="stringliteral">                    return (defined[name] = {});</span>
<a name="l00968"></a>00968 <span class="stringliteral">                }</span>
<a name="l00969"></a>00969 <span class="stringliteral">            },</span>
<a name="l00970"></a>00970 <span class="stringliteral">            module: function (name) {</span>
<a name="l00971"></a>00971 <span class="stringliteral">                return {</span>
<a name="l00972"></a>00972 <span class="stringliteral">                    id: name,</span>
<a name="l00973"></a>00973 <span class="stringliteral">                    uri: &#39;&#39;,</span>
<a name="l00974"></a>00974 <span class="stringliteral">                    exports: defined[name],</span>
<a name="l00975"></a>00975 <span class="stringliteral">                    config: makeConfig(name)</span>
<a name="l00976"></a>00976 <span class="stringliteral">                };</span>
<a name="l00977"></a>00977 <span class="stringliteral">            }</span>
<a name="l00978"></a>00978 <span class="stringliteral">        };</span>
<a name="l00979"></a>00979 <span class="stringliteral"></span>
<a name="l00980"></a>00980 <span class="stringliteral">        function breakCycle(d, traced, processed) {</span>
<a name="l00981"></a>00981 <span class="stringliteral">            var id = d.map.id;</span>
<a name="l00982"></a>00982 <span class="stringliteral"></span>
<a name="l00983"></a>00983 <span class="stringliteral">            traced[id] = true;</span>
<a name="l00984"></a>00984 <span class="stringliteral">            if (!d.finished() &amp;&amp; d.deps) {</span>
<a name="l00985"></a>00985 <span class="stringliteral">                d.deps.forEach(function (depMap) {</span>
<a name="l00986"></a>00986 <span class="stringliteral">                    var depIndex,</span>
<a name="l00987"></a>00987 <span class="stringliteral">                        depId = depMap.id,</span>
<a name="l00988"></a>00988 <span class="stringliteral">                        dep = !hasProp(handlers, depId) &amp;&amp; getDefer(depId);</span>
<a name="l00989"></a>00989 <span class="stringliteral"></span>
<a name="l00990"></a>00990 <span class="stringliteral">                    //Only force things that have not completed</span>
<a name="l00991"></a>00991 <span class="stringliteral">                    //being defined, so still in the registry,</span>
<a name="l00992"></a>00992 <span class="stringliteral">                    //and only if it has not been matched up</span>
<a name="l00993"></a>00993 <span class="stringliteral">                    //in the module already.</span>
<a name="l00994"></a>00994 <span class="stringliteral">                    if (dep &amp;&amp; !dep.finished() &amp;&amp; !processed[depId]) {</span>
<a name="l00995"></a>00995 <span class="stringliteral">                        if (hasProp(traced, depId)) {</span>
<a name="l00996"></a>00996 <span class="stringliteral">                            d.deps.some(function (depMap, i) {</span>
<a name="l00997"></a>00997 <span class="stringliteral">                                if (depMap.id === depId) {</span>
<a name="l00998"></a>00998 <span class="stringliteral">                                    depIndex = i;</span>
<a name="l00999"></a>00999 <span class="stringliteral">                                    return true;</span>
<a name="l01000"></a>01000 <span class="stringliteral">                                }</span>
<a name="l01001"></a>01001 <span class="stringliteral">                            });</span>
<a name="l01002"></a>01002 <span class="stringliteral">                            d.depFinished(defined[depId], depIndex);</span>
<a name="l01003"></a>01003 <span class="stringliteral">                        } else {</span>
<a name="l01004"></a>01004 <span class="stringliteral">                            breakCycle(dep, traced, processed);</span>
<a name="l01005"></a>01005 <span class="stringliteral">                        }</span>
<a name="l01006"></a>01006 <span class="stringliteral">                    }</span>
<a name="l01007"></a>01007 <span class="stringliteral">                });</span>
<a name="l01008"></a>01008 <span class="stringliteral">            }</span>
<a name="l01009"></a>01009 <span class="stringliteral">            processed[id] = true;</span>
<a name="l01010"></a>01010 <span class="stringliteral">        }</span>
<a name="l01011"></a>01011 <span class="stringliteral"></span>
<a name="l01012"></a>01012 <span class="stringliteral">        function check() {</span>
<a name="l01013"></a>01013 <span class="stringliteral">            loadTimeId = 0;</span>
<a name="l01014"></a>01014 <span class="stringliteral"></span>
<a name="l01015"></a>01015 <span class="stringliteral">            var err,</span>
<a name="l01016"></a>01016 <span class="stringliteral">                reqDefs = [],</span>
<a name="l01017"></a>01017 <span class="stringliteral">                noLoads = [],</span>
<a name="l01018"></a>01018 <span class="stringliteral">                waitInterval = config.waitSeconds * 1000,</span>
<a name="l01019"></a>01019 <span class="stringliteral">                //It is possible to disable the wait interval by using waitSeconds of 0.</span>
<a name="l01020"></a>01020 <span class="stringliteral">                expired = waitInterval &amp;&amp; (startTime + waitInterval) &lt; (new Date()).getTime();</span>
<a name="l01021"></a>01021 <span class="stringliteral"></span>
<a name="l01022"></a>01022 <span class="stringliteral">            if (loadCount === 0) {</span>
<a name="l01023"></a>01023 <span class="stringliteral">                reqDefs = requireDeferreds.filter(function (d) {</span>
<a name="l01024"></a>01024 <span class="stringliteral">                    //Only want deferreds that have not finished.</span>
<a name="l01025"></a>01025 <span class="stringliteral">                    return !d.finished();</span>
<a name="l01026"></a>01026 <span class="stringliteral">                });</span>
<a name="l01027"></a>01027 <span class="stringliteral"></span>
<a name="l01028"></a>01028 <span class="stringliteral">                if (reqDefs.length) {</span>
<a name="l01029"></a>01029 <span class="stringliteral">                    //Something is not resolved. Dive into it.</span>
<a name="l01030"></a>01030 <span class="stringliteral">                    eachProp(deferreds, function (d) {</span>
<a name="l01031"></a>01031 <span class="stringliteral">                        if (!d.finished()) {</span>
<a name="l01032"></a>01032 <span class="stringliteral">                            noLoads.push(d);</span>
<a name="l01033"></a>01033 <span class="stringliteral">                        }</span>
<a name="l01034"></a>01034 <span class="stringliteral">                    });</span>
<a name="l01035"></a>01035 <span class="stringliteral"></span>
<a name="l01036"></a>01036 <span class="stringliteral">                    if (noLoads.length) {</span>
<a name="l01037"></a>01037 <span class="stringliteral">                        reqDefs.forEach(function (d) {</span>
<a name="l01038"></a>01038 <span class="stringliteral">                            breakCycle(d, {}, {});</span>
<a name="l01039"></a>01039 <span class="stringliteral">                        });</span>
<a name="l01040"></a>01040 <span class="stringliteral">                    }</span>
<a name="l01041"></a>01041 <span class="stringliteral">                }</span>
<a name="l01042"></a>01042 <span class="stringliteral">            }</span>
<a name="l01043"></a>01043 <span class="stringliteral"></span>
<a name="l01044"></a>01044 <span class="stringliteral">            //If still waiting on loads, and the waiting load is something</span>
<a name="l01045"></a>01045 <span class="stringliteral">            //other than a plugin resource, or there are still outstanding</span>
<a name="l01046"></a>01046 <span class="stringliteral">            //scripts, then just try back later.</span>
<a name="l01047"></a>01047 <span class="stringliteral">            if (expired) {</span>
<a name="l01048"></a>01048 <span class="stringliteral">                //If wait time expired, throw error of unloaded modules.</span>
<a name="l01049"></a>01049 <span class="stringliteral">                noLoads = noLoads.map(function (d) {</span>
<a name="l01050"></a>01050 <span class="stringliteral">                    return d.map.id;</span>
<a name="l01051"></a>01051 <span class="stringliteral">                });</span>
<a name="l01052"></a>01052 <span class="stringliteral">                err = new Error(&#39;Timeout for modules: &#39; + noLoads);</span>
<a name="l01053"></a>01053 <span class="stringliteral">                err.requireModules = noLoads;</span>
<a name="l01054"></a>01054 <span class="stringliteral">                req.onError(err);</span>
<a name="l01055"></a>01055 <span class="stringliteral">            } else if (loadCount || reqDefs.length) {</span>
<a name="l01056"></a>01056 <span class="stringliteral">                //Something is still waiting to load. Wait for it, but only</span>
<a name="l01057"></a>01057 <span class="stringliteral">                //if a timeout is not already in effect.</span>
<a name="l01058"></a>01058 <span class="stringliteral">                if (!loadTimeId) {</span>
<a name="l01059"></a>01059 <span class="stringliteral">                    loadTimeId = prim.nextTick(check);</span>
<a name="l01060"></a>01060 <span class="stringliteral">                }</span>
<a name="l01061"></a>01061 <span class="stringliteral">            }</span>
<a name="l01062"></a>01062 <span class="stringliteral">        }</span>
<a name="l01063"></a>01063 <span class="stringliteral"></span>
<a name="l01064"></a>01064 <span class="stringliteral">        //Used to break out of the promise try/catch chains.</span>
<a name="l01065"></a>01065 <span class="stringliteral">        function delayedError(e) {</span>
<a name="l01066"></a>01066 <span class="stringliteral">            prim.nextTick(function () {</span>
<a name="l01067"></a>01067 <span class="stringliteral">                if (!e.dynaId || !trackedErrors[e.dynaId]) {</span>
<a name="l01068"></a>01068 <span class="stringliteral">                    trackedErrors[e.dynaId] = true;</span>
<a name="l01069"></a>01069 <span class="stringliteral">                    req.onError(e);</span>
<a name="l01070"></a>01070 <span class="stringliteral">                }</span>
<a name="l01071"></a>01071 <span class="stringliteral">            });</span>
<a name="l01072"></a>01072 <span class="stringliteral">        }</span>
<a name="l01073"></a>01073 <span class="stringliteral"></span>
<a name="l01074"></a>01074 <span class="stringliteral">        main = function (name, deps, factory, errback, relName) {</span>
<a name="l01075"></a>01075 <span class="stringliteral">            //Only allow main calling once per module.</span>
<a name="l01076"></a>01076 <span class="stringliteral">            if (name &amp;&amp; hasProp(calledDefine, name)) {</span>
<a name="l01077"></a>01077 <span class="stringliteral">                return;</span>
<a name="l01078"></a>01078 <span class="stringliteral">            }</span>
<a name="l01079"></a>01079 <span class="stringliteral">            calledDefine[name] = true;</span>
<a name="l01080"></a>01080 <span class="stringliteral"></span>
<a name="l01081"></a>01081 <span class="stringliteral">            var d = getDefer(name);</span>
<a name="l01082"></a>01082 <span class="stringliteral"></span>
<a name="l01083"></a>01083 <span class="stringliteral">            //This module may not have dependencies</span>
<a name="l01084"></a>01084 <span class="stringliteral">            if (deps &amp;&amp; !Array.isArray(deps)) {</span>
<a name="l01085"></a>01085 <span class="stringliteral">                //deps is not an array, so probably means</span>
<a name="l01086"></a>01086 <span class="stringliteral">                //an object literal or factory function for</span>
<a name="l01087"></a>01087 <span class="stringliteral">                //the value. Adjust args.</span>
<a name="l01088"></a>01088 <span class="stringliteral">                factory = deps;</span>
<a name="l01089"></a>01089 <span class="stringliteral">                deps = [];</span>
<a name="l01090"></a>01090 <span class="stringliteral">            }</span>
<a name="l01091"></a>01091 <span class="stringliteral"></span>
<a name="l01092"></a>01092 <span class="stringliteral">            d.promise.fail(errback || delayedError);</span>
<a name="l01093"></a>01093 <span class="stringliteral"></span>
<a name="l01094"></a>01094 <span class="stringliteral">            //Use name if no relName</span>
<a name="l01095"></a>01095 <span class="stringliteral">            relName = relName || name;</span>
<a name="l01096"></a>01096 <span class="stringliteral"></span>
<a name="l01097"></a>01097 <span class="stringliteral">            //Call the factory to define the module, if necessary.</span>
<a name="l01098"></a>01098 <span class="stringliteral">            if (typeof factory === &#39;function&#39;) {</span>
<a name="l01099"></a>01099 <span class="stringliteral"></span>
<a name="l01100"></a>01100 <span class="stringliteral">                if (!deps.length &amp;&amp; factory.length) {</span>
<a name="l01101"></a>01101 <span class="stringliteral">                    //Remove comments from the callback string,</span>
<a name="l01102"></a>01102 <span class="stringliteral">                    //look for require calls, and pull them into the dependencies,</span>
<a name="l01103"></a>01103 <span class="stringliteral">                    //but only if there are function args.</span>
<a name="l01104"></a>01104 <span class="stringliteral">                    factory</span>
<a name="l01105"></a>01105 <span class="stringliteral">                        .toString()</span>
<a name="l01106"></a>01106 <span class="stringliteral">                        .replace(commentRegExp, &#39;&#39;)</span>
<a name="l01107"></a>01107 <span class="stringliteral">                        .replace(cjsRequireRegExp, function (match, dep) {</span>
<a name="l01108"></a>01108 <span class="stringliteral">                            deps.push(dep);</span>
<a name="l01109"></a>01109 <span class="stringliteral">                        });</span>
<a name="l01110"></a>01110 <span class="stringliteral"></span>
<a name="l01111"></a>01111 <span class="stringliteral">                    //May be a CommonJS thing even without require calls, but still</span>
<a name="l01112"></a>01112 <span class="stringliteral">                    //could use exports, and module. Avoid doing exports and module</span>
<a name="l01113"></a>01113 <span class="stringliteral">                    //work though if it just needs require.</span>
<a name="l01114"></a>01114 <span class="stringliteral">                    //REQUIRES the function to expect the CommonJS variables in the</span>
<a name="l01115"></a>01115 <span class="stringliteral">                    //order listed below.</span>
<a name="l01116"></a>01116 <span class="stringliteral">                    deps = (factory.length === 1 ?</span>
<a name="l01117"></a>01117 <span class="stringliteral">                            [&#39;require&#39;] :</span>
<a name="l01118"></a>01118 <span class="stringliteral">                            [&#39;require&#39;, &#39;exports&#39;, &#39;module&#39;]).concat(deps);</span>
<a name="l01119"></a>01119 <span class="stringliteral">                }</span>
<a name="l01120"></a>01120 <span class="stringliteral"></span>
<a name="l01121"></a>01121 <span class="stringliteral">                //Save info for use later.</span>
<a name="l01122"></a>01122 <span class="stringliteral">                d.factory = factory;</span>
<a name="l01123"></a>01123 <span class="stringliteral">                d.deps = deps;</span>
<a name="l01124"></a>01124 <span class="stringliteral"></span>
<a name="l01125"></a>01125 <span class="stringliteral">                deps.forEach(function (depName, i) {</span>
<a name="l01126"></a>01126 <span class="stringliteral">                    var depMap;</span>
<a name="l01127"></a>01127 <span class="stringliteral">                    deps[i] = depMap = makeMap(depName, relName, true);</span>
<a name="l01128"></a>01128 <span class="stringliteral">                    depName = depMap.id;</span>
<a name="l01129"></a>01129 <span class="stringliteral"></span>
<a name="l01130"></a>01130 <span class="stringliteral">                    //Fast path CommonJS standard dependencies.</span>
<a name="l01131"></a>01131 <span class="stringliteral">                    if (depName === &quot;</span><a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a><span class="stringliteral">&quot;) {</span>
<a name="l01132"></a>01132 <span class="stringliteral">                        d.values[i] = handlers.require(name);</span>
<a name="l01133"></a>01133 <span class="stringliteral">                    } else if (depName === &quot;</span><a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a><span class="stringliteral">&quot;) {</span>
<a name="l01134"></a>01134 <span class="stringliteral">                        //CommonJS module spec 1.1</span>
<a name="l01135"></a>01135 <span class="stringliteral">                        d.values[i] = handlers.exports(name);</span>
<a name="l01136"></a>01136 <span class="stringliteral">                        d.usingExports = true;</span>
<a name="l01137"></a>01137 <span class="stringliteral">                    } else if (depName === &quot;</span><a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a><span class="stringliteral">&quot;) {</span>
<a name="l01138"></a>01138 <span class="stringliteral">                        //CommonJS module spec 1.1</span>
<a name="l01139"></a>01139 <span class="stringliteral">                        d.values[i] = d.cjsModule = handlers.module(name);</span>
<a name="l01140"></a>01140 <span class="stringliteral">                    } else {</span>
<a name="l01141"></a>01141 <span class="stringliteral">                        waitForDep(depMap, relName, d, i);</span>
<a name="l01142"></a>01142 <span class="stringliteral">                    }</span>
<a name="l01143"></a>01143 <span class="stringliteral">                });</span>
<a name="l01144"></a>01144 <span class="stringliteral"></span>
<a name="l01145"></a>01145 <span class="stringliteral">                //Some modules just depend on the require, exports, modules, so</span>
<a name="l01146"></a>01146 <span class="stringliteral">                //trigger their definition here if so.</span>
<a name="l01147"></a>01147 <span class="stringliteral">                if (d.depCount === d.depMax) {</span>
<a name="l01148"></a>01148 <span class="stringliteral">                    defineModule(d);</span>
<a name="l01149"></a>01149 <span class="stringliteral">                }</span>
<a name="l01150"></a>01150 <span class="stringliteral">            } else if (name) {</span>
<a name="l01151"></a>01151 <span class="stringliteral">                //May just be an object definition for the module. Only</span>
<a name="l01152"></a>01152 <span class="stringliteral">                //worry about defining if have a module name.</span>
<a name="l01153"></a>01153 <span class="stringliteral">                resolve(name, d, factory);</span>
<a name="l01154"></a>01154 <span class="stringliteral">            }</span>
<a name="l01155"></a>01155 <span class="stringliteral"></span>
<a name="l01156"></a>01156 <span class="stringliteral">            startTime = (new Date()).getTime();</span>
<a name="l01157"></a>01157 <span class="stringliteral"></span>
<a name="l01158"></a>01158 <span class="stringliteral">            if (!name) {</span>
<a name="l01159"></a>01159 <span class="stringliteral">                check();</span>
<a name="l01160"></a>01160 <span class="stringliteral">            }</span>
<a name="l01161"></a>01161 <span class="stringliteral">        };</span>
<a name="l01162"></a>01162 <span class="stringliteral"></span>
<a name="l01163"></a>01163 <span class="stringliteral">        req = makeRequire(null, true);</span>
<a name="l01164"></a>01164 <span class="stringliteral"></span>
<a name="l01165"></a>01165 <span class="stringliteral">        /*</span>
<a name="l01166"></a>01166 <span class="stringliteral">         * Just drops the config on the floor, but returns req in case</span>
<a name="l01167"></a>01167 <span class="stringliteral">         * the config return value is used.</span>
<a name="l01168"></a>01168 <span class="stringliteral">         */</span>
<a name="l01169"></a>01169 <span class="stringliteral">        req.config = function (cfg) {</span>
<a name="l01170"></a>01170 <span class="stringliteral">            if (cfg.context &amp;&amp; cfg.context !== contextName) {</span>
<a name="l01171"></a>01171 <span class="stringliteral">                return newContext(cfg.context).config(cfg);</span>
<a name="l01172"></a>01172 <span class="stringliteral">            }</span>
<a name="l01173"></a>01173 <span class="stringliteral"></span>
<a name="l01174"></a>01174 <span class="stringliteral">            //Make sure the baseUrl ends in a slash.</span>
<a name="l01175"></a>01175 <span class="stringliteral">            if (cfg.baseUrl) {</span>
<a name="l01176"></a>01176 <span class="stringliteral">                if (cfg.baseUrl.charAt(cfg.baseUrl.length - 1) !== &#39;/&#39;) {</span>
<a name="l01177"></a>01177 <span class="stringliteral">                    cfg.baseUrl += &#39;/&#39;;</span>
<a name="l01178"></a>01178 <span class="stringliteral">                }</span>
<a name="l01179"></a>01179 <span class="stringliteral">            }</span>
<a name="l01180"></a>01180 <span class="stringliteral"></span>
<a name="l01181"></a>01181 <span class="stringliteral">            //Save off the paths and packages since they require special processing,</span>
<a name="l01182"></a>01182 <span class="stringliteral">            //they are additive.</span>
<a name="l01183"></a>01183 <span class="stringliteral">            var primId,</span>
<a name="l01184"></a>01184 <span class="stringliteral">                pkgs = config.pkgs,</span>
<a name="l01185"></a>01185 <span class="stringliteral">                shim = config.shim,</span>
<a name="l01186"></a>01186 <span class="stringliteral">                objs = {</span>
<a name="l01187"></a>01187 <span class="stringliteral">                    paths: true,</span>
<a name="l01188"></a>01188 <span class="stringliteral">                    config: true,</span>
<a name="l01189"></a>01189 <span class="stringliteral">                    map: true</span>
<a name="l01190"></a>01190 <span class="stringliteral">                };</span>
<a name="l01191"></a>01191 <span class="stringliteral"></span>
<a name="l01192"></a>01192 <span class="stringliteral">            eachProp(cfg, function (value, prop) {</span>
<a name="l01193"></a>01193 <span class="stringliteral">                if (objs[prop]) {</span>
<a name="l01194"></a>01194 <span class="stringliteral">                    if (prop === &#39;map&#39;) {</span>
<a name="l01195"></a>01195 <span class="stringliteral">                        if (!config.map) {</span>
<a name="l01196"></a>01196 <span class="stringliteral">                            config.map = {};</span>
<a name="l01197"></a>01197 <span class="stringliteral">                        }</span>
<a name="l01198"></a>01198 <span class="stringliteral">                        mixin(config[prop], value, true, true);</span>
<a name="l01199"></a>01199 <span class="stringliteral">                    } else {</span>
<a name="l01200"></a>01200 <span class="stringliteral">                        mixin(config[prop], value, true);</span>
<a name="l01201"></a>01201 <span class="stringliteral">                    }</span>
<a name="l01202"></a>01202 <span class="stringliteral">                } else {</span>
<a name="l01203"></a>01203 <span class="stringliteral">                    config[prop] = value;</span>
<a name="l01204"></a>01204 <span class="stringliteral">                }</span>
<a name="l01205"></a>01205 <span class="stringliteral">            });</span>
<a name="l01206"></a>01206 <span class="stringliteral"></span>
<a name="l01207"></a>01207 <span class="stringliteral">            //Merge shim</span>
<a name="l01208"></a>01208 <span class="stringliteral">            if (cfg.shim) {</span>
<a name="l01209"></a>01209 <span class="stringliteral">                eachProp(cfg.shim, function (value, id) {</span>
<a name="l01210"></a>01210 <span class="stringliteral">                    //Normalize the structure</span>
<a name="l01211"></a>01211 <span class="stringliteral">                    if (Array.isArray(value)) {</span>
<a name="l01212"></a>01212 <span class="stringliteral">                        value = {</span>
<a name="l01213"></a>01213 <span class="stringliteral">                            deps: value</span>
<a name="l01214"></a>01214 <span class="stringliteral">                        };</span>
<a name="l01215"></a>01215 <span class="stringliteral">                    }</span>
<a name="l01216"></a>01216 <span class="stringliteral">                    if ((value.exports || value.init) &amp;&amp; !value.exportsFn) {</span>
<a name="l01217"></a>01217 <span class="stringliteral">                        value.exportsFn = makeShimExports(value);</span>
<a name="l01218"></a>01218 <span class="stringliteral">                    }</span>
<a name="l01219"></a>01219 <span class="stringliteral">                    shim[id] = value;</span>
<a name="l01220"></a>01220 <span class="stringliteral">                });</span>
<a name="l01221"></a>01221 <span class="stringliteral">                config.shim = shim;</span>
<a name="l01222"></a>01222 <span class="stringliteral">            }</span>
<a name="l01223"></a>01223 <span class="stringliteral"></span>
<a name="l01224"></a>01224 <span class="stringliteral">            //Adjust packages if necessary.</span>
<a name="l01225"></a>01225 <span class="stringliteral">            if (cfg.packages) {</span>
<a name="l01226"></a>01226 <span class="stringliteral">                cfg.packages.forEach(function (pkgObj) {</span>
<a name="l01227"></a>01227 <span class="stringliteral">                    var location;</span>
<a name="l01228"></a>01228 <span class="stringliteral"></span>
<a name="l01229"></a>01229 <span class="stringliteral">                    pkgObj = typeof pkgObj === &#39;string&#39; ? { name: pkgObj } : pkgObj;</span>
<a name="l01230"></a>01230 <span class="stringliteral">                    location = pkgObj.location;</span>
<a name="l01231"></a>01231 <span class="stringliteral"></span>
<a name="l01232"></a>01232 <span class="stringliteral">                    //Create a brand new object on pkgs, since currentPackages can</span>
<a name="l01233"></a>01233 <span class="stringliteral">                    //be passed in again, and config.pkgs is the internal transformed</span>
<a name="l01234"></a>01234 <span class="stringliteral">                    //state for all package configs.</span>
<a name="l01235"></a>01235 <span class="stringliteral">                    pkgs[pkgObj.name] = {</span>
<a name="l01236"></a>01236 <span class="stringliteral">                        name: pkgObj.name,</span>
<a name="l01237"></a>01237 <span class="stringliteral">                        location: location || pkgObj.name,</span>
<a name="l01238"></a>01238 <span class="stringliteral">                        //Remove leading dot in main, so main paths are normalized,</span>
<a name="l01239"></a>01239 <span class="stringliteral">                        //and remove any trailing .js, since different package</span>
<a name="l01240"></a>01240 <span class="stringliteral">                        //envs have different conventions: some use a module name,</span>
<a name="l01241"></a>01241 <span class="stringliteral">                        //some use a file name.</span>
<a name="l01242"></a>01242 <span class="stringliteral">                        main: (pkgObj.main || &#39;main&#39;)</span>
<a name="l01243"></a>01243 <span class="stringliteral">                              .replace(currDirRegExp, &#39;&#39;)</span>
<a name="l01244"></a>01244 <span class="stringliteral">                              .replace(jsSuffixRegExp, &#39;&#39;)</span>
<a name="l01245"></a>01245 <span class="stringliteral">                    };</span>
<a name="l01246"></a>01246 <span class="stringliteral">                });</span>
<a name="l01247"></a>01247 <span class="stringliteral"></span>
<a name="l01248"></a>01248 <span class="stringliteral">                //Done with modifications, assing packages back to context config</span>
<a name="l01249"></a>01249 <span class="stringliteral">                config.pkgs = pkgs;</span>
<a name="l01250"></a>01250 <span class="stringliteral">            }</span>
<a name="l01251"></a>01251 <span class="stringliteral"></span>
<a name="l01252"></a>01252 <span class="stringliteral">            //If want prim injected, inject it now.</span>
<a name="l01253"></a>01253 <span class="stringliteral">            primId = config.definePrim;</span>
<a name="l01254"></a>01254 <span class="stringliteral">            if (primId) {</span>
<a name="l01255"></a>01255 <span class="stringliteral">                waiting[primId] = [primId, [], function () { return prim; }];</span>
<a name="l01256"></a>01256 <span class="stringliteral">            }</span>
<a name="l01257"></a>01257 <span class="stringliteral"></span>
<a name="l01258"></a>01258 <span class="stringliteral">            //If a deps array or a config callback is specified, then call</span>
<a name="l01259"></a>01259 <span class="stringliteral">            //require with those args. This is useful when require is defined as a</span>
<a name="l01260"></a>01260 <span class="stringliteral">            //config object before require.js is loaded.</span>
<a name="l01261"></a>01261 <span class="stringliteral">            if (cfg.deps) {</span>
<a name="l01262"></a>01262 <span class="stringliteral">                req(cfg.deps, cfg.callback);</span>
<a name="l01263"></a>01263 <span class="stringliteral">            }</span>
<a name="l01264"></a>01264 <span class="stringliteral"></span>
<a name="l01265"></a>01265 <span class="stringliteral">            return req;</span>
<a name="l01266"></a>01266 <span class="stringliteral">        };</span>
<a name="l01267"></a>01267 <span class="stringliteral"></span>
<a name="l01268"></a>01268 <span class="stringliteral">        req.onError = function (err) {</span>
<a name="l01269"></a>01269 <span class="stringliteral">            throw err;</span>
<a name="l01270"></a>01270 <span class="stringliteral">        };</span>
<a name="l01271"></a>01271 <span class="stringliteral"></span>
<a name="l01272"></a>01272 <span class="stringliteral">        context = {</span>
<a name="l01273"></a>01273 <span class="stringliteral">            id: contextName,</span>
<a name="l01274"></a>01274 <span class="stringliteral">            defined: defined,</span>
<a name="l01275"></a>01275 <span class="stringliteral">            waiting: waiting,</span>
<a name="l01276"></a>01276 <span class="stringliteral">            config: config,</span>
<a name="l01277"></a>01277 <span class="stringliteral">            deferreds: deferreds</span>
<a name="l01278"></a>01278 <span class="stringliteral">        };</span>
<a name="l01279"></a>01279 <span class="stringliteral"></span>
<a name="l01280"></a>01280 <span class="stringliteral">        contexts[contextName] = context;</span>
<a name="l01281"></a>01281 <span class="stringliteral"></span>
<a name="l01282"></a>01282 <span class="stringliteral">        return req;</span>
<a name="l01283"></a>01283 <span class="stringliteral">    }</span>
<a name="l01284"></a>01284 <span class="stringliteral"></span>
<a name="l01285"></a>01285 <span class="stringliteral">    requirejs = topReq = newContext(&#39;_&#39;);</span>
<a name="l01286"></a>01286 <span class="stringliteral"></span>
<a name="l01287"></a>01287 <span class="stringliteral">    if (typeof require !== &#39;function&#39;) {</span>
<a name="l01288"></a>01288 <span class="stringliteral">        require = topReq;</span>
<a name="l01289"></a>01289 <span class="stringliteral">    }</span>
<a name="l01290"></a>01290 <span class="stringliteral"></span>
<a name="l01297"></a>01297 <span class="stringliteral">    topReq.exec = function (text) {</span>
<a name="l01298"></a>01298 <span class="stringliteral">        /*jslint evil: true */</span>
<a name="l01299"></a>01299 <span class="stringliteral">        return eval(text);</span>
<a name="l01300"></a>01300 <span class="stringliteral">    };</span>
<a name="l01301"></a>01301 <span class="stringliteral"></span>
<a name="l01302"></a>01302 <span class="stringliteral">    topReq.contexts = contexts;</span>
<a name="l01303"></a>01303 <span class="stringliteral"></span>
<a name="l01304"></a>01304 <span class="stringliteral">    define = function () {</span>
<a name="l01305"></a>01305 <span class="stringliteral">        queue.push([].slice.call(arguments, 0));</span>
<a name="l01306"></a>01306 <span class="stringliteral">    };</span>
<a name="l01307"></a>01307 <span class="stringliteral"></span>
<a name="l01308"></a>01308 <span class="stringliteral">    define.amd = {</span>
<a name="l01309"></a>01309 <span class="stringliteral">        jQuery: true</span>
<a name="l01310"></a>01310 <span class="stringliteral">    };</span>
<a name="l01311"></a>01311 <span class="stringliteral"></span>
<a name="l01312"></a>01312 <span class="stringliteral">    if (bootstrapConfig) {</span>
<a name="l01313"></a>01313 <span class="stringliteral">        topReq.config(bootstrapConfig);</span>
<a name="l01314"></a>01314 <span class="stringliteral">    }</span>
<a name="l01315"></a>01315 <span class="stringliteral"></span>
<a name="l01316"></a>01316 <span class="stringliteral">    //data-main support.</span>
<a name="l01317"></a>01317 <span class="stringliteral">    if (topReq.isBrowser) {</span>
<a name="l01318"></a>01318 <span class="stringliteral">        dataMain = document.querySelectorAll(&#39;script[data-main]&#39;)[0];</span>
<a name="l01319"></a>01319 <span class="stringliteral">        dataMain = dataMain &amp;&amp; dataMain.getAttribute(&#39;data-main&#39;);</span>
<a name="l01320"></a>01320 <span class="stringliteral">        if (dataMain) {</span>
<a name="l01321"></a>01321 <span class="stringliteral">            //Strip off any trailing .js since dataMain is now</span>
<a name="l01322"></a>01322 <span class="stringliteral">            //like a module name.</span>
<a name="l01323"></a>01323 <span class="stringliteral">            dataMain = dataMain.replace(jsSuffixRegExp, &#39;&#39;);</span>
<a name="l01324"></a>01324 <span class="stringliteral">            topReq([dataMain]);</span>
<a name="l01325"></a>01325 <span class="stringliteral">        }</span>
<a name="l01326"></a>01326 <span class="stringliteral">    }</span>
<a name="l01327"></a>01327 <span class="stringliteral">}(this));</span>
<a name="l01328"></a>01328 <span class="stringliteral"></span>
<a name="l01329"></a>01329 <span class="stringliteral">define(&quot;</span>alameda<span class="stringliteral">&quot;, function(){});</span>
<a name="l01330"></a>01330 <span class="stringliteral"></span>
<a name="l01331"></a><a class="code" href="../../de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a95d4cee469e101f76a52694f13905717">01331</a> <span class="stringliteral">var window = self;</span>
<a name="l01332"></a>01332 <span class="stringliteral"></span>
<a name="l01333"></a><a class="code" href="../../de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#acca0830549ecf3f74253c2e401a9dda2">01333</a> <span class="stringliteral">function consoleHelper() {</span>
<a name="l01334"></a>01334 <span class="stringliteral">  var msg = arguments[0] + &#39;:&#39;;</span>
<a name="l01335"></a>01335 <span class="stringliteral">  for (var i = 1; i &lt; arguments.length; i++) {</span>
<a name="l01336"></a>01336 <span class="stringliteral">    msg += &#39; &#39; + arguments[i];</span>
<a name="l01337"></a>01337 <span class="stringliteral">  }</span>
<a name="l01338"></a>01338 <span class="stringliteral">  msg += &#39;\x1b[0m\n&#39;;</span>
<a name="l01339"></a>01339 <span class="stringliteral">  dump(msg);</span>
<a name="l01340"></a>01340 <span class="stringliteral">}</span>
<a name="l01341"></a><a class="code" href="../../de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a6ea122aab27d049c3c34b20c1e0c9ba7">01341</a> <span class="stringliteral">window.console = {</span>
<a name="l01342"></a>01342 <span class="stringliteral">  log: consoleHelper.bind(null, &#39;\x1b[32mWLOG&#39;),</span>
<a name="l01343"></a>01343 <span class="stringliteral">  error: consoleHelper.bind(null, &#39;\x1b[31mWERR&#39;),</span>
<a name="l01344"></a>01344 <span class="stringliteral">  info: consoleHelper.bind(null, &#39;\x1b[36mWINF&#39;),</span>
<a name="l01345"></a>01345 <span class="stringliteral">  warn: consoleHelper.bind(null, &#39;\x1b[33mWWAR&#39;)</span>
<a name="l01346"></a>01346 <span class="stringliteral">};</span>
<a name="l01347"></a>01347 <span class="stringliteral"></span>
<a name="l01348"></a><a class="code" href="../../de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">01348</a> <span class="stringliteral">var document = { cookie: null };</span>
<a name="l01349"></a>01349 <span class="stringliteral"></span>
<a name="l01350"></a>01350 <span class="stringliteral">define(&quot;</span>mailapi/worker-bootstrap<span class="stringliteral">&quot;, function(){});</span>
<a name="l01351"></a>01351 <span class="stringliteral"></span>
<a name="l01352"></a>01352 <span class="stringliteral">// set location of dynamically loaded layers.</span>
<a name="l01353"></a>01353 <span class="stringliteral">require.config({</span>
<a name="l01354"></a>01354 <span class="stringliteral">  baseUrl: &#39;..&#39;,</span>
<a name="l01355"></a>01355 <span class="stringliteral">  paths: {</span>
<a name="l01356"></a>01356 <span class="stringliteral">    // mailcomposer is in the mailapi/composer layer.</span>
<a name="l01357"></a>01357 <span class="stringliteral">    mailcomposer: &#39;mailapi/composer&#39;,</span>
<a name="l01358"></a>01358 <span class="stringliteral"></span>
<a name="l01359"></a>01359 <span class="stringliteral">    // Point activesync protocol modules to their layer</span>
<a name="l01360"></a>01360 <span class="stringliteral">    &#39;wbxml&#39;: &#39;mailapi/activesync/protocollayer&#39;,</span>
<a name="l01361"></a>01361 <span class="stringliteral">    &#39;activesync/codepages&#39;: &#39;mailapi/activesync/protocollayer&#39;,</span>
<a name="l01362"></a>01362 <span class="stringliteral">    &#39;activesync/protocol&#39;: &#39;mailapi/activesync/protocollayer&#39;,</span>
<a name="l01363"></a>01363 <span class="stringliteral"></span>
<a name="l01364"></a>01364 <span class="stringliteral">    // activesync/codepages is split across two layers. If</span>
<a name="l01365"></a>01365 <span class="stringliteral">    // activesync/protocol loads first (for autoconfig work on account setup),</span>
<a name="l01366"></a>01366 <span class="stringliteral">    // then indicate the parts of codepages that are in activesync/configurator</span>
<a name="l01367"></a>01367 <span class="stringliteral">    &#39;activesync/codepages/FolderHierarchy&#39;:</span>
<a name="l01368"></a>01368 <span class="stringliteral">                                      &#39;mailapi/activesync/configurator&#39;,</span>
<a name="l01369"></a>01369 <span class="stringliteral">    &#39;activesync/codepages/ComposeMail&#39;:</span>
<a name="l01370"></a>01370 <span class="stringliteral">                                      &#39;mailapi/activesync/configurator&#39;,</span>
<a name="l01371"></a>01371 <span class="stringliteral">    &#39;activesync/codepages/AirSync&#39;:</span>
<a name="l01372"></a>01372 <span class="stringliteral">                                      &#39;mailapi/activesync/configurator&#39;,</span>
<a name="l01373"></a>01373 <span class="stringliteral">    &#39;activesync/codepages/AirSyncBase&#39;:</span>
<a name="l01374"></a>01374 <span class="stringliteral">                                      &#39;mailapi/activesync/configurator&#39;,</span>
<a name="l01375"></a>01375 <span class="stringliteral">    &#39;activesync/codepages/ItemEstimate&#39;:</span>
<a name="l01376"></a>01376 <span class="stringliteral">                                      &#39;mailapi/activesync/configurator&#39;,</span>
<a name="l01377"></a>01377 <span class="stringliteral">    &#39;activesync/codepages/Email&#39;:</span>
<a name="l01378"></a>01378 <span class="stringliteral">                                      &#39;mailapi/activesync/configurator&#39;,</span>
<a name="l01379"></a>01379 <span class="stringliteral">    &#39;activesync/codepages/ItemOperations&#39;:</span>
<a name="l01380"></a>01380 <span class="stringliteral">                                      &#39;mailapi/activesync/configurator&#39;,</span>
<a name="l01381"></a>01381 <span class="stringliteral">    &#39;activesync/codepages/Move&#39;:</span>
<a name="l01382"></a>01382 <span class="stringliteral">                                      &#39;mailapi/activesync/configurator&#39;,</span>
<a name="l01383"></a>01383 <span class="stringliteral"></span>
<a name="l01384"></a>01384 <span class="stringliteral">    // Point chew methods to the chew layer</span>
<a name="l01385"></a>01385 <span class="stringliteral">    &#39;mailapi/htmlchew&#39;: &#39;mailapi/chewlayer&#39;,</span>
<a name="l01386"></a>01386 <span class="stringliteral">    &#39;mailapi/quotechew&#39;: &#39;mailapi/chewlayer&#39;,</span>
<a name="l01387"></a>01387 <span class="stringliteral">    &#39;mailapi/mailchew&#39;: &#39;mailapi/chewlayer&#39;,</span>
<a name="l01388"></a>01388 <span class="stringliteral">    &#39;mailapi/imap/imapchew&#39;: &#39;mailapi/chewlayer&#39;,</span>
<a name="l01389"></a>01389 <span class="stringliteral"></span>
<a name="l01390"></a>01390 <span class="stringliteral">    // Imap body fetching / parsing / sync</span>
<a name="l01391"></a>01391 <span class="stringliteral">    &#39;mailapi/imap/protocol/sync&#39;: &#39;mailapi/imap/protocollayer&#39;,</span>
<a name="l01392"></a>01392 <span class="stringliteral">    &#39;mailapi/imap/protocol/textparser&#39;: &#39;mailapi/imap/protocollayer&#39;,</span>
<a name="l01393"></a>01393 <span class="stringliteral">    &#39;mailapi/imap/protocol/snippetparser&#39;: &#39;mailapi/imap/protocollayer&#39;,</span>
<a name="l01394"></a>01394 <span class="stringliteral">    &#39;mailapi/imap/protocol/bodyfetcher&#39;: &#39;mailapi/imap/protocollayer&#39;,</span>
<a name="l01395"></a>01395 <span class="stringliteral"></span>
<a name="l01396"></a>01396 <span class="stringliteral">    // &#39;tls&#39; is actually in both the SMTP probe and IMAP probe, but the SMTP</span>
<a name="l01397"></a>01397 <span class="stringliteral">    // probe is much smaller, so if someone requests it outright, just use that.</span>
<a name="l01398"></a>01398 <span class="stringliteral">    &#39;tls&#39;: &#39;mailapi/smtp/probe&#39;,</span>
<a name="l01399"></a>01399 <span class="stringliteral"></span>
<a name="l01400"></a>01400 <span class="stringliteral">    // The imap probe layer also contains the imap module</span>
<a name="l01401"></a>01401 <span class="stringliteral">    &#39;imap&#39;: &#39;mailapi/imap/probe&#39;,</span>
<a name="l01402"></a>01402 <span class="stringliteral"></span>
<a name="l01403"></a>01403 <span class="stringliteral">    // The smtp probe layer also contains the simpleclient</span>
<a name="l01404"></a>01404 <span class="stringliteral">    &#39;simplesmtp/lib/client&#39;: &#39;mailapi/smtp/probe&#39;</span>
<a name="l01405"></a>01405 <span class="stringliteral">  },</span>
<a name="l01406"></a>01406 <span class="stringliteral">  scriptType: &#39;application/javascript;version=1.8&#39;,</span>
<a name="l01407"></a>01407 <span class="stringliteral">  definePrim: &#39;prim&#39;</span>
<a name="l01408"></a>01408 <span class="stringliteral">});</span>
<a name="l01409"></a>01409 <span class="stringliteral"></span>
<a name="l01410"></a>01410 <span class="stringliteral">// q shim for rdcommon/log, just enough for it to</span>
<a name="l01411"></a>01411 <span class="stringliteral">// work. Just uses defer, promise, resolve and reject.</span>
<a name="l01412"></a>01412 <span class="stringliteral">define(&#39;q&#39;, [&#39;prim&#39;], function (prim) {</span>
<a name="l01413"></a>01413 <span class="stringliteral">  return {</span>
<a name="l01414"></a>01414 <span class="stringliteral">    defer: prim</span>
<a name="l01415"></a>01415 <span class="stringliteral">  };</span>
<a name="l01416"></a>01416 <span class="stringliteral">});</span>
<a name="l01417"></a>01417 <span class="stringliteral"></span>
<a name="l01418"></a>01418 <span class="stringliteral"></span>
<a name="l01419"></a>01419 <span class="stringliteral">define(&quot;</span><a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a><span class="stringliteral">&quot;, function(){});</span>
<a name="l01420"></a>01420 <span class="stringliteral"></span>
<a name="l01432"></a>01432 <span class="stringliteral">define(&#39;buffer&#39;,[&#39;require&#39;,&#39;exports&#39;,&#39;module&#39;],function(require, exports, module) {</span>
<a name="l01433"></a>01433 <span class="stringliteral"></span>
<a name="l01434"></a>01434 <span class="stringliteral">function coerce(length) {</span>
<a name="l01435"></a>01435 <span class="stringliteral">  // Coerce length to a number (possibly NaN), round up</span>
<a name="l01436"></a>01436 <span class="stringliteral">  // in case it&#39;s fractional (e.g. 123.456) then do a</span>
<a name="l01437"></a>01437 <span class="stringliteral">  // double negate to coerce a NaN to 0. Easy, right?</span>
<a name="l01438"></a>01438 <span class="stringliteral">  length = ~~Math.ceil(+length);</span>
<a name="l01439"></a>01439 <span class="stringliteral">  return length &lt; 0 ? 0 : length;</span>
<a name="l01440"></a>01440 <span class="stringliteral">}</span>
<a name="l01441"></a>01441 <span class="stringliteral"></span>
<a name="l01442"></a>01442 <span class="stringliteral">var ENCODER_OPTIONS = { fatal: false };</span>
<a name="l01443"></a>01443 <span class="stringliteral"></span>
<a name="l01454"></a>01454 <span class="stringliteral">function safeBase64DecodeToArray(s) {</span>
<a name="l01455"></a>01455 <span class="stringliteral">  var bitsSoFar = 0, validBits = 0, iOut = 0,</span>
<a name="l01456"></a>01456 <span class="stringliteral">      arr = new Uint8Array(Math.ceil(s.length * 3 / 4));</span>
<a name="l01457"></a>01457 <span class="stringliteral">  for (var i = 0; i &lt; s.length; i++) {</span>
<a name="l01458"></a>01458 <span class="stringliteral">    var c = s.charCodeAt(i), bits;</span>
<a name="l01459"></a>01459 <span class="stringliteral">    if (c &gt;= 65 &amp;&amp; c &lt;= 90) // [A-Z]</span>
<a name="l01460"></a>01460 <span class="stringliteral">      bits = c - 65;</span>
<a name="l01461"></a>01461 <span class="stringliteral">    else if (c &gt;= 97 &amp;&amp; c &lt;= 122) // [a-z]</span>
<a name="l01462"></a>01462 <span class="stringliteral">      bits = c - 97 + 26;</span>
<a name="l01463"></a>01463 <span class="stringliteral">    else if (c &gt;= 48 &amp;&amp; c &lt;= 57) // [0-9]</span>
<a name="l01464"></a>01464 <span class="stringliteral">      bits = c - 48 + 52;</span>
<a name="l01465"></a>01465 <span class="stringliteral">    else if (c === 43) // +</span>
<a name="l01466"></a>01466 <span class="stringliteral">      bits = 62;</span>
<a name="l01467"></a>01467 <span class="stringliteral">    else if (c === 47) // /</span>
<a name="l01468"></a>01468 <span class="stringliteral">      bits = 63;</span>
<a name="l01469"></a>01469 <span class="stringliteral">    else if (c === 61) { // =</span>
<a name="l01470"></a>01470 <span class="stringliteral">      validBits = 0;</span>
<a name="l01471"></a>01471 <span class="stringliteral">      continue;</span>
<a name="l01472"></a>01472 <span class="stringliteral">    }</span>
<a name="l01473"></a>01473 <span class="stringliteral">    // ignore all other characters!</span>
<a name="l01474"></a>01474 <span class="stringliteral">    else</span>
<a name="l01475"></a>01475 <span class="stringliteral">      continue;</span>
<a name="l01476"></a>01476 <span class="stringliteral">    bitsSoFar = (bitsSoFar &lt;&lt; 6) | bits;</span>
<a name="l01477"></a>01477 <span class="stringliteral">    validBits += 6;</span>
<a name="l01478"></a>01478 <span class="stringliteral">    if (validBits &gt;= 8) {</span>
<a name="l01479"></a>01479 <span class="stringliteral">      validBits -= 8;</span>
<a name="l01480"></a>01480 <span class="stringliteral">      arr[iOut++] = bitsSoFar &gt;&gt; validBits;</span>
<a name="l01481"></a>01481 <span class="stringliteral">      if (validBits === 2)</span>
<a name="l01482"></a>01482 <span class="stringliteral">        bitsSoFar &amp;= 0x3;</span>
<a name="l01483"></a>01483 <span class="stringliteral">      else if (validBits === 4)</span>
<a name="l01484"></a>01484 <span class="stringliteral">        bitsSoFar &amp;= 0xf;</span>
<a name="l01485"></a>01485 <span class="stringliteral">    }</span>
<a name="l01486"></a>01486 <span class="stringliteral">  }</span>
<a name="l01487"></a>01487 <span class="stringliteral"></span>
<a name="l01488"></a>01488 <span class="stringliteral">  if (iOut &lt; arr.length)</span>
<a name="l01489"></a>01489 <span class="stringliteral">    return arr.subarray(0, iOut);</span>
<a name="l01490"></a>01490 <span class="stringliteral">  return arr;</span>
<a name="l01491"></a>01491 <span class="stringliteral">}</span>
<a name="l01492"></a>01492 <span class="stringliteral"></span>
<a name="l01498"></a>01498 <span class="stringliteral">function encode(string, encoding) {</span>
<a name="l01499"></a>01499 <span class="stringliteral">  var buf, i;</span>
<a name="l01500"></a>01500 <span class="stringliteral">  switch (encoding) {</span>
<a name="l01501"></a>01501 <span class="stringliteral">    case &#39;base64&#39;:</span>
<a name="l01502"></a>01502 <span class="stringliteral">      buf = safeBase64DecodeToArray(string);</span>
<a name="l01503"></a>01503 <span class="stringliteral">      return buf;</span>
<a name="l01504"></a>01504 <span class="stringliteral">    case &#39;binary&#39;:</span>
<a name="l01505"></a>01505 <span class="stringliteral">      buf = new Uint8Array(string.length);</span>
<a name="l01506"></a>01506 <span class="stringliteral">      for (i = 0; i &lt; string.length; i++) {</span>
<a name="l01507"></a>01507 <span class="stringliteral">        buf[i] = string.charCodeAt(i);</span>
<a name="l01508"></a>01508 <span class="stringliteral">      }</span>
<a name="l01509"></a>01509 <span class="stringliteral">      return buf;</span>
<a name="l01510"></a>01510 <span class="stringliteral">    case &#39;hex&#39;:</span>
<a name="l01511"></a>01511 <span class="stringliteral">      buf = new Uint8Array(string.length * 2);</span>
<a name="l01512"></a>01512 <span class="stringliteral">      for (i = 0; i &lt; string.length; i++) {</span>
<a name="l01513"></a>01513 <span class="stringliteral">        var c = string.charCodeAt(i), nib;</span>
<a name="l01514"></a>01514 <span class="stringliteral">        nib = c &gt;&gt; 4;</span>
<a name="l01515"></a>01515 <span class="stringliteral">        buf[i*2] = (nib &lt; 10) ? (nib + 48) : (nib - 10 + 97);</span>
<a name="l01516"></a>01516 <span class="stringliteral">        nib = c &amp; 0xf;</span>
<a name="l01517"></a>01517 <span class="stringliteral">        buf[i*2 + 1] = (nib &lt; 10) ? (nib + 48) : (nib - 10 + 97);</span>
<a name="l01518"></a>01518 <span class="stringliteral">      }</span>
<a name="l01519"></a>01519 <span class="stringliteral">      return buf;</span>
<a name="l01520"></a>01520 <span class="stringliteral">    // need to normalize the name (for now at least)</span>
<a name="l01521"></a>01521 <span class="stringliteral">    case &#39;utf8&#39;:</span>
<a name="l01522"></a>01522 <span class="stringliteral">      encoding = &#39;utf-8&#39;;</span>
<a name="l01523"></a>01523 <span class="stringliteral">    default:</span>
<a name="l01524"></a>01524 <span class="stringliteral">      if (!encoding)</span>
<a name="l01525"></a>01525 <span class="stringliteral">        encoding = &#39;utf-8&#39;;</span>
<a name="l01526"></a>01526 <span class="stringliteral">      return TextEncoder(encoding, ENCODER_OPTIONS).encode(string);</span>
<a name="l01527"></a>01527 <span class="stringliteral">  }</span>
<a name="l01528"></a>01528 <span class="stringliteral">}</span>
<a name="l01529"></a>01529 <span class="stringliteral"></span>
<a name="l01535"></a>01535 <span class="stringliteral">function decode(view, encoding) {</span>
<a name="l01536"></a>01536 <span class="stringliteral">  var sbits, i;</span>
<a name="l01537"></a>01537 <span class="stringliteral">  switch (encoding) {</span>
<a name="l01538"></a>01538 <span class="stringliteral">    case &#39;base64&#39;:</span>
<a name="l01539"></a>01539 <span class="stringliteral">      // base64 wants a string, so go through binary first...</span>
<a name="l01540"></a>01540 <span class="stringliteral">    case &#39;binary&#39;:</span>
<a name="l01541"></a>01541 <span class="stringliteral">      sbits = new Array(view.length);</span>
<a name="l01542"></a>01542 <span class="stringliteral">      for (i = 0; i &lt; view.length; i++) {</span>
<a name="l01543"></a>01543 <span class="stringliteral">        sbits[i] = String.fromCharCode(view[i]);</span>
<a name="l01544"></a>01544 <span class="stringliteral">      }</span>
<a name="l01545"></a>01545 <span class="stringliteral">      // (btoa is binary JS string -&gt; base64 ASCII string)</span>
<a name="l01546"></a>01546 <span class="stringliteral">      if (encoding === &#39;base64&#39;)</span>
<a name="l01547"></a>01547 <span class="stringliteral">        return window.btoa(sbits.join(&#39;&#39;));</span>
<a name="l01548"></a>01548 <span class="stringliteral">      return sbits.join(&#39;&#39;);</span>
<a name="l01549"></a>01549 <span class="stringliteral">    case &#39;hex&#39;:</span>
<a name="l01550"></a>01550 <span class="stringliteral">      sbits = new Array(view.length / 2);</span>
<a name="l01551"></a>01551 <span class="stringliteral">      for (i = 0; i &lt; view.length; i += 2) {</span>
<a name="l01552"></a>01552 <span class="stringliteral">        var nib = view[i], c;</span>
<a name="l01553"></a>01553 <span class="stringliteral">        if (nib &lt;= 57)</span>
<a name="l01554"></a>01554 <span class="stringliteral">          c = 16 * (nib - 48);</span>
<a name="l01555"></a>01555 <span class="stringliteral">        else if (nib &lt; 97)</span>
<a name="l01556"></a>01556 <span class="stringliteral">          c = 16 * (nib - 64 + 10);</span>
<a name="l01557"></a>01557 <span class="stringliteral">        else</span>
<a name="l01558"></a>01558 <span class="stringliteral">          c = 16 * (nib - 97 + 10);</span>
<a name="l01559"></a>01559 <span class="stringliteral">        nib = view[i+1];</span>
<a name="l01560"></a>01560 <span class="stringliteral">        if (nib &lt;= 57)</span>
<a name="l01561"></a>01561 <span class="stringliteral">          c += (nib - 48);</span>
<a name="l01562"></a>01562 <span class="stringliteral">        else if (nib &lt; 97)</span>
<a name="l01563"></a>01563 <span class="stringliteral">          c += (nib - 64 + 10);</span>
<a name="l01564"></a>01564 <span class="stringliteral">        else</span>
<a name="l01565"></a>01565 <span class="stringliteral">          c += (nib - 97 + 10);</span>
<a name="l01566"></a>01566 <span class="stringliteral">        sbits.push(String.fromCharCode(c));</span>
<a name="l01567"></a>01567 <span class="stringliteral">      }</span>
<a name="l01568"></a>01568 <span class="stringliteral">      return sbits.join(&#39;&#39;);</span>
<a name="l01569"></a>01569 <span class="stringliteral">    // need to normalize the name (for now at least)</span>
<a name="l01570"></a>01570 <span class="stringliteral">    case &#39;utf8&#39;:</span>
<a name="l01571"></a>01571 <span class="stringliteral">      encoding = &#39;utf-8&#39;;</span>
<a name="l01572"></a>01572 <span class="stringliteral">    default:</span>
<a name="l01573"></a>01573 <span class="stringliteral">      if (!encoding)</span>
<a name="l01574"></a>01574 <span class="stringliteral">        encoding = &#39;utf-8&#39;;</span>
<a name="l01575"></a>01575 <span class="stringliteral">      return TextDecoder(encoding, ENCODER_OPTIONS).decode(view);</span>
<a name="l01576"></a>01576 <span class="stringliteral">  }</span>
<a name="l01577"></a>01577 <span class="stringliteral">}</span>
<a name="l01578"></a>01578 <span class="stringliteral"></span>
<a name="l01583"></a>01583 <span class="stringliteral">function Buffer(subject, encoding, offset) {</span>
<a name="l01584"></a>01584 <span class="stringliteral">  // The actual buffer that will become &#39;this&#39;.</span>
<a name="l01585"></a>01585 <span class="stringliteral">  var buf;</span>
<a name="l01586"></a>01586 <span class="stringliteral">  var type;</span>
<a name="l01587"></a>01587 <span class="stringliteral"></span>
<a name="l01588"></a>01588 <span class="stringliteral">  // Are we slicing?</span>
<a name="l01589"></a>01589 <span class="stringliteral">  if (typeof offset === &#39;number&#39;) {</span>
<a name="l01590"></a>01590 <span class="stringliteral">    // create a sub-view</span>
<a name="l01591"></a>01591 <span class="stringliteral">    buf = subject.subarray(offset, coerce(encoding) + offset);</span>
<a name="l01592"></a>01592 <span class="stringliteral">  } else {</span>
<a name="l01593"></a>01593 <span class="stringliteral">    // Find the length</span>
<a name="l01594"></a>01594 <span class="stringliteral">    switch (type = typeof subject) {</span>
<a name="l01595"></a>01595 <span class="stringliteral">      case &#39;number&#39;:</span>
<a name="l01596"></a>01596 <span class="stringliteral">        buf = new Uint8Array(coerce(subject));</span>
<a name="l01597"></a>01597 <span class="stringliteral">        break;</span>
<a name="l01598"></a>01598 <span class="stringliteral"></span>
<a name="l01599"></a>01599 <span class="stringliteral">      case &#39;string&#39;:</span>
<a name="l01600"></a>01600 <span class="stringliteral">        buf = encode(subject, encoding);</span>
<a name="l01601"></a>01601 <span class="stringliteral">        break;</span>
<a name="l01602"></a>01602 <span class="stringliteral"></span>
<a name="l01603"></a>01603 <span class="stringliteral">      case &#39;object&#39;: // Assume object is an array</span>
<a name="l01604"></a>01604 <span class="stringliteral">        // only use it verbatim if it&#39;s a buffer and we see it as such (aka</span>
<a name="l01605"></a>01605 <span class="stringliteral">        // it&#39;s from our compartment)</span>
<a name="l01606"></a>01606 <span class="stringliteral">        if (buf instanceof Uint8Array)</span>
<a name="l01607"></a>01607 <span class="stringliteral">          buf = subject;</span>
<a name="l01608"></a>01608 <span class="stringliteral">        else</span>
<a name="l01609"></a>01609 <span class="stringliteral">          buf = new Uint8Array(subject);</span>
<a name="l01610"></a>01610 <span class="stringliteral">        break;</span>
<a name="l01611"></a>01611 <span class="stringliteral"></span>
<a name="l01612"></a>01612 <span class="stringliteral">      default:</span>
<a name="l01613"></a>01613 <span class="stringliteral">        throw new Error(&#39;First argument needs to be a number, &#39; +</span>
<a name="l01614"></a>01614 <span class="stringliteral">                        &#39;array or string.&#39;);</span>
<a name="l01615"></a>01615 <span class="stringliteral">    }</span>
<a name="l01616"></a>01616 <span class="stringliteral">  }</span>
<a name="l01617"></a>01617 <span class="stringliteral"></span>
<a name="l01618"></a>01618 <span class="stringliteral">  // Return the mixed-in Uint8Array to be our &#39;this&#39;!</span>
<a name="l01619"></a>01619 <span class="stringliteral">  return buf;</span>
<a name="l01620"></a>01620 <span class="stringliteral">}</span>
<a name="l01621"></a>01621 <span class="stringliteral">exports.Buffer = Buffer;</span>
<a name="l01622"></a>01622 <span class="stringliteral"></span>
<a name="l01623"></a>01623 <span class="stringliteral">Buffer.byteLength = function Buffer_byteLength(string, encoding) {</span>
<a name="l01624"></a>01624 <span class="stringliteral">  var buf = encode(string, encoding);</span>
<a name="l01625"></a>01625 <span class="stringliteral">  return buf.length;</span>
<a name="l01626"></a>01626 <span class="stringliteral">};</span>
<a name="l01627"></a>01627 <span class="stringliteral"></span>
<a name="l01628"></a>01628 <span class="stringliteral">Buffer.isBuffer = function Buffer_isBuffer(obj) {</span>
<a name="l01629"></a>01629 <span class="stringliteral">  return ((obj instanceof Uint8Array) &amp;&amp;</span>
<a name="l01630"></a>01630 <span class="stringliteral">          obj.copy === BufferPrototype.copy);</span>
<a name="l01631"></a>01631 <span class="stringliteral">};</span>
<a name="l01632"></a>01632 <span class="stringliteral"></span>
<a name="l01633"></a>01633 <span class="stringliteral">// POSSIBLY SUBTLE AND DANGEROUS THING: We are actually clobbering stuff onto</span>
<a name="l01634"></a>01634 <span class="stringliteral">// the Uint8Array prototype.  We do this because we&#39;re not allowed to mix our</span>
<a name="l01635"></a>01635 <span class="stringliteral">// contributions onto the instance types, leaving us only able to mess with</span>
<a name="l01636"></a>01636 <span class="stringliteral">// the prototype.  This obviously may affect other consumers of Uint8Array</span>
<a name="l01637"></a>01637 <span class="stringliteral">// operating in the same global-space.</span>
<a name="l01638"></a>01638 <span class="stringliteral">var BufferPrototype = Uint8Array.prototype;</span>
<a name="l01639"></a>01639 <span class="stringliteral"></span>
<a name="l01640"></a>01640 <span class="stringliteral">BufferPrototype.copy = function(target, target_start, start, end) {</span>
<a name="l01641"></a>01641 <span class="stringliteral">  var source = this;</span>
<a name="l01642"></a>01642 <span class="stringliteral">  start || (start = 0);</span>
<a name="l01643"></a>01643 <span class="stringliteral">  end || (end = this.length);</span>
<a name="l01644"></a>01644 <span class="stringliteral">  target_start || (target_start = 0);</span>
<a name="l01645"></a>01645 <span class="stringliteral"></span>
<a name="l01646"></a>01646 <span class="stringliteral">  if (end &lt; start) throw new Error(&#39;sourceEnd &lt; sourceStart&#39;);</span>
<a name="l01647"></a>01647 <span class="stringliteral"></span>
<a name="l01648"></a>01648 <span class="stringliteral">  // Copy 0 bytes; we&#39;re done</span>
<a name="l01649"></a>01649 <span class="stringliteral">  if (end === start) return;</span>
<a name="l01650"></a>01650 <span class="stringliteral">  if (target.length == 0 || source.length == 0) return;</span>
<a name="l01651"></a>01651 <span class="stringliteral"></span>
<a name="l01652"></a>01652 <span class="stringliteral">  if (target_start &lt; 0 || target_start &gt;= target.length) {</span>
<a name="l01653"></a>01653 <span class="stringliteral">    throw new Error(&#39;targetStart out of bounds&#39;);</span>
<a name="l01654"></a>01654 <span class="stringliteral">  }</span>
<a name="l01655"></a>01655 <span class="stringliteral"></span>
<a name="l01656"></a>01656 <span class="stringliteral">  if (start &lt; 0 || start &gt;= source.length) {</span>
<a name="l01657"></a>01657 <span class="stringliteral">    throw new Error(&#39;sourceStart out of bounds&#39;);</span>
<a name="l01658"></a>01658 <span class="stringliteral">  }</span>
<a name="l01659"></a>01659 <span class="stringliteral"></span>
<a name="l01660"></a>01660 <span class="stringliteral">  if (end &lt; 0 || end &gt; source.length) {</span>
<a name="l01661"></a>01661 <span class="stringliteral">    throw new Error(&#39;sourceEnd out of bounds&#39;);</span>
<a name="l01662"></a>01662 <span class="stringliteral">  }</span>
<a name="l01663"></a>01663 <span class="stringliteral"></span>
<a name="l01664"></a>01664 <span class="stringliteral">  // Are we oob?</span>
<a name="l01665"></a>01665 <span class="stringliteral">  if (end &gt; this.length) {</span>
<a name="l01666"></a>01666 <span class="stringliteral">    end = this.length;</span>
<a name="l01667"></a>01667 <span class="stringliteral">  }</span>
<a name="l01668"></a>01668 <span class="stringliteral"></span>
<a name="l01669"></a>01669 <span class="stringliteral">  if (target.length - target_start &lt; end - start) {</span>
<a name="l01670"></a>01670 <span class="stringliteral">    end = target.length - target_start + start;</span>
<a name="l01671"></a>01671 <span class="stringliteral">  }</span>
<a name="l01672"></a>01672 <span class="stringliteral"></span>
<a name="l01673"></a>01673 <span class="stringliteral">  for (var i = start; i &lt; end; i++) {</span>
<a name="l01674"></a>01674 <span class="stringliteral">    target[i + target_start] = this[i];</span>
<a name="l01675"></a>01675 <span class="stringliteral">  }</span>
<a name="l01676"></a>01676 <span class="stringliteral">};</span>
<a name="l01677"></a>01677 <span class="stringliteral"></span>
<a name="l01678"></a>01678 <span class="stringliteral">BufferPrototype.slice = function(start, end) {</span>
<a name="l01679"></a>01679 <span class="stringliteral">  if (end === undefined) end = this.length;</span>
<a name="l01680"></a>01680 <span class="stringliteral"></span>
<a name="l01681"></a>01681 <span class="stringliteral">  if (end &gt; this.length) {</span>
<a name="l01682"></a>01682 <span class="stringliteral">    throw new Error(&#39;oob&#39;);</span>
<a name="l01683"></a>01683 <span class="stringliteral">  }</span>
<a name="l01684"></a>01684 <span class="stringliteral">  if (start &gt; end) {</span>
<a name="l01685"></a>01685 <span class="stringliteral">    throw new Error(&#39;oob&#39;);</span>
<a name="l01686"></a>01686 <span class="stringliteral">  }</span>
<a name="l01687"></a>01687 <span class="stringliteral">  return Buffer(this, end - start, +start);</span>
<a name="l01688"></a>01688 <span class="stringliteral">};</span>
<a name="l01689"></a>01689 <span class="stringliteral"></span>
<a name="l01695"></a>01695 <span class="stringliteral">BufferPrototype.toString = function(encoding, start, end) {</span>
<a name="l01696"></a>01696 <span class="stringliteral">  encoding = String(encoding || &#39;utf-8&#39;).toLowerCase();</span>
<a name="l01697"></a>01697 <span class="stringliteral">  start = +start || 0;</span>
<a name="l01698"></a>01698 <span class="stringliteral">  if (typeof end == &#39;undefined&#39;) end = this.length;</span>
<a name="l01699"></a>01699 <span class="stringliteral"></span>
<a name="l01700"></a>01700 <span class="stringliteral">  // Fastpath empty strings</span>
<a name="l01701"></a>01701 <span class="stringliteral">  if (+end == start) {</span>
<a name="l01702"></a>01702 <span class="stringliteral">    return &#39;&#39;;</span>
<a name="l01703"></a>01703 <span class="stringliteral">  }</span>
<a name="l01704"></a>01704 <span class="stringliteral">  if (start === 0 &amp;&amp; end === this.length)</span>
<a name="l01705"></a>01705 <span class="stringliteral">    return decode(this, encoding);</span>
<a name="l01706"></a>01706 <span class="stringliteral">  else</span>
<a name="l01707"></a>01707 <span class="stringliteral">    return decode(this.subarray(start, end), encoding);</span>
<a name="l01708"></a>01708 <span class="stringliteral">  // In case things get slow again, comment the above block and uncomment:</span>
<a name="l01709"></a>01709 <span class="stringliteral">/*</span>
<a name="l01710"></a>01710 <span class="stringliteral">var rval, before = Date.now();</span>
<a name="l01711"></a>01711 <span class="stringliteral">  if (start === 0 &amp;&amp; end === this.length)</span>
<a name="l01712"></a>01712 <span class="stringliteral">    rval = decode(this, encoding);</span>
<a name="l01713"></a>01713 <span class="stringliteral">  else</span>
<a name="l01714"></a>01714 <span class="stringliteral">    rval = decode(this.subarray(start, end), encoding);</span>
<a name="l01715"></a>01715 <span class="stringliteral">  var delta = Date.now() - before;</span>
<a name="l01716"></a>01716 <span class="stringliteral">  if (delta &gt; 2)</span>
<a name="l01717"></a>01717 <span class="stringliteral">    console.error(&#39;SLOWDECODE&#39;, delta, end - start, encoding);</span>
<a name="l01718"></a>01718 <span class="stringliteral">  return rval;</span>
<a name="l01719"></a>01719 <span class="stringliteral">*/</span>
<a name="l01720"></a>01720 <span class="stringliteral">};</span>
<a name="l01721"></a>01721 <span class="stringliteral"></span>
<a name="l01722"></a>01722 <span class="stringliteral">BufferPrototype.write  = function(string, offset, length, encoding) {</span>
<a name="l01723"></a>01723 <span class="stringliteral">  // Support both (string, offset, length, encoding)</span>
<a name="l01724"></a>01724 <span class="stringliteral">  // and the legacy (string, encoding, offset, length)</span>
<a name="l01725"></a>01725 <span class="stringliteral">  if (isFinite(offset)) {</span>
<a name="l01726"></a>01726 <span class="stringliteral">    if (!isFinite(length)) {</span>
<a name="l01727"></a>01727 <span class="stringliteral">      encoding = length;</span>
<a name="l01728"></a>01728 <span class="stringliteral">      length = undefined;</span>
<a name="l01729"></a>01729 <span class="stringliteral">    }</span>
<a name="l01730"></a>01730 <span class="stringliteral">  } else {  // legacy</span>
<a name="l01731"></a>01731 <span class="stringliteral">    var swap = encoding;</span>
<a name="l01732"></a>01732 <span class="stringliteral">    encoding = offset;</span>
<a name="l01733"></a>01733 <span class="stringliteral">    offset = length;</span>
<a name="l01734"></a>01734 <span class="stringliteral">    length = swap;</span>
<a name="l01735"></a>01735 <span class="stringliteral">  }</span>
<a name="l01736"></a>01736 <span class="stringliteral"></span>
<a name="l01737"></a>01737 <span class="stringliteral">  offset = +offset || 0;</span>
<a name="l01738"></a>01738 <span class="stringliteral">  var remaining = this.length - offset;</span>
<a name="l01739"></a>01739 <span class="stringliteral">  if (!length) {</span>
<a name="l01740"></a>01740 <span class="stringliteral">    length = remaining;</span>
<a name="l01741"></a>01741 <span class="stringliteral">  } else {</span>
<a name="l01742"></a>01742 <span class="stringliteral">    length = +length;</span>
<a name="l01743"></a>01743 <span class="stringliteral">    if (length &gt; remaining) {</span>
<a name="l01744"></a>01744 <span class="stringliteral">      length = remaining;</span>
<a name="l01745"></a>01745 <span class="stringliteral">    }</span>
<a name="l01746"></a>01746 <span class="stringliteral">  }</span>
<a name="l01747"></a>01747 <span class="stringliteral">  encoding = String(encoding || &#39;utf-8&#39;).toLowerCase();</span>
<a name="l01748"></a>01748 <span class="stringliteral"></span>
<a name="l01749"></a>01749 <span class="stringliteral">  var encoded = encode(string, encoding);</span>
<a name="l01750"></a>01750 <span class="stringliteral">  for (var i = 0; i &lt; encoded.length; i++)</span>
<a name="l01751"></a>01751 <span class="stringliteral">    this[i + offset] = encoded[i];</span>
<a name="l01752"></a>01752 <span class="stringliteral"></span>
<a name="l01753"></a>01753 <span class="stringliteral">  return encoded.length;</span>
<a name="l01754"></a>01754 <span class="stringliteral">};</span>
<a name="l01755"></a>01755 <span class="stringliteral"></span>
<a name="l01756"></a>01756 <span class="stringliteral">});</span>
<a name="l01757"></a>01757 <span class="stringliteral"></span>
<a name="l01762"></a>01762 <span class="stringliteral">(function () {</span>
<a name="l01763"></a>01763 <span class="stringliteral"></span>
<a name="l01764"></a>01764 <span class="stringliteral">// Like setTimeout, but only takes a function argument.  There&#39;s</span>
<a name="l01765"></a>01765 <span class="stringliteral">// no time argument (always zero) and no arguments (you have to</span>
<a name="l01766"></a>01766 <span class="stringliteral">// use a closure).</span>
<a name="l01767"></a>01767 <span class="stringliteral">function setZeroTimeout(fn) {</span>
<a name="l01768"></a>01768 <span class="stringliteral">  setTimeout(fn);</span>
<a name="l01769"></a>01769 <span class="stringliteral">}</span>
<a name="l01770"></a>01770 <span class="stringliteral"></span>
<a name="l01771"></a>01771 <span class="stringliteral">// Add the one thing we want added to the window object.</span>
<a name="l01772"></a>01772 <span class="stringliteral">window.setZeroTimeout = setZeroTimeout;</span>
<a name="l01773"></a>01773 <span class="stringliteral"></span>
<a name="l01774"></a>01774 <span class="stringliteral">window.process = {</span>
<a name="l01775"></a>01775 <span class="stringliteral">  immediate: false,</span>
<a name="l01776"></a>01776 <span class="stringliteral">  nextTick: function(cb) {</span>
<a name="l01777"></a>01777 <span class="stringliteral">    if (this.immediate)</span>
<a name="l01778"></a>01778 <span class="stringliteral">      cb();</span>
<a name="l01779"></a>01779 <span class="stringliteral">    else</span>
<a name="l01780"></a>01780 <span class="stringliteral">      window.setZeroTimeout(cb);</span>
<a name="l01781"></a>01781 <span class="stringliteral">  }</span>
<a name="l01782"></a>01782 <span class="stringliteral">};</span>
<a name="l01783"></a>01783 <span class="stringliteral"></span>
<a name="l01784"></a>01784 <span class="stringliteral">}());</span>
<a name="l01785"></a>01785 <span class="stringliteral"></span>
<a name="l01786"></a>01786 <span class="stringliteral">define(&#39;mailapi/shim-sham&#39;,</span>
<a name="l01787"></a>01787 <span class="stringliteral">  [</span>
<a name="l01788"></a>01788 <span class="stringliteral">    &#39;buffer&#39;,</span>
<a name="l01789"></a>01789 <span class="stringliteral">  ],</span>
<a name="l01790"></a>01790 <span class="stringliteral">  function(</span>
<a name="l01791"></a>01791 <span class="stringliteral">    $buffer</span>
<a name="l01792"></a>01792 <span class="stringliteral">  ) {</span>
<a name="l01793"></a>01793 <span class="stringliteral"></span>
<a name="l01794"></a>01794 <span class="stringliteral">window.Buffer = $buffer.Buffer;</span>
<a name="l01795"></a>01795 <span class="stringliteral"></span>
<a name="l01796"></a>01796 <span class="stringliteral"></span>
<a name="l01797"></a>01797 <span class="stringliteral">}); // end define</span>
<a name="l01798"></a>01798 <span class="stringliteral">;</span>
<a name="l01799"></a>01799 <span class="stringliteral">define(&#39;event-queue&#39;,[&#39;require&#39;],function (require) {</span>
<a name="l01800"></a>01800 <span class="stringliteral">  // hackish hookup to MAGIC_ERROR_TRAPPER for unit testing; this also has the</span>
<a name="l01801"></a>01801 <span class="stringliteral">  //  nice side-effect of cutting down on RequireJS errors at startup when</span>
<a name="l01802"></a>01802 <span class="stringliteral">  //  Q is loading.</span>
<a name="l01803"></a>01803 <span class="stringliteral">  return {</span>
<a name="l01804"></a>01804 <span class="stringliteral">    enqueue: function(task) {</span>
<a name="l01805"></a>01805 <span class="stringliteral">      setTimeout(function() {</span>
<a name="l01806"></a>01806 <span class="stringliteral">        try {</span>
<a name="l01807"></a>01807 <span class="stringliteral">          task();</span>
<a name="l01808"></a>01808 <span class="stringliteral">        }</span>
<a name="l01809"></a>01809 <span class="stringliteral">        catch(ex) {</span>
<a name="l01810"></a>01810 <span class="stringliteral">          console.error(&quot;</span>exception in enqueued task: <span class="stringliteral">&quot; + ex);</span>
<a name="l01811"></a>01811 <span class="stringliteral">          if (MAGIC_ERROR_TRAPPER)</span>
<a name="l01812"></a>01812 <span class="stringliteral">            MAGIC_ERROR_TRAPPER.yoAnError(ex);</span>
<a name="l01813"></a>01813 <span class="stringliteral">          // and re-throw it in case the platform can pick it up.</span>
<a name="l01814"></a>01814 <span class="stringliteral">          throw ex;</span>
<a name="l01815"></a>01815 <span class="stringliteral">        }</span>
<a name="l01816"></a>01816 <span class="stringliteral">      }, 0);</span>
<a name="l01817"></a>01817 <span class="stringliteral">    },</span>
<a name="l01818"></a>01818 <span class="stringliteral">  };</span>
<a name="l01819"></a>01819 <span class="stringliteral">});</span>
<a name="l01820"></a>01820 <span class="stringliteral"></span>
<a name="l01821"></a>01821 <span class="stringliteral">define(&#39;microtime&#39;,[&#39;require&#39;],function (require) {</span>
<a name="l01822"></a>01822 <span class="stringliteral">  // workers won&#39;t have this, of course...</span>
<a name="l01823"></a>01823 <span class="stringliteral">  if (window &amp;&amp; window.performance &amp;&amp; window.performance.now) {</span>
<a name="l01824"></a>01824 <span class="stringliteral">    return {</span>
<a name="l01825"></a>01825 <span class="stringliteral">      now: function () {</span>
<a name="l01826"></a>01826 <span class="stringliteral">        return window.performance.now() * 1000;</span>
<a name="l01827"></a>01827 <span class="stringliteral">      }</span>
<a name="l01828"></a>01828 <span class="stringliteral">    };</span>
<a name="l01829"></a>01829 <span class="stringliteral">  }</span>
<a name="l01830"></a>01830 <span class="stringliteral"></span>
<a name="l01831"></a>01831 <span class="stringliteral">  return {</span>
<a name="l01832"></a>01832 <span class="stringliteral">    now: function () {</span>
<a name="l01833"></a>01833 <span class="stringliteral">      return Date.now() * 1000;</span>
<a name="l01834"></a>01834 <span class="stringliteral">    }</span>
<a name="l01835"></a>01835 <span class="stringliteral">  };</span>
<a name="l01836"></a>01836 <span class="stringliteral">});</span>
<a name="l01837"></a>01837 <span class="stringliteral"></span>
<a name="l01838"></a>01838 <span class="stringliteral">/* ***** BEGIN LICENSE BLOCK *****</span>
<a name="l01839"></a>01839 <span class="stringliteral"> * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a name="l01840"></a>01840 <span class="stringliteral"> *</span>
<a name="l01841"></a>01841 <span class="stringliteral"> * The contents of this file are subject to the Mozilla Public License Version</span>
<a name="l01842"></a>01842 <span class="stringliteral"> * 1.1 (the &quot;</span>License<span class="stringliteral">&quot;); you may not use this file except in compliance with</span>
<a name="l01843"></a>01843 <span class="stringliteral"> * the License. You may obtain a copy of the License at:</span>
<a name="l01844"></a>01844 <span class="stringliteral"> * http://www.mozilla.org/MPL/</span>
<a name="l01845"></a>01845 <span class="stringliteral"> *</span>
<a name="l01846"></a>01846 <span class="stringliteral"> * Software distributed under the License is distributed on an &quot;</span>AS IS<span class="stringliteral">&quot; basis,</span>
<a name="l01847"></a>01847 <span class="stringliteral"> * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a name="l01848"></a>01848 <span class="stringliteral"> * for the specific language governing rights and limitations under the</span>
<a name="l01849"></a>01849 <span class="stringliteral"> * License.</span>
<a name="l01850"></a>01850 <span class="stringliteral"> *</span>
<a name="l01851"></a>01851 <span class="stringliteral"> * The Original Code is Mozilla Raindrop Code.</span>
<a name="l01852"></a>01852 <span class="stringliteral"> *</span>
<a name="l01853"></a>01853 <span class="stringliteral"> * The Initial Developer of the Original Code is</span>
<a name="l01854"></a>01854 <span class="stringliteral"> *   The Mozilla Foundation</span>
<a name="l01855"></a>01855 <span class="stringliteral"> * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a name="l01856"></a>01856 <span class="stringliteral"> * the Initial Developer. All Rights Reserved.</span>
<a name="l01857"></a>01857 <span class="stringliteral"> *</span>
<a name="l01858"></a>01858 <span class="stringliteral"> * Contributor(s):</span>
<a name="l01859"></a>01859 <span class="stringliteral"> *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a name="l01860"></a>01860 <span class="stringliteral"> *</span>
<a name="l01861"></a>01861 <span class="stringliteral"> * Alternatively, the contents of this file may be used under the terms of</span>
<a name="l01862"></a>01862 <span class="stringliteral"> * either the GNU General Public License Version 2 or later (the &quot;</span>GPL<span class="stringliteral">&quot;), or</span>
<a name="l01863"></a>01863 <span class="stringliteral"> * the GNU Lesser General Public License Version 2.1 or later (the &quot;</span>LGPL<span class="stringliteral">&quot;),</span>
<a name="l01864"></a>01864 <span class="stringliteral"> * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a name="l01865"></a>01865 <span class="stringliteral"> * of those above. If you wish to allow use of your version of this file only</span>
<a name="l01866"></a>01866 <span class="stringliteral"> * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a name="l01867"></a>01867 <span class="stringliteral"> * use your version of this file under the terms of the MPL, indicate your</span>
<a name="l01868"></a>01868 <span class="stringliteral"> * decision by deleting the provisions above and replace them with the notice</span>
<a name="l01869"></a>01869 <span class="stringliteral"> * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a name="l01870"></a>01870 <span class="stringliteral"> * the provisions above, a recipient may use your version of this file under</span>
<a name="l01871"></a>01871 <span class="stringliteral"> * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a name="l01872"></a>01872 <span class="stringliteral"> *</span>
<a name="l01873"></a>01873 <span class="stringliteral"> * ***** END LICENSE BLOCK ***** */</span>
<a name="l01874"></a>01874 <span class="stringliteral"></span>
<a name="l01886"></a>01886 <span class="stringliteral">define(&#39;rdcommon/extransform&#39;,</span>
<a name="l01887"></a>01887 <span class="stringliteral">  [</span>
<a name="l01888"></a>01888 <span class="stringliteral">    &#39;require&#39;,</span>
<a name="l01889"></a>01889 <span class="stringliteral">    &#39;exports&#39;</span>
<a name="l01890"></a>01890 <span class="stringliteral">  ],</span>
<a name="l01891"></a>01891 <span class="stringliteral">  function(</span>
<a name="l01892"></a>01892 <span class="stringliteral">    require,</span>
<a name="l01893"></a>01893 <span class="stringliteral">    exports</span>
<a name="l01894"></a>01894 <span class="stringliteral">  ) {</span>
<a name="l01895"></a>01895 <span class="stringliteral"></span>
<a name="l01896"></a>01896 <span class="stringliteral">var baseUrl;</span>
<a name="l01897"></a>01897 <span class="stringliteral">// XXX previous requirejs web magic...</span>
<a name="l01898"></a>01898 <span class="stringliteral">if (false) {</span>
<a name="l01899"></a>01899 <span class="stringliteral">  baseUrl = require.s.contexts._.config.baseUrl;</span>
<a name="l01900"></a>01900 <span class="stringliteral">  if (baseUrl.length &gt; 3 &amp;&amp; baseUrl.substring(0, 3) === &quot;</span>../<span class="stringliteral">&quot;) {</span>
<a name="l01901"></a>01901 <span class="stringliteral">    var targUrl = document.location.origin + document.location.pathname;</span>
<a name="l01902"></a>01902 <span class="stringliteral">    // strip down to the parent directory (lose file or just trailing &quot;</span>/<span class="stringliteral">&quot;)</span>
<a name="l01903"></a>01903 <span class="stringliteral">    targUrl = targUrl.substring(0, targUrl.lastIndexOf(&quot;</span>/<span class="stringliteral">&quot;));</span>
<a name="l01904"></a>01904 <span class="stringliteral">    // eat the relative bits of the baseUrl</span>
<a name="l01905"></a>01905 <span class="stringliteral">    while (baseUrl.length &gt;= 3 &amp;&amp; baseUrl.substring(0, 3) === &quot;</span>../<span class="stringliteral">&quot;) {</span>
<a name="l01906"></a>01906 <span class="stringliteral">      targUrl = targUrl.substring(0, targUrl.lastIndexOf(&quot;</span>/<span class="stringliteral">&quot;));</span>
<a name="l01907"></a>01907 <span class="stringliteral">      baseUrl = baseUrl.substring(3);</span>
<a name="l01908"></a>01908 <span class="stringliteral">    }</span>
<a name="l01909"></a>01909 <span class="stringliteral">    baseUrl = targUrl + baseUrl + &quot;</span>/<span class="stringliteral">&quot;;</span>
<a name="l01910"></a>01910 <span class="stringliteral">    console.log(&quot;</span>baseUrl<span class="stringliteral">&quot;, baseUrl);</span>
<a name="l01911"></a>01911 <span class="stringliteral">  }</span>
<a name="l01912"></a>01912 <span class="stringliteral">}</span>
<a name="l01913"></a>01913 <span class="stringliteral">else {</span>
<a name="l01914"></a>01914 <span class="stringliteral">  // XXX ALMOND hack; don&#39;t even try and find node path where there is none</span>
<a name="l01915"></a>01915 <span class="stringliteral">  /*</span>
<a name="l01916"></a>01916 <span class="stringliteral">  require([&#39;path&#39;], function($path) {</span>
<a name="l01917"></a>01917 <span class="stringliteral">    baseUrl = $path.resolve(&#39;../..&#39;);</span>
<a name="l01918"></a>01918 <span class="stringliteral">  });</span>
<a name="l01919"></a>01919 <span class="stringliteral">  */</span>
<a name="l01920"></a>01920 <span class="stringliteral">}</span>
<a name="l01921"></a>01921 <span class="stringliteral"></span>
<a name="l01922"></a>01922 <span class="stringliteral"></span>
<a name="l01923"></a>01923 <span class="stringliteral"></span>
<a name="l01924"></a>01924 <span class="stringliteral">function uneval(x) {</span>
<a name="l01925"></a>01925 <span class="stringliteral">  return JSON.stringify(x);</span>
<a name="l01926"></a>01926 <span class="stringliteral">}</span>
<a name="l01927"></a>01927 <span class="stringliteral"></span>
<a name="l01928"></a>01928 <span class="stringliteral">function simplifyFilename(filename) {</span>
<a name="l01929"></a>01929 <span class="stringliteral">  if (!filename)</span>
<a name="l01930"></a>01930 <span class="stringliteral">    return filename;</span>
<a name="l01931"></a>01931 <span class="stringliteral">  // simple hack to eliminate jetpack ridiculousness where we have</span>
<a name="l01932"></a>01932 <span class="stringliteral">  //  &quot;</span>LONGPATH -&gt; LONGPATH -&gt; LONGPATH -&gt; actualThing.js<span class="stringliteral">&quot;</span>
<a name="l01933"></a>01933 <span class="stringliteral">  if (filename.length &gt; 96) {</span>
<a name="l01934"></a>01934 <span class="stringliteral">    var lastSlash = filename.lastIndexOf(&#39;/&#39;);</span>
<a name="l01935"></a>01935 <span class="stringliteral">    if (lastSlash !== -1)</span>
<a name="l01936"></a>01936 <span class="stringliteral">      return filename.substring(lastSlash+1);</span>
<a name="l01937"></a>01937 <span class="stringliteral">  }</span>
<a name="l01938"></a>01938 <span class="stringliteral">  // can we reduce it?</span>
<a name="l01939"></a>01939 <span class="stringliteral">  if (baseUrl &amp;&amp; filename.substring(0, baseUrl.length) === baseUrl) {</span>
<a name="l01940"></a>01940 <span class="stringliteral">    // we could take this a step further and do path analysis.</span>
<a name="l01941"></a>01941 <span class="stringliteral">    return filename.substring(baseUrl.length);</span>
<a name="l01942"></a>01942 <span class="stringliteral">  }</span>
<a name="l01943"></a>01943 <span class="stringliteral">  return filename;</span>
<a name="l01944"></a>01944 <span class="stringliteral">}</span>
<a name="l01945"></a>01945 <span class="stringliteral"></span>
<a name="l01946"></a>01946 <span class="stringliteral">// Thunk the stack format in v8</span>
<a name="l01947"></a>01947 <span class="stringliteral">Error.prepareStackTrace = function(e, frames) {</span>
<a name="l01948"></a>01948 <span class="stringliteral">  var o = [];</span>
<a name="l01949"></a>01949 <span class="stringliteral">  for (var i = 0; i &lt; frames.length; i++) {</span>
<a name="l01950"></a>01950 <span class="stringliteral">    var frame = frames[i];</span>
<a name="l01951"></a>01951 <span class="stringliteral">    o.push({</span>
<a name="l01952"></a>01952 <span class="stringliteral">      filename: simplifyFilename(frame.getFileName()),</span>
<a name="l01953"></a>01953 <span class="stringliteral">      lineNo: frame.getLineNumber(),</span>
<a name="l01954"></a>01954 <span class="stringliteral">      funcName: frame.getFunctionName(),</span>
<a name="l01955"></a>01955 <span class="stringliteral">    });</span>
<a name="l01956"></a>01956 <span class="stringliteral">  }</span>
<a name="l01957"></a>01957 <span class="stringliteral">  return o;</span>
<a name="l01958"></a>01958 <span class="stringliteral">};</span>
<a name="l01959"></a>01959 <span class="stringliteral">// raise the limit in case of super-nested require()s</span>
<a name="l01960"></a>01960 <span class="stringliteral">//Error.stackTraceLimit = 64;</span>
<a name="l01961"></a>01961 <span class="stringliteral"></span>
<a name="l01962"></a>01962 <span class="stringliteral">// XXX not sure if this even works since Error is not supposed to be</span>
<a name="l01963"></a>01963 <span class="stringliteral">//  configurable... provide a captureStackTrace method</span>
<a name="l01964"></a>01964 <span class="stringliteral">// nb: and obviously, in independent sandboxes, this does jack...</span>
<a name="l01965"></a>01965 <span class="stringliteral">if (!Error.captureStackTrace) {</span>
<a name="l01966"></a>01966 <span class="stringliteral">  Error.captureStackTrace = function(who, errType) {</span>
<a name="l01967"></a>01967 <span class="stringliteral">    try {</span>
<a name="l01968"></a>01968 <span class="stringliteral">      throw new Error();</span>
<a name="l01969"></a>01969 <span class="stringliteral">    }</span>
<a name="l01970"></a>01970 <span class="stringliteral">    catch(ex) {</span>
<a name="l01971"></a>01971 <span class="stringliteral">      var sframes = ex.stack.split(&quot;</span>\<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a><span class="stringliteral">&quot;), frames = who.stack = [], match;</span>
<a name="l01972"></a>01972 <span class="stringliteral">      for (var i = 0; i &lt; sframes.length; i++) {</span>
<a name="l01973"></a>01973 <span class="stringliteral">        if ((match = SM_STACK_FORMAT.exec(sframes[i]))) {</span>
<a name="l01974"></a>01974 <span class="stringliteral">          frames.push({</span>
<a name="l01975"></a>01975 <span class="stringliteral">                        filename: simplifyFilename(match[2]),</span>
<a name="l01976"></a>01976 <span class="stringliteral">                        lineNo: match[3],</span>
<a name="l01977"></a>01977 <span class="stringliteral">                        funcName: match[1],</span>
<a name="l01978"></a>01978 <span class="stringliteral">                      });</span>
<a name="l01979"></a>01979 <span class="stringliteral">        }</span>
<a name="l01980"></a>01980 <span class="stringliteral">      }</span>
<a name="l01981"></a>01981 <span class="stringliteral">    }</span>
<a name="l01982"></a>01982 <span class="stringliteral">  };</span>
<a name="l01983"></a>01983 <span class="stringliteral">}</span>
<a name="l01984"></a>01984 <span class="stringliteral"></span>
<a name="l01985"></a>01985 <span class="stringliteral">var SM_STACK_FORMAT = /^(.*)@(.+):(\d+)$/;</span>
<a name="l01986"></a>01986 <span class="stringliteral"></span>
<a name="l01987"></a>01987 <span class="stringliteral">// this is biased towards v8/chromium for now</span>
<a name="l01991"></a>01991 <span class="stringliteral">exports.transformException = function transformException(e) {</span>
<a name="l01992"></a>01992 <span class="stringliteral">  // it&#39;s conceivable someone</span>
<a name="l01993"></a>01993 <span class="stringliteral">  if (!(e instanceof Error) &amp;&amp;</span>
<a name="l01994"></a>01994 <span class="stringliteral">      // under jetpack, we are losing hard, probably because of the sandbox</span>
<a name="l01995"></a>01995 <span class="stringliteral">      //  issue where everybody gets their own fundamentals, so check for stack.</span>
<a name="l01996"></a>01996 <span class="stringliteral">      (!e || typeof(e) !== &quot;</span><span class="keywordtype">object</span><span class="stringliteral">&quot; || !(&quot;</span><a class="code" href="../../d6/d1b/pprthred_8h.html#afe76c3c951fe40bd646fbf0b89cbcd17">stack</a><span class="stringliteral">&quot; in e))) {</span>
<a name="l01997"></a>01997 <span class="stringliteral">    return {</span>
<a name="l01998"></a>01998 <span class="stringliteral">      n: &quot;</span>Object<span class="stringliteral">&quot;,</span>
<a name="l01999"></a>01999 <span class="stringliteral">      m: &quot;</span><span class="stringliteral">&quot; + e,</span>
<a name="l02000"></a>02000 <span class="stringliteral">      f: [],</span>
<a name="l02001"></a>02001 <span class="stringliteral">    };</span>
<a name="l02002"></a>02002 <span class="stringliteral">  }</span>
<a name="l02003"></a>02003 <span class="stringliteral"></span>
<a name="l02004"></a>02004 <span class="stringliteral">  var stack = e.stack;</span>
<a name="l02005"></a>02005 <span class="stringliteral">  // evidence of v8 thunk?</span>
<a name="l02006"></a>02006 <span class="stringliteral">  if (Array.isArray(stack)) {</span>
<a name="l02007"></a>02007 <span class="stringliteral">    return {</span>
<a name="l02008"></a>02008 <span class="stringliteral">      n: e.name,</span>
<a name="l02009"></a>02009 <span class="stringliteral">      m: e.message,</span>
<a name="l02010"></a>02010 <span class="stringliteral">      f: stack,</span>
<a name="l02011"></a>02011 <span class="stringliteral">    };</span>
<a name="l02012"></a>02012 <span class="stringliteral">  }</span>
<a name="l02013"></a>02013 <span class="stringliteral"></span>
<a name="l02014"></a>02014 <span class="stringliteral">  // handle the spidermonkey case, XXX maybe</span>
<a name="l02015"></a>02015 <span class="stringliteral">  var o = {</span>
<a name="l02016"></a>02016 <span class="stringliteral">    n: e.name,</span>
<a name="l02017"></a>02017 <span class="stringliteral">    m: e.message,</span>
<a name="l02018"></a>02018 <span class="stringliteral">    f: [],</span>
<a name="l02019"></a>02019 <span class="stringliteral">  };</span>
<a name="l02020"></a>02020 <span class="stringliteral">  if (stack) {</span>
<a name="l02021"></a>02021 <span class="stringliteral">    var sframes = stack.split(&quot;</span>\<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a><span class="stringliteral">&quot;), frames = o.f, match;</span>
<a name="l02022"></a>02022 <span class="stringliteral">    for (var i = 0; i &lt; sframes.length; i++) {</span>
<a name="l02023"></a>02023 <span class="stringliteral">      if ((match = SM_STACK_FORMAT.exec(sframes[i]))) {</span>
<a name="l02024"></a>02024 <span class="stringliteral">        frames.push({</span>
<a name="l02025"></a>02025 <span class="stringliteral">          filename: simplifyFilename(match[2]),</span>
<a name="l02026"></a>02026 <span class="stringliteral">          lineNo: match[3],</span>
<a name="l02027"></a>02027 <span class="stringliteral">          funcName: match[1],</span>
<a name="l02028"></a>02028 <span class="stringliteral">        });</span>
<a name="l02029"></a>02029 <span class="stringliteral">      }</span>
<a name="l02030"></a>02030 <span class="stringliteral">    }</span>
<a name="l02031"></a>02031 <span class="stringliteral">  }</span>
<a name="l02032"></a>02032 <span class="stringliteral">  // otherwise this is probably an XPConnect exception...</span>
<a name="l02033"></a>02033 <span class="stringliteral">  else if (e.filename) {</span>
<a name="l02034"></a>02034 <span class="stringliteral">    o.f.push({</span>
<a name="l02035"></a>02035 <span class="stringliteral">      filename: e.filename,</span>
<a name="l02036"></a>02036 <span class="stringliteral">      lineNo: e.lineNumber,</span>
<a name="l02037"></a>02037 <span class="stringliteral">      funcName: &#39;&#39;,</span>
<a name="l02038"></a>02038 <span class="stringliteral">    });</span>
<a name="l02039"></a>02039 <span class="stringliteral">  }</span>
<a name="l02040"></a>02040 <span class="stringliteral">  return o;</span>
<a name="l02041"></a>02041 <span class="stringliteral">};</span>
<a name="l02042"></a>02042 <span class="stringliteral"></span>
<a name="l02043"></a>02043 <span class="stringliteral">}); // end define</span>
<a name="l02044"></a>02044 <span class="stringliteral">;</span>
<a name="l02045"></a>02045 <span class="stringliteral">/* ***** BEGIN LICENSE BLOCK *****</span>
<a name="l02046"></a>02046 <span class="stringliteral"> * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a name="l02047"></a>02047 <span class="stringliteral"> *</span>
<a name="l02048"></a>02048 <span class="stringliteral"> * The contents of this file are subject to the Mozilla Public License Version</span>
<a name="l02049"></a>02049 <span class="stringliteral"> * 1.1 (the &quot;</span>License<span class="stringliteral">&quot;); you may not use this file except in compliance with</span>
<a name="l02050"></a>02050 <span class="stringliteral"> * the License. You may obtain a copy of the License at:</span>
<a name="l02051"></a>02051 <span class="stringliteral"> * http://www.mozilla.org/MPL/</span>
<a name="l02052"></a>02052 <span class="stringliteral"> *</span>
<a name="l02053"></a>02053 <span class="stringliteral"> * Software distributed under the License is distributed on an &quot;</span>AS IS<span class="stringliteral">&quot; basis,</span>
<a name="l02054"></a>02054 <span class="stringliteral"> * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a name="l02055"></a>02055 <span class="stringliteral"> * for the specific language governing rights and limitations under the</span>
<a name="l02056"></a>02056 <span class="stringliteral"> * License.</span>
<a name="l02057"></a>02057 <span class="stringliteral"> *</span>
<a name="l02058"></a>02058 <span class="stringliteral"> * The Original Code is Mozilla Raindrop Code.</span>
<a name="l02059"></a>02059 <span class="stringliteral"> *</span>
<a name="l02060"></a>02060 <span class="stringliteral"> * The Initial Developer of the Original Code is</span>
<a name="l02061"></a>02061 <span class="stringliteral"> *   The Mozilla Foundation</span>
<a name="l02062"></a>02062 <span class="stringliteral"> * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a name="l02063"></a>02063 <span class="stringliteral"> * the Initial Developer. All Rights Reserved.</span>
<a name="l02064"></a>02064 <span class="stringliteral"> *</span>
<a name="l02065"></a>02065 <span class="stringliteral"> * Contributor(s):</span>
<a name="l02066"></a>02066 <span class="stringliteral"> *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a name="l02067"></a>02067 <span class="stringliteral"> *</span>
<a name="l02068"></a>02068 <span class="stringliteral"> * Alternatively, the contents of this file may be used under the terms of</span>
<a name="l02069"></a>02069 <span class="stringliteral"> * either the GNU General Public License Version 2 or later (the &quot;</span>GPL<span class="stringliteral">&quot;), or</span>
<a name="l02070"></a>02070 <span class="stringliteral"> * the GNU Lesser General Public License Version 2.1 or later (the &quot;</span>LGPL<span class="stringliteral">&quot;),</span>
<a name="l02071"></a>02071 <span class="stringliteral"> * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a name="l02072"></a>02072 <span class="stringliteral"> * of those above. If you wish to allow use of your version of this file only</span>
<a name="l02073"></a>02073 <span class="stringliteral"> * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a name="l02074"></a>02074 <span class="stringliteral"> * use your version of this file under the terms of the MPL, indicate your</span>
<a name="l02075"></a>02075 <span class="stringliteral"> * decision by deleting the provisions above and replace them with the notice</span>
<a name="l02076"></a>02076 <span class="stringliteral"> * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a name="l02077"></a>02077 <span class="stringliteral"> * the provisions above, a recipient may use your version of this file under</span>
<a name="l02078"></a>02078 <span class="stringliteral"> * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a name="l02079"></a>02079 <span class="stringliteral"> *</span>
<a name="l02080"></a>02080 <span class="stringliteral"> * ***** END LICENSE BLOCK ***** */</span>
<a name="l02081"></a>02081 <span class="stringliteral"></span>
<a name="l02273"></a>02273 <span class="stringliteral">define(&#39;rdcommon/log&#39;,</span>
<a name="l02274"></a>02274 <span class="stringliteral">  [</span>
<a name="l02275"></a>02275 <span class="stringliteral">    &#39;q&#39;,</span>
<a name="l02276"></a>02276 <span class="stringliteral">    &#39;microtime&#39;,</span>
<a name="l02277"></a>02277 <span class="stringliteral">    &#39;./extransform&#39;,</span>
<a name="l02278"></a>02278 <span class="stringliteral">    &#39;exports&#39;</span>
<a name="l02279"></a>02279 <span class="stringliteral">  ],</span>
<a name="l02280"></a>02280 <span class="stringliteral">  function(</span>
<a name="l02281"></a>02281 <span class="stringliteral">    $Q,</span>
<a name="l02282"></a>02282 <span class="stringliteral">    $microtime,</span>
<a name="l02283"></a>02283 <span class="stringliteral">    $extransform,</span>
<a name="l02284"></a>02284 <span class="stringliteral">    exports</span>
<a name="l02285"></a>02285 <span class="stringliteral">  ) {</span>
<a name="l02286"></a>02286 <span class="stringliteral"></span>
<a name="l02301"></a>02301 <span class="stringliteral">var gSeq = 0;</span>
<a name="l02302"></a>02302 <span class="stringliteral"></span>
<a name="l02303"></a>02303 <span class="stringliteral">exports.getCurrentSeq = function() {</span>
<a name="l02304"></a>02304 <span class="stringliteral">  return gSeq;</span>
<a name="l02305"></a>02305 <span class="stringliteral">};</span>
<a name="l02306"></a>02306 <span class="stringliteral"></span>
<a name="l02310"></a>02310 <span class="stringliteral">var gUniqueActorName = 1;</span>
<a name="l02314"></a>02314 <span class="stringliteral">var gUniqueThingName = -1;</span>
<a name="l02315"></a>02315 <span class="stringliteral"></span>
<a name="l02316"></a>02316 <span class="stringliteral">var ThingProto = exports.ThingProto = {</span>
<a name="l02317"></a>02317 <span class="stringliteral">  get digitalName() {</span>
<a name="l02318"></a>02318 <span class="stringliteral">    return this.__diginame;</span>
<a name="l02319"></a>02319 <span class="stringliteral">  },</span>
<a name="l02320"></a>02320 <span class="stringliteral">  set digitalName(val) {</span>
<a name="l02321"></a>02321 <span class="stringliteral">    this.__diginame = val;</span>
<a name="l02322"></a>02322 <span class="stringliteral">  },</span>
<a name="l02323"></a>02323 <span class="stringliteral">  toString: function() {</span>
<a name="l02324"></a>02324 <span class="stringliteral">    return &#39;[Thing:&#39; + this.__type + &#39;]&#39;;</span>
<a name="l02325"></a>02325 <span class="stringliteral">  },</span>
<a name="l02326"></a>02326 <span class="stringliteral">  toJSON: function() {</span>
<a name="l02327"></a>02327 <span class="stringliteral">    var o = {</span>
<a name="l02328"></a>02328 <span class="stringliteral">      type: this.__type,</span>
<a name="l02329"></a>02329 <span class="stringliteral">      name: this.__name,</span>
<a name="l02330"></a>02330 <span class="stringliteral">      dname: this.__diginame,</span>
<a name="l02331"></a>02331 <span class="stringliteral">      uniqueName: this._uniqueName,</span>
<a name="l02332"></a>02332 <span class="stringliteral">    };</span>
<a name="l02333"></a>02333 <span class="stringliteral">    if (this.__hardcodedFamily)</span>
<a name="l02334"></a>02334 <span class="stringliteral">      o.family = this.__hardcodedFamily;</span>
<a name="l02335"></a>02335 <span class="stringliteral">    return o;</span>
<a name="l02336"></a>02336 <span class="stringliteral">  },</span>
<a name="l02337"></a>02337 <span class="stringliteral">};</span>
<a name="l02338"></a>02338 <span class="stringliteral"></span>
<a name="l02348"></a>02348 <span class="stringliteral">exports.__makeThing = function makeThing(type, humanName, digitalName, proto) {</span>
<a name="l02349"></a>02349 <span class="stringliteral">  var thing;</span>
<a name="l02350"></a>02350 <span class="stringliteral">  if (proto === undefined)</span>
<a name="l02351"></a>02351 <span class="stringliteral">    proto = ThingProto;</span>
<a name="l02352"></a>02352 <span class="stringliteral">  thing = Object.create(proto);</span>
<a name="l02353"></a>02353 <span class="stringliteral"></span>
<a name="l02354"></a>02354 <span class="stringliteral">  thing.__type = type;</span>
<a name="l02355"></a>02355 <span class="stringliteral">  thing.__name = humanName;</span>
<a name="l02356"></a>02356 <span class="stringliteral">  thing.__diginame = digitalName;</span>
<a name="l02357"></a>02357 <span class="stringliteral">  thing.__hardcodedFamily = null;</span>
<a name="l02358"></a>02358 <span class="stringliteral">  thing._uniqueName = gUniqueThingName--;</span>
<a name="l02359"></a>02359 <span class="stringliteral">  return thing;</span>
<a name="l02360"></a>02360 <span class="stringliteral">};</span>
<a name="l02361"></a>02361 <span class="stringliteral"></span>
<a name="l02362"></a>02362 <span class="stringliteral">function NOP() {</span>
<a name="l02363"></a>02363 <span class="stringliteral">}</span>
<a name="l02364"></a>02364 <span class="stringliteral"></span>
<a name="l02369"></a>02369 <span class="stringliteral">var DummyLogProtoBase = {</span>
<a name="l02370"></a>02370 <span class="stringliteral">  _kids: undefined,</span>
<a name="l02371"></a>02371 <span class="stringliteral">  logLevel: &#39;dummy&#39;,</span>
<a name="l02372"></a>02372 <span class="stringliteral">  toString: function() {</span>
<a name="l02373"></a>02373 <span class="stringliteral">    return &#39;[DummyLog]&#39;;</span>
<a name="l02374"></a>02374 <span class="stringliteral">  },</span>
<a name="l02375"></a>02375 <span class="stringliteral">  toJSON: function() {</span>
<a name="l02376"></a>02376 <span class="stringliteral">    // will this actually break JSON.stringify or just cause it to not use us?</span>
<a name="l02377"></a>02377 <span class="stringliteral">    throw new Error(&quot;</span><a class="code" href="../../da/d7d/sylvester_8js.html#a36e4d4a7eda7b7caf30c74df2451ef99">I</a> WAS NOT PLANNING ON BEING SERIALIZED<span class="stringliteral">&quot;);</span>
<a name="l02378"></a>02378 <span class="stringliteral">  },</span>
<a name="l02379"></a>02379 <span class="stringliteral">  __die: NOP,</span>
<a name="l02380"></a>02380 <span class="stringliteral">  __updateIdent: NOP,</span>
<a name="l02381"></a>02381 <span class="stringliteral">};</span>
<a name="l02382"></a>02382 <span class="stringliteral"></span>
<a name="l02389"></a>02389 <span class="stringliteral">var LogProtoBase = {</span>
<a name="l02397"></a>02397 <span class="stringliteral">  _named: null,</span>
<a name="l02398"></a>02398 <span class="stringliteral">  logLevel: &#39;safe&#39;,</span>
<a name="l02399"></a>02399 <span class="stringliteral">  toJSON: function() {</span>
<a name="l02400"></a>02400 <span class="stringliteral">    var jo = {</span>
<a name="l02401"></a>02401 <span class="stringliteral">      loggerIdent: this.__defName,</span>
<a name="l02402"></a>02402 <span class="stringliteral">      semanticIdent: this._ident,</span>
<a name="l02403"></a>02403 <span class="stringliteral">      uniqueName: this._uniqueName,</span>
<a name="l02404"></a>02404 <span class="stringliteral">      born: this._born,</span>
<a name="l02405"></a>02405 <span class="stringliteral">      died: this._died,</span>
<a name="l02406"></a>02406 <span class="stringliteral">      events: this._eventMap,</span>
<a name="l02407"></a>02407 <span class="stringliteral">      entries: this._entries,</span>
<a name="l02408"></a>02408 <span class="stringliteral">      kids: this._kids</span>
<a name="l02409"></a>02409 <span class="stringliteral">    };</span>
<a name="l02410"></a>02410 <span class="stringliteral">    if (this.__latchedVars.length) {</span>
<a name="l02411"></a>02411 <span class="stringliteral">      var latchedVars = this.__latchedVars, olv = {};</span>
<a name="l02412"></a>02412 <span class="stringliteral">      for (var i = 0; i &lt; latchedVars.length; i++) {</span>
<a name="l02413"></a>02413 <span class="stringliteral">        olv[latchedVars[i]] = this[&#39;:&#39; + latchedVars[i]];</span>
<a name="l02414"></a>02414 <span class="stringliteral">      }</span>
<a name="l02415"></a>02415 <span class="stringliteral">      jo.latched = olv;</span>
<a name="l02416"></a>02416 <span class="stringliteral">    }</span>
<a name="l02417"></a>02417 <span class="stringliteral">    if (this._named)</span>
<a name="l02418"></a>02418 <span class="stringliteral">      jo.named = this._named;</span>
<a name="l02419"></a>02419 <span class="stringliteral">    return jo;</span>
<a name="l02420"></a>02420 <span class="stringliteral">  },</span>
<a name="l02421"></a>02421 <span class="stringliteral">  __die: function() {</span>
<a name="l02422"></a>02422 <span class="stringliteral">    this._died = $microtime.now();</span>
<a name="l02423"></a>02423 <span class="stringliteral">    if (this.__FAB._onDeath)</span>
<a name="l02424"></a>02424 <span class="stringliteral">      this.__FAB._onDeath(this);</span>
<a name="l02425"></a>02425 <span class="stringliteral">  },</span>
<a name="l02426"></a>02426 <span class="stringliteral">  __updateIdent: function(ident) {</span>
<a name="l02427"></a>02427 <span class="stringliteral">    // NOTE: you need to update useSemanticIdent if you change this.</span>
<a name="l02428"></a>02428 <span class="stringliteral">    // normalize all object references to unique name references.</span>
<a name="l02429"></a>02429 <span class="stringliteral">    if (Array.isArray(ident)) {</span>
<a name="l02430"></a>02430 <span class="stringliteral">      var normIdent = [];</span>
<a name="l02431"></a>02431 <span class="stringliteral">      for (var i = 0; i &lt; ident.length; i++) {</span>
<a name="l02432"></a>02432 <span class="stringliteral">        var identBit = ident[i];</span>
<a name="l02433"></a>02433 <span class="stringliteral">        if (typeof(identBit) !== &quot;</span><span class="keywordtype">object</span><span class="stringliteral">&quot; || identBit == null)</span>
<a name="l02434"></a>02434 <span class="stringliteral">          normIdent.push(identBit);</span>
<a name="l02435"></a>02435 <span class="stringliteral">        else</span>
<a name="l02436"></a>02436 <span class="stringliteral">          normIdent.push(identBit._uniqueName);</span>
<a name="l02437"></a>02437 <span class="stringliteral">      }</span>
<a name="l02438"></a>02438 <span class="stringliteral">      ident = normIdent;</span>
<a name="l02439"></a>02439 <span class="stringliteral">    }</span>
<a name="l02440"></a>02440 <span class="stringliteral">    this._ident = ident;</span>
<a name="l02441"></a>02441 <span class="stringliteral">  },</span>
<a name="l02442"></a>02442 <span class="stringliteral">};</span>
<a name="l02443"></a>02443 <span class="stringliteral"></span>
<a name="l02454"></a>02454 <span class="stringliteral">var TestLogProtoBase = Object.create(LogProtoBase);</span>
<a name="l02455"></a>02455 <span class="stringliteral">TestLogProtoBase.logLevel = &#39;dangerous&#39;;</span>
<a name="l02456"></a>02456 <span class="stringliteral">TestLogProtoBase.__unexpectedEntry = function(iEntry, unexpEntry) {</span>
<a name="l02457"></a>02457 <span class="stringliteral">  var entry = [&#39;!unexpected&#39;, unexpEntry];</span>
<a name="l02458"></a>02458 <span class="stringliteral">  this._entries[iEntry] = entry;</span>
<a name="l02459"></a>02459 <span class="stringliteral">};</span>
<a name="l02460"></a>02460 <span class="stringliteral"></span>
<a name="l02461"></a>02461 <span class="stringliteral">TestLogProtoBase.__mismatchEntry = function(iEntry, expected, actual) {</span>
<a name="l02462"></a>02462 <span class="stringliteral">  var entry = [&#39;!mismatch&#39;, expected, actual];</span>
<a name="l02463"></a>02463 <span class="stringliteral">  this._entries[iEntry] = entry;</span>
<a name="l02464"></a>02464 <span class="stringliteral">};</span>
<a name="l02465"></a>02465 <span class="stringliteral"></span>
<a name="l02466"></a>02466 <span class="stringliteral">TestLogProtoBase.__failedExpectation = function(exp) {</span>
<a name="l02467"></a>02467 <span class="stringliteral">  var entry = [&#39;!failedexp&#39;, exp, $microtime.now(), gSeq++];</span>
<a name="l02468"></a>02468 <span class="stringliteral">  this._entries.push(entry);</span>
<a name="l02469"></a>02469 <span class="stringliteral">};</span>
<a name="l02470"></a>02470 <span class="stringliteral"></span>
<a name="l02471"></a>02471 <span class="stringliteral">TestLogProtoBase.__die = function() {</span>
<a name="l02472"></a>02472 <span class="stringliteral">  this._died = $microtime.now();</span>
<a name="l02473"></a>02473 <span class="stringliteral">  var testActor = this._actor;</span>
<a name="l02474"></a>02474 <span class="stringliteral">  if (testActor) {</span>
<a name="l02475"></a>02475 <span class="stringliteral">    if (testActor._expectDeath) {</span>
<a name="l02476"></a>02476 <span class="stringliteral">      testActor._expectDeath = false;</span>
<a name="l02477"></a>02477 <span class="stringliteral">      testActor.__loggerFired();</span>
<a name="l02478"></a>02478 <span class="stringliteral">    }</span>
<a name="l02479"></a>02479 <span class="stringliteral">    if (testActor._lifecycleListener)</span>
<a name="l02480"></a>02480 <span class="stringliteral">      testActor._lifecycleListener.call(null, &#39;dead&#39;, this.__instance, this);</span>
<a name="l02481"></a>02481 <span class="stringliteral">  }</span>
<a name="l02482"></a>02482 <span class="stringliteral">};</span>
<a name="l02483"></a>02483 <span class="stringliteral"></span>
<a name="l02484"></a>02484 <span class="stringliteral">var DIED_EVENTNAME = &#39;(died)&#39;, DIED_EXP = [DIED_EVENTNAME];</span>
<a name="l02485"></a>02485 <span class="stringliteral"></span>
<a name="l02486"></a>02486 <span class="stringliteral">var TestActorProtoBase = {</span>
<a name="l02487"></a>02487 <span class="stringliteral">  toString: function() {</span>
<a name="l02488"></a>02488 <span class="stringliteral">    return &#39;[Actor &#39; + this.__defName + &#39;: &#39; + this.__name + &#39;]&#39;;</span>
<a name="l02489"></a>02489 <span class="stringliteral">  },</span>
<a name="l02490"></a>02490 <span class="stringliteral">  toJSON: function() {</span>
<a name="l02491"></a>02491 <span class="stringliteral">    return {</span>
<a name="l02492"></a>02492 <span class="stringliteral">      actorIdent: this.__defName,</span>
<a name="l02493"></a>02493 <span class="stringliteral">      semanticIdent: this.__name,</span>
<a name="l02494"></a>02494 <span class="stringliteral">      uniqueName: this._uniqueName,</span>
<a name="l02495"></a>02495 <span class="stringliteral">      parentUniqueName: this._parentUniqueName,</span>
<a name="l02496"></a>02496 <span class="stringliteral">      loggerUniqueName: this._logger ? this._logger._uniqueName : null,</span>
<a name="l02497"></a>02497 <span class="stringliteral">    };</span>
<a name="l02498"></a>02498 <span class="stringliteral">  },</span>
<a name="l02499"></a>02499 <span class="stringliteral"></span>
<a name="l02504"></a>02504 <span class="stringliteral">  __attachToLogger: function(logger) {</span>
<a name="l02505"></a>02505 <span class="stringliteral">    logger._actor = this;</span>
<a name="l02506"></a>02506 <span class="stringliteral">    this._logger = logger;</span>
<a name="l02507"></a>02507 <span class="stringliteral">    if (this._lifecycleListener)</span>
<a name="l02508"></a>02508 <span class="stringliteral">      this._lifecycleListener.call(null, &#39;attach&#39;, logger.__instance, logger);</span>
<a name="l02509"></a>02509 <span class="stringliteral">  },</span>
<a name="l02510"></a>02510 <span class="stringliteral"></span>
<a name="l02520"></a>02520 <span class="stringliteral">  attachLifecycleListener: function(func) {</span>
<a name="l02521"></a>02521 <span class="stringliteral">    this._lifecycleListener = func;</span>
<a name="l02522"></a>02522 <span class="stringliteral">  },</span>
<a name="l02523"></a>02523 <span class="stringliteral"></span>
<a name="l02530"></a>02530 <span class="stringliteral">  asyncEventsAreComingDoNotResolve: function() {</span>
<a name="l02531"></a>02531 <span class="stringliteral">    if (!this._activeForTestStep)</span>
<a name="l02532"></a>02532 <span class="stringliteral">      throw new Error(&quot;</span>Attempt <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> <span class="keyword">set</span> expectations <a class="code" href="../../d3/d4a/mock__recipients_8js.html#a7940c57332eea343200607dcc55a2b00">on</a> an actor (<span class="stringliteral">&quot; +</span>
<a name="l02533"></a>02533 <span class="stringliteral">                      this.__defName + &quot;</span>: <span class="stringliteral">&quot; + this.__name + &quot;</span>) that is not <span class="stringliteral">&quot; +</span>
<a name="l02534"></a>02534 <span class="stringliteral">                      &quot;</span>participating in <span class="keyword">this</span> <a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a4fe50fa16c059b33ed172c344bb3fc74">test</a> step!<span class="stringliteral">&quot;);</span>
<a name="l02535"></a>02535 <span class="stringliteral">    if (this._resolved)</span>
<a name="l02536"></a>02536 <span class="stringliteral">      throw new Error(&quot;</span>Attempt <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> <a class="code" href="../../d3/d4a/mock__recipients_8js.html#a81b686bc164506c493dc722ce59d5b54">add</a> expectations when already <a class="code" href="../../d2/d7d/jsapi_8h.html#a56cccbaafc97c9162274032216ba8c39">resolved</a>!<span class="stringliteral">&quot;);</span>
<a name="l02537"></a>02537 <span class="stringliteral"></span>
<a name="l02538"></a>02538 <span class="stringliteral">    // (sorta evil-hack)</span>
<a name="l02539"></a>02539 <span class="stringliteral">    // We can reuse the _expectDeath flag as a means to ensure that we don&#39;t</span>
<a name="l02540"></a>02540 <span class="stringliteral">    //  resolve the promise prematurely, although it&#39;s semantically suspect.</span>
<a name="l02541"></a>02541 <span class="stringliteral">    //  (And bad things will happen if the test logger does actually die...)</span>
<a name="l02542"></a>02542 <span class="stringliteral">    if (this._expectDeath)</span>
<a name="l02543"></a>02543 <span class="stringliteral">      throw new Error(&quot;</span>death expectation incompatible with async events<span class="stringliteral">&quot;);</span>
<a name="l02544"></a>02544 <span class="stringliteral">    this._expectDeath = true;</span>
<a name="l02545"></a>02545 <span class="stringliteral">  },</span>
<a name="l02546"></a>02546 <span class="stringliteral"></span>
<a name="l02552"></a>02552 <span class="stringliteral">  asyncEventsAllDoneDoResolve: function() {</span>
<a name="l02553"></a>02553 <span class="stringliteral">    // stop saying we are expecting our death; new events will trigger</span>
<a name="l02554"></a>02554 <span class="stringliteral">    //  resolution</span>
<a name="l02555"></a>02555 <span class="stringliteral">    this._expectDeath = false;</span>
<a name="l02556"></a>02556 <span class="stringliteral">    // pretend something happened to potentially trigger things now.</span>
<a name="l02557"></a>02557 <span class="stringliteral">    this.__loggerFired();</span>
<a name="l02558"></a>02558 <span class="stringliteral">  },</span>
<a name="l02559"></a>02559 <span class="stringliteral"></span>
<a name="l02564"></a>02564 <span class="stringliteral">  expectNothing: function() {</span>
<a name="l02565"></a>02565 <span class="stringliteral">    if (this._expectations.length)</span>
<a name="l02566"></a>02566 <span class="stringliteral">      throw new Error(&quot;</span>Already expecting something <span class="keyword">this</span> turn! <span class="stringliteral">&quot; +</span>
<a name="l02567"></a>02567 <span class="stringliteral">                      JSON.stringify(this._expectations[0]));</span>
<a name="l02568"></a>02568 <span class="stringliteral">    this._expectNothing = true;</span>
<a name="l02569"></a>02569 <span class="stringliteral">  },</span>
<a name="l02570"></a>02570 <span class="stringliteral"></span>
<a name="l02575"></a>02575 <span class="stringliteral">  expectOnly__die: function() {</span>
<a name="l02576"></a>02576 <span class="stringliteral">    if (!this._activeForTestStep)</span>
<a name="l02577"></a>02577 <span class="stringliteral">      throw new Error(&quot;</span>Attempt <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> <span class="keyword">set</span> expectations <a class="code" href="../../d3/d4a/mock__recipients_8js.html#a7940c57332eea343200607dcc55a2b00">on</a> an actor (<span class="stringliteral">&quot; +</span>
<a name="l02578"></a>02578 <span class="stringliteral">                      this.__defName + &quot;</span>: <span class="stringliteral">&quot; + this.__name + &quot;</span>) that is not &quot; +
<a name="l02579"></a>02579                       &quot;participating in <a class="code" href="../../d5/d09/apps_2email_2test_2integration_2_r_e_a_d_m_e_8md.html#ad995d7ecb156c0e4738ce089b58e2714">this</a> <a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a4fe50fa16c059b33ed172c344bb3fc74">test</a> step!&quot;);
<a name="l02580"></a>02580     <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (<a class="code" href="../../d5/d09/apps_2email_2test_2integration_2_r_e_a_d_m_e_8md.html#ad995d7ecb156c0e4738ce089b58e2714">this</a>._resolved)
<a name="l02581"></a>02581       throw new <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(&quot;Attempt <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> <a class="code" href="../../d3/d4a/mock__recipients_8js.html#a81b686bc164506c493dc722ce59d5b54">add</a> expectations when already <a class="code" href="../../d2/d7d/jsapi_8h.html#a56cccbaafc97c9162274032216ba8c39">resolved</a>!&quot;);
<a name="l02582"></a>02582 
<a name="l02583"></a>02583     <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (<a class="code" href="../../d5/d09/apps_2email_2test_2integration_2_r_e_a_d_m_e_8md.html#ad995d7ecb156c0e4738ce089b58e2714">this</a>._expectDeath)
<a name="l02584"></a>02584       throw new <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(&quot;Already expecting our death!  &quot; +
<a name="l02585"></a>02585                       &quot;Are you using asyncEventsAreComingDoNotResolve?&quot;);
<a name="l02586"></a>02586     <a class="code" href="../../d5/d09/apps_2email_2test_2integration_2_r_e_a_d_m_e_8md.html#ad995d7ecb156c0e4738ce089b58e2714">this</a>._expectDeath = <a class="code" href="../../d7/dd2/qcmstypes_8h.html#a41f9c5fb8b08eb5dc3edce4dcb37fee7">true</a>;
<a name="l02587"></a>02587   },
<a name="l02588"></a>02588 
<a name="l02600"></a>02600   expectUseSetMatching: <a class="code" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>() {
<a name="l02601"></a>02601     this._unorderedSetMode = <span class="keyword">true</span>;
<a name="l02602"></a>02602   },
<a name="l02603"></a>02603 
<a name="l02609"></a>02609   __prepForTestStep: <span class="keyword">function</span>(testRuntimeContext) {
<a name="l02610"></a>02610     <span class="keywordflow">if</span> (!this._logger)
<a name="l02611"></a>02611       testRuntimeContext.reportPendingActor(<span class="keyword">this</span>);
<a name="l02612"></a>02612     <span class="comment">// we should have no expectations going into a test step.</span>
<a name="l02613"></a>02613     <span class="keywordflow">if</span> (this._activeForTestStep)
<a name="l02614"></a>02614       this.__resetExpectations();
<a name="l02615"></a>02615     this._activeForTestStep = <span class="keyword">true</span>;
<a name="l02616"></a>02616     <span class="comment">// and also all current entries should not be considered for expectations</span>
<a name="l02617"></a>02617     <span class="comment">// (We originally considered that we could let loggers accumulate entries</span>
<a name="l02618"></a>02618     <span class="comment">//  in the background and then specify expectations about them in a</span>
<a name="l02619"></a>02619     <span class="comment">//  subsequent step.  That seems confusing.  Seems far better for us to</span>
<a name="l02620"></a>02620     <span class="comment">//  just slice a single step into multiple perspectives...)</span>
<a name="l02621"></a>02621     <span class="keywordflow">if</span> (this._logger)
<a name="l02622"></a>02622       this._iEntry = this._logger._entries.length;
<a name="l02623"></a>02623   },
<a name="l02624"></a>02624 
<a name="l02630"></a>02630   __waitForExpectations: <span class="keyword">function</span>() {
<a name="l02631"></a>02631     <span class="keywordflow">if</span> (this._expectNothing &amp;&amp;
<a name="l02632"></a>02632         (this._expectations.length || <span class="keyword">this</span>._iExpectation))
<a name="l02633"></a>02633       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02634"></a>02634     <span class="comment">// Fail immediately if a synchronous check already failed.  (It would</span>
<a name="l02635"></a>02635     <span class="comment">// have tried to generate a rejection, but there was no deferral at the</span>
<a name="l02636"></a>02636     <span class="comment">// time.)</span>
<a name="l02637"></a>02637     <span class="keywordflow">if</span> (!this._expectationsMetSoFar)
<a name="l02638"></a>02638       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02639"></a>02639     <span class="keywordflow">if</span> ((this._iExpectation &gt;= this._expectations.length) &amp;&amp;
<a name="l02640"></a>02640         (this._expectDeath ? (this._logger &amp;&amp; this._logger._died) : <span class="keyword">true</span>)) {
<a name="l02641"></a>02641       this._resolved = <span class="keyword">true</span>;
<a name="l02642"></a>02642       <span class="keywordflow">return</span> this._expectationsMetSoFar;
<a name="l02643"></a>02643     }
<a name="l02644"></a>02644 
<a name="l02645"></a>02645     <span class="keywordflow">if</span> (!this._deferred)
<a name="l02646"></a>02646       this._deferred = $Q.defer();
<a name="l02647"></a>02647     <span class="keywordflow">return</span> this._deferred.promise;
<a name="l02648"></a>02648   },
<a name="l02649"></a>02649 
<a name="l02650"></a>02650   __stepCleanup: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02651"></a>02651 
<a name="l02661"></a>02661   __resetExpectations: <span class="keyword">function</span>() {
<a name="l02662"></a>02662     <span class="keywordflow">if</span> (this.__stepCleanup)
<a name="l02663"></a>02663       this.__stepCleanup();
<a name="l02664"></a>02664 
<a name="l02665"></a>02665     var expectationsWereMet = this._expectationsMetSoFar;
<a name="l02666"></a>02666     this._expectationsMetSoFar = <span class="keyword">true</span>;
<a name="l02667"></a>02667     <span class="comment">// kill all processed entries.</span>
<a name="l02668"></a>02668     this._iExpectation = 0;
<a name="l02669"></a>02669     this._ignore = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02670"></a>02670     this._expectations.splice(0, this._expectations.length);
<a name="l02671"></a>02671     this._expectNothing = <span class="keyword">false</span>;
<a name="l02672"></a>02672     this._expectDeath = <span class="keyword">false</span>;
<a name="l02673"></a>02673     this._unorderedSetMode = <span class="keyword">false</span>;
<a name="l02674"></a>02674     this._deferred = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02675"></a>02675     this._resolved = <span class="keyword">false</span>;
<a name="l02676"></a>02676     this._activeForTestStep = <span class="keyword">false</span>;
<a name="l02677"></a>02677     <span class="keywordflow">return</span> expectationsWereMet;
<a name="l02678"></a>02678   },
<a name="l02679"></a>02679 
<a name="l02680"></a>02680   __failUnmetExpectations: <span class="keyword">function</span>() {
<a name="l02681"></a>02681     <span class="keywordflow">if</span> (this._iExpectation &lt; this._expectations.length &amp;&amp; <span class="keyword">this</span>._logger) {
<a name="l02682"></a>02682       <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = this._iExpectation; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; this._expectations.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l02683"></a>02683         this._logger.__failedExpectation(this._expectations[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]);
<a name="l02684"></a>02684       }
<a name="l02685"></a>02685     }
<a name="l02686"></a>02686     <span class="keywordflow">if</span> (this._expectDeath &amp;&amp; !this._logger._died)
<a name="l02687"></a>02687       this._logger.__failedExpectation(DIED_EXP);
<a name="l02688"></a>02688   },
<a name="l02689"></a>02689 
<a name="l02695"></a>02695   __loggerFired: <span class="keyword">function</span>() {
<a name="l02696"></a>02696     <span class="comment">// we can&#39;t do anything if we don&#39;t have an actor.</span>
<a name="l02697"></a>02697     var entries = this._logger._entries, expy, entry;
<a name="l02698"></a>02698     <span class="comment">// -- unordered mode</span>
<a name="l02699"></a>02699     <span class="keywordflow">if</span> (this._unorderedSetMode) {
<a name="l02700"></a>02700 
<a name="l02701"></a>02701       <span class="keywordflow">while</span> (this._iExpectation &lt; this._expectations.length &amp;&amp;
<a name="l02702"></a>02702              <span class="keyword">this</span>._iEntry &lt; entries.length) {
<a name="l02703"></a>02703         entry = entries[this._iEntry++];
<a name="l02704"></a>02704         <span class="comment">// ignore meta-entries (which are prefixed with a &#39;!&#39;)</span>
<a name="l02705"></a>02705         <span class="keywordflow">if</span> (entry[0][0] === <span class="stringliteral">&quot;!&quot;</span>)
<a name="l02706"></a>02706           <span class="keywordflow">continue</span>;
<a name="l02707"></a>02707         <span class="comment">// ignore ignored entries</span>
<a name="l02708"></a>02708         <span class="keywordflow">if</span> (this._ignore &amp;&amp; this._ignore.hasOwnProperty(entry[0]))
<a name="l02709"></a>02709           <span class="keywordflow">continue</span>;
<a name="l02710"></a>02710 
<a name="l02711"></a>02711         <span class="comment">// - try all the expectations for a match</span>
<a name="l02712"></a>02712         var foundMatch = <span class="keyword">false</span>;
<a name="l02713"></a>02713         <span class="keywordflow">for</span> (var iExp = this._iExpectation; iExp &lt; this._expectations.length;
<a name="l02714"></a>02714              iExp++) {
<a name="l02715"></a>02715           expy = this._expectations[iExp];
<a name="l02716"></a>02716 
<a name="l02717"></a>02717           <span class="comment">// - on matches, reorder the expectation and bump our pointer</span>
<a name="l02718"></a>02718           <span class="keywordflow">if</span> (expy[0] === entry[0] &amp;&amp;
<a name="l02719"></a>02719               <span class="keyword">this</span>[<span class="stringliteral">&#39;_verify_&#39;</span> + expy[0]](expy, entry)) {
<a name="l02720"></a>02720             <span class="keywordflow">if</span> (iExp !== this._iExpectation) {
<a name="l02721"></a>02721               this._expectations[iExp] = this._expectations[this._iExpectation];
<a name="l02722"></a>02722               this._expectations[this._iExpectation] = expy;
<a name="l02723"></a>02723             }
<a name="l02724"></a>02724             this._iExpectation++;
<a name="l02725"></a>02725             foundMatch = <span class="keyword">true</span>;
<a name="l02726"></a>02726             <span class="keywordflow">break</span>;
<a name="l02727"></a>02727           }
<a name="l02728"></a>02728         }
<a name="l02729"></a>02729         <span class="keywordflow">if</span> (!foundMatch) {
<a name="l02730"></a>02730           this._logger.__unexpectedEntry(this._iEntry - 1, entry);
<a name="l02731"></a>02731           this._expectationsMetSoFar = <span class="keyword">false</span>;
<a name="l02732"></a>02732           <span class="keywordflow">if</span> (this._deferred)
<a name="l02733"></a>02733             this._deferred.reject([this.__defName, expy, entry]);
<a name="l02734"></a>02734         }
<a name="l02735"></a>02735       }
<a name="l02736"></a>02736 
<a name="l02737"></a>02737       <span class="comment">// - generate an unexpected failure if we ran out of expectations</span>
<a name="l02738"></a>02738       <span class="keywordflow">if</span> ((this._iExpectation === this._expectations.length) &amp;&amp;
<a name="l02739"></a>02739           (entries.length &gt; <span class="keyword">this</span>._iEntry)) {
<a name="l02740"></a>02740         <span class="comment">// note: as below, there is no point trying to generate a rejection</span>
<a name="l02741"></a>02741         <span class="comment">//  at this stage.</span>
<a name="l02742"></a>02742         this._expectationsMetSoFar = <span class="keyword">false</span>;
<a name="l02743"></a>02743         <span class="comment">// no need to -1 because we haven&#39;t incremented past the entry.</span>
<a name="l02744"></a>02744         this._logger.__unexpectedEntry(this._iEntry, entries[this._iEntry]);
<a name="l02745"></a>02745         <span class="comment">// do increment past...</span>
<a name="l02746"></a>02746         this._iEntry++;
<a name="l02747"></a>02747       }
<a name="l02748"></a>02748       <span class="comment">// - generate success if we have used up our expectations</span>
<a name="l02749"></a>02749       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((this._iExpectation &gt;= this._expectations.length) &amp;&amp;
<a name="l02750"></a>02750                <span class="keyword">this</span>._deferred &amp;&amp;
<a name="l02751"></a>02751                (<span class="keyword">this</span>._expectDeath ? (<span class="keyword">this</span>._logger &amp;&amp; <span class="keyword">this</span>._logger._died)
<a name="l02752"></a>02752                                   : <span class="keyword">true</span>)) {
<a name="l02753"></a>02753         this._resolved = <span class="keyword">true</span>;
<a name="l02754"></a>02754         this._deferred.resolve();
<a name="l02755"></a>02755       }
<a name="l02756"></a>02756       <span class="keywordflow">return</span>;
<a name="l02757"></a>02757     }
<a name="l02758"></a>02758 
<a name="l02759"></a>02759     <span class="comment">// -- ordered mode</span>
<a name="l02760"></a>02760     <span class="keywordflow">while</span> (this._iExpectation &lt; this._expectations.length &amp;&amp;
<a name="l02761"></a>02761            <span class="keyword">this</span>._iEntry &lt; entries.length) {
<a name="l02762"></a>02762       expy = this._expectations[this._iExpectation];
<a name="l02763"></a>02763       entry = entries[this._iEntry++];
<a name="l02764"></a>02764 
<a name="l02765"></a>02765       <span class="comment">// ignore meta-entries (which are prefixed with a &#39;!&#39;)</span>
<a name="l02766"></a>02766       <span class="keywordflow">if</span> (entry[0][0] === <span class="stringliteral">&quot;!&quot;</span>)
<a name="l02767"></a>02767         <span class="keywordflow">continue</span>;
<a name="l02768"></a>02768         <span class="comment">// ignore ignored entries</span>
<a name="l02769"></a>02769       <span class="keywordflow">if</span> (this._ignore &amp;&amp; this._ignore.hasOwnProperty(entry[0]))
<a name="l02770"></a>02770         <span class="keywordflow">continue</span>;
<a name="l02771"></a>02771 
<a name="l02772"></a>02772       <span class="comment">// Currently, require exact pairwise matching between entries and</span>
<a name="l02773"></a>02773       <span class="comment">//  expectations.</span>
<a name="l02774"></a>02774       <span class="keywordflow">if</span> (expy[0] !== entry[0]) {
<a name="l02775"></a>02775         this._logger.__unexpectedEntry(this._iEntry - 1, entry);
<a name="l02776"></a>02776         <span class="comment">// (fallout, triggers error)</span>
<a name="l02777"></a>02777       }
<a name="l02778"></a>02778       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<span class="keyword">this</span>[<span class="stringliteral">&#39;_verify_&#39;</span> + expy[0]](expy, entry)) {
<a name="l02779"></a>02779         this._logger.__mismatchEntry(this._iEntry - 1, expy, entry);
<a name="l02780"></a>02780         <span class="comment">// things did line up correctly though, so boost the expecation number</span>
<a name="l02781"></a>02781         <span class="comment">//  so we don&#39;t convert subsequent expectations into unexpected ones.</span>
<a name="l02782"></a>02782         this._iExpectation++;
<a name="l02783"></a>02783         <span class="comment">// (fallout, triggers error)</span>
<a name="l02784"></a>02784       }
<a name="l02785"></a>02785       <span class="keywordflow">else</span> {
<a name="l02786"></a>02786         this._iExpectation++;
<a name="l02787"></a>02787         <span class="keywordflow">continue</span>;
<a name="l02788"></a>02788       }
<a name="l02789"></a>02789       <span class="comment">// (only bad cases fall out without hitting a continue)</span>
<a name="l02790"></a>02790       <span class="keywordflow">if</span> (this._expectationsMetSoFar) {
<a name="l02791"></a>02791         this._expectationsMetSoFar = <span class="keyword">false</span>;
<a name="l02792"></a>02792         <span class="keywordflow">if</span> (this._deferred)
<a name="l02793"></a>02793           this._deferred.reject([this.__defName, expy, entry]);
<a name="l02794"></a>02794       }
<a name="l02795"></a>02795       <span class="keywordflow">return</span>;
<a name="l02796"></a>02796     }
<a name="l02797"></a>02797     <span class="comment">// - unexpected log events should count as failure</span>
<a name="l02798"></a>02798     <span class="comment">// We only care if: 1) we were marked active, 2) we had at least one</span>
<a name="l02799"></a>02799     <span class="comment">//  expectation this step OR we were explicitly marked to have no</span>
<a name="l02800"></a>02800     <span class="comment">//  expectations this step.</span>
<a name="l02801"></a>02801     <span class="comment">// Because we will already have resolved() our promise if we get here,</span>
<a name="l02802"></a>02802     <span class="comment">//  it&#39;s up to the test driver to come back and check us for this weird</span>
<a name="l02803"></a>02803     <span class="comment">//  failure, possibly after waiting a tick to see if any additional events</span>
<a name="l02804"></a>02804     <span class="comment">//  come in.</span>
<a name="l02805"></a>02805     <span class="keywordflow">if</span> (this._activeForTestStep &amp;&amp;
<a name="l02806"></a>02806         ((this._expectations.length &amp;&amp;
<a name="l02807"></a>02807           (<span class="keyword">this</span>._iExpectation === <span class="keyword">this</span>._expectations.length) &amp;&amp;
<a name="l02808"></a>02808           (entries.length &gt; <span class="keyword">this</span>._iEntry)) ||
<a name="l02809"></a>02809          (!<span class="keyword">this</span>._expectations.length &amp;&amp;
<a name="l02810"></a>02810           <span class="keyword">this</span>._expectNothing))) {
<a name="l02811"></a>02811       <span class="comment">// Only get upset if this is not an ignored event.</span>
<a name="l02812"></a>02812       <span class="keywordflow">if</span> (!this._ignore ||
<a name="l02813"></a>02813           !this._ignore.hasOwnProperty(entries[<span class="keyword">this</span>._iEntry][0])) {
<a name="l02814"></a>02814         this._expectationsMetSoFar = <span class="keyword">false</span>;
<a name="l02815"></a>02815         this._logger.__unexpectedEntry(this._iEntry, entries[this._iEntry]);
<a name="l02816"></a>02816       }
<a name="l02817"></a>02817       <span class="comment">// We intentionally increment iEntry because otherwise we&#39;ll keep marking</span>
<a name="l02818"></a>02818       <span class="comment">// the same entry as unexpected when that is in fact not what we desire.</span>
<a name="l02819"></a>02819       <span class="comment">// In previous parts of this function it made sense not to increment, but</span>
<a name="l02820"></a>02820       <span class="comment">// here it just causes confusion.</span>
<a name="l02821"></a>02821       this._iEntry++;
<a name="l02822"></a>02822     }
<a name="l02823"></a>02823 
<a name="l02824"></a>02824     <span class="keywordflow">if</span> ((this._iExpectation &gt;= this._expectations.length) &amp;&amp; <span class="keyword">this</span>._deferred &amp;&amp;
<a name="l02825"></a>02825         (<span class="keyword">this</span>._expectDeath ? (<span class="keyword">this</span>._logger &amp;&amp; <span class="keyword">this</span>._logger._died) : <span class="keyword">true</span>)) {
<a name="l02826"></a>02826       this._resolved = <span class="keyword">true</span>;
<a name="l02827"></a>02827       this._deferred.resolve();
<a name="l02828"></a>02828     }
<a name="l02829"></a>02829   },
<a name="l02830"></a>02830 };
<a name="l02831"></a>02831 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TestActorProtoBase = TestActorProtoBase;
<a name="l02832"></a>02832 
<a name="l02845"></a>02845 <span class="keyword">function</span> simplifyInsaneObjects(<a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>, dtype, curDepth) {
<a name="l02846"></a>02846   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a> == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> || <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>) !== <span class="stringliteral">&quot;object&quot;</span>)
<a name="l02847"></a>02847     <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>;
<a name="l02848"></a>02848   <span class="keywordflow">if</span> (!curDepth)
<a name="l02849"></a>02849     curDepth = 0;
<a name="l02850"></a>02850   var nextDepth = curDepth + 1;
<a name="l02851"></a>02851   var limitStrings = 64;
<a name="l02852"></a>02852 
<a name="l02853"></a>02853   <span class="keywordflow">if</span> (dtype) {
<a name="l02854"></a>02854     <span class="keywordflow">if</span> (dtype === <span class="stringliteral">&#39;tostring&#39;</span>) {
<a name="l02855"></a>02855       <span class="keywordflow">if</span> (Array.isArray(<a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>))
<a name="l02856"></a>02856         <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>.join(<span class="stringliteral">&#39;&#39;</span>);
<a name="l02857"></a>02857       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>) !== <span class="stringliteral">&#39;string&#39;</span>)
<a name="l02858"></a>02858         <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>.toString();
<a name="l02859"></a>02859     }
<a name="l02860"></a>02860   }
<a name="l02861"></a>02861 
<a name="l02862"></a>02862   var oot = {};
<a name="l02863"></a>02863   <span class="keywordflow">for</span> (var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>) {
<a name="l02864"></a>02864     var <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a> = obj[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l02865"></a>02865     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(val)) {
<a name="l02866"></a>02866       <span class="keywordflow">case</span> <span class="stringliteral">&quot;string&quot;</span>:
<a name="l02867"></a>02867         <span class="keywordflow">if</span> (limitStrings &amp;&amp; val.length &gt; limitStrings) {
<a name="l02868"></a>02868           oot[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <span class="stringliteral">&quot;OMITTED STRING, originally &quot;</span> + val.length +
<a name="l02869"></a>02869                        <span class="stringliteral">&quot; bytes long&quot;</span>;
<a name="l02870"></a>02870         }
<a name="l02871"></a>02871         <span class="keywordflow">else</span> {
<a name="l02872"></a>02872           oot[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l02873"></a>02873         }
<a name="l02874"></a>02874         <span class="keywordflow">break</span>;
<a name="l02875"></a>02875       <span class="keywordflow">case</span> <span class="stringliteral">&quot;object&quot;</span>:
<a name="l02876"></a>02876         <span class="keywordflow">if</span> (val == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> ||
<a name="l02877"></a>02877             Array.isArray(val) ||
<a name="l02878"></a>02878             (<span class="stringliteral">&quot;toJSON&quot;</span> in <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>) ||
<a name="l02879"></a>02879             curDepth &gt;= 2) {
<a name="l02880"></a>02880           oot[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l02881"></a>02881         }
<a name="l02882"></a>02882         <span class="keywordflow">else</span> {
<a name="l02883"></a>02883           oot[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = simplifyInsaneObjects(val, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, nextDepth);
<a name="l02884"></a>02884         }
<a name="l02885"></a>02885         <span class="keywordflow">break</span>;
<a name="l02886"></a>02886       <span class="keywordflow">default</span>:
<a name="l02887"></a>02887         oot[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l02888"></a>02888         <span class="keywordflow">break</span>;
<a name="l02889"></a>02889     }
<a name="l02890"></a>02890   }
<a name="l02891"></a>02891   <span class="keywordflow">return</span> oot;
<a name="l02892"></a>02892 }
<a name="l02893"></a>02893 
<a name="l02899"></a>02899 var COMPARE_DEPTH = 6;
<a name="l02900"></a>02900 <span class="keyword">function</span> boundedCmpObjs(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>, depthLeft) {
<a name="l02901"></a>02901   var aAttrCount = 0, bAttrCount = 0, <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, nextDepth = depthLeft - 1;
<a name="l02902"></a>02902 
<a name="l02903"></a>02903   <span class="keywordflow">if</span> (<span class="stringliteral">&#39;toJSON&#39;</span> in <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>)
<a name="l02904"></a>02904     a = a.toJSON();
<a name="l02905"></a>02905   <span class="keywordflow">if</span> (<span class="stringliteral">&#39;toJSON&#39;</span> in <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>)
<a name="l02906"></a>02906     b = b.toJSON();
<a name="l02907"></a>02907 
<a name="l02908"></a>02908   <span class="keywordflow">for</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in a) {
<a name="l02909"></a>02909     aAttrCount++;
<a name="l02910"></a>02910     <span class="keywordflow">if</span> (!(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in b))
<a name="l02911"></a>02911       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02912"></a>02912 
<a name="l02913"></a>02913     <span class="keywordflow">if</span> (depthLeft) {
<a name="l02914"></a>02914       <span class="keywordflow">if</span> (!smartCompareEquiv(a[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>], b[key], nextDepth))
<a name="l02915"></a>02915         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02916"></a>02916     }
<a name="l02917"></a>02917     <span class="keywordflow">else</span> {
<a name="l02918"></a>02918       <span class="keywordflow">if</span> (a[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] !== b[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>])
<a name="l02919"></a>02919         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02920"></a>02920     }
<a name="l02921"></a>02921   }
<a name="l02922"></a>02922   <span class="comment">// the theory is that if every key in a is in b and its value is equal, and</span>
<a name="l02923"></a>02923   <span class="comment">//  there are the same number of keys in b, then they must be equal.</span>
<a name="l02924"></a>02924   <span class="keywordflow">for</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in b) {
<a name="l02925"></a>02925     bAttrCount++;
<a name="l02926"></a>02926   }
<a name="l02927"></a>02927   <span class="keywordflow">if</span> (aAttrCount !== bAttrCount)
<a name="l02928"></a>02928     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02929"></a>02929   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02930"></a>02930 }
<a name="l02931"></a>02931 
<a name="l02937"></a>02937 <span class="keyword">function</span> smartCompareEquiv(a, b, depthLeft) {
<a name="l02938"></a>02938   var ta = <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(a), tb = <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(b);
<a name="l02939"></a>02939   <span class="keywordflow">if</span> (ta !== <span class="stringliteral">&#39;object&#39;</span> || (tb !== ta) || (a == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) || (b == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>))
<a name="l02940"></a>02940     <span class="keywordflow">return</span> a === <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>;
<a name="l02941"></a>02941   <span class="comment">// fast-path for identical objects</span>
<a name="l02942"></a>02942   <span class="keywordflow">if</span> (a === b)
<a name="l02943"></a>02943     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02944"></a>02944   <span class="keywordflow">if</span> (Array.isArray(a)) {
<a name="l02945"></a>02945     <span class="keywordflow">if</span> (!Array.isArray(b))
<a name="l02946"></a>02946       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02947"></a>02947     <span class="keywordflow">if</span> (a.length !== b.length)
<a name="l02948"></a>02948       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02949"></a>02949     <span class="keywordflow">for</span> (var iArr = 0; iArr &lt; a.length; iArr++) {
<a name="l02950"></a>02950       <span class="keywordflow">if</span> (!smartCompareEquiv(a[iArr], b[iArr], depthLeft - 1))
<a name="l02951"></a>02951         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02952"></a>02952     }
<a name="l02953"></a>02953     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02954"></a>02954   }
<a name="l02955"></a>02955   <span class="keywordflow">return</span> boundedCmpObjs(a, b, depthLeft);
<a name="l02956"></a>02956 }
<a name="l02957"></a>02957 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.smartCompareEquiv = smartCompareEquiv;
<a name="l02958"></a>02958 
<a name="l02959"></a>02959 <span class="keyword">function</span> makeIgnoreFunc(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>) {
<a name="l02960"></a>02960   <span class="keywordflow">return</span> <span class="keyword">function</span> ignoreFunc() {
<a name="l02961"></a>02961     <span class="keywordflow">if</span> (!this._ignore)
<a name="l02962"></a>02962       this._ignore = {};
<a name="l02963"></a>02963     this._ignore[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">true</span>;
<a name="l02964"></a>02964   };
<a name="l02965"></a>02965 };
<a name="l02966"></a>02966 
<a name="l02974"></a>02974 <span class="keyword">function</span> LoggestClassMaker(moduleFab, <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>) {
<a name="l02975"></a>02975   this.moduleFab = moduleFab;
<a name="l02976"></a>02976   this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l02977"></a>02977 
<a name="l02978"></a>02978   this._latchedVars = [];
<a name="l02979"></a>02979 
<a name="l02980"></a>02980   <span class="comment">// steady-state minimal logging logger (we always want statistics!)</span>
<a name="l02981"></a>02981   var dummyProto = this.dummyProto = Object.create(DummyLogProtoBase);
<a name="l02982"></a>02982   dummyProto.__defName = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l02983"></a>02983   dummyProto.__latchedVars = this._latchedVars;
<a name="l02984"></a>02984   dummyProto.__FAB = this.moduleFab;
<a name="l02985"></a>02985 
<a name="l02986"></a>02986   <span class="comment">// full-logging logger</span>
<a name="l02987"></a>02987   var logProto = this.logProto = Object.create(LogProtoBase);
<a name="l02988"></a>02988   logProto.__defName = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l02989"></a>02989   logProto.__latchedVars = this._latchedVars;
<a name="l02990"></a>02990   logProto.__FAB = this.moduleFab;
<a name="l02991"></a>02991 
<a name="l02992"></a>02992   <span class="comment">// testing full-logging logger</span>
<a name="l02993"></a>02993   var testLogProto = this.testLogProto = Object.create(TestLogProtoBase);
<a name="l02994"></a>02994   testLogProto.__defName = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l02995"></a>02995   testLogProto.__latchedVars = this._latchedVars;
<a name="l02996"></a>02996   testLogProto.__FAB = this.moduleFab;
<a name="l02997"></a>02997 
<a name="l02998"></a>02998   <span class="comment">// testing actor for expectations, etc.</span>
<a name="l02999"></a>02999   var testActorProto = this.testActorProto = Object.create(TestActorProtoBase);
<a name="l03000"></a>03000   testActorProto.__defName = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l03001"></a>03001 
<a name="l03003"></a>03003   this._definedAs = {};
<a name="l03004"></a>03004 }
<a name="l03005"></a>03005 LoggestClassMaker.prototype = {
<a name="l03011"></a>03011   _define: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l03012"></a>03012     <span class="keywordflow">if</span> (this._definedAs.hasOwnProperty(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>)) {
<a name="l03013"></a>03013       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to define &#39;&quot;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> + <span class="stringliteral">&quot;&#39; as a &quot;</span> + <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> +
<a name="l03014"></a>03014                       <span class="stringliteral">&quot; when it is already defined as a &quot;</span> +
<a name="l03015"></a>03015                       this._definedAs[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] + <span class="stringliteral">&quot;!&quot;</span>);
<a name="l03016"></a>03016     }
<a name="l03017"></a>03017     this._definedAs[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>;
<a name="l03018"></a>03018   },
<a name="l03019"></a>03019 
<a name="l03024"></a>03024   _wrapLogProtoForTest: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>) {
<a name="l03025"></a>03025     var logFunc = this.logProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l03026"></a>03026     this.testLogProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03027"></a>03027       var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a883d97b566da72dc454ea1438aaccb">rval</a> = logFunc.apply(<span class="keyword">this</span>, arguments);
<a name="l03028"></a>03028       var testActor = this._actor;
<a name="l03029"></a>03029       <span class="keywordflow">if</span> (testActor)
<a name="l03030"></a>03030         testActor.__loggerFired();
<a name="l03031"></a>03031       <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a883d97b566da72dc454ea1438aaccb">rval</a>;
<a name="l03032"></a>03032     };
<a name="l03033"></a>03033   },
<a name="l03034"></a>03034 
<a name="l03035"></a>03035   addStateVar: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>) {
<a name="l03036"></a>03036     this._define(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <span class="stringliteral">&#39;state&#39;</span>);
<a name="l03037"></a>03037 
<a name="l03038"></a>03038     this.dummyProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <a class="code" href="../../d1/d83/toolkit_8js.html#a7d6b2120faa6e32512aac537baa691a2">NOP</a>;
<a name="l03039"></a>03039 
<a name="l03040"></a>03040     var stateStashName = <span class="charliteral">&#39;:&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l03041"></a>03041     this.logProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>(<a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>) {
<a name="l03042"></a>03042       var oldVal = <span class="keyword">this</span>[stateStashName];
<a name="l03043"></a>03043       <span class="comment">// only log the transition if it&#39;s an actual transition</span>
<a name="l03044"></a>03044       <span class="keywordflow">if</span> (oldVal === val)
<a name="l03045"></a>03045         <span class="keywordflow">return</span>;
<a name="l03046"></a>03046       <span class="keyword">this</span>[stateStashName] = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l03047"></a>03047       this._entries.push([<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, val, $microtime.now(), gSeq++]);
<a name="l03048"></a>03048     };
<a name="l03049"></a>03049 
<a name="l03050"></a>03050     this._wrapLogProtoForTest(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03051"></a>03051 
<a name="l03052"></a>03052     this.testActorProto[<span class="stringliteral">&#39;expect_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>(<a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>) {
<a name="l03053"></a>03053       <span class="keywordflow">if</span> (!this._activeForTestStep)
<a name="l03054"></a>03054         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to set expectations on an actor (&quot;</span> +
<a name="l03055"></a>03055                         this.__defName + <span class="stringliteral">&quot;: &quot;</span> + this.__name + <span class="stringliteral">&quot;) that is not &quot;</span> +
<a name="l03056"></a>03056                         <span class="stringliteral">&quot;participating in this test step!&quot;</span>);
<a name="l03057"></a>03057       <span class="keywordflow">if</span> (this._resolved)
<a name="l03058"></a>03058         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to add expectations when already resolved!&quot;</span>);
<a name="l03059"></a>03059 
<a name="l03060"></a>03060       this._expectations.push([<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, val]);
<a name="l03061"></a>03061       <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l03062"></a>03062     };
<a name="l03063"></a>03063     this.testActorProto[<span class="stringliteral">&#39;ignore_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = makeIgnoreFunc(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03064"></a>03064     this.testActorProto[<span class="stringliteral">&#39;_verify_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>(exp, entry) {
<a name="l03065"></a>03065       <span class="keywordflow">return</span> smartCompareEquiv(exp[1], entry[1], COMPARE_DEPTH);
<a name="l03066"></a>03066     };
<a name="l03067"></a>03067   },
<a name="l03081"></a>03081   addLatchedState: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>) {
<a name="l03082"></a>03082     this._define(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <span class="stringliteral">&#39;latchedState&#39;</span>);
<a name="l03083"></a>03083     this._latchedVars.push(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03084"></a>03084     var latchedName = <span class="charliteral">&#39;:&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l03085"></a>03085 
<a name="l03086"></a>03086     this.testLogProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = this.logProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = this.dummyProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] =
<a name="l03087"></a>03087         <span class="keyword">function</span>(<a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>) {
<a name="l03088"></a>03088       <span class="keyword">this</span>[latchedName] = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l03089"></a>03089     };
<a name="l03090"></a>03090   },
<a name="l03091"></a>03091   addEvent: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>, testOnlyLogArgs) {
<a name="l03092"></a>03092     this._define(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <span class="stringliteral">&#39;event&#39;</span>);
<a name="l03093"></a>03093 
<a name="l03094"></a>03094     var numArgs = 0, useArgs = [];
<a name="l03095"></a>03095     <span class="keywordflow">for</span> (var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in args) {
<a name="l03096"></a>03096       numArgs++;
<a name="l03097"></a>03097       useArgs.push(args[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]);
<a name="l03098"></a>03098     }
<a name="l03099"></a>03099 
<a name="l03100"></a>03100     this.dummyProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03101"></a>03101       this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = (this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] || 0) + 1;
<a name="l03102"></a>03102     };
<a name="l03103"></a>03103 
<a name="l03104"></a>03104     this.logProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03105"></a>03105       this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = (this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] || 0) + 1;
<a name="l03106"></a>03106       var entry = [<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l03107"></a>03107       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; numArgs; iArg++) {
<a name="l03108"></a>03108         <span class="keywordflow">if</span> (useArgs[iArg] === EXCEPTION) {
<a name="l03109"></a>03109           var <a class="code" href="../../d2/dbe/jsprf_8h.html#ae036856e415526e58e249638733f6752">arg</a> = arguments[iArg];
<a name="l03110"></a>03110           entry.push($extransform.transformException(arg));
<a name="l03111"></a>03111         }
<a name="l03112"></a>03112         <span class="keywordflow">else</span> {
<a name="l03113"></a>03113           entry.push(arguments[iArg]);
<a name="l03114"></a>03114         }
<a name="l03115"></a>03115       }
<a name="l03116"></a>03116       entry.push($microtime.now());
<a name="l03117"></a>03117       entry.push(gSeq++);
<a name="l03118"></a>03118       this._entries.push(entry);
<a name="l03119"></a>03119     };
<a name="l03120"></a>03120 
<a name="l03121"></a>03121     <span class="keywordflow">if</span> (!testOnlyLogArgs) {
<a name="l03122"></a>03122       this._wrapLogProtoForTest(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03123"></a>03123     }
<a name="l03124"></a>03124     <span class="keywordflow">else</span> {
<a name="l03125"></a>03125       var numTestOnlyArgs = 0, useTestArgs = [];
<a name="l03126"></a>03126       <span class="keywordflow">for</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in testOnlyLogArgs) {
<a name="l03127"></a>03127         numTestOnlyArgs++;
<a name="l03128"></a>03128         useTestArgs.push(testOnlyLogArgs[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]);
<a name="l03129"></a>03129       }
<a name="l03130"></a>03130       this.testLogProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03131"></a>03131         this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = (this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] || 0) + 1;
<a name="l03132"></a>03132         var entry = [<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>], iArg;
<a name="l03133"></a>03133         <span class="keywordflow">for</span> (iArg = 0; iArg &lt; numArgs; iArg++) {
<a name="l03134"></a>03134           <span class="keywordflow">if</span> (useArgs[iArg] === EXCEPTION) {
<a name="l03135"></a>03135             var arg = arguments[iArg];
<a name="l03136"></a>03136             entry.push($extransform.transformException(arg));
<a name="l03137"></a>03137           }
<a name="l03138"></a>03138           <span class="keywordflow">else</span> {
<a name="l03139"></a>03139             entry.push(arguments[iArg]);
<a name="l03140"></a>03140           }
<a name="l03141"></a>03141         }
<a name="l03142"></a>03142         entry.push($microtime.now());
<a name="l03143"></a>03143         entry.push(gSeq++);
<a name="l03144"></a>03144         <span class="comment">// ++ new bit</span>
<a name="l03145"></a>03145         <span class="keywordflow">for</span> (var iEat=0; iEat &lt; numTestOnlyArgs; iEat++, iArg++) {
<a name="l03146"></a>03146           entry.push(simplifyInsaneObjects(arguments[iArg], useTestArgs[iEat]));
<a name="l03147"></a>03147         }
<a name="l03148"></a>03148         <span class="comment">// -- end new bit</span>
<a name="l03149"></a>03149         this._entries.push(entry);
<a name="l03150"></a>03150         <span class="comment">// ++ firing bit...</span>
<a name="l03151"></a>03151         var testActor = this._actor;
<a name="l03152"></a>03152         <span class="keywordflow">if</span> (testActor)
<a name="l03153"></a>03153           testActor.__loggerFired();
<a name="l03154"></a>03154       };
<a name="l03155"></a>03155     }
<a name="l03156"></a>03156 
<a name="l03157"></a>03157     this.testActorProto[<span class="stringliteral">&#39;expect_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03158"></a>03158       <span class="keywordflow">if</span> (!this._activeForTestStep)
<a name="l03159"></a>03159         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to set expectations on an actor (&quot;</span> +
<a name="l03160"></a>03160                         this.__defName + <span class="stringliteral">&quot;: &quot;</span> + this.__name + <span class="stringliteral">&quot;) that is not &quot;</span> +
<a name="l03161"></a>03161                         <span class="stringliteral">&quot;participating in this test step!&quot;</span>);
<a name="l03162"></a>03162       <span class="keywordflow">if</span> (this._resolved)
<a name="l03163"></a>03163         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to add expectations when already resolved!&quot;</span>);
<a name="l03164"></a>03164 
<a name="l03165"></a>03165       var exp = [<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l03166"></a>03166       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; arguments.length; iArg++) {
<a name="l03167"></a>03167         <span class="keywordflow">if</span> (useArgs[iArg] &amp;&amp; useArgs[iArg] !== EXCEPTION) {
<a name="l03168"></a>03168           exp.push(arguments[iArg]);
<a name="l03169"></a>03169         }
<a name="l03170"></a>03170       }
<a name="l03171"></a>03171       this._expectations.push(exp);
<a name="l03172"></a>03172       <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l03173"></a>03173     };
<a name="l03174"></a>03174     this.testActorProto[<span class="stringliteral">&#39;ignore_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = makeIgnoreFunc(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03175"></a>03175     this.testActorProto[<span class="stringliteral">&#39;_verify_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>(tupe, entry) {
<a name="l03176"></a>03176       <span class="comment">// only check arguments we had expectations for.</span>
<a name="l03177"></a>03177       <span class="keywordflow">for</span> (var iArg = 1; iArg &lt; tupe.length; iArg++) {
<a name="l03178"></a>03178         <span class="keywordflow">if</span> (!smartCompareEquiv(tupe[iArg], entry[iArg], COMPARE_DEPTH))
<a name="l03179"></a>03179           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03180"></a>03180       }
<a name="l03181"></a>03181       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03182"></a>03182     };
<a name="l03183"></a>03183   },
<a name="l03184"></a>03184   addAsyncJob: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>, testOnlyLogArgs) {
<a name="l03185"></a>03185     var name_begin = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> + <span class="stringliteral">&#39;_begin&#39;</span>, name_end = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> + <span class="stringliteral">&#39;_end&#39;</span>;
<a name="l03186"></a>03186     this.dummyProto[name_begin] = <a class="code" href="../../d1/d83/toolkit_8js.html#a7d6b2120faa6e32512aac537baa691a2">NOP</a>;
<a name="l03187"></a>03187     this.dummyProto[name_end] = <a class="code" href="../../d1/d83/toolkit_8js.html#a7d6b2120faa6e32512aac537baa691a2">NOP</a>;
<a name="l03188"></a>03188 
<a name="l03189"></a>03189     var numArgs = 0, numTestOnlyArgs = 0, useArgs = [], useTestArgs = [];
<a name="l03190"></a>03190     <span class="keywordflow">for</span> (var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in args) {
<a name="l03191"></a>03191       numArgs++;
<a name="l03192"></a>03192       useArgs.push(args[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]);
<a name="l03193"></a>03193     }
<a name="l03194"></a>03194 
<a name="l03195"></a>03195     this.logProto[name_begin] = <span class="keyword">function</span>() {
<a name="l03196"></a>03196       this._eventMap[name_begin] = (this._eventMap[name_begin] || 0) + 1;
<a name="l03197"></a>03197       var entry = [name_begin];
<a name="l03198"></a>03198       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; numArgs; iArg++) {
<a name="l03199"></a>03199         <span class="keywordflow">if</span> (useArgs[iArg] === EXCEPTION) {
<a name="l03200"></a>03200           var arg = arguments[iArg];
<a name="l03201"></a>03201           entry.push($extransform.transformException(arg));
<a name="l03202"></a>03202         }
<a name="l03203"></a>03203         <span class="keywordflow">else</span> {
<a name="l03204"></a>03204           entry.push(arguments[iArg]);
<a name="l03205"></a>03205         }
<a name="l03206"></a>03206       }
<a name="l03207"></a>03207       entry.push($microtime.now());
<a name="l03208"></a>03208       entry.push(gSeq++);
<a name="l03209"></a>03209       this._entries.push(entry);
<a name="l03210"></a>03210     };
<a name="l03211"></a>03211     this.logProto[name_end] = <span class="keyword">function</span>() {
<a name="l03212"></a>03212       this._eventMap[name_end] = (this._eventMap[name_end] || 0) + 1;
<a name="l03213"></a>03213       var entry = [name_end];
<a name="l03214"></a>03214       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; numArgs; iArg++) {
<a name="l03215"></a>03215         <span class="keywordflow">if</span> (useArgs[iArg] === EXCEPTION) {
<a name="l03216"></a>03216           var arg = arguments[iArg];
<a name="l03217"></a>03217           entry.push($extransform.transformException(arg));
<a name="l03218"></a>03218         }
<a name="l03219"></a>03219         <span class="keywordflow">else</span> {
<a name="l03220"></a>03220           entry.push(arguments[iArg]);
<a name="l03221"></a>03221         }
<a name="l03222"></a>03222       }
<a name="l03223"></a>03223       entry.push($microtime.now());
<a name="l03224"></a>03224       entry.push(gSeq++);
<a name="l03225"></a>03225       this._entries.push(entry);
<a name="l03226"></a>03226     };
<a name="l03227"></a>03227 
<a name="l03228"></a>03228     <span class="keywordflow">if</span> (!testOnlyLogArgs) {
<a name="l03229"></a>03229       this._wrapLogProtoForTest(name_begin);
<a name="l03230"></a>03230       this._wrapLogProtoForTest(name_end);
<a name="l03231"></a>03231     }
<a name="l03232"></a>03232     <span class="keywordflow">else</span> {
<a name="l03233"></a>03233       <span class="keywordflow">for</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in testOnlyLogArgs) {
<a name="l03234"></a>03234         numTestOnlyArgs++;
<a name="l03235"></a>03235         useTestArgs.push(testOnlyLogArgs[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]);
<a name="l03236"></a>03236       }
<a name="l03237"></a>03237       <span class="comment">// cut-paste-modify of the above...</span>
<a name="l03238"></a>03238       this.testLogProto[name_begin] = <span class="keyword">function</span>() {
<a name="l03239"></a>03239         this._eventMap[name_begin] = (this._eventMap[name_begin] || 0) + 1;
<a name="l03240"></a>03240         var entry = [name_begin];
<a name="l03241"></a>03241         <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; numArgs; iArg++) {
<a name="l03242"></a>03242           <span class="keywordflow">if</span> (useArgs[iArg] === EXCEPTION) {
<a name="l03243"></a>03243             var arg = arguments[iArg];
<a name="l03244"></a>03244             entry.push($extransform.transformException(arg));
<a name="l03245"></a>03245           }
<a name="l03246"></a>03246           <span class="keywordflow">else</span> {
<a name="l03247"></a>03247             entry.push(arguments[iArg]);
<a name="l03248"></a>03248           }
<a name="l03249"></a>03249         }
<a name="l03250"></a>03250         entry.push($microtime.now());
<a name="l03251"></a>03251         entry.push(gSeq++);
<a name="l03252"></a>03252         <span class="comment">// ++ new bit</span>
<a name="l03253"></a>03253         <span class="keywordflow">for</span> (var iEat=0; iEat &lt; numTestOnlyArgs; iEat++, iArg++) {
<a name="l03254"></a>03254           entry.push(simplifyInsaneObjects(arguments[iArg], useTestArgs[iEat]));
<a name="l03255"></a>03255         }
<a name="l03256"></a>03256         <span class="comment">// -- end new bit</span>
<a name="l03257"></a>03257         this._entries.push(entry);
<a name="l03258"></a>03258         <span class="comment">// ++ firing bit...</span>
<a name="l03259"></a>03259         var testActor = this._actor;
<a name="l03260"></a>03260         <span class="keywordflow">if</span> (testActor)
<a name="l03261"></a>03261           testActor.__loggerFired();
<a name="l03262"></a>03262       };
<a name="l03263"></a>03263       this.testLogProto[name_end] = <span class="keyword">function</span>() {
<a name="l03264"></a>03264         this._eventMap[name_end] = (this._eventMap[name_end] || 0) + 1;
<a name="l03265"></a>03265         var entry = [name_end];
<a name="l03266"></a>03266         <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; numArgs; iArg++) {
<a name="l03267"></a>03267           <span class="keywordflow">if</span> (useArgs[iArg] === EXCEPTION) {
<a name="l03268"></a>03268             var arg = arguments[iArg];
<a name="l03269"></a>03269             entry.push($extransform.transformException(arg));
<a name="l03270"></a>03270           }
<a name="l03271"></a>03271           <span class="keywordflow">else</span> {
<a name="l03272"></a>03272             entry.push(arguments[iArg]);
<a name="l03273"></a>03273           }
<a name="l03274"></a>03274         }
<a name="l03275"></a>03275         entry.push($microtime.now());
<a name="l03276"></a>03276         entry.push(gSeq++);
<a name="l03277"></a>03277         <span class="comment">// ++ new bit</span>
<a name="l03278"></a>03278         <span class="keywordflow">for</span> (var iEat=0; iEat &lt; numTestOnlyArgs; iEat++, iArg++) {
<a name="l03279"></a>03279           entry.push(simplifyInsaneObjects(arguments[iArg], useTestArgs[iEat]));
<a name="l03280"></a>03280         }
<a name="l03281"></a>03281         <span class="comment">// -- end new bit</span>
<a name="l03282"></a>03282         this._entries.push(entry);
<a name="l03283"></a>03283         <span class="comment">// ++ firing bit...</span>
<a name="l03284"></a>03284         var testActor = this._actor;
<a name="l03285"></a>03285         <span class="keywordflow">if</span> (testActor)
<a name="l03286"></a>03286           testActor.__loggerFired();
<a name="l03287"></a>03287       };
<a name="l03288"></a>03288     }
<a name="l03289"></a>03289 
<a name="l03290"></a>03290     this.testActorProto[<span class="stringliteral">&#39;expect_&#39;</span> + name_begin] = <span class="keyword">function</span>() {
<a name="l03291"></a>03291       <span class="keywordflow">if</span> (!this._activeForTestStep)
<a name="l03292"></a>03292         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to set expectations on an actor (&quot;</span> +
<a name="l03293"></a>03293                         this.__defName + <span class="stringliteral">&quot;: &quot;</span> + this.__name + <span class="stringliteral">&quot;) that is not &quot;</span> +
<a name="l03294"></a>03294                         <span class="stringliteral">&quot;participating in this test step!&quot;</span>);
<a name="l03295"></a>03295       <span class="keywordflow">if</span> (this._resolved)
<a name="l03296"></a>03296         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to add expectations when already resolved!&quot;</span>);
<a name="l03297"></a>03297 
<a name="l03298"></a>03298       var exp = [name_begin];
<a name="l03299"></a>03299       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; arguments.length; iArg++) {
<a name="l03300"></a>03300         <span class="keywordflow">if</span> (useArgs[iArg] &amp;&amp; useArgs[iArg] !== EXCEPTION)
<a name="l03301"></a>03301           exp.push(arguments[iArg]);
<a name="l03302"></a>03302       }
<a name="l03303"></a>03303       this._expectations.push(exp);
<a name="l03304"></a>03304       <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l03305"></a>03305     };
<a name="l03306"></a>03306     this.testActorProto[<span class="stringliteral">&#39;ignore_&#39;</span> + name_begin] = makeIgnoreFunc(name_begin);
<a name="l03307"></a>03307     this.testActorProto[<span class="stringliteral">&#39;expect_&#39;</span> + name_end] = <span class="keyword">function</span>() {
<a name="l03308"></a>03308       <span class="keywordflow">if</span> (!this._activeForTestStep)
<a name="l03309"></a>03309         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to set expectations on an actor (&quot;</span> +
<a name="l03310"></a>03310                         this.__defName + <span class="stringliteral">&quot;: &quot;</span> + this.__name + <span class="stringliteral">&quot;) that is not &quot;</span> +
<a name="l03311"></a>03311                         <span class="stringliteral">&quot;participating in this test step!&quot;</span>);
<a name="l03312"></a>03312       <span class="keywordflow">if</span> (this._resolved)
<a name="l03313"></a>03313         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to add expectations when already resolved!&quot;</span>);
<a name="l03314"></a>03314 
<a name="l03315"></a>03315       var exp = [name_end];
<a name="l03316"></a>03316       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; arguments.length; iArg++) {
<a name="l03317"></a>03317         <span class="keywordflow">if</span> (useArgs[iArg] &amp;&amp; useArgs[iArg] !== EXCEPTION)
<a name="l03318"></a>03318           exp.push(arguments[iArg]);
<a name="l03319"></a>03319       }
<a name="l03320"></a>03320       this._expectations.push(exp);
<a name="l03321"></a>03321       <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l03322"></a>03322     };
<a name="l03323"></a>03323     this.testActorProto[<span class="stringliteral">&#39;ignore_&#39;</span> + name_end] = makeIgnoreFunc(name_end);
<a name="l03324"></a>03324     this.testActorProto[<span class="stringliteral">&#39;_verify_&#39;</span> + name_begin] =
<a name="l03325"></a>03325         this.testActorProto[<span class="stringliteral">&#39;_verify_&#39;</span> + name_end] = <span class="keyword">function</span>(tupe, entry) {
<a name="l03326"></a>03326       <span class="comment">// only check arguments we had expectations for.</span>
<a name="l03327"></a>03327       <span class="keywordflow">for</span> (var iArg = 1; iArg &lt; tupe.length; iArg++) {
<a name="l03328"></a>03328         <span class="keywordflow">if</span> (!smartCompareEquiv(tupe[iArg], entry[iArg], COMPARE_DEPTH))
<a name="l03329"></a>03329           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03330"></a>03330       }
<a name="l03331"></a>03331       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03332"></a>03332     };
<a name="l03333"></a>03333   },
<a name="l03338"></a>03338   addCall: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, logArgs, testOnlyLogArgs) {
<a name="l03339"></a>03339     this._define(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <span class="stringliteral">&#39;call&#39;</span>);
<a name="l03340"></a>03340 
<a name="l03341"></a>03341     var numLogArgs = 0, numTestOnlyArgs = 0, useArgs = [], useTestArgs = [];
<a name="l03342"></a>03342     <span class="keywordflow">for</span> (var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in logArgs) {
<a name="l03343"></a>03343       numLogArgs++;
<a name="l03344"></a>03344       useArgs.push(logArgs[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]);
<a name="l03345"></a>03345     }
<a name="l03346"></a>03346 
<a name="l03347"></a>03347     this.dummyProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03348"></a>03348       var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a883d97b566da72dc454ea1438aaccb">rval</a>;
<a name="l03349"></a>03349       <span class="keywordflow">try</span> {
<a name="l03350"></a>03350         rval = arguments[numLogArgs+1].apply(
<a name="l03351"></a>03351           arguments[numLogArgs], Array.prototype.slice.call(arguments,
<a name="l03352"></a>03352                                                             numLogArgs+2));
<a name="l03353"></a>03353       }
<a name="l03354"></a>03354       <span class="keywordflow">catch</span>(ex) {
<a name="l03355"></a>03355         <span class="comment">// (call errors are events)</span>
<a name="l03356"></a>03356         this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = (this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] || 0) + 1;
<a name="l03357"></a>03357         rval = ex;
<a name="l03358"></a>03358       }
<a name="l03359"></a>03359       <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a883d97b566da72dc454ea1438aaccb">rval</a>;
<a name="l03360"></a>03360     };
<a name="l03361"></a>03361 
<a name="l03362"></a>03362     this.logProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03363"></a>03363       var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a883d97b566da72dc454ea1438aaccb">rval</a>, iArg;
<a name="l03364"></a>03364       var entry = [<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l03365"></a>03365       <span class="keywordflow">for</span> (iArg = 0; iArg &lt; numLogArgs; iArg++) {
<a name="l03366"></a>03366         entry.push(arguments[iArg]);
<a name="l03367"></a>03367       }
<a name="l03368"></a>03368       entry.push($microtime.now());
<a name="l03369"></a>03369       entry.push(gSeq++);
<a name="l03370"></a>03370       <span class="comment">// push this prior to the call for ordering reasons (the call can log</span>
<a name="l03371"></a>03371       <span class="comment">//  entries too!)</span>
<a name="l03372"></a>03372       this._entries.push(entry);
<a name="l03373"></a>03373       <span class="keywordflow">try</span> {
<a name="l03374"></a>03374         rval = arguments[numLogArgs+1].apply(
<a name="l03375"></a>03375           arguments[numLogArgs], Array.prototype.slice.call(arguments, iArg+2));
<a name="l03376"></a>03376         entry.push($microtime.now());
<a name="l03377"></a>03377         entry.push(gSeq++);
<a name="l03378"></a>03378         entry.push(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03379"></a>03379       }
<a name="l03380"></a>03380       <span class="keywordflow">catch</span>(ex) {
<a name="l03381"></a>03381         entry.push($microtime.now());
<a name="l03382"></a>03382         entry.push(gSeq++);
<a name="l03383"></a>03383         <span class="comment">// We can&#39;t push the exception directly because its &quot;arguments&quot; payload</span>
<a name="l03384"></a>03384         <span class="comment">//  can have rich object references that will cause issues during JSON</span>
<a name="l03385"></a>03385         <span class="comment">//  serialization.  We most care that it can create circular references,</span>
<a name="l03386"></a>03386         <span class="comment">//  but also are not crazy about serializing potentially huge object</span>
<a name="l03387"></a>03387         <span class="comment">//  graphs.  This might be a great place to perform some logHelper</span>
<a name="l03388"></a>03388         <span class="comment">//  style transformations.</span>
<a name="l03389"></a>03389         entry.push($extransform.transformException(ex));
<a name="l03390"></a>03390         <span class="comment">// (call errors are events)</span>
<a name="l03391"></a>03391         this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = (this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] || 0) + 1;
<a name="l03392"></a>03392         rval = ex;
<a name="l03393"></a>03393       }
<a name="l03394"></a>03394 
<a name="l03395"></a>03395       <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a883d97b566da72dc454ea1438aaccb">rval</a>;
<a name="l03396"></a>03396     };
<a name="l03397"></a>03397 
<a name="l03398"></a>03398     <span class="keywordflow">if</span> (!testOnlyLogArgs) {
<a name="l03399"></a>03399       this._wrapLogProtoForTest(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03400"></a>03400     }
<a name="l03401"></a>03401     <span class="keywordflow">else</span> {
<a name="l03402"></a>03402       <span class="keywordflow">for</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in testOnlyLogArgs) {
<a name="l03403"></a>03403         numTestOnlyArgs++;
<a name="l03404"></a>03404         useTestArgs.push(testOnlyLogArgs[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]);
<a name="l03405"></a>03405       }
<a name="l03406"></a>03406       <span class="comment">// cut-paste-modify of the above...</span>
<a name="l03407"></a>03407       this.testLogProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03408"></a>03408         var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a883d97b566da72dc454ea1438aaccb">rval</a>, iArg;
<a name="l03409"></a>03409         var entry = [<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l03410"></a>03410         <span class="keywordflow">for</span> (iArg = 0; iArg &lt; numLogArgs; iArg++) {
<a name="l03411"></a>03411           entry.push(arguments[iArg]);
<a name="l03412"></a>03412         }
<a name="l03413"></a>03413         entry.push($microtime.now());
<a name="l03414"></a>03414         entry.push(gSeq++);
<a name="l03415"></a>03415         <span class="comment">// push this prior to the call for ordering reasons (the call can log</span>
<a name="l03416"></a>03416         <span class="comment">//  entries too!)</span>
<a name="l03417"></a>03417         this._entries.push(entry);
<a name="l03418"></a>03418         <span class="keywordflow">try</span> {
<a name="l03419"></a>03419           rval = arguments[numLogArgs+1].apply(
<a name="l03420"></a>03420             arguments[numLogArgs], Array.prototype.slice.call(arguments, iArg+2));
<a name="l03421"></a>03421           entry.push($microtime.now());
<a name="l03422"></a>03422           entry.push(gSeq++);
<a name="l03423"></a>03423           entry.push(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03424"></a>03424           <span class="comment">// ++ new bit</span>
<a name="l03425"></a>03425           iArg += 2;
<a name="l03426"></a>03426           <span class="keywordflow">for</span> (var iEat=0; iEat &lt; numTestOnlyArgs; iEat++, iArg++) {
<a name="l03427"></a>03427             entry.push(simplifyInsaneObjects(arguments[iArg], useTestArgs[iEat]));
<a name="l03428"></a>03428           }
<a name="l03429"></a>03429           <span class="comment">// -- end new bit</span>
<a name="l03430"></a>03430         }
<a name="l03431"></a>03431         <span class="keywordflow">catch</span>(ex) {
<a name="l03432"></a>03432           entry.push($microtime.now());
<a name="l03433"></a>03433           entry.push(gSeq++);
<a name="l03434"></a>03434           <span class="comment">// We can&#39;t push the exception directly because its &quot;arguments&quot; payload</span>
<a name="l03435"></a>03435           <span class="comment">//  can have rich object references that will cause issues during JSON</span>
<a name="l03436"></a>03436           <span class="comment">//  serialization.  We most care that it can create circular references,</span>
<a name="l03437"></a>03437           <span class="comment">//  but also are not crazy about serializing potentially huge object</span>
<a name="l03438"></a>03438           <span class="comment">//  graphs.  This might be a great place to perform some logHelper</span>
<a name="l03439"></a>03439           <span class="comment">//  style transformations.</span>
<a name="l03440"></a>03440           entry.push($extransform.transformException(ex));
<a name="l03441"></a>03441           <span class="comment">// ++ new bit</span>
<a name="l03442"></a>03442           iArg += 2;
<a name="l03443"></a>03443           <span class="keywordflow">for</span> (var iEat=0; iEat &lt; numTestOnlyArgs; iEat++, iArg++) {
<a name="l03444"></a>03444             entry.push(simplifyInsaneObjects(arguments[iArg], useTestArgs[iEat]));
<a name="l03445"></a>03445           }
<a name="l03446"></a>03446           <span class="comment">// -- end new bit</span>
<a name="l03447"></a>03447           <span class="comment">// (call errors are events)</span>
<a name="l03448"></a>03448           this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = (this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] || 0) + 1;
<a name="l03449"></a>03449           rval = ex;
<a name="l03450"></a>03450         }
<a name="l03451"></a>03451 
<a name="l03452"></a>03452         <span class="comment">// ++ firing bit...</span>
<a name="l03453"></a>03453         var testActor = this._actor;
<a name="l03454"></a>03454         <span class="keywordflow">if</span> (testActor)
<a name="l03455"></a>03455           testActor.__loggerFired();
<a name="l03456"></a>03456         <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a883d97b566da72dc454ea1438aaccb">rval</a>;
<a name="l03457"></a>03457       };
<a name="l03458"></a>03458     }
<a name="l03459"></a>03459 
<a name="l03460"></a>03460     <span class="comment">// XXX we have no way to indicate we expect/desire an assertion</span>
<a name="l03461"></a>03461     <span class="comment">//  (we will just explode on any logged exception)</span>
<a name="l03462"></a>03462     this.testActorProto[<span class="stringliteral">&#39;expect_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03463"></a>03463       <span class="keywordflow">if</span> (!this._activeForTestStep)
<a name="l03464"></a>03464         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to set expectations on an actor (&quot;</span> +
<a name="l03465"></a>03465                         this.__defName + <span class="stringliteral">&quot;: &quot;</span> + this.__name + <span class="stringliteral">&quot;) that is not &quot;</span> +
<a name="l03466"></a>03466                         <span class="stringliteral">&quot;participating in this test step!&quot;</span>);
<a name="l03467"></a>03467       <span class="keywordflow">if</span> (this._resolved)
<a name="l03468"></a>03468         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to add expectations when already resolved!&quot;</span>);
<a name="l03469"></a>03469 
<a name="l03470"></a>03470       var exp = [<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l03471"></a>03471       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; arguments.length; iArg++) {
<a name="l03472"></a>03472         <span class="keywordflow">if</span> (useArgs[iArg])
<a name="l03473"></a>03473           exp.push(arguments[iArg]);
<a name="l03474"></a>03474       }
<a name="l03475"></a>03475       this._expectations.push(exp);
<a name="l03476"></a>03476       <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l03477"></a>03477     };
<a name="l03478"></a>03478     this.testActorProto[<span class="stringliteral">&#39;ignore_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = makeIgnoreFunc(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03479"></a>03479     this.testActorProto[<span class="stringliteral">&#39;_verify_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>(tupe, entry) {
<a name="l03480"></a>03480       <span class="comment">// report failure if an exception was returned!</span>
<a name="l03481"></a>03481       <span class="keywordflow">if</span> (entry.length &gt; numLogArgs + numTestOnlyArgs + 6) {
<a name="l03482"></a>03482         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03483"></a>03483       }
<a name="l03484"></a>03484       <span class="comment">// only check arguments we had expectations for.</span>
<a name="l03485"></a>03485       <span class="keywordflow">for</span> (var iArg = 1; iArg &lt; tupe.length; iArg++) {
<a name="l03486"></a>03486         <span class="keywordflow">if</span> (!smartCompareEquiv(tupe[iArg], entry[iArg], COMPARE_DEPTH))
<a name="l03487"></a>03487           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03488"></a>03488       }
<a name="l03489"></a>03489       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03490"></a>03490     };
<a name="l03491"></a>03491   },
<a name="l03492"></a>03492   addError: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l03493"></a>03493     this._define(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <span class="stringliteral">&#39;error&#39;</span>);
<a name="l03494"></a>03494 
<a name="l03495"></a>03495     var numArgs = 0, useArgs = [];
<a name="l03496"></a>03496     <span class="keywordflow">for</span> (var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in args) {
<a name="l03497"></a>03497       numArgs++;
<a name="l03498"></a>03498       useArgs.push(args[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>]);
<a name="l03499"></a>03499     }
<a name="l03500"></a>03500 
<a name="l03501"></a>03501     this.dummyProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03502"></a>03502       this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = (this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] || 0) + 1;
<a name="l03503"></a>03503     };
<a name="l03504"></a>03504 
<a name="l03505"></a>03505     this.logProto[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03506"></a>03506       this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = (this._eventMap[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] || 0) + 1;
<a name="l03507"></a>03507       var entry = [<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l03508"></a>03508       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; numArgs; iArg++) {
<a name="l03509"></a>03509         <span class="keywordflow">if</span> (useArgs[iArg] === EXCEPTION) {
<a name="l03510"></a>03510           var arg = arguments[iArg];
<a name="l03511"></a>03511           entry.push($extransform.transformException(arg));
<a name="l03512"></a>03512         }
<a name="l03513"></a>03513         <span class="keywordflow">else</span> {
<a name="l03514"></a>03514           entry.push(arguments[iArg]);
<a name="l03515"></a>03515         }
<a name="l03516"></a>03516       }
<a name="l03517"></a>03517       entry.push($microtime.now());
<a name="l03518"></a>03518       entry.push(gSeq++);
<a name="l03519"></a>03519       this._entries.push(entry);
<a name="l03520"></a>03520     };
<a name="l03521"></a>03521 
<a name="l03522"></a>03522     this._wrapLogProtoForTest(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03523"></a>03523 
<a name="l03524"></a>03524     this.testActorProto[<span class="stringliteral">&#39;expect_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>() {
<a name="l03525"></a>03525       <span class="keywordflow">if</span> (!this._activeForTestStep)
<a name="l03526"></a>03526         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to set expectations on an actor (&quot;</span> +
<a name="l03527"></a>03527                         this.__defName + <span class="stringliteral">&quot;: &quot;</span> + this.__name + <span class="stringliteral">&quot;) that is not &quot;</span> +
<a name="l03528"></a>03528                         <span class="stringliteral">&quot;participating in this test step!&quot;</span>);
<a name="l03529"></a>03529       <span class="keywordflow">if</span> (this._resolved)
<a name="l03530"></a>03530         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Attempt to add expectations when already resolved!&quot;</span>);
<a name="l03531"></a>03531 
<a name="l03532"></a>03532       var exp = [<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l03533"></a>03533       <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; arguments.length; iArg++) {
<a name="l03534"></a>03534         <span class="keywordflow">if</span> (useArgs[iArg] &amp;&amp; useArgs[iArg] !== EXCEPTION)
<a name="l03535"></a>03535           exp.push(arguments[iArg]);
<a name="l03536"></a>03536       }
<a name="l03537"></a>03537       this._expectations.push(exp);
<a name="l03538"></a>03538       <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l03539"></a>03539     };
<a name="l03540"></a>03540     this.testActorProto[<span class="stringliteral">&#39;ignore_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = makeIgnoreFunc(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l03541"></a>03541     this.testActorProto[<span class="stringliteral">&#39;_verify_&#39;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span>(tupe, entry) {
<a name="l03542"></a>03542       <span class="comment">// only check arguments we had expectations for.</span>
<a name="l03543"></a>03543       <span class="keywordflow">for</span> (var iArg = 1; iArg &lt; tupe.length; iArg++) {
<a name="l03544"></a>03544         <span class="keywordflow">if</span> (!smartCompareEquiv(tupe[iArg], entry[iArg], COMPARE_DEPTH))
<a name="l03545"></a>03545           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03546"></a>03546       }
<a name="l03547"></a>03547       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03548"></a>03548     };
<a name="l03549"></a>03549   },
<a name="l03562"></a>03562   useSemanticIdent: <span class="keyword">function</span>(<a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l03563"></a>03563   },
<a name="l03564"></a>03564 
<a name="l03565"></a>03565   makeFabs: <span class="keyword">function</span>() {
<a name="l03566"></a>03566     var moduleFab = this.moduleFab;
<a name="l03567"></a>03567 
<a name="l03568"></a>03568     var dummyCon = <span class="keyword">function</span> dummyConstructor() {
<a name="l03569"></a>03569       this._eventMap = {};
<a name="l03570"></a>03570     };
<a name="l03571"></a>03571     dummyCon.prototype = this.dummyProto;
<a name="l03572"></a>03572 
<a name="l03573"></a>03573     var loggerCon = <span class="keyword">function</span> loggerConstructor(ident) {
<a name="l03574"></a>03574       this.__updateIdent(ident);
<a name="l03575"></a>03575       this._uniqueName = gUniqueActorName++;
<a name="l03576"></a>03576       this._eventMap = {};
<a name="l03577"></a>03577       this._entries = [];
<a name="l03578"></a>03578       this._born = $microtime.now();
<a name="l03579"></a>03579       this._died = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03580"></a>03580       this._kids = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03581"></a>03581     };
<a name="l03582"></a>03582     loggerCon.prototype = this.logProto;
<a name="l03583"></a>03583 
<a name="l03584"></a>03584     var testerCon = <span class="keyword">function</span> testerLoggerConstructor(ident) {
<a name="l03585"></a>03585       loggerCon.call(<span class="keyword">this</span>, ident);
<a name="l03586"></a>03586       this._actor = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03587"></a>03587     };
<a name="l03588"></a>03588     testerCon.prototype = this.testLogProto;
<a name="l03589"></a>03589 
<a name="l03590"></a>03590     var testActorCon = <span class="keyword">function</span> testActorConstructor(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, _parentUniqueName) {
<a name="l03591"></a>03591       this.__name = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l03592"></a>03592       this._uniqueName = gUniqueActorName++;
<a name="l03593"></a>03593       this._parentUniqueName = _parentUniqueName;
<a name="l03594"></a>03594       <span class="comment">// initially undefined, goes null when we register for pairing, goes to</span>
<a name="l03595"></a>03595       <span class="comment">//  the logger instance when paired.</span>
<a name="l03596"></a>03596       this._logger = undefined;
<a name="l03597"></a>03597       this._ignore = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03598"></a>03598       this._expectations = [];
<a name="l03599"></a>03599       this._expectationsMetSoFar = <span class="keyword">true</span>;
<a name="l03600"></a>03600       this._expectNothing = <span class="keyword">false</span>;
<a name="l03601"></a>03601       this._expectDeath = <span class="keyword">false</span>;
<a name="l03602"></a>03602       this._unorderedSetMode = <span class="keyword">false</span>;
<a name="l03603"></a>03603       this._activeForTestStep = <span class="keyword">false</span>;
<a name="l03604"></a>03604       this._iEntry = this._iExpectation = 0;
<a name="l03605"></a>03605       this._lifecycleListener = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03606"></a>03606     };
<a name="l03607"></a>03607     testActorCon.prototype = this.testActorProto;
<a name="l03608"></a>03608     this.moduleFab._actorCons[this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = testActorCon;
<a name="l03609"></a>03609 
<a name="l03614"></a>03614     var loggerDecisionFab = <span class="keyword">function</span> loggerDecisionFab(implInstance,
<a name="l03615"></a>03615                                                        parentLogger, ident) {
<a name="l03616"></a>03616       var logger, tester;
<a name="l03617"></a>03617       <span class="comment">// - Testing</span>
<a name="l03618"></a>03618       <span class="keywordflow">if</span> ((tester = (moduleFab._underTest || loggerDecisionFab._underTest))) {
<a name="l03619"></a>03619 <span class="comment">//console.error(&quot;MODULE IS UNDER TEST FOR: &quot; + testerCon.prototype.__defName);</span>
<a name="l03620"></a>03620         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(parentLogger) === <span class="stringliteral">&quot;string&quot;</span>)
<a name="l03621"></a>03621           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;A string can&#39;t be a logger =&gt; not a valid parent&quot;</span>);
<a name="l03622"></a>03622         logger = <span class="keyword">new</span> testerCon(ident);
<a name="l03623"></a>03623         logger.__instance = implInstance;
<a name="l03624"></a>03624         parentLogger = tester.reportNewLogger(logger, parentLogger);
<a name="l03625"></a>03625       }
<a name="l03626"></a>03626       <span class="comment">// - Logging</span>
<a name="l03627"></a>03627       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (moduleFab._generalLog || testerCon._generalLog) {
<a name="l03628"></a>03628 <span class="comment">//console.error(&quot;general logger for: &quot; + testerCon.prototype.__defName);</span>
<a name="l03629"></a>03629         logger = <span class="keyword">new</span> loggerCon(ident);
<a name="l03630"></a>03630       }
<a name="l03631"></a>03631       <span class="comment">// - Statistics Only</span>
<a name="l03632"></a>03632       <span class="keywordflow">else</span> {
<a name="l03633"></a>03633 <span class="comment">//console.error(&quot;statistics only for: &quot; + testerCon.prototype.__defName);</span>
<a name="l03634"></a>03634         <span class="keywordflow">return</span> <span class="keyword">new</span> dummyCon();
<a name="l03635"></a>03635       }
<a name="l03636"></a>03636 
<a name="l03637"></a>03637       <span class="keywordflow">if</span> (parentLogger) {
<a name="l03638"></a>03638         <span class="keywordflow">if</span> (parentLogger._kids === undefined) {
<a name="l03639"></a>03639         }
<a name="l03640"></a>03640         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (parentLogger._kids === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l03641"></a>03641           parentLogger._kids = [logger];
<a name="l03642"></a>03642         }
<a name="l03643"></a>03643         <span class="keywordflow">else</span> {
<a name="l03644"></a>03644           parentLogger._kids.push(logger);
<a name="l03645"></a>03645         }
<a name="l03646"></a>03646       }
<a name="l03647"></a>03647       <span class="keywordflow">return</span> logger;
<a name="l03648"></a>03648     };
<a name="l03649"></a>03649     this.moduleFab[this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = loggerDecisionFab;
<a name="l03650"></a>03650   },
<a name="l03651"></a>03651 };
<a name="l03652"></a>03652 
<a name="l03653"></a>03653 var LEGAL_FABDEF_KEYS = [
<a name="l03654"></a>03654   <span class="stringliteral">&#39;implClass&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;subtype&#39;</span>, <span class="stringliteral">&#39;topBilling&#39;</span>, <span class="stringliteral">&#39;semanticIdent&#39;</span>, <span class="stringliteral">&#39;dicing&#39;</span>,
<a name="l03655"></a>03655   <span class="stringliteral">&#39;stateVars&#39;</span>, <span class="stringliteral">&#39;latchState&#39;</span>, <span class="stringliteral">&#39;events&#39;</span>, <span class="stringliteral">&#39;asyncJobs&#39;</span>, <span class="stringliteral">&#39;calls&#39;</span>, <span class="stringliteral">&#39;errors&#39;</span>,
<a name="l03656"></a>03656   <span class="stringliteral">&#39;TEST_ONLY_calls&#39;</span>, <span class="stringliteral">&#39;TEST_ONLY_events&#39;</span>, <span class="stringliteral">&#39;TEST_ONLY_asyncJobs&#39;</span>,
<a name="l03657"></a>03657   <span class="stringliteral">&#39;LAYER_MAPPING&#39;</span>,
<a name="l03658"></a>03658 ];
<a name="l03659"></a>03659 
<a name="l03660"></a>03660 <span class="keyword">function</span> augmentFab(mod, fab, defs) {
<a name="l03661"></a>03661   var testActors = fab._testActors, rawDefs = fab._rawDefs;
<a name="l03662"></a>03662 
<a name="l03663"></a>03663   <span class="keywordflow">for</span> (var defName in defs) {
<a name="l03664"></a>03664     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, loggerDef = defs[defName], testOnlyMeta;
<a name="l03665"></a>03665     rawDefs[defName] = loggerDef;
<a name="l03666"></a>03666 
<a name="l03667"></a>03667     <span class="keywordflow">for</span> (key in loggerDef) {
<a name="l03668"></a>03668       <span class="keywordflow">if</span> (LEGAL_FABDEF_KEYS.indexOf(key) === -1) {
<a name="l03669"></a>03669         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;key &#39;&quot;</span> + key + <span class="stringliteral">&quot;&#39; is not a legal log def key&quot;</span>);
<a name="l03670"></a>03670       }
<a name="l03671"></a>03671     }
<a name="l03672"></a>03672 
<a name="l03673"></a>03673     var maker = <span class="keyword">new</span> LoggestClassMaker(fab, defName);
<a name="l03674"></a>03674 
<a name="l03675"></a>03675     <span class="keywordflow">if</span> (<span class="stringliteral">&quot;semanticIdent&quot;</span> in loggerDef) {
<a name="l03676"></a>03676       maker.useSemanticIdent(loggerDef.semanticIdent);
<a name="l03677"></a>03677     }
<a name="l03678"></a>03678     <span class="keywordflow">if</span> (<span class="stringliteral">&quot;stateVars&quot;</span> in loggerDef) {
<a name="l03679"></a>03679       <span class="keywordflow">for</span> (key in loggerDef.stateVars) {
<a name="l03680"></a>03680         maker.addStateVar(key);
<a name="l03681"></a>03681       }
<a name="l03682"></a>03682     }
<a name="l03683"></a>03683     <span class="keywordflow">if</span> (<span class="stringliteral">&quot;latchState&quot;</span> in loggerDef) {
<a name="l03684"></a>03684       <span class="keywordflow">for</span> (key in loggerDef.latchState) {
<a name="l03685"></a>03685         maker.addLatchedState(key);
<a name="l03686"></a>03686       }
<a name="l03687"></a>03687     }
<a name="l03688"></a>03688     <span class="keywordflow">if</span> (<span class="stringliteral">&quot;events&quot;</span> in loggerDef) {
<a name="l03689"></a>03689       var testOnlyEventsDef = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03690"></a>03690       <span class="keywordflow">if</span> (<span class="stringliteral">&quot;TEST_ONLY_events&quot;</span> in loggerDef)
<a name="l03691"></a>03691         testOnlyEventsDef = loggerDef.TEST_ONLY_events;
<a name="l03692"></a>03692       <span class="keywordflow">for</span> (key in loggerDef.events) {
<a name="l03693"></a>03693         testOnlyMeta = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03694"></a>03694         <span class="keywordflow">if</span> (testOnlyEventsDef &amp;&amp; testOnlyEventsDef.hasOwnProperty(key))
<a name="l03695"></a>03695           testOnlyMeta = testOnlyEventsDef[key];
<a name="l03696"></a>03696         maker.addEvent(key, loggerDef.events[key], testOnlyMeta);
<a name="l03697"></a>03697       }
<a name="l03698"></a>03698     }
<a name="l03699"></a>03699     <span class="keywordflow">if</span> (<span class="stringliteral">&quot;asyncJobs&quot;</span> in loggerDef) {
<a name="l03700"></a>03700       var testOnlyAsyncJobsDef = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03701"></a>03701       <span class="keywordflow">if</span> (<span class="stringliteral">&quot;TEST_ONLY_asyncJobs&quot;</span> in loggerDef)
<a name="l03702"></a>03702         testOnlyAsyncJobsDef = loggerDef.TEST_ONLY_asyncJobs;
<a name="l03703"></a>03703       <span class="keywordflow">for</span> (key in loggerDef.asyncJobs) {
<a name="l03704"></a>03704         testOnlyMeta = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03705"></a>03705         <span class="keywordflow">if</span> (testOnlyAsyncJobsDef &amp;&amp; testOnlyAsyncJobsDef.hasOwnProperty(key))
<a name="l03706"></a>03706           testOnlyMeta = testOnlyAsyncJobsDef[key];
<a name="l03707"></a>03707         maker.addAsyncJob(key, loggerDef.asyncJobs[key], testOnlyMeta);
<a name="l03708"></a>03708       }
<a name="l03709"></a>03709     }
<a name="l03710"></a>03710     <span class="keywordflow">if</span> (<span class="stringliteral">&quot;calls&quot;</span> in loggerDef) {
<a name="l03711"></a>03711       var testOnlyCallsDef = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03712"></a>03712       <span class="keywordflow">if</span> (<span class="stringliteral">&quot;TEST_ONLY_calls&quot;</span> in loggerDef)
<a name="l03713"></a>03713         testOnlyCallsDef = loggerDef.TEST_ONLY_calls;
<a name="l03714"></a>03714       <span class="keywordflow">for</span> (key in loggerDef.calls) {
<a name="l03715"></a>03715         testOnlyMeta = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03716"></a>03716         <span class="keywordflow">if</span> (testOnlyCallsDef &amp;&amp; testOnlyCallsDef.hasOwnProperty(key))
<a name="l03717"></a>03717           testOnlyMeta = testOnlyCallsDef[key];
<a name="l03718"></a>03718         maker.addCall(key, loggerDef.calls[key], testOnlyMeta);
<a name="l03719"></a>03719       }
<a name="l03720"></a>03720     }
<a name="l03721"></a>03721     <span class="keywordflow">if</span> (<span class="stringliteral">&quot;errors&quot;</span> in loggerDef) {
<a name="l03722"></a>03722       <span class="keywordflow">for</span> (key in loggerDef.errors) {
<a name="l03723"></a>03723         maker.addError(key, loggerDef.errors[key]);
<a name="l03724"></a>03724       }
<a name="l03725"></a>03725     }
<a name="l03726"></a>03726 
<a name="l03727"></a>03727     maker.makeFabs();
<a name="l03728"></a>03728   }
<a name="l03729"></a>03729 
<a name="l03730"></a>03730   <span class="keywordflow">return</span> fab;
<a name="l03731"></a>03731 };
<a name="l03732"></a>03732 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.__augmentFab = augmentFab;
<a name="l03733"></a>03733 
<a name="l03734"></a>03734 var ALL_KNOWN_FABS = [];
<a name="l03735"></a>03735 
<a name="l03741"></a>03741 var GENERAL_LOG_DEFAULT = <span class="keyword">false</span>;
<a name="l03742"></a>03742 var UNDER_TEST_DEFAULT = <span class="keyword">false</span>;
<a name="l03743"></a>03743 
<a name="l03744"></a>03744 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.register = <span class="keyword">function</span> <span class="keyword">register</span>(mod, defs) {
<a name="l03745"></a>03745   var fab = {
<a name="l03746"></a>03746     _generalLog: GENERAL_LOG_DEFAULT,
<a name="l03747"></a>03747     _underTest: UNDER_TEST_DEFAULT,
<a name="l03748"></a>03748     _actorCons: {},
<a name="l03749"></a>03749     _rawDefs: {},
<a name="l03750"></a>03750     _onDeath: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>
<a name="l03751"></a>03751   };
<a name="l03752"></a>03752   ALL_KNOWN_FABS.push(fab);
<a name="l03753"></a>03753   <span class="keywordflow">return</span> augmentFab(mod, fab, defs);
<a name="l03754"></a>03754 };
<a name="l03755"></a>03755 
<a name="l03759"></a>03759 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.provideSchemaForAllKnownFabs = <span class="keyword">function</span> schemaForAllKnownFabs() {
<a name="l03760"></a>03760   var schema = {};
<a name="l03761"></a>03761   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; ALL_KNOWN_FABS.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03762"></a>03762     var rawDefs = ALL_KNOWN_FABS[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]._rawDefs;
<a name="l03763"></a>03763     <span class="keywordflow">for</span> (var key in rawDefs) {
<a name="l03764"></a>03764       schema[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = rawDefs[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l03765"></a>03765     }
<a name="l03766"></a>03766   }
<a name="l03767"></a>03767   <span class="keywordflow">return</span> schema;
<a name="l03768"></a>03768 };
<a name="l03769"></a>03769 
<a name="l03770"></a>03770 var BogusTester = {
<a name="l03771"></a>03771   reportNewLogger: <span class="keyword">function</span>(logger, parentLogger) {
<a name="l03772"></a>03772     <span class="comment">// No one cares, this is just a way to get the tester constructors</span>
<a name="l03773"></a>03773     <span class="comment">//  triggered.</span>
<a name="l03774"></a>03774     <span class="keywordflow">return</span> parentLogger;
<a name="l03775"></a>03775   },
<a name="l03776"></a>03776 };
<a name="l03777"></a>03777 
<a name="l03781"></a>03781 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.enableGeneralLogging = <span class="keyword">function</span>() {
<a name="l03782"></a>03782   GENERAL_LOG_DEFAULT = <span class="keyword">true</span>;
<a name="l03783"></a>03783   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; ALL_KNOWN_FABS.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03784"></a>03784     var logfab = ALL_KNOWN_FABS[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03785"></a>03785     logfab._generalLog = <span class="keyword">true</span>;
<a name="l03786"></a>03786   }
<a name="l03787"></a>03787 };
<a name="l03788"></a>03788 
<a name="l03798"></a>03798 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DEBUG_markAllFabsUnderTest = <span class="keyword">function</span>() {
<a name="l03799"></a>03799   UNDER_TEST_DEFAULT = BogusTester;
<a name="l03800"></a>03800   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; ALL_KNOWN_FABS.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03801"></a>03801     var logfab = ALL_KNOWN_FABS[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03802"></a>03802 
<a name="l03803"></a>03803     logfab._underTest = BogusTester;
<a name="l03804"></a>03804   }
<a name="l03805"></a>03805 };
<a name="l03806"></a>03806 
<a name="l03812"></a>03812 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DEBUG_dumpEntriesOnDeath = <span class="keyword">function</span>(logfab) {
<a name="l03813"></a>03813   logfab._generalLog = <span class="keyword">true</span>;
<a name="l03814"></a>03814   logfab._onDeath = <span class="keyword">function</span>(logger) {
<a name="l03815"></a>03815     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;!! DIED:&quot;</span>, logger.__defName, logger._ident);
<a name="l03816"></a>03816     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(JSON.stringify(logger._entries, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, 2));
<a name="l03817"></a>03817   };
<a name="l03818"></a>03818 };
<a name="l03819"></a>03819 
<a name="l03820"></a>03820 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DEBUG_dumpAllFabEntriesOnDeath = <span class="keyword">function</span>() {
<a name="l03821"></a>03821   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; ALL_KNOWN_FABS.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03822"></a>03822     var logfab = ALL_KNOWN_FABS[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03823"></a>03823     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DEBUG_dumpEntriesOnDeath(logfab);
<a name="l03824"></a>03824   }
<a name="l03825"></a>03825 };
<a name="l03826"></a>03826 
<a name="l03827"></a>03827 <span class="comment">// role information</span>
<a name="l03828"></a>03828 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.CONNECTION = <span class="stringliteral">&#39;connection&#39;</span>;
<a name="l03829"></a>03829 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SERVER = <span class="stringliteral">&#39;server&#39;</span>;
<a name="l03830"></a>03830 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.CLIENT = <span class="stringliteral">&#39;client&#39;</span>;
<a name="l03831"></a>03831 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TASK = <span class="stringliteral">&#39;task&#39;</span>;
<a name="l03832"></a>03832 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DAEMON = <span class="stringliteral">&#39;daemon&#39;</span>;
<a name="l03833"></a>03833 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DATABASE = <span class="stringliteral">&#39;database&#39;</span>;
<a name="l03834"></a>03834 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.CRYPTO = <span class="stringliteral">&#39;crypto&#39;</span>;
<a name="l03835"></a>03835 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.QUERY = <span class="stringliteral">&#39;query&#39;</span>;
<a name="l03836"></a>03836 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ACCOUNT = <span class="stringliteral">&#39;account&#39;</span>;
<a name="l03837"></a>03837 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGGING = <span class="stringliteral">&#39;log&#39;</span>;
<a name="l03838"></a>03838 
<a name="l03839"></a>03839 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_DRIVER = <span class="stringliteral">&#39;testdriver&#39;</span>;
<a name="l03840"></a>03840 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_GROUP = <span class="stringliteral">&#39;testgroup&#39;</span>;
<a name="l03841"></a>03841 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_CASE = <span class="stringliteral">&#39;testcase&#39;</span>;
<a name="l03842"></a>03842 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_PERMUTATION = <span class="stringliteral">&#39;testperm&#39;</span>;
<a name="l03843"></a>03843 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_STEP = <span class="stringliteral">&#39;teststep&#39;</span>;
<a name="l03844"></a>03844 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_LAZY = <span class="stringliteral">&#39;testlazy&#39;</span>;
<a name="l03845"></a>03845 
<a name="l03846"></a>03846 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_SYNTHETIC_ACTOR = <span class="stringliteral">&#39;test:synthactor&#39;</span>;
<a name="l03847"></a>03847 
<a name="l03848"></a>03848 <span class="comment">// argument information</span>
<a name="l03849"></a>03849 var EXCEPTION = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.EXCEPTION = <span class="stringliteral">&#39;exception&#39;</span>;
<a name="l03856"></a>03856 var JSONABLE = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.JSONABLE = <span class="stringliteral">&#39;jsonable&#39;</span>;
<a name="l03857"></a>03857 var TOSTRING = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TOSTRING = <span class="stringliteral">&#39;tostring&#39;</span>;
<a name="l03872"></a>03872 var RAWOBJ_DATABIAS = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.RAWOBJ_DATABIAS = <span class="stringliteral">&#39;jsonable&#39;</span>; <span class="comment">//&#39;rawobj:databias&#39;;</span>
<a name="l03873"></a>03873 
<a name="l03875"></a>03875 <span class="comment">// State/Delta Representation Support</span>
<a name="l03876"></a>03876 <span class="comment">//</span>
<a name="l03877"></a>03877 <span class="comment">// Specialized schema support to allow, by convention, the log viewer to</span>
<a name="l03878"></a>03878 <span class="comment">//  visualize simple containment hierarchies and display annotations on those</span>
<a name="l03879"></a>03879 <span class="comment">//  hierarchies.  Each entry in the hierarchy requires a unique name.</span>
<a name="l03880"></a>03880 <span class="comment">//</span>
<a name="l03881"></a>03881 <span class="comment">// The reconstruction mechanism works like so:</span>
<a name="l03882"></a>03882 <span class="comment">// - For each logger, we latch any STATEREP we observe as the current state.</span>
<a name="l03883"></a>03883 <span class="comment">// - Statereps are visualized as a simple hierarchy.</span>
<a name="l03884"></a>03884 <span class="comment">// - Annotations (STATEANNO) affect display by colorizing/exposing a string on</span>
<a name="l03885"></a>03885 <span class="comment">//    the object indexed by name.  For now, we use numbers to convey</span>
<a name="l03886"></a>03886 <span class="comment">//    semantic colorization desires: -1 is deletion/red, 0 is notable/yellow,</span>
<a name="l03887"></a>03887 <span class="comment">//    1 is addition/green.</span>
<a name="l03888"></a>03888 <span class="comment">// - Deltas combine an annotation entry relevant to the prior state, the new</span>
<a name="l03889"></a>03889 <span class="comment">//    state, and annotations relevant to the new state.  For example,</span>
<a name="l03890"></a>03890 <span class="comment">//    expressing a deletion and an addition would have us annotate the</span>
<a name="l03891"></a>03891 <span class="comment">//    deleted item in the pre-state and the added item in the post-state.</span>
<a name="l03892"></a>03892 
<a name="l03896"></a>03896 var STATEREP = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.STATEREP = <span class="stringliteral">&#39;staterep&#39;</span>;
<a name="l03897"></a>03897 var STATEANNO = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.STATEANNO = <span class="stringliteral">&#39;stateanno&#39;</span>;
<a name="l03898"></a>03898 var STATEDELTA = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.STATEDELTA = <span class="stringliteral">&#39;statedelta&#39;</span>;
<a name="l03899"></a>03899 
<a name="l03901"></a>03901 
<a name="l03902"></a>03902 }); <span class="comment">// end define</span>
<a name="l03903"></a>03903 ;
<a name="l03908"></a>03908 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/util&#39;</span>,
<a name="l03909"></a>03909   [
<a name="l03910"></a>03910     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l03911"></a>03911   ],
<a name="l03912"></a>03912   <span class="keyword">function</span>(
<a name="l03913"></a>03913     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l03914"></a>03914   ) {
<a name="l03915"></a>03915 
<a name="l03922"></a>03922 var cmpHeaderYoungToOld = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.cmpHeaderYoungToOld =
<a name="l03923"></a>03923     <span class="keyword">function</span> cmpHeaderYoungToOld(a, b) {
<a name="l03924"></a>03924   var delta = b.date - a.date;
<a name="l03925"></a>03925   <span class="keywordflow">if</span> (delta)
<a name="l03926"></a>03926     <span class="keywordflow">return</span> delta;
<a name="l03927"></a>03927   <span class="comment">// favor larger UIDs because they are newer-ish.</span>
<a name="l03928"></a>03928   <span class="keywordflow">return</span> b.id - a.id;
<a name="l03929"></a>03929 }
<a name="l03930"></a>03930 
<a name="l03941"></a>03941 var bsearchForInsert = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.bsearchForInsert =
<a name="l03942"></a>03942     <span class="keyword">function</span> bsearchForInsert(<a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, seekVal, cmpfunc) {
<a name="l03943"></a>03943   <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length)
<a name="l03944"></a>03944     <span class="keywordflow">return</span> 0;
<a name="l03945"></a>03945   var low  = 0, <a class="code" href="../../d1/d70/prinit_8h.html#a884316428268cbd4f587015b1f436b53">high</a> = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length - 1,
<a name="l03946"></a>03946       mid, cmpval;
<a name="l03947"></a>03947   <span class="keywordflow">while</span> (low &lt;= <a class="code" href="../../d1/d70/prinit_8h.html#a884316428268cbd4f587015b1f436b53">high</a>) {
<a name="l03948"></a>03948     mid = low + Math.floor((<a class="code" href="../../d1/d70/prinit_8h.html#a884316428268cbd4f587015b1f436b53">high</a> - low) / 2);
<a name="l03949"></a>03949     cmpval = cmpfunc(seekVal, <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[mid]);
<a name="l03950"></a>03950     <span class="keywordflow">if</span> (cmpval &lt; 0)
<a name="l03951"></a>03951       <a class="code" href="../../d1/d70/prinit_8h.html#a884316428268cbd4f587015b1f436b53">high</a> = mid - 1;
<a name="l03952"></a>03952     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmpval &gt; 0)
<a name="l03953"></a>03953       low = mid + 1;
<a name="l03954"></a>03954     <span class="keywordflow">else</span>
<a name="l03955"></a>03955       <span class="keywordflow">break</span>;
<a name="l03956"></a>03956   }
<a name="l03957"></a>03957   <span class="keywordflow">if</span> (cmpval &lt; 0)
<a name="l03958"></a>03958     <span class="keywordflow">return</span> mid; <span class="comment">// insertion is displacing, so use mid outright.</span>
<a name="l03959"></a>03959   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmpval &gt; 0)
<a name="l03960"></a>03960     <span class="keywordflow">return</span> mid + 1;
<a name="l03961"></a>03961   <span class="keywordflow">else</span>
<a name="l03962"></a>03962     <span class="keywordflow">return</span> mid;
<a name="l03963"></a>03963 };
<a name="l03964"></a>03964 
<a name="l03965"></a>03965 var bsearchMaybeExists = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.bsearchMaybeExists =
<a name="l03966"></a>03966     <span class="keyword">function</span> bsearchMaybeExists(<a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, seekVal, cmpfunc, aLow, aHigh) {
<a name="l03967"></a>03967   var low  = ((aLow === undefined)  ? 0                 : aLow),
<a name="l03968"></a>03968       <a class="code" href="../../d1/d70/prinit_8h.html#a884316428268cbd4f587015b1f436b53">high</a> = ((aHigh === undefined) ? (<a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length - 1) : aHigh),
<a name="l03969"></a>03969       mid, cmpval;
<a name="l03970"></a>03970   <span class="keywordflow">while</span> (low &lt;= <a class="code" href="../../d1/d70/prinit_8h.html#a884316428268cbd4f587015b1f436b53">high</a>) {
<a name="l03971"></a>03971     mid = low + Math.floor((<a class="code" href="../../d1/d70/prinit_8h.html#a884316428268cbd4f587015b1f436b53">high</a> - low) / 2);
<a name="l03972"></a>03972     cmpval = cmpfunc(seekVal, <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[mid]);
<a name="l03973"></a>03973     <span class="keywordflow">if</span> (cmpval &lt; 0)
<a name="l03974"></a>03974       <a class="code" href="../../d1/d70/prinit_8h.html#a884316428268cbd4f587015b1f436b53">high</a> = mid - 1;
<a name="l03975"></a>03975     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmpval &gt; 0)
<a name="l03976"></a>03976       low = mid + 1;
<a name="l03977"></a>03977     <span class="keywordflow">else</span>
<a name="l03978"></a>03978       <span class="keywordflow">return</span> mid;
<a name="l03979"></a>03979   }
<a name="l03980"></a>03980   <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03981"></a>03981 };
<a name="l03982"></a>03982 
<a name="l03995"></a>03995 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.partitionMessagesByFolderId =
<a name="l03996"></a>03996     <span class="keyword">function</span> partitionMessagesByFolderId(messageNamers) {
<a name="l03997"></a>03997   var <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a> = [], foldersToMsgs = {};
<a name="l03998"></a>03998   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; messageNamers.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l03999"></a>03999     var messageNamer = messageNamers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l04000"></a>04000         messageSuid = messageNamer.suid,
<a name="l04001"></a>04001         idxLastSlash = messageSuid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>),
<a name="l04002"></a>04002         folderId = messageSuid.substring(0, idxLastSlash);
<a name="l04003"></a>04003 
<a name="l04004"></a>04004     <span class="keywordflow">if</span> (!foldersToMsgs.hasOwnProperty(folderId)) {
<a name="l04005"></a>04005       var messages = [messageNamer];
<a name="l04006"></a>04006       results.push({
<a name="l04007"></a>04007         folderId: folderId,
<a name="l04008"></a>04008         messages: messages,
<a name="l04009"></a>04009       });
<a name="l04010"></a>04010       foldersToMsgs[folderId] = messages;
<a name="l04011"></a>04011     }
<a name="l04012"></a>04012     <span class="keywordflow">else</span> {
<a name="l04013"></a>04013       foldersToMsgs[folderId].push(messageNamer);
<a name="l04014"></a>04014     }
<a name="l04015"></a>04015   }
<a name="l04016"></a>04016   <span class="keywordflow">return</span> <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>;
<a name="l04017"></a>04017 };
<a name="l04018"></a>04018 
<a name="l04019"></a>04019 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.formatAddresses = <span class="keyword">function</span>(nameAddrPairs) {
<a name="l04020"></a>04020   var addrstrings = [];
<a name="l04021"></a>04021   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; nameAddrPairs.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l04022"></a>04022     var pair = nameAddrPairs[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l04023"></a>04023     <span class="comment">// support lazy people providing only an e-mail... or very careful</span>
<a name="l04024"></a>04024     <span class="comment">// people who are sure they formatted things correctly.</span>
<a name="l04025"></a>04025     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(pair) === <span class="stringliteral">&#39;string&#39;</span>) {
<a name="l04026"></a>04026       addrstrings.push(pair);
<a name="l04027"></a>04027     }
<a name="l04028"></a>04028     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pair.name) {
<a name="l04029"></a>04029       addrstrings.push(pair.address);
<a name="l04030"></a>04030     }
<a name="l04031"></a>04031     <span class="keywordflow">else</span> {
<a name="l04032"></a>04032       addrstrings.push(
<a name="l04033"></a>04033         <span class="charliteral">&#39;&quot;&#39;</span> + pair.name.replace(/[<span class="stringliteral">&quot;&#39;]/g, &#39;&#39;) + &#39;&quot;</span> &lt;<span class="stringliteral">&#39; +</span>
<a name="l04034"></a>04034 <span class="stringliteral">          pair.address + &#39;</span>&gt;<span class="stringliteral">&#39;);</span>
<a name="l04035"></a>04035 <span class="stringliteral">    }</span>
<a name="l04036"></a>04036 <span class="stringliteral">  }</span>
<a name="l04037"></a>04037 <span class="stringliteral"></span>
<a name="l04038"></a>04038 <span class="stringliteral">  return addrstrings.join(&#39;</span>, <span class="stringliteral">&#39;);</span>
<a name="l04039"></a>04039 <span class="stringliteral">};</span>
<a name="l04040"></a>04040 <span class="stringliteral"></span>
<a name="l04041"></a>04041 <span class="stringliteral">}); // end define</span>
<a name="l04042"></a>04042 <span class="stringliteral">;</span>
<a name="l04043"></a>04043 <span class="stringliteral">// asuth.</span>
<a name="l04044"></a>04044 <span class="stringliteral"></span>
<a name="l04053"></a>04053 <span class="stringliteral">define(&#39;</span>mailapi/a64<span class="stringliteral">&#39;,</span>
<a name="l04054"></a>04054 <span class="stringliteral">  [</span>
<a name="l04055"></a>04055 <span class="stringliteral">    &#39;</span><a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a><span class="stringliteral">&#39;</span>
<a name="l04056"></a>04056 <span class="stringliteral">  ],</span>
<a name="l04057"></a>04057 <span class="stringliteral">  function(</span>
<a name="l04058"></a>04058 <span class="stringliteral">    exports</span>
<a name="l04059"></a>04059 <span class="stringliteral">  ) {</span>
<a name="l04060"></a>04060 <span class="stringliteral"></span>
<a name="l04067"></a>04067 <span class="stringliteral">var ORDERED_ARBITRARY_BASE64_CHARS = [</span>
<a name="l04068"></a>04068 <span class="stringliteral">  &#39;</span>0<span class="stringliteral">&#39;, &#39;</span>1<span class="stringliteral">&#39;, &#39;</span>2<span class="stringliteral">&#39;, &#39;</span>3<span class="stringliteral">&#39;, &#39;</span>4<span class="stringliteral">&#39;, &#39;</span>5<span class="stringliteral">&#39;, &#39;</span>6<span class="stringliteral">&#39;, &#39;</span>7<span class="stringliteral">&#39;, &#39;</span>8<span class="stringliteral">&#39;, &#39;</span>9<span class="stringliteral">&#39;,</span>
<a name="l04069"></a>04069 <span class="stringliteral">  &#39;</span>A<span class="stringliteral">&#39;, &#39;</span>B<span class="stringliteral">&#39;, &#39;</span>C<span class="stringliteral">&#39;, &#39;</span>D<span class="stringliteral">&#39;, &#39;</span>E<span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../d9/d19/import__vcard__test_8js.html#a1fd406685cbdee605d0a7bebed56fdb0">F</a><span class="stringliteral">&#39;, &#39;</span>G<span class="stringliteral">&#39;, &#39;</span>H<span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../da/d7d/sylvester_8js.html#a36e4d4a7eda7b7caf30c74df2451ef99">I</a><span class="stringliteral">&#39;, &#39;</span>J<span class="stringliteral">&#39;,</span>
<a name="l04070"></a>04070 <span class="stringliteral">  &#39;</span>K<span class="stringliteral">&#39;, &#39;</span>L<span class="stringliteral">&#39;, &#39;</span>M<span class="stringliteral">&#39;, &#39;</span>N<span class="stringliteral">&#39;, &#39;</span>O<span class="stringliteral">&#39;, &#39;</span>P<span class="stringliteral">&#39;, &#39;</span>Q<span class="stringliteral">&#39;, &#39;</span>R<span class="stringliteral">&#39;, &#39;</span>S<span class="stringliteral">&#39;, &#39;</span>T<span class="stringliteral">&#39;,</span>
<a name="l04071"></a>04071 <span class="stringliteral">  &#39;</span>U<span class="stringliteral">&#39;, &#39;</span>V<span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../d9/d19/import__vcard__test_8js.html#a0a9b52fb6605edc74fd7d5359f34477e">W</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../da/d7d/sylvester_8js.html#af2f144226eef01a80d1ad95fc2c088d8">X</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../da/d7d/sylvester_8js.html#a8507648d1aca10fdde851a3cf2872587">Y</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../da/d7d/sylvester_8js.html#a8ec2f1f4b56b59046ed793f621ded341">Z</a><span class="stringliteral">&#39;, &#39;</span>a<span class="stringliteral">&#39;, &#39;</span>b<span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../d2/d7d/jsapi_8h.html#a348d5281ca0f01adebb262bee8baf788">c</a><span class="stringliteral">&#39;, &#39;</span>d<span class="stringliteral">&#39;,</span>
<a name="l04072"></a>04072 <span class="stringliteral">  &#39;</span><a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../d3/d4b/lockscreen_8js.html#a9cf09a2972472098a4c689fd988f4dfc">f</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a><span class="stringliteral">&#39;, &#39;</span>h<span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a><span class="stringliteral">&#39;, &#39;</span>m<span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a><span class="stringliteral">&#39;,</span>
<a name="l04073"></a>04073 <span class="stringliteral">  &#39;</span><a class="code" href="../../d8/dbd/namespaceheader.html#a1f19773439587cecdc1d5ef61c705086">o</a><span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../db/de5/namespacedefault__timezones.html#a28422cbbc99cee3f1b68cd64c3ded285">p</a><span class="stringliteral">&#39;, &#39;</span>q<span class="stringliteral">&#39;, &#39;</span>r<span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a><span class="stringliteral">&#39;, &#39;</span>t<span class="stringliteral">&#39;, &#39;</span>u<span class="stringliteral">&#39;, &#39;</span><a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a5d38b5ed0e5a6c44c34f95302820c4d7">v</a><span class="stringliteral">&#39;, &#39;</span>w<span class="stringliteral">&#39;, &#39;</span>x<span class="stringliteral">&#39;,</span>
<a name="l04074"></a>04074 <span class="stringliteral">  &#39;</span>y<span class="stringliteral">&#39;, &#39;</span>z<span class="stringliteral">&#39;, &#39;</span>{<span class="stringliteral">&#39;, &#39;</span>}<span class="stringliteral">&#39;</span>
<a name="l04075"></a>04075 <span class="stringliteral">];</span>
<a name="l04080"></a>04080 <span class="stringliteral">var ZERO_PADDING = &#39;</span>0000000000000000<span class="stringliteral">&#39;;</span>
<a name="l04081"></a>04081 <span class="stringliteral"></span>
<a name="l04085"></a>04085 <span class="stringliteral">function encodeInt(v, padTo) {</span>
<a name="l04086"></a>04086 <span class="stringliteral">  var sbits = [];</span>
<a name="l04087"></a>04087 <span class="stringliteral">  do {</span>
<a name="l04088"></a>04088 <span class="stringliteral">    // note: bitwise ops are 32-bit only.</span>
<a name="l04089"></a>04089 <span class="stringliteral">    // so, this is fine:</span>
<a name="l04090"></a>04090 <span class="stringliteral">    sbits.push(ORDERED_ARBITRARY_BASE64_CHARS[v &amp; 0x3f]);</span>
<a name="l04091"></a>04091 <span class="stringliteral">    // but this can&#39;</span>t be &gt;&gt;&gt; 6 and has <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> be a divide.
<a name="l04092"></a>04092     <a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a5d38b5ed0e5a6c44c34f95302820c4d7">v</a> = Math.floor(<a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a5d38b5ed0e5a6c44c34f95302820c4d7">v</a> / 64);
<a name="l04093"></a>04093   } <span class="keywordflow">while</span> (<a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a5d38b5ed0e5a6c44c34f95302820c4d7">v</a> &gt; 0);
<a name="l04094"></a>04094   sbits.reverse();
<a name="l04095"></a>04095   var estr = sbits.join(<span class="stringliteral">&#39;&#39;</span>);
<a name="l04096"></a>04096   <span class="keywordflow">if</span> (padTo &amp;&amp; estr.length &lt; padTo)
<a name="l04097"></a>04097     <span class="keywordflow">return</span> ZERO_PADDING.substring(0, padTo - estr.length) + estr;
<a name="l04098"></a>04098   <span class="keywordflow">return</span> estr;
<a name="l04099"></a>04099 }
<a name="l04100"></a>04100 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.encodeInt = encodeInt;
<a name="l04101"></a>04101 
<a name="l04106"></a>04106 var E10_14_RSH_14 = Math.pow(10, 14) / Math.pow(2, 14),
<a name="l04107"></a>04107       P2_14 = Math.pow(2, 14),
<a name="l04108"></a>04108       P2_22 = Math.pow(2, 22),
<a name="l04109"></a>04109       P2_32 = Math.pow(2, 32),
<a name="l04110"></a>04110       P2_36 = Math.pow(2, 36),
<a name="l04111"></a>04111       MASK32 = 0xffffffff;
<a name="l04112"></a>04112 
<a name="l04129"></a>04129 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.parseUI64 = <span class="keyword">function</span> <a class="code" href="../../db/de5/namespacedefault__timezones.html#a28422cbbc99cee3f1b68cd64c3ded285">p</a>(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, padTo) {
<a name="l04130"></a>04130   <span class="comment">// 2^53 is 16 digits long, so any string shorter than that can be handled</span>
<a name="l04131"></a>04131   <span class="comment">// by the built-in logic.</span>
<a name="l04132"></a>04132   <span class="keywordflow">if</span> (<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>.length &lt; 16) {
<a name="l04133"></a>04133     <span class="keywordflow">return</span> encodeInt(parseInt(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, 10));
<a name="l04134"></a>04134   }
<a name="l04135"></a>04135 
<a name="l04136"></a>04136   var lowParse = parseInt(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>.substring(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>.length - 14), 10),
<a name="l04137"></a>04137       highParse = parseInt(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>.substring(0, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>.length - 14), 10),
<a name="l04138"></a>04138       <span class="comment">// multiply the high parse by our scaled power of 10</span>
<a name="l04139"></a>04139       rawHighBits = highParse * E10_14_RSH_14;
<a name="l04140"></a>04140 
<a name="l04141"></a>04141   <span class="comment">// Now lowParse&#39;s low 14 bits are valid, but everything above that needs to</span>
<a name="l04142"></a>04142   <span class="comment">// be mixed (by addition) with rawHighBits.  We&#39;ll mix in 22 bits from</span>
<a name="l04143"></a>04143   <span class="comment">// rawHighBits to get lowBits to 36 useful bits.  The main thing is to lop off</span>
<a name="l04144"></a>04144   <span class="comment">// the higher bits in rawHighBits that we don&#39;t want so they don&#39;t go float.</span>
<a name="l04145"></a>04145   <span class="comment">// We do want the 37rd bit if there was addition overflow to carry to the</span>
<a name="l04146"></a>04146   <span class="comment">// upper calculation.</span>
<a name="l04147"></a>04147   var lowBitsAdded = (((rawHighBits % P2_36) * P2_14) % P2_36 +
<a name="l04148"></a>04148                       lowParse % P2_36),
<a name="l04149"></a>04149       lowBits = lowBitsAdded % P2_36,
<a name="l04150"></a>04150       overflow = Math.floor(lowBitsAdded / P2_36) % 2;
<a name="l04151"></a>04151 
<a name="l04152"></a>04152   <span class="comment">// We can lop off the low 22-bits of the high bits (since lowBits is taking</span>
<a name="l04153"></a>04153   <span class="comment">// care of that) and combine that with the bits of low above 36.</span>
<a name="l04154"></a>04154   var highBits = Math.floor(rawHighBits / P2_22) +
<a name="l04155"></a>04155                  Math.floor(lowParse / P2_36) + overflow;
<a name="l04156"></a>04156 
<a name="l04157"></a>04157   var outStr = encodeInt(highBits) + encodeInt(lowBits, 6);
<a name="l04158"></a>04158   <span class="keywordflow">if</span> (padTo &amp;&amp; outStr.length &lt; padTo)
<a name="l04159"></a>04159     <span class="keywordflow">return</span> ZERO_PADDING.substring(0, padTo - outStr.length) + outStr;
<a name="l04160"></a>04160   <span class="keywordflow">return</span> outStr;
<a name="l04161"></a>04161 };
<a name="l04162"></a>04162 
<a name="l04163"></a>04163 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.cmpUI64 = <span class="keyword">function</span>(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) {
<a name="l04164"></a>04164   <span class="comment">// longer equals bigger!</span>
<a name="l04165"></a>04165   var <a class="code" href="../../d2/d7d/jsapi_8h.html#a348d5281ca0f01adebb262bee8baf788">c</a> = a.length - b.length;
<a name="l04166"></a>04166   <span class="keywordflow">if</span> (c !== 0)
<a name="l04167"></a>04167     <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a348d5281ca0f01adebb262bee8baf788">c</a>;
<a name="l04168"></a>04168 
<a name="l04169"></a>04169   <span class="keywordflow">if</span> (a &lt; b)
<a name="l04170"></a>04170     <span class="keywordflow">return</span> -1;
<a name="l04171"></a>04171   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a &gt; b)
<a name="l04172"></a>04172     <span class="keywordflow">return</span> 1;
<a name="l04173"></a>04173   <span class="keywordflow">return</span> 0;
<a name="l04174"></a>04174 };
<a name="l04175"></a>04175 
<a name="l04179"></a>04179 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.decodeUI64 = <span class="keyword">function</span> d(es) {
<a name="l04180"></a>04180   var iNonZero = 0;
<a name="l04181"></a>04181   <span class="keywordflow">for</span> (;es.charCodeAt(iNonZero) === 48; iNonZero++) {
<a name="l04182"></a>04182   }
<a name="l04183"></a>04183   <span class="keywordflow">if</span> (iNonZero)
<a name="l04184"></a>04184     es = es.substring(iNonZero);
<a name="l04185"></a>04185 
<a name="l04186"></a>04186   var <a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a5d38b5ed0e5a6c44c34f95302820c4d7">v</a>, <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l04187"></a>04187   <span class="comment">// 8 characters is 48 bits, JS can do that internally.</span>
<a name="l04188"></a>04188   <span class="keywordflow">if</span> (es.length &lt;= 8) {
<a name="l04189"></a>04189     v = 0;
<a name="l04190"></a>04190     <span class="keywordflow">for</span> (i = 0; i &lt; es.length; i++) {
<a name="l04191"></a>04191       v = v * 64 + ORDERED_ARBITRARY_BASE64_CHARS.indexOf(es[i]);
<a name="l04192"></a>04192     }
<a name="l04193"></a>04193     <span class="keywordflow">return</span> v.toString(10);
<a name="l04194"></a>04194   }
<a name="l04195"></a>04195 
<a name="l04196"></a>04196   <span class="comment">// upper-string gets 28 bits (that could hold 30), lower-string gets 36 bits.</span>
<a name="l04197"></a>04197   <span class="comment">// This is how we did things in encoding is why.</span>
<a name="l04198"></a>04198   var ues = es.substring(0, es.length - 6), uv = 0,
<a name="l04199"></a>04199       les = es.substring(es.length - 6), lv = 0;
<a name="l04200"></a>04200 
<a name="l04201"></a>04201   <span class="keywordflow">for</span> (i = 0; i &lt; ues.length; i++) {
<a name="l04202"></a>04202     uv = uv * 64 + ORDERED_ARBITRARY_BASE64_CHARS.indexOf(ues[i]);
<a name="l04203"></a>04203   }
<a name="l04204"></a>04204   <span class="keywordflow">for</span> (i = 0; i &lt; les.length; i++) {
<a name="l04205"></a>04205     lv = lv * 64 + ORDERED_ARBITRARY_BASE64_CHARS.indexOf(les[i]);
<a name="l04206"></a>04206   }
<a name="l04207"></a>04207 
<a name="l04208"></a>04208   <span class="comment">// Do the division to figure out the &quot;high&quot; string from our encoding (a whole</span>
<a name="l04209"></a>04209   <span class="comment">// number.)  Then subtract that whole number off our effective number, leaving</span>
<a name="l04210"></a>04210   <span class="comment">// us dealing with &lt;53 bits so we can just hand it off to the JS engine.</span>
<a name="l04211"></a>04211 
<a name="l04212"></a>04212   var rsh14val = (uv * P2_22 + Math.floor(lv / P2_14)),
<a name="l04213"></a>04213       uraw = rsh14val / E10_14_RSH_14,
<a name="l04214"></a>04214       udv = Math.floor(uraw),
<a name="l04215"></a>04215       uds = udv.toString();
<a name="l04216"></a>04216 
<a name="l04217"></a>04217   var rsh14Leftover = rsh14val - udv * E10_14_RSH_14,
<a name="l04218"></a>04218       lowBitsRemoved = rsh14Leftover * P2_14 + lv % P2_14;
<a name="l04219"></a>04219 
<a name="l04220"></a>04220   var lds = lowBitsRemoved.toString();
<a name="l04221"></a>04221   <span class="keywordflow">if</span> (lds.length &lt; 14)
<a name="l04222"></a>04222     lds = ZERO_PADDING.substring(0, 14 - lds.length) + lds;
<a name="l04223"></a>04223 
<a name="l04224"></a>04224   <span class="keywordflow">return</span> uds + lds;
<a name="l04225"></a>04225 };
<a name="l04226"></a>04226 <span class="comment">//d(p(&#39;10000000000000000&#39;));</span>
<a name="l04227"></a>04227 <span class="comment">//d(p(&#39;18014398509481984&#39;));</span>
<a name="l04228"></a>04228 <span class="comment">//d(p(&#39;1171221845949812801&#39;));</span>
<a name="l04229"></a>04229 
<a name="l04230"></a>04230 }); <span class="comment">// end define</span>
<a name="l04231"></a>04231 ;
<a name="l04237"></a>04237 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/allback&#39;</span>,
<a name="l04238"></a>04238   [
<a name="l04239"></a>04239     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l04240"></a>04240   ],
<a name="l04241"></a>04241   <span class="keyword">function</span>(
<a name="l04242"></a>04242     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l04243"></a>04243   ) {
<a name="l04244"></a>04244 
<a name="l04265"></a>04265 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.allbackMaker = <span class="keyword">function</span> allbackMaker(<a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#ae76808cc87130a0f45031b8fdc26ea2b">names</a>, allDoneCallback) {
<a name="l04266"></a>04266   var aggrData = {}, <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a> = {}, waitingFor = <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#ae76808cc87130a0f45031b8fdc26ea2b">names</a>.concat();
<a name="l04267"></a>04267 
<a name="l04268"></a>04268   <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#ae76808cc87130a0f45031b8fdc26ea2b">names</a>.forEach(<span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>) {
<a name="l04269"></a>04269     <span class="comment">// (build a consistent shape for aggrData regardless of callback ordering)</span>
<a name="l04270"></a>04270     aggrData[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = undefined;
<a name="l04271"></a>04271     <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a>[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <span class="keyword">function</span> anAllback(callbackResult) {
<a name="l04272"></a>04272       var i = waitingFor.indexOf(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l04273"></a>04273       <span class="keywordflow">if</span> (i === -1) {
<a name="l04274"></a>04274         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&quot;Callback &#39;&quot;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> + <span class="stringliteral">&quot;&#39; fired multiple times!&quot;</span>);
<a name="l04275"></a>04275         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Callback &#39;&quot;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> + <span class="stringliteral">&quot;&#39; fired multiple times!&quot;</span>);
<a name="l04276"></a>04276       }
<a name="l04277"></a>04277       waitingFor.splice(i, 1);
<a name="l04278"></a>04278       <span class="keywordflow">if</span> (arguments.length &gt; 1)
<a name="l04279"></a>04279         aggrData[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = arguments;
<a name="l04280"></a>04280       <span class="keywordflow">else</span>
<a name="l04281"></a>04281         aggrData[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = callbackResult;
<a name="l04282"></a>04282       <span class="keywordflow">if</span> (waitingFor.length === 0 &amp;&amp; allDoneCallback)
<a name="l04283"></a>04283         allDoneCallback(aggrData);
<a name="l04284"></a>04284     };
<a name="l04285"></a>04285   });
<a name="l04286"></a>04286 
<a name="l04287"></a>04287   <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a>;
<a name="l04288"></a>04288 };
<a name="l04289"></a>04289 
<a name="l04290"></a>04290 }); <span class="comment">// end define</span>
<a name="l04291"></a>04291 ;
<a name="l04292"></a>04292 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/date&#39;</span>,
<a name="l04293"></a>04293   [
<a name="l04294"></a>04294     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l04295"></a>04295     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l04296"></a>04296   ],
<a name="l04297"></a>04297   <span class="keyword">function</span>(
<a name="l04298"></a>04298     $module,
<a name="l04299"></a>04299     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l04300"></a>04300   ) {
<a name="l04301"></a>04301 
<a name="l04303"></a>04303 <span class="comment">// Time</span>
<a name="l04304"></a>04304 <span class="comment">//</span>
<a name="l04305"></a>04305 <span class="comment">// == JS Dates</span>
<a name="l04306"></a>04306 <span class="comment">//</span>
<a name="l04307"></a>04307 <span class="comment">// We primarily deal in UTC timestamps.  When we need to talk dates with IMAP</span>
<a name="l04308"></a>04308 <span class="comment">// (see next section), we need these timestamps to line up with midnight for</span>
<a name="l04309"></a>04309 <span class="comment">// a given day.  We do not need to line up with weeks, months, or years,</span>
<a name="l04310"></a>04310 <span class="comment">// saving us a lot of complexity.</span>
<a name="l04311"></a>04311 <span class="comment">//</span>
<a name="l04312"></a>04312 <span class="comment">// Day algebra is straightforward because JS Date objects have no concept of</span>
<a name="l04313"></a>04313 <span class="comment">// leap seconds.  We don&#39;t need to worry that a leap second will cause adding</span>
<a name="l04314"></a>04314 <span class="comment">// a day to be less than or more than a day.  Hooray!</span>
<a name="l04315"></a>04315 <span class="comment">//</span>
<a name="l04316"></a>04316 <span class="comment">// == IMAP and Time</span>
<a name="l04317"></a>04317 <span class="comment">//</span>
<a name="l04318"></a>04318 <span class="comment">// The stock IMAP SEARCH command&#39;s SINCE and BEFORE predicates only operate on</span>
<a name="l04319"></a>04319 <span class="comment">// whole-dates (and ignore the non-date time parts).  Additionally, SINCE is</span>
<a name="l04320"></a>04320 <span class="comment">// inclusive and BEFORE is exclusive.</span>
<a name="l04321"></a>04321 <span class="comment">//</span>
<a name="l04322"></a>04322 <span class="comment">// We use JS millisecond timestamp values throughout, and it&#39;s important to us</span>
<a name="l04323"></a>04323 <span class="comment">// that our date logic is consistent with IMAP&#39;s time logic where relevant.</span>
<a name="l04324"></a>04324 <span class="comment">// All of our IMAP-exposed time-interval related logic operates on day</span>
<a name="l04325"></a>04325 <span class="comment">// granularities.  Our timestamp/date values are always normalized to midnight</span>
<a name="l04326"></a>04326 <span class="comment">// which happily works out with intuitive range operations.</span>
<a name="l04327"></a>04327 <span class="comment">//</span>
<a name="l04328"></a>04328 <span class="comment">// Observe the pretty ASCII art where as you move to the right you are moving</span>
<a name="l04329"></a>04329 <span class="comment">// forward in time.</span>
<a name="l04330"></a>04330 <span class="comment">//</span>
<a name="l04331"></a>04331 <span class="comment">//             ________________________________________</span>
<a name="l04332"></a>04332 <span class="comment">//      BEFORE)| midnight (0 millis) ... 11:59:59:999 |</span>
<a name="l04333"></a>04333 <span class="comment">// ON_OR_BEFORE]</span>
<a name="l04334"></a>04334 <span class="comment">//             [SINCE......................................</span>
<a name="l04335"></a>04335 <span class="comment">//              (AFTER.....................................</span>
<a name="l04336"></a>04336 <span class="comment">//</span>
<a name="l04337"></a>04337 <span class="comment">// Our date range comparisons (noting that larger timestamps are &#39;younger&#39;) are:</span>
<a name="l04338"></a>04338 <span class="comment">// SINCE analog:  (testDate &gt;= comparisonDate)</span>
<a name="l04339"></a>04339 <span class="comment">//   testDate is as-recent-as or more-recent-than the comparisonDate.</span>
<a name="l04340"></a>04340 <span class="comment">// BEFORE analog: (testDate &lt; comparisonDate)</span>
<a name="l04341"></a>04341 <span class="comment">//   testDate is less-recent-than the comparisonDate</span>
<a name="l04342"></a>04342 <span class="comment">//</span>
<a name="l04343"></a>04343 <span class="comment">// Because &quot;who is the test date and who is the range value under discussion&quot;</span>
<a name="l04344"></a>04344 <span class="comment">// can be unclear and the numerical direction of time is not always intuitive,</span>
<a name="l04345"></a>04345 <span class="comment">// I&#39;m introducing simple BEFORE and SINCE helper functions to try and make</span>
<a name="l04346"></a>04346 <span class="comment">// the comparison logic ridiculously explicit as well as calling out where we</span>
<a name="l04347"></a>04347 <span class="comment">// are being consistent with IMAP.</span>
<a name="l04348"></a>04348 <span class="comment">//</span>
<a name="l04349"></a>04349 <span class="comment">// Not all of our time logic is consistent with IMAP!  Specifically, use of</span>
<a name="l04350"></a>04350 <span class="comment">// exclusive time bounds without secondary comparison keys means that ranges</span>
<a name="l04351"></a>04351 <span class="comment">// defined in this way cannot spread messages with the same timestamp over</span>
<a name="l04352"></a>04352 <span class="comment">// multiple ranges.  This allows for pathological data structure situations</span>
<a name="l04353"></a>04353 <span class="comment">// where there&#39;s too much data in a data block, etc.</span>
<a name="l04354"></a>04354 <span class="comment">// Our date ranges are defined by &#39;startTS&#39; and &#39;endTS&#39;.  Using math syntax, our</span>
<a name="l04355"></a>04355 <span class="comment">// IMAP-consistent time ranges end up as: [startTS, endTS).  It is always true</span>
<a name="l04356"></a>04356 <span class="comment">// that BEFORE(startTS, endTS) and SINCE(endTS, startTS) in these cases.</span>
<a name="l04357"></a>04357 <span class="comment">//</span>
<a name="l04358"></a>04358 <span class="comment">// As such, I&#39;ve also created an ON_OR_BEFORE helper that allows equivalence and</span>
<a name="l04359"></a>04359 <span class="comment">// STRICTLY_AFTER that does not check equivalence to round out all possibilities</span>
<a name="l04360"></a>04360 <span class="comment">// while still being rather explicit.</span>
<a name="l04361"></a>04361 
<a name="l04362"></a>04362 
<a name="l04369"></a>04369 var BEFORE = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BEFORE =
<a name="l04370"></a>04370       <span class="keyword">function</span> BEFORE(testDate, comparisonDate) {
<a name="l04371"></a>04371   <span class="comment">// testDate is numerically less than comparisonDate, so it is chronologically</span>
<a name="l04372"></a>04372   <span class="comment">// before it.</span>
<a name="l04373"></a>04373   <span class="keywordflow">return</span> testDate &lt; comparisonDate;
<a name="l04374"></a>04374 };
<a name="l04375"></a>04375 
<a name="l04376"></a>04376 var ON_OR_BEFORE = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ON_OR_BEFORE =
<a name="l04377"></a>04377       <span class="keyword">function</span> ON_OR_BEFORE(testDate, comparisonDate) {
<a name="l04378"></a>04378   <span class="keywordflow">return</span> testDate &lt;= comparisonDate;
<a name="l04379"></a>04379 };
<a name="l04380"></a>04380 
<a name="l04387"></a>04387 var SINCE = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SINCE =
<a name="l04388"></a>04388       <span class="keyword">function</span> SINCE(testDate, comparisonDate) {
<a name="l04389"></a>04389   <span class="comment">// testDate is numerically greater-than-or-equal-to comparisonDate, so it</span>
<a name="l04390"></a>04390   <span class="comment">// chronologically after/since it.</span>
<a name="l04391"></a>04391   <span class="keywordflow">return</span> testDate &gt;= comparisonDate;
<a name="l04392"></a>04392 };
<a name="l04393"></a>04393 
<a name="l04394"></a>04394 var STRICTLY_AFTER = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.STRICTLY_AFTER =
<a name="l04395"></a>04395       <span class="keyword">function</span> STRICTLY_AFTER(testDate, comparisonDate) {
<a name="l04396"></a>04396   <span class="keywordflow">return</span> testDate &gt; comparisonDate;
<a name="l04397"></a>04397 };
<a name="l04398"></a>04398 
<a name="l04399"></a>04399 var IN_BS_DATE_RANGE = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.IN_BS_DATE_RANGE =
<a name="l04400"></a>04400       <span class="keyword">function</span> IN_BS_DATE_RANGE(testDate, startTS, endTS) {
<a name="l04401"></a>04401   <span class="keywordflow">return</span> testDate &gt;= startTS &amp;&amp; testDate &lt; endTS;
<a name="l04402"></a>04402 };
<a name="l04403"></a>04403 
<a name="l04404"></a>04404 var PASTWARDS = 1, FUTUREWARDS = -1;
<a name="l04412"></a>04412 var TIME_DIR_AT_OR_BEYOND = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TIME_DIR_AT_OR_BEYOND =
<a name="l04413"></a>04413       <span class="keyword">function</span> TIME_DIR_AT_OR_BEYOND(<a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a>, testDate, comparisonDate) {
<a name="l04414"></a>04414   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a> === PASTWARDS)
<a name="l04415"></a>04415     <span class="keywordflow">return</span> testDate &lt;= comparisonDate;
<a name="l04416"></a>04416   <span class="comment">// we use null as a sentinel value for &#39;the future&#39;/&#39;now&#39;</span>
<a name="l04417"></a>04417   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (comparisonDate === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l04418"></a>04418     <span class="keywordflow">return</span> testDate &gt;= NOW();
<a name="l04419"></a>04419   <span class="keywordflow">else</span> <span class="comment">// FUTUREWARDS</span>
<a name="l04420"></a>04420     <span class="keywordflow">return</span> testDate &gt;= comparisonDate;
<a name="l04421"></a>04421 };
<a name="l04427"></a>04427 var TIME_DIR_DELTA = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TIME_DIR_DELTA =
<a name="l04428"></a>04428       <span class="keyword">function</span> TIME_DIR_DELTA(<a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a>, testDate, comparisonDate) {
<a name="l04429"></a>04429   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a> === PASTWARDS)
<a name="l04430"></a>04430     <span class="keywordflow">return</span> testDate - comparisonDate;
<a name="l04431"></a>04431   <span class="keywordflow">else</span> <span class="comment">// FUTUREWARDS</span>
<a name="l04432"></a>04432     <span class="keywordflow">return</span> comparisonDate - testDate;
<a name="l04433"></a>04433 };
<a name="l04438"></a>04438 var TIME_DIR_ADD = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TIME_DIR_ADD =
<a name="l04439"></a>04439       <span class="keyword">function</span> TIME_DIR_ADD(<a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a>, baseDate, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>) {
<a name="l04440"></a>04440   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a> === PASTWARDS)
<a name="l04441"></a>04441     <span class="keywordflow">return</span> baseDate + <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>;
<a name="l04442"></a>04442   <span class="keywordflow">else</span> <span class="comment">// FUTUREWARDS</span>
<a name="l04443"></a>04443     <span class="keywordflow">return</span> baseDate - <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>;
<a name="l04444"></a>04444 };
<a name="l04445"></a>04445 
<a name="l04446"></a>04446 <span class="comment">//function DATE_RANGES_OVERLAP(A_startTS, A_endTS, B_startTS, B_endTS) {</span>
<a name="l04447"></a>04447 <span class="comment">//}</span>
<a name="l04448"></a>04448 
<a name="l04449"></a>04449 var HOUR_MILLIS = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.HOUR_MILLIS = 60 * 60 * 1000;
<a name="l04450"></a>04450 var DAY_MILLIS = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DAY_MILLIS = 24 * 60 * 60 * 1000;
<a name="l04451"></a>04451 
<a name="l04455"></a>04455 var TIME_WARPED_NOW = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04456"></a>04456 
<a name="l04461"></a>04461 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_LetsDoTheTimewarpAgain = <span class="keyword">function</span>(fakeNow) {
<a name="l04462"></a>04462   <span class="keywordflow">if</span> (fakeNow === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l04463"></a>04463     TIME_WARPED_NOW = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04464"></a>04464     <span class="keywordflow">return</span>;
<a name="l04465"></a>04465   }
<a name="l04466"></a>04466   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(fakeNow) !== <span class="stringliteral">&#39;number&#39;</span>)
<a name="l04467"></a>04467     fakeNow = fakeNow.valueOf();
<a name="l04468"></a>04468   TIME_WARPED_NOW = fakeNow;
<a name="l04469"></a>04469 };
<a name="l04470"></a>04470 
<a name="l04471"></a>04471 var NOW = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.NOW =
<a name="l04472"></a>04472       <span class="keyword">function</span> NOW() {
<a name="l04473"></a>04473   <span class="keywordflow">return</span> TIME_WARPED_NOW || Date.now();
<a name="l04474"></a>04474 };
<a name="l04475"></a>04475 
<a name="l04481"></a>04481 var makeDaysAgo = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.makeDaysAgo =
<a name="l04482"></a>04482       <span class="keyword">function</span> makeDaysAgo(numDays, tzOffset) {
<a name="l04483"></a>04483   var past = quantizeDate((TIME_WARPED_NOW || Date.now()) + tzOffset) -
<a name="l04484"></a>04484                numDays * DAY_MILLIS;
<a name="l04485"></a>04485   <span class="keywordflow">return</span> past;
<a name="l04486"></a>04486 };
<a name="l04487"></a>04487 var makeDaysBefore = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.makeDaysBefore =
<a name="l04488"></a>04488       <span class="keyword">function</span> makeDaysBefore(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, numDaysBefore, tzOffset) {
<a name="l04489"></a>04489   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l04490"></a>04490     <span class="keywordflow">return</span> makeDaysAgo(numDaysBefore - 1, tzOffset);
<a name="l04491"></a>04491   <span class="keywordflow">return</span> quantizeDate(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>) - numDaysBefore * DAY_MILLIS;
<a name="l04492"></a>04492 };
<a name="l04496"></a>04496 var quantizeDate = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.quantizeDate =
<a name="l04497"></a>04497       <span class="keyword">function</span> quantizeDate(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>) {
<a name="l04498"></a>04498   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l04499"></a>04499     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04500"></a>04500   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>) === <span class="stringliteral">&#39;number&#39;</span>)
<a name="l04501"></a>04501     <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> = <span class="keyword">new</span> Date(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>);
<a name="l04502"></a>04502   <span class="keywordflow">return</span> <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>.setUTCHours(0, 0, 0, 0).valueOf();
<a name="l04503"></a>04503 };
<a name="l04504"></a>04504 
<a name="l04509"></a>04509 var quantizeDateUp = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.quantizeDateUp =
<a name="l04510"></a>04510       <span class="keyword">function</span> quantizeDateUp(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>) {
<a name="l04511"></a>04511   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>) === <span class="stringliteral">&#39;number&#39;</span>)
<a name="l04512"></a>04512     <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> = <span class="keyword">new</span> Date(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>);
<a name="l04513"></a>04513   var truncated = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>.setUTCHours(0, 0, 0, 0).valueOf();
<a name="l04514"></a>04514   <span class="keywordflow">if</span> (<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>.valueOf()  === truncated)
<a name="l04515"></a>04515     <span class="keywordflow">return</span> truncated;
<a name="l04516"></a>04516   <span class="keywordflow">return</span> truncated + DAY_MILLIS;
<a name="l04517"></a>04517 };
<a name="l04518"></a>04518 
<a name="l04519"></a>04519 
<a name="l04520"></a>04520 }); <span class="comment">// end define</span>
<a name="l04521"></a>04521 ;
<a name="l04522"></a>04522 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/syncbase&#39;</span>,
<a name="l04523"></a>04523   [
<a name="l04524"></a>04524     <span class="stringliteral">&#39;./date&#39;</span>,
<a name="l04525"></a>04525     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l04526"></a>04526   ],
<a name="l04527"></a>04527   <span class="keyword">function</span>(
<a name="l04528"></a>04528     $date,
<a name="l04529"></a>04529     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l04530"></a>04530   ) {
<a name="l04531"></a>04531 
<a name="l04533"></a>04533 <span class="comment">// IMAP time constants</span>
<a name="l04534"></a>04534 
<a name="l04541"></a>04541 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.OPEN_REFRESH_THRESH_MS = 10 * 60 * 1000;
<a name="l04542"></a>04542 
<a name="l04549"></a>04549 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.GROW_REFRESH_THRESH_MS = 60 * 60 * 1000;
<a name="l04550"></a>04550 
<a name="l04552"></a>04552 <span class="comment">// Block Purging Constants (IMAP only)</span>
<a name="l04553"></a>04553 <span class="comment">//</span>
<a name="l04554"></a>04554 <span class="comment">// These values are all intended for resource-constrained mobile devices.  A</span>
<a name="l04555"></a>04555 <span class="comment">// more powerful tablet-class or desktop-class app would probably want to crank</span>
<a name="l04556"></a>04556 <span class="comment">// the values way up.</span>
<a name="l04557"></a>04557 
<a name="l04566"></a>04566 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BLOCK_PURGE_EVERY_N_NEW_BODY_BLOCKS = 4;
<a name="l04567"></a>04567 
<a name="l04575"></a>04575 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BLOCK_PURGE_ONLY_AFTER_UNSYNCED_MS = 14 * $date.DAY_MILLIS;
<a name="l04576"></a>04576 
<a name="l04591"></a>04591 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BLOCK_PURGE_HARD_MAX_BLOCK_LIMIT = 128;
<a name="l04592"></a>04592 
<a name="l04594"></a>04594 <span class="comment">// General Sync Constants</span>
<a name="l04595"></a>04595 
<a name="l04601"></a>04601 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SYNC_FOLDER_LIST_EVERY_MS = $date.DAY_MILLIS;
<a name="l04602"></a>04602 
<a name="l04606"></a>04606 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.INITIAL_FILL_SIZE = 15;
<a name="l04607"></a>04607 
<a name="l04613"></a>04613 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.INITIAL_SYNC_DAYS = 3;
<a name="l04614"></a>04614 
<a name="l04619"></a>04619 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.INITIAL_SYNC_GROWTH_DAYS = 3;
<a name="l04620"></a>04620 
<a name="l04634"></a>04634 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TIME_SCALE_FACTOR_ON_NO_MESSAGES = 2;
<a name="l04635"></a>04635 
<a name="l04646"></a>04646 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.OLDEST_SYNC_DATE = Date.UTC(1990, 0, 1);
<a name="l04647"></a>04647 
<a name="l04663"></a>04663 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SYNC_WHOLE_FOLDER_AT_N_MESSAGES = 40;
<a name="l04664"></a>04664 
<a name="l04675"></a>04675 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BISECT_DATE_AT_N_MESSAGES = 60;
<a name="l04676"></a>04676 
<a name="l04689"></a>04689 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TOO_MANY_MESSAGES = 2000;
<a name="l04690"></a>04690 
<a name="l04691"></a>04691 
<a name="l04693"></a>04693 <span class="comment">// Size Estimate Constants</span>
<a name="l04694"></a>04694 
<a name="l04721"></a>04721 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.HEADER_EST_SIZE_IN_BYTES = 430;
<a name="l04722"></a>04722 
<a name="l04723"></a>04723 
<a name="l04725"></a>04725 <span class="comment">// Error / Retry Constants</span>
<a name="l04726"></a>04726 
<a name="l04739"></a>04739 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MAX_OP_TRY_COUNT = 10;
<a name="l04740"></a>04740 
<a name="l04745"></a>04745 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.OP_UNKNOWN_ERROR_TRY_COUNT_INCREMENT = 5;
<a name="l04746"></a>04746 
<a name="l04751"></a>04751 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DEFERRED_OP_DELAY_MS = 30 * 1000;
<a name="l04752"></a>04752 
<a name="l04754"></a>04754 <span class="comment">// General defaults</span>
<a name="l04755"></a>04755 
<a name="l04760"></a>04760 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.CHECK_INTERVALS_ENUMS_TO_MS = {
<a name="l04761"></a>04761   <span class="stringliteral">&#39;manual&#39;</span>: 0, <span class="comment">// 0 disables; no infinite checking!</span>
<a name="l04762"></a>04762   <span class="stringliteral">&#39;3min&#39;</span>: 3 * 60 * 1000,
<a name="l04763"></a>04763   <span class="stringliteral">&#39;5min&#39;</span>: 5 * 60 * 1000,
<a name="l04764"></a>04764   <span class="stringliteral">&#39;10min&#39;</span>: 10 * 60 * 1000,
<a name="l04765"></a>04765   <span class="stringliteral">&#39;15min&#39;</span>: 15 * 60 * 1000,
<a name="l04766"></a>04766   <span class="stringliteral">&#39;30min&#39;</span>: 30 * 60 * 1000,
<a name="l04767"></a>04767   <span class="stringliteral">&#39;60min&#39;</span>: 60 * 60 * 1000,
<a name="l04768"></a>04768 };
<a name="l04769"></a>04769 
<a name="l04775"></a>04775 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.DEFAULT_CHECK_INTERVAL_ENUM = <span class="stringliteral">&#39;manual&#39;</span>;
<a name="l04776"></a>04776 
<a name="l04777"></a>04777 var DAY_MILLIS = 24 * 60 * 60 * 1000;
<a name="l04778"></a>04778 
<a name="l04784"></a>04784 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SYNC_RANGE_ENUMS_TO_MS = {
<a name="l04785"></a>04785   <span class="comment">// This choice is being made for IMAP.</span>
<a name="l04786"></a>04786   <span class="stringliteral">&#39;auto&#39;</span>: 30 * DAY_MILLIS,
<a name="l04787"></a>04787     <span class="stringliteral">&#39;1d&#39;</span>: 1 * DAY_MILLIS,
<a name="l04788"></a>04788     <span class="stringliteral">&#39;3d&#39;</span>: 3 * DAY_MILLIS,
<a name="l04789"></a>04789     <span class="stringliteral">&#39;1w&#39;</span>: 7 * DAY_MILLIS,
<a name="l04790"></a>04790     <span class="stringliteral">&#39;2w&#39;</span>: 14 * DAY_MILLIS,
<a name="l04791"></a>04791     <span class="stringliteral">&#39;1m&#39;</span>: 30 * DAY_MILLIS,
<a name="l04792"></a>04792    <span class="stringliteral">&#39;all&#39;</span>: 30 * 365 * DAY_MILLIS,
<a name="l04793"></a>04793 };
<a name="l04794"></a>04794 
<a name="l04795"></a>04795 
<a name="l04797"></a>04797 <span class="comment">// Unit test support</span>
<a name="l04798"></a>04798 
<a name="l04808"></a>04808 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TEST_adjustSyncValues = <span class="keyword">function</span> TEST_adjustSyncValues(syncValues) {
<a name="l04809"></a>04809   <span class="keywordflow">if</span> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;fillSize&#39;</span>))
<a name="l04810"></a>04810     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.INITIAL_FILL_SIZE = syncValues.fillSize;
<a name="l04811"></a>04811   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;days&#39;</span>))
<a name="l04812"></a>04812     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.INITIAL_SYNC_DAYS = syncValues.days;
<a name="l04813"></a>04813   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;growDays&#39;</span>))
<a name="l04814"></a>04814     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.INITIAL_SYNC_GROWTH_DAYS = syncValues.growDays;
<a name="l04815"></a>04815 
<a name="l04816"></a>04816   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;SYNC_WHOLE_FOLDER_AT_N_MESSAGES&#39;</span>))
<a name="l04817"></a>04817     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SYNC_WHOLE_FOLDER_AT_N_MESSAGES =
<a name="l04818"></a>04818       syncValues.SYNC_WHOLE_FOLDER_AT_N_MESSAGES;
<a name="l04819"></a>04819   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;bisectThresh&#39;</span>))
<a name="l04820"></a>04820     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BISECT_DATE_AT_N_MESSAGES = syncValues.bisectThresh;
<a name="l04821"></a>04821   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;tooMany&#39;</span>))
<a name="l04822"></a>04822     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TOO_MANY_MESSAGES = syncValues.tooMany;
<a name="l04823"></a>04823 
<a name="l04824"></a>04824   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;scaleFactor&#39;</span>))
<a name="l04825"></a>04825     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.TIME_SCALE_FACTOR_ON_NO_MESSAGES = syncValues.scaleFactor;
<a name="l04826"></a>04826 
<a name="l04827"></a>04827   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;openRefreshThresh&#39;</span>))
<a name="l04828"></a>04828     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.OPEN_REFRESH_THRESH_MS = syncValues.openRefreshThresh;
<a name="l04829"></a>04829   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;growRefreshThresh&#39;</span>))
<a name="l04830"></a>04830     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.GROW_REFRESH_THRESH_MS = syncValues.growRefreshThresh;
<a name="l04831"></a>04831 
<a name="l04832"></a>04832   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;HEADER_EST_SIZE_IN_BYTES&#39;</span>))
<a name="l04833"></a>04833     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.HEADER_EST_SIZE_IN_BYTES =
<a name="l04834"></a>04834       syncValues.HEADER_EST_SIZE_IN_BYTES;
<a name="l04835"></a>04835 
<a name="l04836"></a>04836   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;BLOCK_PURGE_ONLY_AFTER_UNSYNCED_MS&#39;</span>))
<a name="l04837"></a>04837     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BLOCK_PURGE_ONLY_AFTER_UNSYNCED_MS =
<a name="l04838"></a>04838       syncValues.BLOCK_PURGE_ONLY_AFTER_UNSYNCED_MS;
<a name="l04839"></a>04839   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;BLOCK_PURGE_HARD_MAX_BLOCK_LIMIT&#39;</span>))
<a name="l04840"></a>04840     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BLOCK_PURGE_HARD_MAX_BLOCK_LIMIT =
<a name="l04841"></a>04841       syncValues.BLOCK_PURGE_HARD_MAX_BLOCK_LIMIT;
<a name="l04842"></a>04842 
<a name="l04843"></a>04843   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;MAX_OP_TRY_COUNT&#39;</span>))
<a name="l04844"></a>04844     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MAX_OP_TRY_COUNT = syncValues.MAX_OP_TRY_COUNT;
<a name="l04845"></a>04845   <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (syncValues.hasOwnProperty(<span class="stringliteral">&#39;OP_UNKNOWN_ERROR_TRY_COUNT_INCREMENT&#39;</span>))
<a name="l04846"></a>04846     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.OP_UNKNOWN_ERROR_TRY_COUNT_INCREMENT =
<a name="l04847"></a>04847       syncValues.OP_UNKNOWN_ERROR_TRY_COUNT_INCREMENT;
<a name="l04848"></a>04848 };
<a name="l04849"></a>04849 
<a name="l04850"></a>04850 }); <span class="comment">// end define</span>
<a name="l04851"></a>04851 ;
<a name="l04904"></a>04904 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/mailslice&#39;</span>,
<a name="l04905"></a>04905   [
<a name="l04906"></a>04906     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l04907"></a>04907     <span class="stringliteral">&#39;./util&#39;</span>,
<a name="l04908"></a>04908     <span class="stringliteral">&#39;./a64&#39;</span>,
<a name="l04909"></a>04909     <span class="stringliteral">&#39;./allback&#39;</span>,
<a name="l04910"></a>04910     <span class="stringliteral">&#39;./date&#39;</span>,
<a name="l04911"></a>04911     <span class="stringliteral">&#39;./syncbase&#39;</span>,
<a name="l04912"></a>04912     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l04913"></a>04913     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l04914"></a>04914   ],
<a name="l04915"></a>04915   <span class="keyword">function</span>(
<a name="l04916"></a>04916     $log,
<a name="l04917"></a>04917     $util,
<a name="l04918"></a>04918     $a64,
<a name="l04919"></a>04919     $allback,
<a name="l04920"></a>04920     $date,
<a name="l04921"></a>04921     $sync,
<a name="l04922"></a>04922     $module,
<a name="l04923"></a>04923     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l04924"></a>04924   ) {
<a name="l04925"></a>04925 var bsearchForInsert = $util.bsearchForInsert,
<a name="l04926"></a>04926     bsearchMaybeExists = $util.bsearchMaybeExists,
<a name="l04927"></a>04927     cmpHeaderYoungToOld = $util.cmpHeaderYoungToOld,
<a name="l04928"></a>04928     allbackMaker = $allback.allbackMaker,
<a name="l04929"></a>04929     BEFORE = $date.BEFORE,
<a name="l04930"></a>04930     ON_OR_BEFORE = $date.ON_OR_BEFORE,
<a name="l04931"></a>04931     SINCE = $date.SINCE,
<a name="l04932"></a>04932     STRICTLY_AFTER = $date.STRICTLY_AFTER,
<a name="l04933"></a>04933     IN_BS_DATE_RANGE = $date.IN_BS_DATE_RANGE,
<a name="l04934"></a>04934     HOUR_MILLIS = $date.HOUR_MILLIS,
<a name="l04935"></a>04935     DAY_MILLIS = $date.DAY_MILLIS,
<a name="l04936"></a>04936     NOW = $date.NOW,
<a name="l04937"></a>04937     quantizeDate = $date.quantizeDate,
<a name="l04938"></a>04938     quantizeDateUp = $date.quantizeDateUp;
<a name="l04939"></a>04939 
<a name="l04940"></a>04940 var PASTWARDS = 1, FUTUREWARDS = -1;
<a name="l04941"></a>04941 
<a name="l04942"></a>04942 <span class="comment">// What do we think the post-snappy compression overhead of the structured clone</span>
<a name="l04943"></a>04943 <span class="comment">// persistence rep will be for various things?  These are total guesses right</span>
<a name="l04944"></a>04944 <span class="comment">// now.  Keep in mind we do want the pre-compression size of the data in all</span>
<a name="l04945"></a>04945 <span class="comment">// cases and we just hope it will compress a bit.  For the attributes we are</span>
<a name="l04946"></a>04946 <span class="comment">// including the attribute name as well as any fixed-overhead for its payload,</span>
<a name="l04947"></a>04947 <span class="comment">// especially numbers which may or may not be zig-zag encoded/etc.</span>
<a name="l04948"></a>04948 var OBJ_OVERHEAD_EST = 2, STR_ATTR_OVERHEAD_EST = 5,
<a name="l04949"></a>04949     NUM_ATTR_OVERHEAD_EST = 10, LIST_ATTR_OVERHEAD_EST = 4,
<a name="l04950"></a>04950     NULL_ATTR_OVERHEAD_EST = 2, LIST_OVERHEAD_EST = 4,
<a name="l04951"></a>04951     NUM_OVERHEAD_EST = 8, STR_OVERHEAD_EST = 4;
<a name="l04952"></a>04952 
<a name="l04959"></a>04959 var tupleRangeIntersectsTupleRange = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.tupleRangeIntersectsTupleRange =
<a name="l04960"></a>04960     <span class="keyword">function</span> tupleRangeIntersectsTupleRange(a, b) {
<a name="l04961"></a>04961   <span class="keywordflow">if</span> (BEFORE(a.endTS, b.startTS) ||
<a name="l04962"></a>04962       STRICTLY_AFTER(a.startTS, b.endTS))
<a name="l04963"></a>04963     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04964"></a>04964   <span class="keywordflow">if</span> ((a.endTS === b.startTS &amp;&amp; a.endUID &lt; b.startUID) ||
<a name="l04965"></a>04965       (a.startTS === b.endTS &amp;&amp; a.startTS &gt; b.endUID))
<a name="l04966"></a>04966     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04967"></a>04967   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04968"></a>04968 };
<a name="l04969"></a>04969 
<a name="l04970"></a>04970 var EXPECTED_BLOCK_SIZE = 8;
<a name="l04971"></a>04971 
<a name="l04976"></a>04976 var MAX_BLOCK_SIZE = EXPECTED_BLOCK_SIZE * 1024,
<a name="l04980"></a>04980       BLOCK_SPLIT_SMALL_PART = (EXPECTED_BLOCK_SIZE / 3) * 1024,
<a name="l04984"></a>04984       BLOCK_SPLIT_EQUAL_PART = (EXPECTED_BLOCK_SIZE / 2) * 1024,
<a name="l04988"></a>04988       BLOCK_SPLIT_LARGE_PART = (EXPECTED_BLOCK_SIZE / 1.5) * 1024;
<a name="l04989"></a>04989 
<a name="l04996"></a>04996 var SYNC_START_MINIMUM_PROGRESS = 0.02;
<a name="l04997"></a>04997 
<a name="l05026"></a>05026 <span class="keyword">function</span> MailSlice(bridgeHandle, storage, _parentLog) {
<a name="l05027"></a>05027   this._bridgeHandle = bridgeHandle;
<a name="l05028"></a>05028   bridgeHandle.__listener = <span class="keyword">this</span>;
<a name="l05029"></a>05029   this._storage = storage;
<a name="l05030"></a>05030   this._LOG = <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#af6bd479a55b8d304e23d9a96d199c3aa">LOGFAB</a>.MailSlice(<span class="keyword">this</span>, _parentLog, bridgeHandle._handle);
<a name="l05031"></a>05031 
<a name="l05032"></a>05032   <span class="comment">// The time range of the headers we are looking at right now.</span>
<a name="l05033"></a>05033   this.startTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05034"></a>05034   this.startUID = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05035"></a>05035   <span class="comment">// If the end values line up with the most recent message known about for this</span>
<a name="l05036"></a>05036   <span class="comment">// folder, then we will grow to encompass more recent messages.</span>
<a name="l05037"></a>05037   this.endTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05038"></a>05038   this.endUID = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05039"></a>05039 
<a name="l05045"></a>05045   this.waitingOnData = <span class="keyword">false</span>;
<a name="l05046"></a>05046 
<a name="l05051"></a>05051   this._accumulating = <span class="keyword">false</span>;
<a name="l05059"></a>05059   this.ignoreHeaders = <span class="keyword">false</span>;
<a name="l05060"></a>05060 
<a name="l05064"></a>05064   this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a> = [];
<a name="l05065"></a>05065   this.desiredHeaders = $sync.INITIAL_FILL_SIZE;
<a name="l05066"></a>05066 }
<a name="l05067"></a>05067 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MailSlice = MailSlice;
<a name="l05068"></a>05068 MailSlice.prototype = {
<a name="l05069"></a>05069   <span class="keyword">set</span> atTop(val) {
<a name="l05070"></a>05070     <span class="keywordflow">if</span> (this._bridgeHandle)
<a name="l05071"></a>05071       this._bridgeHandle.atTop = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l05072"></a>05072     <span class="keywordflow">return</span> <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l05073"></a>05073   },
<a name="l05074"></a>05074   <span class="keyword">set</span> atBottom(val) {
<a name="l05075"></a>05075     <span class="keywordflow">if</span> (this._bridgeHandle)
<a name="l05076"></a>05076       this._bridgeHandle.atBottom = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l05077"></a>05077     <span class="keywordflow">return</span> <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l05078"></a>05078   },
<a name="l05079"></a>05079   <span class="keyword">set</span> userCanGrowUpwards(val) {
<a name="l05080"></a>05080     <span class="keywordflow">if</span> (this._bridgeHandle)
<a name="l05081"></a>05081       this._bridgeHandle.userCanGrowUpwards = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l05082"></a>05082     <span class="keywordflow">return</span> <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l05083"></a>05083   },
<a name="l05084"></a>05084   <span class="keyword">set</span> userCanGrowDownwards(val) {
<a name="l05085"></a>05085     <span class="keywordflow">if</span> (this._bridgeHandle)
<a name="l05086"></a>05086       this._bridgeHandle.userCanGrowDownwards = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l05087"></a>05087     <span class="keywordflow">return</span> <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l05088"></a>05088   },
<a name="l05089"></a>05089 
<a name="l05090"></a>05090   _updateSliceFlags: <span class="keyword">function</span>() {
<a name="l05091"></a>05091     var flagHolder = this._bridgeHandle;
<a name="l05092"></a>05092     flagHolder.atTop = this._storage.headerIsYoungestKnown(this.endTS,
<a name="l05093"></a>05093                                                            this.endUID);
<a name="l05094"></a>05094     flagHolder.atBottom = this._storage.headerIsOldestKnown(this.startTS,
<a name="l05095"></a>05095                                                             this.startUID);
<a name="l05096"></a>05096     <span class="keywordflow">if</span> (flagHolder.atTop)
<a name="l05097"></a>05097       flagHolder.userCanGrowUpwards = !this._storage.syncedToToday();
<a name="l05098"></a>05098     <span class="keywordflow">else</span>
<a name="l05099"></a>05099       flagHolder.userCanGrowUpwards = <span class="keyword">false</span>;
<a name="l05100"></a>05100 
<a name="l05101"></a>05101     <span class="keywordflow">if</span> (flagHolder.atBottom)
<a name="l05102"></a>05102       flagHolder.userCanGrowDownwards = !this._storage.syncedToDawnOfTime();
<a name="l05103"></a>05103     <span class="keywordflow">else</span>
<a name="l05104"></a>05104       flagHolder.userCanGrowDownwards = <span class="keyword">false</span>;
<a name="l05105"></a>05105   },
<a name="l05106"></a>05106 
<a name="l05110"></a>05110   <a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a>: <span class="keyword">function</span>() {
<a name="l05111"></a>05111     <span class="keywordflow">if</span> (!this._bridgeHandle)
<a name="l05112"></a>05112       <span class="keywordflow">return</span>;
<a name="l05113"></a>05113 
<a name="l05114"></a>05114     <span class="keywordflow">if</span> (this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length) {
<a name="l05115"></a>05115       <span class="comment">// If we&#39;re accumulating, we were starting from zero to begin with, so</span>
<a name="l05116"></a>05116       <span class="comment">// there is no need to send a nuking splice.</span>
<a name="l05117"></a>05117       <span class="keywordflow">if</span> (!this._accumulating)
<a name="l05118"></a>05118         this._bridgeHandle.sendSplice(0, this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length, [], <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l05119"></a>05119       this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.splice(0, this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length);
<a name="l05120"></a>05120 
<a name="l05121"></a>05121       this.startTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05122"></a>05122       this.startUID = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05123"></a>05123       this.endTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05124"></a>05124       this.endUID = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05125"></a>05125     }
<a name="l05126"></a>05126   },
<a name="l05127"></a>05127 
<a name="l05131"></a>05131   refresh: <span class="keyword">function</span>() {
<a name="l05132"></a>05132     this._storage.refreshSlice(<span class="keyword">this</span>);
<a name="l05133"></a>05133   },
<a name="l05134"></a>05134 
<a name="l05135"></a>05135   reqNoteRanges: <span class="keyword">function</span>(firstIndex, firstSuid, lastIndex, lastSuid) {
<a name="l05136"></a>05136     <span class="keywordflow">if</span> (!this._bridgeHandle)
<a name="l05137"></a>05137       <span class="keywordflow">return</span>;
<a name="l05138"></a>05138 
<a name="l05139"></a>05139     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l05140"></a>05140     <span class="comment">// - Fixup indices if required</span>
<a name="l05141"></a>05141     <span class="keywordflow">if</span> (firstIndex &gt;= this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length ||
<a name="l05142"></a>05142         <span class="keyword">this</span>.headers[firstIndex].suid !== firstSuid) {
<a name="l05143"></a>05143       firstIndex = 0; <span class="comment">// default to not splicing if it&#39;s gone</span>
<a name="l05144"></a>05144       <span class="keywordflow">for</span> (i = 0; i &lt; this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length; i++) {
<a name="l05145"></a>05145         <span class="keywordflow">if</span> (this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[i].suid === firstSuid) {
<a name="l05146"></a>05146           firstIndex = <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l05147"></a>05147           <span class="keywordflow">break</span>;
<a name="l05148"></a>05148         }
<a name="l05149"></a>05149       }
<a name="l05150"></a>05150     }
<a name="l05151"></a>05151     <span class="keywordflow">if</span> (lastIndex &gt;= this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length ||
<a name="l05152"></a>05152         <span class="keyword">this</span>.headers[lastIndex].suid !== lastSuid) {
<a name="l05153"></a>05153       <span class="keywordflow">for</span> (i = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length - 1; i &gt;= 0; i--) {
<a name="l05154"></a>05154         <span class="keywordflow">if</span> (this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[i].suid === lastSuid) {
<a name="l05155"></a>05155           lastIndex = <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l05156"></a>05156           <span class="keywordflow">break</span>;
<a name="l05157"></a>05157         }
<a name="l05158"></a>05158       }
<a name="l05159"></a>05159     }
<a name="l05160"></a>05160 
<a name="l05161"></a>05161     <span class="comment">// - Perform splices as required</span>
<a name="l05162"></a>05162     <span class="comment">// (high before low to avoid index changes)</span>
<a name="l05163"></a>05163     <span class="keywordflow">if</span> (lastIndex + 1 &lt; this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length) {
<a name="l05164"></a>05164       this.atBottom = <span class="keyword">false</span>;
<a name="l05165"></a>05165       this.userCanGrowDownwards = <span class="keyword">false</span>;
<a name="l05166"></a>05166       var delCount = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length - lastIndex  - 1;
<a name="l05167"></a>05167       this.desiredHeaders -= delCount;
<a name="l05168"></a>05168       <span class="keywordflow">if</span> (!this._accumulating)
<a name="l05169"></a>05169         this._bridgeHandle.sendSplice(
<a name="l05170"></a>05170           lastIndex + 1, delCount, [],
<a name="l05171"></a>05171           <span class="comment">// This is expected; more coming if there&#39;s a low-end splice</span>
<a name="l05172"></a>05172           <span class="keyword">true</span>, firstIndex &gt; 0);
<a name="l05173"></a>05173       this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.splice(lastIndex + 1, this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length - lastIndex - 1);
<a name="l05174"></a>05174       var lastHeader = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[lastIndex];
<a name="l05175"></a>05175       this.startTS = lastHeader.date;
<a name="l05176"></a>05176       this.startUID = lastHeader.id;
<a name="l05177"></a>05177     }
<a name="l05178"></a>05178     <span class="keywordflow">if</span> (firstIndex &gt; 0) {
<a name="l05179"></a>05179       this.atTop = <span class="keyword">false</span>;
<a name="l05180"></a>05180       this.userCanGrowUpwards = <span class="keyword">false</span>;
<a name="l05181"></a>05181       this.desiredHeaders -= firstIndex;
<a name="l05182"></a>05182       <span class="keywordflow">if</span> (!this._accumulating)
<a name="l05183"></a>05183         this._bridgeHandle.sendSplice(0, firstIndex, [], <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l05184"></a>05184       this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.splice(0, firstIndex);
<a name="l05185"></a>05185       var firstHeader = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[0];
<a name="l05186"></a>05186       this.endTS = firstHeader.date;
<a name="l05187"></a>05187       this.endUID = firstHeader.id;
<a name="l05188"></a>05188     }
<a name="l05189"></a>05189 
<a name="l05190"></a>05190     this._storage.sliceShrunk(<span class="keyword">this</span>);
<a name="l05191"></a>05191   },
<a name="l05192"></a>05192 
<a name="l05193"></a>05193   reqGrow: <span class="keyword">function</span>(dirMagnitude, userRequestsGrowth) {
<a name="l05194"></a>05194     <span class="keywordflow">if</span> (dirMagnitude === -1)
<a name="l05195"></a>05195       dirMagnitude = -$sync.INITIAL_FILL_SIZE;
<a name="l05196"></a>05196     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirMagnitude === 1)
<a name="l05197"></a>05197       dirMagnitude = $sync.INITIAL_FILL_SIZE;
<a name="l05198"></a>05198     this._storage.growSlice(<span class="keyword">this</span>, dirMagnitude, userRequestsGrowth);
<a name="l05199"></a>05199   },
<a name="l05200"></a>05200 
<a name="l05201"></a>05201   sendEmptyCompletion: <span class="keyword">function</span>() {
<a name="l05202"></a>05202     this.setStatus(<span class="stringliteral">&#39;synced&#39;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l05203"></a>05203   },
<a name="l05204"></a>05204 
<a name="l05205"></a>05205   setStatus: <span class="keyword">function</span>(<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, requested, moreExpected, flushAccumulated,
<a name="l05206"></a>05206                       progress, newEmailCount) {
<a name="l05207"></a>05207     <span class="keywordflow">if</span> (!this._bridgeHandle)
<a name="l05208"></a>05208       <span class="keywordflow">return</span>;
<a name="l05209"></a>05209 
<a name="l05210"></a>05210     <span class="keywordflow">switch</span> (<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>) {
<a name="l05211"></a>05211       <span class="keywordflow">case</span> <span class="stringliteral">&#39;synced&#39;</span>:
<a name="l05212"></a>05212       <span class="keywordflow">case</span> <span class="stringliteral">&#39;syncfailed&#39;</span>:
<a name="l05213"></a>05213         this._updateSliceFlags();
<a name="l05214"></a>05214         <span class="keywordflow">break</span>;
<a name="l05215"></a>05215     }
<a name="l05216"></a>05216     <span class="keywordflow">if</span> (flushAccumulated &amp;&amp; this._accumulating) {
<a name="l05217"></a>05217       <span class="keywordflow">if</span> (this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length &gt; <span class="keyword">this</span>.desiredHeaders) {
<a name="l05218"></a>05218         this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.splice(this.desiredHeaders,
<a name="l05219"></a>05219                             this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length - <span class="keyword">this</span>.desiredHeaders);
<a name="l05220"></a>05220         this.endTS = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length - 1].date;
<a name="l05221"></a>05221         this.endUID = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length - 1].id;
<a name="l05222"></a>05222       }
<a name="l05223"></a>05223 
<a name="l05224"></a>05224       this._accumulating = <span class="keyword">false</span>;
<a name="l05225"></a>05225       this._bridgeHandle.status = <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>;
<a name="l05226"></a>05226       <span class="comment">// XXX remove concat() once our bridge sending makes rep sharing</span>
<a name="l05227"></a>05227       <span class="comment">// impossible by dint of actual postMessage or JSON roundtripping.</span>
<a name="l05228"></a>05228       this._bridgeHandle.sendSplice(0, 0, this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.concat(),
<a name="l05229"></a>05229                                     requested, moreExpected,
<a name="l05230"></a>05230                                     newEmailCount);
<a name="l05231"></a>05231       <span class="comment">// If we&#39;re no longer synchronizing, we want to update desiredHeaders</span>
<a name="l05232"></a>05232       <span class="comment">// to avoid accumulating extra &#39;desire&#39;.</span>
<a name="l05233"></a>05233       <span class="keywordflow">if</span> (<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a> !== <span class="stringliteral">&#39;synchronizing&#39;</span>)
<a name="l05234"></a>05234         this.desiredHeaders = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length;
<a name="l05235"></a>05235     }
<a name="l05236"></a>05236     <span class="keywordflow">else</span> {
<a name="l05237"></a>05237       this._bridgeHandle.sendStatus(<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, requested, moreExpected, progress,
<a name="l05238"></a>05238                                     newEmailCount);
<a name="l05239"></a>05239     }
<a name="l05240"></a>05240   },
<a name="l05241"></a>05241 
<a name="l05246"></a>05246   setSyncProgress: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>) {
<a name="l05247"></a>05247     <span class="keywordflow">if</span> (!this._bridgeHandle)
<a name="l05248"></a>05248       <span class="keywordflow">return</span>;
<a name="l05249"></a>05249     this._bridgeHandle.sendSyncProgress(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>);
<a name="l05250"></a>05250   },
<a name="l05251"></a>05251 
<a name="l05266"></a>05266   batchAppendHeaders: <span class="keyword">function</span>(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, insertAt, moreComing) {
<a name="l05267"></a>05267     <span class="keywordflow">if</span> (!this._bridgeHandle)
<a name="l05268"></a>05268       <span class="keywordflow">return</span>;
<a name="l05269"></a>05269 
<a name="l05270"></a>05270     this._LOG.headersAppended(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>);
<a name="l05271"></a>05271     <span class="keywordflow">if</span> (insertAt === -1)
<a name="l05272"></a>05272       insertAt = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length;
<a name="l05273"></a>05273     this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.splice.apply(this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, [insertAt, 0].concat(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>));
<a name="l05274"></a>05274 
<a name="l05275"></a>05275     <span class="comment">// XXX this can obviously be optimized to not be a loop</span>
<a name="l05276"></a>05276     <span class="keywordflow">for</span> (var i = 0; i &lt; <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length; i++) {
<a name="l05277"></a>05277       var <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a> = <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l05278"></a>05278       <span class="keywordflow">if</span> (this.startTS === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> ||
<a name="l05279"></a>05279           BEFORE(header.date, <span class="keyword">this</span>.startTS)) {
<a name="l05280"></a>05280         this.startTS = header.date;
<a name="l05281"></a>05281         this.startUID = header.id;
<a name="l05282"></a>05282       }
<a name="l05283"></a>05283       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (header.date === <span class="keyword">this</span>.startTS &amp;&amp;
<a name="l05284"></a>05284                header.id &lt; <span class="keyword">this</span>.startUID) {
<a name="l05285"></a>05285         this.startUID = header.id;
<a name="l05286"></a>05286       }
<a name="l05287"></a>05287       <span class="keywordflow">if</span> (this.endTS === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> ||
<a name="l05288"></a>05288           STRICTLY_AFTER(header.date, <span class="keyword">this</span>.endTS)) {
<a name="l05289"></a>05289         this.endTS = header.date;
<a name="l05290"></a>05290         this.endUID = header.id;
<a name="l05291"></a>05291       }
<a name="l05292"></a>05292       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (header.date === <span class="keyword">this</span>.endTS &amp;&amp;
<a name="l05293"></a>05293                header.id &gt; <span class="keyword">this</span>.endUID) {
<a name="l05294"></a>05294         this.endUID = header.id;
<a name="l05295"></a>05295       }
<a name="l05296"></a>05296     }
<a name="l05297"></a>05297 
<a name="l05298"></a>05298     this._updateSliceFlags();
<a name="l05299"></a>05299     <span class="keywordflow">if</span> (!this._accumulating)
<a name="l05300"></a>05300       this._bridgeHandle.sendSplice(insertAt, 0, <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>,
<a name="l05301"></a>05301                                     <span class="keyword">true</span>, moreComing);
<a name="l05302"></a>05302   },
<a name="l05303"></a>05303 
<a name="l05310"></a>05310   onHeaderAdded: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, syncDriven, messageIsNew) {
<a name="l05311"></a>05311     <span class="keywordflow">if</span> (!this._bridgeHandle)
<a name="l05312"></a>05312       <span class="keywordflow">return</span>;
<a name="l05313"></a>05313 
<a name="l05314"></a>05314     var idx = bsearchForInsert(this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, header, cmpHeaderYoungToOld);
<a name="l05315"></a>05315     var <a class="code" href="../../da/d32/prio_8h.html#af43989ec768cc0b16e89ee92cf28a223">hlen</a> = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length;
<a name="l05316"></a>05316     <span class="comment">// Don&#39;t append the header if it would expand us beyond our requested amount</span>
<a name="l05317"></a>05317     <span class="comment">// and there is no subsequent step, like accumulate flushing, that would get</span>
<a name="l05318"></a>05318     <span class="comment">// rid of the excess.  Note that this does not guarantee that we won&#39;t</span>
<a name="l05319"></a>05319     <span class="comment">// end up with more headers than originally planned; if we get told about</span>
<a name="l05320"></a>05320     <span class="comment">// headers earlier than the last slot, we will insert them and grow without</span>
<a name="l05321"></a>05321     <span class="comment">// forcing a removal of something else to offset.</span>
<a name="l05322"></a>05322     <span class="keywordflow">if</span> (hlen &gt;= this.desiredHeaders &amp;&amp; idx === hlen &amp;&amp;
<a name="l05323"></a>05323         !this._accumulating)
<a name="l05324"></a>05324       <span class="keywordflow">return</span>;
<a name="l05325"></a>05325     <span class="comment">// If we are inserting (not at the end) and not accumulating (in which case</span>
<a name="l05326"></a>05326     <span class="comment">// we can chop off the excess before we tell about it), then be sure to grow</span>
<a name="l05327"></a>05327     <span class="comment">// the number of desired headers to be consistent with the number of headers</span>
<a name="l05328"></a>05328     <span class="comment">// we have.</span>
<a name="l05329"></a>05329     <span class="keywordflow">if</span> (hlen &gt;= this.desiredHeaders &amp;&amp; !this._accumulating)
<a name="l05330"></a>05330       this.desiredHeaders++;
<a name="l05331"></a>05331 
<a name="l05332"></a>05332     <span class="keywordflow">if</span> (this.startTS === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> ||
<a name="l05333"></a>05333         BEFORE(header.date, <span class="keyword">this</span>.startTS)) {
<a name="l05334"></a>05334       this.startTS = header.date;
<a name="l05335"></a>05335       this.startUID = header.id;
<a name="l05336"></a>05336     }
<a name="l05337"></a>05337     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (header.date === <span class="keyword">this</span>.startTS &amp;&amp;
<a name="l05338"></a>05338              header.id &lt; <span class="keyword">this</span>.startUID) {
<a name="l05339"></a>05339       this.startUID = header.id;
<a name="l05340"></a>05340     }
<a name="l05341"></a>05341     <span class="keywordflow">if</span> (this.endTS === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> ||
<a name="l05342"></a>05342         STRICTLY_AFTER(header.date, <span class="keyword">this</span>.endTS)) {
<a name="l05343"></a>05343       this.endTS = header.date;
<a name="l05344"></a>05344       this.endUID = header.id;
<a name="l05345"></a>05345     }
<a name="l05346"></a>05346     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (header.date === <span class="keyword">this</span>.endTS &amp;&amp;
<a name="l05347"></a>05347              header.id &gt; <span class="keyword">this</span>.endUID) {
<a name="l05348"></a>05348       this.endUID = header.id;
<a name="l05349"></a>05349     }
<a name="l05350"></a>05350 
<a name="l05351"></a>05351     this._LOG.headerAdded(idx, header);
<a name="l05352"></a>05352     <span class="keywordflow">if</span> (!this._accumulating)
<a name="l05353"></a>05353       this._bridgeHandle.sendSplice(idx, 0, [header],
<a name="l05354"></a>05354                                     Boolean(this.waitingOnData),
<a name="l05355"></a>05355                                     Boolean(this.waitingOnData));
<a name="l05356"></a>05356     this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.splice(idx, 0, header);
<a name="l05357"></a>05357   },
<a name="l05358"></a>05358 
<a name="l05363"></a>05363   onHeaderModified: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>) {
<a name="l05364"></a>05364     <span class="keywordflow">if</span> (!this._bridgeHandle)
<a name="l05365"></a>05365       <span class="keywordflow">return</span>;
<a name="l05366"></a>05366 
<a name="l05367"></a>05367     <span class="comment">// this can only affect flags which will not affect ordering</span>
<a name="l05368"></a>05368     var idx = bsearchMaybeExists(this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, header, cmpHeaderYoungToOld);
<a name="l05369"></a>05369     <span class="keywordflow">if</span> (idx !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l05370"></a>05370       <span class="comment">// There is no identity invariant to ensure this is already true.</span>
<a name="l05371"></a>05371       this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[idx] = <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>;
<a name="l05372"></a>05372       this._LOG.headerModified(idx, header);
<a name="l05373"></a>05373       <span class="comment">// If we are accumulating, the update will be observed.</span>
<a name="l05374"></a>05374       <span class="keywordflow">if</span> (!this._accumulating)
<a name="l05375"></a>05375         this._bridgeHandle.sendUpdate([idx, header]);
<a name="l05376"></a>05376     }
<a name="l05377"></a>05377   },
<a name="l05378"></a>05378 
<a name="l05382"></a>05382   onHeaderRemoved: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>) {
<a name="l05383"></a>05383     <span class="keywordflow">if</span> (!this._bridgeHandle)
<a name="l05384"></a>05384       <span class="keywordflow">return</span>;
<a name="l05385"></a>05385 
<a name="l05386"></a>05386     var idx = bsearchMaybeExists(this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, header, cmpHeaderYoungToOld);
<a name="l05387"></a>05387     <span class="keywordflow">if</span> (idx !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l05388"></a>05388       this._LOG.headerRemoved(idx, header);
<a name="l05389"></a>05389       <span class="keywordflow">if</span> (!this._accumulating)
<a name="l05390"></a>05390         this._bridgeHandle.sendSplice(idx, 1, [],
<a name="l05391"></a>05391                                       Boolean(this.waitingOnData),
<a name="l05392"></a>05392                                       Boolean(this.waitingOnData));
<a name="l05393"></a>05393       this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.splice(idx, 1);
<a name="l05394"></a>05394 
<a name="l05395"></a>05395       <span class="comment">// update time-ranges if required...</span>
<a name="l05396"></a>05396       <span class="keywordflow">if</span> (header.date === <span class="keyword">this</span>.endTS &amp;&amp; header.id === <span class="keyword">this</span>.endUID) {
<a name="l05397"></a>05397         <span class="keywordflow">if</span> (!this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length) {
<a name="l05398"></a>05398           this.endTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05399"></a>05399           this.endUID = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05400"></a>05400         }
<a name="l05401"></a>05401         <span class="keywordflow">else</span> {
<a name="l05402"></a>05402           this.endTS = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[0].date;
<a name="l05403"></a>05403           this.endUID = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[0].id;
<a name="l05404"></a>05404         }
<a name="l05405"></a>05405       }
<a name="l05406"></a>05406       <span class="keywordflow">if</span> (header.date === <span class="keyword">this</span>.startTS &amp;&amp; header.id === <span class="keyword">this</span>.startUID) {
<a name="l05407"></a>05407         <span class="keywordflow">if</span> (!this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length) {
<a name="l05408"></a>05408           this.startTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05409"></a>05409           this.startUID = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05410"></a>05410         }
<a name="l05411"></a>05411         <span class="keywordflow">else</span> {
<a name="l05412"></a>05412           var lastHeader = this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[this.<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length - 1];
<a name="l05413"></a>05413           this.startTS = lastHeader.date;
<a name="l05414"></a>05414           this.startUID = lastHeader.id;
<a name="l05415"></a>05415         }
<a name="l05416"></a>05416       }
<a name="l05417"></a>05417     }
<a name="l05418"></a>05418   },
<a name="l05419"></a>05419 
<a name="l05420"></a>05420   <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span>() {
<a name="l05421"></a>05421     this._bridgeHandle = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05422"></a>05422     this.desiredHeaders = 0;
<a name="l05423"></a>05423     this._storage.dyingSlice(<span class="keyword">this</span>);
<a name="l05424"></a>05424     this._LOG.__die();
<a name="l05425"></a>05425   },
<a name="l05426"></a>05426 
<a name="l05427"></a>05427   <span class="keyword">get</span> isDead() {
<a name="l05428"></a>05428     <span class="keywordflow">return</span> this._bridgeHandle === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05429"></a>05429   },
<a name="l05430"></a>05430 };
<a name="l05431"></a>05431 
<a name="l05755"></a>05755 <span class="keyword">function</span> FolderStorage(account, folderId, persistedFolderInfo, dbConn,
<a name="l05756"></a>05756                        FolderSyncer, _parentLog) {
<a name="l05758"></a>05758   this._account = account;
<a name="l05759"></a>05759   this._imapDb = dbConn;
<a name="l05760"></a>05760 
<a name="l05761"></a>05761   this.folderId = folderId;
<a name="l05762"></a>05762   this.folderMeta = persistedFolderInfo.$meta;
<a name="l05763"></a>05763   this._folderImpl = persistedFolderInfo.$impl;
<a name="l05764"></a>05764 
<a name="l05765"></a>05765   this._LOG = <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#af6bd479a55b8d304e23d9a96d199c3aa">LOGFAB</a>.FolderStorage(<span class="keyword">this</span>, _parentLog, folderId);
<a name="l05766"></a>05766 
<a name="l05774"></a>05774   this._accuracyRanges = persistedFolderInfo.accuracy;
<a name="l05782"></a>05782   this._headerBlockInfos = persistedFolderInfo.headerBlocks;
<a name="l05790"></a>05790   this._bodyBlockInfos = persistedFolderInfo.bodyBlocks;
<a name="l05791"></a>05791 
<a name="l05802"></a>05802   this._serverIdHeaderBlockMapping =
<a name="l05803"></a>05803     persistedFolderInfo.serverIdHeaderBlockMapping;
<a name="l05804"></a>05804 
<a name="l05810"></a>05810   this._headerBlocks = {};
<a name="l05819"></a>05819   this._loadedHeaderBlockInfos = [];
<a name="l05825"></a>05825   this._bodyBlocks = {};
<a name="l05834"></a>05834   this._loadedBodyBlockInfos = [];
<a name="l05835"></a>05835 
<a name="l05836"></a>05836   this._bound_makeHeaderBlock = this._makeHeaderBlock.bind(<span class="keyword">this</span>);
<a name="l05837"></a>05837   this._bound_insertHeaderInBlock = this._insertHeaderInBlock.bind(<span class="keyword">this</span>);
<a name="l05838"></a>05838   this._bound_splitHeaderBlock = this._splitHeaderBlock.bind(<span class="keyword">this</span>);
<a name="l05839"></a>05839   this._bound_deleteHeaderFromBlock = this._deleteHeaderFromBlock.bind(<span class="keyword">this</span>);
<a name="l05840"></a>05840 
<a name="l05841"></a>05841   this._bound_makeBodyBlock = this._makeBodyBlock.bind(<span class="keyword">this</span>);
<a name="l05842"></a>05842   this._bound_insertBodyInBlock = this._insertBodyInBlock.bind(<span class="keyword">this</span>);
<a name="l05843"></a>05843   this._bound_splitBodyBlock = this._splitBodyBlock.bind(<span class="keyword">this</span>);
<a name="l05844"></a>05844   this._bound_deleteBodyFromBlock = this._deleteBodyFromBlock.bind(<span class="keyword">this</span>);
<a name="l05845"></a>05845 
<a name="l05849"></a>05849   this._dirty = <span class="keyword">false</span>;
<a name="l05851"></a>05851   this._dirtyHeaderBlocks = {};
<a name="l05853"></a>05853   this._dirtyBodyBlocks = {};
<a name="l05854"></a>05854 
<a name="l05858"></a>05858   this._pendingLoads = [];
<a name="l05865"></a>05865   this._pendingLoadListeners = {};
<a name="l05866"></a>05866 
<a name="l05873"></a>05873   this._deferredCalls = [];
<a name="l05874"></a>05874 
<a name="l05889"></a>05889   this._mutexQueue = [];
<a name="l05890"></a>05890 
<a name="l05894"></a>05894   this._slices = [];
<a name="l05900"></a>05900   this._curSyncSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05901"></a>05901 
<a name="l05902"></a>05902   this._messagePurgeScheduled = <span class="keyword">false</span>;
<a name="l05903"></a>05903 
<a name="l05904"></a>05904   this.folderSyncer = FolderSyncer &amp;&amp; <span class="keyword">new</span> FolderSyncer(account, <span class="keyword">this</span>,
<a name="l05905"></a>05905                                                        this._LOG);
<a name="l05906"></a>05906 }
<a name="l05907"></a>05907 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.FolderStorage = FolderStorage;
<a name="l05908"></a>05908 FolderStorage.prototype = {
<a name="l05909"></a>05909   <span class="keyword">get</span> hasActiveSlices() {
<a name="l05910"></a>05910     <span class="keywordflow">return</span> this._slices.length &gt; 0;
<a name="l05911"></a>05911   },
<a name="l05912"></a>05912 
<a name="l05916"></a>05916   resetAndRefreshActiveSlices: <span class="keyword">function</span>() {
<a name="l05917"></a>05917     <span class="keywordflow">if</span> (!this._slices.length)
<a name="l05918"></a>05918       <span class="keywordflow">return</span>;
<a name="l05919"></a>05919     <span class="comment">// This will splice out slices as we go, so work from the back to avoid</span>
<a name="l05920"></a>05920     <span class="comment">// processing any slice more than once.  (Shuffling of processed slices</span>
<a name="l05921"></a>05921     <span class="comment">// will occur, but we don&#39;t care.)</span>
<a name="l05922"></a>05922     <span class="keywordflow">for</span> (var i = this._slices.length - 1; i &gt;= 0; i--) {
<a name="l05923"></a>05923       var <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a> = this._slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l05924"></a>05924       slice.reset();
<a name="l05925"></a>05925       slice.desiredHeaders = $sync.INITIAL_FILL_SIZE;
<a name="l05926"></a>05926       this._resetAndResyncSlice(slice, <span class="keyword">true</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l05927"></a>05927     }
<a name="l05928"></a>05928   },
<a name="l05929"></a>05929 
<a name="l05938"></a>05938   generatePersistenceInfo: <span class="keyword">function</span>() {
<a name="l05939"></a>05939     <span class="keywordflow">if</span> (!this._dirty)
<a name="l05940"></a>05940       <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05941"></a>05941     var pinfo = {
<a name="l05942"></a>05942       <span class="keywordtype">id</span>: this.folderId,
<a name="l05943"></a>05943       headerBlocks: this._dirtyHeaderBlocks,
<a name="l05944"></a>05944       bodyBlocks: this._dirtyBodyBlocks,
<a name="l05945"></a>05945     };
<a name="l05946"></a>05946     this._dirtyHeaderBlocks = {};
<a name="l05947"></a>05947     this._dirtyBodyBlocks = {};
<a name="l05948"></a>05948     this._dirty = <span class="keyword">false</span>;
<a name="l05949"></a>05949     this.flushExcessCachedBlocks(<span class="stringliteral">&#39;persist&#39;</span>);
<a name="l05950"></a>05950     <span class="keywordflow">return</span> pinfo;
<a name="l05951"></a>05951   },
<a name="l05952"></a>05952 
<a name="l05953"></a>05953   _invokeNextMutexedCall: <span class="keyword">function</span>() {
<a name="l05954"></a>05954     var callInfo = this._mutexQueue[0], <span class="keyword">self</span> = <span class="keyword">this</span>, <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a> = <span class="keyword">false</span>;
<a name="l05955"></a>05955     this._mutexedCallInProgress = <span class="keyword">true</span>;
<a name="l05956"></a>05956     this._LOG.mutexedCall_begin(callInfo.name);
<a name="l05957"></a>05957 
<a name="l05958"></a>05958     <span class="keywordflow">try</span> {
<a name="l05959"></a>05959       callInfo.func(<span class="keyword">function</span> mutexedOpDone() {
<a name="l05960"></a>05960         <span class="keywordflow">if</span> (<a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>) {
<a name="l05961"></a>05961           <span class="keyword">self</span>._LOG.tooManyCallbacks(callInfo.name);
<a name="l05962"></a>05962           <span class="keywordflow">return</span>;
<a name="l05963"></a>05963         }
<a name="l05964"></a>05964         <span class="keyword">self</span>._LOG.mutexedCall_end(callInfo.name);
<a name="l05965"></a>05965         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a> = <span class="keyword">true</span>;
<a name="l05966"></a>05966         <span class="keywordflow">if</span> (<span class="keyword">self</span>._mutexQueue[0] !== callInfo) {
<a name="l05967"></a>05967           <span class="keyword">self</span>._LOG.mutexInvariantFail(callInfo.name, <span class="keyword">self</span>._mutexQueue[0].name);
<a name="l05968"></a>05968           <span class="keywordflow">return</span>;
<a name="l05969"></a>05969         }
<a name="l05970"></a>05970         <span class="keyword">self</span>._mutexQueue.shift();
<a name="l05971"></a>05971         <span class="keyword">self</span>.flushExcessCachedBlocks(<span class="stringliteral">&#39;mutex&#39;</span>);
<a name="l05972"></a>05972         <span class="comment">// Although everything should be async, avoid stack explosions by</span>
<a name="l05973"></a>05973         <span class="comment">// deferring the execution to a future turn of the event loop.</span>
<a name="l05974"></a>05974         <span class="keywordflow">if</span> (<span class="keyword">self</span>._mutexQueue.length)
<a name="l05975"></a>05975           <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setZeroTimeout(<span class="keyword">self</span>._invokeNextMutexedCall.bind(<span class="keyword">self</span>));
<a name="l05976"></a>05976         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">self</span>._slices.length === 0)
<a name="l05977"></a>05977           <span class="keyword">self</span>.folderSyncer.allConsumersDead();
<a name="l05978"></a>05978       });
<a name="l05979"></a>05979     }
<a name="l05980"></a>05980     <span class="keywordflow">catch</span> (ex) {
<a name="l05981"></a>05981       this._LOG.mutexedOpErr(ex);
<a name="l05982"></a>05982     }
<a name="l05983"></a>05983   },
<a name="l05984"></a>05984 
<a name="l06019"></a>06019   runMutexed: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#ad84b078786561118564537030cd7a8b1">func</a>) {
<a name="l06020"></a>06020     var doRun = this._mutexQueue.length === 0;
<a name="l06021"></a>06021     this._mutexQueue.push({ <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#ad84b078786561118564537030cd7a8b1">func</a>: <a class="code" href="../../d2/d7d/jsapi_8h.html#ad84b078786561118564537030cd7a8b1">func</a> });
<a name="l06022"></a>06022 
<a name="l06023"></a>06023     <span class="keywordflow">if</span> (doRun)
<a name="l06024"></a>06024       this._invokeNextMutexedCall();
<a name="l06025"></a>06025   },
<a name="l06026"></a>06026 
<a name="l06027"></a>06027   _issueNewHeaderId: <span class="keyword">function</span>() {
<a name="l06028"></a>06028     <span class="keywordflow">return</span> this._folderImpl.nextId++;
<a name="l06029"></a>06029   },
<a name="l06030"></a>06030 
<a name="l06036"></a>06036   _makeHeaderBlock: <span class="keyword">function</span> ifs__makeHeaderBlock(
<a name="l06037"></a>06037       startTS, startUID, endTS, endUID, estSize, <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>, <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>) {
<a name="l06038"></a>06038     var blockId = $a64.encodeInt(this._folderImpl.nextHeaderBlock++),
<a name="l06039"></a>06039         blockInfo = {
<a name="l06040"></a>06040           blockId: blockId,
<a name="l06041"></a>06041           startTS: startTS,
<a name="l06042"></a>06042           startUID: startUID,
<a name="l06043"></a>06043           endTS: endTS,
<a name="l06044"></a>06044           endUID: endUID,
<a name="l06045"></a>06045           <a class="code" href="../../de/deb/jsdbgapi_8h.html#af811e5c0ef06b777b160f87806b7285e">count</a>: <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a> ? <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>.length : 0,
<a name="l06046"></a>06046           estSize: estSize || 0,
<a name="l06047"></a>06047         },
<a name="l06048"></a>06048         block = {
<a name="l06049"></a>06049           <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>: <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a> || [],
<a name="l06050"></a>06050           <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>: <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a> || [],
<a name="l06051"></a>06051         };
<a name="l06052"></a>06052     this._dirty = <span class="keyword">true</span>;
<a name="l06053"></a>06053     this._headerBlocks[blockId] = block;
<a name="l06054"></a>06054     this._dirtyHeaderBlocks[blockId] = block;
<a name="l06055"></a>06055 
<a name="l06056"></a>06056     <span class="comment">// Update the server id mapping if we are maintaining one.</span>
<a name="l06057"></a>06057     <span class="keywordflow">if</span> (this._serverIdHeaderBlockMapping &amp;&amp; <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>) {
<a name="l06058"></a>06058       var srvMapping = this._serverIdHeaderBlockMapping;
<a name="l06059"></a>06059       <span class="keywordflow">for</span> (var i = 0; i &lt; <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length; i++) {
<a name="l06060"></a>06060         var header = <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06061"></a>06061         <span class="keywordflow">if</span> (header.srvid)
<a name="l06062"></a>06062           srvMapping[header.srvid] = blockId;
<a name="l06063"></a>06063       }
<a name="l06064"></a>06064     }
<a name="l06065"></a>06065 
<a name="l06066"></a>06066     <span class="keywordflow">return</span> blockInfo;
<a name="l06067"></a>06067   },
<a name="l06068"></a>06068 
<a name="l06069"></a>06069   _insertHeaderInBlock: <span class="keyword">function</span> ifs__insertHeaderInBlock(header, uid, <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>,
<a name="l06070"></a>06070                                                           block) {
<a name="l06071"></a>06071     var idx = bsearchForInsert(block.headers, header, cmpHeaderYoungToOld);
<a name="l06072"></a>06072     block.ids.splice(idx, 0, header.id);
<a name="l06073"></a>06073     block.headers.splice(idx, 0, header);
<a name="l06074"></a>06074     this._dirty = <span class="keyword">true</span>;
<a name="l06075"></a>06075     this._dirtyHeaderBlocks[<a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.blockId] = block;
<a name="l06076"></a>06076     <span class="comment">// Insertion does not need to update start/end TS/UID because the calling</span>
<a name="l06077"></a>06077     <span class="comment">// logic is able to handle it.</span>
<a name="l06078"></a>06078   },
<a name="l06079"></a>06079 
<a name="l06080"></a>06080   _deleteHeaderFromBlock: <span class="keyword">function</span> ifs__deleteHeaderFromBlock(uid, <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>, block) {
<a name="l06081"></a>06081     var idx = block.ids.indexOf(uid), <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>;
<a name="l06082"></a>06082     <span class="comment">// - remove, update counts</span>
<a name="l06083"></a>06083     block.ids.splice(idx, 1);
<a name="l06084"></a>06084     block.headers.splice(idx, 1);
<a name="l06085"></a>06085     <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.estSize -= $sync.HEADER_EST_SIZE_IN_BYTES;
<a name="l06086"></a>06086     <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.count--;
<a name="l06087"></a>06087 
<a name="l06088"></a>06088     this._dirty = <span class="keyword">true</span>;
<a name="l06089"></a>06089     this._dirtyHeaderBlocks[<a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.blockId] = block;
<a name="l06090"></a>06090 
<a name="l06091"></a>06091     <span class="comment">// - update endTS/endUID if necessary</span>
<a name="l06092"></a>06092     <span class="keywordflow">if</span> (idx === 0 &amp;&amp; <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.count) {
<a name="l06093"></a>06093       header = block.headers[0];
<a name="l06094"></a>06094       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.endTS = header.date;
<a name="l06095"></a>06095       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.endUID = header.id;
<a name="l06096"></a>06096     }
<a name="l06097"></a>06097     <span class="comment">// - update startTS/startUID if necessary</span>
<a name="l06098"></a>06098     <span class="keywordflow">if</span> (idx === <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.count &amp;&amp; idx &gt; 0) {
<a name="l06099"></a>06099       header = block.headers[idx - 1];
<a name="l06100"></a>06100       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.startTS = header.date;
<a name="l06101"></a>06101       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.startUID = header.id;
<a name="l06102"></a>06102     }
<a name="l06103"></a>06103   },
<a name="l06104"></a>06104 
<a name="l06112"></a>06112   _splitHeaderBlock: <span class="keyword">function</span> ifs__splitHeaderBlock(splinfo, splock,
<a name="l06113"></a>06113                                                     newerTargetBytes) {
<a name="l06114"></a>06114     <span class="comment">// We currently assume a fixed size, so this is easy.</span>
<a name="l06115"></a>06115     var numHeaders = Math.ceil(newerTargetBytes /
<a name="l06116"></a>06116                                $sync.HEADER_EST_SIZE_IN_BYTES);
<a name="l06117"></a>06117     <span class="keywordflow">if</span> (numHeaders &gt; splock.headers.length)
<a name="l06118"></a>06118       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;No need to split!&quot;</span>);
<a name="l06119"></a>06119 
<a name="l06120"></a>06120     var olderNumHeaders = splock.headers.length - numHeaders,
<a name="l06121"></a>06121         olderEndHeader = splock.headers[numHeaders],
<a name="l06122"></a>06122         <span class="comment">// (This will update the server id mappings for the headers too)</span>
<a name="l06123"></a>06123         olderInfo = this._makeHeaderBlock(
<a name="l06124"></a>06124                       <span class="comment">// Take the start info from the block, because it may have</span>
<a name="l06125"></a>06125                       <span class="comment">// been extended beyond the header (for an insertion if</span>
<a name="l06126"></a>06126                       <span class="comment">// we change back to inserting after splitting.)</span>
<a name="l06127"></a>06127                       splinfo.startTS, splinfo.startUID,
<a name="l06128"></a>06128                       olderEndHeader.date, olderEndHeader.id,
<a name="l06129"></a>06129                       olderNumHeaders * $sync.HEADER_EST_SIZE_IN_BYTES,
<a name="l06130"></a>06130                       splock.ids.splice(numHeaders, olderNumHeaders),
<a name="l06131"></a>06131                       splock.headers.splice(numHeaders, olderNumHeaders));
<a name="l06132"></a>06132 
<a name="l06133"></a>06133     var newerStartHeader = splock.headers[numHeaders - 1];
<a name="l06134"></a>06134     splinfo.count = numHeaders;
<a name="l06135"></a>06135     splinfo.estSize = numHeaders * $sync.HEADER_EST_SIZE_IN_BYTES;
<a name="l06136"></a>06136     splinfo.startTS = newerStartHeader.date;
<a name="l06137"></a>06137     splinfo.startUID = newerStartHeader.id;
<a name="l06138"></a>06138     <span class="comment">// this._dirty is already touched by makeHeaderBlock when it dirties the</span>
<a name="l06139"></a>06139     <span class="comment">// block it creates.</span>
<a name="l06140"></a>06140     this._dirtyHeaderBlocks[splinfo.blockId] = splock;
<a name="l06141"></a>06141 
<a name="l06142"></a>06142     <span class="keywordflow">return</span> olderInfo;
<a name="l06143"></a>06143   },
<a name="l06144"></a>06144 
<a name="l06150"></a>06150   _makeBodyBlock: <span class="keyword">function</span> ifs__makeBodyBlock(
<a name="l06151"></a>06151       startTS, startUID, endTS, endUID, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a6d7e27eaec1e5f6600e65858be43c18b">size</a>, <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>, bodies) {
<a name="l06152"></a>06152     var blockId = $a64.encodeInt(this._folderImpl.nextBodyBlock++),
<a name="l06153"></a>06153         blockInfo = {
<a name="l06154"></a>06154           blockId: blockId,
<a name="l06155"></a>06155           startTS: startTS,
<a name="l06156"></a>06156           startUID: startUID,
<a name="l06157"></a>06157           endTS: endTS,
<a name="l06158"></a>06158           endUID: endUID,
<a name="l06159"></a>06159           <a class="code" href="../../de/deb/jsdbgapi_8h.html#af811e5c0ef06b777b160f87806b7285e">count</a>: <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a> ? <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>.length : 0,
<a name="l06160"></a>06160           estSize: <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a6d7e27eaec1e5f6600e65858be43c18b">size</a> || 0,
<a name="l06161"></a>06161         },
<a name="l06162"></a>06162         block = {
<a name="l06163"></a>06163           <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>: <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a> || [],
<a name="l06164"></a>06164           bodies: bodies || {},
<a name="l06165"></a>06165         };
<a name="l06166"></a>06166     this._dirty = <span class="keyword">true</span>;
<a name="l06167"></a>06167     this._bodyBlocks[blockId] = block;
<a name="l06168"></a>06168     this._dirtyBodyBlocks[blockId] = block;
<a name="l06169"></a>06169 
<a name="l06170"></a>06170     <span class="keywordflow">if</span> (this._folderImpl.nextBodyBlock %
<a name="l06171"></a>06171           $sync.BLOCK_PURGE_EVERY_N_NEW_BODY_BLOCKS === 0 &amp;&amp;
<a name="l06172"></a>06172         !<span class="keyword">this</span>._messagePurgeScheduled) {
<a name="l06173"></a>06173       this._messagePurgeScheduled = <span class="keyword">true</span>;
<a name="l06174"></a>06174       this._account.scheduleMessagePurge(this.folderId);
<a name="l06175"></a>06175     }
<a name="l06176"></a>06176 
<a name="l06177"></a>06177     <span class="keywordflow">return</span> blockInfo;
<a name="l06178"></a>06178   },
<a name="l06179"></a>06179 
<a name="l06180"></a>06180   _insertBodyInBlock: <span class="keyword">function</span> ifs__insertBodyInBlock(body, <span class="keywordtype">id</span>, <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>, block) {
<a name="l06181"></a>06181     <span class="keyword">function</span> cmpBodyByID(aID, bID) {
<a name="l06182"></a>06182       var aDate = (aID === <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>) ? body.date : block.bodies[aID].date,
<a name="l06183"></a>06183           bDate = (bID === <span class="keywordtype">id</span>) ? body.date : block.bodies[bID].date,
<a name="l06184"></a>06184           d = bDate - aDate;
<a name="l06185"></a>06185       <span class="keywordflow">if</span> (d)
<a name="l06186"></a>06186         <span class="keywordflow">return</span> d;
<a name="l06187"></a>06187       d = bID - aID;
<a name="l06188"></a>06188       <span class="keywordflow">return</span> d;
<a name="l06189"></a>06189     }
<a name="l06190"></a>06190 
<a name="l06191"></a>06191     var idx = bsearchForInsert(block.ids, <span class="keywordtype">id</span>, cmpBodyByID);
<a name="l06192"></a>06192     block.ids.splice(idx, 0, <span class="keywordtype">id</span>);
<a name="l06193"></a>06193     block.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>] = body;
<a name="l06194"></a>06194     this._dirty = <span class="keyword">true</span>;
<a name="l06195"></a>06195     this._dirtyBodyBlocks[<a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.blockId] = block;
<a name="l06196"></a>06196     <span class="comment">// Insertion does not need to update start/end TS/UID because the calling</span>
<a name="l06197"></a>06197     <span class="comment">// logic is able to handle it.</span>
<a name="l06198"></a>06198   },
<a name="l06199"></a>06199 
<a name="l06200"></a>06200   _deleteBodyFromBlock: <span class="keyword">function</span> ifs__deleteBodyFromBlock(<span class="keywordtype">id</span>, <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>, block) {
<a name="l06201"></a>06201     <span class="comment">// - delete</span>
<a name="l06202"></a>06202     var idx = block.ids.indexOf(<span class="keywordtype">id</span>);
<a name="l06203"></a>06203     var body = block.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>];
<a name="l06204"></a>06204     <span class="keywordflow">if</span> (idx === -1 || !body) {
<a name="l06205"></a>06205       this._LOG.bodyBlockMissing(<span class="keywordtype">id</span>, idx, !!body);
<a name="l06206"></a>06206       <span class="keywordflow">return</span>;
<a name="l06207"></a>06207     }
<a name="l06208"></a>06208     block.ids.splice(idx, 1);
<a name="l06209"></a>06209     <span class="keyword">delete</span> block.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>];
<a name="l06210"></a>06210     <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.estSize -= body.size;
<a name="l06211"></a>06211     <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.count--;
<a name="l06212"></a>06212 
<a name="l06213"></a>06213     this._dirty = <span class="keyword">true</span>;
<a name="l06214"></a>06214     this._dirtyBodyBlocks[<a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.blockId] = block;
<a name="l06215"></a>06215 
<a name="l06216"></a>06216     <span class="comment">// - update endTS/endUID if necessary</span>
<a name="l06217"></a>06217     <span class="keywordflow">if</span> (idx === 0 &amp;&amp; <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.count) {
<a name="l06218"></a>06218       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.endUID = <span class="keywordtype">id</span> = block.ids[0];
<a name="l06219"></a>06219       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.endTS = block.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>].date;
<a name="l06220"></a>06220     }
<a name="l06221"></a>06221     <span class="comment">// - update startTS/startUID if necessary</span>
<a name="l06222"></a>06222     <span class="keywordflow">if</span> (idx === <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.count &amp;&amp; idx &gt; 0) {
<a name="l06223"></a>06223       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.startUID = <span class="keywordtype">id</span> = block.ids[idx - 1];
<a name="l06224"></a>06224       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.startTS = block.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>].date;
<a name="l06225"></a>06225     }
<a name="l06226"></a>06226   },
<a name="l06227"></a>06227 
<a name="l06235"></a>06235   _splitBodyBlock: <span class="keyword">function</span> ifs__splitBodyBlock(splinfo, splock,
<a name="l06236"></a>06236                                                 newerTargetBytes) {
<a name="l06237"></a>06237     <span class="comment">// Save off the start timestamp/uid; these may have been extended beyond the</span>
<a name="l06238"></a>06238     <span class="comment">// delimiting bodies because of the insertion triggering the split.  (At</span>
<a name="l06239"></a>06239     <span class="comment">// least if we start inserting after splitting again in the future.)</span>
<a name="l06240"></a>06240     var savedStartTS = splinfo.startTS, savedStartUID = splinfo.startUID;
<a name="l06241"></a>06241 
<a name="l06242"></a>06242     var newerBytes = 0, <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a> = splock.ids, newDict = {}, oldDict = {},
<a name="l06243"></a>06243         inNew = <span class="keyword">true</span>, numHeaders = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>, body,
<a name="l06244"></a>06244         idxLast = <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>.length - 1;
<a name="l06245"></a>06245     <span class="comment">// loop for new traversal; picking a split-point so that there is at least</span>
<a name="l06246"></a>06246     <span class="comment">// one item in each block.</span>
<a name="l06247"></a>06247     <span class="keywordflow">for</span> (i = 0; i &lt; idxLast; i++) {
<a name="l06248"></a>06248       <span class="keywordtype">id</span> = <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l06249"></a>06249       body = splock.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>];
<a name="l06250"></a>06250       newerBytes += body.size;
<a name="l06251"></a>06251       newDict[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>] = body;
<a name="l06252"></a>06252       <span class="keywordflow">if</span> (newerBytes &gt;= newerTargetBytes) {
<a name="l06253"></a>06253         i++;
<a name="l06254"></a>06254         <span class="keywordflow">break</span>;
<a name="l06255"></a>06255       }
<a name="l06256"></a>06256     }
<a name="l06257"></a>06257     <span class="comment">// mark the breakpoint; i is pointing at the first old-block message</span>
<a name="l06258"></a>06258     splinfo.count = numHeaders = <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l06259"></a>06259     <span class="comment">// and these values are from the last processed new-block message</span>
<a name="l06260"></a>06260     splinfo.startTS = body.date;
<a name="l06261"></a>06261     splinfo.startUID = <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>;
<a name="l06262"></a>06262     <span class="comment">// loop for old traversal</span>
<a name="l06263"></a>06263     <span class="keywordflow">for</span> (; i &lt; <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>.length; i++) {
<a name="l06264"></a>06264       <span class="keywordtype">id</span> = <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06265"></a>06265       oldDict[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>] = splock.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>];
<a name="l06266"></a>06266     }
<a name="l06267"></a>06267 
<a name="l06268"></a>06268     var oldEndUID = <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>[numHeaders];
<a name="l06269"></a>06269     var olderInfo = this._makeBodyBlock(
<a name="l06270"></a>06270       savedStartTS, savedStartUID,
<a name="l06271"></a>06271       oldDict[oldEndUID].<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, oldEndUID,
<a name="l06272"></a>06272       splinfo.estSize - newerBytes,
<a name="l06273"></a>06273       <span class="comment">// (the older block gets the uids the new/existing block does not want,</span>
<a name="l06274"></a>06274       <span class="comment">//  leaving `uids` containing only the d</span>
<a name="l06275"></a>06275       <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>.splice(numHeaders, <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>.length - numHeaders),
<a name="l06276"></a>06276       oldDict);
<a name="l06277"></a>06277     splinfo.estSize = newerBytes;
<a name="l06278"></a>06278     splock.bodies = newDict;
<a name="l06279"></a>06279     <span class="comment">// _makeBodyBlock dirties the block it creates and touches _dirty</span>
<a name="l06280"></a>06280     this._dirtyBodyBlocks[splinfo.blockId] = splock;
<a name="l06281"></a>06281 
<a name="l06282"></a>06282     <span class="keywordflow">return</span> olderInfo;
<a name="l06283"></a>06283   },
<a name="l06284"></a>06284 
<a name="l06297"></a>06297   flushExcessCachedBlocks: <span class="keyword">function</span>(debugLabel) {
<a name="l06298"></a>06298     var slices = this._slices;
<a name="l06299"></a>06299     <span class="keyword">function</span> blockIntersectsAnySlice(blockInfo) {
<a name="l06300"></a>06300       <span class="keywordflow">for</span> (var i = 0; i &lt; slices.length; i++) {
<a name="l06301"></a>06301         var <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a> = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06302"></a>06302         <span class="keywordflow">if</span> (tupleRangeIntersectsTupleRange(slice, blockInfo)) {
<a name="l06303"></a>06303           <span class="comment">// Here is some useful debug you can uncomment!</span>
<a name="l06304"></a>06304           <span class="comment">/*</span>
<a name="l06305"></a>06305 <span class="comment">          console.log(&#39;  slice intersect. slice:&#39;,</span>
<a name="l06306"></a>06306 <span class="comment">                      slice.startTS, slice.startUID,</span>
<a name="l06307"></a>06307 <span class="comment">                      slice.endTS, slice.endUID, &#39;  block:&#39;,</span>
<a name="l06308"></a>06308 <span class="comment">                      blockInfo.startTS, blockInfo.startUID,</span>
<a name="l06309"></a>06309 <span class="comment">                      blockInfo.endTS, blockInfo.endUID);</span>
<a name="l06310"></a>06310 <span class="comment">           */</span>
<a name="l06311"></a>06311           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l06312"></a>06312         }
<a name="l06313"></a>06313       }
<a name="l06314"></a>06314       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l06315"></a>06315     }
<a name="l06316"></a>06316     <span class="keyword">function</span> maybeDiscard(blockType, blockInfoList, loadedBlockInfos,
<a name="l06317"></a>06317                           blockMap, dirtyMap) {
<a name="l06318"></a>06318       <span class="comment">// console.warn(&#39;!! flushing&#39;, blockType, &#39;blocks because:&#39;, debugLabel);</span>
<a name="l06319"></a>06319       <span class="keywordflow">for</span> (var i = 0; i &lt; loadedBlockInfos.length; i++) {
<a name="l06320"></a>06320         var blockInfo = loadedBlockInfos[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06321"></a>06321         <span class="comment">// do not discard dirty blocks</span>
<a name="l06322"></a>06322         <span class="keywordflow">if</span> (dirtyMap.hasOwnProperty(blockInfo.blockId)) {
<a name="l06323"></a>06323           <span class="comment">// console.log(&#39;  dirty block:&#39;, blockInfo.blockId);</span>
<a name="l06324"></a>06324           <span class="keywordflow">continue</span>;
<a name="l06325"></a>06325         }
<a name="l06326"></a>06326         <span class="comment">// do not discard blocks that overlap mail slices</span>
<a name="l06327"></a>06327         <span class="keywordflow">if</span> (blockIntersectsAnySlice(blockInfo))
<a name="l06328"></a>06328           <span class="keywordflow">continue</span>;
<a name="l06329"></a>06329         <span class="comment">// console.log(&#39;discarding&#39;, blockType, &#39;block&#39;, blockInfo.blockId);</span>
<a name="l06330"></a>06330         <span class="keyword">delete</span> blockMap[blockInfo.blockId];
<a name="l06331"></a>06331         loadedBlockInfos.splice(i--, 1);
<a name="l06332"></a>06332       }
<a name="l06333"></a>06333     }
<a name="l06334"></a>06334 
<a name="l06335"></a>06335     maybeDiscard(
<a name="l06336"></a>06336       <span class="stringliteral">&#39;header&#39;</span>, this._headerBlockInfos, this._loadedHeaderBlockInfos,
<a name="l06337"></a>06337       this._headerBlocks, this._dirtyHeaderBlocks);
<a name="l06338"></a>06338     maybeDiscard(
<a name="l06339"></a>06339       <span class="stringliteral">&#39;body&#39;</span>, this._bodyBlockInfos, this._loadedBodyBlockInfos,
<a name="l06340"></a>06340       this._bodyBlocks, this._dirtyBodyBlocks);
<a name="l06341"></a>06341   },
<a name="l06342"></a>06342 
<a name="l06402"></a>06402   purgeExcessMessages: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l06403"></a>06403     this._messagePurgeScheduled = <span class="keyword">false</span>;
<a name="l06404"></a>06404     var cutTS = Math.max(
<a name="l06405"></a>06405       this._purge_findLastAccessCutPoint(),
<a name="l06406"></a>06406       this._purge_findHardBlockCutPoint(this._headerBlockInfos),
<a name="l06407"></a>06407       this._purge_findHardBlockCutPoint(this._bodyBlockInfos));
<a name="l06408"></a>06408 
<a name="l06409"></a>06409     <span class="keywordflow">if</span> (cutTS === 0) {
<a name="l06410"></a>06410       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(0, cutTS);
<a name="l06411"></a>06411       <span class="keywordflow">return</span>;
<a name="l06412"></a>06412     }
<a name="l06413"></a>06413 
<a name="l06414"></a>06414     <span class="comment">// Quantize to the subsequent UTC midnight, then apply the timezone</span>
<a name="l06415"></a>06415     <span class="comment">// adjustment that is what our IMAP database lookup does to account for</span>
<a name="l06416"></a>06416     <span class="comment">// skew.  (See `ImapFolderConn.syncDateRange`)</span>
<a name="l06417"></a>06417     cutTS = quantizeDate(cutTS + DAY_MILLIS) - this._account.tzOffset;
<a name="l06418"></a>06418 
<a name="l06419"></a>06419     <span class="comment">// Update the accuracy ranges by nuking accuracy ranges that are no longer</span>
<a name="l06420"></a>06420     <span class="comment">// relevant and updating any overlapped range.</span>
<a name="l06421"></a>06421     var aranges = this._accuracyRanges;
<a name="l06422"></a>06422     var splitInfo = this._findFirstObjIndexForDateRange(aranges, cutTS, cutTS);
<a name="l06423"></a>06423     <span class="comment">// we only need to update a range if there was in fact some overlap.</span>
<a name="l06424"></a>06424     <span class="keywordflow">if</span> (splitInfo[1]) {
<a name="l06425"></a>06425       splitInfo[1].startTS = cutTS;
<a name="l06426"></a>06426       <span class="comment">// then be sure not to splice ourselves...</span>
<a name="l06427"></a>06427       aranges.splice(splitInfo[0] + 1, aranges.length - splitInfo[0]);
<a name="l06428"></a>06428     }
<a name="l06429"></a>06429     <span class="keywordflow">else</span> {
<a name="l06430"></a>06430       <span class="comment">// do splice things at/after</span>
<a name="l06431"></a>06431       aranges.splice(splitInfo[0], aranges.length - splitInfo[0]);
<a name="l06432"></a>06432     }
<a name="l06433"></a>06433 
<a name="l06434"></a>06434     var headerBlockInfos = this._headerBlockInfos,
<a name="l06435"></a>06435         headerBlocks = this._headerBlocks,
<a name="l06436"></a>06436         deletionCount = 0,
<a name="l06437"></a>06437         <span class="comment">// These variables let us detect if the deletion happened fully</span>
<a name="l06438"></a>06438         <span class="comment">// synchronously and thereby avoid blowing up the stack.</span>
<a name="l06439"></a>06439         callActive = <span class="keyword">false</span>, deleteTriggered = <span class="keyword">false</span>;
<a name="l06440"></a>06440     var deleteNextHeader = <span class="keyword">function</span>() {
<a name="l06441"></a>06441       <span class="comment">// if things are happening synchronously, bail out</span>
<a name="l06442"></a>06442       <span class="keywordflow">if</span> (callActive) {
<a name="l06443"></a>06443         deleteTriggered = <span class="keyword">true</span>;
<a name="l06444"></a>06444         <span class="keywordflow">return</span>;
<a name="l06445"></a>06445       }
<a name="l06446"></a>06446 
<a name="l06447"></a>06447       <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l06448"></a>06448         <span class="comment">// - bail if we ran out of blocks somehow</span>
<a name="l06449"></a>06449         <span class="keywordflow">if</span> (!headerBlockInfos.length) {
<a name="l06450"></a>06450           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(deletionCount, cutTS);
<a name="l06451"></a>06451           <span class="keywordflow">return</span>;
<a name="l06452"></a>06452         }
<a name="l06453"></a>06453         <span class="comment">// - load the last header block if not currently loaded</span>
<a name="l06454"></a>06454         var blockInfo = headerBlockInfos[headerBlockInfos.length - 1];
<a name="l06455"></a>06455         <span class="keywordflow">if</span> (!this._headerBlocks.hasOwnProperty(blockInfo.blockId)) {
<a name="l06456"></a>06456           this._loadBlock(<span class="stringliteral">&#39;header&#39;</span>, blockInfo, deleteNextHeader);
<a name="l06457"></a>06457           <span class="keywordflow">return</span>;
<a name="l06458"></a>06458         }
<a name="l06459"></a>06459         <span class="comment">// - get the last header, check it</span>
<a name="l06460"></a>06460         var headerBlock = this._headerBlocks[blockInfo.blockId],
<a name="l06461"></a>06461             lastHeader = headerBlock.headers[headerBlock.headers.length - 1];
<a name="l06462"></a>06462         <span class="keywordflow">if</span> (SINCE(lastHeader.date, cutTS)) {
<a name="l06463"></a>06463           <span class="comment">// all done! header is more recent than the cut date</span>
<a name="l06464"></a>06464           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(deletionCount, cutTS);
<a name="l06465"></a>06465           <span class="keywordflow">return</span>;
<a name="l06466"></a>06466         }
<a name="l06467"></a>06467         deleteTriggered = <span class="keyword">false</span>;
<a name="l06468"></a>06468         callActive = <span class="keyword">true</span>;
<a name="l06469"></a>06469         deletionCount++;
<a name="l06470"></a>06470         this.deleteMessageHeaderAndBodyUsingHeader(lastHeader,
<a name="l06471"></a>06471                                                    deleteNextHeader);
<a name="l06472"></a>06472         callActive = <span class="keyword">false</span>;
<a name="l06473"></a>06473         <span class="keywordflow">if</span> (!deleteTriggered)
<a name="l06474"></a>06474           <span class="keywordflow">return</span>;
<a name="l06475"></a>06475       }
<a name="l06476"></a>06476     }.bind(<span class="keyword">this</span>);
<a name="l06477"></a>06477     deleteNextHeader();
<a name="l06478"></a>06478   },
<a name="l06479"></a>06479 
<a name="l06480"></a>06480   _purge_findLastAccessCutPoint: <span class="keyword">function</span>() {
<a name="l06481"></a>06481     var aranges = this._accuracyRanges,
<a name="l06482"></a>06482         cutoffDate = $date.NOW() - $sync.BLOCK_PURGE_ONLY_AFTER_UNSYNCED_MS;
<a name="l06483"></a>06483     <span class="comment">// When the loop terminates, this is the block we should use to cut, so</span>
<a name="l06484"></a>06484     <span class="comment">// start with an invalid value.</span>
<a name="l06485"></a>06485     var iCutRange;
<a name="l06486"></a>06486     <span class="keywordflow">for</span> (iCutRange = aranges.length; iCutRange &gt;= 1; iCutRange--) {
<a name="l06487"></a>06487       var arange = aranges[iCutRange - 1];
<a name="l06488"></a>06488       <span class="comment">// We can destroy things that aren&#39;t fully synchronized.</span>
<a name="l06489"></a>06489       <span class="comment">// NB: this case was intended for search-on-server which is not yet</span>
<a name="l06490"></a>06490       <span class="comment">// implemented.</span>
<a name="l06491"></a>06491       <span class="keywordflow">if</span> (!arange.fullSync)
<a name="l06492"></a>06492         <span class="keywordflow">continue</span>;
<a name="l06493"></a>06493       <span class="keywordflow">if</span> (arange.fullSync.updated &gt; cutoffDate)
<a name="l06494"></a>06494         <span class="keywordflow">break</span>;
<a name="l06495"></a>06495     }
<a name="l06496"></a>06496     <span class="keywordflow">if</span> (iCutRange === aranges.length)
<a name="l06497"></a>06497       <span class="keywordflow">return</span> 0;
<a name="l06498"></a>06498 
<a name="l06499"></a>06499     var cutTS = aranges[iCutRange].endTS,
<a name="l06500"></a>06500         syncRangeMS = $sync.SYNC_RANGE_ENUMS_TO_MS[
<a name="l06501"></a>06501                         this._account.accountDef.syncRange] ||
<a name="l06502"></a>06502                       $sync.SYNC_RANGE_ENUMS_TO_MS[<span class="stringliteral">&#39;auto&#39;</span>],
<a name="l06503"></a>06503         <span class="comment">// Determine the sync horizon, but then subtract an extra day off so</span>
<a name="l06504"></a>06504         <span class="comment">// that the quantization does not take a bite out of the sync range</span>
<a name="l06505"></a>06505         syncHorizonTS = $date.NOW() - syncRangeMS - DAY_MILLIS;
<a name="l06506"></a>06506 
<a name="l06507"></a>06507     <span class="comment">// If the proposed cut is more recent than our sync horizon, use the sync</span>
<a name="l06508"></a>06508     <span class="comment">// horizon.</span>
<a name="l06509"></a>06509     <span class="keywordflow">if</span> (STRICTLY_AFTER(cutTS, syncHorizonTS))
<a name="l06510"></a>06510       <span class="keywordflow">return</span> syncHorizonTS;
<a name="l06511"></a>06511     <span class="keywordflow">return</span> cutTS;
<a name="l06512"></a>06512   },
<a name="l06513"></a>06513 
<a name="l06514"></a>06514   _purge_findHardBlockCutPoint: <span class="keyword">function</span>(blockInfoList) {
<a name="l06515"></a>06515     <span class="keywordflow">if</span> (blockInfoList.length &lt;= $sync.BLOCK_PURGE_HARD_MAX_BLOCK_LIMIT)
<a name="l06516"></a>06516       <span class="keywordflow">return</span> 0;
<a name="l06517"></a>06517     <span class="keywordflow">return</span> blockInfoList[$sync.BLOCK_PURGE_HARD_MAX_BLOCK_LIMIT].startTS;
<a name="l06518"></a>06518   },
<a name="l06519"></a>06519 
<a name="l06533"></a>06533   _findRangeObjIndexForDate: <span class="keyword">function</span> ifs__findRangeObjIndexForDate(
<a name="l06534"></a>06534       <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>) {
<a name="l06535"></a>06535     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l06536"></a>06536     <span class="comment">// linear scan for now; binary search later</span>
<a name="l06537"></a>06537     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length; i++) {
<a name="l06538"></a>06538       var <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a> = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06539"></a>06539       <span class="comment">// - Stop if we will never find a match if we keep going.</span>
<a name="l06540"></a>06540       <span class="comment">// If our date is after the end of this range, then it will never fall</span>
<a name="l06541"></a>06541       <span class="comment">// inside any subsequent ranges, because they are all chronologically</span>
<a name="l06542"></a>06542       <span class="comment">// earlier than this range.</span>
<a name="l06543"></a>06543       <span class="keywordflow">if</span> (SINCE(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, info.endTS))
<a name="l06544"></a>06544         <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06545"></a>06545       <span class="comment">// therefore BEFORE(date, info.endTS)</span>
<a name="l06546"></a>06546 
<a name="l06547"></a>06547       <span class="keywordflow">if</span> (SINCE(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, info.startTS))
<a name="l06548"></a>06548         <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>];
<a name="l06549"></a>06549       <span class="comment">// (Older than the startTS, keep going.)</span>
<a name="l06550"></a>06550     }
<a name="l06551"></a>06551 
<a name="l06552"></a>06552     <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06553"></a>06553   },
<a name="l06554"></a>06554 
<a name="l06568"></a>06568   _findRangeObjIndexForDateAndID: <span class="keyword">function</span> ifs__findRangeObjIndexForDateAndID(
<a name="l06569"></a>06569       <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, uid) {
<a name="l06570"></a>06570     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l06571"></a>06571     <span class="comment">// linear scan for now; binary search later</span>
<a name="l06572"></a>06572     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length; i++) {
<a name="l06573"></a>06573       var info = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06574"></a>06574       <span class="comment">// - Stop if we will never find a match if we keep going.</span>
<a name="l06575"></a>06575       <span class="comment">// If our date is after the end of this range, then it will never fall</span>
<a name="l06576"></a>06576       <span class="comment">// inside any subsequent ranges, because they are all chronologically</span>
<a name="l06577"></a>06577       <span class="comment">// earlier than this range.</span>
<a name="l06578"></a>06578       <span class="comment">// If our date is the same and our UID is higher, then likewise we</span>
<a name="l06579"></a>06579       <span class="comment">// shouldn&#39;t go further because IDs decrease too.</span>
<a name="l06580"></a>06580       <span class="keywordflow">if</span> (STRICTLY_AFTER(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, info.endTS) ||
<a name="l06581"></a>06581           (<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> === info.endTS &amp;&amp; uid &gt; info.endUID))
<a name="l06582"></a>06582         <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06583"></a>06583       <span class="comment">// therefore BEFORE(date, info.endTS) ||</span>
<a name="l06584"></a>06584       <span class="comment">//           (date === info.endTS &amp;&amp; uid &lt;= info.endUID)</span>
<a name="l06585"></a>06585       <span class="keywordflow">if</span> (STRICTLY_AFTER(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, info.startTS) ||
<a name="l06586"></a>06586           (<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> === info.startTS &amp;&amp; uid &gt;= info.startUID))
<a name="l06587"></a>06587         <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>];
<a name="l06588"></a>06588       <span class="comment">// (Older than the startTS, keep going.)</span>
<a name="l06589"></a>06589     }
<a name="l06590"></a>06590 
<a name="l06591"></a>06591     <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06592"></a>06592   },
<a name="l06593"></a>06593 
<a name="l06594"></a>06594 
<a name="l06600"></a>06600   _findFirstObjIndexForDateRange: <span class="keyword">function</span> ifs__findFirstObjIndexForDateRange(
<a name="l06601"></a>06601       <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, startTS, endTS) {
<a name="l06602"></a>06602     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l06603"></a>06603     <span class="comment">// linear scan for now; binary search later</span>
<a name="l06604"></a>06604     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length; i++) {
<a name="l06605"></a>06605       var info = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06606"></a>06606       <span class="comment">// - Stop if we will never find a match if we keep going.</span>
<a name="l06607"></a>06607       <span class="comment">// If our comparison range starts AFTER the end of this range, then it</span>
<a name="l06608"></a>06608       <span class="comment">// does not overlap this range and will never overlap any subsequent</span>
<a name="l06609"></a>06609       <span class="comment">// ranges because they are all chronologically earlier than this range.</span>
<a name="l06610"></a>06610       <span class="comment">//</span>
<a name="l06611"></a>06611       <span class="comment">// nb: We are saying that there is no overlap if one range starts where</span>
<a name="l06612"></a>06612       <span class="comment">// the other one ends.  This is consistent with the inclusive/exclusive</span>
<a name="l06613"></a>06613       <span class="comment">// definition of since/before and our ranges.</span>
<a name="l06614"></a>06614       <span class="keywordflow">if</span> (STRICTLY_AFTER(startTS, info.endTS))
<a name="l06615"></a>06615         <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06616"></a>06616       <span class="comment">// therefore ON_OR_BEFORE(startTS, info.endTS)</span>
<a name="l06617"></a>06617 
<a name="l06618"></a>06618       <span class="comment">// nb: SINCE(endTS, info.startTS) is not right here because the equals</span>
<a name="l06619"></a>06619       <span class="comment">// case does not result in overlap because endTS is exclusive.</span>
<a name="l06620"></a>06620       <span class="keywordflow">if</span> (endTS === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> || STRICTLY_AFTER(endTS, info.startTS))
<a name="l06621"></a>06621         <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>];
<a name="l06622"></a>06622       <span class="comment">// (no overlap yet)</span>
<a name="l06623"></a>06623     }
<a name="l06624"></a>06624 
<a name="l06625"></a>06625     <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06626"></a>06626   },
<a name="l06627"></a>06627 
<a name="l06632"></a>06632   _findLastObjIndexForDateRange: <span class="keyword">function</span> ifs__findLastObjIndexForDateRange(
<a name="l06633"></a>06633       <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, startTS, endTS) {
<a name="l06634"></a>06634     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l06635"></a>06635     <span class="comment">// linear scan for now; binary search later</span>
<a name="l06636"></a>06636     <span class="keywordflow">for</span> (i = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length - 1; i &gt;= 0; i--) {
<a name="l06637"></a>06637       var info = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06638"></a>06638       <span class="comment">// - Stop if we will never find a match if we keep going.</span>
<a name="l06639"></a>06639       <span class="comment">// If our comparison range ends ON OR BEFORE the end of this range, then</span>
<a name="l06640"></a>06640       <span class="comment">// it does not overlap this range and will never overlap any subsequent</span>
<a name="l06641"></a>06641       <span class="comment">// ranges because they are all chronologically later than this range.</span>
<a name="l06642"></a>06642       <span class="comment">//</span>
<a name="l06643"></a>06643       <span class="comment">// nb: We are saying that there is no overlap if one range starts where</span>
<a name="l06644"></a>06644       <span class="comment">// the other one ends.  This is consistent with the inclusive/exclusive</span>
<a name="l06645"></a>06645       <span class="comment">// definition of since/before and our ranges.</span>
<a name="l06646"></a>06646       <span class="keywordflow">if</span> (ON_OR_BEFORE(endTS, info.startTS))
<a name="l06647"></a>06647         <span class="keywordflow">return</span> [i + 1, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06648"></a>06648       <span class="comment">// therefore STRICTLY_AFTER(endTS, info.startTS)</span>
<a name="l06649"></a>06649 
<a name="l06650"></a>06650       <span class="comment">// we match in this entry if the start stamp is before the range&#39;s end</span>
<a name="l06651"></a>06651       <span class="keywordflow">if</span> (BEFORE(startTS, info.endTS))
<a name="l06652"></a>06652         <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>];
<a name="l06653"></a>06653 
<a name="l06654"></a>06654       <span class="comment">// (no overlap yet)</span>
<a name="l06655"></a>06655     }
<a name="l06656"></a>06656 
<a name="l06657"></a>06657     <span class="keywordflow">return</span> [0, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06658"></a>06658   },
<a name="l06659"></a>06659 
<a name="l06660"></a>06660 
<a name="l06666"></a>06666   _findFirstObjForDateRange: <span class="keyword">function</span> ifs__findFirstObjForDateRange(
<a name="l06667"></a>06667       <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, startTS, endTS) {
<a name="l06668"></a>06668     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l06669"></a>06669     var dateComparator = endTS === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> ? SINCE : IN_BS_DATE_RANGE;
<a name="l06670"></a>06670     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length; i++) {
<a name="l06671"></a>06671       var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].date;
<a name="l06672"></a>06672       <span class="keywordflow">if</span> (dateComparator(date, startTS, endTS))
<a name="l06673"></a>06673         <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]];
<a name="l06674"></a>06674     }
<a name="l06675"></a>06675     <span class="keywordflow">return</span> [<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>];
<a name="l06676"></a>06676   },
<a name="l06677"></a>06677 
<a name="l06748"></a>06748   _insertIntoBlockUsingDateAndUID: <span class="keyword">function</span> ifs__pickInsertionBlocks(
<a name="l06749"></a>06749       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, date, uid, srvid, estSizeCost, <a class="code" href="../../d2/d7d/jsapi_8h.html#a0ae46d903d137443f5781a6d9d2a1593">thing</a>, blockPickedCallback) {
<a name="l06750"></a>06750     var blockInfoList, loadedBlockInfoList, blockMap, makeBlock, insertInBlock,
<a name="l06751"></a>06751         splitBlock, serverIdBlockMapping;
<a name="l06752"></a>06752     <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;header&#39;</span>) {
<a name="l06753"></a>06753       blockInfoList = this._headerBlockInfos;
<a name="l06754"></a>06754       loadedBlockInfoList = this._loadedHeaderBlockInfos;
<a name="l06755"></a>06755       blockMap = this._headerBlocks;
<a name="l06756"></a>06756       serverIdBlockMapping = this._serverIdHeaderBlockMapping;
<a name="l06757"></a>06757       makeBlock = this._bound_makeHeaderBlock;
<a name="l06758"></a>06758       insertInBlock = this._bound_insertHeaderInBlock;
<a name="l06759"></a>06759       splitBlock = this._bound_splitHeaderBlock;
<a name="l06760"></a>06760     }
<a name="l06761"></a>06761     <span class="keywordflow">else</span> {
<a name="l06762"></a>06762       blockInfoList = this._bodyBlockInfos;
<a name="l06763"></a>06763       loadedBlockInfoList = this._loadedBodyBlockInfos;
<a name="l06764"></a>06764       blockMap = this._bodyBlocks;
<a name="l06765"></a>06765       serverIdBlockMapping = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>; <span class="comment">// only headers have the mapping</span>
<a name="l06766"></a>06766       makeBlock = this._bound_makeBodyBlock;
<a name="l06767"></a>06767       insertInBlock = this._bound_insertBodyInBlock;
<a name="l06768"></a>06768       splitBlock = this._bound_splitBodyBlock;
<a name="l06769"></a>06769     }
<a name="l06770"></a>06770 
<a name="l06771"></a>06771     <span class="comment">// -- find the current containing block / insertion point</span>
<a name="l06772"></a>06772     var infoTuple = this._findRangeObjIndexForDateAndID(blockInfoList,
<a name="l06773"></a>06773                                                         date, uid),
<a name="l06774"></a>06774         iInfo = infoTuple[0], info = infoTuple[1];
<a name="l06775"></a>06775 
<a name="l06776"></a>06776     <span class="comment">// -- not in a block, find or create one</span>
<a name="l06777"></a>06777     <span class="keywordflow">if</span> (!info) {
<a name="l06778"></a>06778       <span class="comment">// - Create a block if no blocks exist at all.</span>
<a name="l06779"></a>06779       <span class="keywordflow">if</span> (blockInfoList.length === 0) {
<a name="l06780"></a>06780         info = makeBlock(date, uid, date, uid);
<a name="l06781"></a>06781         blockInfoList.splice(iInfo, 0, info);
<a name="l06782"></a>06782         loadedBlockInfoList.push(info);
<a name="l06783"></a>06783       }
<a name="l06784"></a>06784       <span class="comment">// - Is there a trailing/older dude and we fit?</span>
<a name="l06785"></a>06785       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iInfo &lt; blockInfoList.length &amp;&amp;
<a name="l06786"></a>06786                blockInfoList[iInfo].estSize + estSizeCost &lt; MAX_BLOCK_SIZE) {
<a name="l06787"></a>06787         info = blockInfoList[iInfo];
<a name="l06788"></a>06788 
<a name="l06789"></a>06789         <span class="comment">// We are chronologically/UID-ically more recent, so check the end range</span>
<a name="l06790"></a>06790         <span class="comment">// for expansion needs.</span>
<a name="l06791"></a>06791         <span class="keywordflow">if</span> (STRICTLY_AFTER(date, info.endTS)) {
<a name="l06792"></a>06792           info.endTS = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>;
<a name="l06793"></a>06793           info.endUID = uid;
<a name="l06794"></a>06794         }
<a name="l06795"></a>06795         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (date === info.endTS &amp;&amp;
<a name="l06796"></a>06796                  uid &gt; info.endUID) {
<a name="l06797"></a>06797           info.endUID = uid;
<a name="l06798"></a>06798         }
<a name="l06799"></a>06799       }
<a name="l06800"></a>06800       <span class="comment">// - Is there a preceding/younger dude and we fit?</span>
<a name="l06801"></a>06801       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iInfo &gt; 0 &amp;&amp;
<a name="l06802"></a>06802                blockInfoList[iInfo - 1].estSize + estSizeCost &lt; MAX_BLOCK_SIZE){
<a name="l06803"></a>06803         info = blockInfoList[--iInfo];
<a name="l06804"></a>06804 
<a name="l06805"></a>06805         <span class="comment">// We are chronologically less recent, so check the start range for</span>
<a name="l06806"></a>06806         <span class="comment">// expansion needs.</span>
<a name="l06807"></a>06807         <span class="keywordflow">if</span> (BEFORE(date, info.startTS)) {
<a name="l06808"></a>06808           info.startTS = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>;
<a name="l06809"></a>06809           info.startUID = uid;
<a name="l06810"></a>06810         }
<a name="l06811"></a>06811         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (date === info.startTS &amp;&amp;
<a name="l06812"></a>06812                  uid &lt; info.startUID) {
<a name="l06813"></a>06813           info.startUID = uid;
<a name="l06814"></a>06814         }
<a name="l06815"></a>06815       }
<a name="l06816"></a>06816       <span class="comment">// Any adjacent blocks at this point are overflowing, so it&#39;s now a</span>
<a name="l06817"></a>06817       <span class="comment">// question of who to split.  We pick the one further from the center that</span>
<a name="l06818"></a>06818       <span class="comment">// exists.</span>
<a name="l06819"></a>06819       <span class="comment">// - Preceding (if possible and) suitable OR the only choice</span>
<a name="l06820"></a>06820       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((iInfo &gt; 0 &amp;&amp; iInfo &lt; blockInfoList.length / 2) ||
<a name="l06821"></a>06821                (iInfo === blockInfoList.length)) {
<a name="l06822"></a>06822         info = blockInfoList[--iInfo];
<a name="l06823"></a>06823         <span class="comment">// We are chronologically less recent, so check the start range for</span>
<a name="l06824"></a>06824         <span class="comment">// expansion needs.</span>
<a name="l06825"></a>06825         <span class="keywordflow">if</span> (BEFORE(date, info.startTS)) {
<a name="l06826"></a>06826           info.startTS = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>;
<a name="l06827"></a>06827           info.startUID = uid;
<a name="l06828"></a>06828         }
<a name="l06829"></a>06829         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (date === info.startTS &amp;&amp;
<a name="l06830"></a>06830                  uid &lt; info.startUID) {
<a name="l06831"></a>06831           info.startUID = uid;
<a name="l06832"></a>06832         }
<a name="l06833"></a>06833       }
<a name="l06834"></a>06834       <span class="comment">// - It must be the trailing dude</span>
<a name="l06835"></a>06835       <span class="keywordflow">else</span> {
<a name="l06836"></a>06836         info = blockInfoList[iInfo];
<a name="l06837"></a>06837         <span class="comment">// We are chronologically/UID-ically more recent, so check the end range</span>
<a name="l06838"></a>06838         <span class="comment">// for expansion needs.</span>
<a name="l06839"></a>06839         <span class="keywordflow">if</span> (STRICTLY_AFTER(date, info.endTS)) {
<a name="l06840"></a>06840           info.endTS = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>;
<a name="l06841"></a>06841           info.endUID = uid;
<a name="l06842"></a>06842         }
<a name="l06843"></a>06843         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (date === info.endTS &amp;&amp;
<a name="l06844"></a>06844                  uid &gt; info.endUID) {
<a name="l06845"></a>06845           info.endUID = uid;
<a name="l06846"></a>06846         }
<a name="l06847"></a>06847       }
<a name="l06848"></a>06848     }
<a name="l06849"></a>06849     <span class="comment">// (info now definitely exists and is definitely in blockInfoList)</span>
<a name="l06850"></a>06850 
<a name="l06851"></a>06851     <span class="keyword">function</span> processBlock(block) { <span class="comment">// &#39;this&#39; gets explicitly bound</span>
<a name="l06852"></a>06852       <span class="comment">// -- perform the insertion</span>
<a name="l06853"></a>06853       <span class="comment">// We could do this after the split, but this makes things simpler if</span>
<a name="l06854"></a>06854       <span class="comment">// we want to factor in the newly inserted thing&#39;s size in the</span>
<a name="l06855"></a>06855       <span class="comment">// distribution of bytes.</span>
<a name="l06856"></a>06856       info.estSize += estSizeCost;
<a name="l06857"></a>06857       info.count++;
<a name="l06858"></a>06858       insertInBlock(<a class="code" href="../../d2/d7d/jsapi_8h.html#a0ae46d903d137443f5781a6d9d2a1593">thing</a>, uid, info, block);
<a name="l06859"></a>06859 
<a name="l06860"></a>06860       <span class="comment">// -- split if necessary</span>
<a name="l06861"></a>06861       <span class="keywordflow">if</span> (info.count &gt; 1 &amp;&amp; info.estSize &gt;= MAX_BLOCK_SIZE) {
<a name="l06862"></a>06862         <span class="comment">// - figure the desired resulting sizes</span>
<a name="l06863"></a>06863         var firstBlockTarget;
<a name="l06864"></a>06864         <span class="comment">// big part to the center at the edges (favoring front edge)</span>
<a name="l06865"></a>06865         <span class="keywordflow">if</span> (iInfo === 0)
<a name="l06866"></a>06866           firstBlockTarget = BLOCK_SPLIT_SMALL_PART;
<a name="l06867"></a>06867         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iInfo === blockInfoList.length - 1)
<a name="l06868"></a>06868           firstBlockTarget = BLOCK_SPLIT_LARGE_PART;
<a name="l06869"></a>06869         <span class="comment">// otherwise equal split</span>
<a name="l06870"></a>06870         <span class="keywordflow">else</span>
<a name="l06871"></a>06871           firstBlockTarget = BLOCK_SPLIT_EQUAL_PART;
<a name="l06872"></a>06872 
<a name="l06873"></a>06873 
<a name="l06874"></a>06874         <span class="comment">// - split</span>
<a name="l06875"></a>06875         var olderInfo;
<a name="l06876"></a>06876         olderInfo = splitBlock(info, block, firstBlockTarget);
<a name="l06877"></a>06877         blockInfoList.splice(iInfo + 1, 0, olderInfo);
<a name="l06878"></a>06878         loadedBlockInfoList.push(olderInfo);
<a name="l06879"></a>06879 
<a name="l06880"></a>06880         <span class="comment">// - figure which of the blocks our insertion went in</span>
<a name="l06881"></a>06881         <span class="keywordflow">if</span> (BEFORE(date, olderInfo.endTS) ||
<a name="l06882"></a>06882             ((date === olderInfo.endTS) &amp;&amp; (uid &lt;= olderInfo.endUID))) {
<a name="l06883"></a>06883           iInfo++;
<a name="l06884"></a>06884           info = olderInfo;
<a name="l06885"></a>06885           block = blockMap[info.blockId];
<a name="l06886"></a>06886         }
<a name="l06887"></a>06887       }
<a name="l06888"></a>06888       <span class="comment">// otherwise, no split necessary, just use it</span>
<a name="l06889"></a>06889       <span class="keywordflow">if</span> (serverIdBlockMapping &amp;&amp; srvid)
<a name="l06890"></a>06890         serverIdBlockMapping[srvid] = info.blockId;
<a name="l06891"></a>06891 
<a name="l06892"></a>06892       <span class="keywordflow">if</span> (blockPickedCallback) {
<a name="l06893"></a>06893         blockPickedCallback(info, block);
<a name="l06894"></a>06894       }
<a name="l06895"></a>06895     }
<a name="l06896"></a>06896 
<a name="l06897"></a>06897     <span class="keywordflow">if</span> (blockMap.hasOwnProperty(info.blockId))
<a name="l06898"></a>06898       processBlock.call(<span class="keyword">this</span>, blockMap[info.blockId]);
<a name="l06899"></a>06899     <span class="keywordflow">else</span>
<a name="l06900"></a>06900       this._loadBlock(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, info, processBlock.bind(<span class="keyword">this</span>));
<a name="l06901"></a>06901   },
<a name="l06902"></a>06902 
<a name="l06903"></a>06903   runAfterDeferredCalls: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l06904"></a>06904     <span class="keywordflow">if</span> (this._deferredCalls.length)
<a name="l06905"></a>06905       this._deferredCalls.push(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l06906"></a>06906     <span class="keywordflow">else</span>
<a name="l06907"></a>06907       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l06908"></a>06908   },
<a name="l06909"></a>06909 
<a name="l06914"></a>06914   _runDeferredCalls: <span class="keyword">function</span> ifs__runDeferredCalls() {
<a name="l06915"></a>06915     <span class="keywordflow">while</span> (this._deferredCalls.length &amp;&amp; <span class="keyword">this</span>._pendingLoads.length === 0) {
<a name="l06916"></a>06916       var toCall = this._deferredCalls.shift();
<a name="l06917"></a>06917       <span class="keywordflow">try</span> {
<a name="l06918"></a>06918         toCall();
<a name="l06919"></a>06919       }
<a name="l06920"></a>06920       <span class="keywordflow">catch</span> (ex) {
<a name="l06921"></a>06921         this._LOG.callbackErr(ex);
<a name="l06922"></a>06922       }
<a name="l06923"></a>06923     }
<a name="l06924"></a>06924   },
<a name="l06925"></a>06925 
<a name="l06926"></a>06926   _findBlockInfoFromBlockId: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, blockId) {
<a name="l06927"></a>06927     var blockInfoList;
<a name="l06928"></a>06928     <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;header&#39;</span>)
<a name="l06929"></a>06929       blockInfoList = this._headerBlockInfos;
<a name="l06930"></a>06930     <span class="keywordflow">else</span>
<a name="l06931"></a>06931       blockInfoList = this._bodyBlockInfos;
<a name="l06932"></a>06932 
<a name="l06933"></a>06933     <span class="keywordflow">for</span> (var i = 0; i &lt; blockInfoList.length; i++) {
<a name="l06934"></a>06934       var blockInfo = blockInfoList[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06935"></a>06935       <span class="keywordflow">if</span> (blockInfo.blockId === blockId)
<a name="l06936"></a>06936         <span class="keywordflow">return</span> blockInfo;
<a name="l06937"></a>06937     }
<a name="l06938"></a>06938     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l06939"></a>06939   },
<a name="l06940"></a>06940 
<a name="l06945"></a>06945   _loadBlock: <span class="keyword">function</span> ifs__loadBlock(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, blockInfo, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l06946"></a>06946     var blockId = blockInfo.blockId;
<a name="l06947"></a>06947     var aggrId = <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> + blockId;
<a name="l06948"></a>06948     <span class="keywordflow">if</span> (this._pendingLoads.indexOf(aggrId) !== -1) {
<a name="l06949"></a>06949       this._pendingLoadListeners[aggrId].push(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l06950"></a>06950       <span class="keywordflow">return</span>;
<a name="l06951"></a>06951     }
<a name="l06952"></a>06952 
<a name="l06953"></a>06953     var <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> = this._pendingLoads.length;
<a name="l06954"></a>06954     this._pendingLoads.push(aggrId);
<a name="l06955"></a>06955     this._pendingLoadListeners[aggrId] = [<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>];
<a name="l06956"></a>06956 
<a name="l06957"></a>06957     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l06958"></a>06958     <span class="keyword">function</span> onLoaded(block) {
<a name="l06959"></a>06959       <span class="keywordflow">if</span> (!block)
<a name="l06960"></a>06960         <span class="keyword">self</span>._LOG.badBlockLoad(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, blockId);
<a name="l06961"></a>06961       <span class="keyword">self</span>._LOG.loadBlock_end(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, blockId, block);
<a name="l06962"></a>06962       <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;header&#39;</span>) {
<a name="l06963"></a>06963         <span class="keyword">self</span>._headerBlocks[blockId] = block;
<a name="l06964"></a>06964         <span class="keyword">self</span>._loadedHeaderBlockInfos.push(blockInfo);
<a name="l06965"></a>06965       }
<a name="l06966"></a>06966       <span class="keywordflow">else</span> {
<a name="l06967"></a>06967         <span class="keyword">self</span>._bodyBlocks[blockId] = block;
<a name="l06968"></a>06968         <span class="keyword">self</span>._loadedBodyBlockInfos.push(blockInfo);
<a name="l06969"></a>06969       }
<a name="l06970"></a>06970       <span class="keyword">self</span>._pendingLoads.splice(<span class="keyword">self</span>._pendingLoads.indexOf(aggrId), 1);
<a name="l06971"></a>06971       var <a class="code" href="../../de/dfc/events_8js.html#aefbed4536fb9e73c5a626949dcbffbf4">listeners</a> = <span class="keyword">self</span>._pendingLoadListeners[aggrId];
<a name="l06972"></a>06972       <span class="keyword">delete</span> <span class="keyword">self</span>._pendingLoadListeners[aggrId];
<a name="l06973"></a>06973       <span class="keywordflow">for</span> (var i = 0; i &lt; listeners.length; i++) {
<a name="l06974"></a>06974         <span class="keywordflow">try</span> {
<a name="l06975"></a>06975           listeners[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>](block);
<a name="l06976"></a>06976         }
<a name="l06977"></a>06977         <span class="keywordflow">catch</span> (ex) {
<a name="l06978"></a>06978           <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l06979"></a>06979         }
<a name="l06980"></a>06980       }
<a name="l06981"></a>06981 
<a name="l06982"></a>06982       <span class="keywordflow">if</span> (<span class="keyword">self</span>._pendingLoads.length === 0)
<a name="l06983"></a>06983         <span class="keyword">self</span>._runDeferredCalls();
<a name="l06984"></a>06984     }
<a name="l06985"></a>06985 
<a name="l06986"></a>06986     this._LOG.loadBlock_begin(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, blockId);
<a name="l06987"></a>06987     <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;header&#39;</span>)
<a name="l06988"></a>06988       this._imapDb.loadHeaderBlock(this.folderId, blockId, onLoaded);
<a name="l06989"></a>06989     <span class="keywordflow">else</span>
<a name="l06990"></a>06990       this._imapDb.loadBodyBlock(this.folderId, blockId, onLoaded);
<a name="l06991"></a>06991   },
<a name="l06992"></a>06992 
<a name="l06993"></a>06993   _deleteFromBlock: <span class="keyword">function</span> ifs__deleteFromBlock(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, date, <span class="keywordtype">id</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l06994"></a>06994     var blockInfoList, loadedBlockInfoList, blockMap, deleteFromBlock;
<a name="l06995"></a>06995     this._LOG.deleteFromBlock(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, date, <span class="keywordtype">id</span>);
<a name="l06996"></a>06996     <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;header&#39;</span>) {
<a name="l06997"></a>06997       blockInfoList = this._headerBlockInfos;
<a name="l06998"></a>06998       loadedBlockInfoList = this._loadedHeaderBlockInfos;
<a name="l06999"></a>06999       blockMap = this._headerBlocks;
<a name="l07000"></a>07000       deleteFromBlock = this._bound_deleteHeaderFromBlock;
<a name="l07001"></a>07001     }
<a name="l07002"></a>07002     <span class="keywordflow">else</span> {
<a name="l07003"></a>07003       blockInfoList = this._bodyBlockInfos;
<a name="l07004"></a>07004       loadedBlockInfoList = this._loadedBodyBlockInfos;
<a name="l07005"></a>07005       blockMap = this._bodyBlocks;
<a name="l07006"></a>07006       deleteFromBlock = this._bound_deleteBodyFromBlock;
<a name="l07007"></a>07007     }
<a name="l07008"></a>07008 
<a name="l07009"></a>07009     var infoTuple = this._findRangeObjIndexForDateAndID(blockInfoList,
<a name="l07010"></a>07010                                                         date, <span class="keywordtype">id</span>),
<a name="l07011"></a>07011         iInfo = infoTuple[0], info = infoTuple[1];
<a name="l07012"></a>07012     <span class="comment">// If someone is asking for us to delete something, there should definitely</span>
<a name="l07013"></a>07013     <span class="comment">// be a block that includes it!</span>
<a name="l07014"></a>07014     <span class="keywordflow">if</span> (!info) {
<a name="l07015"></a>07015       this._LOG.badDeletionRequest(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, date, <span class="keywordtype">id</span>);
<a name="l07016"></a>07016       <span class="keywordflow">return</span>;
<a name="l07017"></a>07017     }
<a name="l07018"></a>07018 
<a name="l07019"></a>07019     <span class="keyword">function</span> processBlock(block) {
<a name="l07020"></a>07020       <span class="comment">// The delete function is in charge of updating the start/end TS/ID info</span>
<a name="l07021"></a>07021       <span class="comment">// because it knows about the internal block structure to do so.</span>
<a name="l07022"></a>07022       deleteFromBlock(<span class="keywordtype">id</span>, info, block);
<a name="l07023"></a>07023 
<a name="l07024"></a>07024       <span class="comment">// - Nuke the block if it&#39;s empty</span>
<a name="l07025"></a>07025       <span class="keywordflow">if</span> (info.count === 0) {
<a name="l07026"></a>07026         blockInfoList.splice(iInfo, 1);
<a name="l07027"></a>07027         <span class="keyword">delete</span> blockMap[info.blockId];
<a name="l07028"></a>07028         loadedBlockInfoList.splice(loadedBlockInfoList.indexOf(info), 1);
<a name="l07029"></a>07029 
<a name="l07030"></a>07030         this._dirty = <span class="keyword">true</span>;
<a name="l07031"></a>07031         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;header&#39;</span>)
<a name="l07032"></a>07032           this._dirtyHeaderBlocks[info.blockId] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07033"></a>07033         <span class="keywordflow">else</span>
<a name="l07034"></a>07034           this._dirtyBodyBlocks[info.blockId] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07035"></a>07035       }
<a name="l07036"></a>07036       <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>)
<a name="l07037"></a>07037         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l07038"></a>07038     }
<a name="l07039"></a>07039     <span class="keywordflow">if</span> (blockMap.hasOwnProperty(info.blockId))
<a name="l07040"></a>07040       processBlock.call(<span class="keyword">this</span>, blockMap[info.blockId]);
<a name="l07041"></a>07041     <span class="keywordflow">else</span>
<a name="l07042"></a>07042       this._loadBlock(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, info, processBlock.bind(<span class="keyword">this</span>));
<a name="l07043"></a>07043   },
<a name="l07044"></a>07044 
<a name="l07081"></a>07081   sliceOpenMostRecent: <span class="keyword">function</span> fs_sliceOpenMostRecent(slice, forceRefresh) {
<a name="l07082"></a>07082     <span class="comment">// Set the status immediately so that the UI will convey that the request is</span>
<a name="l07083"></a>07083     <span class="comment">// being processed, even though it might take a little bit to acquire the</span>
<a name="l07084"></a>07084     <span class="comment">// mutex.</span>
<a name="l07085"></a>07085     slice.setStatus(<span class="stringliteral">&#39;synchronizing&#39;</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>,
<a name="l07086"></a>07086                     SYNC_START_MINIMUM_PROGRESS);
<a name="l07087"></a>07087     this.runMutexed(
<a name="l07088"></a>07088       <span class="stringliteral">&#39;sync&#39;</span>,
<a name="l07089"></a>07089       this._sliceOpenMostRecent.bind(<span class="keyword">this</span>, slice, forceRefresh));
<a name="l07090"></a>07090   },
<a name="l07091"></a>07091   _sliceOpenMostRecent: <span class="keyword">function</span> fs__sliceOpenMostRecent(slice, forceRefresh,
<a name="l07092"></a>07092                                                          releaseMutex) {
<a name="l07093"></a>07093     <span class="comment">// We only put the slice in the list of slices now that we have the mutex</span>
<a name="l07094"></a>07094     <span class="comment">// in order to avoid having the slice have data fed into it if there were</span>
<a name="l07095"></a>07095     <span class="comment">// other synchronizations already in progress.</span>
<a name="l07096"></a>07096     this._slices.push(slice);
<a name="l07097"></a>07097 
<a name="l07098"></a>07098     var doneCallback = <span class="keyword">function</span> doneSyncCallback(err, reportSyncStatusAs,
<a name="l07099"></a>07099                                                  moreExpected) {
<a name="l07100"></a>07100       <span class="keywordflow">if</span> (!reportSyncStatusAs) {
<a name="l07101"></a>07101         <span class="keywordflow">if</span> (err)
<a name="l07102"></a>07102           reportSyncStatusAs = <span class="stringliteral">&#39;syncfailed&#39;</span>;
<a name="l07103"></a>07103         <span class="keywordflow">else</span>
<a name="l07104"></a>07104           reportSyncStatusAs = <span class="stringliteral">&#39;synced&#39;</span>;
<a name="l07105"></a>07105       }
<a name="l07106"></a>07106       <span class="keywordflow">if</span> (moreExpected === undefined)
<a name="l07107"></a>07107         moreExpected = <span class="keyword">false</span>;
<a name="l07108"></a>07108 
<a name="l07109"></a>07109       slice.waitingOnData = <span class="keyword">false</span>;
<a name="l07110"></a>07110       slice.setStatus(reportSyncStatusAs, <span class="keyword">true</span>, moreExpected, <span class="keyword">true</span>);
<a name="l07111"></a>07111       this._curSyncSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07112"></a>07112 
<a name="l07113"></a>07113       releaseMutex();
<a name="l07114"></a>07114     }.bind(<span class="keyword">this</span>);
<a name="l07115"></a>07115 
<a name="l07116"></a>07116     <span class="comment">// -- grab from database if we have ever synchronized this folder</span>
<a name="l07117"></a>07117     <span class="comment">// OR if it&#39;s synthetic</span>
<a name="l07118"></a>07118     <span class="keywordflow">if</span> (this._accuracyRanges.length || <span class="keyword">this</span>.folderMeta.type === <span class="stringliteral">&#39;localdrafts&#39;</span>) {
<a name="l07119"></a>07119       <span class="comment">// We can only trigger a refresh if we are online.  Our caller may want to</span>
<a name="l07120"></a>07120       <span class="comment">// force the refresh, ignoring recency data.  (This logic was too ugly as</span>
<a name="l07121"></a>07121       <span class="comment">// a straight-up boolean/ternarny combo.)</span>
<a name="l07122"></a>07122       var triggerRefresh;
<a name="l07123"></a>07123       <span class="keywordflow">if</span> (this._account.universe.online &amp;&amp; <span class="keyword">this</span>.folderSyncer.syncable &amp;&amp;
<a name="l07124"></a>07124           <span class="keyword">this</span>.folderMeta.type !== <span class="stringliteral">&#39;localdrafts&#39;</span>) {
<a name="l07125"></a>07125         <span class="keywordflow">if</span> (forceRefresh)
<a name="l07126"></a>07126           triggerRefresh = <span class="stringliteral">&#39;force&#39;</span>;
<a name="l07127"></a>07127         <span class="keywordflow">else</span>
<a name="l07128"></a>07128           triggerRefresh = <span class="keyword">true</span>;
<a name="l07129"></a>07129       }
<a name="l07130"></a>07130       <span class="keywordflow">else</span> {
<a name="l07131"></a>07131         triggerRefresh = <span class="keyword">false</span>;
<a name="l07132"></a>07132       }
<a name="l07133"></a>07133 
<a name="l07134"></a>07134       slice.waitingOnData = <span class="stringliteral">&#39;db&#39;</span>;
<a name="l07135"></a>07135       this.getMessagesInImapDateRange(
<a name="l07136"></a>07136         0, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, $sync.INITIAL_FILL_SIZE, $sync.INITIAL_FILL_SIZE,
<a name="l07137"></a>07137         <span class="comment">// trigger a refresh if we are online</span>
<a name="l07138"></a>07138         <span class="keyword">this</span>.onFetchDBHeaders.bind(
<a name="l07139"></a>07139           <span class="keyword">this</span>, slice, triggerRefresh,
<a name="l07140"></a>07140           doneCallback, releaseMutex)
<a name="l07141"></a>07141       );
<a name="l07142"></a>07142       <span class="keywordflow">return</span>;
<a name="l07143"></a>07143     }
<a name="l07144"></a>07144     <span class="comment">// (we have never synchronized this folder)</span>
<a name="l07145"></a>07145 
<a name="l07146"></a>07146     <span class="comment">// -- no work to do if we are offline or synthetic folder</span>
<a name="l07147"></a>07147     <span class="keywordflow">if</span> (!this._account.universe.online ||
<a name="l07148"></a>07148         <span class="keyword">this</span>.folderMeta.type === <span class="stringliteral">&#39;localdrafts&#39;</span>) {
<a name="l07149"></a>07149       doneCallback();
<a name="l07150"></a>07150       <span class="keywordflow">return</span>;
<a name="l07151"></a>07151     }
<a name="l07152"></a>07152     <span class="comment">// If the folder can&#39;t be synchronized right now, just report the sync as</span>
<a name="l07153"></a>07153     <span class="comment">// blocked. We&#39;ll update it soon enough.</span>
<a name="l07154"></a>07154     <span class="keywordflow">if</span> (!this.folderSyncer.syncable) {
<a name="l07155"></a>07155       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Synchronization is currently blocked; waiting...&#39;</span>);
<a name="l07156"></a>07156       doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;syncblocked&#39;</span>, <span class="keyword">true</span>);
<a name="l07157"></a>07157       <span class="keywordflow">return</span>;
<a name="l07158"></a>07158     }
<a name="l07159"></a>07159 
<a name="l07160"></a>07160     <span class="comment">// -- Bad existing data, issue a sync</span>
<a name="l07161"></a>07161     var progressCallback = slice.setSyncProgress.bind(slice);
<a name="l07162"></a>07162     var syncCallback = <span class="keyword">function</span> syncCallback(syncMode, accumulateMode,
<a name="l07163"></a>07163                                              ignoreHeaders) {
<a name="l07164"></a>07164       slice.waitingOnData = syncMode;
<a name="l07165"></a>07165       <span class="keywordflow">if</span> (accumulateMode &amp;&amp; slice.headers.length === 0) {
<a name="l07166"></a>07166         slice._accumulating = <span class="keyword">true</span>;
<a name="l07167"></a>07167       }
<a name="l07168"></a>07168       <span class="keywordflow">if</span> (ignoreHeaders) {
<a name="l07169"></a>07169         slice.ignoreHeaders = <span class="keyword">true</span>;
<a name="l07170"></a>07170       }
<a name="l07171"></a>07171       this._curSyncSlice = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l07172"></a>07172     }.bind(<span class="keyword">this</span>);
<a name="l07173"></a>07173 
<a name="l07174"></a>07174     <span class="comment">// The slice flags are not yet valid; we are primarily interested in having</span>
<a name="l07175"></a>07175     <span class="comment">// atTop be true when splice notifications for generated as headers are</span>
<a name="l07176"></a>07176     <span class="comment">// added.</span>
<a name="l07177"></a>07177     slice._updateSliceFlags();
<a name="l07178"></a>07178     this.folderSyncer.initialSync(
<a name="l07179"></a>07179       slice, $sync.INITIAL_SYNC_DAYS,
<a name="l07180"></a>07180       syncCallback, doneCallback, progressCallback);
<a name="l07181"></a>07181   },
<a name="l07182"></a>07182 
<a name="l07224"></a>07224   growSlice: <span class="keyword">function</span> ifs_growSlice(slice, dirMagnitude, userRequestsGrowth) {
<a name="l07225"></a>07225     <span class="comment">// If the user requested synchronization, provide UI feedback immediately,</span>
<a name="l07226"></a>07226     <span class="comment">// otherwise, let the method set this state if/when we actually decide to</span>
<a name="l07227"></a>07227     <span class="comment">// talk to the server.</span>
<a name="l07228"></a>07228     <span class="keywordflow">if</span> (userRequestsGrowth)
<a name="l07229"></a>07229       slice.setStatus(<span class="stringliteral">&#39;synchronizing&#39;</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>,
<a name="l07230"></a>07230                       SYNC_START_MINIMUM_PROGRESS);
<a name="l07231"></a>07231     this.runMutexed(
<a name="l07232"></a>07232       <span class="stringliteral">&#39;grow&#39;</span>,
<a name="l07233"></a>07233       this._growSlice.bind(<span class="keyword">this</span>, slice, dirMagnitude, userRequestsGrowth));
<a name="l07234"></a>07234   },
<a name="l07235"></a>07235   _growSlice: <span class="keyword">function</span> ifs__growSlice(slice, dirMagnitude, userRequestsGrowth,
<a name="l07236"></a>07236                                       releaseMutex) {
<a name="l07237"></a>07237     var <a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a>, desiredCount;
<a name="l07238"></a>07238 
<a name="l07239"></a>07239     var batchHeaders = [];
<a name="l07240"></a>07240     <span class="comment">// --- process messages</span>
<a name="l07241"></a>07241     var gotMessages = <span class="keyword">function</span> gotMessages(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, moreExpected) {
<a name="l07242"></a>07242       <span class="keywordflow">if</span> (<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.length === 0) {
<a name="l07243"></a>07243         <span class="comment">// no array manipulation required</span>
<a name="l07244"></a>07244       }
<a name="l07245"></a>07245       <span class="keywordflow">if</span> (dir === PASTWARDS) {
<a name="l07246"></a>07246         batchHeaders = batchHeaders.concat(<a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>);
<a name="l07247"></a>07247       }
<a name="l07248"></a>07248       <span class="keywordflow">else</span> { <span class="comment">// dir === FUTUREWARDS</span>
<a name="l07249"></a>07249         batchHeaders = <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>.concat(batchHeaders);
<a name="l07250"></a>07250       }
<a name="l07251"></a>07251 
<a name="l07252"></a>07252       <span class="keywordflow">if</span> (moreExpected)
<a name="l07253"></a>07253         <span class="keywordflow">return</span>;
<a name="l07254"></a>07254 
<a name="l07255"></a>07255       <span class="comment">// -- callbacks which may or may not get used</span>
<a name="l07256"></a>07256       var doneCallback = <span class="keyword">function</span> doneGrowCallback(err) {
<a name="l07257"></a>07257         <span class="comment">// In a refresh, we may have asked for more than we know about in case</span>
<a name="l07258"></a>07258         <span class="comment">// of a refresh at the edge where the database didn&#39;t have all the</span>
<a name="l07259"></a>07259         <span class="comment">// headers we wanted, so latch it now.</span>
<a name="l07260"></a>07260         slice.desiredHeaders = slice.headers.length;
<a name="l07261"></a>07261         slice.waitingOnData = <span class="keyword">false</span>;
<a name="l07262"></a>07262         slice.setStatus(err ? <span class="stringliteral">&#39;syncfailed&#39;</span> : <span class="stringliteral">&#39;synced&#39;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l07263"></a>07263         this._curSyncSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07264"></a>07264 
<a name="l07265"></a>07265         releaseMutex();
<a name="l07266"></a>07266       }.bind(<span class="keyword">this</span>);
<a name="l07267"></a>07267 
<a name="l07268"></a>07268       var progressCallback = slice.setSyncProgress.bind(slice);
<a name="l07269"></a>07269 
<a name="l07270"></a>07270       <span class="comment">// -- Handle already-known headers</span>
<a name="l07271"></a>07271       <span class="keywordflow">if</span> (batchHeaders.length) {
<a name="l07272"></a>07272         var refreshInterval;
<a name="l07273"></a>07273 
<a name="l07274"></a>07274         <span class="comment">// - compute refresh interval, if needed</span>
<a name="l07275"></a>07275             <span class="comment">// offline? don&#39;t need a refresh!</span>
<a name="l07276"></a>07276         <span class="keywordflow">if</span> (!this._account.universe.online ||
<a name="l07277"></a>07277             <span class="comment">// disabled account? don&#39;t need a refresh!</span>
<a name="l07278"></a>07278             !<span class="keyword">this</span>._account.enabled ||
<a name="l07279"></a>07279             <span class="comment">// can&#39;t incrementally refresh? don&#39;t need a refresh!</span>
<a name="l07280"></a>07280             !<span class="keyword">this</span>.folderSyncer.canGrowSync) {
<a name="l07281"></a>07281           refreshInterval = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07282"></a>07282         }
<a name="l07283"></a>07283         <span class="keywordflow">else</span> {
<a name="l07284"></a>07284           <span class="comment">// - Figure out refresh range.</span>
<a name="l07285"></a>07285           <span class="comment">// We want to make sure that our refresh covers any gaps between the</span>
<a name="l07286"></a>07286           <span class="comment">// last message in our slice and the first message that we retrieved.</span>
<a name="l07287"></a>07287 
<a name="l07288"></a>07288           <span class="comment">// NB: endTS is exclusive, so we need to pad it out by a day relative</span>
<a name="l07289"></a>07289           <span class="comment">// to a known message if we want to make sure it gets covered by the</span>
<a name="l07290"></a>07290           <span class="comment">// sync range.</span>
<a name="l07291"></a>07291 
<a name="l07292"></a>07292           <span class="comment">// NB: We quantize to whole dates, but compensate for server timezones</span>
<a name="l07293"></a>07293           <span class="comment">// so that our refresh actually lines up with the messages we are</span>
<a name="l07294"></a>07294           <span class="comment">// interested in.  (We want the date in the server&#39;s timezone, so we</span>
<a name="l07295"></a>07295           <span class="comment">// add the timezone to be relative to that timezone.)  We do adjust</span>
<a name="l07296"></a>07296           <span class="comment">// startTS for the timezone offset in here rather than in the</span>
<a name="l07297"></a>07297           <span class="comment">// quantization blow below because we do not timezone adjust the oldest</span>
<a name="l07298"></a>07298           <span class="comment">// full sync date because it&#39;s already in the right &#39;units&#39;.</span>
<a name="l07299"></a>07299 
<a name="l07300"></a>07300           var highestLegalEndTS;
<a name="l07301"></a>07301           <span class="comment">// If we hit the highestLegalEndTS, flag that we should mark endTS as</span>
<a name="l07302"></a>07302           <span class="comment">// open-ended if we decide we do need to refresh.</span>
<a name="l07303"></a>07303           var openEndTS = <span class="keyword">false</span>;
<a name="l07304"></a>07304 
<a name="l07305"></a>07305           var startTS, endTS;
<a name="l07306"></a>07306           <span class="keywordflow">if</span> (dir === PASTWARDS) {
<a name="l07307"></a>07307             var oldestHeader = batchHeaders[batchHeaders.length - 1];
<a name="l07308"></a>07308             <span class="comment">// If we were always going to sync the entire day, we could</span>
<a name="l07309"></a>07309             <span class="comment">// subtract an entire day off of slice.startTS, but we are planning</span>
<a name="l07310"></a>07310             <span class="comment">// to start grabbing less than whole days, so we want to leave it</span>
<a name="l07311"></a>07311             <span class="comment">// up to checkAccuracyCoverageNeedingRefresh to get rid of any</span>
<a name="l07312"></a>07312             <span class="comment">// redundant coverage of what we are currently looking at.</span>
<a name="l07313"></a>07313             <span class="comment">//</span>
<a name="l07314"></a>07314             <span class="comment">// We do want to cap the date so that we don&#39;t re-refresh today and</span>
<a name="l07315"></a>07315             <span class="comment">// any other intervening days spuriously.  When we sync we only use</span>
<a name="l07316"></a>07316             <span class="comment">// an endTS of tz-adjusted NOW(), so our rounding up can be too</span>
<a name="l07317"></a>07317             <span class="comment">// aggressive otherwise and prevent range shrinking.  We call</span>
<a name="l07318"></a>07318             <span class="comment">// quantizeDateUp afterwards so that if any part of the day is still</span>
<a name="l07319"></a>07319             <span class="comment">// covered we will have our refresh cover it.</span>
<a name="l07320"></a>07320             <span class="comment">//</span>
<a name="l07321"></a>07321             <span class="comment">// NB: We use OPEN_REFRESH_THRESH_MS here because since we are</span>
<a name="l07322"></a>07322             <span class="comment">// growing past-wards, we don&#39;t really care about refreshing things</span>
<a name="l07323"></a>07323             <span class="comment">// in our future.  This is not the case for FUTUREWARDS.</span>
<a name="l07324"></a>07324             highestLegalEndTS = NOW() - $sync.OPEN_REFRESH_THRESH_MS +
<a name="l07325"></a>07325                                   this._account.tzOffset;
<a name="l07326"></a>07326             endTS = slice.startTS + $date.DAY_MILLIS + this._account.tzOffset;
<a name="l07327"></a>07327 
<a name="l07328"></a>07328             <span class="keywordflow">if</span> (this.headerIsOldestKnown(oldestHeader.date, oldestHeader.id))
<a name="l07329"></a>07329               startTS = this.getOldestFullSyncDate();
<a name="l07330"></a>07330             <span class="keywordflow">else</span>
<a name="l07331"></a>07331               startTS = oldestHeader.date + this._account.tzOffset;
<a name="l07332"></a>07332           }
<a name="l07333"></a>07333           <span class="keywordflow">else</span> { <span class="comment">// dir === FUTUREWARDS</span>
<a name="l07334"></a>07334             <span class="comment">// Unlike PASTWARDS, we do want to be more aggressively up-to-date</span>
<a name="l07335"></a>07335             <span class="comment">// about the future, so only subtract off the grow range coverage.</span>
<a name="l07336"></a>07336             <span class="comment">// (If we didn&#39;t subtract anything off, quick scrolling back and</span>
<a name="l07337"></a>07337             <span class="comment">// forth could cause us to refresh more frequently than</span>
<a name="l07338"></a>07338             <span class="comment">// GROW_REFRESH_THRESH_MS, which is not what we want.)</span>
<a name="l07339"></a>07339             highestLegalEndTS = NOW() - $sync.GROW_REFRESH_THRESH_MS +
<a name="l07340"></a>07340                                   this._account.tzOffset;
<a name="l07341"></a>07341 
<a name="l07342"></a>07342             var youngestHeader = batchHeaders[0];
<a name="l07343"></a>07343             <span class="comment">// see the PASTWARDS case for why we don&#39;t add a day to this</span>
<a name="l07344"></a>07344             startTS = slice.endTS + this._account.tzOffset;
<a name="l07345"></a>07345             endTS = youngestHeader.date + $date.DAY_MILLIS +
<a name="l07346"></a>07346                       this._account.tzOffset;
<a name="l07347"></a>07347           }
<a name="l07348"></a>07348           <span class="comment">// We do not want this clamped/saturated case quantized, but we do</span>
<a name="l07349"></a>07349           <span class="comment">// want all the (other) future-dated endTS cases quantized.</span>
<a name="l07350"></a>07350           <span class="keywordflow">if</span> (STRICTLY_AFTER(endTS, highestLegalEndTS)) {
<a name="l07351"></a>07351             endTS = highestLegalEndTS;
<a name="l07352"></a>07352             openEndTS = <span class="keyword">true</span>;
<a name="l07353"></a>07353           }
<a name="l07354"></a>07354           <span class="keywordflow">else</span> {
<a name="l07355"></a>07355             endTS = quantizeDate(endTS);
<a name="l07356"></a>07356           }
<a name="l07357"></a>07357 
<a name="l07358"></a>07358           <span class="comment">// Now, it&#39;s not super-likely, but it is possible that because of</span>
<a name="l07359"></a>07359           <span class="comment">// clock skew or what not that our startTS could end up after our</span>
<a name="l07360"></a>07360           <span class="comment">// endTS, which we do not want.  Now, we could just clamp this,</span>
<a name="l07361"></a>07361           <span class="comment">// but since we know the result would be a zero-coverage range,</span>
<a name="l07362"></a>07362           <span class="comment">// we can just set the refreshInterval to null and be done.</span>
<a name="l07363"></a>07363           <span class="keywordflow">if</span> (SINCE(startTS, endTS))
<a name="l07364"></a>07364             refreshInterval = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07365"></a>07365           <span class="keywordflow">else</span>
<a name="l07366"></a>07366             refreshInterval = this.checkAccuracyCoverageNeedingRefresh(
<a name="l07367"></a>07367               quantizeDate(startTS),
<a name="l07368"></a>07368               endTS, <span class="comment">// quantized above except when it would go into the future.</span>
<a name="l07369"></a>07369               $sync.GROW_REFRESH_THRESH_MS);
<a name="l07370"></a>07370         }
<a name="l07371"></a>07371 
<a name="l07372"></a>07372         <span class="comment">// We could also send the headers in as they come across the wire,</span>
<a name="l07373"></a>07373         <span class="comment">// but we expect to be dealing in bite-sized requests, so that could</span>
<a name="l07374"></a>07374         <span class="comment">// be overkill.</span>
<a name="l07375"></a>07375         slice.batchAppendHeaders(
<a name="l07376"></a>07376           batchHeaders, dir === PASTWARDS ? -1 : 0,
<a name="l07377"></a>07377           <span class="comment">// !!refreshInterval is more efficient, but this way we can reuse</span>
<a name="l07378"></a>07378           <span class="comment">// doneCallback() below in the else case simply.</span>
<a name="l07379"></a>07379           <span class="keyword">true</span>);
<a name="l07380"></a>07380         <span class="comment">// If the database had fewer headers than are requested, it&#39;s possible</span>
<a name="l07381"></a>07381         <span class="comment">// the refresh may give us extras, so allow those to be reported.</span>
<a name="l07382"></a>07382         slice.desiredHeaders = Math.max(slice.headers.length, desiredCount);
<a name="l07383"></a>07383 
<a name="l07384"></a>07384         <span class="keywordflow">if</span> (refreshInterval &amp;&amp;
<a name="l07385"></a>07385             <span class="comment">// If the values are the same, by definition we have nothing to do,</span>
<a name="l07386"></a>07386             <span class="comment">// but more importantly, the rounding might not improve the</span>
<a name="l07387"></a>07387             <span class="comment">// situation, which could result in pathological sync failure on</span>
<a name="l07388"></a>07388             <span class="comment">// gmail where it returns all the messages it knows about.</span>
<a name="l07389"></a>07389             refreshInterval.startTS !== refreshInterval.endTS) {
<a name="l07390"></a>07390 
<a name="l07391"></a>07391           <span class="comment">// If growth was not requested, make sure we convey server traffic is</span>
<a name="l07392"></a>07392           <span class="comment">// happening.</span>
<a name="l07393"></a>07393           <span class="keywordflow">if</span> (!userRequestsGrowth)
<a name="l07394"></a>07394             slice.setStatus(<span class="stringliteral">&#39;synchronizing&#39;</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>,
<a name="l07395"></a>07395                             SYNC_START_MINIMUM_PROGRESS);
<a name="l07396"></a>07396 
<a name="l07397"></a>07397           this.folderSyncer.refreshSync(
<a name="l07398"></a>07398             slice, dir,
<a name="l07399"></a>07399             quantizeDate(refreshInterval.startTS),
<a name="l07400"></a>07400             <span class="comment">// If we didn&#39;t shrink the endTS and we flagged to be open-ended, then</span>
<a name="l07401"></a>07401             <span class="comment">// use null.  But if we did shrink the range, then there&#39;s no need to</span>
<a name="l07402"></a>07402             <span class="comment">// go open-ended.</span>
<a name="l07403"></a>07403             (openEndTS &amp;&amp; refreshInterval.endTS === highestLegalEndTS) ? <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>
<a name="l07404"></a>07404               : quantizeDateUp(refreshInterval.endTS),
<a name="l07405"></a>07405             <span class="comment">/* origStartTS */</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l07406"></a>07406             doneCallback, progressCallback);
<a name="l07407"></a>07407         }
<a name="l07408"></a>07408         <span class="keywordflow">else</span> {
<a name="l07409"></a>07409           doneCallback();
<a name="l07410"></a>07410         }
<a name="l07411"></a>07411 
<a name="l07412"></a>07412         <span class="keywordflow">return</span>;
<a name="l07413"></a>07413       }
<a name="l07414"></a>07414 
<a name="l07415"></a>07415       <span class="comment">// -- grow!</span>
<a name="l07416"></a>07416       <span class="comment">// - do not grow if offline / no support / no user request</span>
<a name="l07417"></a>07417       <span class="keywordflow">if</span> (!this._account.universe.online ||
<a name="l07418"></a>07418           !<span class="keyword">this</span>.folderSyncer.canGrowSync ||
<a name="l07419"></a>07419           !userRequestsGrowth) {
<a name="l07420"></a>07420         <span class="keywordflow">if</span> (this.folderSyncer.syncable)
<a name="l07421"></a>07421           slice.sendEmptyCompletion();
<a name="l07422"></a>07422         releaseMutex();
<a name="l07423"></a>07423         <span class="keywordflow">return</span>;
<a name="l07424"></a>07424       }
<a name="l07425"></a>07425 
<a name="l07426"></a>07426       <span class="keywordflow">if</span> (!userRequestsGrowth)
<a name="l07427"></a>07427         slice.setStatus(<span class="stringliteral">&#39;synchronizing&#39;</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>,
<a name="l07428"></a>07428                         SYNC_START_MINIMUM_PROGRESS);
<a name="l07429"></a>07429       this._curSyncSlice = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l07430"></a>07430       slice.waitingOnData = <span class="stringliteral">&#39;grow&#39;</span>;
<a name="l07431"></a>07431       <span class="comment">// We only add the desired count now that we are sure we are growing; if</span>
<a name="l07432"></a>07432       <span class="comment">// we did it earlier we might boost the desiredHeaders count and then</span>
<a name="l07433"></a>07433       <span class="comment">// not sync, resulting in the next time we do grow fetching more than we</span>
<a name="l07434"></a>07434       <span class="comment">// want.</span>
<a name="l07435"></a>07435       slice.desiredHeaders += desiredCount;
<a name="l07436"></a>07436 
<a name="l07437"></a>07437       <span class="comment">// TODO: when we support partial day sync, these growth steps will need</span>
<a name="l07438"></a>07438       <span class="comment">// to be adjusted by 1-day if day covering the edge message has not been</span>
<a name="l07439"></a>07439       <span class="comment">// fully synchronized.</span>
<a name="l07440"></a>07440       this.folderSyncer.growSync(
<a name="l07441"></a>07441         slice, dir,
<a name="l07442"></a>07442         dir === PASTWARDS ? quantizeDate(slice.startTS)
<a name="l07443"></a>07443                           : quantizeDate(slice.endTS + $date.DAY_MILLIS),
<a name="l07444"></a>07444         $sync.INITIAL_SYNC_GROWTH_DAYS,
<a name="l07445"></a>07445         doneCallback, progressCallback);
<a name="l07446"></a>07446     }.bind(<span class="keyword">this</span>);
<a name="l07447"></a>07447 
<a name="l07448"></a>07448     <span class="comment">// --- request messages</span>
<a name="l07449"></a>07449     <span class="keywordflow">if</span> (dirMagnitude &lt; 0) {
<a name="l07450"></a>07450       dir = FUTUREWARDS;
<a name="l07451"></a>07451       desiredCount = -dirMagnitude;
<a name="l07452"></a>07452 
<a name="l07453"></a>07453       this.getMessagesAfterMessage(
<a name="l07454"></a>07454         slice.endTS, slice.endUID, desiredCount, gotMessages);
<a name="l07455"></a>07455     }
<a name="l07456"></a>07456     <span class="keywordflow">else</span> {
<a name="l07457"></a>07457       dir = PASTWARDS;
<a name="l07458"></a>07458       desiredCount = dirMagnitude;
<a name="l07459"></a>07459 
<a name="l07460"></a>07460       this.getMessagesBeforeMessage(
<a name="l07461"></a>07461         slice.startTS, slice.startUID, desiredCount, gotMessages);
<a name="l07462"></a>07462     }
<a name="l07463"></a>07463   },
<a name="l07464"></a>07464 
<a name="l07470"></a>07470   sliceShrunk: <span class="keyword">function</span> fs_sliceShrunk(slice) {
<a name="l07471"></a>07471     <span class="keywordflow">if</span> (this._mutexQueue.length === 0)
<a name="l07472"></a>07472       this.flushExcessCachedBlocks(<span class="stringliteral">&#39;shrunk&#39;</span>);
<a name="l07473"></a>07473   },
<a name="l07474"></a>07474 
<a name="l07488"></a>07488   refreshSlice: <span class="keyword">function</span> fs_refreshSlice(slice) {
<a name="l07489"></a>07489     <span class="comment">// Set the status immediately so that the UI will convey that the request is</span>
<a name="l07490"></a>07490     <span class="comment">// being processed, even though it might take a little bit to acquire the</span>
<a name="l07491"></a>07491     <span class="comment">// mutex.</span>
<a name="l07492"></a>07492     slice.setStatus(<span class="stringliteral">&#39;synchronizing&#39;</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, 0.0);
<a name="l07493"></a>07493     this.runMutexed(
<a name="l07494"></a>07494       <span class="stringliteral">&#39;refresh&#39;</span>,
<a name="l07495"></a>07495       this._refreshSlice.bind(<span class="keyword">this</span>, slice, <span class="keyword">false</span>));
<a name="l07496"></a>07496   },
<a name="l07497"></a>07497   _refreshSlice: <span class="keyword">function</span> fs__refreshSlice(slice, checkOpenRecency,
<a name="l07498"></a>07498                                            releaseMutex) {
<a name="l07499"></a>07499     slice.waitingOnData = <span class="stringliteral">&#39;refresh&#39;</span>;
<a name="l07500"></a>07500 
<a name="l07501"></a>07501     var startTS = slice.startTS, endTS = slice.endTS,
<a name="l07502"></a>07502         <span class="comment">// In the event we grow the startTS to the dawn of time, then we want</span>
<a name="l07503"></a>07503         <span class="comment">// to also provide the original startTS so that the bisection does not</span>
<a name="l07504"></a>07504         <span class="comment">// need to scan through years of empty space.</span>
<a name="l07505"></a>07505         origStartTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l07506"></a>07506         <span class="comment">// If we are refreshing through &#39;now&#39;, we will count the new messages we</span>
<a name="l07507"></a>07507         <span class="comment">// hear about and update this.newEmailCount once the sync completes.  If</span>
<a name="l07508"></a>07508         <span class="comment">// we are performing any othe sync, the value will not be updated.</span>
<a name="l07509"></a>07509         newEmailCount = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07510"></a>07510 
<a name="l07511"></a>07511     <span class="comment">// - Grow endTS</span>
<a name="l07512"></a>07512     <span class="comment">// If the endTS lines up with the most recent known message for the folder,</span>
<a name="l07513"></a>07513     <span class="comment">// then remove the timestamp constraint so it goes all the way to now.</span>
<a name="l07514"></a>07514     <span class="comment">// OR if we just have no known messages</span>
<a name="l07515"></a>07515     <span class="keywordflow">if</span> (this.headerIsYoungestKnown(endTS, slice.endUID)) {
<a name="l07516"></a>07516       var prevTS = endTS;
<a name="l07517"></a>07517       newEmailCount = 0;
<a name="l07518"></a>07518 
<a name="l07525"></a>07525       slice._onAddingHeader = <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, currentSlice) {
<a name="l07526"></a>07526         <span class="keywordflow">if</span> (SINCE(header.date, prevTS) &amp;&amp;
<a name="l07527"></a>07527             (!header.flags || header.flags.indexOf(<span class="stringliteral">&#39;\\Seen&#39;</span>) === -1)) {
<a name="l07528"></a>07528           newEmailCount += 1;
<a name="l07529"></a>07529           <span class="keywordflow">if</span> (slice.onNewHeader)
<a name="l07530"></a>07530             slice.onNewHeader(header);
<a name="l07531"></a>07531         }
<a name="l07532"></a>07532       }.bind(<span class="keyword">this</span>);
<a name="l07533"></a>07533 
<a name="l07534"></a>07534       endTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07535"></a>07535     }
<a name="l07536"></a>07536     <span class="keywordflow">else</span> {
<a name="l07537"></a>07537       <span class="comment">// We want the range to include the day; since it&#39;s an exclusive range</span>
<a name="l07538"></a>07538       <span class="comment">// quantized to midnight, we need to adjust forward a day and then</span>
<a name="l07539"></a>07539       <span class="comment">// quantize.  We also need to compensate for the timezone; we want this</span>
<a name="l07540"></a>07540       <span class="comment">// time in terms of server time, so we add the timezone offset.</span>
<a name="l07541"></a>07541       endTS = quantizeDate(endTS + DAY_MILLIS + this._account.tzOffset);
<a name="l07542"></a>07542     }
<a name="l07543"></a>07543 
<a name="l07544"></a>07544     <span class="comment">// - Grow startTS</span>
<a name="l07545"></a>07545     <span class="comment">// Grow the start-stamp to include the oldest continuous accuracy range</span>
<a name="l07546"></a>07546     <span class="comment">// coverage date.  Keep original date around for bisect per above.</span>
<a name="l07547"></a>07547     <span class="keywordflow">if</span> (this.headerIsOldestKnown(startTS, slice.startUID)) {
<a name="l07548"></a>07548       origStartTS = quantizeDate(startTS + this._account.tzOffset);
<a name="l07549"></a>07549       startTS = this.getOldestFullSyncDate();
<a name="l07550"></a>07550     }
<a name="l07551"></a>07551     <span class="comment">// If we didn&#39;t grow based on the accuracy range, then apply the time-zone</span>
<a name="l07552"></a>07552     <span class="comment">// adjustment so that our day coverage covers the actual INTERNALDATE day</span>
<a name="l07553"></a>07553     <span class="comment">// of the start message.</span>
<a name="l07554"></a>07554     <span class="keywordflow">else</span> {
<a name="l07555"></a>07555       startTS += this._account.tzOffset;
<a name="l07556"></a>07556     }
<a name="l07557"></a>07557 
<a name="l07558"></a>07558     <span class="comment">// quantize the start date</span>
<a name="l07559"></a>07559     <span class="keywordflow">if</span> (startTS)
<a name="l07560"></a>07560       startTS = quantizeDate(startTS);
<a name="l07561"></a>07561 
<a name="l07562"></a>07562     var doneCallback = <span class="keyword">function</span> refreshDoneCallback(err, bisectInfo,
<a name="l07563"></a>07563                                                     numMessages) {
<a name="l07564"></a>07564       slice._onAddingHeader = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07565"></a>07565 
<a name="l07566"></a>07566       var reportSyncStatusAs = <span class="stringliteral">&#39;synced&#39;</span>;
<a name="l07567"></a>07567       <span class="keywordflow">switch</span> (err) {
<a name="l07568"></a>07568         <span class="keywordflow">case</span> <span class="stringliteral">&#39;aborted&#39;</span>:
<a name="l07569"></a>07569         <span class="keywordflow">case</span> <span class="stringliteral">&#39;unknown&#39;</span>:
<a name="l07570"></a>07570           reportSyncStatusAs = <span class="stringliteral">&#39;syncfailed&#39;</span>;
<a name="l07571"></a>07571           <span class="keywordflow">break</span>;
<a name="l07572"></a>07572       }
<a name="l07573"></a>07573 
<a name="l07574"></a>07574       releaseMutex();
<a name="l07575"></a>07575       slice.waitingOnData = <span class="keyword">false</span>;
<a name="l07576"></a>07576       slice.setStatus(reportSyncStatusAs, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l07577"></a>07577                       newEmailCount);
<a name="l07578"></a>07578       <span class="keywordflow">return</span> undefined;
<a name="l07579"></a>07579     }.bind(<span class="keyword">this</span>);
<a name="l07580"></a>07580 
<a name="l07581"></a>07581 
<a name="l07582"></a>07582     <span class="comment">// In the initial open case, we support a constant that allows us to</span>
<a name="l07583"></a>07583     <span class="comment">// fast-path out without bothering the server.</span>
<a name="l07584"></a>07584     <span class="keywordflow">if</span> (checkOpenRecency) {
<a name="l07585"></a>07585       <span class="comment">// We use now less the refresh threshold as the accuracy range end-post;</span>
<a name="l07586"></a>07586       <span class="comment">// since markSyncRange uses NOW() when &#39;null&#39; is provided (which it will</span>
<a name="l07587"></a>07587       <span class="comment">// be for a sync through now), this all works out consistently.</span>
<a name="l07588"></a>07588       <span class="keywordflow">if</span> (this.checkAccuracyCoverageNeedingRefresh(
<a name="l07589"></a>07589              startTS,
<a name="l07590"></a>07590              endTS ||
<a name="l07591"></a>07591                NOW() - $sync.OPEN_REFRESH_THRESH_MS + <span class="keyword">this</span>._account.tzOffset,
<a name="l07592"></a>07592              $sync.OPEN_REFRESH_THRESH_MS) === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l07593"></a>07593         doneCallback();
<a name="l07594"></a>07594         <span class="keywordflow">return</span>;
<a name="l07595"></a>07595       }
<a name="l07596"></a>07596     }
<a name="l07597"></a>07597 
<a name="l07598"></a>07598     <span class="comment">// The choice of PASTWARDS/FUTUREWARDS impacts the direction our chunks</span>
<a name="l07599"></a>07599     <span class="comment">// happen if we have to bisect (if that happens) and (eventually) the</span>
<a name="l07600"></a>07600     <span class="comment">// direction new bodies are fetched.</span>
<a name="l07601"></a>07601     <span class="comment">//</span>
<a name="l07602"></a>07602     <span class="comment">// There are arguments for both choices:</span>
<a name="l07603"></a>07603     <span class="comment">//</span>
<a name="l07604"></a>07604     <span class="comment">// Initial slice open refresh:</span>
<a name="l07605"></a>07605     <span class="comment">// - PASTWARDS: Show the user the newest messages, but at the cost of a</span>
<a name="l07606"></a>07606     <span class="comment">//   gap between the known messages and these new messages we are</span>
<a name="l07607"></a>07607     <span class="comment">//   synchronizing in.  The gap is potentially confusing and ordering could</span>
<a name="l07608"></a>07608     <span class="comment">//   also be confusing to the user.</span>
<a name="l07609"></a>07609     <span class="comment">// - FUTUREWARDS: Avoid that gap, having the scrolling make sense.</span>
<a name="l07610"></a>07610     <span class="comment">//   There is a pathological case here where we are ridiculously out-of-date</span>
<a name="l07611"></a>07611     <span class="comment">//   and it would take the user a loooong time to sync all the way back up</span>
<a name="l07612"></a>07612     <span class="comment">//   to now and it would be better to just restart with an initial deepening</span>
<a name="l07613"></a>07613     <span class="comment">//   sync and/or throw things away.  Arguably, these are cases that should</span>
<a name="l07614"></a>07614     <span class="comment">//   be explicitly handled outside of us.</span>
<a name="l07615"></a>07615     <span class="comment">//</span>
<a name="l07616"></a>07616     <span class="comment">// Manual refresh:</span>
<a name="l07617"></a>07617     <span class="comment">// - PASTWARDS: Newest first.</span>
<a name="l07618"></a>07618     <span class="comment">// - FUTUREWARDS: Have the messages show up in the order they were received.</span>
<a name="l07619"></a>07619     <span class="comment">//</span>
<a name="l07620"></a>07620     <span class="comment">// We currently choose FUTUREWARDS to avoid the gap and have messages show</span>
<a name="l07621"></a>07621     <span class="comment">// up chronologically.</span>
<a name="l07622"></a>07622     this.folderSyncer.refreshSync(
<a name="l07623"></a>07623       slice, FUTUREWARDS, startTS, endTS, origStartTS,
<a name="l07624"></a>07624       doneCallback, slice.setSyncProgress.bind(slice));
<a name="l07625"></a>07625   },
<a name="l07626"></a>07626 
<a name="l07627"></a>07627   _resetAndResyncSlice: <span class="keyword">function</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, forceRefresh, releaseMutex) {
<a name="l07628"></a>07628     this._slices.splice(this._slices.indexOf(slice), 1);
<a name="l07629"></a>07629     <span class="keywordflow">if</span> (releaseMutex)
<a name="l07630"></a>07630       this._sliceOpenMostRecent(slice, forceRefresh, releaseMutex);
<a name="l07631"></a>07631     <span class="keywordflow">else</span>
<a name="l07632"></a>07632       this.sliceOpenMostRecent(slice, forceRefresh);
<a name="l07633"></a>07633   },
<a name="l07634"></a>07634 
<a name="l07635"></a>07635   dyingSlice: <span class="keyword">function</span> ifs_dyingSlice(slice) {
<a name="l07636"></a>07636     var idx = this._slices.indexOf(slice);
<a name="l07637"></a>07637     this._slices.splice(idx, 1);
<a name="l07638"></a>07638 
<a name="l07639"></a>07639     <span class="keywordflow">if</span> (this._slices.length === 0 &amp;&amp; <span class="keyword">this</span>._mutexQueue.length === 0)
<a name="l07640"></a>07640       this.folderSyncer.allConsumersDead();
<a name="l07641"></a>07641   },
<a name="l07642"></a>07642 
<a name="l07646"></a>07646   onFetchDBHeaders: <span class="keyword">function</span>(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, triggerRefresh, doneCallback, releaseMutex,
<a name="l07647"></a>07647                              <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, moreMessagesComing) {
<a name="l07648"></a>07648     var triggerNow = <span class="keyword">false</span>;
<a name="l07649"></a>07649     <span class="keywordflow">if</span> (!moreMessagesComing &amp;&amp; triggerRefresh) {
<a name="l07650"></a>07650       moreMessagesComing = <span class="keyword">true</span>;
<a name="l07651"></a>07651       triggerNow = <span class="keyword">true</span>;
<a name="l07652"></a>07652     }
<a name="l07653"></a>07653 
<a name="l07654"></a>07654     <span class="keywordflow">if</span> (headers.length) {
<a name="l07655"></a>07655       <span class="comment">// Claim there are more headers coming since we will trigger setStatus</span>
<a name="l07656"></a>07656       <span class="comment">// right below and we want that to be the only edge transition.</span>
<a name="l07657"></a>07657       slice.batchAppendHeaders(headers, -1, <span class="keyword">true</span>);
<a name="l07658"></a>07658     }
<a name="l07659"></a>07659 
<a name="l07660"></a>07660     <span class="keywordflow">if</span> (!moreMessagesComing) {
<a name="l07661"></a>07661       slice.desiredHeaders = slice.headers.length;
<a name="l07662"></a>07662       doneCallback();
<a name="l07663"></a>07663     }
<a name="l07664"></a>07664     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (triggerNow) {
<a name="l07665"></a>07665       slice.desiredHeaders = slice.headers.length;
<a name="l07666"></a>07666       <span class="comment">// refreshSlice expects this to be null for two reasons:</span>
<a name="l07667"></a>07667       <span class="comment">// 1) Invariant about only having one sync-like thing happening at a time.</span>
<a name="l07668"></a>07668       <span class="comment">// 2) We want to generate header deltas rather than initial filling,</span>
<a name="l07669"></a>07669       <span class="comment">//    and this is keyed off of whether the slice is the current sync</span>
<a name="l07670"></a>07670       <span class="comment">//    slice.</span>
<a name="l07671"></a>07671       this._curSyncSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07672"></a>07672       <span class="comment">// We want to have the refresh check its refresh recency range unless we</span>
<a name="l07673"></a>07673       <span class="comment">// have been explicitly told to force a refresh.</span>
<a name="l07674"></a>07674       var checkOpenRecency = triggerRefresh !== <span class="stringliteral">&#39;force&#39;</span>;
<a name="l07675"></a>07675       this._refreshSlice(slice, checkOpenRecency, releaseMutex);
<a name="l07676"></a>07676     }
<a name="l07677"></a>07677   },
<a name="l07678"></a>07678 
<a name="l07679"></a>07679   sliceQuicksearch: <span class="keyword">function</span> ifs_sliceQuicksearch(slice, searchParams) {
<a name="l07680"></a>07680   },
<a name="l07681"></a>07681 
<a name="l07682"></a>07682   getYoungestMessageTimestamp: <span class="keyword">function</span>() {
<a name="l07683"></a>07683     <span class="keywordflow">if</span> (!this._headerBlockInfos.length)
<a name="l07684"></a>07684       <span class="keywordflow">return</span> 0;
<a name="l07685"></a>07685     <span class="keywordflow">return</span> this._headerBlockInfos[0].endTS;
<a name="l07686"></a>07686   },
<a name="l07687"></a>07687 
<a name="l07694"></a>07694   headerIsYoungestKnown: <span class="keyword">function</span>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, uid) {
<a name="l07695"></a>07695     <span class="comment">// NB: unlike oldest known, this should not actually be impacted by messages</span>
<a name="l07696"></a>07696     <span class="comment">// found by search.</span>
<a name="l07697"></a>07697     <span class="keywordflow">if</span> (!this._headerBlockInfos.length)
<a name="l07698"></a>07698       <span class="keywordflow">return</span> (date === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> &amp;&amp; uid === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l07699"></a>07699     var blockInfo = this._headerBlockInfos[0];
<a name="l07700"></a>07700 
<a name="l07701"></a>07701     <span class="keywordflow">return</span> (date === blockInfo.endTS &amp;&amp;
<a name="l07702"></a>07702             uid === blockInfo.endUID);
<a name="l07703"></a>07703   },
<a name="l07704"></a>07704 
<a name="l07705"></a>07705   getOldestMessageTimestamp: <span class="keyword">function</span>() {
<a name="l07706"></a>07706     <span class="keywordflow">if</span> (!this._headerBlockInfos.length)
<a name="l07707"></a>07707       <span class="keywordflow">return</span> 0;
<a name="l07708"></a>07708     <span class="keywordflow">return</span> this._headerBlockInfos[this._headerBlockInfos.length - 1].startTS;
<a name="l07709"></a>07709   },
<a name="l07710"></a>07710 
<a name="l07717"></a>07717   headerIsOldestKnown: <span class="keyword">function</span>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, uid) {
<a name="l07718"></a>07718     <span class="comment">// TODO: when we implement search, this logic will need to be more clever</span>
<a name="l07719"></a>07719     <span class="comment">// to check our full-sync range since we may indeed have cached messages</span>
<a name="l07720"></a>07720     <span class="comment">// from way in the past.</span>
<a name="l07721"></a>07721     <span class="keywordflow">if</span> (!this._headerBlockInfos.length)
<a name="l07722"></a>07722       <span class="keywordflow">return</span> (date === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> &amp;&amp; uid === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l07723"></a>07723 
<a name="l07724"></a>07724     var blockInfo = this._headerBlockInfos[this._headerBlockInfos.length - 1];
<a name="l07725"></a>07725     <span class="keywordflow">return</span> (date === blockInfo.startTS &amp;&amp;
<a name="l07726"></a>07726             uid === blockInfo.startUID);
<a name="l07727"></a>07727   },
<a name="l07728"></a>07728 
<a name="l07732"></a>07732   getNewestFullSyncDate: <span class="keyword">function</span>() {
<a name="l07733"></a>07733     <span class="comment">// If we have any accuracy range, it should be what we want.</span>
<a name="l07734"></a>07734     <span class="keywordflow">if</span> (this._accuracyRanges.length)
<a name="l07735"></a>07735       <span class="keywordflow">return</span> this._accuracyRanges[0].endTS;
<a name="l07736"></a>07736     <span class="comment">// If we have no accuracy ranges, then 0 at least safely indicates we are</span>
<a name="l07737"></a>07737     <span class="comment">// not up-to-date.</span>
<a name="l07738"></a>07738     <span class="keywordflow">return</span> 0;
<a name="l07739"></a>07739   },
<a name="l07740"></a>07740 
<a name="l07745"></a>07745   getOldestFullSyncDate: <span class="keyword">function</span>() {
<a name="l07746"></a>07746     <span class="comment">// Start at the oldest index and run towards the newest until we find a</span>
<a name="l07747"></a>07747     <span class="comment">// fully synced range or run out of ranges.</span>
<a name="l07748"></a>07748     <span class="comment">//</span>
<a name="l07749"></a>07749     <span class="comment">// We used to start at the newest and move towards the oldest since this</span>
<a name="l07750"></a>07750     <span class="comment">// checked our fully-synced-from-now invariant, but that invariant has now</span>
<a name="l07751"></a>07751     <span class="comment">// gone by the wayside and is not required for correctness for the purposes</span>
<a name="l07752"></a>07752     <span class="comment">// of us/our callers.</span>
<a name="l07753"></a>07753     var idxAR = this._accuracyRanges.length - 1;
<a name="l07754"></a>07754     <span class="comment">// Run futurewards in time until we find one without a fullSync or run out</span>
<a name="l07755"></a>07755     <span class="keywordflow">while</span> (idxAR &gt;= 0 &amp;&amp;
<a name="l07756"></a>07756            !this._accuracyRanges[idxAR].fullSync) {
<a name="l07757"></a>07757       idxAR--;
<a name="l07758"></a>07758     }
<a name="l07759"></a>07759     <span class="comment">// Sanity-check, use.</span>
<a name="l07760"></a>07760     var syncTS;
<a name="l07761"></a>07761     <span class="keywordflow">if</span> (idxAR &gt;= 0)
<a name="l07762"></a>07762       syncTS = this._accuracyRanges[idxAR].startTS;
<a name="l07763"></a>07763     <span class="keywordflow">else</span>
<a name="l07764"></a>07764       syncTS = NOW();
<a name="l07765"></a>07765     <span class="keywordflow">return</span> syncTS;
<a name="l07766"></a>07766   },
<a name="l07767"></a>07767 
<a name="l07773"></a>07773   syncedToToday: <span class="keyword">function</span>() {
<a name="l07774"></a>07774     <span class="keywordflow">if</span> (!this.folderSyncer.canGrowSync)
<a name="l07775"></a>07775       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07776"></a>07776 
<a name="l07777"></a>07777     var newestSyncTS = this.getNewestFullSyncDate();
<a name="l07778"></a>07778     <span class="keywordflow">return</span> SINCE(newestSyncTS, quantizeDate(NOW() + this._account.tzOffset));
<a name="l07779"></a>07779   },
<a name="l07780"></a>07780 
<a name="l07791"></a>07791   syncedToDawnOfTime: <span class="keyword">function</span>() {
<a name="l07792"></a>07792     <span class="keywordflow">if</span> (!this.folderSyncer.canGrowSync)
<a name="l07793"></a>07793       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07794"></a>07794 
<a name="l07795"></a>07795     var oldestSyncTS = this.getOldestFullSyncDate();
<a name="l07796"></a>07796     <span class="comment">// We add a day to the oldest sync date to allow for some timezone-related</span>
<a name="l07797"></a>07797     <span class="comment">// slop.  This is done defensively.  Unit tests ensure that our refresh of</span>
<a name="l07798"></a>07798     <span class="comment">// synced-to-the-dawn-of-time does not result in date drift that would cause</span>
<a name="l07799"></a>07799     <span class="comment">// the date to slowly move in and escape the slop.</span>
<a name="l07800"></a>07800     <span class="keywordflow">return</span> ON_OR_BEFORE(oldestSyncTS, $sync.OLDEST_SYNC_DATE + $date.DAY_MILLIS);
<a name="l07801"></a>07801   },
<a name="l07802"></a>07802 
<a name="l07806"></a>07806   getKnownMessageCount: <span class="keyword">function</span>() {
<a name="l07807"></a>07807     var <a class="code" href="../../de/deb/jsdbgapi_8h.html#af811e5c0ef06b777b160f87806b7285e">count</a> = 0;
<a name="l07808"></a>07808     <span class="keywordflow">for</span> (var i = 0; i &lt; this._headerBlockInfos.length; i++) {
<a name="l07809"></a>07809       var blockInfo = this._headerBlockInfos[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l07810"></a>07810       count += blockInfo.count;
<a name="l07811"></a>07811     }
<a name="l07812"></a>07812     <span class="keywordflow">return</span> <a class="code" href="../../de/deb/jsdbgapi_8h.html#af811e5c0ef06b777b160f87806b7285e">count</a>;
<a name="l07813"></a>07813   },
<a name="l07814"></a>07814 
<a name="l07846"></a>07846   getMessagesInImapDateRange: <span class="keyword">function</span> ifs_getMessagesInDateRange(
<a name="l07847"></a>07847       startTS, endTS, minDesired, maxDesired, messageCallback) {
<a name="l07848"></a>07848     var toFill = (minDesired != <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) ? minDesired : $sync.TOO_MANY_MESSAGES,
<a name="l07849"></a>07849         maxFill = (maxDesired != <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) ? maxDesired : $sync.TOO_MANY_MESSAGES,
<a name="l07850"></a>07850         <span class="keyword">self</span> = <span class="keyword">this</span>,
<a name="l07851"></a>07851         <span class="comment">// header block info iteration</span>
<a name="l07852"></a>07852         iHeadBlockInfo = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, headBlockInfo;
<a name="l07853"></a>07853 
<a name="l07854"></a>07854     <span class="comment">// find the first header block with the data we want</span>
<a name="l07855"></a>07855     var headerPair = this._findFirstObjIndexForDateRange(
<a name="l07856"></a>07856                        this._headerBlockInfos, startTS, endTS);
<a name="l07857"></a>07857     iHeadBlockInfo = headerPair[0];
<a name="l07858"></a>07858     headBlockInfo = headerPair[1];
<a name="l07859"></a>07859     <span class="keywordflow">if</span> (!headBlockInfo) {
<a name="l07860"></a>07860       <span class="comment">// no blocks equals no messages.</span>
<a name="l07861"></a>07861       messageCallback([], <span class="keyword">false</span>);
<a name="l07862"></a>07862       <span class="keywordflow">return</span>;
<a name="l07863"></a>07863     }
<a name="l07864"></a>07864 
<a name="l07865"></a>07865     <span class="keyword">function</span> fetchMore() {
<a name="l07866"></a>07866       <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l07867"></a>07867         <span class="comment">// - load the header block if required</span>
<a name="l07868"></a>07868         <span class="keywordflow">if</span> (!<span class="keyword">self</span>._headerBlocks.hasOwnProperty(headBlockInfo.blockId)) {
<a name="l07869"></a>07869           <span class="keyword">self</span>._loadBlock(<span class="stringliteral">&#39;header&#39;</span>, headBlockInfo, fetchMore);
<a name="l07870"></a>07870           <span class="keywordflow">return</span>;
<a name="l07871"></a>07871         }
<a name="l07872"></a>07872         var headerBlock = <span class="keyword">self</span>._headerBlocks[headBlockInfo.blockId];
<a name="l07873"></a>07873         <span class="comment">// - use up as many headers in the block as possible</span>
<a name="l07874"></a>07874         <span class="comment">// (previously used destructuring, but we want uglifyjs to work)</span>
<a name="l07875"></a>07875         var headerTuple = <span class="keyword">self</span>._findFirstObjForDateRange(
<a name="l07876"></a>07876                             headerBlock.headers,
<a name="l07877"></a>07877                             startTS, endTS),
<a name="l07878"></a>07878             iFirstHeader = headerTuple[0], header = headerTuple[1];
<a name="l07879"></a>07879         <span class="comment">// aw man, no usable messages?!</span>
<a name="l07880"></a>07880         <span class="keywordflow">if</span> (!header) {
<a name="l07881"></a>07881           messageCallback([], <span class="keyword">false</span>);
<a name="l07882"></a>07882           <span class="keywordflow">return</span>;
<a name="l07883"></a>07883         }
<a name="l07884"></a>07884         <span class="comment">// (at least one usable message)</span>
<a name="l07885"></a>07885 
<a name="l07886"></a>07886         var iHeader = iFirstHeader;
<a name="l07887"></a>07887         <span class="keywordflow">for</span> (; iHeader &lt; headerBlock.headers.length &amp;&amp; maxFill;
<a name="l07888"></a>07888              iHeader++, maxFill--) {
<a name="l07889"></a>07889           header = headerBlock.headers[iHeader];
<a name="l07890"></a>07890           <span class="comment">// (we are done if we have found a header earlier than what we want)</span>
<a name="l07891"></a>07891           <span class="keywordflow">if</span> (BEFORE(header.date, startTS))
<a name="l07892"></a>07892             <span class="keywordflow">break</span>;
<a name="l07893"></a>07893         }
<a name="l07894"></a>07894         <span class="comment">// (iHeader is pointing at the index of message we don&#39;t want)</span>
<a name="l07895"></a>07895         <span class="comment">// There is no further processing to do if we bailed early.</span>
<a name="l07896"></a>07896         <span class="keywordflow">if</span> (maxFill &amp;&amp; iHeader &lt; headerBlock.headers.length)
<a name="l07897"></a>07897           toFill = 0;
<a name="l07898"></a>07898         <span class="keywordflow">else</span>
<a name="l07899"></a>07899           toFill -= iHeader - iFirstHeader;
<a name="l07900"></a>07900 
<a name="l07901"></a>07901         <span class="keywordflow">if</span> (!toFill) {
<a name="l07902"></a>07902         }
<a name="l07903"></a>07903         <span class="comment">// - There may be viable messages in the next block, check.</span>
<a name="l07904"></a>07904         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (++iHeadBlockInfo &gt;= <span class="keyword">self</span>._headerBlockInfos.length) {
<a name="l07905"></a>07905           <span class="comment">// Nope, there are no more messages, nothing left to do.</span>
<a name="l07906"></a>07906           toFill = 0;
<a name="l07907"></a>07907         }
<a name="l07908"></a>07908         <span class="keywordflow">else</span> {
<a name="l07909"></a>07909           headBlockInfo = <span class="keyword">self</span>._headerBlockInfos[iHeadBlockInfo];
<a name="l07910"></a>07910           <span class="comment">// We may not want to go back any farther</span>
<a name="l07911"></a>07911           <span class="keywordflow">if</span> (STRICTLY_AFTER(startTS, headBlockInfo.endTS))
<a name="l07912"></a>07912             toFill = 0;
<a name="l07913"></a>07913         }
<a name="l07914"></a>07914         <span class="comment">// generate the notifications fo what we did create</span>
<a name="l07915"></a>07915         messageCallback(headerBlock.headers.slice(iFirstHeader, iHeader),
<a name="l07916"></a>07916                         Boolean(toFill));
<a name="l07917"></a>07917         <span class="keywordflow">if</span> (!toFill)
<a name="l07918"></a>07918           <span class="keywordflow">return</span>;
<a name="l07919"></a>07919         <span class="comment">// (there must be some overlap, keep going)</span>
<a name="l07920"></a>07920       }
<a name="l07921"></a>07921     }
<a name="l07922"></a>07922 
<a name="l07923"></a>07923     fetchMore();
<a name="l07924"></a>07924   },
<a name="l07925"></a>07925 
<a name="l07938"></a>07938   getAllMessagesInImapDateRange: <span class="keyword">function</span> ifs_getAllMessagesInDateRange(
<a name="l07939"></a>07939       startTS, endTS, allCallback) {
<a name="l07940"></a>07940     var allHeaders = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07941"></a>07941     <span class="keyword">function</span> someMessages(headers, moreHeadersExpected) {
<a name="l07942"></a>07942       <span class="keywordflow">if</span> (allHeaders)
<a name="l07943"></a>07943         allHeaders = allHeaders.concat(headers);
<a name="l07944"></a>07944       <span class="keywordflow">else</span>
<a name="l07945"></a>07945         allHeaders = <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>;
<a name="l07946"></a>07946       <span class="keywordflow">if</span> (!moreHeadersExpected)
<a name="l07947"></a>07947         allCallback(allHeaders);
<a name="l07948"></a>07948     }
<a name="l07949"></a>07949     this.getMessagesInImapDateRange(startTS, endTS, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, someMessages);
<a name="l07950"></a>07950   },
<a name="l07951"></a>07951 
<a name="l07959"></a>07959   getMessagesBeforeMessage: <span class="keyword">function</span>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>, limit, messageCallback) {
<a name="l07960"></a>07960     var toFill = (limit != <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) ? limit : $sync.TOO_MANY_MESSAGES, <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l07961"></a>07961 
<a name="l07962"></a>07962     var headerPair, iHeadBlockInfo, headBlockInfo;
<a name="l07963"></a>07963     <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (date) {
<a name="l07964"></a>07964       headerPair = this._findRangeObjIndexForDateAndID(
<a name="l07965"></a>07965                      this._headerBlockInfos, date, <span class="keywordtype">id</span>);
<a name="l07966"></a>07966       iHeadBlockInfo = headerPair[0];
<a name="l07967"></a>07967       headBlockInfo = headerPair[1];
<a name="l07968"></a>07968     }
<a name="l07969"></a>07969     <span class="keywordflow">else</span> {
<a name="l07970"></a>07970       iHeadBlockInfo = 0;
<a name="l07971"></a>07971       headBlockInfo = this._headerBlockInfos[0];
<a name="l07972"></a>07972     }
<a name="l07973"></a>07973 
<a name="l07974"></a>07974     <span class="keywordflow">if</span> (!headBlockInfo) {
<a name="l07975"></a>07975       <span class="comment">// The iteration request is somehow not current; log an error and return</span>
<a name="l07976"></a>07976       <span class="comment">// an empty result set.</span>
<a name="l07977"></a>07977       this._LOG.badIterationStart(date, <span class="keywordtype">id</span>);
<a name="l07978"></a>07978       messageCallback([], <span class="keyword">false</span>);
<a name="l07979"></a>07979       <span class="keywordflow">return</span>;
<a name="l07980"></a>07980     }
<a name="l07981"></a>07981 
<a name="l07982"></a>07982     var iHeader = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07983"></a>07983     <span class="keyword">function</span> fetchMore() {
<a name="l07984"></a>07984       <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l07985"></a>07985         <span class="comment">// - load the header block if required</span>
<a name="l07986"></a>07986         <span class="keywordflow">if</span> (!<span class="keyword">self</span>._headerBlocks.hasOwnProperty(headBlockInfo.blockId)) {
<a name="l07987"></a>07987           <span class="keyword">self</span>._loadBlock(<span class="stringliteral">&#39;header&#39;</span>, headBlockInfo, fetchMore);
<a name="l07988"></a>07988           <span class="keywordflow">return</span>;
<a name="l07989"></a>07989         }
<a name="l07990"></a>07990         var headerBlock = <span class="keyword">self</span>._headerBlocks[headBlockInfo.blockId];
<a name="l07991"></a>07991 
<a name="l07992"></a>07992         <span class="comment">// Null means find it by id...</span>
<a name="l07993"></a>07993         <span class="keywordflow">if</span> (iHeader === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l07994"></a>07994           <span class="keywordflow">if</span> (<span class="keywordtype">id</span> !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l07995"></a>07995             iHeader = headerBlock.ids.indexOf(<span class="keywordtype">id</span>);
<a name="l07996"></a>07996           <span class="keywordflow">else</span>
<a name="l07997"></a>07997             iHeader = 0;
<a name="l07998"></a>07998           <span class="keywordflow">if</span> (iHeader === -1) {
<a name="l07999"></a>07999             <span class="keyword">self</span>._LOG.badIterationStart(date, <span class="keywordtype">id</span>);
<a name="l08000"></a>08000             toFill = 0;
<a name="l08001"></a>08001           }
<a name="l08002"></a>08002           iHeader++;
<a name="l08003"></a>08003         }
<a name="l08004"></a>08004         <span class="comment">// otherwise we know we are starting at the front of the block.</span>
<a name="l08005"></a>08005         <span class="keywordflow">else</span> {
<a name="l08006"></a>08006           iHeader = 0;
<a name="l08007"></a>08007         }
<a name="l08008"></a>08008 
<a name="l08009"></a>08009         var useHeaders = Math.min(
<a name="l08010"></a>08010               headerBlock.headers.length - iHeader,
<a name="l08011"></a>08011               toFill);
<a name="l08012"></a>08012         <span class="keywordflow">if</span> (iHeader &gt;= headerBlock.headers.length)
<a name="l08013"></a>08013           useHeaders = 0;
<a name="l08014"></a>08014         toFill -= useHeaders;
<a name="l08015"></a>08015 
<a name="l08016"></a>08016         <span class="comment">// If there&#39;s nothing more to...</span>
<a name="l08017"></a>08017         <span class="keywordflow">if</span> (!toFill) {
<a name="l08018"></a>08018         }
<a name="l08019"></a>08019         <span class="comment">// - There may be viable messages in the next block, check.</span>
<a name="l08020"></a>08020         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (++iHeadBlockInfo &gt;= <span class="keyword">self</span>._headerBlockInfos.length) {
<a name="l08021"></a>08021           <span class="comment">// Nope, there are no more messages, nothing left to do.</span>
<a name="l08022"></a>08022           toFill = 0;
<a name="l08023"></a>08023         }
<a name="l08024"></a>08024         <span class="keywordflow">else</span> {
<a name="l08025"></a>08025           headBlockInfo = <span class="keyword">self</span>._headerBlockInfos[iHeadBlockInfo];
<a name="l08026"></a>08026         }
<a name="l08027"></a>08027         <span class="comment">// generate the notifications for what we did create</span>
<a name="l08028"></a>08028         messageCallback(headerBlock.headers.slice(iHeader,
<a name="l08029"></a>08029                                                   iHeader + useHeaders),
<a name="l08030"></a>08030                         Boolean(toFill));
<a name="l08031"></a>08031         <span class="keywordflow">if</span> (!toFill)
<a name="l08032"></a>08032           <span class="keywordflow">return</span>;
<a name="l08033"></a>08033         <span class="comment">// (there must be some overlap, keep going)</span>
<a name="l08034"></a>08034       }
<a name="l08035"></a>08035     }
<a name="l08036"></a>08036 
<a name="l08037"></a>08037     fetchMore();
<a name="l08038"></a>08038   },
<a name="l08039"></a>08039 
<a name="l08044"></a>08044   getMessagesAfterMessage: <span class="keyword">function</span>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>, limit, messageCallback) {
<a name="l08045"></a>08045     var toFill = (limit != <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) ? limit : $sync.TOO_MANY_MESSAGES, <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l08046"></a>08046 
<a name="l08047"></a>08047     var headerPair = <span class="keyword">this</span>._findRangeObjIndexForDateAndID(
<a name="l08048"></a>08048                        <span class="keyword">this</span>._headerBlockInfos, date, <span class="keywordtype">id</span>);
<a name="l08049"></a>08049     var iHeadBlockInfo = headerPair[0];
<a name="l08050"></a>08050     var headBlockInfo = headerPair[1];
<a name="l08051"></a>08051 
<a name="l08052"></a>08052     <span class="keywordflow">if</span> (!headBlockInfo) {
<a name="l08053"></a>08053       <span class="comment">// The iteration request is somehow not current; log an error and return</span>
<a name="l08054"></a>08054       <span class="comment">// an empty result set.</span>
<a name="l08055"></a>08055       this._LOG.badIterationStart(date, <span class="keywordtype">id</span>);
<a name="l08056"></a>08056       messageCallback([], <span class="keyword">false</span>);
<a name="l08057"></a>08057       <span class="keywordflow">return</span>;
<a name="l08058"></a>08058     }
<a name="l08059"></a>08059 
<a name="l08060"></a>08060     var iHeader = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08061"></a>08061     <span class="keyword">function</span> fetchMore() {
<a name="l08062"></a>08062       <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l08063"></a>08063         <span class="comment">// - load the header block if required</span>
<a name="l08064"></a>08064         <span class="keywordflow">if</span> (!<span class="keyword">self</span>._headerBlocks.hasOwnProperty(headBlockInfo.blockId)) {
<a name="l08065"></a>08065           <span class="keyword">self</span>._loadBlock(<span class="stringliteral">&#39;header&#39;</span>, headBlockInfo, fetchMore);
<a name="l08066"></a>08066           <span class="keywordflow">return</span>;
<a name="l08067"></a>08067         }
<a name="l08068"></a>08068         var headerBlock = <span class="keyword">self</span>._headerBlocks[headBlockInfo.blockId];
<a name="l08069"></a>08069 
<a name="l08070"></a>08070         <span class="comment">// Null means find it by id...</span>
<a name="l08071"></a>08071         <span class="keywordflow">if</span> (iHeader === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l08072"></a>08072           iHeader = headerBlock.ids.indexOf(<span class="keywordtype">id</span>);
<a name="l08073"></a>08073           <span class="keywordflow">if</span> (iHeader === -1) {
<a name="l08074"></a>08074             <span class="keyword">self</span>._LOG.badIterationStart(date, <span class="keywordtype">id</span>);
<a name="l08075"></a>08075             toFill = 0;
<a name="l08076"></a>08076           }
<a name="l08077"></a>08077           iHeader--;
<a name="l08078"></a>08078         }
<a name="l08079"></a>08079         <span class="comment">// otherwise we know we are starting at the end of the block (and</span>
<a name="l08080"></a>08080         <span class="comment">// moving towards the front)</span>
<a name="l08081"></a>08081         <span class="keywordflow">else</span> {
<a name="l08082"></a>08082           iHeader = headerBlock.headers.length - 1;
<a name="l08083"></a>08083         }
<a name="l08084"></a>08084 
<a name="l08085"></a>08085         var useHeaders = Math.min(iHeader + 1, toFill);
<a name="l08086"></a>08086         <span class="keywordflow">if</span> (iHeader &lt; 0)
<a name="l08087"></a>08087           useHeaders = 0;
<a name="l08088"></a>08088         toFill -= useHeaders;
<a name="l08089"></a>08089 
<a name="l08090"></a>08090         <span class="comment">// If there&#39;s nothing more to...</span>
<a name="l08091"></a>08091         <span class="keywordflow">if</span> (!toFill) {
<a name="l08092"></a>08092         }
<a name="l08093"></a>08093         <span class="comment">// - There may be viable messages in the previous block, check.</span>
<a name="l08094"></a>08094         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (--iHeadBlockInfo &lt; 0) {
<a name="l08095"></a>08095           <span class="comment">// Nope, there are no more messages, nothing left to do.</span>
<a name="l08096"></a>08096           toFill = 0;
<a name="l08097"></a>08097         }
<a name="l08098"></a>08098         <span class="keywordflow">else</span> {
<a name="l08099"></a>08099           headBlockInfo = <span class="keyword">self</span>._headerBlockInfos[iHeadBlockInfo];
<a name="l08100"></a>08100         }
<a name="l08101"></a>08101         <span class="comment">// generate the notifications for what we did create</span>
<a name="l08102"></a>08102         var messages = headerBlock.headers.slice(iHeader - useHeaders + 1,
<a name="l08103"></a>08103                                                  iHeader + 1);
<a name="l08104"></a>08104         messageCallback(messages, Boolean(toFill));
<a name="l08105"></a>08105         <span class="keywordflow">if</span> (!toFill)
<a name="l08106"></a>08106           <span class="keywordflow">return</span>;
<a name="l08107"></a>08107         <span class="comment">// (there must be some overlap, keep going)</span>
<a name="l08108"></a>08108       }
<a name="l08109"></a>08109     }
<a name="l08110"></a>08110 
<a name="l08111"></a>08111     fetchMore();
<a name="l08112"></a>08112   },
<a name="l08113"></a>08113 
<a name="l08114"></a>08114 
<a name="l08139"></a>08139   markSyncRange: <span class="keyword">function</span>(startTS, endTS, modseq, updated) {
<a name="l08140"></a>08140     <span class="comment">// If our range was marked open-ended, it&#39;s really accurate through now.</span>
<a name="l08141"></a>08141     <span class="comment">// But we don&#39;t want true UTC now, we want the now of the server in terms of</span>
<a name="l08142"></a>08142     <span class="comment">// IMAP&#39;s crazy SINCE/BEFORE quantized date-range.  If it&#39;s already tomorrow</span>
<a name="l08143"></a>08143     <span class="comment">// as far as the server is concerned date-wise, then we need to reflect that</span>
<a name="l08144"></a>08144     <span class="comment">// here.</span>
<a name="l08145"></a>08145     <span class="comment">//</span>
<a name="l08146"></a>08146     <span class="comment">// To really spell it out, let&#39;s say that it&#39;s currently daylight savings</span>
<a name="l08147"></a>08147     <span class="comment">// time, we live on the east coast (utc-4), and our server is in Europe</span>
<a name="l08148"></a>08148     <span class="comment">// (utc+2).</span>
<a name="l08149"></a>08149     <span class="comment">//</span>
<a name="l08150"></a>08150     <span class="comment">// Let&#39;s say it&#39;s 7pm, which is 11pm at utc-0 and 1am at utc+2.  NOW() is</span>
<a name="l08151"></a>08151     <span class="comment">// going to net us the 11pm value; we need to add the timezone offset of</span>
<a name="l08152"></a>08152     <span class="comment">// +2 to get to 1am, which is then what we want to use for markSyncRange.</span>
<a name="l08153"></a>08153     <span class="comment">//</span>
<a name="l08154"></a>08154     <span class="keywordflow">if</span> (!endTS)
<a name="l08155"></a>08155       endTS = NOW() + this._account.tzOffset;
<a name="l08156"></a>08156     <span class="keywordflow">if</span> (startTS &gt; endTS)
<a name="l08157"></a>08157       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Your timestamps are switched!&#39;</span>);
<a name="l08158"></a>08158 
<a name="l08159"></a>08159     var aranges = this._accuracyRanges;
<a name="l08160"></a>08160     <span class="keyword">function</span> makeRange(<a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>, <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>, modseq, updated) {
<a name="l08161"></a>08161       <span class="keywordflow">return</span> {
<a name="l08162"></a>08162         startTS: <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>, endTS: <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>,
<a name="l08163"></a>08163         <span class="comment">// let an existing fullSync be passed in instead...</span>
<a name="l08164"></a>08164         fullSync: (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(modseq) === <span class="stringliteral">&#39;string&#39;</span>) ?
<a name="l08165"></a>08165           { highestModseq: modseq, updated: updated } :
<a name="l08166"></a>08166           { highestModseq: modseq.fullSync.highestModseq,
<a name="l08167"></a>08167             updated: modseq.fullSync.updated },
<a name="l08168"></a>08168       };
<a name="l08169"></a>08169     }
<a name="l08170"></a>08170 
<a name="l08171"></a>08171     var newInfo = this._findFirstObjIndexForDateRange(aranges, startTS, endTS),
<a name="l08172"></a>08172         oldInfo = this._findLastObjIndexForDateRange(aranges, startTS, endTS),
<a name="l08173"></a>08173         newSplits, oldSplits;
<a name="l08174"></a>08174     <span class="comment">// We need to split the new block if we overlap a block and our end range</span>
<a name="l08175"></a>08175     <span class="comment">// is not &#39;outside&#39; the range.</span>
<a name="l08176"></a>08176     newSplits = newInfo[1] &amp;&amp; STRICTLY_AFTER(newInfo[1].endTS, endTS);
<a name="l08177"></a>08177     <span class="comment">// We need to split the old block if we overlap a block and our start range</span>
<a name="l08178"></a>08178     <span class="comment">// is not &#39;outside&#39; the range.</span>
<a name="l08179"></a>08179     oldSplits = oldInfo[1] &amp;&amp; BEFORE(oldInfo[1].startTS, startTS);
<a name="l08180"></a>08180 
<a name="l08181"></a>08181     var insertions = [],
<a name="l08182"></a>08182         delCount = oldInfo[0] - newInfo[0];
<a name="l08183"></a>08183     <span class="keywordflow">if</span> (oldInfo[1])
<a name="l08184"></a>08184       delCount++;
<a name="l08185"></a>08185 
<a name="l08186"></a>08186     <span class="keywordflow">if</span> (newSplits) {
<a name="l08187"></a>08187       <span class="comment">// should this just be an effective merge with our insertion?</span>
<a name="l08188"></a>08188       <span class="keywordflow">if</span> (newInfo[1].fullSync &amp;&amp;
<a name="l08189"></a>08189           newInfo[1].fullSync.highestModseq === modseq &amp;&amp;
<a name="l08190"></a>08190           newInfo[1].fullSync.updated === updated)
<a name="l08191"></a>08191         endTS = newInfo[1].endTS;
<a name="l08192"></a>08192       <span class="keywordflow">else</span>
<a name="l08193"></a>08193         insertions.push(makeRange(endTS, newInfo[1].endTS, newInfo[1]));
<a name="l08194"></a>08194     }
<a name="l08195"></a>08195     insertions.push(makeRange(startTS, endTS, modseq, updated));
<a name="l08196"></a>08196     <span class="keywordflow">if</span> (oldSplits) {
<a name="l08197"></a>08197       <span class="comment">// should this just be an effective merge with what we just inserted?</span>
<a name="l08198"></a>08198       <span class="keywordflow">if</span> (oldInfo[1].fullSync &amp;&amp;
<a name="l08199"></a>08199           oldInfo[1].fullSync.highestModseq === modseq &amp;&amp;
<a name="l08200"></a>08200           oldInfo[1].fullSync.updated === updated)
<a name="l08201"></a>08201         insertions[insertions.length-1].startTS = oldInfo[1].startTS;
<a name="l08202"></a>08202       <span class="keywordflow">else</span>
<a name="l08203"></a>08203         insertions.push(makeRange(oldInfo[1].startTS, startTS, oldInfo[1]));
<a name="l08204"></a>08204     }
<a name="l08205"></a>08205 
<a name="l08206"></a>08206     <span class="comment">// - merges</span>
<a name="l08207"></a>08207     <span class="comment">// Consider a merge if there is an adjacent accuracy range in the given dir.</span>
<a name="l08208"></a>08208     var newNeighbor = newInfo[0] &gt; 0 ? aranges[newInfo[0] - 1] : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l08209"></a>08209         oldAdjust = oldInfo[1] ? 1 : 0,
<a name="l08210"></a>08210         oldNeighbor = oldInfo[0] &lt; (aranges.length - oldAdjust) ?
<a name="l08211"></a>08211                         aranges[oldInfo[0] + oldAdjust] : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08212"></a>08212     <span class="comment">// We merge if our starts and ends line up...</span>
<a name="l08213"></a>08213     <span class="keywordflow">if</span> (newNeighbor &amp;&amp;
<a name="l08214"></a>08214        insertions[0].endTS === newNeighbor.startTS &amp;&amp;
<a name="l08215"></a>08215         newNeighbor.fullSync &amp;&amp;
<a name="l08216"></a>08216         newNeighbor.fullSync.highestModseq === modseq &amp;&amp;
<a name="l08217"></a>08217         newNeighbor.fullSync.updated === updated) {
<a name="l08218"></a>08218       insertions[0].endTS = newNeighbor.endTS;
<a name="l08219"></a>08219       newInfo[0]--;
<a name="l08220"></a>08220       delCount++;
<a name="l08221"></a>08221     }
<a name="l08222"></a>08222     <span class="keywordflow">if</span> (oldNeighbor &amp;&amp;
<a name="l08223"></a>08223         insertions[insertions.length-1].startTS === oldNeighbor.endTS &amp;&amp;
<a name="l08224"></a>08224         oldNeighbor.fullSync &amp;&amp;
<a name="l08225"></a>08225         oldNeighbor.fullSync.highestModseq === modseq &amp;&amp;
<a name="l08226"></a>08226         oldNeighbor.fullSync.updated === updated) {
<a name="l08227"></a>08227       insertions[insertions.length-1].startTS = oldNeighbor.startTS;
<a name="l08228"></a>08228       delCount++;
<a name="l08229"></a>08229     }
<a name="l08230"></a>08230 
<a name="l08231"></a>08231     aranges.splice.apply(aranges, [newInfo[0], delCount].concat(insertions));
<a name="l08232"></a>08232 
<a name="l08233"></a>08233     <span class="comment">/*lastSyncedAt depends on current timestamp of the client device</span>
<a name="l08234"></a>08234 <span class="comment">     should not be added timezone offset*/</span>
<a name="l08235"></a>08235     this.folderMeta.lastSyncedAt = NOW();
<a name="l08236"></a>08236     <span class="keywordflow">if</span> (this._account.universe)
<a name="l08237"></a>08237       this._account.universe.__notifyModifiedFolder(this._account,
<a name="l08238"></a>08238                                                     this.folderMeta);
<a name="l08239"></a>08239   },
<a name="l08240"></a>08240 
<a name="l08250"></a>08250   markSyncedToDawnOfTime: <span class="keyword">function</span>() {
<a name="l08251"></a>08251     this._LOG.syncedToDawnOfTime();
<a name="l08252"></a>08252 
<a name="l08253"></a>08253     <span class="comment">// We can just expand the first accuracy range structure to stretch to the</span>
<a name="l08254"></a>08254     <span class="comment">// dawn of time and nuke the rest.</span>
<a name="l08255"></a>08255     var aranges = this._accuracyRanges;
<a name="l08256"></a>08256     <span class="comment">// (If aranges is the empty list, there are deep invariant problems and</span>
<a name="l08257"></a>08257     <span class="comment">// the exception is desired.)</span>
<a name="l08258"></a>08258     aranges[aranges.length - 1].startTS = $sync.OLDEST_SYNC_DATE;
<a name="l08259"></a>08259   },
<a name="l08260"></a>08260 
<a name="l08268"></a>08268   clearSyncedToDawnOfTime: <span class="keyword">function</span>(newOldestTS) {
<a name="l08269"></a>08269     var aranges = this._accuracyRanges;
<a name="l08270"></a>08270     <span class="keywordflow">if</span> (!aranges.length)
<a name="l08271"></a>08271       <span class="keywordflow">return</span>;
<a name="l08272"></a>08272     var lastRange = aranges[aranges.length - 1];
<a name="l08273"></a>08273     <span class="comment">// Only update the startTS if it leaves a valid accuracy range</span>
<a name="l08274"></a>08274     <span class="keywordflow">if</span> (STRICTLY_AFTER(lastRange.endTS, newOldestTS)) {
<a name="l08275"></a>08275       lastRange.startTS = newOldestTS;
<a name="l08276"></a>08276     }
<a name="l08277"></a>08277     <span class="comment">// Otherwise, pop the range to get rid of the info.  This is a defensive</span>
<a name="l08278"></a>08278     <span class="comment">// programming thing; we do not expect this case to happen, so we log.</span>
<a name="l08279"></a>08279     <span class="keywordflow">else</span> {
<a name="l08280"></a>08280       this._LOG.accuracyRangeSuspect(lastRange);
<a name="l08281"></a>08281       aranges.pop();
<a name="l08282"></a>08282     }
<a name="l08283"></a>08283   },
<a name="l08284"></a>08284 
<a name="l08322"></a>08322   checkAccuracyCoverageNeedingRefresh: <span class="keyword">function</span>(startTS, endTS, threshMS) {
<a name="l08323"></a>08323     var aranges = this._accuracyRanges, arange,
<a name="l08324"></a>08324         newInfo = this._findFirstObjIndexForDateRange(aranges, startTS, endTS),
<a name="l08325"></a>08325         oldInfo = this._findLastObjIndexForDateRange(aranges, startTS, endTS),
<a name="l08326"></a>08326         recencyCutoff = NOW() - threshMS;
<a name="l08327"></a>08327     var <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a> = { startTS: startTS, endTS: endTS };
<a name="l08328"></a>08328     <span class="keywordflow">if</span> (newInfo[1]) {
<a name="l08329"></a>08329       <span class="comment">// - iterate from the &#39;end&#39;, trying to push things as far as we can go.</span>
<a name="l08330"></a>08330       var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l08331"></a>08331       <span class="keywordflow">for</span> (i = newInfo[0]; i &lt;= oldInfo[0]; i++) {
<a name="l08332"></a>08332         arange = aranges[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08333"></a>08333         <span class="comment">// skip out if this range would cause a gap (will not happen in base</span>
<a name="l08334"></a>08334         <span class="comment">// case.)</span>
<a name="l08335"></a>08335         <span class="keywordflow">if</span> (BEFORE(arange.endTS, result.endTS))
<a name="l08336"></a>08336           <span class="keywordflow">break</span>;
<a name="l08337"></a>08337         <span class="comment">// skip out if this range was not fully updated or the data is too old</span>
<a name="l08338"></a>08338         <span class="keywordflow">if</span> (!arange.fullSync ||
<a name="l08339"></a>08339             BEFORE(arange.fullSync.updated, recencyCutoff))
<a name="l08340"></a>08340           <span class="keywordflow">break</span>;
<a name="l08341"></a>08341         <span class="comment">// if the range covers all of us or further than we need, we are done.</span>
<a name="l08342"></a>08342         <span class="keywordflow">if</span> (ON_OR_BEFORE(arange.startTS, result.startTS))
<a name="l08343"></a>08343           <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08344"></a>08344         <span class="comment">// the range only partially covers us; shrink our range and keep going</span>
<a name="l08345"></a>08345         result.endTS = arange.startTS;
<a name="l08346"></a>08346       }
<a name="l08347"></a>08347       <span class="comment">// - iterate from the &#39;start&#39;, trying to push things as far as we can go.</span>
<a name="l08348"></a>08348       <span class="comment">// (if we are here, we must not completely cover the range.)</span>
<a name="l08349"></a>08349       <span class="keywordflow">for</span> (i = oldInfo[0]; i &gt;= 0; i--) {
<a name="l08350"></a>08350         arange = aranges[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08351"></a>08351         <span class="comment">// skip out if this range would cause a gap</span>
<a name="l08352"></a>08352         <span class="keywordflow">if</span> (STRICTLY_AFTER(arange.startTS, result.startTS))
<a name="l08353"></a>08353           <span class="keywordflow">break</span>;
<a name="l08354"></a>08354         <span class="comment">// skip out if this range was not fully updated or the data is too old</span>
<a name="l08355"></a>08355         <span class="keywordflow">if</span> (!arange.fullSync ||
<a name="l08356"></a>08356             BEFORE(arange.fullSync.updated, recencyCutoff))
<a name="l08357"></a>08357           <span class="keywordflow">break</span>;
<a name="l08358"></a>08358         <span class="comment">// the range only partially covers us; shrink our range and keep going</span>
<a name="l08359"></a>08359         result.startTS = arange.endTS;
<a name="l08360"></a>08360       }
<a name="l08361"></a>08361     }
<a name="l08362"></a>08362     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>;
<a name="l08363"></a>08363   },
<a name="l08364"></a>08364 
<a name="l08379"></a>08379   getMessage: <span class="keyword">function</span>(suid, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08380"></a>08380     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(options) === <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l08381"></a>08381       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>;
<a name="l08382"></a>08382       options = undefined;
<a name="l08383"></a>08383     }
<a name="l08384"></a>08384 
<a name="l08385"></a>08385     var <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>;
<a name="l08386"></a>08386     var body;
<a name="l08387"></a>08387     var pending = 2;
<a name="l08388"></a>08388 
<a name="l08389"></a>08389     <span class="keyword">function</span> next() {
<a name="l08390"></a>08390       <span class="keywordflow">if</span> (!--pending) {
<a name="l08391"></a>08391         <span class="keywordflow">if</span> (!body || !header) {
<a name="l08392"></a>08392           <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l08393"></a>08393         }
<a name="l08394"></a>08394 
<a name="l08395"></a>08395         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>({ header: <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body: body });
<a name="l08396"></a>08396       }
<a name="l08397"></a>08397     }
<a name="l08398"></a>08398 
<a name="l08399"></a>08399     this.getMessageHeader(suid, date, <span class="keyword">function</span>(_header) {
<a name="l08400"></a>08400       header = _header;
<a name="l08401"></a>08401       next();
<a name="l08402"></a>08402     });
<a name="l08403"></a>08403 
<a name="l08404"></a>08404     var gotBody = <span class="keyword">function</span> gotBody(_body) {
<a name="l08405"></a>08405       body = _body;
<a name="l08406"></a>08406       next();
<a name="l08407"></a>08407     };
<a name="l08408"></a>08408 
<a name="l08409"></a>08409     <span class="keywordflow">if</span> (options &amp;&amp; options.withBodyReps) {
<a name="l08410"></a>08410       this.getMessageBodyWithReps(suid, date, gotBody);
<a name="l08411"></a>08411     } <span class="keywordflow">else</span> {
<a name="l08412"></a>08412       this.getMessageBody(suid, date, gotBody);
<a name="l08413"></a>08413     }
<a name="l08414"></a>08414   },
<a name="l08415"></a>08415 
<a name="l08420"></a>08420   getMessageHeader: <span class="keyword">function</span> ifs_getMessageHeader(suid, date, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08421"></a>08421     var <span class="keywordtype">id</span> = parseInt(suid.substring(suid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>) + 1)),
<a name="l08422"></a>08422         posInfo = this._findRangeObjIndexForDateAndID(this._headerBlockInfos,
<a name="l08423"></a>08423                                                       date, <span class="keywordtype">id</span>);
<a name="l08424"></a>08424     <span class="keywordflow">if</span> (posInfo[1] === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l08425"></a>08425       this._LOG.headerNotFound();
<a name="l08426"></a>08426       <span class="keywordflow">try</span> {
<a name="l08427"></a>08427         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l08428"></a>08428       }
<a name="l08429"></a>08429       <span class="keywordflow">catch</span> (ex) {
<a name="l08430"></a>08430         this._LOG.callbackErr(ex);
<a name="l08431"></a>08431       }
<a name="l08432"></a>08432       <span class="keywordflow">return</span>;
<a name="l08433"></a>08433     }
<a name="l08434"></a>08434     var headerBlockInfo = posInfo[1], <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l08435"></a>08435     <span class="keywordflow">if</span> (!(this._headerBlocks.hasOwnProperty(headerBlockInfo.blockId))) {
<a name="l08436"></a>08436       this._loadBlock(<span class="stringliteral">&#39;header&#39;</span>, headerBlockInfo, <span class="keyword">function</span>(headerBlock) {
<a name="l08437"></a>08437           var idx = headerBlock.ids.indexOf(<span class="keywordtype">id</span>);
<a name="l08438"></a>08438           var headerInfo = headerBlock.headers[idx] || <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08439"></a>08439           <span class="keywordflow">if</span> (!headerInfo)
<a name="l08440"></a>08440             <span class="keyword">self</span>._LOG.headerNotFound();
<a name="l08441"></a>08441           <span class="keywordflow">try</span> {
<a name="l08442"></a>08442             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(headerInfo);
<a name="l08443"></a>08443           }
<a name="l08444"></a>08444           <span class="keywordflow">catch</span> (ex) {
<a name="l08445"></a>08445             <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l08446"></a>08446           }
<a name="l08447"></a>08447         });
<a name="l08448"></a>08448       <span class="keywordflow">return</span>;
<a name="l08449"></a>08449     }
<a name="l08450"></a>08450     var block = this._headerBlocks[headerBlockInfo.blockId],
<a name="l08451"></a>08451         idx = block.ids.indexOf(<span class="keywordtype">id</span>),
<a name="l08452"></a>08452         headerInfo = block.headers[idx] || <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08453"></a>08453     <span class="keywordflow">if</span> (!headerInfo)
<a name="l08454"></a>08454       this._LOG.headerNotFound();
<a name="l08455"></a>08455     <span class="keywordflow">try</span> {
<a name="l08456"></a>08456       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(headerInfo);
<a name="l08457"></a>08457     }
<a name="l08458"></a>08458     <span class="keywordflow">catch</span> (ex) {
<a name="l08459"></a>08459       this._LOG.callbackErr(ex);
<a name="l08460"></a>08460     }
<a name="l08461"></a>08461   },
<a name="l08462"></a>08462 
<a name="l08466"></a>08466   getMessageHeaders: <span class="keyword">function</span> ifs_getMessageHeaders(namers, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08467"></a>08467     var pending = namers.length;
<a name="l08468"></a>08468 
<a name="l08469"></a>08469     var headers = [];
<a name="l08470"></a>08470     var gotHeader = <span class="keyword">function</span> gotHeader(header) {
<a name="l08471"></a>08471       <span class="keywordflow">if</span> (header) {
<a name="l08472"></a>08472         headers.push(header);
<a name="l08473"></a>08473       }
<a name="l08474"></a>08474 
<a name="l08475"></a>08475       <span class="keywordflow">if</span> (!--pending) {
<a name="l08476"></a>08476         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(headers);
<a name="l08477"></a>08477       }
<a name="l08478"></a>08478     };
<a name="l08479"></a>08479     <span class="keywordflow">for</span> (var i = 0; i &lt; namers.length; i++) {
<a name="l08480"></a>08480       var namer = namers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08481"></a>08481       this.getMessageHeader(namer.suid, namer.date, gotHeader);
<a name="l08482"></a>08482     }
<a name="l08483"></a>08483   },
<a name="l08484"></a>08484 
<a name="l08488"></a>08488   addMessageHeader: <span class="keyword">function</span> ifs_addMessageHeader(header, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08489"></a>08489     <span class="keywordflow">if</span> (this._pendingLoads.length) {
<a name="l08490"></a>08490       this._deferredCalls.push(this.addMessageHeader.bind(
<a name="l08491"></a>08491                                  <span class="keyword">this</span>, header, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>));
<a name="l08492"></a>08492       <span class="keywordflow">return</span>;
<a name="l08493"></a>08493     }
<a name="l08494"></a>08494     this._LOG.addMessageHeader(header.date, header.id, header.srvid);
<a name="l08495"></a>08495 
<a name="l08496"></a>08496     <span class="keywordflow">if</span> (this._curSyncSlice &amp;&amp; !this._curSyncSlice.ignoreHeaders)
<a name="l08497"></a>08497       this._curSyncSlice.onHeaderAdded(header, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l08498"></a>08498     <span class="comment">// - Generate notifications for (other) interested slices</span>
<a name="l08499"></a>08499     <span class="keywordflow">if</span> (this._slices.length &gt; (<span class="keyword">this</span>._curSyncSlice ? 1 : 0)) {
<a name="l08500"></a>08500       var date = header.date, uid = header.id;
<a name="l08501"></a>08501       <span class="keywordflow">for</span> (var iSlice = 0; iSlice &lt; this._slices.length; iSlice++) {
<a name="l08502"></a>08502         var slice = this._slices[iSlice];
<a name="l08503"></a>08503         <span class="keywordflow">if</span> (slice === this._curSyncSlice)
<a name="l08504"></a>08504           <span class="keywordflow">continue</span>;
<a name="l08505"></a>08505 
<a name="l08506"></a>08506         <span class="comment">// Note: the following control flow is to decide when to bail; if we</span>
<a name="l08507"></a>08507         <span class="comment">// make it through the conditionals, the header gets reported to the</span>
<a name="l08508"></a>08508         <span class="comment">// slice.</span>
<a name="l08509"></a>08509 
<a name="l08510"></a>08510         <span class="comment">// (if the slice is empty, it cares about any header, so keep going)</span>
<a name="l08511"></a>08511         <span class="keywordflow">if</span> (slice.startTS !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l08512"></a>08512           <span class="comment">// We never automatically grow a slice into the past if we are full,</span>
<a name="l08513"></a>08513           <span class="comment">// but we do allow it if not full.</span>
<a name="l08514"></a>08514           <span class="keywordflow">if</span> (BEFORE(date, slice.startTS)) {
<a name="l08515"></a>08515             <span class="keywordflow">if</span> (slice.headers.length &gt;= slice.desiredHeaders)
<a name="l08516"></a>08516               <span class="keywordflow">continue</span>;
<a name="l08517"></a>08517           }
<a name="l08518"></a>08518           <span class="comment">// We do grow a slice into the present if it&#39;s already up-to-date.</span>
<a name="l08519"></a>08519           <span class="comment">// We do count messages from the same second as our</span>
<a name="l08520"></a>08520           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SINCE(date, slice.endTS)) {
<a name="l08521"></a>08521             <span class="comment">// !(covers most recently known message)</span>
<a name="l08522"></a>08522             <span class="keywordflow">if</span>(!(this._headerBlockInfos.length &amp;&amp;
<a name="l08523"></a>08523                  slice.endTS === <span class="keyword">this</span>._headerBlockInfos[0].endTS &amp;&amp;
<a name="l08524"></a>08524                  slice.endUID === <span class="keyword">this</span>._headerBlockInfos[0].endUID))
<a name="l08525"></a>08525               <span class="keywordflow">continue</span>;
<a name="l08526"></a>08526           }
<a name="l08527"></a>08527           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((date === slice.startTS &amp;&amp;
<a name="l08528"></a>08528                     uid &lt; slice.startUID) ||
<a name="l08529"></a>08529                    (date === slice.endTS &amp;&amp;
<a name="l08530"></a>08530                     uid &gt; slice.endUID)) {
<a name="l08531"></a>08531             <span class="keywordflow">continue</span>;
<a name="l08532"></a>08532           }
<a name="l08533"></a>08533         }
<a name="l08534"></a>08534         <span class="keywordflow">else</span> {
<a name="l08535"></a>08535           <span class="comment">// Make sure to increase the number of desired headers so the</span>
<a name="l08536"></a>08536           <span class="comment">// truncating heuristic won&#39;t rule the header out.</span>
<a name="l08537"></a>08537           slice.desiredHeaders++;
<a name="l08538"></a>08538         }
<a name="l08539"></a>08539 
<a name="l08540"></a>08540         <span class="keywordflow">if</span> (slice._onAddingHeader)
<a name="l08541"></a>08541           slice._onAddingHeader(header);
<a name="l08542"></a>08542 
<a name="l08543"></a>08543         slice.onHeaderAdded(header, <span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l08544"></a>08544       }
<a name="l08545"></a>08545     }
<a name="l08546"></a>08546 
<a name="l08547"></a>08547 
<a name="l08548"></a>08548     this._insertIntoBlockUsingDateAndUID(
<a name="l08549"></a>08549       <span class="stringliteral">&#39;header&#39;</span>, header.date, header.id, header.srvid,
<a name="l08550"></a>08550       $sync.HEADER_EST_SIZE_IN_BYTES, header, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l08551"></a>08551   },
<a name="l08552"></a>08552 
<a name="l08565"></a>08565   updateMessageHeader: <span class="keyword">function</span> ifs_updateMessageHeader(date, <span class="keywordtype">id</span>, partOfSync,
<a name="l08566"></a>08566                                                         headerOrMutationFunc,
<a name="l08567"></a>08567                                                         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08568"></a>08568     <span class="comment">// (While this method can complete synchronously, we want to maintain its</span>
<a name="l08569"></a>08569     <span class="comment">// perceived ordering relative to those that cannot be.)</span>
<a name="l08570"></a>08570     <span class="keywordflow">if</span> (this._pendingLoads.length) {
<a name="l08571"></a>08571       this._deferredCalls.push(this.updateMessageHeader.bind(
<a name="l08572"></a>08572                                  <span class="keyword">this</span>, date, <span class="keywordtype">id</span>, partOfSync,
<a name="l08573"></a>08573                                  headerOrMutationFunc, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>));
<a name="l08574"></a>08574       <span class="keywordflow">return</span>;
<a name="l08575"></a>08575     }
<a name="l08576"></a>08576 
<a name="l08577"></a>08577     <span class="comment">// We need to deal with the potential for the block having been discarded</span>
<a name="l08578"></a>08578     <span class="comment">// from memory thanks to the potential asynchrony due to pending loads or</span>
<a name="l08579"></a>08579     <span class="comment">// on the part of the caller.</span>
<a name="l08580"></a>08580     var infoTuple = this._findRangeObjIndexForDateAndID(
<a name="l08581"></a>08581                       this._headerBlockInfos, date, <span class="keywordtype">id</span>),
<a name="l08582"></a>08582         iInfo = infoTuple[0], info = infoTuple[1], <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l08583"></a>08583     <span class="keyword">function</span> doUpdateHeader(block) {
<a name="l08584"></a>08584       var idx = block.ids.indexOf(<span class="keywordtype">id</span>), <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>;
<a name="l08585"></a>08585       <span class="keywordflow">if</span> (idx === -1) {
<a name="l08586"></a>08586         <span class="comment">// Call the mutation func with null to let it know we couldn&#39;t find the</span>
<a name="l08587"></a>08587         <span class="comment">// header.</span>
<a name="l08588"></a>08588         <span class="keywordflow">if</span> (headerOrMutationFunc instanceof Function)
<a name="l08589"></a>08589           headerOrMutationFunc(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l08590"></a>08590         <span class="keywordflow">else</span>
<a name="l08591"></a>08591           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Failed to find ID &#39;</span> + <span class="keywordtype">id</span> + <span class="charliteral">&#39;!&#39;</span>);
<a name="l08592"></a>08592       }
<a name="l08593"></a>08593       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (headerOrMutationFunc instanceof Function) {
<a name="l08594"></a>08594         <span class="comment">// If it returns false it means that the header did not change and so</span>
<a name="l08595"></a>08595         <span class="comment">// there is no need to mark anything dirty and we can leave without</span>
<a name="l08596"></a>08596         <span class="comment">// notifying anyone.</span>
<a name="l08597"></a>08597         <span class="keywordflow">if</span> (!headerOrMutationFunc((header = block.headers[idx])))
<a name="l08598"></a>08598           header = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08599"></a>08599       }
<a name="l08600"></a>08600       <span class="keywordflow">else</span> {
<a name="l08601"></a>08601         header = block.headers[idx] = headerOrMutationFunc;
<a name="l08602"></a>08602       }
<a name="l08603"></a>08603       <span class="comment">// only dirty us and generate notifications if there is a header</span>
<a name="l08604"></a>08604       <span class="keywordflow">if</span> (header) {
<a name="l08605"></a>08605         <span class="keyword">self</span>._dirty = <span class="keyword">true</span>;
<a name="l08606"></a>08606         <span class="keyword">self</span>._dirtyHeaderBlocks[info.blockId] = block;
<a name="l08607"></a>08607 
<a name="l08608"></a>08608         <span class="keyword">self</span>._LOG.updateMessageHeader(header.date, header.id, header.srvid);
<a name="l08609"></a>08609 
<a name="l08610"></a>08610         <span class="keywordflow">if</span> (<span class="keyword">self</span>._slices.length &gt; (<span class="keyword">self</span>._curSyncSlice ? 1 : 0)) {
<a name="l08611"></a>08611           <span class="keywordflow">for</span> (var iSlice = 0; iSlice &lt; <span class="keyword">self</span>._slices.length; iSlice++) {
<a name="l08612"></a>08612             var slice = <span class="keyword">self</span>._slices[iSlice];
<a name="l08613"></a>08613             <span class="keywordflow">if</span> (partOfSync &amp;&amp; slice === <span class="keyword">self</span>._curSyncSlice)
<a name="l08614"></a>08614               <span class="keywordflow">continue</span>;
<a name="l08615"></a>08615             <span class="keywordflow">if</span> (BEFORE(date, slice.startTS) ||
<a name="l08616"></a>08616                 STRICTLY_AFTER(date, slice.endTS))
<a name="l08617"></a>08617               <span class="keywordflow">continue</span>;
<a name="l08618"></a>08618             <span class="keywordflow">if</span> ((date === slice.startTS &amp;&amp;
<a name="l08619"></a>08619                  <span class="keywordtype">id</span> &lt; slice.startUID) ||
<a name="l08620"></a>08620                 (date === slice.endTS &amp;&amp;
<a name="l08621"></a>08621                  <span class="keywordtype">id</span> &gt; slice.endUID))
<a name="l08622"></a>08622               <span class="keywordflow">continue</span>;
<a name="l08623"></a>08623             slice.onHeaderModified(header);
<a name="l08624"></a>08624           }
<a name="l08625"></a>08625         }
<a name="l08626"></a>08626       }
<a name="l08627"></a>08627       <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>)
<a name="l08628"></a>08628         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l08629"></a>08629     }
<a name="l08630"></a>08630     <span class="keywordflow">if</span> (!info) {
<a name="l08631"></a>08631       <span class="keywordflow">if</span> (headerOrMutationFunc instanceof Function)
<a name="l08632"></a>08632         headerOrMutationFunc(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l08633"></a>08633       <span class="keywordflow">else</span>
<a name="l08634"></a>08634         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Failed to find block containing header with date: &#39;</span> +
<a name="l08635"></a>08635                         date + <span class="stringliteral">&#39; id: &#39;</span> + <span class="keywordtype">id</span>);
<a name="l08636"></a>08636     }
<a name="l08637"></a>08637     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!this._headerBlocks.hasOwnProperty(info.blockId))
<a name="l08638"></a>08638       this._loadBlock(<span class="stringliteral">&#39;header&#39;</span>, info, doUpdateHeader);
<a name="l08639"></a>08639     <span class="keywordflow">else</span>
<a name="l08640"></a>08640       doUpdateHeader(this._headerBlocks[info.blockId]);
<a name="l08641"></a>08641   },
<a name="l08642"></a>08642 
<a name="l08646"></a>08646   updateMessageHeaderByServerId: <span class="keyword">function</span>(srvid, partOfSync,
<a name="l08647"></a>08647                                           headerOrMutationFunc) {
<a name="l08648"></a>08648     <span class="keywordflow">if</span> (this._pendingLoads.length) {
<a name="l08649"></a>08649       this._deferredCalls.push(this.updateMessageHeaderByServerId.bind(
<a name="l08650"></a>08650         <span class="keyword">this</span>, srvid, partOfSync, headerOrMutationFunc));
<a name="l08651"></a>08651       <span class="keywordflow">return</span>;
<a name="l08652"></a>08652     }
<a name="l08653"></a>08653 
<a name="l08654"></a>08654     var blockId = this._serverIdHeaderBlockMapping[srvid];
<a name="l08655"></a>08655     <span class="keywordflow">if</span> (srvid === undefined) {
<a name="l08656"></a>08656       this._LOG.serverIdMappingMissing(srvid);
<a name="l08657"></a>08657       <span class="keywordflow">return</span>;
<a name="l08658"></a>08658     }
<a name="l08659"></a>08659 
<a name="l08660"></a>08660     var findInBlock = <span class="keyword">function</span> findInBlock(headerBlock) {
<a name="l08661"></a>08661       var headers = headerBlock.headers;
<a name="l08662"></a>08662       <span class="keywordflow">for</span> (var i = 0; i &lt; headers.length; i++) {
<a name="l08663"></a>08663         var header = headers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08664"></a>08664         <span class="keywordflow">if</span> (header.srvid === srvid) {
<a name="l08665"></a>08665           <span class="comment">// future work: this method will duplicate some work to re-locate</span>
<a name="l08666"></a>08666           <span class="comment">// the header; we could try and avoid doing that.</span>
<a name="l08667"></a>08667           this.updateMessageHeader(
<a name="l08668"></a>08668             header.date, header.id, partOfSync, headerOrMutationFunc);
<a name="l08669"></a>08669           <span class="keywordflow">return</span>;
<a name="l08670"></a>08670         }
<a name="l08671"></a>08671       }
<a name="l08672"></a>08672     }.bind(<span class="keyword">this</span>);
<a name="l08673"></a>08673 
<a name="l08674"></a>08674     <span class="keywordflow">if</span> (this._headerBlocks.hasOwnProperty(blockId)) {
<a name="l08675"></a>08675       findInBlock(this._headerBlocks[blockId]);
<a name="l08676"></a>08676     }
<a name="l08677"></a>08677     <span class="keywordflow">else</span> {
<a name="l08678"></a>08678       var blockInfo = this._findBlockInfoFromBlockId(<span class="stringliteral">&#39;header&#39;</span>, blockId);
<a name="l08679"></a>08679       this._loadBlock(<span class="stringliteral">&#39;header&#39;</span>, blockInfo, findInBlock);
<a name="l08680"></a>08680     }
<a name="l08681"></a>08681   },
<a name="l08682"></a>08682 
<a name="l08686"></a>08686   unchangedMessageHeader: <span class="keyword">function</span> ifs_unchangedMessageHeader(header) {
<a name="l08687"></a>08687     <span class="keywordflow">if</span> (this._pendingLoads.length) {
<a name="l08688"></a>08688       this._deferredCalls.push(this.unchangedMessageHeader.bind(<span class="keyword">this</span>, header));
<a name="l08689"></a>08689       <span class="keywordflow">return</span>;
<a name="l08690"></a>08690     }
<a name="l08691"></a>08691     <span class="comment">// (no block update required)</span>
<a name="l08692"></a>08692     <span class="keywordflow">if</span> (this._curSyncSlice &amp;&amp; !this._curSyncSlice.ignoreHeaders)
<a name="l08693"></a>08693       this._curSyncSlice.onHeaderAdded(header, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l08694"></a>08694   },
<a name="l08695"></a>08695 
<a name="l08696"></a>08696   hasMessageWithServerId: <span class="keyword">function</span>(srvid) {
<a name="l08697"></a>08697     <span class="keywordflow">if</span> (!this._serverIdHeaderBlockMapping)
<a name="l08698"></a>08698       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Server ID mapping not supported for this storage!&#39;</span>);
<a name="l08699"></a>08699 
<a name="l08700"></a>08700     var blockId = this._serverIdHeaderBlockMapping[srvid];
<a name="l08701"></a>08701     <span class="keywordflow">if</span> (srvid === undefined) {
<a name="l08702"></a>08702       this._LOG.serverIdMappingMissing(srvid);
<a name="l08703"></a>08703       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l08704"></a>08704     }
<a name="l08705"></a>08705 
<a name="l08706"></a>08706     <span class="keywordflow">return</span> !!blockId;
<a name="l08707"></a>08707   },
<a name="l08708"></a>08708 
<a name="l08709"></a>08709   deleteMessageHeaderAndBody: <span class="keyword">function</span>(suid, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08710"></a>08710     this.getMessageHeader(suid, date, <span class="keyword">function</span>(header) {
<a name="l08711"></a>08711       <span class="keywordflow">if</span> (header)
<a name="l08712"></a>08712         this.deleteMessageHeaderAndBodyUsingHeader(header, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l08713"></a>08713       <span class="keywordflow">else</span>
<a name="l08714"></a>08714         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l08715"></a>08715     }.bind(<span class="keyword">this</span>));
<a name="l08716"></a>08716   },
<a name="l08717"></a>08717 
<a name="l08718"></a>08718   deleteMessageHeaderAndBodyUsingHeader: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08719"></a>08719     <span class="keywordflow">if</span> (this._pendingLoads.length) {
<a name="l08720"></a>08720       this._deferredCalls.push(this.deleteMessageHeaderAndBodyUsingHeader.bind(
<a name="l08721"></a>08721                                <span class="keyword">this</span>, header, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>));
<a name="l08722"></a>08722       <span class="keywordflow">return</span>;
<a name="l08723"></a>08723     }
<a name="l08724"></a>08724 
<a name="l08725"></a>08725     <span class="keywordflow">if</span> (this._curSyncSlice &amp;&amp; !this._curSyncSlice.ignoreHeaders)
<a name="l08726"></a>08726       this._curSyncSlice.onHeaderRemoved(header);
<a name="l08727"></a>08727     <span class="keywordflow">if</span> (this._slices.length &gt; (<span class="keyword">this</span>._curSyncSlice ? 1 : 0)) {
<a name="l08728"></a>08728       <span class="keywordflow">for</span> (var iSlice = 0; iSlice &lt; this._slices.length; iSlice++) {
<a name="l08729"></a>08729         var slice = this._slices[iSlice];
<a name="l08730"></a>08730         <span class="keywordflow">if</span> (slice === this._curSyncSlice)
<a name="l08731"></a>08731           <span class="keywordflow">continue</span>;
<a name="l08732"></a>08732         <span class="keywordflow">if</span> (BEFORE(header.date, slice.startTS) ||
<a name="l08733"></a>08733             STRICTLY_AFTER(header.date, slice.endTS))
<a name="l08734"></a>08734           <span class="keywordflow">continue</span>;
<a name="l08735"></a>08735         <span class="keywordflow">if</span> ((header.date === slice.startTS &amp;&amp;
<a name="l08736"></a>08736              header.id &lt; slice.startUID) ||
<a name="l08737"></a>08737             (header.date === slice.endTS &amp;&amp;
<a name="l08738"></a>08738              header.id &gt; slice.endUID))
<a name="l08739"></a>08739           <span class="keywordflow">continue</span>;
<a name="l08740"></a>08740         slice.onHeaderRemoved(header);
<a name="l08741"></a>08741       }
<a name="l08742"></a>08742     }
<a name="l08743"></a>08743 
<a name="l08744"></a>08744     <span class="keywordflow">if</span> (this._serverIdHeaderBlockMapping &amp;&amp; header.srvid)
<a name="l08745"></a>08745       <span class="keyword">delete</span> this._serverIdHeaderBlockMapping[header.srvid];
<a name="l08746"></a>08746 
<a name="l08747"></a>08747     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a> = allbackMaker([<span class="stringliteral">&#39;header&#39;</span>, <span class="stringliteral">&#39;body&#39;</span>], <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l08748"></a>08748     this._deleteFromBlock(<span class="stringliteral">&#39;header&#39;</span>, header.date, header.id, callbacks.header);
<a name="l08749"></a>08749     this._deleteFromBlock(<span class="stringliteral">&#39;body&#39;</span>, header.date, header.id, callbacks.body);
<a name="l08750"></a>08750   },
<a name="l08751"></a>08751 
<a name="l08758"></a>08758   deleteMessageByServerId: <span class="keyword">function</span>(srvid) {
<a name="l08759"></a>08759     <span class="keywordflow">if</span> (!this._serverIdHeaderBlockMapping)
<a name="l08760"></a>08760       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Server ID mapping not supported for this storage!&#39;</span>);
<a name="l08761"></a>08761 
<a name="l08762"></a>08762     <span class="keywordflow">if</span> (this._pendingLoads.length) {
<a name="l08763"></a>08763       this._deferredCalls.push(this.deleteMessageByServerId.bind(<span class="keyword">this</span>, srvid));
<a name="l08764"></a>08764       <span class="keywordflow">return</span>;
<a name="l08765"></a>08765     }
<a name="l08766"></a>08766 
<a name="l08767"></a>08767     var blockId = this._serverIdHeaderBlockMapping[srvid];
<a name="l08768"></a>08768     <span class="keywordflow">if</span> (srvid === undefined) {
<a name="l08769"></a>08769       this._LOG.serverIdMappingMissing(srvid);
<a name="l08770"></a>08770       <span class="keywordflow">return</span>;
<a name="l08771"></a>08771     }
<a name="l08772"></a>08772 
<a name="l08773"></a>08773     var findInBlock = <span class="keyword">function</span> findInBlock(headerBlock) {
<a name="l08774"></a>08774       var headers = headerBlock.headers;
<a name="l08775"></a>08775       <span class="keywordflow">for</span> (var i = 0; i &lt; headers.length; i++) {
<a name="l08776"></a>08776         var header = headers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08777"></a>08777         <span class="keywordflow">if</span> (header.srvid === srvid) {
<a name="l08778"></a>08778           this.deleteMessageHeaderAndBodyUsingHeader(header);
<a name="l08779"></a>08779           <span class="keywordflow">return</span>;
<a name="l08780"></a>08780         }
<a name="l08781"></a>08781       }
<a name="l08782"></a>08782     }.bind(<span class="keyword">this</span>);
<a name="l08783"></a>08783 
<a name="l08784"></a>08784     <span class="keywordflow">if</span> (this._headerBlocks.hasOwnProperty(blockId)) {
<a name="l08785"></a>08785       findInBlock(this._headerBlocks[blockId]);
<a name="l08786"></a>08786     }
<a name="l08787"></a>08787     <span class="keywordflow">else</span> {
<a name="l08788"></a>08788       var blockInfo = this._findBlockInfoFromBlockId(<span class="stringliteral">&#39;header&#39;</span>, blockId);
<a name="l08789"></a>08789       this._loadBlock(<span class="stringliteral">&#39;header&#39;</span>, blockInfo, findInBlock);
<a name="l08790"></a>08790     }
<a name="l08791"></a>08791   },
<a name="l08792"></a>08792 
<a name="l08797"></a>08797   addMessageBody: <span class="keyword">function</span> ifs_addMessageBody(header, bodyInfo, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08798"></a>08798     <span class="keywordflow">if</span> (this._pendingLoads.length) {
<a name="l08799"></a>08799       this._deferredCalls.push(this.addMessageBody.bind(
<a name="l08800"></a>08800                                  <span class="keyword">this</span>, header, bodyInfo, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>));
<a name="l08801"></a>08801       <span class="keywordflow">return</span>;
<a name="l08802"></a>08802     }
<a name="l08803"></a>08803     this._LOG.addMessageBody(header.date, header.id, header.srvid);
<a name="l08804"></a>08804 
<a name="l08805"></a>08805     <span class="comment">// crappy size estimates where we assume the world is ASCII and so a UTF-8</span>
<a name="l08806"></a>08806     <span class="comment">// encoding will take exactly 1 byte per character.</span>
<a name="l08807"></a>08807     var sizeEst = OBJ_OVERHEAD_EST + NUM_ATTR_OVERHEAD_EST +
<a name="l08808"></a>08808                     4 * NULL_ATTR_OVERHEAD_EST;
<a name="l08809"></a>08809     <span class="keyword">function</span> sizifyAddrs(addrs) {
<a name="l08810"></a>08810       sizeEst += LIST_ATTR_OVERHEAD_EST;
<a name="l08811"></a>08811       <span class="keywordflow">if</span> (!addrs)
<a name="l08812"></a>08812         <span class="keywordflow">return</span>;
<a name="l08813"></a>08813       <span class="keywordflow">for</span> (var i = 0; i &lt; addrs.length; i++) {
<a name="l08814"></a>08814         var addrPair = addrs[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08815"></a>08815         sizeEst += OBJ_OVERHEAD_EST + 2 * STR_ATTR_OVERHEAD_EST +
<a name="l08816"></a>08816                      (addrPair.name ? addrPair.name.length : 0) +
<a name="l08817"></a>08817                      (addrPair.address ? addrPair.address.length : 0);
<a name="l08818"></a>08818       }
<a name="l08819"></a>08819     }
<a name="l08820"></a>08820     <span class="keyword">function</span> sizifyAttachments(<a class="code" href="../../d9/d04/expat_8h.html#aabf48bc707494afd1ab76d41878a29c6">atts</a>) {
<a name="l08821"></a>08821       sizeEst += LIST_ATTR_OVERHEAD_EST;
<a name="l08822"></a>08822       <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d04/expat_8h.html#aabf48bc707494afd1ab76d41878a29c6">atts</a>)
<a name="l08823"></a>08823         <span class="keywordflow">return</span>;
<a name="l08824"></a>08824       <span class="keywordflow">for</span> (var i = 0; i &lt; <a class="code" href="../../d9/d04/expat_8h.html#aabf48bc707494afd1ab76d41878a29c6">atts</a>.length; i++) {
<a name="l08825"></a>08825         var att = <a class="code" href="../../d9/d04/expat_8h.html#aabf48bc707494afd1ab76d41878a29c6">atts</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08826"></a>08826         sizeEst += OBJ_OVERHEAD_EST + 2 * STR_ATTR_OVERHEAD_EST +
<a name="l08827"></a>08827                      att.name.length + att.type.length +
<a name="l08828"></a>08828                      NUM_ATTR_OVERHEAD_EST;
<a name="l08829"></a>08829       }
<a name="l08830"></a>08830     }
<a name="l08831"></a>08831     <span class="keyword">function</span> sizifyStr(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l08832"></a>08832       sizeEst += STR_ATTR_OVERHEAD_EST + <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.length;
<a name="l08833"></a>08833     }
<a name="l08834"></a>08834     <span class="keyword">function</span> sizifyStringList(<a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>) {
<a name="l08835"></a>08835       sizeEst += LIST_OVERHEAD_EST;
<a name="l08836"></a>08836       <span class="keywordflow">if</span> (!<a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>)
<a name="l08837"></a>08837         <span class="keywordflow">return</span>;
<a name="l08838"></a>08838       <span class="keywordflow">for</span> (var i = 0; i &lt; <a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>.<a class="code" href="../../d3/d59/structmozilla_1_1dom_1_1_enum_entry.html#a71a832c1bac8ba7c7eec7996cfdccf08">length</a>; i++) {
<a name="l08839"></a>08839         sizeEst += STR_ATTR_OVERHEAD_EST + <a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].<a class="code" href="../../d3/d59/structmozilla_1_1dom_1_1_enum_entry.html#a71a832c1bac8ba7c7eec7996cfdccf08">length</a>;
<a name="l08840"></a>08840       }
<a name="l08841"></a>08841     }
<a name="l08842"></a>08842     <span class="keyword">function</span> sizifyBodyRep(rep) {
<a name="l08843"></a>08843       sizeEst += LIST_OVERHEAD_EST +
<a name="l08844"></a>08844                    NUM_OVERHEAD_EST * (rep.length / 2) +
<a name="l08845"></a>08845                    STR_OVERHEAD_EST * (rep.length / 2);
<a name="l08846"></a>08846       <span class="keywordflow">for</span> (var i = 1; i &lt; rep.length; i += 2) {
<a name="l08847"></a>08847         <span class="keywordflow">if</span> (rep[i])
<a name="l08848"></a>08848           sizeEst += rep[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].length;
<a name="l08849"></a>08849       }
<a name="l08850"></a>08850     };
<a name="l08851"></a>08851     <span class="keyword">function</span> sizifyBodyReps(reps) {
<a name="l08852"></a>08852       <span class="keywordflow">if</span> (!reps)
<a name="l08853"></a>08853         <span class="keywordflow">return</span>;
<a name="l08854"></a>08854 
<a name="l08855"></a>08855 
<a name="l08856"></a>08856       sizeEst += STR_OVERHEAD_EST * (reps.length / 2);
<a name="l08857"></a>08857       <span class="keywordflow">for</span> (var i = 0; i &lt; reps.length; i++) {
<a name="l08858"></a>08858         var rep = reps[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08859"></a>08859         <span class="keywordflow">if</span> (rep.type === <span class="stringliteral">&#39;html&#39;</span>) {
<a name="l08860"></a>08860           sizeEst += STR_OVERHEAD_EST + rep.amountDownloaded;
<a name="l08861"></a>08861         } <span class="keywordflow">else</span> {
<a name="l08862"></a>08862           rep.content &amp;&amp; sizifyBodyRep(rep.content);
<a name="l08863"></a>08863         }
<a name="l08864"></a>08864       }
<a name="l08865"></a>08865     };
<a name="l08866"></a>08866 
<a name="l08867"></a>08867     <span class="keywordflow">if</span> (bodyInfo.to)
<a name="l08868"></a>08868       sizifyAddrs(bodyInfo.to);
<a name="l08869"></a>08869     <span class="keywordflow">if</span> (bodyInfo.cc)
<a name="l08870"></a>08870       sizifyAddrs(bodyInfo.cc);
<a name="l08871"></a>08871     <span class="keywordflow">if</span> (bodyInfo.bcc)
<a name="l08872"></a>08872       sizifyAddrs(bodyInfo.bcc);
<a name="l08873"></a>08873     <span class="keywordflow">if</span> (bodyInfo.replyTo)
<a name="l08874"></a>08874       sizifyStr(bodyInfo.replyTo);
<a name="l08875"></a>08875 
<a name="l08876"></a>08876 
<a name="l08877"></a>08877     sizifyAttachments(bodyInfo.attachments);
<a name="l08878"></a>08878     sizifyAttachments(bodyInfo.relatedParts);
<a name="l08879"></a>08879     sizifyStringList(bodyInfo.references);
<a name="l08880"></a>08880     sizifyBodyReps(bodyInfo.bodyReps);
<a name="l08881"></a>08881 
<a name="l08882"></a>08882     bodyInfo.size = sizeEst;
<a name="l08883"></a>08883 
<a name="l08884"></a>08884     this._insertIntoBlockUsingDateAndUID(
<a name="l08885"></a>08885       <span class="stringliteral">&#39;body&#39;</span>, header.date, header.id, header.srvid, bodyInfo.size, bodyInfo,
<a name="l08886"></a>08886       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l08887"></a>08887   },
<a name="l08888"></a>08888 
<a name="l08896"></a>08896   messageBodyRepsDownloaded: <span class="keyword">function</span>(bodyInfo) {
<a name="l08897"></a>08897     <span class="comment">// no reps its as close to downloaded as its going to get.</span>
<a name="l08898"></a>08898     <span class="keywordflow">if</span> (!bodyInfo.bodyReps || !bodyInfo.bodyReps.length)
<a name="l08899"></a>08899       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l08900"></a>08900 
<a name="l08901"></a>08901     <span class="keywordflow">return</span> bodyInfo.bodyReps.every(<span class="keyword">function</span>(rep) {
<a name="l08902"></a>08902       <span class="keywordflow">return</span> rep.isDownloaded;
<a name="l08903"></a>08903     });
<a name="l08904"></a>08904   },
<a name="l08905"></a>08905 
<a name="l08910"></a>08910   getMessageBodyWithReps: <span class="keyword">function</span>(suid, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08911"></a>08911     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l08912"></a>08912     <span class="comment">// try to get the body without any magic</span>
<a name="l08913"></a>08913     this.getMessageBody(suid, date, <span class="keyword">function</span>(bodyInfo) {
<a name="l08914"></a>08914       <span class="keywordflow">if</span> (!bodyInfo) {
<a name="l08915"></a>08915         <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(bodyInfo);
<a name="l08916"></a>08916       }
<a name="l08917"></a>08917 
<a name="l08918"></a>08918       <span class="keywordflow">if</span> (<span class="keyword">self</span>.messageBodyRepsDownloaded(bodyInfo)) {
<a name="l08919"></a>08919         <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(bodyInfo);
<a name="l08920"></a>08920       }
<a name="l08921"></a>08921 
<a name="l08922"></a>08922       <span class="comment">// queue a job and return bodyInfo after it completes..</span>
<a name="l08923"></a>08923       <span class="keyword">self</span>._account.universe.downloadMessageBodyReps(suid, date,
<a name="l08924"></a>08924                                                      <span class="keyword">function</span>(err, bodyInfo) {
<a name="l08925"></a>08925 
<a name="l08926"></a>08926         <span class="comment">// the err (if any) will be logged by the job.</span>
<a name="l08927"></a>08927         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(bodyInfo);
<a name="l08928"></a>08928       });
<a name="l08929"></a>08929     });
<a name="l08930"></a>08930   },
<a name="l08931"></a>08931 
<a name="l08932"></a>08932   getMessageBody: <span class="keyword">function</span> ifs_getMessageBody(suid, date, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l08933"></a>08933     var <span class="keywordtype">id</span> = parseInt(suid.substring(suid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>) + 1)),
<a name="l08934"></a>08934         posInfo = this._findRangeObjIndexForDateAndID(this._bodyBlockInfos,
<a name="l08935"></a>08935                                                       date, <span class="keywordtype">id</span>);
<a name="l08936"></a>08936     <span class="keywordflow">if</span> (posInfo[1] === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l08937"></a>08937       this._LOG.bodyNotFound();
<a name="l08938"></a>08938       <span class="keywordflow">try</span> {
<a name="l08939"></a>08939         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l08940"></a>08940       }
<a name="l08941"></a>08941       <span class="keywordflow">catch</span> (ex) {
<a name="l08942"></a>08942         this._LOG.callbackErr(ex);
<a name="l08943"></a>08943       }
<a name="l08944"></a>08944       <span class="keywordflow">return</span>;
<a name="l08945"></a>08945     }
<a name="l08946"></a>08946     var bodyBlockInfo = posInfo[1], <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l08947"></a>08947     <span class="keywordflow">if</span> (!(this._bodyBlocks.hasOwnProperty(bodyBlockInfo.blockId))) {
<a name="l08948"></a>08948       this._loadBlock(<span class="stringliteral">&#39;body&#39;</span>, bodyBlockInfo, <span class="keyword">function</span>(bodyBlock) {
<a name="l08949"></a>08949           var bodyInfo = bodyBlock.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>] || <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08950"></a>08950           <span class="keywordflow">if</span> (!bodyInfo)
<a name="l08951"></a>08951             <span class="keyword">self</span>._LOG.bodyNotFound();
<a name="l08952"></a>08952           <span class="keywordflow">try</span> {
<a name="l08953"></a>08953             <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(bodyInfo);
<a name="l08954"></a>08954           }
<a name="l08955"></a>08955           <span class="keywordflow">catch</span> (ex) {
<a name="l08956"></a>08956             <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l08957"></a>08957           }
<a name="l08958"></a>08958         });
<a name="l08959"></a>08959       <span class="keywordflow">return</span>;
<a name="l08960"></a>08960     }
<a name="l08961"></a>08961     var block = this._bodyBlocks[bodyBlockInfo.blockId],
<a name="l08962"></a>08962         bodyInfo = block.bodies[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>] || <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08963"></a>08963     <span class="keywordflow">if</span> (!bodyInfo)
<a name="l08964"></a>08964       this._LOG.bodyNotFound();
<a name="l08965"></a>08965     <span class="keywordflow">try</span> {
<a name="l08966"></a>08966       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(bodyInfo);
<a name="l08967"></a>08967     }
<a name="l08968"></a>08968     <span class="keywordflow">catch</span> (ex) {
<a name="l08969"></a>08969       this._LOG.callbackErr(ex);
<a name="l08970"></a>08970     }
<a name="l08971"></a>08971   },
<a name="l08972"></a>08972 
<a name="l08999"></a>08999   updateMessageBody: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, bodyInfo, eventDetails, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l09000"></a>09000     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(eventDetails) === <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l09001"></a>09001       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> = eventDetails;
<a name="l09002"></a>09002       eventDetails = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09003"></a>09003     }
<a name="l09004"></a>09004 
<a name="l09005"></a>09005     <span class="comment">// (While this method can complete synchronously, we want to maintain its</span>
<a name="l09006"></a>09006     <span class="comment">// perceived ordering relative to those that cannot be.)</span>
<a name="l09007"></a>09007     <span class="keywordflow">if</span> (this._pendingLoads.length) {
<a name="l09008"></a>09008       this._deferredCalls.push(this.updateMessageBody.bind(
<a name="l09009"></a>09009                                  <span class="keyword">this</span>, header, bodyInfo,
<a name="l09010"></a>09010                                  eventDetails, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>));
<a name="l09011"></a>09011       <span class="keywordflow">return</span>;
<a name="l09012"></a>09012     }
<a name="l09013"></a>09013 
<a name="l09014"></a>09014     var suid = header.suid;
<a name="l09015"></a>09015     var <span class="keywordtype">id</span> = parseInt(suid.substring(suid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>) + 1));
<a name="l09016"></a>09016     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l09017"></a>09017 
<a name="l09018"></a>09018     <span class="keyword">function</span> bodyUpdated() {
<a name="l09019"></a>09019       <span class="keywordflow">if</span> (eventDetails &amp;&amp; <span class="keyword">self</span>._account.universe) {
<a name="l09020"></a>09020         <span class="keyword">self</span>._account.universe.__notifyModifiedBody(
<a name="l09021"></a>09021           suid, eventDetails, bodyInfo
<a name="l09022"></a>09022         );
<a name="l09023"></a>09023       }
<a name="l09024"></a>09024 
<a name="l09025"></a>09025       <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l09026"></a>09026         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l09027"></a>09027       }
<a name="l09028"></a>09028     }
<a name="l09029"></a>09029 
<a name="l09030"></a>09030     this._deleteFromBlock(<span class="stringliteral">&#39;body&#39;</span>, header.date, <span class="keywordtype">id</span>, <span class="keyword">function</span>() {
<a name="l09031"></a>09031       <span class="keyword">self</span>.addMessageBody(header, bodyInfo, bodyUpdated);
<a name="l09032"></a>09032     });
<a name="l09033"></a>09033   },
<a name="l09034"></a>09034 
<a name="l09035"></a>09035   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>() {
<a name="l09036"></a>09036     <span class="comment">// reverse iterate since they will remove themselves as we kill them</span>
<a name="l09037"></a>09037     <span class="keywordflow">for</span> (var i = this._slices.length - 1; i &gt;= 0; i--) {
<a name="l09038"></a>09038       this._slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].die();
<a name="l09039"></a>09039     }
<a name="l09040"></a>09040     this.folderSyncer.shutdown();
<a name="l09041"></a>09041     this._LOG.__die();
<a name="l09042"></a>09042   },
<a name="l09043"></a>09043 
<a name="l09050"></a>09050   youAreDeadCleanupAfterYourself: <span class="keyword">function</span>() {
<a name="l09051"></a>09051     <span class="comment">// XXX close connections, etc.</span>
<a name="l09052"></a>09052   },
<a name="l09053"></a>09053 };
<a name="l09054"></a>09054 
<a name="l09055"></a>09055 var <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#af6bd479a55b8d304e23d9a96d199c3aa">LOGFAB</a> = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l09056"></a>09056   MailSlice: {
<a name="l09057"></a>09057     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: $log.QUERY,
<a name="l09058"></a>09058     events: {
<a name="l09059"></a>09059       headersAppended: {},
<a name="l09060"></a>09060       headerAdded: { index: <span class="keyword">false</span> },
<a name="l09061"></a>09061       headerModified: { index: <span class="keyword">false</span> },
<a name="l09062"></a>09062       headerRemoved: { index: <span class="keyword">false</span> },
<a name="l09063"></a>09063     },
<a name="l09064"></a>09064     TEST_ONLY_events: {
<a name="l09065"></a>09065       headersAppended: { headers: <span class="keyword">false</span> },
<a name="l09066"></a>09066       headerAdded: { header: <span class="keyword">false</span> },
<a name="l09067"></a>09067       headerModified: { header: <span class="keyword">false</span> },
<a name="l09068"></a>09068       headerRemoved: { header: <span class="keyword">false</span> },
<a name="l09069"></a>09069     },
<a name="l09070"></a>09070   },
<a name="l09071"></a>09071   FolderStorage: {
<a name="l09072"></a>09072     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: $log.DATABASE,
<a name="l09073"></a>09073     events: {
<a name="l09074"></a>09074       addMessageHeader: { date: <span class="keyword">false</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span>, srvid: <span class="keyword">false</span> },
<a name="l09075"></a>09075       addMessageBody: { date: <span class="keyword">false</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span>, srvid: <span class="keyword">false</span> },
<a name="l09076"></a>09076 
<a name="l09077"></a>09077       updateMessageHeader: { date: <span class="keyword">false</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span>, srvid: <span class="keyword">false</span> },
<a name="l09078"></a>09078       updateMessageBody: { date: <span class="keyword">false</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l09079"></a>09079 
<a name="l09080"></a>09080       <span class="comment">// For now, logging date and uid is useful because the general logging</span>
<a name="l09081"></a>09081       <span class="comment">// level will show us if we are trying to redundantly delete things.</span>
<a name="l09082"></a>09082       <span class="comment">// Also, date and uid are opaque identifiers with very little entropy</span>
<a name="l09083"></a>09083       <span class="comment">// on their own.  (The danger is in correlation with known messages,</span>
<a name="l09084"></a>09084       <span class="comment">// but that is likely to be useful in the debugging situations where logs</span>
<a name="l09085"></a>09085       <span class="comment">// will be sufaced.)</span>
<a name="l09086"></a>09086       deleteFromBlock: { <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="keyword">false</span>, date: <span class="keyword">false</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l09087"></a>09087 
<a name="l09088"></a>09088       <span class="comment">// This was an error but the test results viewer UI is not quite smart</span>
<a name="l09089"></a>09089       <span class="comment">// enough to understand the difference between expected errors and</span>
<a name="l09090"></a>09090       <span class="comment">// unexpected errors, so this is getting downgraded for now.</span>
<a name="l09091"></a>09091       headerNotFound: {},
<a name="l09092"></a>09092       bodyNotFound: {},
<a name="l09093"></a>09093 
<a name="l09094"></a>09094       syncedToDawnOfTime: {},
<a name="l09095"></a>09095     },
<a name="l09096"></a>09096     TEST_ONLY_events: {
<a name="l09097"></a>09097     },
<a name="l09098"></a>09098     asyncJobs: {
<a name="l09099"></a>09099       loadBlock: { <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="keyword">false</span>, blockId: <span class="keyword">false</span> },
<a name="l09100"></a>09100       mutexedCall: { <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="keyword">true</span> },
<a name="l09101"></a>09101     },
<a name="l09102"></a>09102     TEST_ONLY_asyncJobs: {
<a name="l09103"></a>09103       loadBlock: { block: <span class="keyword">false</span> },
<a name="l09104"></a>09104     },
<a name="l09105"></a>09105     errors: {
<a name="l09106"></a>09106       callbackErr: { ex: $log.EXCEPTION },
<a name="l09107"></a>09107 
<a name="l09108"></a>09108       badBlockLoad: { <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="keyword">false</span>, blockId: <span class="keyword">false</span> },
<a name="l09109"></a>09109 
<a name="l09110"></a>09110       <span class="comment">// Exposing date/uid at a general level is deemed okay because they are</span>
<a name="l09111"></a>09111       <span class="comment">// opaque identifiers and the most likely failure models involve the</span>
<a name="l09112"></a>09112       <span class="comment">// values being ridiculous (and therefore not legal).</span>
<a name="l09113"></a>09113       badIterationStart: { date: <span class="keyword">false</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l09114"></a>09114       badDeletionRequest: { <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="keyword">false</span>, date: <span class="keyword">false</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l09115"></a>09115       bodyBlockMissing: { <span class="keywordtype">id</span>: <span class="keyword">false</span>, idx: <span class="keyword">false</span>, dict: <span class="keyword">false</span> },
<a name="l09116"></a>09116       serverIdMappingMissing: { srvid: <span class="keyword">false</span> },
<a name="l09117"></a>09117 
<a name="l09118"></a>09118       accuracyRangeSuspect: { arange: <span class="keyword">false</span> },
<a name="l09119"></a>09119 
<a name="l09120"></a>09120       mutexedOpErr: { err: $log.EXCEPTION },
<a name="l09121"></a>09121 
<a name="l09122"></a>09122       tooManyCallbacks: { <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="keyword">false</span> },
<a name="l09123"></a>09123       mutexInvariantFail: { fireName: <span class="keyword">false</span>, curName: <span class="keyword">false</span> },
<a name="l09124"></a>09124     }
<a name="l09125"></a>09125   },
<a name="l09126"></a>09126 }); <span class="comment">// end LOGFAB</span>
<a name="l09127"></a>09127 
<a name="l09128"></a>09128 }); <span class="comment">// end define</span>
<a name="l09129"></a>09129 ;
<a name="l09210"></a>09210 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/searchfilter&#39;</span>,
<a name="l09211"></a>09211   [
<a name="l09212"></a>09212     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l09213"></a>09213     <span class="stringliteral">&#39;./syncbase&#39;</span>,
<a name="l09214"></a>09214     <span class="stringliteral">&#39;./date&#39;</span>,
<a name="l09215"></a>09215     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l09216"></a>09216     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l09217"></a>09217   ],
<a name="l09218"></a>09218   <span class="keyword">function</span>(
<a name="l09219"></a>09219     $log,
<a name="l09220"></a>09220     $syncbase,
<a name="l09221"></a>09221     $date,
<a name="l09222"></a>09222     $module,
<a name="l09223"></a>09223     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l09224"></a>09224   ) {
<a name="l09225"></a>09225 
<a name="l09232"></a>09232 <span class="keyword">function</span> matchRegexpOrString(phrase, <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>, fromIndex) {
<a name="l09233"></a>09233   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>) {
<a name="l09234"></a>09234     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09235"></a>09235   }
<a name="l09236"></a>09236 
<a name="l09237"></a>09237   <span class="keywordflow">if</span> (phrase instanceof RegExp) {
<a name="l09238"></a>09238     <span class="keywordflow">return</span> phrase.exec(fromIndex ? <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.slice(fromIndex) : <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>);
<a name="l09239"></a>09239   }
<a name="l09240"></a>09240 
<a name="l09241"></a>09241   var idx = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.indexOf(phrase, fromIndex);
<a name="l09242"></a>09242   <span class="keywordflow">if</span> (idx == -1) {
<a name="l09243"></a>09243     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09244"></a>09244   }
<a name="l09245"></a>09245 
<a name="l09246"></a>09246   var <a class="code" href="../../d6/da5/libpinyin_8js.html#a2a7ba084dafcf16766cf163d1f5fbbba">ret</a> = [ phrase ];
<a name="l09247"></a>09247   ret.index = idx - fromIndex;
<a name="l09248"></a>09248   <span class="keywordflow">return</span> <a class="code" href="../../d6/da5/libpinyin_8js.html#a2a7ba084dafcf16766cf163d1f5fbbba">ret</a>;
<a name="l09249"></a>09249 }
<a name="l09250"></a>09250 
<a name="l09258"></a>09258 <span class="keyword">function</span> AuthorFilter(phrase) {
<a name="l09259"></a>09259   this.phrase = phrase;
<a name="l09260"></a>09260 }
<a name="l09261"></a>09261 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.AuthorFilter = AuthorFilter;
<a name="l09262"></a>09262 AuthorFilter.prototype = {
<a name="l09263"></a>09263   needsBody: <span class="keyword">false</span>,
<a name="l09264"></a>09264 
<a name="l09265"></a>09265   testMessage: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body, <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>) {
<a name="l09266"></a>09266     var <a class="code" href="../../dd/dc4/namespacesetup.html#a7b92894168460f935bc49467954c4a92">author</a> = header.author, phrase = this.phrase, <a class="code" href="../../d6/da5/libpinyin_8js.html#a2a7ba084dafcf16766cf163d1f5fbbba">ret</a>;
<a name="l09267"></a>09267     <span class="keywordflow">if</span> ((ret = matchRegexpOrString(phrase, author.name, 0))) {
<a name="l09268"></a>09268       <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.author = {
<a name="l09269"></a>09269         <a class="code" href="../../dd/dfa/classtext.html">text</a>: author.name,
<a name="l09270"></a>09270         <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a>: 0,
<a name="l09271"></a>09271         matchRuns: [{ <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: ret.index, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>: ret[0].length }],
<a name="l09272"></a>09272         <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l09273"></a>09273       };
<a name="l09274"></a>09274       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l09275"></a>09275     }
<a name="l09276"></a>09276     <span class="keywordflow">if</span> ((ret = matchRegexpOrString(phrase, author.address, 0))) {
<a name="l09277"></a>09277       <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.author = {
<a name="l09278"></a>09278         <a class="code" href="../../dd/dfa/classtext.html">text</a>: author.address,
<a name="l09279"></a>09279         <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a>: 0,
<a name="l09280"></a>09280         matchRuns: [{ <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: ret.index, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>: ret[0].length }],
<a name="l09281"></a>09281         <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l09282"></a>09282       };
<a name="l09283"></a>09283       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l09284"></a>09284     }
<a name="l09285"></a>09285     <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.author = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09286"></a>09286     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09287"></a>09287   },
<a name="l09288"></a>09288 };
<a name="l09289"></a>09289 
<a name="l09301"></a>09301 <span class="keyword">function</span> RecipientFilter(phrase, stopAfterNMatches,
<a name="l09302"></a>09302                          checkTo, checkCc, checkBcc) {
<a name="l09303"></a>09303   this.phrase = phrase;
<a name="l09304"></a>09304   this.stopAfter = stopAfterNMatches;
<a name="l09305"></a>09305   this.checkTo = checkTo;
<a name="l09306"></a>09306   this.checkCc = checkCc;
<a name="l09307"></a>09307   this.checkBcc = checkBcc;
<a name="l09308"></a>09308 }
<a name="l09309"></a>09309 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.RecipientFilter = RecipientFilter;
<a name="l09310"></a>09310 RecipientFilter.prototype = {
<a name="l09311"></a>09311   needsBody: <span class="keyword">true</span>,
<a name="l09312"></a>09312 
<a name="l09313"></a>09313   testMessage: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body, <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>) {
<a name="l09314"></a>09314     var phrase = this.phrase, stopAfter = this.stopAfter;
<a name="l09315"></a>09315     var matches = [];
<a name="l09316"></a>09316     <span class="keyword">function</span> checkRecipList(<a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>) {
<a name="l09317"></a>09317       var <a class="code" href="../../d6/da5/libpinyin_8js.html#a2a7ba084dafcf16766cf163d1f5fbbba">ret</a>;
<a name="l09318"></a>09318       <span class="keywordflow">for</span> (var i = 0; i &lt; <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length; i++) {
<a name="l09319"></a>09319         var recip = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l09320"></a>09320         <span class="keywordflow">if</span> ((ret = matchRegexpOrString(phrase, recip.name, 0))) {
<a name="l09321"></a>09321           matches.push({
<a name="l09322"></a>09322             <a class="code" href="../../dd/dfa/classtext.html">text</a>: recip.name,
<a name="l09323"></a>09323             <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a>: 0,
<a name="l09324"></a>09324             matchRuns: [{ <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: ret.index, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>: ret[0].length }],
<a name="l09325"></a>09325             <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l09326"></a>09326           });
<a name="l09327"></a>09327           <span class="keywordflow">if</span> (matches.length &lt; stopAfter)
<a name="l09328"></a>09328             <span class="keywordflow">continue</span>;
<a name="l09329"></a>09329           <span class="keywordflow">return</span>;
<a name="l09330"></a>09330         }
<a name="l09331"></a>09331         <span class="keywordflow">if</span> ((ret = matchRegexpOrString(phrase, recip.address, 0))) {
<a name="l09332"></a>09332           matches.push({
<a name="l09333"></a>09333             <a class="code" href="../../dd/dfa/classtext.html">text</a>: recip.address,
<a name="l09334"></a>09334             <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a>: 0,
<a name="l09335"></a>09335             matchRuns: [{ <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: ret.index, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>: ret[0].length }],
<a name="l09336"></a>09336             <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l09337"></a>09337           });
<a name="l09338"></a>09338           <span class="keywordflow">if</span> (matches.length &gt;= stopAfter)
<a name="l09339"></a>09339             <span class="keywordflow">return</span>;
<a name="l09340"></a>09340         }
<a name="l09341"></a>09341       }
<a name="l09342"></a>09342     }
<a name="l09343"></a>09343 
<a name="l09344"></a>09344     <span class="keywordflow">if</span> (this.checkTo &amp;&amp; header.to)
<a name="l09345"></a>09345       checkRecipList(header.to);
<a name="l09346"></a>09346     <span class="keywordflow">if</span> (this.checkCc &amp;&amp; header.cc &amp;&amp; matches.length &lt; stopAfter)
<a name="l09347"></a>09347       checkRecipList(header.cc);
<a name="l09348"></a>09348     <span class="keywordflow">if</span> (this.checkBcc &amp;&amp; header.bcc &amp;&amp; matches.length &lt; stopAfter)
<a name="l09349"></a>09349       checkRecipList(header.bcc);
<a name="l09350"></a>09350 
<a name="l09351"></a>09351     <span class="keywordflow">if</span> (matches.length) {
<a name="l09352"></a>09352       <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.recipients = matches;
<a name="l09353"></a>09353       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l09354"></a>09354     }
<a name="l09355"></a>09355     <span class="keywordflow">else</span> {
<a name="l09356"></a>09356       <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.recipients = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09357"></a>09357       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09358"></a>09358     }
<a name="l09359"></a>09359   },
<a name="l09360"></a>09360 
<a name="l09361"></a>09361 };
<a name="l09362"></a>09362 
<a name="l09378"></a>09378 <span class="keyword">function</span> snippetMatchHelper(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>, contextBefore, contextAfter,
<a name="l09379"></a>09379                             <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>) {
<a name="l09380"></a>09380   <span class="keywordflow">if</span> (contextBefore &gt; <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>)
<a name="l09381"></a>09381     contextBefore = <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>;
<a name="l09382"></a>09382   var <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a> = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.indexOf(<span class="charliteral">&#39; &#39;</span>, <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a> - contextBefore);
<a name="l09383"></a>09383   <span class="keywordflow">if</span> (offset === -1)
<a name="l09384"></a>09384     offset = 0;
<a name="l09385"></a>09385   <span class="keywordflow">if</span> (offset &gt;= <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>)
<a name="l09386"></a>09386     offset = <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a> - contextBefore;
<a name="l09387"></a>09387   var endIdx = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.lastIndexOf(<span class="charliteral">&#39; &#39;</span>, <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a> + <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a> + contextAfter);
<a name="l09388"></a>09388   <span class="keywordflow">if</span> (endIdx &lt;= <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a> + <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>)
<a name="l09389"></a>09389     endIdx = <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a> + <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a> + contextAfter;
<a name="l09390"></a>09390   var snippet = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.substring(offset, endIdx);
<a name="l09391"></a>09391 
<a name="l09392"></a>09392   <span class="keywordflow">return</span> {
<a name="l09393"></a>09393     <a class="code" href="../../dd/dfa/classtext.html">text</a>: snippet,
<a name="l09394"></a>09394     offset: <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a>,
<a name="l09395"></a>09395     matchRuns: [{ <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a> - <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a>, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>: <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a> }],
<a name="l09396"></a>09396     <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>
<a name="l09397"></a>09397   };
<a name="l09398"></a>09398 }
<a name="l09399"></a>09399 
<a name="l09409"></a>09409 <span class="keyword">function</span> SubjectFilter(phrase, stopAfterNMatches, contextBefore, contextAfter) {
<a name="l09410"></a>09410   this.phrase = phrase;
<a name="l09411"></a>09411   this.stopAfter = stopAfterNMatches;
<a name="l09412"></a>09412   this.contextBefore = contextBefore;
<a name="l09413"></a>09413   this.contextAfter = contextAfter;
<a name="l09414"></a>09414 }
<a name="l09415"></a>09415 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SubjectFilter = SubjectFilter;
<a name="l09416"></a>09416 SubjectFilter.prototype = {
<a name="l09417"></a>09417   needsBody: <span class="keyword">false</span>,
<a name="l09418"></a>09418   testMessage: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body, <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>) {
<a name="l09419"></a>09419     var <a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a> = header.subject;
<a name="l09420"></a>09420     <span class="comment">// Empty subjects can&#39;t match *anything*; no empty regexes allowed, etc.</span>
<a name="l09421"></a>09421     <span class="keywordflow">if</span> (!subject)
<a name="l09422"></a>09422       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09423"></a>09423     var phrase = this.phrase,
<a name="l09424"></a>09424         slen = subject.length,
<a name="l09425"></a>09425         stopAfter = this.stopAfter,
<a name="l09426"></a>09426         contextBefore = this.contextBefore, contextAfter = this.contextAfter,
<a name="l09427"></a>09427         matches = [],
<a name="l09428"></a>09428         idx = 0;
<a name="l09429"></a>09429 
<a name="l09430"></a>09430     <span class="keywordflow">while</span> (idx &lt; slen &amp;&amp; matches.length &lt; stopAfter) {
<a name="l09431"></a>09431       var ret = matchRegexpOrString(phrase, subject, idx);
<a name="l09432"></a>09432       <span class="keywordflow">if</span> (!ret)
<a name="l09433"></a>09433         <span class="keywordflow">break</span>;
<a name="l09434"></a>09434 
<a name="l09435"></a>09435       matches.push(snippetMatchHelper(subject, idx + ret.index, ret[0].length,
<a name="l09436"></a>09436                                       contextBefore, contextAfter, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>));
<a name="l09437"></a>09437       idx += ret.index + ret[0].length;
<a name="l09438"></a>09438     }
<a name="l09439"></a>09439 
<a name="l09440"></a>09440     <span class="keywordflow">if</span> (matches.length) {
<a name="l09441"></a>09441       <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.subject = matches;
<a name="l09442"></a>09442       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l09443"></a>09443     }
<a name="l09444"></a>09444     <span class="keywordflow">else</span> {
<a name="l09445"></a>09445       <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.subject = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09446"></a>09446       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09447"></a>09447     }
<a name="l09448"></a>09448   },
<a name="l09449"></a>09449 };
<a name="l09450"></a>09450 
<a name="l09451"></a>09451 <span class="comment">// stable value from quotechew.js; full export regime not currently required.</span>
<a name="l09452"></a>09452 var CT_AUTHORED_CONTENT = 0x1;
<a name="l09453"></a>09453 <span class="comment">// HTML DOM constants</span>
<a name="l09454"></a>09454 var ELEMENT_NODE = 1, TEXT_NODE = 3;
<a name="l09455"></a>09455 
<a name="l09465"></a>09465 <span class="keyword">function</span> BodyFilter(phrase, matchQuotes, stopAfterNMatches,
<a name="l09466"></a>09466                     contextBefore, contextAfter) {
<a name="l09467"></a>09467   this.phrase = phrase;
<a name="l09468"></a>09468   this.stopAfter = stopAfterNMatches;
<a name="l09469"></a>09469   this.contextBefore = contextBefore;
<a name="l09470"></a>09470   this.contextAfter = contextAfter;
<a name="l09471"></a>09471   this.matchQuotes = matchQuotes;
<a name="l09472"></a>09472 }
<a name="l09473"></a>09473 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.BodyFilter = BodyFilter;
<a name="l09474"></a>09474 BodyFilter.prototype = {
<a name="l09475"></a>09475   needsBody: <span class="keyword">true</span>,
<a name="l09476"></a>09476   testMessage: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body, <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>) {
<a name="l09477"></a>09477     var phrase = this.phrase,
<a name="l09478"></a>09478         stopAfter = this.stopAfter,
<a name="l09479"></a>09479         contextBefore = this.contextBefore, contextAfter = this.contextAfter,
<a name="l09480"></a>09480         matches = [],
<a name="l09481"></a>09481         matchQuotes = this.matchQuotes,
<a name="l09482"></a>09482         idx;
<a name="l09483"></a>09483 
<a name="l09484"></a>09484     <span class="keywordflow">for</span> (var iBodyRep = 0; iBodyRep &lt; body.bodyReps.length; iBodyRep++) {
<a name="l09485"></a>09485       var bodyType = body.bodyReps[iBodyRep].type,
<a name="l09486"></a>09486           bodyRep = body.bodyReps[iBodyRep].content;
<a name="l09487"></a>09487 
<a name="l09488"></a>09488       <span class="keywordflow">if</span> (bodyType === <span class="stringliteral">&#39;plain&#39;</span>) {
<a name="l09489"></a>09489         <span class="keywordflow">for</span> (var iRep = 0; iRep &lt; bodyRep.length &amp;&amp; matches.length &lt; stopAfter;
<a name="l09490"></a>09490              iRep += 2) {
<a name="l09491"></a>09491           var etype = bodyRep[iRep]&amp;0xf, block = bodyRep[iRep + 1],
<a name="l09492"></a>09492               repPath = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09493"></a>09493 
<a name="l09494"></a>09494           <span class="comment">// Ignore blocks that are not message-author authored unless we are</span>
<a name="l09495"></a>09495           <span class="comment">// told to match quotes.</span>
<a name="l09496"></a>09496           <span class="keywordflow">if</span> (!matchQuotes &amp;&amp; etype !== CT_AUTHORED_CONTENT)
<a name="l09497"></a>09497             <span class="keywordflow">continue</span>;
<a name="l09498"></a>09498 
<a name="l09499"></a>09499           <span class="keywordflow">for</span> (idx = 0; idx &lt; block.length &amp;&amp; matches.length &lt; stopAfter;) {
<a name="l09500"></a>09500             var ret = matchRegexpOrString(phrase, block, idx);
<a name="l09501"></a>09501             <span class="keywordflow">if</span> (!ret)
<a name="l09502"></a>09502               <span class="keywordflow">break</span>;
<a name="l09503"></a>09503             <span class="keywordflow">if</span> (repPath === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l09504"></a>09504               repPath = [iBodyRep, iRep];
<a name="l09505"></a>09505             matches.push(snippetMatchHelper(block, ret.index, ret[0].length,
<a name="l09506"></a>09506                                             contextBefore, contextAfter,
<a name="l09507"></a>09507                                             repPath));
<a name="l09508"></a>09508             idx += ret.index + ret[0].length;
<a name="l09509"></a>09509           }
<a name="l09510"></a>09510         }
<a name="l09511"></a>09511       }
<a name="l09512"></a>09512       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bodyType === <span class="stringliteral">&#39;html&#39;</span>) {
<a name="l09513"></a>09513         <span class="comment">// NB: this code is derived from htmlchew.js&#39; generateSnippet</span>
<a name="l09514"></a>09514         <span class="comment">// functionality.</span>
<a name="l09515"></a>09515 
<a name="l09516"></a>09516         <span class="comment">// - convert the HMTL into a DOM tree</span>
<a name="l09517"></a>09517         <span class="comment">// We don&#39;t want our indexOf to run afoul of presentation logic.</span>
<a name="l09518"></a>09518         var htmlPath = [iBodyRep, 0];
<a name="l09519"></a>09519         var htmlDoc = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.implementation.createHTMLDocument(<span class="stringliteral">&#39;&#39;</span>),
<a name="l09520"></a>09520             rootNode = htmlDoc.createElement(<span class="stringliteral">&#39;div&#39;</span>);
<a name="l09521"></a>09521         rootNode.innerHTML = bodyRep;
<a name="l09522"></a>09522 
<a name="l09523"></a>09523         var <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a> = rootNode.firstChild, <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a> = <span class="keyword">false</span>;
<a name="l09524"></a>09524         <span class="keywordflow">while</span> (!<a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>) {
<a name="l09525"></a>09525           <span class="keywordflow">if</span> (node.nodeType === ELEMENT_NODE) {
<a name="l09526"></a>09526             <span class="keywordflow">switch</span> (node.tagName.toLowerCase()) {
<a name="l09527"></a>09527               <span class="comment">// - Things that can&#39;t contain useful text.</span>
<a name="l09528"></a>09528               <span class="comment">// The style does not belong in the snippet!</span>
<a name="l09529"></a>09529               <span class="keywordflow">case</span> <span class="stringliteral">&#39;style&#39;</span>:
<a name="l09530"></a>09530                 <span class="keywordflow">break</span>;
<a name="l09531"></a>09531 
<a name="l09532"></a>09532               <span class="keywordflow">case</span> <span class="stringliteral">&#39;blockquote&#39;</span>:
<a name="l09533"></a>09533                 <span class="comment">// fall-through if matchQuotes</span>
<a name="l09534"></a>09534                 <span class="keywordflow">if</span> (!matchQuotes)
<a name="l09535"></a>09535                   <span class="keywordflow">break</span>;
<a name="l09536"></a>09536               <span class="keywordflow">default</span>:
<a name="l09537"></a>09537                 <span class="keywordflow">if</span> (node.firstChild) {
<a name="l09538"></a>09538                   node = node.firstChild;
<a name="l09539"></a>09539                   htmlPath.push(0);
<a name="l09540"></a>09540                   <span class="keywordflow">continue</span>;
<a name="l09541"></a>09541                 }
<a name="l09542"></a>09542                 <span class="keywordflow">break</span>;
<a name="l09543"></a>09543             }
<a name="l09544"></a>09544           }
<a name="l09545"></a>09545           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (node.nodeType === TEXT_NODE) {
<a name="l09546"></a>09546             <span class="comment">// XXX the snippet generator normalizes whitespace here to avoid</span>
<a name="l09547"></a>09547             <span class="comment">// being overwhelmed by ridiculous whitespace.  This is not quite</span>
<a name="l09548"></a>09548             <span class="comment">// as much a problem for us, but it would be useful if the</span>
<a name="l09549"></a>09549             <span class="comment">// sanitizer layer normalized whitespace so neither of us has to</span>
<a name="l09550"></a>09550             <span class="comment">// worry about it.</span>
<a name="l09551"></a>09551             var nodeText = node.data;
<a name="l09552"></a>09552 
<a name="l09553"></a>09553             var ret = matchRegexpOrString(phrase, nodeText, 0);
<a name="l09554"></a>09554             <span class="keywordflow">if</span> (ret) {
<a name="l09555"></a>09555               matches.push(
<a name="l09556"></a>09556                 snippetMatchHelper(nodeText, ret.index, ret[0].length,
<a name="l09557"></a>09557                                    contextBefore, contextAfter,
<a name="l09558"></a>09558                                    htmlPath.concat()));
<a name="l09559"></a>09559               <span class="keywordflow">if</span> (matches.length &gt;= stopAfter)
<a name="l09560"></a>09560                 <span class="keywordflow">break</span>;
<a name="l09561"></a>09561             }
<a name="l09562"></a>09562           }
<a name="l09563"></a>09563 
<a name="l09564"></a>09564           <span class="keywordflow">while</span> (!node.nextSibling) {
<a name="l09565"></a>09565             node = node.parentNode;
<a name="l09566"></a>09566             htmlPath.pop();
<a name="l09567"></a>09567             <span class="keywordflow">if</span> (node === rootNode) {
<a name="l09568"></a>09568               <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a> = <span class="keyword">true</span>;
<a name="l09569"></a>09569               <span class="keywordflow">break</span>;
<a name="l09570"></a>09570             }
<a name="l09571"></a>09571           }
<a name="l09572"></a>09572           <span class="keywordflow">if</span> (!<a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>) {
<a name="l09573"></a>09573             node = node.nextSibling;
<a name="l09574"></a>09574             htmlPath[htmlPath.length - 1]++;
<a name="l09575"></a>09575           }
<a name="l09576"></a>09576         }
<a name="l09577"></a>09577       }
<a name="l09578"></a>09578     }
<a name="l09579"></a>09579 
<a name="l09580"></a>09580     <span class="keywordflow">if</span> (matches.length) {
<a name="l09581"></a>09581       <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.body = matches;
<a name="l09582"></a>09582       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l09583"></a>09583     }
<a name="l09584"></a>09584     <span class="keywordflow">else</span> {
<a name="l09585"></a>09585       <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a>.body = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09586"></a>09586       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09587"></a>09587     }
<a name="l09588"></a>09588   },
<a name="l09589"></a>09589 };
<a name="l09590"></a>09590 
<a name="l09595"></a>09595 <span class="keyword">function</span> MessageFilterer(filters) {
<a name="l09596"></a>09596   this.filters = filters;
<a name="l09597"></a>09597   this.bodiesNeeded = <span class="keyword">false</span>;
<a name="l09598"></a>09598 
<a name="l09599"></a>09599   <span class="keywordflow">for</span> (var i = 0; i &lt; filters.length; i++) {
<a name="l09600"></a>09600     var <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> = filters[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l09601"></a>09601     <span class="keywordflow">if</span> (filter.needsBody)
<a name="l09602"></a>09602       this.bodiesNeeded = <span class="keyword">true</span>;
<a name="l09603"></a>09603   }
<a name="l09604"></a>09604 }
<a name="l09605"></a>09605 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MessageFilterer = MessageFilterer;
<a name="l09606"></a>09606 MessageFilterer.prototype = {
<a name="l09612"></a>09612   testMessage: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body) {
<a name="l09613"></a>09613     <span class="comment">//console.log(&#39;sf: testMessage(&#39;, header.suid, header.author.address,</span>
<a name="l09614"></a>09614     <span class="comment">//            header.subject, &#39;body?&#39;, !!body, &#39;)&#39;);</span>
<a name="l09615"></a>09615     var matched = <span class="keyword">false</span>, matchObj = {};
<a name="l09616"></a>09616     var filters = this.filters;
<a name="l09617"></a>09617     <span class="keywordflow">try</span> {
<a name="l09618"></a>09618       <span class="keywordflow">for</span> (var i = 0; i &lt; filters.length; i++) {
<a name="l09619"></a>09619         var <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> = filters[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l09620"></a>09620         <span class="keywordflow">if</span> (filter.testMessage(header, body, matchObj))
<a name="l09621"></a>09621           matched = <span class="keyword">true</span>;
<a name="l09622"></a>09622       }
<a name="l09623"></a>09623     }
<a name="l09624"></a>09624     <span class="keywordflow">catch</span> (ex) {
<a name="l09625"></a>09625       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;filter exception&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l09626"></a>09626     }
<a name="l09627"></a>09627     <span class="comment">//console.log(&#39;   =&gt;&#39;, matched, JSON.stringify(matchObj));</span>
<a name="l09628"></a>09628     <span class="keywordflow">if</span> (matched)
<a name="l09629"></a>09629       <span class="keywordflow">return</span> matchObj;
<a name="l09630"></a>09630     <span class="keywordflow">else</span>
<a name="l09631"></a>09631       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l09632"></a>09632   },
<a name="l09633"></a>09633 };
<a name="l09634"></a>09634 
<a name="l09635"></a>09635 var CONTEXT_CHARS_BEFORE = 16;
<a name="l09636"></a>09636 var CONTEXT_CHARS_AFTER = 40;
<a name="l09637"></a>09637 
<a name="l09641"></a>09641 <span class="keyword">function</span> SearchSlice(bridgeHandle, storage, phrase, whatToSearch, _parentLog) {
<a name="l09642"></a>09642 <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;sf: creating SearchSlice:&#39;</span>, phrase);
<a name="l09643"></a>09643   this._bridgeHandle = bridgeHandle;
<a name="l09644"></a>09644   bridgeHandle.__listener = <span class="keyword">this</span>;
<a name="l09645"></a>09645   <span class="comment">// this mechanism never allows triggering synchronization.</span>
<a name="l09646"></a>09646   bridgeHandle.userCanGrowDownwards = <span class="keyword">false</span>;
<a name="l09647"></a>09647 
<a name="l09648"></a>09648   this._storage = storage;
<a name="l09649"></a>09649   this._LOG = LOGFAB.SearchSlice(<span class="keyword">this</span>, _parentLog, bridgeHandle._handle);
<a name="l09650"></a>09650 
<a name="l09651"></a>09651   <span class="comment">// These correspond to the range of headers that we have searched to generate</span>
<a name="l09652"></a>09652   <span class="comment">// the current set of matched headers.  Our matches will always be fully</span>
<a name="l09653"></a>09653   <span class="comment">// contained by this range.</span>
<a name="l09654"></a>09654   this.startTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09655"></a>09655   this.startUID = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09656"></a>09656   this.endTS = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09657"></a>09657   this.endUID = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09658"></a>09658 
<a name="l09659"></a>09659   <span class="keywordflow">if</span> (!(phrase instanceof RegExp)) {
<a name="l09660"></a>09660     phrase = <span class="keyword">new</span> RegExp(phrase.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>,
<a name="l09661"></a>09661                                        <span class="stringliteral">&#39;\\$&amp;&#39;</span>),
<a name="l09662"></a>09662                         <span class="charliteral">&#39;i&#39;</span>);
<a name="l09663"></a>09663   }
<a name="l09664"></a>09664 
<a name="l09665"></a>09665   var filters = [];
<a name="l09666"></a>09666   <span class="keywordflow">if</span> (whatToSearch.author)
<a name="l09667"></a>09667     filters.push(<span class="keyword">new</span> AuthorFilter(phrase));
<a name="l09668"></a>09668   <span class="keywordflow">if</span> (whatToSearch.recipients)
<a name="l09669"></a>09669     filters.push(<span class="keyword">new</span> RecipientFilter(phrase, 1, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>));
<a name="l09670"></a>09670   <span class="keywordflow">if</span> (whatToSearch.subject)
<a name="l09671"></a>09671     filters.push(<span class="keyword">new</span> SubjectFilter(
<a name="l09672"></a>09672                    phrase, 1, CONTEXT_CHARS_BEFORE, CONTEXT_CHARS_AFTER));
<a name="l09673"></a>09673   <span class="keywordflow">if</span> (whatToSearch.body)
<a name="l09674"></a>09674     filters.push(<span class="keyword">new</span> BodyFilter(
<a name="l09675"></a>09675                    phrase, whatToSearch.body === <span class="stringliteral">&#39;yes-quotes&#39;</span>,
<a name="l09676"></a>09676                    1, CONTEXT_CHARS_BEFORE, CONTEXT_CHARS_AFTER));
<a name="l09677"></a>09677 
<a name="l09678"></a>09678   this.filterer = <span class="keyword">new</span> MessageFilterer(filters);
<a name="l09679"></a>09679 
<a name="l09680"></a>09680   this._bound_gotOlderMessages = this._gotMessages.bind(<span class="keyword">this</span>, 1);
<a name="l09681"></a>09681   this._bound_gotNewerMessages = this._gotMessages.bind(<span class="keyword">this</span>, -1);
<a name="l09682"></a>09682 
<a name="l09683"></a>09683   this.headers = [];
<a name="l09684"></a>09684   this.desiredHeaders = $syncbase.INITIAL_FILL_SIZE;
<a name="l09685"></a>09685   <span class="comment">// Fetch as many headers as we want in our results; we probably will have</span>
<a name="l09686"></a>09686   <span class="comment">// less than a 100% hit-rate, but there isn&#39;t much savings from getting the</span>
<a name="l09687"></a>09687   <span class="comment">// extra headers now, so punt on those.</span>
<a name="l09688"></a>09688   this._storage.getMessagesInImapDateRange(
<a name="l09689"></a>09689     0, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, this.desiredHeaders, this.desiredHeaders,
<a name="l09690"></a>09690     this._gotMessages.bind(<span class="keyword">this</span>, 1));
<a name="l09691"></a>09691 }
<a name="l09692"></a>09692 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SearchSlice = SearchSlice;
<a name="l09693"></a>09693 SearchSlice.prototype = {
<a name="l09694"></a>09694   <span class="keyword">set</span> atTop(val) {
<a name="l09695"></a>09695     this._bridgeHandle.atTop = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l09696"></a>09696   },
<a name="l09697"></a>09697   <span class="keyword">set</span> atBottom(val) {
<a name="l09698"></a>09698     this._bridgeHandle.atBottom = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l09699"></a>09699   },
<a name="l09700"></a>09700 
<a name="l09701"></a>09701   _gotMessages: <span class="keyword">function</span>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#aec4b49f6f844eec3e3877aef25ed0b84">dir</a>, <a class="code" href="../../da/d32/prio_8h.html#ae514094796205f27cbccab72be2e8826">headers</a>, moreMessagesComing) {
<a name="l09702"></a>09702 <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;sf: gotMessages&#39;</span>, headers.length);
<a name="l09703"></a>09703     <span class="comment">// update the range of what we have seen and searched</span>
<a name="l09704"></a>09704     <span class="keywordflow">if</span> (headers.length) {
<a name="l09705"></a>09705       <span class="keywordflow">if</span> (dir === -1) { <span class="comment">// (more recent)</span>
<a name="l09706"></a>09706         this.endTS = headers[0].date;
<a name="l09707"></a>09707         this.endUID = headers[0].id;
<a name="l09708"></a>09708       }
<a name="l09709"></a>09709       <span class="keywordflow">else</span> { <span class="comment">// (older)</span>
<a name="l09710"></a>09710         var lastHeader = headers[headers.length - 1];
<a name="l09711"></a>09711         this.startTS = lastHeader.date;
<a name="l09712"></a>09712         this.startUID = lastHeader.id;
<a name="l09713"></a>09713         <span class="keywordflow">if</span> (this.endTS === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l09714"></a>09714           this.endTS = headers[0].date;
<a name="l09715"></a>09715           this.endUID = headers[0].id;
<a name="l09716"></a>09716         }
<a name="l09717"></a>09717       }
<a name="l09718"></a>09718     }
<a name="l09719"></a>09719 
<a name="l09720"></a>09720     var checkHandle = <span class="keyword">function</span> checkHandle(headers, bodies) {
<a name="l09721"></a>09721       <span class="comment">// run a filter on these</span>
<a name="l09722"></a>09722       var matchPairs = [];
<a name="l09723"></a>09723       <span class="keywordflow">for</span> (i = 0; i &lt; headers.length; i++) {
<a name="l09724"></a>09724         var header = headers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l09725"></a>09725             body = bodies ? bodies[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09726"></a>09726         var matchObj = this.filterer.testMessage(header, body);
<a name="l09727"></a>09727         <span class="keywordflow">if</span> (matchObj)
<a name="l09728"></a>09728           matchPairs.push({ header: <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, matches: matchObj });
<a name="l09729"></a>09729       }
<a name="l09730"></a>09730 
<a name="l09731"></a>09731       var atTop = this.atTop = this._storage.headerIsYoungestKnown(
<a name="l09732"></a>09732                     this.endTS, this.endUID);
<a name="l09733"></a>09733       var atBottom = this.atBottom = this._storage.headerIsOldestKnown(
<a name="l09734"></a>09734                        this.startTS, this.startUID);
<a name="l09735"></a>09735       var canGetMore = (dir === -1) ? !atTop : !atBottom;
<a name="l09736"></a>09736       <span class="keywordflow">if</span> (matchPairs.length) {
<a name="l09737"></a>09737         var willHave = this.headers.length + matchPairs.length,
<a name="l09738"></a>09738             wantMore = !moreMessagesComing &amp;&amp;
<a name="l09739"></a>09739                        (willHave &lt; this.desiredHeaders) &amp;&amp;
<a name="l09740"></a>09740                        canGetMore;
<a name="l09741"></a>09741 <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;sf: willHave&#39;</span>, willHave, <span class="stringliteral">&#39;of&#39;</span>, this.desiredHeaders, <span class="stringliteral">&#39;want more?&#39;</span>, wantMore);
<a name="l09742"></a>09742         var insertAt = dir === -1 ? 0 : this.headers.length;
<a name="l09743"></a>09743         this._bridgeHandle.sendSplice(
<a name="l09744"></a>09744           insertAt, 0, matchPairs, <span class="keyword">true</span>,
<a name="l09745"></a>09745           moreMessagesComing || wantMore);
<a name="l09746"></a>09746         this.headers.splice.apply(this.headers,
<a name="l09747"></a>09747                                   [insertAt, 0].concat(matchPairs));
<a name="l09748"></a>09748         <span class="keywordflow">if</span> (wantMore)
<a name="l09749"></a>09749           this.reqGrow(dir, <span class="keyword">false</span>);
<a name="l09750"></a>09750       }
<a name="l09751"></a>09751       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!moreMessagesComing) {
<a name="l09752"></a>09752         <span class="comment">// If there aren&#39;t more messages coming, we either need to get more</span>
<a name="l09753"></a>09753         <span class="comment">// messages (if there are any left in the folder that we haven&#39;t seen)</span>
<a name="l09754"></a>09754         <span class="comment">// or signal completion.  We can use our growth function directly since</span>
<a name="l09755"></a>09755         <span class="comment">// there are no state invariants that will get confused.</span>
<a name="l09756"></a>09756         <span class="keywordflow">if</span> (canGetMore)
<a name="l09757"></a>09757           this.reqGrow(dir, <span class="keyword">false</span>);
<a name="l09758"></a>09758         <span class="keywordflow">else</span>
<a name="l09759"></a>09759           this._bridgeHandle.sendStatus(<span class="stringliteral">&#39;synced&#39;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l09760"></a>09760       }
<a name="l09761"></a>09761       <span class="comment">// (otherwise we need to wait for the additional messages to show before</span>
<a name="l09762"></a>09762       <span class="comment">//  doing anything conclusive)</span>
<a name="l09763"></a>09763     }.bind(<span class="keyword">this</span>);
<a name="l09764"></a>09764 
<a name="l09765"></a>09765     <span class="keywordflow">if</span> (this.filterer.bodiesNeeded) {
<a name="l09766"></a>09766       <span class="comment">// To batch our updates to the UI, just get all the bodies then advance</span>
<a name="l09767"></a>09767       <span class="comment">// to the next stage of processing.  It would be nice</span>
<a name="l09768"></a>09768       var bodies = [];
<a name="l09769"></a>09769       var gotBody = <span class="keyword">function</span>(body) {
<a name="l09770"></a>09770         <span class="keywordflow">if</span> (!body)
<a name="l09771"></a>09771           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;failed to get a body for: &#39;</span>,
<a name="l09772"></a>09772                       headers[bodies.length].suid,
<a name="l09773"></a>09773                       headers[bodies.length].subject);
<a name="l09774"></a>09774         bodies.push(body);
<a name="l09775"></a>09775         <span class="keywordflow">if</span> (bodies.length === headers.length)
<a name="l09776"></a>09776           checkHandle(headers, bodies);
<a name="l09777"></a>09777       };
<a name="l09778"></a>09778       <span class="keywordflow">for</span> (var i = 0; i &lt; headers.length; i++) {
<a name="l09779"></a>09779         var header = headers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l09780"></a>09780         this._storage.getMessageBody(header.suid, header.date, gotBody);
<a name="l09781"></a>09781       }
<a name="l09782"></a>09782     }
<a name="l09783"></a>09783     <span class="keywordflow">else</span> {
<a name="l09784"></a>09784       checkHandle(headers, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l09785"></a>09785     }
<a name="l09786"></a>09786   },
<a name="l09787"></a>09787 
<a name="l09788"></a>09788   refresh: <span class="keyword">function</span>() {
<a name="l09789"></a>09789     <span class="comment">// no one should actually call this.</span>
<a name="l09790"></a>09790   },
<a name="l09791"></a>09791 
<a name="l09792"></a>09792   reqNoteRanges: <span class="keyword">function</span>(firstIndex, firstSuid, lastIndex, lastSuid) {
<a name="l09793"></a>09793     <span class="comment">// when shrinking our range, we could try and be clever and use the values</span>
<a name="l09794"></a>09794     <span class="comment">// of the first thing we are updating to adjust our range, but it&#39;s safest/</span>
<a name="l09795"></a>09795     <span class="comment">// easiest right now to just use what we are left with.</span>
<a name="l09796"></a>09796 
<a name="l09797"></a>09797     <span class="comment">// THIS CODE IS COPIED FROM `MailSlice`&#39;s reqNoteRanges implementation</span>
<a name="l09798"></a>09798 
<a name="l09799"></a>09799     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l09800"></a>09800     <span class="comment">// - Fixup indices if required</span>
<a name="l09801"></a>09801     <span class="keywordflow">if</span> (firstIndex &gt;= this.headers.length ||
<a name="l09802"></a>09802         <span class="keyword">this</span>.headers[firstIndex].suid !== firstSuid) {
<a name="l09803"></a>09803       firstIndex = 0; <span class="comment">// default to not splicing if it&#39;s gone</span>
<a name="l09804"></a>09804       <span class="keywordflow">for</span> (i = 0; i &lt; this.headers.length; i++) {
<a name="l09805"></a>09805         <span class="keywordflow">if</span> (this.headers[i].suid === firstSuid) {
<a name="l09806"></a>09806           firstIndex = <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l09807"></a>09807           <span class="keywordflow">break</span>;
<a name="l09808"></a>09808         }
<a name="l09809"></a>09809       }
<a name="l09810"></a>09810     }
<a name="l09811"></a>09811     <span class="keywordflow">if</span> (lastIndex &gt;= this.headers.length ||
<a name="l09812"></a>09812         <span class="keyword">this</span>.headers[lastIndex].suid !== lastSuid) {
<a name="l09813"></a>09813       <span class="keywordflow">for</span> (i = this.headers.length - 1; i &gt;= 0; i--) {
<a name="l09814"></a>09814         <span class="keywordflow">if</span> (this.headers[i].suid === lastSuid) {
<a name="l09815"></a>09815           lastIndex = <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l09816"></a>09816           <span class="keywordflow">break</span>;
<a name="l09817"></a>09817         }
<a name="l09818"></a>09818       }
<a name="l09819"></a>09819     }
<a name="l09820"></a>09820 
<a name="l09821"></a>09821     <span class="comment">// - Perform splices as required</span>
<a name="l09822"></a>09822     <span class="comment">// (high before low to avoid index changes)</span>
<a name="l09823"></a>09823     <span class="keywordflow">if</span> (lastIndex + 1 &lt; this.headers.length) {
<a name="l09824"></a>09824       this.atBottom = <span class="keyword">false</span>;
<a name="l09825"></a>09825       this.userCanGrowDownwards = <span class="keyword">false</span>;
<a name="l09826"></a>09826       var delCount = this.headers.length - lastIndex  - 1;
<a name="l09827"></a>09827       this.desiredHeaders -= delCount;
<a name="l09828"></a>09828       <span class="keywordflow">if</span> (!this._accumulating)
<a name="l09829"></a>09829         this._bridgeHandle.sendSplice(
<a name="l09830"></a>09830           lastIndex + 1, delCount, [],
<a name="l09831"></a>09831           <span class="comment">// This is expected; more coming if there&#39;s a low-end splice</span>
<a name="l09832"></a>09832           <span class="keyword">true</span>, firstIndex &gt; 0);
<a name="l09833"></a>09833       this.headers.splice(lastIndex + 1, this.headers.length - lastIndex - 1);
<a name="l09834"></a>09834       var lastHeader = this.headers[lastIndex];
<a name="l09835"></a>09835       this.startTS = lastHeader.date;
<a name="l09836"></a>09836       this.startUID = lastHeader.id;
<a name="l09837"></a>09837     }
<a name="l09838"></a>09838     <span class="keywordflow">if</span> (firstIndex &gt; 0) {
<a name="l09839"></a>09839       this.atTop = <span class="keyword">false</span>;
<a name="l09840"></a>09840       this.desiredHeaders -= firstIndex;
<a name="l09841"></a>09841       <span class="keywordflow">if</span> (!this._accumulating)
<a name="l09842"></a>09842         this._bridgeHandle.sendSplice(0, firstIndex, [], <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l09843"></a>09843       this.headers.splice(0, firstIndex);
<a name="l09844"></a>09844       var firstHeader = this.headers[0];
<a name="l09845"></a>09845       this.endTS = firstHeader.date;
<a name="l09846"></a>09846       this.endUID = firstHeader.id;
<a name="l09847"></a>09847     }
<a name="l09848"></a>09848   },
<a name="l09849"></a>09849 
<a name="l09850"></a>09850   reqGrow: <span class="keyword">function</span>(dirMagnitude, userRequestsGrowth) {
<a name="l09851"></a>09851     <span class="keywordflow">if</span> (dirMagnitude === -1) {
<a name="l09852"></a>09852       this._storage.getMessagesAfterMessage(this.endTS, this.endUID,
<a name="l09853"></a>09853                                             $syncbase.INITIAL_FILL_SIZE,
<a name="l09854"></a>09854                                             <span class="keyword">this</span>._gotMessages.bind(<span class="keyword">this</span>, -1));
<a name="l09855"></a>09855     }
<a name="l09856"></a>09856     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirMagnitude === 1) {
<a name="l09857"></a>09857       this._storage.getMessagesBeforeMessage(this.startTS, this.startUID,
<a name="l09858"></a>09858                                              $syncbase.INITIAL_FILL_SIZE,
<a name="l09859"></a>09859                                              <span class="keyword">this</span>._gotMessages.bind(<span class="keyword">this</span>, 1));
<a name="l09860"></a>09860     }
<a name="l09861"></a>09861   },
<a name="l09862"></a>09862 
<a name="l09863"></a>09863   <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span>() {
<a name="l09864"></a>09864     this._bridgeHandle = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l09865"></a>09865     this._LOG.__die();
<a name="l09866"></a>09866   },
<a name="l09867"></a>09867 };
<a name="l09868"></a>09868 
<a name="l09869"></a>09869 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l09870"></a>09870   SearchSlice: {
<a name="l09871"></a>09871     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: $log.QUERY,
<a name="l09872"></a>09872     events: {
<a name="l09873"></a>09873     },
<a name="l09874"></a>09874     TEST_ONLY_events: {
<a name="l09875"></a>09875     },
<a name="l09876"></a>09876   },
<a name="l09877"></a>09877 }); <span class="comment">// end LOGFAB</span>
<a name="l09878"></a>09878 
<a name="l09879"></a>09879 
<a name="l09880"></a>09880 }); <span class="comment">// end define</span>
<a name="l09881"></a>09881 ;
<a name="l09882"></a>09882 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/worker-router&#39;</span>,[],<span class="keyword">function</span>() {
<a name="l09883"></a>09883 
<a name="l09884"></a>09884 var listeners = {};
<a name="l09885"></a>09885 
<a name="l09886"></a>09886 <span class="keyword">function</span> receiveMessage(evt) {
<a name="l09887"></a>09887   var <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = evt.data;
<a name="l09888"></a>09888 <span class="comment">//dump(&#39;\x1b[37mw &lt;= M: recv: &#39;+data.type+&#39; &#39;+data.uid+&#39; &#39;+data.cmd +&#39;\x1b[0m\n&#39;);</span>
<a name="l09889"></a>09889   var listener = listeners[data.type];
<a name="l09890"></a>09890   <span class="keywordflow">if</span> (listener)
<a name="l09891"></a>09891     listener(data);
<a name="l09892"></a>09892 }
<a name="l09893"></a>09893 
<a name="l09894"></a>09894 <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;message&#39;</span>, receiveMessage);
<a name="l09895"></a>09895 
<a name="l09896"></a>09896 
<a name="l09897"></a>09897 <span class="keyword">function</span> unregister(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l09898"></a>09898   <span class="keyword">delete</span> listeners[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l09899"></a>09899 }
<a name="l09900"></a>09900 
<a name="l09901"></a>09901 <span class="keyword">function</span> registerSimple(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l09902"></a>09902   listeners[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>;
<a name="l09903"></a>09903 
<a name="l09904"></a>09904   <span class="keywordflow">return</span> <span class="keyword">function</span> sendSimpleMessage(cmd, args) {
<a name="l09905"></a>09905     <span class="comment">//dump(&#39;\x1b[34mw =&gt; M: send: &#39; + type + &#39; null &#39; + cmd + &#39;\x1b[0m\n&#39;);</span>
<a name="l09906"></a>09906     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.postMessage({ <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, uid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, cmd: cmd, args: args });
<a name="l09907"></a>09907   };
<a name="l09908"></a>09908 }
<a name="l09909"></a>09909 
<a name="l09910"></a>09910 var callbackSenders = {};
<a name="l09911"></a>09911 
<a name="l09917"></a>09917 <span class="keyword">function</span> registerCallbackType(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l09918"></a>09918   <span class="keywordflow">if</span> (callbackSenders.hasOwnProperty(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>))
<a name="l09919"></a>09919     <span class="keywordflow">return</span> callbackSenders[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l09920"></a>09920   listeners[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <span class="keyword">function</span> receiveCallbackMessage(data) {
<a name="l09921"></a>09921     var <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> = <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a>[data.uid];
<a name="l09922"></a>09922     <span class="keywordflow">if</span> (!callback)
<a name="l09923"></a>09923       <span class="keywordflow">return</span>;
<a name="l09924"></a>09924     <span class="keyword">delete</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a>[data.uid];
<a name="l09925"></a>09925 
<a name="l09926"></a>09926     callback.apply(callback, data.args);
<a name="l09927"></a>09927   };
<a name="l09928"></a>09928   var <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a> = {};
<a name="l09929"></a>09929   var uid = 0;
<a name="l09930"></a>09930 
<a name="l09931"></a>09931   var sender = <span class="keyword">function</span> sendCallbackMessage(cmd, args, callback) {
<a name="l09932"></a>09932     <span class="keywordflow">if</span> (callback) {
<a name="l09933"></a>09933       callbacks[uid] = <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>;
<a name="l09934"></a>09934     }
<a name="l09935"></a>09935 
<a name="l09936"></a>09936     <span class="comment">//dump(&#39;\x1b[34mw =&gt; M: send: &#39; + type + &#39; &#39; + uid + &#39; &#39; + cmd + &#39;\x1b[0m\n&#39;);</span>
<a name="l09937"></a>09937     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.postMessage({ <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, uid: uid++, cmd: cmd, args: args });
<a name="l09938"></a>09938   };
<a name="l09939"></a>09939   callbackSenders[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = sender;
<a name="l09940"></a>09940   <span class="keywordflow">return</span> sender;
<a name="l09941"></a>09941 }
<a name="l09942"></a>09942 
<a name="l09947"></a>09947 <span class="keyword">function</span> registerInstanceType(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l09948"></a>09948   var uid = 0;
<a name="l09949"></a>09949   var instanceMap = {};
<a name="l09950"></a>09950   listeners[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <span class="keyword">function</span> receiveInstanceMessage(data) {
<a name="l09951"></a>09951     var instanceListener = instanceMap[data.uid];
<a name="l09952"></a>09952     <span class="keywordflow">if</span> (!instanceListener)
<a name="l09953"></a>09953       <span class="keywordflow">return</span>;
<a name="l09954"></a>09954 
<a name="l09955"></a>09955     instanceListener(data);
<a name="l09956"></a>09956   };
<a name="l09957"></a>09957 
<a name="l09958"></a>09958   <span class="keywordflow">return</span> {
<a name="l09959"></a>09959     <span class="keyword">register</span>: <span class="keyword">function</span>(instanceListener) {
<a name="l09960"></a>09960       var thisUid = uid++;
<a name="l09961"></a>09961       instanceMap[thisUid] = instanceListener;
<a name="l09962"></a>09962 
<a name="l09963"></a>09963       <span class="keywordflow">return</span> {
<a name="l09964"></a>09964         sendMessage: <span class="keyword">function</span> sendInstanceMessage(cmd, args) {
<a name="l09965"></a>09965 <span class="comment">//dump(&#39;\x1b[34mw =&gt; M: send: &#39; + type + &#39; &#39; + thisUid + &#39; &#39; + cmd + &#39;\x1b[0m\n&#39;);</span>
<a name="l09966"></a>09966           <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.postMessage({ <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, uid: thisUid,
<a name="l09967"></a>09967                                cmd: cmd, args: args });
<a name="l09968"></a>09968         },
<a name="l09969"></a>09969         unregister: <span class="keyword">function</span> unregisterInstance() {
<a name="l09970"></a>09970           <span class="keyword">delete</span> instanceMap[thisUid];
<a name="l09971"></a>09971         }
<a name="l09972"></a>09972       };
<a name="l09973"></a>09973     },
<a name="l09974"></a>09974   };
<a name="l09975"></a>09975 }
<a name="l09976"></a>09976 
<a name="l09977"></a>09977 <span class="keyword">function</span> <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>() {
<a name="l09978"></a>09978   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.removeEventListener(<span class="stringliteral">&#39;message&#39;</span>, receiveMessage);
<a name="l09979"></a>09979   listeners = {};
<a name="l09980"></a>09980   callbackSenders = {};
<a name="l09981"></a>09981 }
<a name="l09982"></a>09982 
<a name="l09983"></a>09983 <span class="keywordflow">return</span> {
<a name="l09984"></a>09984   registerSimple: registerSimple,
<a name="l09985"></a>09985   registerCallbackType: registerCallbackType,
<a name="l09986"></a>09986   registerInstanceType: registerInstanceType,
<a name="l09987"></a>09987   unregister: unregister,
<a name="l09988"></a>09988   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>
<a name="l09989"></a>09989 };
<a name="l09990"></a>09990 
<a name="l09991"></a>09991 }); <span class="comment">// end define</span>
<a name="l09992"></a>09992 ;
<a name="l09997"></a>09997 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/jobmixins&#39;</span>,
<a name="l09998"></a>09998   [
<a name="l09999"></a>09999     <span class="stringliteral">&#39;./worker-router&#39;</span>,
<a name="l10000"></a>10000     <span class="stringliteral">&#39;./util&#39;</span>,
<a name="l10001"></a>10001     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l10002"></a>10002   ],
<a name="l10003"></a>10003   <span class="keyword">function</span>(
<a name="l10004"></a>10004     $router,
<a name="l10005"></a>10005     $util,
<a name="l10006"></a>10006     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l10007"></a>10007   ) {
<a name="l10008"></a>10008 
<a name="l10009"></a>10009 var sendMessage = $router.registerCallbackType(<span class="stringliteral">&#39;devicestorage&#39;</span>);
<a name="l10010"></a>10010 
<a name="l10011"></a>10011 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_do_modtags = <span class="keyword">function</span>(op, doneCallback, undo) {
<a name="l10012"></a>10012   var addTags = undo ? op.removeTags : op.addTags,
<a name="l10013"></a>10013       removeTags = undo ? op.addTags : op.removeTags;
<a name="l10014"></a>10014   this._partitionAndAccessFoldersSequentially(
<a name="l10015"></a>10015     op.messages,
<a name="l10016"></a>10016     <span class="keyword">false</span>,
<a name="l10017"></a>10017     <span class="keyword">function</span> perFolder(ignoredConn, storage, headers, namers, callWhenDone) {
<a name="l10018"></a>10018       var waitingOn = headers.length;
<a name="l10019"></a>10019       <span class="keyword">function</span> next() {
<a name="l10020"></a>10020         <span class="keywordflow">if</span> (--waitingOn === 0)
<a name="l10021"></a>10021           callWhenDone();
<a name="l10022"></a>10022       }
<a name="l10023"></a>10023       <span class="keywordflow">for</span> (var iHeader = 0; iHeader &lt; headers.length; iHeader++) {
<a name="l10024"></a>10024         var header = headers[iHeader];
<a name="l10025"></a>10025         var iTag, tag, existing, modified = <span class="keyword">false</span>;
<a name="l10026"></a>10026         <span class="keywordflow">if</span> (addTags) {
<a name="l10027"></a>10027           <span class="keywordflow">for</span> (iTag = 0; iTag &lt; addTags.length; iTag++) {
<a name="l10028"></a>10028             tag = addTags[iTag];
<a name="l10029"></a>10029             <span class="comment">// The list should be small enough that native stuff is better</span>
<a name="l10030"></a>10030             <span class="comment">// than JS bsearch.</span>
<a name="l10031"></a>10031             existing = header.flags.indexOf(tag);
<a name="l10032"></a>10032             <span class="keywordflow">if</span> (existing !== -1)
<a name="l10033"></a>10033               <span class="keywordflow">continue</span>;
<a name="l10034"></a>10034             header.flags.push(tag);
<a name="l10035"></a>10035             header.flags.sort(); <span class="comment">// (maintain sorted invariant)</span>
<a name="l10036"></a>10036             modified = <span class="keyword">true</span>;
<a name="l10037"></a>10037           }
<a name="l10038"></a>10038         }
<a name="l10039"></a>10039         <span class="keywordflow">if</span> (removeTags) {
<a name="l10040"></a>10040           <span class="keywordflow">for</span> (iTag = 0; iTag &lt; removeTags.length; iTag++) {
<a name="l10041"></a>10041             tag = removeTags[iTag];
<a name="l10042"></a>10042             existing = header.flags.indexOf(tag);
<a name="l10043"></a>10043             <span class="keywordflow">if</span> (existing === -1)
<a name="l10044"></a>10044               <span class="keywordflow">continue</span>;
<a name="l10045"></a>10045             header.flags.splice(existing, 1);
<a name="l10046"></a>10046             modified = <span class="keyword">true</span>;
<a name="l10047"></a>10047           }
<a name="l10048"></a>10048         }
<a name="l10049"></a>10049         storage.updateMessageHeader(header.date, header.id, <span class="keyword">false</span>,
<a name="l10050"></a>10050                                     header, next);
<a name="l10051"></a>10051       }
<a name="l10052"></a>10052     },
<a name="l10053"></a>10053     <span class="keyword">function</span>() {
<a name="l10054"></a>10054       doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="keyword">true</span>);
<a name="l10055"></a>10055     },
<a name="l10056"></a>10056     <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">// connection loss does not happen for local-only ops</span>
<a name="l10057"></a>10057     undo,
<a name="l10058"></a>10058     <span class="stringliteral">&#39;modtags&#39;</span>);
<a name="l10059"></a>10059 };
<a name="l10060"></a>10060 
<a name="l10061"></a>10061 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_undo_modtags = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10062"></a>10062   <span class="comment">// Undoing is just a question of flipping the add and remove lists.</span>
<a name="l10063"></a>10063   <span class="keywordflow">return</span> this.local_do_modtags(op, callback, <span class="keyword">true</span>);
<a name="l10064"></a>10064 };
<a name="l10065"></a>10065 
<a name="l10066"></a>10066 
<a name="l10067"></a>10067 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_do_move = <span class="keyword">function</span>(op, doneCallback, targetFolderId) {
<a name="l10068"></a>10068   <span class="comment">// create a scratch field to store the guid&#39;s for check purposes</span>
<a name="l10069"></a>10069   op.guids = {};
<a name="l10070"></a>10070   var nukeServerIds = !this.resilientServerIds;
<a name="l10071"></a>10071 
<a name="l10072"></a>10072   var stateDelta = this._stateDelta, addWait = 0, <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l10073"></a>10073   <span class="keywordflow">if</span> (!stateDelta.moveMap)
<a name="l10074"></a>10074     stateDelta.moveMap = {};
<a name="l10075"></a>10075   <span class="keywordflow">if</span> (!stateDelta.serverIdMap)
<a name="l10076"></a>10076     stateDelta.serverIdMap = {};
<a name="l10077"></a>10077   <span class="keywordflow">if</span> (!targetFolderId)
<a name="l10078"></a>10078     targetFolderId = op.targetFolder;
<a name="l10079"></a>10079 
<a name="l10080"></a>10080   this._partitionAndAccessFoldersSequentially(
<a name="l10081"></a>10081     op.messages, <span class="keyword">false</span>,
<a name="l10082"></a>10082     <span class="keyword">function</span> perFolder(ignoredConn, sourceStorage, headers, namers,
<a name="l10083"></a>10083                        perFolderDone) {
<a name="l10084"></a>10084       <span class="comment">// -- open the target folder for processing</span>
<a name="l10085"></a>10085       <span class="keyword">function</span> targetOpened_nowProcess(ignoredConn, _targetStorage) {
<a name="l10086"></a>10086         targetStorage = _targetStorage;
<a name="l10087"></a>10087         processNext();
<a name="l10088"></a>10088       }
<a name="l10089"></a>10089       <span class="comment">// -- get the body for the next header (or be done)</span>
<a name="l10090"></a>10090       <span class="keyword">function</span> processNext() {
<a name="l10091"></a>10091         <span class="keywordflow">if</span> (iNextHeader &gt;= headers.length) {
<a name="l10092"></a>10092           perFolderDone();
<a name="l10093"></a>10093           <span class="keywordflow">return</span>;
<a name="l10094"></a>10094         }
<a name="l10095"></a>10095         header = headers[iNextHeader++];
<a name="l10096"></a>10096         sourceStorage.getMessageBody(header.suid, header.date,
<a name="l10097"></a>10097                                      gotBody_nowDelete);
<a name="l10098"></a>10098       }
<a name="l10099"></a>10099       <span class="comment">// -- delete the header and body from the source</span>
<a name="l10100"></a>10100       <span class="keyword">function</span> gotBody_nowDelete(_body) {
<a name="l10101"></a>10101         body = _body;
<a name="l10102"></a>10102 
<a name="l10103"></a>10103         <span class="comment">// We need an entry in the server id map if we are moving/deleting it.</span>
<a name="l10104"></a>10104         <span class="comment">// We don&#39;t need this if we&#39;re moving a message to the folder it&#39;s</span>
<a name="l10105"></a>10105         <span class="comment">// already in, but it doesn&#39;t hurt anything.</span>
<a name="l10106"></a>10106         <span class="keywordflow">if</span> (header.srvid)
<a name="l10107"></a>10107           stateDelta.serverIdMap[header.suid] = header.srvid;
<a name="l10108"></a>10108 
<a name="l10109"></a>10109         <span class="keywordflow">if</span> (sourceStorage === targetStorage ||
<a name="l10110"></a>10110             <span class="comment">// localdraft messages aren&#39;t real, and so must not be moved and</span>
<a name="l10111"></a>10111             <span class="comment">// are only eligible for nuke deletion.</span>
<a name="l10112"></a>10112             sourceStorage.folderMeta.type === <span class="stringliteral">&#39;localdrafts&#39;</span>) {
<a name="l10113"></a>10113           <span class="keywordflow">if</span> (op.type === <span class="stringliteral">&#39;move&#39;</span>) {
<a name="l10114"></a>10114             <span class="comment">// A move from a folder to itself is a no-op.</span>
<a name="l10115"></a>10115             processNext();
<a name="l10116"></a>10116           }
<a name="l10117"></a>10117           <span class="keywordflow">else</span> { <span class="comment">// op.type === &#39;delete&#39;</span>
<a name="l10118"></a>10118             <span class="comment">// If the op is a delete and the source and destination folders</span>
<a name="l10119"></a>10119             <span class="comment">// match, we&#39;re deleting from trash, so just perma-delete it.</span>
<a name="l10120"></a>10120             sourceStorage.deleteMessageHeaderAndBodyUsingHeader(
<a name="l10121"></a>10121               header, processNext);
<a name="l10122"></a>10122           }
<a name="l10123"></a>10123         }
<a name="l10124"></a>10124         <span class="keywordflow">else</span> {
<a name="l10125"></a>10125           sourceStorage.deleteMessageHeaderAndBodyUsingHeader(
<a name="l10126"></a>10126             header, deleted_nowAdd);
<a name="l10127"></a>10127         }
<a name="l10128"></a>10128       }
<a name="l10129"></a>10129       <span class="comment">// -- add the header/body to the target folder</span>
<a name="l10130"></a>10130       <span class="keyword">function</span> deleted_nowAdd() {
<a name="l10131"></a>10131         var sourceSuid = header.suid;
<a name="l10132"></a>10132 
<a name="l10133"></a>10133         <span class="comment">// - update id fields</span>
<a name="l10134"></a>10134         header.id = targetStorage._issueNewHeaderId();
<a name="l10135"></a>10135         header.suid = targetStorage.folderId + <span class="charliteral">&#39;/&#39;</span> + header.id;
<a name="l10136"></a>10136         <span class="keywordflow">if</span> (nukeServerIds)
<a name="l10137"></a>10137           header.srvid = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10138"></a>10138 
<a name="l10139"></a>10139         stateDelta.moveMap[sourceSuid] = header.suid;
<a name="l10140"></a>10140 
<a name="l10141"></a>10141         addWait = 2;
<a name="l10142"></a>10142         targetStorage.addMessageHeader(header, added);
<a name="l10143"></a>10143         targetStorage.addMessageBody(header, body, added);
<a name="l10144"></a>10144       }
<a name="l10145"></a>10145       <span class="keyword">function</span> added() {
<a name="l10146"></a>10146         <span class="keywordflow">if</span> (--addWait !== 0)
<a name="l10147"></a>10147           <span class="keywordflow">return</span>;
<a name="l10148"></a>10148         processNext();
<a name="l10149"></a>10149       }
<a name="l10150"></a>10150       var iNextHeader = 0, targetStorage = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, header = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, body = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l10151"></a>10151           addWait = 0;
<a name="l10152"></a>10152 
<a name="l10153"></a>10153       <span class="comment">// If the source folder and the target folder are the same, don&#39;t try</span>
<a name="l10154"></a>10154       <span class="comment">// to access the target folder!</span>
<a name="l10155"></a>10155       <span class="keywordflow">if</span> (sourceStorage.folderId === targetFolderId) {
<a name="l10156"></a>10156         targetStorage = sourceStorage;
<a name="l10157"></a>10157         processNext();
<a name="l10158"></a>10158       }
<a name="l10159"></a>10159       <span class="keywordflow">else</span> {
<a name="l10160"></a>10160         <span class="keyword">self</span>._accessFolderForMutation(targetFolderId, <span class="keyword">false</span>,
<a name="l10161"></a>10161                                       targetOpened_nowProcess, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l10162"></a>10162                                       <span class="stringliteral">&#39;local move target&#39;</span>);
<a name="l10163"></a>10163       }
<a name="l10164"></a>10164     },
<a name="l10165"></a>10165     <span class="keyword">function</span>() {
<a name="l10166"></a>10166       doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="keyword">true</span>);
<a name="l10167"></a>10167     },
<a name="l10168"></a>10168     <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">// connection loss does not happen for local-only ops</span>
<a name="l10169"></a>10169     <span class="keyword">false</span>,
<a name="l10170"></a>10170     <span class="stringliteral">&#39;local move source&#39;</span>);
<a name="l10171"></a>10171 };
<a name="l10172"></a>10172 
<a name="l10173"></a>10173 <span class="comment">// XXX implement!</span>
<a name="l10174"></a>10174 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_undo_move = <span class="keyword">function</span>(op, doneCallback, targetFolderId) {
<a name="l10175"></a>10175   doneCallback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10176"></a>10176 };
<a name="l10177"></a>10177 
<a name="l10178"></a>10178 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_do_delete = <span class="keyword">function</span>(op, doneCallback) {
<a name="l10179"></a>10179   var trashFolder = this.account.getFirstFolderWithType(<span class="stringliteral">&#39;trash&#39;</span>);
<a name="l10180"></a>10180   <span class="keywordflow">if</span> (!trashFolder) {
<a name="l10181"></a>10181     this.account.ensureEssentialFolders();
<a name="l10182"></a>10182     doneCallback(<span class="stringliteral">&#39;defer&#39;</span>);
<a name="l10183"></a>10183     <span class="keywordflow">return</span>;
<a name="l10184"></a>10184   }
<a name="l10185"></a>10185   this.local_do_move(op, doneCallback, trashFolder.id);
<a name="l10186"></a>10186 };
<a name="l10187"></a>10187 
<a name="l10188"></a>10188 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_undo_delete = <span class="keyword">function</span>(op, doneCallback) {
<a name="l10189"></a>10189   var trashFolder = this.account.getFirstFolderWithType(<span class="stringliteral">&#39;trash&#39;</span>);
<a name="l10190"></a>10190   <span class="keywordflow">if</span> (!trashFolder) {
<a name="l10191"></a>10191     <span class="comment">// the absence of the trash folder when it must have previously existed is</span>
<a name="l10192"></a>10192     <span class="comment">// confusing.</span>
<a name="l10193"></a>10193     doneCallback(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l10194"></a>10194     <span class="keywordflow">return</span>;
<a name="l10195"></a>10195   }
<a name="l10196"></a>10196   this.local_undo_move(op, doneCallback, trashFolder.id);
<a name="l10197"></a>10197 };
<a name="l10198"></a>10198 
<a name="l10199"></a>10199 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.do_download = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10200"></a>10200   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l10201"></a>10201   var idxLastSlash = op.messageSuid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>),
<a name="l10202"></a>10202       folderId = op.messageSuid.substring(0, idxLastSlash);
<a name="l10203"></a>10203 
<a name="l10204"></a>10204   var folderConn, folderStorage;
<a name="l10205"></a>10205   <span class="comment">// Once we have the connection, get the current state of the body rep.</span>
<a name="l10206"></a>10206   var gotConn = <span class="keyword">function</span> gotConn(_folderConn, _folderStorage) {
<a name="l10207"></a>10207     folderConn = _folderConn;
<a name="l10208"></a>10208     folderStorage = _folderStorage;
<a name="l10209"></a>10209 
<a name="l10210"></a>10210     folderStorage.getMessageHeader(op.messageSuid, op.messageDate, gotHeader);
<a name="l10211"></a>10211   };
<a name="l10212"></a>10212   var deadConn = <span class="keyword">function</span> deadConn() {
<a name="l10213"></a>10213     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;aborted-retry&#39;</span>);
<a name="l10214"></a>10214   };
<a name="l10215"></a>10215   <span class="comment">// Now that we have the body, we can know the part numbers and eliminate /</span>
<a name="l10216"></a>10216   <span class="comment">// filter out any redundant download requests.  Issue all the fetches at</span>
<a name="l10217"></a>10217   <span class="comment">// once.</span>
<a name="l10218"></a>10218   var partsToDownload = [], storePartsTo = [], <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, bodyInfo, uid;
<a name="l10219"></a>10219   var gotHeader = <span class="keyword">function</span> gotHeader(_headerInfo) {
<a name="l10220"></a>10220     header = _headerInfo;
<a name="l10221"></a>10221     uid = header.srvid;
<a name="l10222"></a>10222     folderStorage.getMessageBody(op.messageSuid, op.messageDate, gotBody);
<a name="l10223"></a>10223   };
<a name="l10224"></a>10224   var gotBody = <span class="keyword">function</span> gotBody(_bodyInfo) {
<a name="l10225"></a>10225     bodyInfo = _bodyInfo;
<a name="l10226"></a>10226     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, partInfo;
<a name="l10227"></a>10227     <span class="keywordflow">for</span> (i = 0; i &lt; op.relPartIndices.length; i++) {
<a name="l10228"></a>10228       partInfo = bodyInfo.relatedParts[op.relPartIndices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]];
<a name="l10229"></a>10229       <span class="keywordflow">if</span> (partInfo.file)
<a name="l10230"></a>10230         <span class="keywordflow">continue</span>;
<a name="l10231"></a>10231       partsToDownload.push(partInfo);
<a name="l10232"></a>10232       storePartsTo.push(<span class="stringliteral">&#39;idb&#39;</span>);
<a name="l10233"></a>10233     }
<a name="l10234"></a>10234     <span class="keywordflow">for</span> (i = 0; i &lt; op.attachmentIndices.length; i++) {
<a name="l10235"></a>10235       partInfo = bodyInfo.attachments[op.attachmentIndices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]];
<a name="l10236"></a>10236       <span class="keywordflow">if</span> (partInfo.file)
<a name="l10237"></a>10237         <span class="keywordflow">continue</span>;
<a name="l10238"></a>10238       partsToDownload.push(partInfo);
<a name="l10239"></a>10239       <span class="comment">// right now all attachments go in sdcard</span>
<a name="l10240"></a>10240       storePartsTo.push(<span class="stringliteral">&#39;sdcard&#39;</span>);
<a name="l10241"></a>10241     }
<a name="l10242"></a>10242 
<a name="l10243"></a>10243     folderConn.downloadMessageAttachments(uid, partsToDownload, gotParts);
<a name="l10244"></a>10244   };
<a name="l10245"></a>10245   var pendingStorageWrites = 0, downloadErr = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10250"></a>10250   <span class="keyword">function</span> saveToStorage(blob, storage, <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>, partInfo, isRetry) {
<a name="l10251"></a>10251     pendingStorageWrites++;
<a name="l10252"></a>10252 
<a name="l10253"></a>10253     var callback = <span class="keyword">function</span>(<a class="code" href="../../db/df4/geoloc_8js.html#a15b4f92b0ef49ac05f43437f3d85ae46">success</a>, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, savedFilename) {
<a name="l10254"></a>10254       <span class="keywordflow">if</span> (<a class="code" href="../../db/df4/geoloc_8js.html#a15b4f92b0ef49ac05f43437f3d85ae46">success</a>) {
<a name="l10255"></a>10255         <span class="keyword">self</span>._LOG.savedAttachment(storage, blob.type, blob.size);
<a name="l10256"></a>10256         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;saved attachment to&#39;</span>, storage, savedFilename, <span class="stringliteral">&#39;type:&#39;</span>, blob.type);
<a name="l10257"></a>10257         partInfo.file = [storage, savedFilename];
<a name="l10258"></a>10258         <span class="keywordflow">if</span> (--pendingStorageWrites === 0)
<a name="l10259"></a>10259           <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l10260"></a>10260       } <span class="keywordflow">else</span> {
<a name="l10261"></a>10261         <span class="keyword">self</span>._LOG.saveFailure(storage, blob.type, error, <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>);
<a name="l10262"></a>10262         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;failed to save attachment to&#39;</span>, storage, <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>,
<a name="l10263"></a>10263                      <span class="stringliteral">&#39;type:&#39;</span>, blob.type);
<a name="l10264"></a>10264         pendingStorageWrites--;
<a name="l10265"></a>10265         <span class="comment">// if we failed to unique the file after appending junk, just give up</span>
<a name="l10266"></a>10266         <span class="keywordflow">if</span> (isRetry) {
<a name="l10267"></a>10267           <span class="keywordflow">if</span> (pendingStorageWrites === 0)
<a name="l10268"></a>10268             <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l10269"></a>10269           <span class="keywordflow">return</span>;
<a name="l10270"></a>10270         }
<a name="l10271"></a>10271         <span class="comment">// retry by appending a super huge timestamp to the file before its</span>
<a name="l10272"></a>10272         <span class="comment">// extension.</span>
<a name="l10273"></a>10273         var idxLastPeriod = <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>.lastIndexOf(<span class="charliteral">&#39;.&#39;</span>);
<a name="l10274"></a>10274         <span class="keywordflow">if</span> (idxLastPeriod === -1)
<a name="l10275"></a>10275           idxLastPeriod = <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>.length;
<a name="l10276"></a>10276         <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a> = <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>.substring(0, idxLastPeriod) + <span class="charliteral">&#39;-&#39;</span> + Date.now() +
<a name="l10277"></a>10277                     <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>.substring(idxLastPeriod);
<a name="l10278"></a>10278         saveToStorage(blob, storage, <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>, partInfo, <span class="keyword">true</span>);
<a name="l10279"></a>10279       }
<a name="l10280"></a>10280     };
<a name="l10281"></a>10281     sendMessage(<span class="stringliteral">&#39;save&#39;</span>, [storage, blob, <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>], callback);
<a name="l10282"></a>10282   }
<a name="l10283"></a>10283   var gotParts = <span class="keyword">function</span> gotParts(err, bodyBlobs) {
<a name="l10284"></a>10284     <span class="keywordflow">if</span> (bodyBlobs.length !== partsToDownload.length) {
<a name="l10285"></a>10285       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(err, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="keyword">false</span>);
<a name="l10286"></a>10286       <span class="keywordflow">return</span>;
<a name="l10287"></a>10287     }
<a name="l10288"></a>10288     downloadErr = err;
<a name="l10289"></a>10289     <span class="keywordflow">for</span> (var i = 0; i &lt; partsToDownload.length; i++) {
<a name="l10290"></a>10290       <span class="comment">// Because we should be under a mutex, this part should still be the</span>
<a name="l10291"></a>10291       <span class="comment">// live representation and we can mutate it.</span>
<a name="l10292"></a>10292       var partInfo = partsToDownload[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l10293"></a>10293           blob = bodyBlobs[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l10294"></a>10294           storeTo = storePartsTo[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l10295"></a>10295 
<a name="l10296"></a>10296       <span class="keywordflow">if</span> (blob) {
<a name="l10297"></a>10297         partInfo.sizeEstimate = blob.size;
<a name="l10298"></a>10298         partInfo.type = blob.type;
<a name="l10299"></a>10299         <span class="keywordflow">if</span> (storeTo === <span class="stringliteral">&#39;idb&#39;</span>)
<a name="l10300"></a>10300           partInfo.file = blob;
<a name="l10301"></a>10301         <span class="keywordflow">else</span>
<a name="l10302"></a>10302           saveToStorage(blob, storeTo, partInfo.name, partInfo);
<a name="l10303"></a>10303       }
<a name="l10304"></a>10304     }
<a name="l10305"></a>10305     <span class="keywordflow">if</span> (!pendingStorageWrites)
<a name="l10306"></a>10306       <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l10307"></a>10307   };
<a name="l10308"></a>10308 
<a name="l10309"></a>10309   <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>() {
<a name="l10310"></a>10310     folderStorage.updateMessageBody(header, bodyInfo, <span class="keyword">function</span>() {
<a name="l10311"></a>10311       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(downloadErr, bodyInfo, <span class="keyword">true</span>);
<a name="l10312"></a>10312     });
<a name="l10313"></a>10313   };
<a name="l10314"></a>10314 
<a name="l10315"></a>10315   <span class="keyword">self</span>._accessFolderForMutation(folderId, <span class="keyword">true</span>, gotConn, deadConn,
<a name="l10316"></a>10316                                 <span class="stringliteral">&#39;download&#39;</span>);
<a name="l10317"></a>10317 };
<a name="l10318"></a>10318 
<a name="l10319"></a>10319 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_do_download = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10320"></a>10320   <span class="comment">// Downloads are inherently online operations.</span>
<a name="l10321"></a>10321   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10322"></a>10322 };
<a name="l10323"></a>10323 
<a name="l10324"></a>10324 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.check_download = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10325"></a>10325   <span class="comment">// If we downloaded the file and persisted it successfully, this job would be</span>
<a name="l10326"></a>10326   <span class="comment">// marked done because of the atomicity guarantee on our commits.</span>
<a name="l10327"></a>10327   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;coherent-notyet&#39;</span>);
<a name="l10328"></a>10328 };
<a name="l10329"></a>10329 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_undo_download = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10330"></a>10330   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10331"></a>10331 };
<a name="l10332"></a>10332 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.undo_download = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10333"></a>10333   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10334"></a>10334 };
<a name="l10335"></a>10335 
<a name="l10336"></a>10336 
<a name="l10337"></a>10337 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_do_downloadBodies = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10338"></a>10338   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10339"></a>10339 };
<a name="l10340"></a>10340 
<a name="l10341"></a>10341 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.do_downloadBodies = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10342"></a>10342   var aggrErr, totalDownloaded = 0;
<a name="l10343"></a>10343   this._partitionAndAccessFoldersSequentially(
<a name="l10344"></a>10344     op.messages,
<a name="l10345"></a>10345     <span class="keyword">true</span>,
<a name="l10346"></a>10346     <span class="keyword">function</span> perFolder(folderConn, storage, headers, namers, callWhenDone) {
<a name="l10347"></a>10347       folderConn.downloadBodies(headers, op.options, <span class="keyword">function</span>(err, numDownloaded) {
<a name="l10348"></a>10348         totalDownloaded += numDownloaded;
<a name="l10349"></a>10349         <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (err &amp;&amp; !aggrErr) {
<a name="l10350"></a>10350           aggrErr = err;
<a name="l10351"></a>10351         }
<a name="l10352"></a>10352         callWhenDone();
<a name="l10353"></a>10353       });
<a name="l10354"></a>10354     },
<a name="l10355"></a>10355     <span class="keyword">function</span> allDone() {
<a name="l10356"></a>10356       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(aggrErr, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l10357"></a>10357                <span class="comment">// save if we might have done work.</span>
<a name="l10358"></a>10358                totalDownloaded &gt; 0);
<a name="l10359"></a>10359     },
<a name="l10360"></a>10360     <span class="keyword">function</span> deadConn() {
<a name="l10361"></a>10361       aggrErr = <span class="stringliteral">&#39;aborted-retry&#39;</span>;
<a name="l10362"></a>10362     },
<a name="l10363"></a>10363     <span class="keyword">false</span>, <span class="comment">// reverse?</span>
<a name="l10364"></a>10364     <span class="stringliteral">&#39;downloadBodies&#39;</span>,
<a name="l10365"></a>10365     <span class="keyword">true</span> <span class="comment">// require headers</span>
<a name="l10366"></a>10366   );
<a name="l10367"></a>10367 };
<a name="l10368"></a>10368 
<a name="l10369"></a>10369 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.check_downloadBodies = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10370"></a>10370   <span class="comment">// If we had downloaded the bodies and persisted them successfully, this job</span>
<a name="l10371"></a>10371   <span class="comment">// would be marked done because of the atomicity guarantee on our commits.  It</span>
<a name="l10372"></a>10372   <span class="comment">// is possible this request might only be partially serviced, in which case we</span>
<a name="l10373"></a>10373   <span class="comment">// will avoid redundant body fetches, but redundant folder selection is</span>
<a name="l10374"></a>10374   <span class="comment">// possible if this request spans multiple folders.</span>
<a name="l10375"></a>10375   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;coherent-notyet&#39;</span>);
<a name="l10376"></a>10376 };
<a name="l10377"></a>10377 
<a name="l10378"></a>10378 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.check_downloadBodyReps = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10379"></a>10379   <span class="comment">// If we downloaded all of the body parts and persisted them successfully,</span>
<a name="l10380"></a>10380   <span class="comment">// this job would be marked done because of the atomicity guarantee on our</span>
<a name="l10381"></a>10381   <span class="comment">// commits.  But it&#39;s not, so there&#39;s more to do.</span>
<a name="l10382"></a>10382   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;coherent-notyet&#39;</span>);
<a name="l10383"></a>10383 };
<a name="l10384"></a>10384 
<a name="l10385"></a>10385 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.do_downloadBodyReps = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10386"></a>10386   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l10387"></a>10387   var idxLastSlash = op.messageSuid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>),
<a name="l10388"></a>10388       folderId = op.messageSuid.substring(0, idxLastSlash);
<a name="l10389"></a>10389 
<a name="l10390"></a>10390   var folderConn, folderStorage;
<a name="l10391"></a>10391   <span class="comment">// Once we have the connection, get the current state of the body rep.</span>
<a name="l10392"></a>10392   var gotConn = <span class="keyword">function</span> gotConn(_folderConn, _folderStorage) {
<a name="l10393"></a>10393     folderConn = _folderConn;
<a name="l10394"></a>10394     folderStorage = _folderStorage;
<a name="l10395"></a>10395 
<a name="l10396"></a>10396     folderStorage.getMessageHeader(op.messageSuid, op.messageDate, gotHeader);
<a name="l10397"></a>10397   };
<a name="l10398"></a>10398   var deadConn = <span class="keyword">function</span> deadConn() {
<a name="l10399"></a>10399     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;aborted-retry&#39;</span>);
<a name="l10400"></a>10400   };
<a name="l10401"></a>10401 
<a name="l10402"></a>10402   var gotHeader = <span class="keyword">function</span> gotHeader(header) {
<a name="l10403"></a>10403     <span class="comment">// header may have been deleted by the time we get here...</span>
<a name="l10404"></a>10404     <span class="keywordflow">if</span> (!header) {
<a name="l10405"></a>10405       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l10406"></a>10406       <span class="keywordflow">return</span>;
<a name="l10407"></a>10407     }
<a name="l10408"></a>10408 
<a name="l10409"></a>10409     folderConn.downloadBodyReps(header, onDownloadReps);
<a name="l10410"></a>10410   };
<a name="l10411"></a>10411 
<a name="l10412"></a>10412   var onDownloadReps = <span class="keyword">function</span> onDownloadReps(err, bodyInfo) {
<a name="l10413"></a>10413     <span class="keywordflow">if</span> (err) {
<a name="l10414"></a>10414       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Error downloading reps&#39;</span>, err);
<a name="l10415"></a>10415       <span class="comment">// fail we cannot download for some reason?</span>
<a name="l10416"></a>10416       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;unknown&#39;</span>);
<a name="l10417"></a>10417       <span class="keywordflow">return</span>;
<a name="l10418"></a>10418     }
<a name="l10419"></a>10419 
<a name="l10420"></a>10420     <span class="comment">// success</span>
<a name="l10421"></a>10421     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, bodyInfo, <span class="keyword">true</span>);
<a name="l10422"></a>10422   };
<a name="l10423"></a>10423 
<a name="l10424"></a>10424   <span class="keyword">self</span>._accessFolderForMutation(folderId, <span class="keyword">true</span>, gotConn, deadConn,
<a name="l10425"></a>10425                                 <span class="stringliteral">&#39;downloadBodyReps&#39;</span>);
<a name="l10426"></a>10426 };
<a name="l10427"></a>10427 
<a name="l10428"></a>10428 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_do_downloadBodyReps = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10429"></a>10429   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10430"></a>10430 };
<a name="l10431"></a>10431 
<a name="l10432"></a>10432 
<a name="l10433"></a>10433 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_do_saveDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10434"></a>10434   var localDraftsFolder = this.account.getFirstFolderWithType(<span class="stringliteral">&#39;localdrafts&#39;</span>);
<a name="l10435"></a>10435   <span class="keywordflow">if</span> (!localDraftsFolder) {
<a name="l10436"></a>10436     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l10437"></a>10437     <span class="keywordflow">return</span>;
<a name="l10438"></a>10438   }
<a name="l10439"></a>10439   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l10440"></a>10440   this._accessFolderForMutation(
<a name="l10441"></a>10441     localDraftsFolder.id, <span class="comment">/* needConn*/</span> <span class="keyword">false</span>,
<a name="l10442"></a>10442     <span class="keyword">function</span>(nullFolderConn, folderStorage) {
<a name="l10443"></a>10443       <span class="keyword">function</span> next() {
<a name="l10444"></a>10444         <span class="keywordflow">if</span> (--waitingFor === 0) {
<a name="l10445"></a>10445           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(
<a name="l10446"></a>10446             <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l10447"></a>10447             { suid: header.suid, date: header.date },
<a name="l10448"></a>10448             <span class="comment">/* save account */</span> <span class="keyword">true</span>);
<a name="l10449"></a>10449         }
<a name="l10450"></a>10450       }
<a name="l10451"></a>10451       var waitingFor = 2;
<a name="l10452"></a>10452 
<a name="l10453"></a>10453       var header = op.header, body = op.body;
<a name="l10454"></a>10454       <span class="comment">// fill-in header id&#39;s</span>
<a name="l10455"></a>10455       header.id = folderStorage._issueNewHeaderId();
<a name="l10456"></a>10456       header.suid = folderStorage.folderId + <span class="charliteral">&#39;/&#39;</span> + header.id;
<a name="l10457"></a>10457 
<a name="l10458"></a>10458       <span class="comment">// If there already was a draft saved, delete it.</span>
<a name="l10459"></a>10459       <span class="comment">// Note that ordering of the removal and the addition doesn&#39;t really</span>
<a name="l10460"></a>10460       <span class="comment">// matter here because of our use of transactions.</span>
<a name="l10461"></a>10461       <span class="keywordflow">if</span> (op.existingNamer) {
<a name="l10462"></a>10462         waitingFor++;
<a name="l10463"></a>10463         folderStorage.deleteMessageHeaderAndBody(
<a name="l10464"></a>10464           op.existingNamer.suid, op.existingNamer.date, next);
<a name="l10465"></a>10465       }
<a name="l10466"></a>10466 
<a name="l10467"></a>10467       folderStorage.addMessageHeader(header, next);
<a name="l10468"></a>10468       folderStorage.addMessageBody(header, body, next);
<a name="l10469"></a>10469     },
<a name="l10470"></a>10470     <span class="comment">/* no conn =&gt; no deathback required */</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l10471"></a>10471     <span class="stringliteral">&#39;saveDraft&#39;</span>);
<a name="l10472"></a>10472 };
<a name="l10473"></a>10473 
<a name="l10474"></a>10474 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.do_saveDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10475"></a>10475   <span class="comment">// there is no server component for this</span>
<a name="l10476"></a>10476   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10477"></a>10477 };
<a name="l10478"></a>10478 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.check_saveDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10479"></a>10479   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;moot&#39;</span>);
<a name="l10480"></a>10480 };
<a name="l10481"></a>10481 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_undo_saveDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10482"></a>10482   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10483"></a>10483 };
<a name="l10484"></a>10484 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.undo_saveDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10485"></a>10485   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10486"></a>10486 };
<a name="l10487"></a>10487 
<a name="l10488"></a>10488 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_do_deleteDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10489"></a>10489   var localDraftsFolder = this.account.getFirstFolderWithType(<span class="stringliteral">&#39;localdrafts&#39;</span>);
<a name="l10490"></a>10490   <span class="keywordflow">if</span> (!localDraftsFolder) {
<a name="l10491"></a>10491     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;moot&#39;</span>);
<a name="l10492"></a>10492     <span class="keywordflow">return</span>;
<a name="l10493"></a>10493   }
<a name="l10494"></a>10494   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l10495"></a>10495   this._accessFolderForMutation(
<a name="l10496"></a>10496     localDraftsFolder.id, <span class="comment">/* needConn*/</span> <span class="keyword">false</span>,
<a name="l10497"></a>10497     <span class="keyword">function</span>(nullFolderConn, folderStorage) {
<a name="l10498"></a>10498       folderStorage.deleteMessageHeaderAndBody(
<a name="l10499"></a>10499         op.messageNamer.suid, op.messageNamer.date,
<a name="l10500"></a>10500         <span class="keyword">function</span>() {
<a name="l10501"></a>10501           callback(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">/* save account */</span> <span class="keyword">true</span>);
<a name="l10502"></a>10502         });
<a name="l10503"></a>10503     },
<a name="l10504"></a>10504     <span class="comment">/* no conn =&gt; no deathback required */</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l10505"></a>10505     <span class="stringliteral">&#39;deleteDraft&#39;</span>);
<a name="l10506"></a>10506 };
<a name="l10507"></a>10507 
<a name="l10508"></a>10508 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.do_deleteDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10509"></a>10509   <span class="comment">// there is no server component for this</span>
<a name="l10510"></a>10510   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10511"></a>10511 };
<a name="l10512"></a>10512 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.check_deleteDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10513"></a>10513   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;moot&#39;</span>);
<a name="l10514"></a>10514 };
<a name="l10515"></a>10515 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.local_undo_deleteDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10516"></a>10516   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10517"></a>10517 };
<a name="l10518"></a>10518 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.undo_deleteDraft = <span class="keyword">function</span>(op, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10519"></a>10519   <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10520"></a>10520 };
<a name="l10521"></a>10521 
<a name="l10522"></a>10522 
<a name="l10523"></a>10523 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.postJobCleanup = <span class="keyword">function</span>(<a class="code" href="../../d7/d78/namespacefactory.html#a6acf635a79cc1f5a1d1f28c22e730869">passed</a>) {
<a name="l10524"></a>10524   <span class="keywordflow">if</span> (<a class="code" href="../../d7/d78/namespacefactory.html#a6acf635a79cc1f5a1d1f28c22e730869">passed</a>) {
<a name="l10525"></a>10525     var deltaMap, fullMap;
<a name="l10526"></a>10526     <span class="comment">// - apply updates to the serverIdMap map</span>
<a name="l10527"></a>10527     <span class="keywordflow">if</span> (this._stateDelta.serverIdMap) {
<a name="l10528"></a>10528       deltaMap = this._stateDelta.serverIdMap;
<a name="l10529"></a>10529       fullMap = this._state.suidToServerId;
<a name="l10530"></a>10530       <span class="keywordflow">for</span> (var suid in deltaMap) {
<a name="l10531"></a>10531         var srvid = deltaMap[suid];
<a name="l10532"></a>10532         <span class="keywordflow">if</span> (srvid === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l10533"></a>10533           <span class="keyword">delete</span> fullMap[suid];
<a name="l10534"></a>10534         <span class="keywordflow">else</span>
<a name="l10535"></a>10535           fullMap[suid] = srvid;
<a name="l10536"></a>10536       }
<a name="l10537"></a>10537     }
<a name="l10538"></a>10538     <span class="comment">// - apply updates to the move map</span>
<a name="l10539"></a>10539     <span class="keywordflow">if</span> (this._stateDelta.moveMap) {
<a name="l10540"></a>10540       deltaMap = this._stateDelta.moveMap;
<a name="l10541"></a>10541       fullMap = this._state.moveMap;
<a name="l10542"></a>10542       <span class="keywordflow">for</span> (var oldSuid in deltaMap) {
<a name="l10543"></a>10543         var newSuid = deltaMap[oldSuid];
<a name="l10544"></a>10544         fullMap[oldSuid] = newSuid;
<a name="l10545"></a>10545       }
<a name="l10546"></a>10546     }
<a name="l10547"></a>10547   }
<a name="l10548"></a>10548 
<a name="l10549"></a>10549   <span class="keywordflow">for</span> (var i = 0; i &lt; this._heldMutexReleasers.length; i++) {
<a name="l10550"></a>10550     this._heldMutexReleasers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]();
<a name="l10551"></a>10551   }
<a name="l10552"></a>10552   this._heldMutexReleasers = [];
<a name="l10553"></a>10553 
<a name="l10554"></a>10554   this._stateDelta.serverIdMap = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10555"></a>10555   this._stateDelta.moveMap = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10556"></a>10556 };
<a name="l10557"></a>10557 
<a name="l10558"></a>10558 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.allJobsDone =  <span class="keyword">function</span>() {
<a name="l10559"></a>10559   this._state.suidToServerId = {};
<a name="l10560"></a>10560   this._state.moveMap = {};
<a name="l10561"></a>10561 };
<a name="l10562"></a>10562 
<a name="l10621"></a>10621 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>._partitionAndAccessFoldersSequentially = <span class="keyword">function</span>(
<a name="l10622"></a>10622     allMessageNamers,
<a name="l10623"></a>10623     needConn,
<a name="l10624"></a>10624     callInFolder,
<a name="l10625"></a>10625     callWhenDone,
<a name="l10626"></a>10626     callOnConnLoss,
<a name="l10627"></a>10627     reverse,
<a name="l10628"></a>10628     label,
<a name="l10629"></a>10629     requireHeaders) {
<a name="l10630"></a>10630   var partitions = $util.partitionMessagesByFolderId(allMessageNamers);
<a name="l10631"></a>10631   var folderConn, storage, <span class="keyword">self</span> = <span class="keyword">this</span>,
<a name="l10632"></a>10632       folderId = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, folderMessageNamers = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, serverIds = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l10633"></a>10633       iNextPartition = 0, curPartition = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, modsToGo = 0,
<a name="l10634"></a>10634       <span class="comment">// Set to true immediately before calling callWhenDone; causes us to</span>
<a name="l10635"></a>10635       <span class="comment">// immediately bail out of any of our callbacks in order to avoid</span>
<a name="l10636"></a>10636       <span class="comment">// continuing beyond the point when we should have stopped.</span>
<a name="l10637"></a>10637       terminated = <span class="keyword">false</span>;
<a name="l10638"></a>10638 
<a name="l10639"></a>10639   <span class="keywordflow">if</span> (reverse)
<a name="l10640"></a>10640     partitions.reverse();
<a name="l10641"></a>10641 
<a name="l10642"></a>10642   var openNextFolder = <span class="keyword">function</span> openNextFolder() {
<a name="l10643"></a>10643     <span class="keywordflow">if</span> (terminated)
<a name="l10644"></a>10644       <span class="keywordflow">return</span>;
<a name="l10645"></a>10645     <span class="keywordflow">if</span> (iNextPartition &gt;= partitions.length) {
<a name="l10646"></a>10646       terminated = <span class="keyword">true</span>;
<a name="l10647"></a>10647       callWhenDone(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10648"></a>10648       <span class="keywordflow">return</span>;
<a name="l10649"></a>10649     }
<a name="l10650"></a>10650     <span class="comment">// Cleanup the last folder (if there was one)</span>
<a name="l10651"></a>10651     <span class="keywordflow">if</span> (iNextPartition) {
<a name="l10652"></a>10652       folderConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10653"></a>10653       <span class="comment">// The folder&#39;s mutex should be last; if the callee acquired any</span>
<a name="l10654"></a>10654       <span class="comment">// additional mutexes in the last round, it should have freed it then</span>
<a name="l10655"></a>10655       <span class="comment">// too.</span>
<a name="l10656"></a>10656       var releaser = <span class="keyword">self</span>._heldMutexReleasers.pop();
<a name="l10657"></a>10657       <span class="keywordflow">if</span> (releaser)
<a name="l10658"></a>10658         releaser();
<a name="l10659"></a>10659       folderConn = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10660"></a>10660     }
<a name="l10661"></a>10661 
<a name="l10662"></a>10662     curPartition = partitions[iNextPartition++];
<a name="l10663"></a>10663     folderMessageNamers = curPartition.messages;
<a name="l10664"></a>10664     serverIds = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10665"></a>10665     <span class="keywordflow">if</span> (curPartition.folderId !== folderId) {
<a name="l10666"></a>10666       folderId = curPartition.folderId;
<a name="l10667"></a>10667       <span class="keyword">self</span>._accessFolderForMutation(folderId, needConn, gotFolderConn,
<a name="l10668"></a>10668                                     connDied, label);
<a name="l10669"></a>10669     }
<a name="l10670"></a>10670   };
<a name="l10671"></a>10671   var connDied = <span class="keyword">function</span> connDied() {
<a name="l10672"></a>10672     <span class="keywordflow">if</span> (terminated)
<a name="l10673"></a>10673       <span class="keywordflow">return</span>;
<a name="l10674"></a>10674     <span class="keywordflow">if</span> (callOnConnLoss) {
<a name="l10675"></a>10675       <span class="keywordflow">try</span> {
<a name="l10676"></a>10676         callOnConnLoss();
<a name="l10677"></a>10677       }
<a name="l10678"></a>10678       <span class="keywordflow">catch</span> (ex) {
<a name="l10679"></a>10679         <span class="keyword">self</span>._LOG.callbackErr(ex);
<a name="l10680"></a>10680       }
<a name="l10681"></a>10681     }
<a name="l10682"></a>10682     terminated = <span class="keyword">true</span>;
<a name="l10683"></a>10683     callWhenDone(<span class="stringliteral">&#39;connection-lost&#39;</span>);
<a name="l10684"></a>10684   };
<a name="l10685"></a>10685   var gotFolderConn = <span class="keyword">function</span> gotFolderConn(_folderConn, _storage) {
<a name="l10686"></a>10686     <span class="keywordflow">if</span> (terminated)
<a name="l10687"></a>10687       <span class="keywordflow">return</span>;
<a name="l10688"></a>10688     folderConn = _folderConn;
<a name="l10689"></a>10689     storage = _storage;
<a name="l10690"></a>10690     <span class="comment">// - Get headers or resolve current server id from name map</span>
<a name="l10691"></a>10691     <span class="keywordflow">if</span> (needConn &amp;&amp; !requireHeaders) {
<a name="l10692"></a>10692       var neededHeaders = [],
<a name="l10693"></a>10693           suidToServerId = <span class="keyword">self</span>._state.suidToServerId;
<a name="l10694"></a>10694       serverIds = [];
<a name="l10695"></a>10695       <span class="keywordflow">for</span> (var i = 0; i &lt; folderMessageNamers.length; i++) {
<a name="l10696"></a>10696         var namer = folderMessageNamers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l10697"></a>10697         var srvid = suidToServerId[namer.suid];
<a name="l10698"></a>10698         <span class="keywordflow">if</span> (srvid) {
<a name="l10699"></a>10699           serverIds.push(srvid);
<a name="l10700"></a>10700         }
<a name="l10701"></a>10701         <span class="keywordflow">else</span> {
<a name="l10702"></a>10702           serverIds.push(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10703"></a>10703           neededHeaders.push(namer);
<a name="l10704"></a>10704         }
<a name="l10705"></a>10705       }
<a name="l10706"></a>10706 
<a name="l10707"></a>10707       <span class="keywordflow">if</span> (!neededHeaders.length) {
<a name="l10708"></a>10708         <span class="keywordflow">try</span> {
<a name="l10709"></a>10709           callInFolder(folderConn, storage, serverIds, folderMessageNamers,
<a name="l10710"></a>10710                        openNextFolder);
<a name="l10711"></a>10711         }
<a name="l10712"></a>10712         <span class="keywordflow">catch</span> (ex) {
<a name="l10713"></a>10713           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;PAAFS error:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l10714"></a>10714         }
<a name="l10715"></a>10715       }
<a name="l10716"></a>10716       <span class="keywordflow">else</span> {
<a name="l10717"></a>10717         storage.getMessageHeaders(neededHeaders, gotNeededHeaders);
<a name="l10718"></a>10718       }
<a name="l10719"></a>10719     }
<a name="l10720"></a>10720     <span class="keywordflow">else</span> {
<a name="l10721"></a>10721       storage.getMessageHeaders(folderMessageNamers, gotHeaders);
<a name="l10722"></a>10722     }
<a name="l10723"></a>10723   };
<a name="l10724"></a>10724   var gotNeededHeaders = <span class="keyword">function</span> gotNeededHeaders(headers) {
<a name="l10725"></a>10725     <span class="keywordflow">if</span> (terminated)
<a name="l10726"></a>10726       <span class="keywordflow">return</span>;
<a name="l10727"></a>10727     var iNextServerId = serverIds.indexOf(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l10728"></a>10728     <span class="keywordflow">for</span> (var i = 0; i &lt; headers.length; i++) {
<a name="l10729"></a>10729       var header = headers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l10730"></a>10730       <span class="comment">// It&#39;s possible that by the time this job actually gets a chance to run</span>
<a name="l10731"></a>10731       <span class="comment">// that the header is no longer in the folder.  This is rare but not</span>
<a name="l10732"></a>10732       <span class="comment">// particularly exceptional.</span>
<a name="l10733"></a>10733       <span class="keywordflow">if</span> (header) {
<a name="l10734"></a>10734         var srvid = header.srvid;
<a name="l10735"></a>10735         serverIds[iNextServerId] = srvid;
<a name="l10736"></a>10736         <span class="comment">// A header that exists but does not have a server id is exceptional and</span>
<a name="l10737"></a>10737         <span class="comment">// bad, although logic should handle it because of the above dead-header</span>
<a name="l10738"></a>10738         <span class="comment">// case.  suidToServerId should really have provided this information to</span>
<a name="l10739"></a>10739         <span class="comment">// us.</span>
<a name="l10740"></a>10740         <span class="keywordflow">if</span> (!srvid)
<a name="l10741"></a>10741           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;Header&#39;</span>, headers[i].suid, <span class="stringliteral">&#39;missing server id in job!&#39;</span>);
<a name="l10742"></a>10742       }
<a name="l10743"></a>10743       iNextServerId = serverIds.indexOf(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, iNextServerId + 1);
<a name="l10744"></a>10744     }
<a name="l10745"></a>10745 
<a name="l10746"></a>10746     <span class="comment">// its entirely possible that we need headers but there are none so we can</span>
<a name="l10747"></a>10747     <span class="comment">// skip entering this folder as the job cannot do anything with an empty</span>
<a name="l10748"></a>10748     <span class="comment">// header.</span>
<a name="l10749"></a>10749     <span class="keywordflow">if</span> (!serverIds.length) {
<a name="l10750"></a>10750       openNextFolder();
<a name="l10751"></a>10751       <span class="keywordflow">return</span>;
<a name="l10752"></a>10752     }
<a name="l10753"></a>10753 
<a name="l10754"></a>10754     <span class="keywordflow">try</span> {
<a name="l10755"></a>10755       callInFolder(folderConn, storage, serverIds, folderMessageNamers,
<a name="l10756"></a>10756                    openNextFolder);
<a name="l10757"></a>10757     }
<a name="l10758"></a>10758     <span class="keywordflow">catch</span> (ex) {
<a name="l10759"></a>10759       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;PAAFS error:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l10760"></a>10760     }
<a name="l10761"></a>10761   };
<a name="l10762"></a>10762   var gotHeaders = <span class="keyword">function</span> gotHeaders(headers) {
<a name="l10763"></a>10763     <span class="keywordflow">if</span> (terminated)
<a name="l10764"></a>10764       <span class="keywordflow">return</span>;
<a name="l10765"></a>10765     <span class="comment">// its unlikely but entirely possible that all pending headers have been</span>
<a name="l10766"></a>10766     <span class="comment">// removed somehow between when the job was queued and now.</span>
<a name="l10767"></a>10767     <span class="keywordflow">if</span> (!headers.length) {
<a name="l10768"></a>10768       openNextFolder();
<a name="l10769"></a>10769       <span class="keywordflow">return</span>;
<a name="l10770"></a>10770     }
<a name="l10771"></a>10771 
<a name="l10772"></a>10772     <span class="comment">// Sort the headers in ascending-by-date order so that slices hear about</span>
<a name="l10773"></a>10773     <span class="comment">// changes from oldest to newest. That way, they won&#39;t get upset about being</span>
<a name="l10774"></a>10774     <span class="comment">// asked to expand into the past.</span>
<a name="l10775"></a>10775     headers.sort(<span class="keyword">function</span>(a, b) { <span class="keywordflow">return</span> a.date &gt; b.date; });
<a name="l10776"></a>10776     <span class="keywordflow">try</span> {
<a name="l10777"></a>10777       callInFolder(folderConn, storage, headers, folderMessageNamers,
<a name="l10778"></a>10778                    openNextFolder);
<a name="l10779"></a>10779     }
<a name="l10780"></a>10780     <span class="keywordflow">catch</span> (ex) {
<a name="l10781"></a>10781       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;PAAFS error:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l10782"></a>10782     }
<a name="l10783"></a>10783   };
<a name="l10784"></a>10784   openNextFolder();
<a name="l10785"></a>10785 };
<a name="l10786"></a>10786 
<a name="l10787"></a>10787 
<a name="l10788"></a>10788 
<a name="l10789"></a>10789 }); <span class="comment">// end define</span>
<a name="l10790"></a>10790 ;
<a name="l10795"></a>10795 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/accountmixins&#39;</span>,
<a name="l10796"></a>10796   [
<a name="l10797"></a>10797     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l10798"></a>10798   ],
<a name="l10799"></a>10799   <span class="keyword">function</span>(
<a name="l10800"></a>10800     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l10801"></a>10801   ) {
<a name="l10802"></a>10802 
<a name="l10833"></a>10833 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.runOp = <span class="keyword">function</span> runOp(op, <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>, callback) {
<a name="l10834"></a>10834   <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;runOp(&#39;</span> + <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> + <span class="stringliteral">&#39;: &#39;</span> + JSON.stringify(op).substring(0, 160) +
<a name="l10835"></a>10835               <span class="charliteral">&#39;)&#39;</span>);
<a name="l10836"></a>10836 
<a name="l10837"></a>10837   var methodName = <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> + <span class="charliteral">&#39;_&#39;</span> + op.type, <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l10838"></a>10838 
<a name="l10839"></a>10839   <span class="keywordflow">if</span> (!(methodName in this._jobDriver)) {
<a name="l10840"></a>10840     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;Unsupported op:&#39;</span>, op.type, <span class="stringliteral">&#39;mode:&#39;</span>, <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>);
<a name="l10841"></a>10841     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;failure-give-up&#39;</span>);
<a name="l10842"></a>10842     <span class="keywordflow">return</span>;
<a name="l10843"></a>10843   }
<a name="l10844"></a>10844 
<a name="l10845"></a>10845   this._LOG.runOp_begin(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>, op.type, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, op);
<a name="l10846"></a>10846   <span class="comment">// _LOG supports wrapping calls, but we want to be able to strip out all</span>
<a name="l10847"></a>10847   <span class="comment">// logging, and that wouldn&#39;t work.</span>
<a name="l10848"></a>10848   <span class="keywordflow">try</span> {
<a name="l10849"></a>10849     this._jobDriver[methodName](op, <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, resultIfAny,
<a name="l10850"></a>10850                                              accountSaveSuggested) {
<a name="l10851"></a>10851       <span class="keyword">self</span>._jobDriver.postJobCleanup(!error);
<a name="l10852"></a>10852       <span class="keyword">self</span>._LOG.runOp_end(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>, op.type, error, op);
<a name="l10853"></a>10853       <span class="comment">// defer the callback to the next tick to avoid deep recursion</span>
<a name="l10854"></a>10854       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setZeroTimeout(<span class="keyword">function</span>() {
<a name="l10855"></a>10855         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(error, resultIfAny, accountSaveSuggested);
<a name="l10856"></a>10856       });
<a name="l10857"></a>10857     });
<a name="l10858"></a>10858   }
<a name="l10859"></a>10859   <span class="keywordflow">catch</span> (ex) {
<a name="l10860"></a>10860     this._LOG.opError(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>, op.type, ex);
<a name="l10861"></a>10861   }
<a name="l10862"></a>10862 };
<a name="l10863"></a>10863 
<a name="l10864"></a>10864 
<a name="l10869"></a>10869 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.getFirstFolderWithType = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l10870"></a>10870   var folders = this.folders;
<a name="l10871"></a>10871   <span class="keywordflow">for</span> (var iFolder = 0; iFolder &lt; folders.length; iFolder++) {
<a name="l10872"></a>10872     <span class="keywordflow">if</span> (folders[iFolder].<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>)
<a name="l10873"></a>10873       <span class="keywordflow">return</span> folders[iFolder];
<a name="l10874"></a>10874   }
<a name="l10875"></a>10875  <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10876"></a>10876 };
<a name="l10877"></a>10877 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.getFolderByPath = <span class="keyword">function</span>(folderPath) {
<a name="l10878"></a>10878   var folders = this.folders;
<a name="l10879"></a>10879   <span class="keywordflow">for</span> (var iFolder = 0; iFolder &lt; folders.length; iFolder++) {
<a name="l10880"></a>10880     <span class="keywordflow">if</span> (folders[iFolder].<a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a> === folderPath)
<a name="l10881"></a>10881       <span class="keywordflow">return</span> folders[iFolder];
<a name="l10882"></a>10882   }
<a name="l10883"></a>10883  <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10884"></a>10884 };
<a name="l10885"></a>10885 
<a name="l10886"></a>10886 
<a name="l10887"></a>10887 
<a name="l10898"></a>10898 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.saveAccountState = <span class="keyword">function</span>(reuseTrans, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, <a class="code" href="../../da/dd0/ns_i_d_o_m_close_event_8idl.html#aa538b14c961e4162ded76940b8f37507">reason</a>) {
<a name="l10899"></a>10899   <span class="keywordflow">if</span> (!this._alive) {
<a name="l10900"></a>10900     this._LOG.accountDeleted(<span class="stringliteral">&#39;saveAccountState&#39;</span>);
<a name="l10901"></a>10901     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10902"></a>10902   }
<a name="l10903"></a>10903 
<a name="l10904"></a>10904   <span class="comment">// Indicate save is active, in case something, like</span>
<a name="l10905"></a>10905   <span class="comment">// signaling the end of a sync, needs to run after</span>
<a name="l10906"></a>10906   <span class="comment">// a save, via runAfterSaves.</span>
<a name="l10907"></a>10907   this._saveAccountStateActive = <span class="keyword">true</span>;
<a name="l10908"></a>10908   <span class="keywordflow">if</span> (!this._deferredSaveAccountCalls) {
<a name="l10909"></a>10909     this._deferredSaveAccountCalls = [];
<a name="l10910"></a>10910   }
<a name="l10911"></a>10911 
<a name="l10912"></a>10912   <span class="keywordflow">if</span> (callback)
<a name="l10913"></a>10913     this.runAfterSaves(callback);
<a name="l10914"></a>10914 
<a name="l10915"></a>10915   var perFolderStuff = [], <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l10916"></a>10916   <span class="keywordflow">for</span> (var iFolder = 0; iFolder &lt; this.folders.length; iFolder++) {
<a name="l10917"></a>10917     var folderPub = this.folders[iFolder],
<a name="l10918"></a>10918         folderStorage = this._folderStorages[folderPub.id],
<a name="l10919"></a>10919         folderStuff = folderStorage.generatePersistenceInfo();
<a name="l10920"></a>10920     <span class="keywordflow">if</span> (folderStuff)
<a name="l10921"></a>10921       perFolderStuff.push(folderStuff);
<a name="l10922"></a>10922   }
<a name="l10923"></a>10923   this._LOG.saveAccountState(<a class="code" href="../../da/dd0/ns_i_d_o_m_close_event_8idl.html#aa538b14c961e4162ded76940b8f37507">reason</a>);
<a name="l10924"></a>10924   var trans = this._db.saveAccountFolderStates(
<a name="l10925"></a>10925     this.<span class="keywordtype">id</span>, this._folderInfos, perFolderStuff,
<a name="l10926"></a>10926     this._deadFolderIds,
<a name="l10927"></a>10927     <span class="keyword">function</span> stateSaved() {
<a name="l10928"></a>10928       this._saveAccountStateActive = <span class="keyword">false</span>;
<a name="l10929"></a>10929 
<a name="l10930"></a>10930       <span class="comment">// NB: we used to log when the save completed, but it ended up being</span>
<a name="l10931"></a>10931       <span class="comment">// annoying to the unit tests since we don&#39;t block our actions on</span>
<a name="l10932"></a>10932       <span class="comment">// the completion of the save at this time.</span>
<a name="l10933"></a>10933 
<a name="l10934"></a>10934       var callbacks = this._deferredSaveAccountCalls;
<a name="l10935"></a>10935       this._deferredSaveAccountCalls = [];
<a name="l10936"></a>10936       callbacks.forEach(<span class="keyword">function</span>(callback) {
<a name="l10937"></a>10937         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l10938"></a>10938       });
<a name="l10939"></a>10939     }.bind(<span class="keyword">this</span>),
<a name="l10940"></a>10940     reuseTrans);
<a name="l10941"></a>10941   this._deadFolderIds = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l10942"></a>10942   <span class="keywordflow">return</span> trans;
<a name="l10943"></a>10943 };
<a name="l10944"></a>10944 
<a name="l10945"></a>10945 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.runAfterSaves = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l10946"></a>10946   <span class="keywordflow">if</span> (this._saveAccountStateActive || this._saveAccountIsImminent) {
<a name="l10947"></a>10947     this._deferredSaveAccountCalls.push(callback);
<a name="l10948"></a>10948   } <span class="keywordflow">else</span> {
<a name="l10949"></a>10949     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l10950"></a>10950   }
<a name="l10951"></a>10951 };
<a name="l10952"></a>10952 
<a name="l10953"></a>10953 }); <span class="comment">// end define</span>
<a name="l10954"></a>10954 ;
<a name="l10955"></a>10955 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;events&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>],<span class="keyword">function</span> (<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l10956"></a>10956 <span class="keywordflow">if</span> (!<a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.EventEmitter) <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.EventEmitter = <a class="code" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> () {};
<a name="l10957"></a>10957 
<a name="l10958"></a>10958 var <a class="code" href="../../de/dfc/events_8js.html#ad57db69f456bd679167cecd98d6c4019">EventEmitter</a> = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.EventEmitter = <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>.EventEmitter;
<a name="l10959"></a>10959 var <a class="code" href="../../de/dfc/events_8js.html#adca5ce0ed65a1514a671ae81eb33bd53">isArray</a> = <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> Array.isArray === <span class="stringliteral">&#39;function&#39;</span>
<a name="l10960"></a>10960     ? Array.isArray
<a name="l10961"></a>10961     : <span class="keyword">function</span> (xs) {
<a name="l10962"></a>10962         <span class="keywordflow">return</span> Object.toString.call(xs) === <span class="stringliteral">&#39;[object Array]&#39;</span>
<a name="l10963"></a>10963     }
<a name="l10964"></a>10964 ;
<a name="l10965"></a>10965 
<a name="l10966"></a>10966 <span class="comment">// By default EventEmitters will print a warning if more than</span>
<a name="l10967"></a>10967 <span class="comment">// 10 listeners are added to it. This is a useful default which</span>
<a name="l10968"></a>10968 <span class="comment">// helps finding memory leaks.</span>
<a name="l10969"></a>10969 <span class="comment">//</span>
<a name="l10970"></a>10970 <span class="comment">// Obviously not all Emitters should be limited to 10. This function allows</span>
<a name="l10971"></a>10971 <span class="comment">// that to be increased. Set to zero for unlimited.</span>
<a name="l10972"></a>10972 var <a class="code" href="../../de/dfc/events_8js.html#a337004a347b709269ece5bd8dce5871c">defaultMaxListeners</a> = 10;
<a name="l10973"></a>10973 EventEmitter.prototype.setMaxListeners = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l10974"></a>10974   <span class="keywordflow">if</span> (!this._events) this._events = {};
<a name="l10975"></a>10975   this._events.maxListeners = <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>;
<a name="l10976"></a>10976 };
<a name="l10977"></a>10977 
<a name="l10978"></a>10978 
<a name="l10979"></a>10979 EventEmitter.prototype.emit = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l10980"></a>10980   <span class="comment">// If there is no &#39;error&#39; event listener then throw.</span>
<a name="l10981"></a>10981   <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;error&#39;</span>) {
<a name="l10982"></a>10982     <span class="keywordflow">if</span> (!this._events || !this._events.error ||
<a name="l10983"></a>10983         (isArray(this._events.error) &amp;&amp; !this._events.error.length))
<a name="l10984"></a>10984     {
<a name="l10985"></a>10985       <span class="keywordflow">if</span> (arguments[1] instanceof <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>) {
<a name="l10986"></a>10986         <span class="keywordflow">throw</span> arguments[1]; <span class="comment">// Unhandled &#39;error&#39; event</span>
<a name="l10987"></a>10987       } <span class="keywordflow">else</span> {
<a name="l10988"></a>10988         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;Uncaught, unspecified &#39;error&#39; event.&quot;</span>);
<a name="l10989"></a>10989       }
<a name="l10990"></a>10990       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l10991"></a>10991     }
<a name="l10992"></a>10992   }
<a name="l10993"></a>10993 
<a name="l10994"></a>10994   <span class="keywordflow">if</span> (!this._events) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l10995"></a>10995   var <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a> = this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l10996"></a>10996   <span class="keywordflow">if</span> (!handler) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l10997"></a>10997 
<a name="l10998"></a>10998   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> handler == <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l10999"></a>10999     <span class="keywordflow">switch</span> (arguments.length) {
<a name="l11000"></a>11000       <span class="comment">// fast cases</span>
<a name="l11001"></a>11001       <span class="keywordflow">case</span> 1:
<a name="l11002"></a>11002         handler.call(<span class="keyword">this</span>);
<a name="l11003"></a>11003         <span class="keywordflow">break</span>;
<a name="l11004"></a>11004       <span class="keywordflow">case</span> 2:
<a name="l11005"></a>11005         handler.call(<span class="keyword">this</span>, arguments[1]);
<a name="l11006"></a>11006         <span class="keywordflow">break</span>;
<a name="l11007"></a>11007       <span class="keywordflow">case</span> 3:
<a name="l11008"></a>11008         handler.call(<span class="keyword">this</span>, arguments[1], arguments[2]);
<a name="l11009"></a>11009         <span class="keywordflow">break</span>;
<a name="l11010"></a>11010       <span class="comment">// slower</span>
<a name="l11011"></a>11011       <span class="keywordflow">default</span>:
<a name="l11012"></a>11012         var args = Array.prototype.slice.call(arguments, 1);
<a name="l11013"></a>11013         handler.apply(<span class="keyword">this</span>, args);
<a name="l11014"></a>11014     }
<a name="l11015"></a>11015     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l11016"></a>11016 
<a name="l11017"></a>11017   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/dfc/events_8js.html#adca5ce0ed65a1514a671ae81eb33bd53">isArray</a>(handler)) {
<a name="l11018"></a>11018     var args = Array.prototype.slice.call(arguments, 1);
<a name="l11019"></a>11019 
<a name="l11020"></a>11020     var listeners = handler.slice();
<a name="l11021"></a>11021     <span class="keywordflow">for</span> (var i = 0, <a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a> = listeners.length; i &lt; <a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a>; i++) {
<a name="l11022"></a>11022       listeners[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].apply(<span class="keyword">this</span>, args);
<a name="l11023"></a>11023     }
<a name="l11024"></a>11024     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l11025"></a>11025 
<a name="l11026"></a>11026   } <span class="keywordflow">else</span> {
<a name="l11027"></a>11027     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l11028"></a>11028   }
<a name="l11029"></a>11029 };
<a name="l11030"></a>11030 
<a name="l11031"></a>11031 <span class="comment">// EventEmitter is defined in src/node_events.cc</span>
<a name="l11032"></a>11032 <span class="comment">// EventEmitter.prototype.emit() is also defined there.</span>
<a name="l11033"></a>11033 EventEmitter.prototype.addListener = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, listener) {
<a name="l11034"></a>11034   <span class="keywordflow">if</span> (<span class="stringliteral">&#39;function&#39;</span> !== <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> listener) {
<a name="l11035"></a>11035     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;addListener only takes instances of Function&#39;</span>);
<a name="l11036"></a>11036   }
<a name="l11037"></a>11037 
<a name="l11038"></a>11038   <span class="keywordflow">if</span> (!this._events) this._events = {};
<a name="l11039"></a>11039 
<a name="l11040"></a>11040   <span class="comment">// To avoid recursion in the case that type == &quot;newListeners&quot;! Before</span>
<a name="l11041"></a>11041   <span class="comment">// adding it to the listeners, first emit &quot;newListeners&quot;.</span>
<a name="l11042"></a>11042   this.<a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a>(<span class="stringliteral">&#39;newListener&#39;</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, listener);
<a name="l11043"></a>11043 
<a name="l11044"></a>11044   <span class="keywordflow">if</span> (!this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>]) {
<a name="l11045"></a>11045     <span class="comment">// Optimize the case of one listener. Don&#39;t need the extra array object.</span>
<a name="l11046"></a>11046     this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = listener;
<a name="l11047"></a>11047   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/dfc/events_8js.html#adca5ce0ed65a1514a671ae81eb33bd53">isArray</a>(this._events[type])) {
<a name="l11048"></a>11048 
<a name="l11049"></a>11049     <span class="comment">// Check for listener leak</span>
<a name="l11050"></a>11050     <span class="keywordflow">if</span> (!this._events[type].warned) {
<a name="l11051"></a>11051       var m;
<a name="l11052"></a>11052       <span class="keywordflow">if</span> (this._events.maxListeners !== undefined) {
<a name="l11053"></a>11053         m = this._events.maxListeners;
<a name="l11054"></a>11054       } <span class="keywordflow">else</span> {
<a name="l11055"></a>11055         m = <a class="code" href="../../de/dfc/events_8js.html#a337004a347b709269ece5bd8dce5871c">defaultMaxListeners</a>;
<a name="l11056"></a>11056       }
<a name="l11057"></a>11057 
<a name="l11058"></a>11058       <span class="keywordflow">if</span> (m &amp;&amp; m &gt; 0 &amp;&amp; this._events[type].<a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a> &gt; m) {
<a name="l11059"></a>11059         this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>].warned = <span class="keyword">true</span>;
<a name="l11060"></a>11060         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;(node) warning: possible EventEmitter memory &#39;</span> +
<a name="l11061"></a>11061                       <span class="stringliteral">&#39;leak detected. %d listeners added. &#39;</span> +
<a name="l11062"></a>11062                       <span class="stringliteral">&#39;Use emitter.setMaxListeners() to increase limit.&#39;</span>,
<a name="l11063"></a>11063                       this._events[type].<a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>);
<a name="l11064"></a>11064         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.trace();
<a name="l11065"></a>11065       }
<a name="l11066"></a>11066     }
<a name="l11067"></a>11067 
<a name="l11068"></a>11068     <span class="comment">// If we&#39;ve already got an array, just append.</span>
<a name="l11069"></a>11069     this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>].push(listener);
<a name="l11070"></a>11070   } <span class="keywordflow">else</span> {
<a name="l11071"></a>11071     <span class="comment">// Adding the second element, need to change to array.</span>
<a name="l11072"></a>11072     this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = [this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>], listener];
<a name="l11073"></a>11073   }
<a name="l11074"></a>11074 
<a name="l11075"></a>11075   <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l11076"></a>11076 };
<a name="l11077"></a>11077 
<a name="l11078"></a>11078 EventEmitter.prototype.on = EventEmitter.prototype.addListener;
<a name="l11079"></a>11079 
<a name="l11080"></a>11080 EventEmitter.prototype.once = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, listener) {
<a name="l11081"></a>11081   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l11082"></a>11082   <span class="keyword">self</span>.on(type, <span class="keyword">function</span> <a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>() {
<a name="l11083"></a>11083     <span class="keyword">self</span>.removeListener(type, <a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>);
<a name="l11084"></a>11084     listener.apply(<span class="keyword">this</span>, arguments);
<a name="l11085"></a>11085   });
<a name="l11086"></a>11086 
<a name="l11087"></a>11087   <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l11088"></a>11088 };
<a name="l11089"></a>11089 
<a name="l11090"></a>11090 EventEmitter.prototype.removeListener = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, listener) {
<a name="l11091"></a>11091   <span class="keywordflow">if</span> (<span class="stringliteral">&#39;function&#39;</span> !== <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> listener) {
<a name="l11092"></a>11092     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;removeListener only takes instances of Function&#39;</span>);
<a name="l11093"></a>11093   }
<a name="l11094"></a>11094 
<a name="l11095"></a>11095   <span class="comment">// does not use listeners(), so no side effect of creating _events[type]</span>
<a name="l11096"></a>11096   <span class="keywordflow">if</span> (!this._events || !this._events[type]) <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l11097"></a>11097 
<a name="l11098"></a>11098   var <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a> = this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l11099"></a>11099 
<a name="l11100"></a>11100   <span class="keywordflow">if</span> (<a class="code" href="../../de/dfc/events_8js.html#adca5ce0ed65a1514a671ae81eb33bd53">isArray</a>(list)) {
<a name="l11101"></a>11101     var i = list.indexOf(listener);
<a name="l11102"></a>11102     <span class="keywordflow">if</span> (i &lt; 0) <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l11103"></a>11103     list.splice(i, 1);
<a name="l11104"></a>11104     <span class="keywordflow">if</span> (list.length == 0)
<a name="l11105"></a>11105       <span class="keyword">delete</span> this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l11106"></a>11106   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (this._events[type] === listener) {
<a name="l11107"></a>11107     <span class="keyword">delete</span> this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l11108"></a>11108   }
<a name="l11109"></a>11109 
<a name="l11110"></a>11110   <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l11111"></a>11111 };
<a name="l11112"></a>11112 
<a name="l11113"></a>11113 EventEmitter.prototype.removeAllListeners = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l11114"></a>11114   <span class="comment">// does not use listeners(), so no side effect of creating _events[type]</span>
<a name="l11115"></a>11115   <span class="keywordflow">if</span> (type &amp;&amp; this._events &amp;&amp; this._events[type]) this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l11116"></a>11116   <span class="keywordflow">if</span> (!type) this._events = {};
<a name="l11117"></a>11117   <span class="keywordflow">return</span> <span class="keyword">this</span>;
<a name="l11118"></a>11118 };
<a name="l11119"></a>11119 
<a name="l11120"></a>11120 EventEmitter.prototype.listeners = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l11121"></a>11121   <span class="keywordflow">if</span> (!this._events) this._events = {};
<a name="l11122"></a>11122   <span class="keywordflow">if</span> (!this._events[type]) this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = [];
<a name="l11123"></a>11123   <span class="keywordflow">if</span> (!<a class="code" href="../../de/dfc/events_8js.html#adca5ce0ed65a1514a671ae81eb33bd53">isArray</a>(this._events[type])) {
<a name="l11124"></a>11124     this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = [this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>]];
<a name="l11125"></a>11125   }
<a name="l11126"></a>11126   <span class="keywordflow">return</span> this._events[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l11127"></a>11127 };
<a name="l11128"></a>11128 
<a name="l11129"></a>11129 });
<a name="l11130"></a>11130 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;util&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;events&#39;</span>],<span class="keyword">function</span> (<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l11131"></a>11131 var events = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;events&#39;</span>);
<a name="l11132"></a>11132 
<a name="l11133"></a>11133 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.print = <span class="keyword">function</span> () {};
<a name="l11134"></a>11134 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.puts = <span class="keyword">function</span> () {};
<a name="l11135"></a>11135 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.debug = <span class="keyword">function</span>() {};
<a name="l11136"></a>11136 
<a name="l11137"></a>11137 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.log = <span class="keyword">function</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {};
<a name="l11138"></a>11138 
<a name="l11139"></a>11139 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.pump = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l11140"></a>11140 
<a name="l11141"></a>11141 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.inherits = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a57afe414c13cee8166fdbf73c2859199">ctor</a>, superCtor) {
<a name="l11142"></a>11142   <a class="code" href="../../d2/d7d/jsapi_8h.html#a57afe414c13cee8166fdbf73c2859199">ctor</a>.super_ = superCtor;
<a name="l11143"></a>11143   <a class="code" href="../../d2/d7d/jsapi_8h.html#a57afe414c13cee8166fdbf73c2859199">ctor</a>.prototype = Object.create(superCtor.prototype, {
<a name="l11144"></a>11144     <a class="code" href="../../d8/d14/_cloud_apps_8js.html#af72715521e98346fe28d30efb7887846">constructor</a>: {
<a name="l11145"></a>11145       <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>: <a class="code" href="../../d2/d7d/jsapi_8h.html#a57afe414c13cee8166fdbf73c2859199">ctor</a>,
<a name="l11146"></a>11146       enumerable: <span class="keyword">false</span>,
<a name="l11147"></a>11147       writable: <span class="keyword">true</span>,
<a name="l11148"></a>11148       configurable: <span class="keyword">true</span>
<a name="l11149"></a>11149     }
<a name="l11150"></a>11150   });
<a name="l11151"></a>11151 };
<a name="l11152"></a>11152 
<a name="l11153"></a>11153 });
<a name="l11154"></a>11154 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;stream&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;events&#39;</span>,<span class="stringliteral">&#39;util&#39;</span>],<span class="keyword">function</span> (<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l11155"></a>11155 var events = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;events&#39;</span>);
<a name="l11156"></a>11156 var <a class="code" href="../../db/deb/apps_2system_2test_2marionette_2lib_2notification_8js.html#a8f5b2e09d5197e9d28f6032dff542d44">util</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;util&#39;</span>);
<a name="l11157"></a>11157 
<a name="l11158"></a>11158 <span class="keyword">function</span> Stream() {
<a name="l11159"></a>11159   events.EventEmitter.call(<span class="keyword">this</span>);
<a name="l11160"></a>11160 }
<a name="l11161"></a>11161 util.inherits(Stream, events.EventEmitter);
<a name="l11162"></a>11162 <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.exports = Stream;
<a name="l11163"></a>11163 <span class="comment">// Backwards-compat with node 0.4.x</span>
<a name="l11164"></a>11164 Stream.Stream = Stream;
<a name="l11165"></a>11165 
<a name="l11166"></a>11166 Stream.prototype.pipe = <span class="keyword">function</span>(dest, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>) {
<a name="l11167"></a>11167   var source = <span class="keyword">this</span>;
<a name="l11168"></a>11168 
<a name="l11169"></a>11169   <span class="keyword">function</span> ondata(chunk) {
<a name="l11170"></a>11170     <span class="keywordflow">if</span> (dest.writable) {
<a name="l11171"></a>11171       <span class="keywordflow">if</span> (<span class="keyword">false</span> === dest.write(chunk) &amp;&amp; source.pause) {
<a name="l11172"></a>11172         source.pause();
<a name="l11173"></a>11173       }
<a name="l11174"></a>11174     }
<a name="l11175"></a>11175   }
<a name="l11176"></a>11176 
<a name="l11177"></a>11177   source.on(<span class="stringliteral">&#39;data&#39;</span>, ondata);
<a name="l11178"></a>11178 
<a name="l11179"></a>11179   <span class="keyword">function</span> ondrain() {
<a name="l11180"></a>11180     <span class="keywordflow">if</span> (source.readable &amp;&amp; source.resume) {
<a name="l11181"></a>11181       source.resume();
<a name="l11182"></a>11182     }
<a name="l11183"></a>11183   }
<a name="l11184"></a>11184 
<a name="l11185"></a>11185   dest.on(<span class="stringliteral">&#39;drain&#39;</span>, ondrain);
<a name="l11186"></a>11186 
<a name="l11187"></a>11187   <span class="comment">// If the &#39;end&#39; option is not supplied, dest.end() will be called when</span>
<a name="l11188"></a>11188   <span class="comment">// source gets the &#39;end&#39; or &#39;close&#39; events.  Only dest.end() once, and</span>
<a name="l11189"></a>11189   <span class="comment">// only when all sources have ended.</span>
<a name="l11190"></a>11190   <span class="keywordflow">if</span> (!dest._isStdio &amp;&amp; (!options || options.end !== <span class="keyword">false</span>)) {
<a name="l11191"></a>11191     dest._pipeCount = dest._pipeCount || 0;
<a name="l11192"></a>11192     dest._pipeCount++;
<a name="l11193"></a>11193 
<a name="l11194"></a>11194     source.on(<span class="stringliteral">&#39;end&#39;</span>, onend);
<a name="l11195"></a>11195     source.on(<span class="stringliteral">&#39;close&#39;</span>, onclose);
<a name="l11196"></a>11196   }
<a name="l11197"></a>11197 
<a name="l11198"></a>11198   var didOnEnd = <span class="keyword">false</span>;
<a name="l11199"></a>11199   <span class="keyword">function</span> onend() {
<a name="l11200"></a>11200     <span class="keywordflow">if</span> (didOnEnd) <span class="keywordflow">return</span>;
<a name="l11201"></a>11201     didOnEnd = <span class="keyword">true</span>;
<a name="l11202"></a>11202 
<a name="l11203"></a>11203     dest._pipeCount--;
<a name="l11204"></a>11204 
<a name="l11205"></a>11205     <span class="comment">// remove the listeners</span>
<a name="l11206"></a>11206     cleanup();
<a name="l11207"></a>11207 
<a name="l11208"></a>11208     <span class="keywordflow">if</span> (dest._pipeCount &gt; 0) {
<a name="l11209"></a>11209       <span class="comment">// waiting for other incoming streams to end.</span>
<a name="l11210"></a>11210       <span class="keywordflow">return</span>;
<a name="l11211"></a>11211     }
<a name="l11212"></a>11212 
<a name="l11213"></a>11213     dest.end();
<a name="l11214"></a>11214   }
<a name="l11215"></a>11215 
<a name="l11216"></a>11216 
<a name="l11217"></a>11217   <span class="keyword">function</span> onclose() {
<a name="l11218"></a>11218     <span class="keywordflow">if</span> (didOnEnd) <span class="keywordflow">return</span>;
<a name="l11219"></a>11219     didOnEnd = <span class="keyword">true</span>;
<a name="l11220"></a>11220 
<a name="l11221"></a>11221     dest._pipeCount--;
<a name="l11222"></a>11222 
<a name="l11223"></a>11223     <span class="comment">// remove the listeners</span>
<a name="l11224"></a>11224     cleanup();
<a name="l11225"></a>11225 
<a name="l11226"></a>11226     <span class="keywordflow">if</span> (dest._pipeCount &gt; 0) {
<a name="l11227"></a>11227       <span class="comment">// waiting for other incoming streams to end.</span>
<a name="l11228"></a>11228       <span class="keywordflow">return</span>;
<a name="l11229"></a>11229     }
<a name="l11230"></a>11230 
<a name="l11231"></a>11231     dest.destroy();
<a name="l11232"></a>11232   }
<a name="l11233"></a>11233 
<a name="l11234"></a>11234   <span class="comment">// don&#39;t leave dangling pipes when there are errors.</span>
<a name="l11235"></a>11235   <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aca241430796cc1ddfb977bb37c38590b">er</a>) {
<a name="l11236"></a>11236     cleanup();
<a name="l11237"></a>11237     <span class="keywordflow">if</span> (this.<a class="code" href="../../de/dfc/events_8js.html#aefbed4536fb9e73c5a626949dcbffbf4">listeners</a>(<span class="stringliteral">&#39;error&#39;</span>).<a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a> === 0) {
<a name="l11238"></a>11238       <span class="keywordflow">throw</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#aca241430796cc1ddfb977bb37c38590b">er</a>; <span class="comment">// Unhandled stream error in pipe.</span>
<a name="l11239"></a>11239     }
<a name="l11240"></a>11240   }
<a name="l11241"></a>11241 
<a name="l11242"></a>11242   source.on(<span class="stringliteral">&#39;error&#39;</span>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>);
<a name="l11243"></a>11243   dest.on(<span class="stringliteral">&#39;error&#39;</span>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>);
<a name="l11244"></a>11244 
<a name="l11245"></a>11245   <span class="comment">// remove all the event listeners that were added.</span>
<a name="l11246"></a>11246   <span class="keyword">function</span> cleanup() {
<a name="l11247"></a>11247     source.removeListener(<span class="stringliteral">&#39;data&#39;</span>, ondata);
<a name="l11248"></a>11248     dest.removeListener(<span class="stringliteral">&#39;drain&#39;</span>, ondrain);
<a name="l11249"></a>11249 
<a name="l11250"></a>11250     source.removeListener(<span class="stringliteral">&#39;end&#39;</span>, onend);
<a name="l11251"></a>11251     source.removeListener(<span class="stringliteral">&#39;close&#39;</span>, onclose);
<a name="l11252"></a>11252 
<a name="l11253"></a>11253     source.removeListener(<span class="stringliteral">&#39;error&#39;</span>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>);
<a name="l11254"></a>11254     dest.removeListener(<span class="stringliteral">&#39;error&#39;</span>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>);
<a name="l11255"></a>11255 
<a name="l11256"></a>11256     source.removeListener(<span class="stringliteral">&#39;end&#39;</span>, cleanup);
<a name="l11257"></a>11257     source.removeListener(<span class="stringliteral">&#39;close&#39;</span>, cleanup);
<a name="l11258"></a>11258 
<a name="l11259"></a>11259     dest.removeListener(<span class="stringliteral">&#39;end&#39;</span>, cleanup);
<a name="l11260"></a>11260     dest.removeListener(<span class="stringliteral">&#39;close&#39;</span>, cleanup);
<a name="l11261"></a>11261   }
<a name="l11262"></a>11262 
<a name="l11263"></a>11263   source.on(<span class="stringliteral">&#39;end&#39;</span>, cleanup);
<a name="l11264"></a>11264   source.on(<span class="stringliteral">&#39;close&#39;</span>, cleanup);
<a name="l11265"></a>11265 
<a name="l11266"></a>11266   dest.on(<span class="stringliteral">&#39;end&#39;</span>, cleanup);
<a name="l11267"></a>11267   dest.on(<span class="stringliteral">&#39;close&#39;</span>, cleanup);
<a name="l11268"></a>11268 
<a name="l11269"></a>11269   dest.emit(<span class="stringliteral">&#39;pipe&#39;</span>, source);
<a name="l11270"></a>11270 
<a name="l11271"></a>11271   <span class="comment">// Allow for unix-like usage: A.pipe(B).pipe(C)</span>
<a name="l11272"></a>11272   <span class="keywordflow">return</span> dest;
<a name="l11273"></a>11273 };
<a name="l11274"></a>11274 
<a name="l11275"></a>11275 });
<a name="l11276"></a>11276 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;crypto&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l11277"></a>11277 
<a name="l11278"></a>11278 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.createHash = <span class="keyword">function</span>(algorithm) {
<a name="l11279"></a>11279   <span class="keywordflow">if</span> (algorithm !== <span class="stringliteral">&quot;md5&quot;</span>)
<a name="l11280"></a>11280     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;MD5 or bust!&quot;</span>);
<a name="l11281"></a>11281 
<a name="l11282"></a>11282   var data = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11283"></a>11283   <span class="keywordflow">return</span> {
<a name="l11284"></a>11284     <a class="code" href="../../dd/d6d/mock__spinner_8js.html#ab10b009b0da48f61217a18daf8e20cd8">update</a>: <span class="keyword">function</span>(addData) {
<a name="l11285"></a>11285       data += addData;
<a name="l11286"></a>11286     },
<a name="l11287"></a>11287     digest: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>) {
<a name="l11288"></a>11288       <span class="keywordflow">switch</span> (<a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>) {
<a name="l11289"></a>11289         <span class="keywordflow">case</span> <span class="stringliteral">&quot;hex&quot;</span>:
<a name="l11290"></a>11290           <span class="keywordflow">return</span> hex_md5(data);
<a name="l11291"></a>11291         <span class="keywordflow">case</span> <span class="stringliteral">&quot;base64&quot;</span>:
<a name="l11292"></a>11292           <span class="keywordflow">return</span> b64_md5(data);
<a name="l11293"></a>11293         <span class="keywordflow">default</span>:
<a name="l11294"></a>11294           <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;The encoding is no good: &quot;</span> + <a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>);
<a name="l11295"></a>11295       }
<a name="l11296"></a>11296     }
<a name="l11297"></a>11297   };
<a name="l11298"></a>11298 };
<a name="l11299"></a>11299 
<a name="l11300"></a>11300 <span class="comment">/*</span>
<a name="l11301"></a>11301 <span class="comment"> * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message</span>
<a name="l11302"></a>11302 <span class="comment"> * Digest Algorithm, as defined in RFC 1321.</span>
<a name="l11303"></a>11303 <span class="comment"> * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009</span>
<a name="l11304"></a>11304 <span class="comment"> * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet</span>
<a name="l11305"></a>11305 <span class="comment"> * Distributed under the BSD License</span>
<a name="l11306"></a>11306 <span class="comment"> * See http://pajhome.org.uk/crypt/md5 for more info.</span>
<a name="l11307"></a>11307 <span class="comment"> */</span>
<a name="l11308"></a>11308 
<a name="l11309"></a>11309 <span class="comment">/*</span>
<a name="l11310"></a>11310 <span class="comment"> * Configurable variables. You may need to tweak these to be compatible with</span>
<a name="l11311"></a>11311 <span class="comment"> * the server-side, but the defaults work in most cases.</span>
<a name="l11312"></a>11312 <span class="comment"> */</span>
<a name="l11313"></a>11313 var <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#a82a63095cd2408025ea9210fbd3a1010">hexcase</a> = 0;   <span class="comment">/* hex output format. 0 - lowercase; 1 - uppercase        */</span>
<a name="l11314"></a>11314 var <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#a1b3c9c1f22b5fa4d7bc3678a90e89769">b64pad</a>  = <span class="stringliteral">&quot;&quot;</span>;  <span class="comment">/* base-64 pad character. &quot;=&quot; for strict RFC compliance   */</span>
<a name="l11315"></a>11315 
<a name="l11316"></a>11316 <span class="comment">/*</span>
<a name="l11317"></a>11317 <span class="comment"> * These are the functions you&#39;ll usually want to call</span>
<a name="l11318"></a>11318 <span class="comment"> * They take string arguments and return either hex or base-64 encoded strings</span>
<a name="l11319"></a>11319 <span class="comment"> */</span>
<a name="l11320"></a>11320 <span class="keyword">function</span> hex_md5(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>)    { <span class="keywordflow">return</span> rstr2hex(rstr_md5(str2rstr_utf8(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>))); }
<a name="l11321"></a>11321 <span class="keyword">function</span> b64_md5(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>)    { <span class="keywordflow">return</span> rstr2b64(rstr_md5(str2rstr_utf8(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>))); }
<a name="l11322"></a>11322 <span class="keyword">function</span> any_md5(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) { <span class="keywordflow">return</span> rstr2any(rstr_md5(str2rstr_utf8(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>)), <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>); }
<a name="l11323"></a>11323 <span class="keyword">function</span> hex_hmac_md5(<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>, d)
<a name="l11324"></a>11324   { <span class="keywordflow">return</span> rstr2hex(rstr_hmac_md5(str2rstr_utf8(<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>), str2rstr_utf8(d))); }
<a name="l11325"></a>11325 <span class="keyword">function</span> b64_hmac_md5(<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>, d)
<a name="l11326"></a>11326   { <span class="keywordflow">return</span> rstr2b64(rstr_hmac_md5(str2rstr_utf8(<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>), str2rstr_utf8(d))); }
<a name="l11327"></a>11327 <span class="keyword">function</span> any_hmac_md5(<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>, d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>)
<a name="l11328"></a>11328   { <span class="keywordflow">return</span> rstr2any(rstr_hmac_md5(str2rstr_utf8(<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>), str2rstr_utf8(d)), <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>); }
<a name="l11329"></a>11329 
<a name="l11330"></a>11330 <span class="comment">/*</span>
<a name="l11331"></a>11331 <span class="comment"> * Perform a simple self-test to see if the VM is working</span>
<a name="l11332"></a>11332 <span class="comment"> */</span>
<a name="l11333"></a>11333 <span class="keyword">function</span> md5_vm_test()
<a name="l11334"></a>11334 {
<a name="l11335"></a>11335   <span class="keywordflow">return</span> hex_md5(<span class="stringliteral">&quot;abc&quot;</span>).toLowerCase() == <span class="stringliteral">&quot;900150983cd24fb0d6963f7d28e17f72&quot;</span>;
<a name="l11336"></a>11336 }
<a name="l11337"></a>11337 
<a name="l11338"></a>11338 <span class="comment">/*</span>
<a name="l11339"></a>11339 <span class="comment"> * Calculate the MD5 of a raw string</span>
<a name="l11340"></a>11340 <span class="comment"> */</span>
<a name="l11341"></a>11341 <span class="keyword">function</span> rstr_md5(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>)
<a name="l11342"></a>11342 {
<a name="l11343"></a>11343   <span class="keywordflow">return</span> binl2rstr(binl_md5(rstr2binl(<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>), <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>.length * 8));
<a name="l11344"></a>11344 }
<a name="l11345"></a>11345 
<a name="l11346"></a>11346 <span class="comment">/*</span>
<a name="l11347"></a>11347 <span class="comment"> * Calculate the HMAC-MD5, of a key and some data (raw strings)</span>
<a name="l11348"></a>11348 <span class="comment"> */</span>
<a name="l11349"></a>11349 <span class="keyword">function</span> rstr_hmac_md5(key, data)
<a name="l11350"></a>11350 {
<a name="l11351"></a>11351   var bkey = rstr2binl(key);
<a name="l11352"></a>11352   <span class="keywordflow">if</span>(bkey.length &gt; 16) bkey = binl_md5(bkey, key.length * 8);
<a name="l11353"></a>11353 
<a name="l11354"></a>11354   var ipad = Array(16), opad = Array(16);
<a name="l11355"></a>11355   <span class="keywordflow">for</span>(var i = 0; i &lt; 16; i++)
<a name="l11356"></a>11356   {
<a name="l11357"></a>11357     ipad[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] = bkey[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] ^ 0x36363636;
<a name="l11358"></a>11358     opad[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] = bkey[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] ^ 0x5C5C5C5C;
<a name="l11359"></a>11359   }
<a name="l11360"></a>11360 
<a name="l11361"></a>11361   var hash = binl_md5(ipad.concat(rstr2binl(data)), 512 + data.length * 8);
<a name="l11362"></a>11362   <span class="keywordflow">return</span> binl2rstr(binl_md5(opad.concat(hash), 512 + 128));
<a name="l11363"></a>11363 }
<a name="l11364"></a>11364 
<a name="l11365"></a>11365 <span class="comment">/*</span>
<a name="l11366"></a>11366 <span class="comment"> * Convert a raw string to a hex string</span>
<a name="l11367"></a>11367 <span class="comment"> */</span>
<a name="l11368"></a>11368 <span class="keyword">function</span> rstr2hex(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>)
<a name="l11369"></a>11369 {
<a name="l11370"></a>11370   <span class="keywordflow">try</span> { hexcase } <span class="keywordflow">catch</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) { hexcase=0; }
<a name="l11371"></a>11371   var hex_tab = hexcase ? <span class="stringliteral">&quot;0123456789ABCDEF&quot;</span> : <span class="stringliteral">&quot;0123456789abcdef&quot;</span>;
<a name="l11372"></a>11372   var <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a> = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11373"></a>11373   var x;
<a name="l11374"></a>11374   <span class="keywordflow">for</span>(var i = 0; i &lt; <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length; i++)
<a name="l11375"></a>11375   {
<a name="l11376"></a>11376     x = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i);
<a name="l11377"></a>11377     output += hex_tab.charAt((x &gt;&gt;&gt; 4) &amp; 0x0F)
<a name="l11378"></a>11378            +  hex_tab.charAt( x        &amp; 0x0F);
<a name="l11379"></a>11379   }
<a name="l11380"></a>11380   <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l11381"></a>11381 }
<a name="l11382"></a>11382 
<a name="l11383"></a>11383 <span class="comment">/*</span>
<a name="l11384"></a>11384 <span class="comment"> * Convert a raw string to a base-64 string</span>
<a name="l11385"></a>11385 <span class="comment"> */</span>
<a name="l11386"></a>11386 <span class="keyword">function</span> rstr2b64(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>)
<a name="l11387"></a>11387 {
<a name="l11388"></a>11388   <span class="keywordflow">try</span> { b64pad } <span class="keywordflow">catch</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) { b64pad=<span class="stringliteral">&#39;&#39;</span>; }
<a name="l11389"></a>11389   var tab = <span class="stringliteral">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;
<a name="l11390"></a>11390   var output = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11391"></a>11391   var <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a> = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length;
<a name="l11392"></a>11392   <span class="keywordflow">for</span>(var i = 0; i &lt; <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>; i += 3)
<a name="l11393"></a>11393   {
<a name="l11394"></a>11394     var triplet = (<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i) &lt;&lt; 16)
<a name="l11395"></a>11395                 | (i + 1 &lt; len ? <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i+1) &lt;&lt; 8 : 0)
<a name="l11396"></a>11396                 | (i + 2 &lt; len ? <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i+2)      : 0);
<a name="l11397"></a>11397     <span class="keywordflow">for</span>(var <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a> &lt; 4; <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>++)
<a name="l11398"></a>11398     {
<a name="l11399"></a>11399       <span class="keywordflow">if</span>(i * 8 + <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a> * 6 &gt; <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length * 8) output += <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#a1b3c9c1f22b5fa4d7bc3678a90e89769">b64pad</a>;
<a name="l11400"></a>11400       <span class="keywordflow">else</span> output += tab.charAt((triplet &gt;&gt;&gt; 6*(3-<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>)) &amp; 0x3F);
<a name="l11401"></a>11401     }
<a name="l11402"></a>11402   }
<a name="l11403"></a>11403   <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l11404"></a>11404 }
<a name="l11405"></a>11405 
<a name="l11406"></a>11406 <span class="comment">/*</span>
<a name="l11407"></a>11407 <span class="comment"> * Convert a raw string to an arbitrary string encoding</span>
<a name="l11408"></a>11408 <span class="comment"> */</span>
<a name="l11409"></a>11409 <span class="keyword">function</span> rstr2any(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>, <a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>)
<a name="l11410"></a>11410 {
<a name="l11411"></a>11411   var divisor = <a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>.length;
<a name="l11412"></a>11412   var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>, q, x, quotient;
<a name="l11413"></a>11413 
<a name="l11414"></a>11414   <span class="comment">/* Convert to an array of 16-bit big-endian values, forming the dividend */</span>
<a name="l11415"></a>11415   var dividend = Array(Math.ceil(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length / 2));
<a name="l11416"></a>11416   <span class="keywordflow">for</span>(i = 0; i &lt; dividend.length; i++)
<a name="l11417"></a>11417   {
<a name="l11418"></a>11418     dividend[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] = (<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i * 2) &lt;&lt; 8) | <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i * 2 + 1);
<a name="l11419"></a>11419   }
<a name="l11420"></a>11420 
<a name="l11421"></a>11421   <span class="comment">/*</span>
<a name="l11422"></a>11422 <span class="comment">   * Repeatedly perform a long division. The binary array forms the dividend,</span>
<a name="l11423"></a>11423 <span class="comment">   * the length of the encoding is the divisor. Once computed, the quotient</span>
<a name="l11424"></a>11424 <span class="comment">   * forms the dividend for the next step. All remainders are stored for later</span>
<a name="l11425"></a>11425 <span class="comment">   * use.</span>
<a name="l11426"></a>11426 <span class="comment">   */</span>
<a name="l11427"></a>11427   var full_length = Math.ceil(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length * 8 /
<a name="l11428"></a>11428                                     (Math.log(<a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>.length) / Math.log(2)));
<a name="l11429"></a>11429   var remainders = Array(full_length);
<a name="l11430"></a>11430   <span class="keywordflow">for</span>(j = 0; j &lt; full_length; j++)
<a name="l11431"></a>11431   {
<a name="l11432"></a>11432     quotient = Array();
<a name="l11433"></a>11433     x = 0;
<a name="l11434"></a>11434     <span class="keywordflow">for</span>(i = 0; i &lt; dividend.length; i++)
<a name="l11435"></a>11435     {
<a name="l11436"></a>11436       x = (x &lt;&lt; 16) + dividend[i];
<a name="l11437"></a>11437       q = Math.floor(x / divisor);
<a name="l11438"></a>11438       x -= q * divisor;
<a name="l11439"></a>11439       <span class="keywordflow">if</span>(quotient.length &gt; 0 || q &gt; 0)
<a name="l11440"></a>11440         quotient[quotient.length] = q;
<a name="l11441"></a>11441     }
<a name="l11442"></a>11442     remainders[<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>] = x;
<a name="l11443"></a>11443     dividend = quotient;
<a name="l11444"></a>11444   }
<a name="l11445"></a>11445 
<a name="l11446"></a>11446   <span class="comment">/* Convert the remainders to the output string */</span>
<a name="l11447"></a>11447   var output = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11448"></a>11448   <span class="keywordflow">for</span>(i = remainders.length - 1; i &gt;= 0; i--)
<a name="l11449"></a>11449     output += <a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>.charAt(remainders[i]);
<a name="l11450"></a>11450 
<a name="l11451"></a>11451   <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l11452"></a>11452 }
<a name="l11453"></a>11453 
<a name="l11454"></a>11454 <span class="comment">/*</span>
<a name="l11455"></a>11455 <span class="comment"> * Encode a string as utf-8.</span>
<a name="l11456"></a>11456 <span class="comment"> * For efficiency, this assumes the input is valid utf-16.</span>
<a name="l11457"></a>11457 <span class="comment"> */</span>
<a name="l11458"></a>11458 <span class="keyword">function</span> str2rstr_utf8(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>)
<a name="l11459"></a>11459 {
<a name="l11460"></a>11460   var output = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11461"></a>11461   var i = -1;
<a name="l11462"></a>11462   var x, y;
<a name="l11463"></a>11463 
<a name="l11464"></a>11464   <span class="keywordflow">while</span>(++i &lt; <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length)
<a name="l11465"></a>11465   {
<a name="l11466"></a>11466     <span class="comment">/* Decode utf-16 surrogate pairs */</span>
<a name="l11467"></a>11467     x = <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i);
<a name="l11468"></a>11468     y = i + 1 &lt; <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length ? <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i + 1) : 0;
<a name="l11469"></a>11469     <span class="keywordflow">if</span>(0xD800 &lt;= x &amp;&amp; x &lt;= 0xDBFF &amp;&amp; 0xDC00 &lt;= y &amp;&amp; y &lt;= 0xDFFF)
<a name="l11470"></a>11470     {
<a name="l11471"></a>11471       x = 0x10000 + ((x &amp; 0x03FF) &lt;&lt; 10) + (y &amp; 0x03FF);
<a name="l11472"></a>11472       i++;
<a name="l11473"></a>11473     }
<a name="l11474"></a>11474 
<a name="l11475"></a>11475     <span class="comment">/* Encode output as utf-8 */</span>
<a name="l11476"></a>11476     <span class="keywordflow">if</span>(x &lt;= 0x7F)
<a name="l11477"></a>11477       output += String.fromCharCode(x);
<a name="l11478"></a>11478     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(x &lt;= 0x7FF)
<a name="l11479"></a>11479       output += String.fromCharCode(0xC0 | ((x &gt;&gt;&gt; 6 ) &amp; 0x1F),
<a name="l11480"></a>11480                                     0x80 | ( x         &amp; 0x3F));
<a name="l11481"></a>11481     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(x &lt;= 0xFFFF)
<a name="l11482"></a>11482       output += String.fromCharCode(0xE0 | ((x &gt;&gt;&gt; 12) &amp; 0x0F),
<a name="l11483"></a>11483                                     0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
<a name="l11484"></a>11484                                     0x80 | ( x         &amp; 0x3F));
<a name="l11485"></a>11485     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(x &lt;= 0x1FFFFF)
<a name="l11486"></a>11486       output += String.fromCharCode(0xF0 | ((x &gt;&gt;&gt; 18) &amp; 0x07),
<a name="l11487"></a>11487                                     0x80 | ((x &gt;&gt;&gt; 12) &amp; 0x3F),
<a name="l11488"></a>11488                                     0x80 | ((x &gt;&gt;&gt; 6 ) &amp; 0x3F),
<a name="l11489"></a>11489                                     0x80 | ( x         &amp; 0x3F));
<a name="l11490"></a>11490   }
<a name="l11491"></a>11491   <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l11492"></a>11492 }
<a name="l11493"></a>11493 
<a name="l11494"></a>11494 <span class="comment">/*</span>
<a name="l11495"></a>11495 <span class="comment"> * Encode a string as utf-16</span>
<a name="l11496"></a>11496 <span class="comment"> */</span>
<a name="l11497"></a>11497 <span class="keyword">function</span> str2rstr_utf16le(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>)
<a name="l11498"></a>11498 {
<a name="l11499"></a>11499   var output = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11500"></a>11500   <span class="keywordflow">for</span>(var i = 0; i &lt; <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length; i++)
<a name="l11501"></a>11501     output += String.fromCharCode( <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i)        &amp; 0xFF,
<a name="l11502"></a>11502                                   (<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF);
<a name="l11503"></a>11503   <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l11504"></a>11504 }
<a name="l11505"></a>11505 
<a name="l11506"></a>11506 <span class="keyword">function</span> str2rstr_utf16be(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>)
<a name="l11507"></a>11507 {
<a name="l11508"></a>11508   var output = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11509"></a>11509   <span class="keywordflow">for</span>(var i = 0; i &lt; <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length; i++)
<a name="l11510"></a>11510     output += String.fromCharCode((<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i) &gt;&gt;&gt; 8) &amp; 0xFF,
<a name="l11511"></a>11511                                    <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i)        &amp; 0xFF);
<a name="l11512"></a>11512   <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l11513"></a>11513 }
<a name="l11514"></a>11514 
<a name="l11515"></a>11515 <span class="comment">/*</span>
<a name="l11516"></a>11516 <span class="comment"> * Convert a raw string to an array of little-endian words</span>
<a name="l11517"></a>11517 <span class="comment"> * Characters &gt;255 have their high-byte silently ignored.</span>
<a name="l11518"></a>11518 <span class="comment"> */</span>
<a name="l11519"></a>11519 <span class="keyword">function</span> rstr2binl(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>)
<a name="l11520"></a>11520 {
<a name="l11521"></a>11521   var output = Array(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length &gt;&gt; 2);
<a name="l11522"></a>11522   <span class="keywordflow">for</span>(var i = 0; i &lt; output.length; i++)
<a name="l11523"></a>11523     output[i] = 0;
<a name="l11524"></a>11524   <span class="keywordflow">for</span>(var i = 0; i &lt; <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length * 8; i += 8)
<a name="l11525"></a>11525     output[i&gt;&gt;5] |= (<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.charCodeAt(i / 8) &amp; 0xFF) &lt;&lt; (i%32);
<a name="l11526"></a>11526   <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l11527"></a>11527 }
<a name="l11528"></a>11528 
<a name="l11529"></a>11529 <span class="comment">/*</span>
<a name="l11530"></a>11530 <span class="comment"> * Convert an array of little-endian words to a string</span>
<a name="l11531"></a>11531 <span class="comment"> */</span>
<a name="l11532"></a>11532 <span class="keyword">function</span> binl2rstr(<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>)
<a name="l11533"></a>11533 {
<a name="l11534"></a>11534   var output = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11535"></a>11535   <span class="keywordflow">for</span>(var i = 0; i &lt; <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>.length * 32; i += 8)
<a name="l11536"></a>11536     output += String.fromCharCode((<a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>[i&gt;&gt;5] &gt;&gt;&gt; (i % 32)) &amp; 0xFF);
<a name="l11537"></a>11537   <span class="keywordflow">return</span> <a class="code" href="../../df/d12/latin__test_8js.html#a34687689873d42dec2c94cc27f36e1e9">output</a>;
<a name="l11538"></a>11538 }
<a name="l11539"></a>11539 
<a name="l11540"></a>11540 <span class="comment">/*</span>
<a name="l11541"></a>11541 <span class="comment"> * Calculate the MD5 of an array of little-endian words, and a bit length.</span>
<a name="l11542"></a>11542 <span class="comment"> */</span>
<a name="l11543"></a>11543 <span class="keyword">function</span> binl_md5(x, len)
<a name="l11544"></a>11544 {
<a name="l11545"></a>11545   <span class="comment">/* append padding */</span>
<a name="l11546"></a>11546   x[len &gt;&gt; 5] |= 0x80 &lt;&lt; ((<a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>) % 32);
<a name="l11547"></a>11547   x[(((len + 64) &gt;&gt;&gt; 9) &lt;&lt; 4) + 14] = len;
<a name="l11548"></a>11548 
<a name="l11549"></a>11549   var a =  1732584193;
<a name="l11550"></a>11550   var b = -271733879;
<a name="l11551"></a>11551   var c = -1732584194;
<a name="l11552"></a>11552   var d =  271733878;
<a name="l11553"></a>11553 
<a name="l11554"></a>11554   <span class="keywordflow">for</span>(var i = 0; i &lt; x.length; i += 16)
<a name="l11555"></a>11555   {
<a name="l11556"></a>11556     var olda = <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>;
<a name="l11557"></a>11557     var oldb = <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>;
<a name="l11558"></a>11558     var oldc = <a class="code" href="../../d2/d7d/jsapi_8h.html#a348d5281ca0f01adebb262bee8baf788">c</a>;
<a name="l11559"></a>11559     var oldd = d;
<a name="l11560"></a>11560 
<a name="l11561"></a>11561     a = md5_ff(a, b, c, d, x[i+ 0], 7 , -680876936);
<a name="l11562"></a>11562     d = md5_ff(d, a, b, c, x[i+ 1], 12, -389564586);
<a name="l11563"></a>11563     c = md5_ff(c, d, a, b, x[i+ 2], 17,  606105819);
<a name="l11564"></a>11564     b = md5_ff(b, c, d, a, x[i+ 3], 22, -1044525330);
<a name="l11565"></a>11565     a = md5_ff(a, b, c, d, x[i+ 4], 7 , -176418897);
<a name="l11566"></a>11566     d = md5_ff(d, a, b, c, x[i+ 5], 12,  1200080426);
<a name="l11567"></a>11567     c = md5_ff(c, d, a, b, x[i+ 6], 17, -1473231341);
<a name="l11568"></a>11568     b = md5_ff(b, c, d, a, x[i+ 7], 22, -45705983);
<a name="l11569"></a>11569     a = md5_ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);
<a name="l11570"></a>11570     d = md5_ff(d, a, b, c, x[i+ 9], 12, -1958414417);
<a name="l11571"></a>11571     c = md5_ff(c, d, a, b, x[i+10], 17, -42063);
<a name="l11572"></a>11572     b = md5_ff(b, c, d, a, x[i+11], 22, -1990404162);
<a name="l11573"></a>11573     a = md5_ff(a, b, c, d, x[i+12], 7 ,  1804603682);
<a name="l11574"></a>11574     d = md5_ff(d, a, b, c, x[i+13], 12, -40341101);
<a name="l11575"></a>11575     c = md5_ff(c, d, a, b, x[i+14], 17, -1502002290);
<a name="l11576"></a>11576     b = md5_ff(b, c, d, a, x[i+15], 22,  1236535329);
<a name="l11577"></a>11577 
<a name="l11578"></a>11578     a = md5_gg(a, b, c, d, x[i+ 1], 5 , -165796510);
<a name="l11579"></a>11579     d = md5_gg(d, a, b, c, x[i+ 6], 9 , -1069501632);
<a name="l11580"></a>11580     c = md5_gg(c, d, a, b, x[i+11], 14,  643717713);
<a name="l11581"></a>11581     b = md5_gg(b, c, d, a, x[i+ 0], 20, -373897302);
<a name="l11582"></a>11582     a = md5_gg(a, b, c, d, x[i+ 5], 5 , -701558691);
<a name="l11583"></a>11583     d = md5_gg(d, a, b, c, x[i+10], 9 ,  38016083);
<a name="l11584"></a>11584     c = md5_gg(c, d, a, b, x[i+15], 14, -660478335);
<a name="l11585"></a>11585     b = md5_gg(b, c, d, a, x[i+ 4], 20, -405537848);
<a name="l11586"></a>11586     a = md5_gg(a, b, c, d, x[i+ 9], 5 ,  568446438);
<a name="l11587"></a>11587     d = md5_gg(d, a, b, c, x[i+14], 9 , -1019803690);
<a name="l11588"></a>11588     c = md5_gg(c, d, a, b, x[i+ 3], 14, -187363961);
<a name="l11589"></a>11589     b = md5_gg(b, c, d, a, x[i+ 8], 20,  1163531501);
<a name="l11590"></a>11590     a = md5_gg(a, b, c, d, x[i+13], 5 , -1444681467);
<a name="l11591"></a>11591     d = md5_gg(d, a, b, c, x[i+ 2], 9 , -51403784);
<a name="l11592"></a>11592     c = md5_gg(c, d, a, b, x[i+ 7], 14,  1735328473);
<a name="l11593"></a>11593     b = md5_gg(b, c, d, a, x[i+12], 20, -1926607734);
<a name="l11594"></a>11594 
<a name="l11595"></a>11595     a = md5_hh(a, b, c, d, x[i+ 5], 4 , -378558);
<a name="l11596"></a>11596     d = md5_hh(d, a, b, c, x[i+ 8], 11, -2022574463);
<a name="l11597"></a>11597     c = md5_hh(c, d, a, b, x[i+11], 16,  1839030562);
<a name="l11598"></a>11598     b = md5_hh(b, c, d, a, x[i+14], 23, -35309556);
<a name="l11599"></a>11599     a = md5_hh(a, b, c, d, x[i+ 1], 4 , -1530992060);
<a name="l11600"></a>11600     d = md5_hh(d, a, b, c, x[i+ 4], 11,  1272893353);
<a name="l11601"></a>11601     c = md5_hh(c, d, a, b, x[i+ 7], 16, -155497632);
<a name="l11602"></a>11602     b = md5_hh(b, c, d, a, x[i+10], 23, -1094730640);
<a name="l11603"></a>11603     a = md5_hh(a, b, c, d, x[i+13], 4 ,  681279174);
<a name="l11604"></a>11604     d = md5_hh(d, a, b, c, x[i+ 0], 11, -358537222);
<a name="l11605"></a>11605     c = md5_hh(c, d, a, b, x[i+ 3], 16, -722521979);
<a name="l11606"></a>11606     b = md5_hh(b, c, d, a, x[i+ 6], 23,  76029189);
<a name="l11607"></a>11607     a = md5_hh(a, b, c, d, x[i+ 9], 4 , -640364487);
<a name="l11608"></a>11608     d = md5_hh(d, a, b, c, x[i+12], 11, -421815835);
<a name="l11609"></a>11609     c = md5_hh(c, d, a, b, x[i+15], 16,  530742520);
<a name="l11610"></a>11610     b = md5_hh(b, c, d, a, x[i+ 2], 23, -995338651);
<a name="l11611"></a>11611 
<a name="l11612"></a>11612     a = md5_ii(a, b, c, d, x[i+ 0], 6 , -198630844);
<a name="l11613"></a>11613     d = md5_ii(d, a, b, c, x[i+ 7], 10,  1126891415);
<a name="l11614"></a>11614     c = md5_ii(c, d, a, b, x[i+14], 15, -1416354905);
<a name="l11615"></a>11615     b = md5_ii(b, c, d, a, x[i+ 5], 21, -57434055);
<a name="l11616"></a>11616     a = md5_ii(a, b, c, d, x[i+12], 6 ,  1700485571);
<a name="l11617"></a>11617     d = md5_ii(d, a, b, c, x[i+ 3], 10, -1894986606);
<a name="l11618"></a>11618     c = md5_ii(c, d, a, b, x[i+10], 15, -1051523);
<a name="l11619"></a>11619     b = md5_ii(b, c, d, a, x[i+ 1], 21, -2054922799);
<a name="l11620"></a>11620     a = md5_ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);
<a name="l11621"></a>11621     d = md5_ii(d, a, b, c, x[i+15], 10, -30611744);
<a name="l11622"></a>11622     c = md5_ii(c, d, a, b, x[i+ 6], 15, -1560198380);
<a name="l11623"></a>11623     b = md5_ii(b, c, d, a, x[i+13], 21,  1309151649);
<a name="l11624"></a>11624     a = md5_ii(a, b, c, d, x[i+ 4], 6 , -145523070);
<a name="l11625"></a>11625     d = md5_ii(d, a, b, c, x[i+11], 10, -1120210379);
<a name="l11626"></a>11626     c = md5_ii(c, d, a, b, x[i+ 2], 15,  718787259);
<a name="l11627"></a>11627     b = md5_ii(b, c, d, a, x[i+ 9], 21, -343485551);
<a name="l11628"></a>11628 
<a name="l11629"></a>11629     a = <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(a, olda);
<a name="l11630"></a>11630     b = <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(b, oldb);
<a name="l11631"></a>11631     c = <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(c, oldc);
<a name="l11632"></a>11632     d = <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(d, oldd);
<a name="l11633"></a>11633   }
<a name="l11634"></a>11634   <span class="keywordflow">return</span> Array(a, b, c, d);
<a name="l11635"></a>11635 }
<a name="l11636"></a>11636 
<a name="l11637"></a>11637 <span class="comment">/*</span>
<a name="l11638"></a>11638 <span class="comment"> * These functions implement the four basic operations the algorithm uses.</span>
<a name="l11639"></a>11639 <span class="comment"> */</span>
<a name="l11640"></a>11640 <span class="keyword">function</span> md5_cmn(q, a, b, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t)
<a name="l11641"></a>11641 {
<a name="l11642"></a>11642   <span class="keywordflow">return</span> <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(bit_rol(<a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(<a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(a, q), <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(x, t)), <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>),b);
<a name="l11643"></a>11643 }
<a name="l11644"></a>11644 <span class="keyword">function</span> md5_ff(a, b, c, d, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t)
<a name="l11645"></a>11645 {
<a name="l11646"></a>11646   <span class="keywordflow">return</span> md5_cmn((b &amp; c) | ((~b) &amp; d), a, b, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t);
<a name="l11647"></a>11647 }
<a name="l11648"></a>11648 <span class="keyword">function</span> md5_gg(a, b, c, d, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t)
<a name="l11649"></a>11649 {
<a name="l11650"></a>11650   <span class="keywordflow">return</span> md5_cmn((b &amp; d) | (c &amp; (~d)), a, b, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t);
<a name="l11651"></a>11651 }
<a name="l11652"></a>11652 <span class="keyword">function</span> md5_hh(a, b, c, d, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t)
<a name="l11653"></a>11653 {
<a name="l11654"></a>11654   <span class="keywordflow">return</span> md5_cmn(b ^ c ^ d, a, b, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t);
<a name="l11655"></a>11655 }
<a name="l11656"></a>11656 <span class="keyword">function</span> md5_ii(a, b, c, d, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t)
<a name="l11657"></a>11657 {
<a name="l11658"></a>11658   <span class="keywordflow">return</span> md5_cmn(c ^ (b | (~d)), a, b, x, <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>, t);
<a name="l11659"></a>11659 }
<a name="l11660"></a>11660 
<a name="l11661"></a>11661 <span class="comment">/*</span>
<a name="l11662"></a>11662 <span class="comment"> * Add integers, wrapping at 2^32. This uses 16-bit operations internally</span>
<a name="l11663"></a>11663 <span class="comment"> * to work around bugs in some JS interpreters.</span>
<a name="l11664"></a>11664 <span class="comment"> */</span>
<a name="l11665"></a>11665 <span class="keyword">function</span> <a class="code" href="../../da/d5b/showcase__apps_2twittershare_2js_2ext_2sha1_8js.html#acebf897e9468e4952ed0e5352b22c2b1">safe_add</a>(x, y)
<a name="l11666"></a>11666 {
<a name="l11667"></a>11667   var lsw = (x &amp; 0xFFFF) + (y &amp; 0xFFFF);
<a name="l11668"></a>11668   var msw = (x &gt;&gt; 16) + (y &gt;&gt; 16) + (lsw &gt;&gt; 16);
<a name="l11669"></a>11669   <span class="keywordflow">return</span> (msw &lt;&lt; 16) | (lsw &amp; 0xFFFF);
<a name="l11670"></a>11670 }
<a name="l11671"></a>11671 
<a name="l11672"></a>11672 <span class="comment">/*</span>
<a name="l11673"></a>11673 <span class="comment"> * Bitwise rotate a 32-bit number to the left.</span>
<a name="l11674"></a>11674 <span class="comment"> */</span>
<a name="l11675"></a>11675 <span class="keyword">function</span> bit_rol(<a class="code" href="../../de/d81/xpt__struct_8h.html#af23ba264fc6071dcd37179d8a2b5440b">num</a>, cnt)
<a name="l11676"></a>11676 {
<a name="l11677"></a>11677   <span class="keywordflow">return</span> (<a class="code" href="../../de/d81/xpt__struct_8h.html#af23ba264fc6071dcd37179d8a2b5440b">num</a> &lt;&lt; cnt) | (<a class="code" href="../../de/d81/xpt__struct_8h.html#af23ba264fc6071dcd37179d8a2b5440b">num</a> &gt;&gt;&gt; (32 - cnt));
<a name="l11678"></a>11678 }
<a name="l11679"></a>11679 
<a name="l11680"></a>11680 });
<a name="l11681"></a>11681 
<a name="l11688"></a>11688 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;encoding&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l11689"></a>11689 
<a name="l11690"></a>11690 <span class="comment">// from https://github.com/andris9/encoding/blob/master/index.js</span>
<a name="l11691"></a>11691 <span class="comment">// (MIT licensed)</span>
<a name="l11698"></a>11698 <span class="comment"></span><span class="keyword">function</span> checkEncoding(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>){
<a name="l11699"></a>11699     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> = (<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> || <span class="stringliteral">&quot;&quot;</span>).<a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>().trim().toLowerCase().
<a name="l11700"></a>11700         <span class="comment">// this handles aliases with dashes and underscores too; built-in</span>
<a name="l11701"></a>11701         <span class="comment">// aliase are only for latin1, latin2, etc.</span>
<a name="l11702"></a>11702         <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/^latin[\-<a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>]?(\d+)$/, <span class="stringliteral">&quot;iso-8859-$1&quot;</span>).
<a name="l11703"></a>11703         <span class="comment">// win949, win-949, ms949 =&gt; windows-949</span>
<a name="l11704"></a>11704         <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/^(?:(?:win(?:dows)?)|ms)[\-<a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>]?(\d+)$/, <span class="stringliteral">&quot;windows-$1&quot;</span>).
<a name="l11705"></a>11705         <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/^utf[\-<a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>]?(\d+)$/, <span class="stringliteral">&quot;utf-$1&quot;</span>).
<a name="l11706"></a>11706         <a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/^us_?<a class="code" href="../../d2/d7d/jsapi_8h.html#af4cd8e00680d4ed17cdfbece34a8ced5">ascii</a>$/, <span class="stringliteral">&quot;ascii&quot;</span>); <span class="comment">// maps to windows-1252</span>
<a name="l11707"></a>11707     <span class="keywordflow">return</span> <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l11708"></a>11708 }
<a name="l11709"></a>11709 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.checkEncoding = checkEncoding;
<a name="l11710"></a>11710 
<a name="l11711"></a>11711 var ENCODER_OPTIONS = { fatal: <span class="keyword">false</span> };
<a name="l11712"></a>11712 
<a name="l11713"></a>11713 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.convert = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, destEnc, sourceEnc, ignoredUseLite) {
<a name="l11714"></a>11714   destEnc = checkEncoding(destEnc || <span class="stringliteral">&#39;utf-8&#39;</span>);
<a name="l11715"></a>11715   sourceEnc = checkEncoding(sourceEnc || <span class="stringliteral">&#39;utf-8&#39;</span>);
<a name="l11716"></a>11716 
<a name="l11717"></a>11717   <span class="keywordflow">if</span> (destEnc === sourceEnc)
<a name="l11718"></a>11718     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, <span class="stringliteral">&#39;utf-8&#39;</span>);
<a name="l11719"></a>11719 
<a name="l11720"></a>11720   <span class="comment">// - decoding (Uint8Array =&gt; String)</span>
<a name="l11721"></a>11721   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (/^utf-8$/.<a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a4fe50fa16c059b33ed172c344bb3fc74">test</a>(destEnc)) {
<a name="l11722"></a>11722     var decoder = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a0e3c3c2d2b62a1fb09b3187256812cbe">TextDecoder</a>(sourceEnc, ENCODER_OPTIONS);
<a name="l11723"></a>11723     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) === <span class="stringliteral">&#39;string&#39;</span>)
<a name="l11724"></a>11724       <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = <span class="keyword">new</span> <a class="code" href="../../d6/d51/namespacemozilla_1_1plugins.html#a72ea86f5ca4664a57e64f9477a7475ff">Buffer</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, <span class="stringliteral">&#39;binary&#39;</span>);
<a name="l11725"></a>11725     <span class="comment">// XXX strictly speaking, we should be returning a buffer...</span>
<a name="l11726"></a>11726     <span class="keywordflow">return</span> decoder.decode(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l11727"></a>11727   }
<a name="l11728"></a>11728   <span class="comment">// - encoding (String =&gt; Uint8Array)</span>
<a name="l11729"></a>11729   <span class="keywordflow">else</span> {
<a name="l11730"></a>11730     var idxSlash = destEnc.indexOf(<span class="charliteral">&#39;/&#39;</span>);
<a name="l11731"></a>11731     <span class="comment">// ignore &#39;//TRANSLIT//IGNORE&#39; and the like.</span>
<a name="l11732"></a>11732     <span class="keywordflow">if</span> (idxSlash !== -1 &amp;&amp; destEnc[idxSlash+1] === <span class="charliteral">&#39;/&#39;</span>)
<a name="l11733"></a>11733       destEnc = destEnc.substring(0, idxSlash);
<a name="l11734"></a>11734 
<a name="l11735"></a>11735     var encoder = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a992caf3b993bd7025dad3c150b51fb1b">TextEncoder</a>(destEnc, ENCODER_OPTIONS);
<a name="l11736"></a>11736     <span class="keywordflow">return</span> encoder.encode(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l11737"></a>11737   }
<a name="l11738"></a>11738 };
<a name="l11739"></a>11739 
<a name="l11740"></a>11740 });
<a name="l11741"></a>11741 
<a name="l11742"></a>11742 <span class="comment">/* Holds localized strings fo mailchew. mailbridge will set the values.</span>
<a name="l11743"></a>11743 <span class="comment"> * This is broken out as a separate module so that mailchew can be loaded</span>
<a name="l11744"></a>11744 <span class="comment"> * async as needed.</span>
<a name="l11745"></a>11745 <span class="comment"> **/</span>
<a name="l11746"></a>11746 
<a name="l11747"></a>11747 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/mailchew-strings&#39;</span>,
<a name="l11748"></a>11748   [
<a name="l11749"></a>11749     <span class="stringliteral">&#39;exports&#39;</span>,
<a name="l11750"></a>11750     <span class="stringliteral">&#39;events&#39;</span>
<a name="l11751"></a>11751   ],
<a name="l11752"></a>11752   <span class="keyword">function</span>(
<a name="l11753"></a>11753     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>,
<a name="l11754"></a>11754     $EventEmitter
<a name="l11755"></a>11755   ) {
<a name="l11756"></a>11756 
<a name="l11757"></a>11757 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.events = <span class="keyword">new</span> $EventEmitter.EventEmitter();
<a name="l11758"></a>11758 
<a name="l11759"></a>11759 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.set = <span class="keyword">function</span> <span class="keyword">set</span>(<a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>) {
<a name="l11760"></a>11760   <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.strings = <a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>;
<a name="l11761"></a>11761   <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.events.emit(<span class="stringliteral">&#39;strings&#39;</span>, <a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>);
<a name="l11762"></a>11762 };
<a name="l11763"></a>11763 
<a name="l11764"></a>11764 });
<a name="l11765"></a>11765 
<a name="l11766"></a>11766 <span class="comment">/*global define */</span>
<a name="l11767"></a>11767 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/slice_bridge_proxy&#39;</span>,
<a name="l11768"></a>11768   [
<a name="l11769"></a>11769     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l11770"></a>11770   ],
<a name="l11771"></a>11771   <span class="keyword">function</span>(
<a name="l11772"></a>11772     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l11773"></a>11773   ) {
<a name="l11774"></a>11774 
<a name="l11775"></a>11775 <span class="keyword">function</span> SliceBridgeProxy(bridge, <a class="code" href="../../d4/d21/calendar_2js_2controllers_2alarm_8js.html#a0416fc4d5e8ec4fd436369a406438e44">ns</a>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>) {
<a name="l11776"></a>11776   this._bridge = bridge;
<a name="l11777"></a>11777   this._ns = <a class="code" href="../../d4/d21/calendar_2js_2controllers_2alarm_8js.html#a0416fc4d5e8ec4fd436369a406438e44">ns</a>;
<a name="l11778"></a>11778   this._handle = <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>;
<a name="l11779"></a>11779   this.__listener = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l11780"></a>11780 
<a name="l11781"></a>11781   this.<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a> = <span class="stringliteral">&#39;synced&#39;</span>;
<a name="l11782"></a>11782   this.progress = 0.0;
<a name="l11783"></a>11783   this.atTop = <span class="keyword">false</span>;
<a name="l11784"></a>11784   this.atBottom = <span class="keyword">false</span>;
<a name="l11796"></a>11796   this.userCanGrowUpwards = <span class="keyword">false</span>;
<a name="l11797"></a>11797   this.userCanGrowDownwards = <span class="keyword">false</span>;
<a name="l11798"></a>11798 }
<a name="l11799"></a>11799 
<a name="l11800"></a>11800 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.SliceBridgeProxy = SliceBridgeProxy;
<a name="l11801"></a>11801 
<a name="l11802"></a>11802 SliceBridgeProxy.prototype = {
<a name="l11808"></a>11808   sendSplice: <span class="keyword">function</span> sbp_sendSplice(index, howMany, addItems, requested,
<a name="l11809"></a>11809                                       moreExpected, newEmailCount) {
<a name="l11810"></a>11810     this._bridge.__sendMessage({
<a name="l11811"></a>11811       type: <span class="stringliteral">&#39;sliceSplice&#39;</span>,
<a name="l11812"></a>11812       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle,
<a name="l11813"></a>11813       index: <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>,
<a name="l11814"></a>11814       howMany: howMany,
<a name="l11815"></a>11815       addItems: addItems,
<a name="l11816"></a>11816       requested: requested,
<a name="l11817"></a>11817       moreExpected: moreExpected,
<a name="l11818"></a>11818       <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: this.<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>,
<a name="l11819"></a>11819       progress: this.progress,
<a name="l11820"></a>11820       atTop: this.atTop,
<a name="l11821"></a>11821       atBottom: this.atBottom,
<a name="l11822"></a>11822       userCanGrowUpwards: this.userCanGrowUpwards,
<a name="l11823"></a>11823       userCanGrowDownwards: this.userCanGrowDownwards,
<a name="l11824"></a>11824       newEmailCount: newEmailCount,
<a name="l11825"></a>11825     });
<a name="l11826"></a>11826   },
<a name="l11827"></a>11827 
<a name="l11831"></a>11831   sendUpdate: <span class="keyword">function</span> sbp_sendUpdate(indexUpdatesRun) {
<a name="l11832"></a>11832     this._bridge.__sendMessage({
<a name="l11833"></a>11833       type: <span class="stringliteral">&#39;sliceUpdate&#39;</span>,
<a name="l11834"></a>11834       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle,
<a name="l11835"></a>11835       updates: indexUpdatesRun,
<a name="l11836"></a>11836     });
<a name="l11837"></a>11837   },
<a name="l11838"></a>11838 
<a name="l11843"></a>11843   sendStatus: <span class="keyword">function</span> sbp_sendStatus(<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, requested, moreExpected,
<a name="l11844"></a>11844                                       progress, newEmailCount) {
<a name="l11845"></a>11845     this.<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a> = <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>;
<a name="l11846"></a>11846     <span class="keywordflow">if</span> (progress != <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l11847"></a>11847       this.progress = progress;
<a name="l11848"></a>11848     this.sendSplice(0, 0, [], requested, moreExpected, newEmailCount);
<a name="l11849"></a>11849   },
<a name="l11850"></a>11850 
<a name="l11851"></a>11851   sendSyncProgress: <span class="keyword">function</span>(progress) {
<a name="l11852"></a>11852     this.progress = progress;
<a name="l11853"></a>11853     this.sendSplice(0, 0, [], <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l11854"></a>11854   },
<a name="l11855"></a>11855 
<a name="l11856"></a>11856   <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span> sbp_die() {
<a name="l11857"></a>11857     <span class="keywordflow">if</span> (this.__listener)
<a name="l11858"></a>11858       this.__listener.die();
<a name="l11859"></a>11859   },
<a name="l11860"></a>11860 };
<a name="l11861"></a>11861 
<a name="l11862"></a>11862 });
<a name="l11863"></a>11863 
<a name="l11868"></a>11868 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/mailbridge&#39;</span>,
<a name="l11869"></a>11869   [
<a name="l11870"></a>11870     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l11871"></a>11871     <span class="stringliteral">&#39;./util&#39;</span>,
<a name="l11872"></a>11872     <span class="stringliteral">&#39;./mailchew-strings&#39;</span>,
<a name="l11873"></a>11873     <span class="stringliteral">&#39;./date&#39;</span>,
<a name="l11874"></a>11874     <span class="stringliteral">&#39;./slice_bridge_proxy&#39;</span>,
<a name="l11875"></a>11875     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l11876"></a>11876     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l11877"></a>11877     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l11878"></a>11878   ],
<a name="l11879"></a>11879   <span class="keyword">function</span>(
<a name="l11880"></a>11880     $log,
<a name="l11881"></a>11881     $imaputil,
<a name="l11882"></a>11882     $mailchewStrings,
<a name="l11883"></a>11883     $date,
<a name="l11884"></a>11884     $sliceBridgeProxy,
<a name="l11885"></a>11885     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l11886"></a>11886     $module,
<a name="l11887"></a>11887     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l11888"></a>11888   ) {
<a name="l11889"></a>11889 var bsearchForInsert = $imaputil.bsearchForInsert,
<a name="l11890"></a>11890     bsearchMaybeExists = $imaputil.bsearchMaybeExists,
<a name="l11891"></a>11891     SliceBridgeProxy = $sliceBridgeProxy.SliceBridgeProxy;
<a name="l11892"></a>11892 
<a name="l11893"></a>11893 <span class="keyword">function</span> toBridgeWireOn(x) {
<a name="l11894"></a>11894   <span class="keywordflow">return</span> x.toBridgeWire();
<a name="l11895"></a>11895 }
<a name="l11896"></a>11896 
<a name="l11897"></a>11897 var FOLDER_TYPE_TO_SORT_PRIORITY = {
<a name="l11898"></a>11898   account: <span class="charliteral">&#39;a&#39;</span>,
<a name="l11899"></a>11899   inbox: <span class="charliteral">&#39;c&#39;</span>,
<a name="l11900"></a>11900   starred: <span class="charliteral">&#39;e&#39;</span>,
<a name="l11901"></a>11901   important: <span class="charliteral">&#39;f&#39;</span>,
<a name="l11902"></a>11902   drafts: <span class="charliteral">&#39;g&#39;</span>,
<a name="l11903"></a>11903   localdrafts: <span class="charliteral">&#39;h&#39;</span>,
<a name="l11904"></a>11904   queue: <span class="charliteral">&#39;i&#39;</span>,
<a name="l11905"></a>11905   sent: <span class="charliteral">&#39;j&#39;</span>,
<a name="l11906"></a>11906   junk: <span class="charliteral">&#39;k&#39;</span>,
<a name="l11907"></a>11907   trash: <span class="charliteral">&#39;m&#39;</span>,
<a name="l11908"></a>11908   archive: <span class="charliteral">&#39;o&#39;</span>,
<a name="l11909"></a>11909   normal: <span class="charliteral">&#39;z&#39;</span>,
<a name="l11910"></a>11910   <span class="comment">// nomail folders are annoying since they are basically just hierarchy,</span>
<a name="l11911"></a>11911   <span class="comment">//  but they are also rare and should only happen amongst normal folders.</span>
<a name="l11912"></a>11912   nomail: <span class="charliteral">&#39;z&#39;</span>,
<a name="l11913"></a>11913 };
<a name="l11914"></a>11914 
<a name="l11924"></a>11924 <span class="keyword">function</span> makeFolderSortString(account, folder) {
<a name="l11925"></a>11925   <span class="keywordflow">if</span> (!folder)
<a name="l11926"></a>11926     <span class="keywordflow">return</span> account.id;
<a name="l11927"></a>11927 
<a name="l11928"></a>11928   var parentFolder = account.getFolderMetaForFolderId(folder.parentId);
<a name="l11929"></a>11929   <span class="keywordflow">return</span> makeFolderSortString(account, parentFolder) + <span class="charliteral">&#39;!&#39;</span> +
<a name="l11930"></a>11930          FOLDER_TYPE_TO_SORT_PRIORITY[folder.type] + <span class="charliteral">&#39;!&#39;</span> +
<a name="l11931"></a>11931          folder.name.toLocaleLowerCase();
<a name="l11932"></a>11932 }
<a name="l11933"></a>11933 
<a name="l11934"></a>11934 <span class="keyword">function</span> strcmp(a, b) {
<a name="l11935"></a>11935   <span class="keywordflow">if</span> (a &lt; b)
<a name="l11936"></a>11936     <span class="keywordflow">return</span> -1;
<a name="l11937"></a>11937   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a &gt; b)
<a name="l11938"></a>11938     <span class="keywordflow">return</span> 1;
<a name="l11939"></a>11939   <span class="keywordflow">return</span> 0;
<a name="l11940"></a>11940 }
<a name="l11941"></a>11941 
<a name="l11942"></a>11942 <span class="keyword">function</span> checkIfAddressListContainsAddress(list, addrPair) {
<a name="l11943"></a>11943   <span class="keywordflow">if</span> (!list)
<a name="l11944"></a>11944     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l11945"></a>11945   var checkAddress = addrPair.address;
<a name="l11946"></a>11946   <span class="keywordflow">for</span> (var i = 0; i &lt; list.length; i++) {
<a name="l11947"></a>11947     <span class="keywordflow">if</span> (list[i].<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a> === checkAddress)
<a name="l11948"></a>11948       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l11949"></a>11949   }
<a name="l11950"></a>11950   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l11951"></a>11951 }
<a name="l11952"></a>11952 
<a name="l11958"></a>11958 <span class="keyword">function</span> MailBridge(universe, <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>) {
<a name="l11959"></a>11959   this.universe = universe;
<a name="l11960"></a>11960   this.universe.registerBridge(<span class="keyword">this</span>);
<a name="l11961"></a>11961 
<a name="l11962"></a>11962   this._LOG = LOGFAB.MailBridge(<span class="keyword">this</span>, universe._LOG, <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l11964"></a>11964   this._slices = {};
<a name="l11966"></a>11966   this._slicesByType = {
<a name="l11967"></a>11967     accounts: [],
<a name="l11968"></a>11968     identities: [],
<a name="l11969"></a>11969     folders: [],
<a name="l11970"></a>11970     headers: [],
<a name="l11971"></a>11971     matchedHeaders: [],
<a name="l11972"></a>11972   };
<a name="l11973"></a>11973 
<a name="l11987"></a>11987   this._observedBodies = {};
<a name="l11988"></a>11988 
<a name="l11989"></a>11989   <span class="comment">// outstanding persistent objects that aren&#39;t slices. covers: composition</span>
<a name="l11990"></a>11990   this._pendingRequests = {};
<a name="l11991"></a>11991   <span class="comment">//</span>
<a name="l11992"></a>11992   this._lastUndoableOpPair = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l11993"></a>11993 }
<a name="l11994"></a>11994 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MailBridge = MailBridge;
<a name="l11995"></a>11995 MailBridge.prototype = {
<a name="l11996"></a>11996   __sendMessage: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l11997"></a>11997     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;This is supposed to get hidden by an instance var.&#39;</span>);
<a name="l11998"></a>11998   },
<a name="l11999"></a>11999 
<a name="l12000"></a>12000   __receiveMessage: <span class="keyword">function</span> mb___receiveMessage(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12001"></a>12001     var implCmdName = <span class="stringliteral">&#39;_cmd_&#39;</span> + <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.type;
<a name="l12002"></a>12002     <span class="keywordflow">if</span> (!(implCmdName in <span class="keyword">this</span>)) {
<a name="l12003"></a>12003       this._LOG.badMessageType(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.type);
<a name="l12004"></a>12004       <span class="keywordflow">return</span>;
<a name="l12005"></a>12005     }
<a name="l12006"></a>12006     var rval = this._LOG.cmd(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.type, <span class="keyword">this</span>, <span class="keyword">this</span>[implCmdName], <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>);
<a name="l12007"></a>12007   },
<a name="l12008"></a>12008 
<a name="l12009"></a>12009   _cmd_ping: <span class="keyword">function</span> mb__cmd_ping(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12010"></a>12010     this.__sendMessage({
<a name="l12011"></a>12011       type: <span class="stringliteral">&#39;pong&#39;</span>,
<a name="l12012"></a>12012       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12013"></a>12013     });
<a name="l12014"></a>12014   },
<a name="l12015"></a>12015 
<a name="l12016"></a>12016   _cmd_modifyConfig: <span class="keyword">function</span> mb__cmd_modifyConfig(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12017"></a>12017     this.universe.modifyConfig(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mods);
<a name="l12018"></a>12018   },
<a name="l12019"></a>12019 
<a name="l12027"></a>12027   bodyHasObservers: <span class="keyword">function</span>(suid) {
<a name="l12028"></a>12028     <span class="keywordflow">return</span> !!this._observedBodies[suid];
<a name="l12029"></a>12029   },
<a name="l12030"></a>12030 
<a name="l12031"></a>12031   notifyConfig: <span class="keyword">function</span>(<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>) {
<a name="l12032"></a>12032     this.__sendMessage({
<a name="l12033"></a>12033       type: <span class="stringliteral">&#39;config&#39;</span>,
<a name="l12034"></a>12034       <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>: <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>,
<a name="l12035"></a>12035     });
<a name="l12036"></a>12036   },
<a name="l12037"></a>12037 
<a name="l12038"></a>12038   _cmd_debugSupport: <span class="keyword">function</span> mb__cmd_debugSupport(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12039"></a>12039     <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.cmd) {
<a name="l12040"></a>12040       <span class="keywordflow">case</span> <span class="stringliteral">&#39;setLogging&#39;</span>:
<a name="l12041"></a>12041         this.universe.modifyConfig({ debugLogging: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.arg });
<a name="l12042"></a>12042         <span class="keywordflow">break</span>;
<a name="l12043"></a>12043 
<a name="l12044"></a>12044       <span class="keywordflow">case</span> <span class="stringliteral">&#39;dumpLog&#39;</span>:
<a name="l12045"></a>12045         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.arg) {
<a name="l12046"></a>12046           <span class="keywordflow">case</span> <span class="stringliteral">&#39;storage&#39;</span>:
<a name="l12047"></a>12047             this.universe.dumpLogToDeviceStorage();
<a name="l12048"></a>12048             <span class="keywordflow">break</span>;
<a name="l12049"></a>12049         }
<a name="l12050"></a>12050         <span class="keywordflow">break</span>;
<a name="l12051"></a>12051     }
<a name="l12052"></a>12052   },
<a name="l12053"></a>12053 
<a name="l12054"></a>12054   _cmd_setInteractive: <span class="keyword">function</span> mb__cmd_setInteractive(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12055"></a>12055     this.universe.setInteractive();
<a name="l12056"></a>12056   },
<a name="l12057"></a>12057 
<a name="l12058"></a>12058   _cmd_localizedStrings: <span class="keyword">function</span> mb__cmd_localizedStrings(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12059"></a>12059     $mailchewStrings.set(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.strings);
<a name="l12060"></a>12060   },
<a name="l12061"></a>12061 
<a name="l12062"></a>12062   _cmd_tryToCreateAccount: <span class="keyword">function</span> mb__cmd_tryToCreateAccount(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12063"></a>12063     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l12064"></a>12064     this.universe.tryToCreateAccount(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.details, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.domainInfo,
<a name="l12065"></a>12065                                      <span class="keyword">function</span>(error, account, errorDetails) {
<a name="l12066"></a>12066         <span class="keyword">self</span>.__sendMessage({
<a name="l12067"></a>12067             type: <span class="stringliteral">&#39;tryToCreateAccountResults&#39;</span>,
<a name="l12068"></a>12068             <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12069"></a>12069             account: account ? account.toBridgeWire() : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12070"></a>12070             error: <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>,
<a name="l12071"></a>12071             errorDetails: errorDetails,
<a name="l12072"></a>12072           });
<a name="l12073"></a>12073       });
<a name="l12074"></a>12074   },
<a name="l12075"></a>12075 
<a name="l12076"></a>12076   _cmd_clearAccountProblems: <span class="keyword">function</span> mb__cmd_clearAccountProblems(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12077"></a>12077     var account = this.universe.getAccountForAccountId(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.accountId),
<a name="l12078"></a>12078         <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l12079"></a>12079     account.checkAccount(<span class="keyword">function</span>(err) {
<a name="l12080"></a>12080       <span class="comment">// If we succeeded or the problem was not an authentication, assume</span>
<a name="l12081"></a>12081       <span class="comment">// everything went fine and clear the problems.  This includes the case</span>
<a name="l12082"></a>12082       <span class="comment">// we&#39;re offline.</span>
<a name="l12083"></a>12083       <span class="keywordflow">if</span> (!err || (
<a name="l12084"></a>12084           err !== <span class="stringliteral">&#39;bad-user-or-pass&#39;</span> &amp;&amp;
<a name="l12085"></a>12085           err !== <span class="stringliteral">&#39;needs-app-pass&#39;</span> &amp;&amp;
<a name="l12086"></a>12086           err !== <span class="stringliteral">&#39;imap-disabled&#39;</span>
<a name="l12087"></a>12087         )) {
<a name="l12088"></a>12088         <span class="keyword">self</span>.universe.clearAccountProblems(account);
<a name="l12089"></a>12089       }
<a name="l12090"></a>12090       <span class="comment">// The login information is still bad; re-send the bad login notification.</span>
<a name="l12091"></a>12091       <span class="keywordflow">else</span> {
<a name="l12092"></a>12092         <span class="comment">// This is only being sent over this, the same bridge the clear request</span>
<a name="l12093"></a>12093         <span class="comment">// came from rather than sent via the mailuniverse.  No point having the</span>
<a name="l12094"></a>12094         <span class="comment">// notifications stack up on inactive UIs.</span>
<a name="l12095"></a>12095         <span class="keyword">self</span>.notifyBadLogin(account, err);
<a name="l12096"></a>12096       }
<a name="l12097"></a>12097       <span class="keyword">self</span>.__sendMessage({
<a name="l12098"></a>12098         type: <span class="stringliteral">&#39;clearAccountProblems&#39;</span>,
<a name="l12099"></a>12099         <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12100"></a>12100       });
<a name="l12101"></a>12101     });
<a name="l12102"></a>12102   },
<a name="l12103"></a>12103 
<a name="l12104"></a>12104   _cmd_modifyAccount: <span class="keyword">function</span> mb__cmd_modifyAccount(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12105"></a>12105     var account = this.universe.getAccountForAccountId(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.accountId),
<a name="l12106"></a>12106         accountDef = account.accountDef;
<a name="l12107"></a>12107 
<a name="l12108"></a>12108     <span class="keywordflow">for</span> (var key in <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mods) {
<a name="l12109"></a>12109       var val = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mods[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l12110"></a>12110 
<a name="l12111"></a>12111       <span class="keywordflow">switch</span> (key) {
<a name="l12112"></a>12112         <span class="keywordflow">case</span> <span class="stringliteral">&#39;name&#39;</span>:
<a name="l12113"></a>12113           accountDef.name = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l12114"></a>12114           <span class="keywordflow">break</span>;
<a name="l12115"></a>12115 
<a name="l12116"></a>12116         <span class="keywordflow">case</span> <span class="stringliteral">&#39;username&#39;</span>:
<a name="l12117"></a>12117           accountDef.credentials.username = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l12118"></a>12118           <span class="keywordflow">break</span>;
<a name="l12119"></a>12119         <span class="keywordflow">case</span> <span class="stringliteral">&#39;password&#39;</span>:
<a name="l12120"></a>12120           accountDef.credentials.password = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l12121"></a>12121           <span class="keywordflow">break</span>;
<a name="l12122"></a>12122 
<a name="l12123"></a>12123         <span class="keywordflow">case</span> <span class="stringliteral">&#39;identities&#39;</span>:
<a name="l12124"></a>12124           <span class="comment">// TODO: support identity mutation</span>
<a name="l12125"></a>12125           <span class="comment">// we expect a list of identity mutation objects, namely an id and the</span>
<a name="l12126"></a>12126           <span class="comment">// rest are attributes to change</span>
<a name="l12127"></a>12127           <span class="keywordflow">break</span>;
<a name="l12128"></a>12128 
<a name="l12129"></a>12129         <span class="keywordflow">case</span> <span class="stringliteral">&#39;servers&#39;</span>:
<a name="l12130"></a>12130           <span class="comment">// TODO: support server mutation</span>
<a name="l12131"></a>12131           <span class="comment">// we expect a list of server mutation objects; namely, the type names</span>
<a name="l12132"></a>12132           <span class="comment">// the server and the rest are attributes to change</span>
<a name="l12133"></a>12133           <span class="keywordflow">break</span>;
<a name="l12134"></a>12134 
<a name="l12135"></a>12135         <span class="keywordflow">case</span> <span class="stringliteral">&#39;syncRange&#39;</span>:
<a name="l12136"></a>12136           accountDef.syncRange = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l12137"></a>12137           <span class="keywordflow">break</span>;
<a name="l12138"></a>12138 
<a name="l12139"></a>12139         <span class="keywordflow">case</span> <span class="stringliteral">&#39;syncInterval&#39;</span>:
<a name="l12140"></a>12140           accountDef.syncInterval = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l12141"></a>12141           <span class="keywordflow">break</span>;
<a name="l12142"></a>12142 
<a name="l12143"></a>12143         <span class="keywordflow">case</span> <span class="stringliteral">&#39;notifyOnNew&#39;</span>:
<a name="l12144"></a>12144           accountDef.notifyOnNew = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l12145"></a>12145           <span class="keywordflow">break</span>;
<a name="l12146"></a>12146 
<a name="l12147"></a>12147         <span class="keywordflow">case</span> <span class="stringliteral">&#39;setAsDefault&#39;</span>:
<a name="l12148"></a>12148           <span class="comment">// Weird things can happen if the device&#39;s clock goes back in time,</span>
<a name="l12149"></a>12149           <span class="comment">// but this way, at least the user can change their default if they</span>
<a name="l12150"></a>12150           <span class="comment">// cycle through their accounts.</span>
<a name="l12151"></a>12151           <span class="keywordflow">if</span> (val)
<a name="l12152"></a>12152             accountDef.defaultPriority = $date.NOW();
<a name="l12153"></a>12153           <span class="keywordflow">break</span>;
<a name="l12154"></a>12154       }
<a name="l12155"></a>12155     }
<a name="l12156"></a>12156 
<a name="l12157"></a>12157     this.universe.saveAccountDef(accountDef, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l12158"></a>12158   },
<a name="l12159"></a>12159 
<a name="l12160"></a>12160   _cmd_deleteAccount: <span class="keyword">function</span> mb__cmd_deleteAccount(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12161"></a>12161     this.universe.deleteAccount(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.accountId);
<a name="l12162"></a>12162   },
<a name="l12163"></a>12163 
<a name="l12164"></a>12164   notifyBadLogin: <span class="keyword">function</span> mb_notifyBadLogin(account, problem) {
<a name="l12165"></a>12165     this.__sendMessage({
<a name="l12166"></a>12166       type: <span class="stringliteral">&#39;badLogin&#39;</span>,
<a name="l12167"></a>12167       account: account.toBridgeWire(),
<a name="l12168"></a>12168       problem: problem
<a name="l12169"></a>12169     });
<a name="l12170"></a>12170   },
<a name="l12171"></a>12171 
<a name="l12172"></a>12172   _cmd_viewAccounts: <span class="keyword">function</span> mb__cmd_viewAccounts(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12173"></a>12173     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] =
<a name="l12174"></a>12174           <span class="keyword">new</span> SliceBridgeProxy(<span class="keyword">this</span>, <span class="stringliteral">&#39;accounts&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12175"></a>12175     proxy.markers = this.universe.accounts.map(<span class="keyword">function</span>(x) { <span class="keywordflow">return</span> x.id; });
<a name="l12176"></a>12176 
<a name="l12177"></a>12177     this._slicesByType[<span class="stringliteral">&#39;accounts&#39;</span>].push(proxy);
<a name="l12178"></a>12178     var wireReps = this.universe.accounts.map(toBridgeWireOn);
<a name="l12179"></a>12179     <span class="comment">// send all the accounts in one go.</span>
<a name="l12180"></a>12180     proxy.sendSplice(0, 0, wireReps, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l12181"></a>12181   },
<a name="l12182"></a>12182 
<a name="l12183"></a>12183   notifyAccountAdded: <span class="keyword">function</span> mb_notifyAccountAdded(account) {
<a name="l12184"></a>12184     var accountWireRep = account.toBridgeWire();
<a name="l12185"></a>12185     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, proxy, slices, wireSplice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, markersSplice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l12186"></a>12186     <span class="comment">// -- notify account slices</span>
<a name="l12187"></a>12187     slices = this._slicesByType[<span class="stringliteral">&#39;accounts&#39;</span>];
<a name="l12188"></a>12188     <span class="keywordflow">for</span> (i = 0; i &lt; slices.length; i++) {
<a name="l12189"></a>12189       proxy = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l12190"></a>12190       proxy.sendSplice(proxy.markers.length, 0, [accountWireRep], <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l12191"></a>12191       proxy.markers.push(account.id);
<a name="l12192"></a>12192     }
<a name="l12193"></a>12193 
<a name="l12194"></a>12194     <span class="comment">// -- notify folder slices</span>
<a name="l12195"></a>12195     accountWireRep = account.toBridgeFolder();
<a name="l12196"></a>12196     slices = this._slicesByType[<span class="stringliteral">&#39;folders&#39;</span>];
<a name="l12197"></a>12197     var startMarker = makeFolderSortString(account, accountWireRep),
<a name="l12198"></a>12198         idxStart;
<a name="l12199"></a>12199     <span class="keywordflow">for</span> (i = 0; i &lt; slices.length; i++) {
<a name="l12200"></a>12200       proxy = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l12201"></a>12201       <span class="comment">// If it&#39;s filtered to an account, it can&#39;t care about us.  (You can&#39;t</span>
<a name="l12202"></a>12202       <span class="comment">// know about an account before it&#39;s created.)</span>
<a name="l12203"></a>12203       <span class="keywordflow">if</span> (proxy.mode === <span class="stringliteral">&#39;account&#39;</span>)
<a name="l12204"></a>12204         <span class="keywordflow">continue</span>;
<a name="l12205"></a>12205 
<a name="l12206"></a>12206       idxStart = bsearchForInsert(proxy.markers, startMarker, strcmp);
<a name="l12207"></a>12207       wireSplice = [accountWireRep];
<a name="l12208"></a>12208       markersSplice = [startMarker];
<a name="l12209"></a>12209       <span class="keywordflow">for</span> (var iFolder = 0; iFolder &lt; account.folders.length; iFolder++) {
<a name="l12210"></a>12210         var folder = account.folders[iFolder],
<a name="l12211"></a>12211             folderMarker = makeFolderSortString(account, folder),
<a name="l12212"></a>12212             idxFolder = bsearchForInsert(markersSplice, folderMarker, strcmp);
<a name="l12213"></a>12213         wireSplice.splice(idxFolder, 0, folder);
<a name="l12214"></a>12214         markersSplice.splice(idxFolder, 0, folderMarker);
<a name="l12215"></a>12215       }
<a name="l12216"></a>12216       proxy.sendSplice(idxStart, 0, wireSplice, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l12217"></a>12217       proxy.markers.splice.apply(proxy.markers,
<a name="l12218"></a>12218                                  [idxStart, 0].concat(markersSplice));
<a name="l12219"></a>12219     }
<a name="l12220"></a>12220   },
<a name="l12221"></a>12221 
<a name="l12228"></a>12228   notifyAccountModified: <span class="keyword">function</span>(account) {
<a name="l12229"></a>12229     var slices = this._slicesByType[<span class="stringliteral">&#39;accounts&#39;</span>],
<a name="l12230"></a>12230         accountWireRep = account.toBridgeWire();
<a name="l12231"></a>12231     <span class="keywordflow">for</span> (var i = 0; i &lt; slices.length; i++) {
<a name="l12232"></a>12232       var proxy = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l12233"></a>12233       var idx = proxy.markers.indexOf(account.id);
<a name="l12234"></a>12234       <span class="keywordflow">if</span> (idx !== -1) {
<a name="l12235"></a>12235         proxy.sendUpdate([idx, accountWireRep]);
<a name="l12236"></a>12236       }
<a name="l12237"></a>12237     }
<a name="l12238"></a>12238   },
<a name="l12239"></a>12239 
<a name="l12240"></a>12240   notifyAccountRemoved: <span class="keyword">function</span>(accountId) {
<a name="l12241"></a>12241     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, proxy, slices;
<a name="l12242"></a>12242     <span class="comment">// -- notify account slices</span>
<a name="l12243"></a>12243     slices = this._slicesByType[<span class="stringliteral">&#39;accounts&#39;</span>];
<a name="l12244"></a>12244     <span class="keywordflow">for</span> (i = 0; i &lt; slices.length; i++) {
<a name="l12245"></a>12245       proxy = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l12246"></a>12246       var idx = proxy.markers.indexOf(accountId);
<a name="l12247"></a>12247       <span class="keywordflow">if</span> (idx !== -1) {
<a name="l12248"></a>12248         proxy.sendSplice(idx, 1, [], <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l12249"></a>12249         proxy.markers.splice(idx, 1);
<a name="l12250"></a>12250       }
<a name="l12251"></a>12251     }
<a name="l12252"></a>12252 
<a name="l12253"></a>12253     <span class="comment">// -- notify folder slices</span>
<a name="l12254"></a>12254     slices = this._slicesByType[<span class="stringliteral">&#39;folders&#39;</span>];
<a name="l12255"></a>12255     var startMarker = accountId + <span class="stringliteral">&#39;!!&#39;</span>,
<a name="l12256"></a>12256         endMarker = accountId + <span class="stringliteral">&#39;!|&#39;</span>;
<a name="l12257"></a>12257     <span class="keywordflow">for</span> (i = 0; i &lt; slices.length; i++) {
<a name="l12258"></a>12258       proxy = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l12259"></a>12259       var idxStart = bsearchForInsert(proxy.markers, startMarker,
<a name="l12260"></a>12260                                       strcmp),
<a name="l12261"></a>12261           idxEnd = bsearchForInsert(proxy.markers, endMarker,
<a name="l12262"></a>12262                                     strcmp);
<a name="l12263"></a>12263       <span class="keywordflow">if</span> (idxEnd !== idxStart) {
<a name="l12264"></a>12264         proxy.sendSplice(idxStart, idxEnd - idxStart, [], <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l12265"></a>12265         proxy.markers.splice(idxStart, idxEnd - idxStart);
<a name="l12266"></a>12266       }
<a name="l12267"></a>12267     }
<a name="l12268"></a>12268   },
<a name="l12269"></a>12269 
<a name="l12270"></a>12270   _cmd_viewSenderIdentities: <span class="keyword">function</span> mb__cmd_viewSenderIdentities(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12271"></a>12271     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] =
<a name="l12272"></a>12272           <span class="keyword">new</span> SliceBridgeProxy(<span class="keyword">this</span>, identities, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12273"></a>12273     this._slicesByType[<span class="stringliteral">&#39;identities&#39;</span>].push(proxy);
<a name="l12274"></a>12274     var wireReps = this.universe.identities;
<a name="l12275"></a>12275     <span class="comment">// send all the identities in one go.</span>
<a name="l12276"></a>12276     proxy.sendSplice(0, 0, wireReps, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l12277"></a>12277   },
<a name="l12278"></a>12278 
<a name="l12279"></a>12279   _cmd_requestBodies: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12280"></a>12280     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l12281"></a>12281     this.universe.downloadBodies(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messages, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.options, <span class="keyword">function</span>() {
<a name="l12282"></a>12282       <span class="keyword">self</span>.__sendMessage({
<a name="l12283"></a>12283         type: <span class="stringliteral">&#39;requestBodiesComplete&#39;</span>,
<a name="l12284"></a>12284         <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12285"></a>12285         requestId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.requestId
<a name="l12286"></a>12286       });
<a name="l12287"></a>12287     });
<a name="l12288"></a>12288   },
<a name="l12289"></a>12289 
<a name="l12290"></a>12290   notifyFolderAdded: <span class="keyword">function</span>(account, folderMeta) {
<a name="l12291"></a>12291     var newMarker = makeFolderSortString(account, folderMeta);
<a name="l12292"></a>12292 
<a name="l12293"></a>12293     var slices = this._slicesByType[<span class="stringliteral">&#39;folders&#39;</span>];
<a name="l12294"></a>12294     <span class="keywordflow">for</span> (var i = 0; i &lt; slices.length; i++) {
<a name="l12295"></a>12295       var proxy = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l12296"></a>12296       var idx = bsearchForInsert(proxy.markers, newMarker, strcmp);
<a name="l12297"></a>12297       proxy.sendSplice(idx, 0, [folderMeta], <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l12298"></a>12298       proxy.markers.splice(idx, 0, newMarker);
<a name="l12299"></a>12299     }
<a name="l12300"></a>12300   },
<a name="l12301"></a>12301 
<a name="l12302"></a>12302   notifyFolderModified: <span class="keyword">function</span>(account, folderMeta) {
<a name="l12303"></a>12303     var <a class="code" href="../../d7/d27/jpeglib_8h.html#a55fc502015142062735ebfd18c825354">marker</a> = makeFolderSortString(account, folderMeta);
<a name="l12304"></a>12304 
<a name="l12305"></a>12305     var slices = this._slicesByType[<span class="stringliteral">&#39;folders&#39;</span>];
<a name="l12306"></a>12306     <span class="keywordflow">for</span> (var i = 0; i &lt; slices.length; i++) {
<a name="l12307"></a>12307       var proxy = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l12308"></a>12308 
<a name="l12309"></a>12309       var idx = bsearchMaybeExists(proxy.markers, marker, strcmp);
<a name="l12310"></a>12310       <span class="keywordflow">if</span> (idx === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l12311"></a>12311         <span class="keywordflow">continue</span>;
<a name="l12312"></a>12312       proxy.sendUpdate([idx, folderMeta]);
<a name="l12313"></a>12313     }
<a name="l12314"></a>12314   },
<a name="l12315"></a>12315 
<a name="l12316"></a>12316   notifyFolderRemoved: <span class="keyword">function</span>(account, folderMeta) {
<a name="l12317"></a>12317     var marker = makeFolderSortString(account, folderMeta);
<a name="l12318"></a>12318 
<a name="l12319"></a>12319     var slices = this._slicesByType[<span class="stringliteral">&#39;folders&#39;</span>];
<a name="l12320"></a>12320     <span class="keywordflow">for</span> (var i = 0; i &lt; slices.length; i++) {
<a name="l12321"></a>12321       var proxy = slices[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l12322"></a>12322 
<a name="l12323"></a>12323       var idx = bsearchMaybeExists(proxy.markers, marker, strcmp);
<a name="l12324"></a>12324       <span class="keywordflow">if</span> (idx === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l12325"></a>12325         <span class="keywordflow">continue</span>;
<a name="l12326"></a>12326       proxy.sendSplice(idx, 1, [], <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l12327"></a>12327       proxy.markers.splice(idx, 1);
<a name="l12328"></a>12328     }
<a name="l12329"></a>12329   },
<a name="l12330"></a>12330 
<a name="l12343"></a>12343   notifyBodyModified: <span class="keyword">function</span>(suid, detail, body) {
<a name="l12344"></a>12344     var handles = this._observedBodies[suid];
<a name="l12345"></a>12345     var defaultHandler = this.__sendMessage;
<a name="l12346"></a>12346 
<a name="l12347"></a>12347     <span class="keywordflow">if</span> (handles) {
<a name="l12348"></a>12348       <span class="keywordflow">for</span> (var <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a> in handles) {
<a name="l12349"></a>12349         <span class="comment">// the suid may have an existing handler which captures the output of</span>
<a name="l12350"></a>12350         <span class="comment">// the notification instead of dispatching here... This allows us to</span>
<a name="l12351"></a>12351         <span class="comment">// aggregate pending notifications while fetching the bodies so updates</span>
<a name="l12352"></a>12352         <span class="comment">// never come before the actual body.</span>
<a name="l12353"></a>12353         var <a class="code" href="../../d3/d4a/mock__recipients_8js.html#a1c233303d7d7013c8dc2390a2f264b43">emit</a> = handles[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] || defaultHandler;
<a name="l12354"></a>12354 
<a name="l12355"></a>12355         emit.call(<span class="keyword">this</span>, {
<a name="l12356"></a>12356           type: <span class="stringliteral">&#39;bodyModified&#39;</span>,
<a name="l12357"></a>12357           <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l12358"></a>12358           bodyInfo: body,
<a name="l12359"></a>12359           detail: detail
<a name="l12360"></a>12360         });
<a name="l12361"></a>12361       }
<a name="l12362"></a>12362     }
<a name="l12363"></a>12363   },
<a name="l12364"></a>12364 
<a name="l12365"></a>12365   _cmd_viewFolders: <span class="keyword">function</span> mb__cmd_viewFolders(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12366"></a>12366     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] =
<a name="l12367"></a>12367           <span class="keyword">new</span> SliceBridgeProxy(<span class="keyword">this</span>, <span class="stringliteral">&#39;folders&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12368"></a>12368     this._slicesByType[<span class="stringliteral">&#39;folders&#39;</span>].push(proxy);
<a name="l12369"></a>12369     proxy.mode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mode;
<a name="l12370"></a>12370     proxy.argument = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.argument;
<a name="l12371"></a>12371     var markers = proxy.markers = [];
<a name="l12372"></a>12372 
<a name="l12373"></a>12373     var wireReps = [];
<a name="l12374"></a>12374 
<a name="l12375"></a>12375     <span class="keyword">function</span> pushAccountFolders(acct) {
<a name="l12376"></a>12376       <span class="keywordflow">for</span> (var iFolder = 0; iFolder &lt; acct.folders.length; iFolder++) {
<a name="l12377"></a>12377         var folder = acct.folders[iFolder];
<a name="l12378"></a>12378         var newMarker = makeFolderSortString(acct, folder);
<a name="l12379"></a>12379         var idx = bsearchForInsert(markers, newMarker, strcmp);
<a name="l12380"></a>12380         wireReps.splice(idx, 0, folder);
<a name="l12381"></a>12381         markers.splice(idx, 0, newMarker);
<a name="l12382"></a>12382       }
<a name="l12383"></a>12383     }
<a name="l12384"></a>12384 
<a name="l12385"></a>12385     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mode === <span class="stringliteral">&#39;account&#39;</span>) {
<a name="l12386"></a>12386       pushAccountFolders(
<a name="l12387"></a>12387         this.universe.getAccountForAccountId(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.argument));
<a name="l12388"></a>12388     }
<a name="l12389"></a>12389     <span class="keywordflow">else</span> {
<a name="l12390"></a>12390       var accounts = this.universe.accounts.concat();
<a name="l12391"></a>12391 
<a name="l12392"></a>12392       <span class="comment">// sort accounts by their id&#39;s</span>
<a name="l12393"></a>12393       accounts.sort(<span class="keyword">function</span> (a, b) {
<a name="l12394"></a>12394         <span class="keywordflow">return</span> a.id.localeCompare(b.id);
<a name="l12395"></a>12395       });
<a name="l12396"></a>12396 
<a name="l12397"></a>12397       <span class="keywordflow">for</span> (var iAcct = 0; iAcct &lt; accounts.length; iAcct++) {
<a name="l12398"></a>12398         var acct = accounts[iAcct], acctBridgeRep = acct.toBridgeFolder(),
<a name="l12399"></a>12399             acctMarker = makeFolderSortString(acct, acctBridgeRep),
<a name="l12400"></a>12400             idxAcct = bsearchForInsert(markers, acctMarker, strcmp);
<a name="l12401"></a>12401 
<a name="l12402"></a>12402         wireReps.splice(idxAcct, 0, acctBridgeRep);
<a name="l12403"></a>12403         markers.splice(idxAcct, 0, acctMarker);
<a name="l12404"></a>12404         pushAccountFolders(acct);
<a name="l12405"></a>12405       }
<a name="l12406"></a>12406     }
<a name="l12407"></a>12407     proxy.sendSplice(0, 0, wireReps, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l12408"></a>12408   },
<a name="l12409"></a>12409 
<a name="l12410"></a>12410   _cmd_createFolder: <span class="keyword">function</span> mb__cmd_createFolder(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12411"></a>12411     this.universe.createFolder(
<a name="l12412"></a>12412       <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.accountId,
<a name="l12413"></a>12413       <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.parentFolderId,
<a name="l12414"></a>12414       <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.containOnlyOtherFolders);
<a name="l12415"></a>12415   },
<a name="l12416"></a>12416 
<a name="l12417"></a>12417   _cmd_viewFolderMessages: <span class="keyword">function</span> mb__cmd_viewFolderMessages(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12418"></a>12418     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] =
<a name="l12419"></a>12419           <span class="keyword">new</span> SliceBridgeProxy(<span class="keyword">this</span>, <span class="stringliteral">&#39;headers&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12420"></a>12420     this._slicesByType[<span class="stringliteral">&#39;headers&#39;</span>].push(proxy);
<a name="l12421"></a>12421 
<a name="l12422"></a>12422     var account = this.universe.getAccountForFolderId(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.folderId);
<a name="l12423"></a>12423     account.sliceFolderMessages(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.folderId, proxy);
<a name="l12424"></a>12424   },
<a name="l12425"></a>12425 
<a name="l12426"></a>12426   _cmd_searchFolderMessages: <span class="keyword">function</span> mb__cmd_searchFolderMessages(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12427"></a>12427     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] =
<a name="l12428"></a>12428           <span class="keyword">new</span> SliceBridgeProxy(<span class="keyword">this</span>, <span class="stringliteral">&#39;matchedHeaders&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12429"></a>12429     this._slicesByType[<span class="stringliteral">&#39;matchedHeaders&#39;</span>].push(proxy);
<a name="l12430"></a>12430     var account = this.universe.getAccountForFolderId(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.folderId);
<a name="l12431"></a>12431     account.searchFolderMessages(
<a name="l12432"></a>12432       <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.folderId, proxy, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.phrase, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.whatToSearch);
<a name="l12433"></a>12433   },
<a name="l12434"></a>12434 
<a name="l12435"></a>12435   _cmd_refreshHeaders: <span class="keyword">function</span> mb__cmd_refreshHeaders(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12436"></a>12436     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12437"></a>12437     <span class="keywordflow">if</span> (!proxy) {
<a name="l12438"></a>12438       this._LOG.badSliceHandle(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12439"></a>12439       <span class="keywordflow">return</span>;
<a name="l12440"></a>12440     }
<a name="l12441"></a>12441 
<a name="l12442"></a>12442     <span class="keywordflow">if</span> (proxy.__listener)
<a name="l12443"></a>12443       proxy.__listener.refresh();
<a name="l12444"></a>12444   },
<a name="l12445"></a>12445 
<a name="l12446"></a>12446   _cmd_growSlice: <span class="keyword">function</span> mb__cmd_growSlice(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12447"></a>12447     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12448"></a>12448     <span class="keywordflow">if</span> (!proxy) {
<a name="l12449"></a>12449       this._LOG.badSliceHandle(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12450"></a>12450       <span class="keywordflow">return</span>;
<a name="l12451"></a>12451     }
<a name="l12452"></a>12452 
<a name="l12453"></a>12453     <span class="keywordflow">if</span> (proxy.__listener)
<a name="l12454"></a>12454       proxy.__listener.reqGrow(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.dirMagnitude, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.userRequestsGrowth);
<a name="l12455"></a>12455   },
<a name="l12456"></a>12456 
<a name="l12457"></a>12457   _cmd_shrinkSlice: <span class="keyword">function</span> mb__cmd_shrinkSlice(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12458"></a>12458     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12459"></a>12459     <span class="keywordflow">if</span> (!proxy) {
<a name="l12460"></a>12460       this._LOG.badSliceHandle(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12461"></a>12461       <span class="keywordflow">return</span>;
<a name="l12462"></a>12462     }
<a name="l12463"></a>12463 
<a name="l12464"></a>12464     <span class="keywordflow">if</span> (proxy.__listener)
<a name="l12465"></a>12465       proxy.__listener.reqNoteRanges(
<a name="l12466"></a>12466         <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.firstIndex, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.firstSuid, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.lastIndex, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.lastSuid);
<a name="l12467"></a>12467   },
<a name="l12468"></a>12468 
<a name="l12469"></a>12469   _cmd_killSlice: <span class="keyword">function</span> mb__cmd_killSlice(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12470"></a>12470     var proxy = this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12471"></a>12471     <span class="keywordflow">if</span> (!proxy) {
<a name="l12472"></a>12472       this._LOG.badSliceHandle(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle);
<a name="l12473"></a>12473       <span class="keywordflow">return</span>;
<a name="l12474"></a>12474     }
<a name="l12475"></a>12475 
<a name="l12476"></a>12476     <span class="keyword">delete</span> this._slices[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12477"></a>12477     var proxies = this._slicesByType[proxy._ns],
<a name="l12478"></a>12478         idx = proxies.indexOf(proxy);
<a name="l12479"></a>12479     proxies.splice(idx, 1);
<a name="l12480"></a>12480     proxy.die();
<a name="l12481"></a>12481 
<a name="l12482"></a>12482     this.__sendMessage({
<a name="l12483"></a>12483       type: <span class="stringliteral">&#39;sliceDead&#39;</span>,
<a name="l12484"></a>12484       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12485"></a>12485     });
<a name="l12486"></a>12486   },
<a name="l12487"></a>12487 
<a name="l12488"></a>12488   _cmd_getBody: <span class="keyword">function</span> mb__cmd_getBody(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12489"></a>12489     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l12490"></a>12490     <span class="comment">// map the message id to the folder storage</span>
<a name="l12491"></a>12491     var folderStorage = this.universe.getFolderStorageForMessageSuid(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid);
<a name="l12492"></a>12492 
<a name="l12493"></a>12493     <span class="comment">// when requesting the body we also create a observer to notify the client</span>
<a name="l12494"></a>12494     <span class="comment">// of events... We never want to send the updates before fetching the body</span>
<a name="l12495"></a>12495     <span class="comment">// so we buffer them here with a temporary handler.</span>
<a name="l12496"></a>12496     var pendingUpdates = [];
<a name="l12497"></a>12497 
<a name="l12498"></a>12498     var catchPending = <span class="keyword">function</span> catchPending(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12499"></a>12499       pendingUpdates.push(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>);
<a name="l12500"></a>12500     };
<a name="l12501"></a>12501 
<a name="l12502"></a>12502     <span class="keywordflow">if</span> (!this._observedBodies[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid])
<a name="l12503"></a>12503       this._observedBodies[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid] = {};
<a name="l12504"></a>12504 
<a name="l12505"></a>12505     this._observedBodies[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid][<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] = catchPending;
<a name="l12506"></a>12506 
<a name="l12507"></a>12507     var handler = <span class="keyword">function</span>(bodyInfo) {
<a name="l12508"></a>12508       <span class="keyword">self</span>.__sendMessage({
<a name="l12509"></a>12509         type: <span class="stringliteral">&#39;gotBody&#39;</span>,
<a name="l12510"></a>12510         <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12511"></a>12511         bodyInfo: bodyInfo
<a name="l12512"></a>12512       });
<a name="l12513"></a>12513 
<a name="l12514"></a>12514       <span class="comment">// if all body reps where requested we verify that all are present</span>
<a name="l12515"></a>12515       <span class="comment">// otherwise we begin the request for more body reps.</span>
<a name="l12516"></a>12516       <span class="keywordflow">if</span> (
<a name="l12517"></a>12517         <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.downloadBodyReps &amp;&amp;
<a name="l12518"></a>12518         !folderStorage.messageBodyRepsDownloaded(bodyInfo)
<a name="l12519"></a>12519       ) {
<a name="l12520"></a>12520 
<a name="l12521"></a>12521         <span class="keyword">self</span>.universe.downloadMessageBodyReps(
<a name="l12522"></a>12522           <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid,
<a name="l12523"></a>12523           <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.date,
<a name="l12524"></a>12524           <span class="keyword">function</span>() { <span class="comment">/* we don&#39;t care it will send update events */</span> }
<a name="l12525"></a>12525         );
<a name="l12526"></a>12526       }
<a name="l12527"></a>12527 
<a name="l12528"></a>12528       <span class="comment">// dispatch pending updates...</span>
<a name="l12529"></a>12529       pendingUpdates.forEach(<span class="keyword">self</span>.__sendMessage, <span class="keyword">self</span>);
<a name="l12530"></a>12530       pendingUpdates = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l12531"></a>12531 
<a name="l12532"></a>12532       <span class="comment">// revert to default handler. Note! this is intentionally</span>
<a name="l12533"></a>12533       <span class="comment">// set to null and not deleted if deleted the observer is removed.</span>
<a name="l12534"></a>12534       <span class="keyword">self</span>._observedBodies[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid][<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l12535"></a>12535     };
<a name="l12536"></a>12536 
<a name="l12537"></a>12537     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.withBodyReps)
<a name="l12538"></a>12538       folderStorage.getMessageBodyWithReps(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.date, handler);
<a name="l12539"></a>12539     <span class="keywordflow">else</span>
<a name="l12540"></a>12540       folderStorage.getMessageBody(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.date, handler);
<a name="l12541"></a>12541   },
<a name="l12542"></a>12542 
<a name="l12543"></a>12543   _cmd_killBody: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12544"></a>12544     var handles = this._observedBodies[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.id];
<a name="l12545"></a>12545     <span class="keywordflow">if</span> (handles) {
<a name="l12546"></a>12546       <span class="keyword">delete</span> handles[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12547"></a>12547 
<a name="l12548"></a>12548       var purgeHandles = <span class="keyword">true</span>;
<a name="l12549"></a>12549       <span class="keywordflow">for</span> (var key in handles) {
<a name="l12550"></a>12550         purgeHandles = <span class="keyword">false</span>;
<a name="l12551"></a>12551         <span class="keywordflow">break</span>;
<a name="l12552"></a>12552       }
<a name="l12553"></a>12553 
<a name="l12554"></a>12554       <span class="keywordflow">if</span> (purgeHandles) {
<a name="l12555"></a>12555         <span class="keyword">delete</span> this._observedBodies[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.id];
<a name="l12556"></a>12556       }
<a name="l12557"></a>12557     }
<a name="l12558"></a>12558 
<a name="l12559"></a>12559     this.__sendMessage({
<a name="l12560"></a>12560       type: <span class="stringliteral">&#39;bodyDead&#39;</span>,
<a name="l12561"></a>12561       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle
<a name="l12562"></a>12562     });
<a name="l12563"></a>12563   },
<a name="l12564"></a>12564 
<a name="l12565"></a>12565   _cmd_downloadAttachments: <span class="keyword">function</span> mb__cmd__downloadAttachments(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12566"></a>12566     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l12567"></a>12567     this.universe.downloadMessageAttachments(
<a name="l12568"></a>12568       <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.date, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.relPartIndices, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.attachmentIndices,
<a name="l12569"></a>12569       <span class="keyword">function</span>(err, bodyInfo) {
<a name="l12570"></a>12570         <span class="keyword">self</span>.__sendMessage({
<a name="l12571"></a>12571           type: <span class="stringliteral">&#39;downloadedAttachments&#39;</span>,
<a name="l12572"></a>12572           <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12573"></a>12573           bodyInfo: err ? <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> : bodyInfo
<a name="l12574"></a>12574         });
<a name="l12575"></a>12575       });
<a name="l12576"></a>12576   },
<a name="l12577"></a>12577 
<a name="l12579"></a>12579   <span class="comment">// Message Mutation</span>
<a name="l12580"></a>12580   <span class="comment">//</span>
<a name="l12581"></a>12581   <span class="comment">// All mutations are told to the universe which breaks the modifications up on</span>
<a name="l12582"></a>12582   <span class="comment">// a per-account basis.</span>
<a name="l12583"></a>12583 
<a name="l12584"></a>12584   _cmd_modifyMessageTags: <span class="keyword">function</span> mb__cmd_modifyMessageTags(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12585"></a>12585     <span class="comment">// XXXYYY</span>
<a name="l12586"></a>12586 
<a name="l12587"></a>12587     <span class="comment">// - The mutations are written to the database for persistence (in case</span>
<a name="l12588"></a>12588     <span class="comment">//   we fail to make the change in a timely fashion) and so that we can</span>
<a name="l12589"></a>12589     <span class="comment">//   know enough to reverse the operation.</span>
<a name="l12590"></a>12590     <span class="comment">// - Speculative changes are made to the headers in the database locally.</span>
<a name="l12591"></a>12591 
<a name="l12592"></a>12592     var longtermIds = this.universe.modifyMessageTags(
<a name="l12593"></a>12593       <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.opcode, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messages, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.addTags, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.removeTags);
<a name="l12594"></a>12594     this.__sendMessage({
<a name="l12595"></a>12595       type: <span class="stringliteral">&#39;mutationConfirmed&#39;</span>,
<a name="l12596"></a>12596       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12597"></a>12597       longtermIds: longtermIds,
<a name="l12598"></a>12598     });
<a name="l12599"></a>12599   },
<a name="l12600"></a>12600 
<a name="l12601"></a>12601   _cmd_deleteMessages: <span class="keyword">function</span> mb__cmd_deleteMessages(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12602"></a>12602     var longtermIds = this.universe.deleteMessages(
<a name="l12603"></a>12603       <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messages);
<a name="l12604"></a>12604     this.__sendMessage({
<a name="l12605"></a>12605       type: <span class="stringliteral">&#39;mutationConfirmed&#39;</span>,
<a name="l12606"></a>12606       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12607"></a>12607       longtermIds: longtermIds,
<a name="l12608"></a>12608     });
<a name="l12609"></a>12609   },
<a name="l12610"></a>12610 
<a name="l12611"></a>12611   _cmd_moveMessages: <span class="keyword">function</span> mb__cmd_moveMessages(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12612"></a>12612     var longtermIds = this.universe.moveMessages(
<a name="l12613"></a>12613       <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messages, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.targetFolder);
<a name="l12614"></a>12614     this.__sendMessage({
<a name="l12615"></a>12615       type: <span class="stringliteral">&#39;mutationConfirmed&#39;</span>,
<a name="l12616"></a>12616       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12617"></a>12617       longtermIds: longtermIds,
<a name="l12618"></a>12618     });
<a name="l12619"></a>12619   },
<a name="l12620"></a>12620 
<a name="l12621"></a>12621   _cmd_undo: <span class="keyword">function</span> mb__cmd_undo(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12622"></a>12622     this.universe.undoMutation(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.longtermIds);
<a name="l12623"></a>12623   },
<a name="l12624"></a>12624 
<a name="l12626"></a>12626   <span class="comment">// Composition</span>
<a name="l12627"></a>12627 
<a name="l12628"></a>12628 
<a name="l12629"></a>12629   _cmd_beginCompose: <span class="keyword">function</span> mb__cmd_beginCompose(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12630"></a>12630     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;./composer&#39;</span>], <span class="keyword">function</span> ($composer) {
<a name="l12631"></a>12631       var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a> = this._pendingRequests[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] = {
<a name="l12632"></a>12632         type: <span class="stringliteral">&#39;compose&#39;</span>,
<a name="l12633"></a>12633         active: <span class="stringliteral">&#39;begin&#39;</span>,
<a name="l12634"></a>12634         persistedNamer: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12635"></a>12635         <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">false</span>
<a name="l12636"></a>12636       };
<a name="l12637"></a>12637 
<a name="l12638"></a>12638       <span class="comment">// - figure out the identity to use</span>
<a name="l12639"></a>12639       var account, <a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>, folderId;
<a name="l12640"></a>12640       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mode === <span class="stringliteral">&#39;new&#39;</span> &amp;&amp; <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.submode === <span class="stringliteral">&#39;folder&#39;</span>)
<a name="l12641"></a>12641         account = <span class="keyword">this</span>.universe.getAccountForFolderId(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refSuid);
<a name="l12642"></a>12642       <span class="keywordflow">else</span>
<a name="l12643"></a>12643         account = this.universe.getAccountForMessageSuid(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refSuid);
<a name="l12644"></a>12644 
<a name="l12645"></a>12645       identity = account.identities[0];
<a name="l12646"></a>12646 
<a name="l12647"></a>12647       <span class="comment">// not doing something that needs a body just return an empty composer.</span>
<a name="l12648"></a>12648       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mode !== <span class="stringliteral">&#39;reply&#39;</span> &amp;&amp; <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mode !== <span class="stringliteral">&#39;forward&#39;</span>) {
<a name="l12649"></a>12649         <span class="keywordflow">return</span> this.__sendMessage({
<a name="l12650"></a>12650           type: <span class="stringliteral">&#39;composeBegun&#39;</span>,
<a name="l12651"></a>12651           <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12652"></a>12652           error: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12653"></a>12653           identity: <a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>,
<a name="l12654"></a>12654           subject: <span class="stringliteral">&#39;&#39;</span>,
<a name="l12655"></a>12655           body: { <a class="code" href="../../dd/dfa/classtext.html">text</a>: <span class="stringliteral">&#39;&#39;</span>, html: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> },
<a name="l12656"></a>12656           <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>: [],
<a name="l12657"></a>12657           <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>: [],
<a name="l12658"></a>12658           bcc: [],
<a name="l12659"></a>12659           references: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12660"></a>12660           attachments: [],
<a name="l12661"></a>12661         });
<a name="l12662"></a>12662       }
<a name="l12663"></a>12663 
<a name="l12664"></a>12664       var folderStorage =
<a name="l12665"></a>12665         this.universe.getFolderStorageForMessageSuid(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refSuid);
<a name="l12666"></a>12666 
<a name="l12667"></a>12667       var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l12668"></a>12668       folderStorage.getMessage(
<a name="l12669"></a>12669         <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refSuid, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refDate, { withBodyReps: <span class="keyword">true</span> }, <span class="keyword">function</span>(res) {
<a name="l12670"></a>12670 
<a name="l12671"></a>12671         <span class="keywordflow">if</span> (!res) {
<a name="l12672"></a>12672           <span class="comment">// cannot compose a reply/fwd message without a header/body</span>
<a name="l12673"></a>12673           <span class="keywordflow">return</span> <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(
<a name="l12674"></a>12674             <span class="stringliteral">&#39;Cannot compose message missing header/body: &#39;</span>,
<a name="l12675"></a>12675             <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.suid
<a name="l12676"></a>12676           );
<a name="l12677"></a>12677         }
<a name="l12678"></a>12678 
<a name="l12679"></a>12679         var header = res.header;
<a name="l12680"></a>12680         var bodyInfo = res.body;
<a name="l12681"></a>12681 
<a name="l12682"></a>12682         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.mode === <span class="stringliteral">&#39;reply&#39;</span>) {
<a name="l12683"></a>12683           var rTo, rCc, rBcc;
<a name="l12684"></a>12684           <span class="comment">// clobber the sender&#39;s e-mail with the reply-to</span>
<a name="l12685"></a>12685           var effectiveAuthor = {
<a name="l12686"></a>12686             <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refAuthor.name,
<a name="l12687"></a>12687             <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: (header.replyTo &amp;&amp; header.replyTo.address) ||
<a name="l12688"></a>12688                      <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refAuthor.address,
<a name="l12689"></a>12689           };
<a name="l12690"></a>12690           <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.submode) {
<a name="l12691"></a>12691             <span class="keywordflow">case</span> <span class="stringliteral">&#39;list&#39;</span>:
<a name="l12692"></a>12692               <span class="comment">// XXX we can&#39;t do this without headers we&#39;re not retrieving,</span>
<a name="l12693"></a>12693               <span class="comment">// fall through for now.</span>
<a name="l12694"></a>12694             <span class="keywordflow">case</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>:
<a name="l12695"></a>12695             <span class="keywordflow">case</span> <span class="stringliteral">&#39;sender&#39;</span>:
<a name="l12696"></a>12696               rTo = [effectiveAuthor];
<a name="l12697"></a>12697               rCc = rBcc = [];
<a name="l12698"></a>12698               <span class="keywordflow">break</span>;
<a name="l12699"></a>12699             <span class="keywordflow">case</span> <span class="stringliteral">&#39;all&#39;</span>:
<a name="l12700"></a>12700               <span class="comment">// No need to change the lists if the author is already on the</span>
<a name="l12701"></a>12701               <span class="comment">// reply lists.</span>
<a name="l12702"></a>12702               <span class="comment">//</span>
<a name="l12703"></a>12703               <span class="comment">// nb: Our logic here is fairly simple; Thunderbird&#39;s</span>
<a name="l12704"></a>12704               <span class="comment">// nsMsgCompose.cpp does a lot of checking that we should</span>
<a name="l12705"></a>12705               <span class="comment">// audit, although much of it could just be related to its</span>
<a name="l12706"></a>12706               <span class="comment">// much more extensive identity support.</span>
<a name="l12707"></a>12707               <span class="keywordflow">if</span> (checkIfAddressListContainsAddress(header.to,
<a name="l12708"></a>12708                                                     effectiveAuthor) ||
<a name="l12709"></a>12709                   checkIfAddressListContainsAddress(header.cc,
<a name="l12710"></a>12710                                                     effectiveAuthor)) {
<a name="l12711"></a>12711                 rTo = header.to;
<a name="l12712"></a>12712               }
<a name="l12713"></a>12713               <span class="comment">// add the author as the first &#39;to&#39; person</span>
<a name="l12714"></a>12714               <span class="keywordflow">else</span> {
<a name="l12715"></a>12715                 <span class="keywordflow">if</span> (header.to &amp;&amp; header.to.length)
<a name="l12716"></a>12716                   rTo = [effectiveAuthor].concat(header.to);
<a name="l12717"></a>12717                 <span class="keywordflow">else</span>
<a name="l12718"></a>12718                   rTo = [effectiveAuthor];
<a name="l12719"></a>12719               }
<a name="l12720"></a>12720               rCc = header.cc;
<a name="l12721"></a>12721               rBcc = header.bcc;
<a name="l12722"></a>12722               <span class="keywordflow">break</span>;
<a name="l12723"></a>12723           }
<a name="l12724"></a>12724 
<a name="l12725"></a>12725           var referencesStr;
<a name="l12726"></a>12726           <span class="keywordflow">if</span> (bodyInfo.references) {
<a name="l12727"></a>12727             referencesStr = bodyInfo.references.concat([<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refGuid])
<a name="l12728"></a>12728                               .map(<span class="keyword">function</span>(x) { <span class="keywordflow">return</span> <span class="charliteral">&#39;&lt;&#39;</span> + x + <span class="charliteral">&#39;&gt;&#39;</span>; })
<a name="l12729"></a>12729                               .<a class="code" href="../../de/d11/path_8js.html#a9c4b06c29cf28f47c4f54ed4e30c85b3">join</a>(<span class="charliteral">&#39; &#39;</span>);
<a name="l12730"></a>12730           }
<a name="l12731"></a>12731           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refGuid) {
<a name="l12732"></a>12732             referencesStr = <span class="charliteral">&#39;&lt;&#39;</span> + <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refGuid + <span class="charliteral">&#39;&gt;&#39;</span>;
<a name="l12733"></a>12733           }
<a name="l12734"></a>12734           <span class="comment">// ActiveSync does not thread so good</span>
<a name="l12735"></a>12735           <span class="keywordflow">else</span> {
<a name="l12736"></a>12736             referencesStr = <span class="stringliteral">&#39;&#39;</span>;
<a name="l12737"></a>12737           }
<a name="l12738"></a>12738           req.active = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l12739"></a>12739           <span class="keyword">self</span>.__sendMessage({
<a name="l12740"></a>12740             type: <span class="stringliteral">&#39;composeBegun&#39;</span>,
<a name="l12741"></a>12741             <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12742"></a>12742             error: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12743"></a>12743             identity: <a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>,
<a name="l12744"></a>12744             subject: $composer.mailchew
<a name="l12745"></a>12745                        .generateReplySubject(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refSubject),
<a name="l12746"></a>12746             <span class="comment">// blank lines at the top are baked in</span>
<a name="l12747"></a>12747             body: $composer.mailchew.generateReplyBody(
<a name="l12748"></a>12748                     bodyInfo.bodyReps, effectiveAuthor, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refDate,
<a name="l12749"></a>12749                     identity, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refGuid),
<a name="l12750"></a>12750             <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>: rTo,
<a name="l12751"></a>12751             <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>: rCc,
<a name="l12752"></a>12752             bcc: rBcc,
<a name="l12753"></a>12753             referencesStr: referencesStr,
<a name="l12754"></a>12754             attachments: [],
<a name="l12755"></a>12755           });
<a name="l12756"></a>12756         }
<a name="l12757"></a>12757         <span class="keywordflow">else</span> {
<a name="l12758"></a>12758           req.active = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l12759"></a>12759           <span class="keyword">self</span>.__sendMessage({
<a name="l12760"></a>12760             type: <span class="stringliteral">&#39;composeBegun&#39;</span>,
<a name="l12761"></a>12761             <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12762"></a>12762             error: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12763"></a>12763             identity: <a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>,
<a name="l12764"></a>12764             subject: $composer.mailchew
<a name="l12765"></a>12765                        .generateForwardSubject(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refSubject),
<a name="l12766"></a>12766             <span class="comment">// blank lines at the top are baked in by the func</span>
<a name="l12767"></a>12767             body: $composer.mailchew.generateForwardMessage(
<a name="l12768"></a>12768                     <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refAuthor, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refDate, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.refSubject,
<a name="l12769"></a>12769                     header, bodyInfo, identity),
<a name="l12770"></a>12770             <span class="comment">// forwards have no assumed envelope information</span>
<a name="l12771"></a>12771             <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>: [],
<a name="l12772"></a>12772             <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>: [],
<a name="l12773"></a>12773             bcc: [],
<a name="l12774"></a>12774             <span class="comment">// XXX imitate Thunderbird current or previous behaviour; I</span>
<a name="l12775"></a>12775             <span class="comment">// think we ended up linking forwards into the conversation</span>
<a name="l12776"></a>12776             <span class="comment">// they came from, but with an extra header so that it was</span>
<a name="l12777"></a>12777             <span class="comment">// possible to detect it was a forward.</span>
<a name="l12778"></a>12778             references: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12779"></a>12779             attachments: [],
<a name="l12780"></a>12780           });
<a name="l12781"></a>12781         }
<a name="l12782"></a>12782       });
<a name="l12783"></a>12783     }.bind(<span class="keyword">this</span>));
<a name="l12784"></a>12784   },
<a name="l12785"></a>12785 
<a name="l12786"></a>12786   _cmd_resumeCompose: <span class="keyword">function</span> mb__cmd_resumeCompose(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12787"></a>12787     var req = this._pendingRequests[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle] = {
<a name="l12788"></a>12788       type: <span class="stringliteral">&#39;compose&#39;</span>,
<a name="l12789"></a>12789       active: <span class="stringliteral">&#39;resume&#39;</span>,
<a name="l12790"></a>12790       persistedNamer: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messageNamer,
<a name="l12791"></a>12791       <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">false</span>
<a name="l12792"></a>12792     };
<a name="l12793"></a>12793 
<a name="l12794"></a>12794     <span class="comment">// NB: We are not acquiring the folder mutex here because</span>
<a name="l12795"></a>12795     var account = this.universe.getAccountForMessageSuid(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messageNamer.suid);
<a name="l12796"></a>12796     var folderStorage = this.universe.getFolderStorageForMessageSuid(
<a name="l12797"></a>12797                           <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messageNamer.suid);
<a name="l12798"></a>12798     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l12799"></a>12799     folderStorage.runMutexed(<span class="stringliteral">&#39;resumeCompose&#39;</span>, <span class="keyword">function</span>(callWhenDone) {
<a name="l12800"></a>12800       <span class="keyword">function</span> fail() {
<a name="l12801"></a>12801         <span class="keyword">self</span>.__sendMessage({
<a name="l12802"></a>12802           type: <span class="stringliteral">&#39;composeBegun&#39;</span>,
<a name="l12803"></a>12803           <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12804"></a>12804           error: <span class="stringliteral">&#39;no-message&#39;</span>
<a name="l12805"></a>12805         });
<a name="l12806"></a>12806         callWhenDone();
<a name="l12807"></a>12807       }
<a name="l12808"></a>12808       folderStorage.getMessage(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messageNamer.suid, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.messageNamer.date,
<a name="l12809"></a>12809                                <span class="keyword">function</span>(res) {
<a name="l12810"></a>12810         <span class="keywordflow">try</span> {
<a name="l12811"></a>12811           <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (!res.header || !res.body) {
<a name="l12812"></a>12812             fail();
<a name="l12813"></a>12813             <span class="keywordflow">return</span>;
<a name="l12814"></a>12814           }
<a name="l12815"></a>12815           var header = res.header, body = res.body;
<a name="l12816"></a>12816 
<a name="l12817"></a>12817           <span class="comment">// -- convert from header/body rep to compose rep</span>
<a name="l12818"></a>12818 
<a name="l12819"></a>12819           var composeBody = {
<a name="l12820"></a>12820             <a class="code" href="../../dd/dfa/classtext.html">text</a>: <span class="stringliteral">&#39;&#39;</span>,
<a name="l12821"></a>12821             html: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12822"></a>12822           };
<a name="l12823"></a>12823 
<a name="l12824"></a>12824           <span class="comment">// Body structure should be guaranteed, but add some checks.</span>
<a name="l12825"></a>12825           <span class="keywordflow">if</span> (body.bodyReps.length &gt;= 1 &amp;&amp;
<a name="l12826"></a>12826               body.bodyReps[0].type === <span class="stringliteral">&#39;plain&#39;</span> &amp;&amp;
<a name="l12827"></a>12827               body.bodyReps[0].content.length === 2 &amp;&amp;
<a name="l12828"></a>12828               body.bodyReps[0].content[0] === 0x1) {
<a name="l12829"></a>12829             composeBody.text = body.bodyReps[0].content[1];
<a name="l12830"></a>12830           }
<a name="l12831"></a>12831           <span class="comment">// HTML is optional, but if present, should satisfy our guard</span>
<a name="l12832"></a>12832           <span class="keywordflow">if</span> (body.bodyReps.length == 2 &amp;&amp;
<a name="l12833"></a>12833               body.bodyReps[1].type === <span class="stringliteral">&#39;html&#39;</span>) {
<a name="l12834"></a>12834             composeBody.html = body.bodyReps[1].content;
<a name="l12835"></a>12835           }
<a name="l12836"></a>12836 
<a name="l12837"></a>12837           var attachments = [];
<a name="l12838"></a>12838           body.attachments.forEach(<span class="keyword">function</span>(att) {
<a name="l12839"></a>12839             attachments.push({
<a name="l12840"></a>12840               <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: att.name,
<a name="l12841"></a>12841               blob: att.file
<a name="l12842"></a>12842             });
<a name="l12843"></a>12843           });
<a name="l12844"></a>12844 
<a name="l12845"></a>12845           req.active = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l12846"></a>12846           <span class="keyword">self</span>.__sendMessage({
<a name="l12847"></a>12847             type: <span class="stringliteral">&#39;composeBegun&#39;</span>,
<a name="l12848"></a>12848             <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12849"></a>12849             error: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12850"></a>12850             identity: account.identities[0],
<a name="l12851"></a>12851             subject: header.subject,
<a name="l12852"></a>12852             body: composeBody,
<a name="l12853"></a>12853             <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>: header.to,
<a name="l12854"></a>12854             <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>: header.cc,
<a name="l12855"></a>12855             bcc: header.bcc,
<a name="l12856"></a>12856             referencesStr: body.references,
<a name="l12857"></a>12857             attachments: attachments
<a name="l12858"></a>12858           });
<a name="l12859"></a>12859           callWhenDone();
<a name="l12860"></a>12860         }
<a name="l12861"></a>12861         <span class="keywordflow">catch</span> (ex) {
<a name="l12862"></a>12862           fail(); <span class="comment">// calls callWhenDone</span>
<a name="l12863"></a>12863         }
<a name="l12864"></a>12864       });
<a name="l12865"></a>12865     });
<a name="l12866"></a>12866   },
<a name="l12867"></a>12867 
<a name="l12868"></a>12868   _cmd_doneCompose: <span class="keyword">function</span> mb__cmd_doneCompose(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l12869"></a>12869     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;./composer&#39;</span>], <span class="keyword">function</span> ($composer) {
<a name="l12870"></a>12870       var req = this._pendingRequests[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle], <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l12871"></a>12871       <span class="keywordflow">if</span> (!req)
<a name="l12872"></a>12872         <span class="keywordflow">return</span>;
<a name="l12873"></a>12873       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.command === <span class="stringliteral">&#39;die&#39;</span>) {
<a name="l12874"></a>12874         <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (req.active)
<a name="l12875"></a>12875           req.die = <span class="keyword">true</span>;
<a name="l12876"></a>12876         <span class="keywordflow">else</span>
<a name="l12877"></a>12877           <span class="keyword">delete</span> <span class="keyword">this</span>._pendingRequests[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12878"></a>12878         <span class="keywordflow">return</span>;
<a name="l12879"></a>12879       }
<a name="l12880"></a>12880       var account;
<a name="l12881"></a>12881       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.command === <span class="stringliteral">&#39;delete&#39;</span>) {
<a name="l12882"></a>12882         <span class="keyword">function</span> sendDeleted() {
<a name="l12883"></a>12883           <span class="keyword">self</span>.__sendMessage({
<a name="l12884"></a>12884             type: <span class="stringliteral">&#39;doneCompose&#39;</span>,
<a name="l12885"></a>12885             <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12886"></a>12886             err: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12887"></a>12887             badAddresses: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12888"></a>12888             messageId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12889"></a>12889             sentDate: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>
<a name="l12890"></a>12890           });
<a name="l12891"></a>12891         }
<a name="l12892"></a>12892         <span class="keywordflow">if</span> (req.persistedNamer) {
<a name="l12893"></a>12893           account = this.universe.getAccountForMessageSuid(
<a name="l12894"></a>12894                       req.persistedNamer.suid);
<a name="l12895"></a>12895           this.universe.deleteDraft(account, req.persistedNamer, sendDeleted);
<a name="l12896"></a>12896         }
<a name="l12897"></a>12897         <span class="keywordflow">else</span> {
<a name="l12898"></a>12898           sendDeleted();
<a name="l12899"></a>12899         }
<a name="l12900"></a>12900         <span class="keyword">delete</span> this._pendingRequests[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12901"></a>12901         <span class="comment">// XXX if we have persistedFolder/persistedUID, enqueue a delete of that</span>
<a name="l12902"></a>12902         <span class="comment">// message and try and execute it.</span>
<a name="l12903"></a>12903         <span class="keywordflow">return</span>;
<a name="l12904"></a>12904       }
<a name="l12905"></a>12905 
<a name="l12906"></a>12906 
<a name="l12907"></a>12907       var wireRep = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.state,
<a name="l12908"></a>12908           identity = this.universe.getIdentityForSenderIdentityId(
<a name="l12909"></a>12909                        wireRep.senderId);
<a name="l12910"></a>12910       account = this.universe.getAccountForSenderIdentityId(wireRep.senderId);
<a name="l12911"></a>12911 
<a name="l12912"></a>12912       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.command === <span class="stringliteral">&#39;send&#39;</span>) {
<a name="l12913"></a>12913         var composer = <span class="keyword">new</span> $composer.Composer(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.command, wireRep,
<a name="l12914"></a>12914                                               account, identity);
<a name="l12915"></a>12915 
<a name="l12916"></a>12916         req.active = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l12917"></a>12917         <span class="keywordflow">if</span> (req.die)
<a name="l12918"></a>12918           <span class="keyword">delete</span> this._pendingRequests[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l12919"></a>12919         account.sendMessage(composer, <span class="keyword">function</span>(err, badAddresses) {
<a name="l12920"></a>12920           <span class="comment">// If there was an associated/saved draft, clear it out, but there&#39;s</span>
<a name="l12921"></a>12921           <span class="comment">// no need to wait for that to complete.</span>
<a name="l12922"></a>12922           <span class="keywordflow">if</span> (req.persistedNamer)
<a name="l12923"></a>12923             <span class="keyword">this</span>.universe.deleteDraft(account, req.persistedNamer);
<a name="l12924"></a>12924           this.__sendMessage({
<a name="l12925"></a>12925             type: <span class="stringliteral">&#39;doneCompose&#39;</span>,
<a name="l12926"></a>12926             <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l12927"></a>12927             err: err,
<a name="l12928"></a>12928             badAddresses: badAddresses,
<a name="l12929"></a>12929             messageId: composer.messageId,
<a name="l12930"></a>12930             sentDate: composer.sentDate.valueOf(),
<a name="l12931"></a>12931           });
<a name="l12932"></a>12932         }.bind(<span class="keyword">this</span>));
<a name="l12933"></a>12933       }
<a name="l12934"></a>12934       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.command === <span class="stringliteral">&#39;save&#39;</span>) {
<a name="l12935"></a>12935         <span class="comment">// -- convert from compose rep to header/body rep</span>
<a name="l12936"></a>12936         var msgTimestamp = Date.now();
<a name="l12937"></a>12937         var header = {
<a name="l12938"></a>12938           <span class="keywordtype">id</span>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">// filled in by the job</span>
<a name="l12939"></a>12939           srvid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">// stays null</span>
<a name="l12940"></a>12940           suid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">// filled in by the job</span>
<a name="l12941"></a>12941           guid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="comment">// unused</span>
<a name="l12942"></a>12942           author: { <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: identity.name, <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: identity.address},
<a name="l12943"></a>12943           <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>: wireRep.to,
<a name="l12944"></a>12944           <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>: wireRep.cc,
<a name="l12945"></a>12945           bcc: wireRep.bcc,
<a name="l12946"></a>12946           replyTo: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12947"></a>12947           date: msgTimestamp,
<a name="l12948"></a>12948           <a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>: [],
<a name="l12949"></a>12949           hasAttachments: !!wireRep.attachments.length,
<a name="l12950"></a>12950           subject: wireRep.subject,
<a name="l12951"></a>12951           snippet: wireRep.body.text.substring(0, 100),
<a name="l12952"></a>12952         };
<a name="l12953"></a>12953         var body = {
<a name="l12954"></a>12954           date: msgTimestamp,
<a name="l12955"></a>12955           <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a6d7e27eaec1e5f6600e65858be43c18b">size</a>: 0,
<a name="l12956"></a>12956           attachments: [],
<a name="l12957"></a>12957           relatedParts: [],
<a name="l12958"></a>12958           references: wireRep.referencesStr,
<a name="l12959"></a>12959           bodyReps: []
<a name="l12960"></a>12960         };
<a name="l12961"></a>12961         wireRep.attachments.forEach(<span class="keyword">function</span>(wireAtt) {
<a name="l12962"></a>12962           body.attachments.push({
<a name="l12963"></a>12963             <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: wireAtt.name,
<a name="l12964"></a>12964             contentId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12965"></a>12965             type: wireAtt.blob.type,
<a name="l12966"></a>12966             part: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12967"></a>12967             <a class="code" href="../../d9/d04/expat_8h.html#a4dfeb87c47b4dde2571b24c1a6798056">encoding</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12968"></a>12968             sizeEstimate: wireAtt.blob.size,
<a name="l12969"></a>12969             <a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>: wireAtt.blob
<a name="l12970"></a>12970           });
<a name="l12971"></a>12971         });
<a name="l12972"></a>12972         body.bodyReps.push({
<a name="l12973"></a>12973           type: <span class="stringliteral">&#39;plain&#39;</span>,
<a name="l12974"></a>12974           part: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12975"></a>12975           sizeEstimate: wireRep.body.text.length,
<a name="l12976"></a>12976           amountDownloaded: wireRep.body.text.length,
<a name="l12977"></a>12977           isDownloaded: <span class="keyword">true</span>,
<a name="l12978"></a>12978           _partInfo: {},
<a name="l12979"></a>12979           <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a4a1b5640b674da15d6f1b87899e53789">content</a>: [0x1, wireRep.body.text]
<a name="l12980"></a>12980         });
<a name="l12981"></a>12981         <span class="keywordflow">if</span> (wireRep.body.html) {
<a name="l12982"></a>12982           body.bodyReps.push({
<a name="l12983"></a>12983             type: <span class="stringliteral">&#39;html&#39;</span>,
<a name="l12984"></a>12984             part: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l12985"></a>12985             sizeEstimate: wireRep.body.html.length,
<a name="l12986"></a>12986             amountDownloaded: wireRep.body.html.length,
<a name="l12987"></a>12987             isDownloaded: <span class="keyword">true</span>,
<a name="l12988"></a>12988             _partInfo: {},
<a name="l12989"></a>12989             <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a4a1b5640b674da15d6f1b87899e53789">content</a>: wireRep.body.html
<a name="l12990"></a>12990           });
<a name="l12991"></a>12991         }
<a name="l12992"></a>12992 
<a name="l12993"></a>12993         this.universe.saveDraft(
<a name="l12994"></a>12994           account, req.persistedNamer, header, body,
<a name="l12995"></a>12995           <span class="keyword">function</span>(err, messageNamer) {
<a name="l12996"></a>12996             req.active = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l12997"></a>12997             req.persistedNamer = messageNamer;
<a name="l12998"></a>12998             <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (req.die)
<a name="l12999"></a>12999               <span class="keyword">delete</span> <span class="keyword">self</span>._pendingRequests[<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle];
<a name="l13000"></a>13000             <span class="keyword">self</span>.__sendMessage({
<a name="l13001"></a>13001               type: <span class="stringliteral">&#39;doneCompose&#39;</span>,
<a name="l13002"></a>13002               <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.handle,
<a name="l13003"></a>13003               err: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l13004"></a>13004               badAddresses: null,
<a name="l13005"></a>13005               messageId: null,
<a name="l13006"></a>13006               sentDate: null,
<a name="l13007"></a>13007             });
<a name="l13008"></a>13008           });
<a name="l13009"></a>13009       }
<a name="l13010"></a>13010     }.bind(<span class="keyword">this</span>));
<a name="l13011"></a>13011   },
<a name="l13012"></a>13012 
<a name="l13013"></a>13013   notifyCronSyncStart: <span class="keyword">function</span> mb_notifyCronSyncStart(accountIds) {
<a name="l13014"></a>13014     this.__sendMessage({
<a name="l13015"></a>13015       type: <span class="stringliteral">&#39;cronSyncStart&#39;</span>,
<a name="l13016"></a>13016       accountIds: accountIds
<a name="l13017"></a>13017     });
<a name="l13018"></a>13018   },
<a name="l13019"></a>13019 
<a name="l13020"></a>13020   notifyCronSyncStop: <span class="keyword">function</span> mb_notifyCronSyncStop(accountsResults) {
<a name="l13021"></a>13021     this.__sendMessage({
<a name="l13022"></a>13022       type: <span class="stringliteral">&#39;cronSyncStop&#39;</span>,
<a name="l13023"></a>13023       accountsResults: accountsResults
<a name="l13024"></a>13024     });
<a name="l13025"></a>13025   }
<a name="l13026"></a>13026 
<a name="l13028"></a>13028 };
<a name="l13029"></a>13029 
<a name="l13030"></a>13030 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l13031"></a>13031   MailBridge: {
<a name="l13032"></a>13032     type: $log.DAEMON,
<a name="l13033"></a>13033     events: {
<a name="l13034"></a>13034       <span class="comment">// NB: under unit test, this is not used and bridgeSnoop is used instead.</span>
<a name="l13035"></a>13035       <a class="code" href="../../df/d65/openaudio_8js.html#a4379e0d0aa0995d904faac29a324b51b">send</a>: { type: <span class="keyword">true</span> },
<a name="l13036"></a>13036     },
<a name="l13037"></a>13037     TEST_ONLY_events: {
<a name="l13038"></a>13038       <a class="code" href="../../df/d65/openaudio_8js.html#a4379e0d0aa0995d904faac29a324b51b">send</a>: { <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>: <span class="keyword">false</span> },
<a name="l13039"></a>13039     },
<a name="l13040"></a>13040     errors: {
<a name="l13041"></a>13041       badMessageType: { type: <span class="keyword">true</span> },
<a name="l13042"></a>13042       badSliceHandle: { <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: <span class="keyword">true</span> },
<a name="l13043"></a>13043     },
<a name="l13044"></a>13044     calls: {
<a name="l13045"></a>13045       cmd: { command: <span class="keyword">true</span> },
<a name="l13046"></a>13046     },
<a name="l13047"></a>13047     TEST_ONLY_calls: {
<a name="l13048"></a>13048     },
<a name="l13049"></a>13049   },
<a name="l13050"></a>13050 });
<a name="l13051"></a>13051 
<a name="l13052"></a>13052 }); <span class="comment">// end define</span>
<a name="l13053"></a>13053 ;
<a name="l13054"></a>13054 <span class="comment">/* ***** BEGIN LICENSE BLOCK *****</span>
<a name="l13055"></a>13055 <span class="comment"> * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a name="l13056"></a>13056 <span class="comment"> *</span>
<a name="l13057"></a>13057 <span class="comment"> * The contents of this file are subject to the Mozilla Public License Version</span>
<a name="l13058"></a>13058 <span class="comment"> * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a name="l13059"></a>13059 <span class="comment"> * the License. You may obtain a copy of the License at:</span>
<a name="l13060"></a>13060 <span class="comment"> * http://www.mozilla.org/MPL/</span>
<a name="l13061"></a>13061 <span class="comment"> *</span>
<a name="l13062"></a>13062 <span class="comment"> * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a name="l13063"></a>13063 <span class="comment"> * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a name="l13064"></a>13064 <span class="comment"> * for the specific language governing rights and limitations under the</span>
<a name="l13065"></a>13065 <span class="comment"> * License.</span>
<a name="l13066"></a>13066 <span class="comment"> *</span>
<a name="l13067"></a>13067 <span class="comment"> * The Original Code is Mozilla Raindrop Code.</span>
<a name="l13068"></a>13068 <span class="comment"> *</span>
<a name="l13069"></a>13069 <span class="comment"> * The Initial Developer of the Original Code is</span>
<a name="l13070"></a>13070 <span class="comment"> *   The Mozilla Foundation</span>
<a name="l13071"></a>13071 <span class="comment"> * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a name="l13072"></a>13072 <span class="comment"> * the Initial Developer. All Rights Reserved.</span>
<a name="l13073"></a>13073 <span class="comment"> *</span>
<a name="l13074"></a>13074 <span class="comment"> * Contributor(s):</span>
<a name="l13075"></a>13075 <span class="comment"> *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a name="l13076"></a>13076 <span class="comment"> *</span>
<a name="l13077"></a>13077 <span class="comment"> * Alternatively, the contents of this file may be used under the terms of</span>
<a name="l13078"></a>13078 <span class="comment"> * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a name="l13079"></a>13079 <span class="comment"> * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a name="l13080"></a>13080 <span class="comment"> * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a name="l13081"></a>13081 <span class="comment"> * of those above. If you wish to allow use of your version of this file only</span>
<a name="l13082"></a>13082 <span class="comment"> * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a name="l13083"></a>13083 <span class="comment"> * use your version of this file under the terms of the MPL, indicate your</span>
<a name="l13084"></a>13084 <span class="comment"> * decision by deleting the provisions above and replace them with the notice</span>
<a name="l13085"></a>13085 <span class="comment"> * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a name="l13086"></a>13086 <span class="comment"> * the provisions above, a recipient may use your version of this file under</span>
<a name="l13087"></a>13087 <span class="comment"> * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a name="l13088"></a>13088 <span class="comment"> *</span>
<a name="l13089"></a>13089 <span class="comment"> * ***** END LICENSE BLOCK ***** */</span>
<a name="l13090"></a>13090 
<a name="l13103"></a>13103 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;rdcommon/logreaper&#39;</span>,
<a name="l13104"></a>13104   [
<a name="l13105"></a>13105     <span class="stringliteral">&#39;./log&#39;</span>,
<a name="l13106"></a>13106     <span class="stringliteral">&#39;microtime&#39;</span>,
<a name="l13107"></a>13107     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l13108"></a>13108   ],
<a name="l13109"></a>13109   <span class="keyword">function</span>(
<a name="l13110"></a>13110     $log,
<a name="l13111"></a>13111     $microtime,
<a name="l13112"></a>13112     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l13113"></a>13113   ) {
<a name="l13114"></a>13114 
<a name="l13115"></a>13115 var EMPTY = [];
<a name="l13116"></a>13116 
<a name="l13117"></a>13117 <span class="keyword">function</span> LogReaper(rootLogger) {
<a name="l13118"></a>13118   this._rootLogger = rootLogger;
<a name="l13119"></a>13119   this._lastTimestamp = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13120"></a>13120   this._lastSeq = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13121"></a>13121 }
<a name="l13122"></a>13122 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LogReaper = LogReaper;
<a name="l13123"></a>13123 LogReaper.prototype = {
<a name="l13140"></a>13140   reapHierLogTimeSlice: <span class="keyword">function</span>() {
<a name="l13141"></a>13141     var rootLogger = this._rootLogger,
<a name="l13142"></a>13142         startSeq, startTimestamp;
<a name="l13143"></a>13143     <span class="keywordflow">if</span> (this._lastTimestamp === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l13144"></a>13144       startSeq = 0;
<a name="l13145"></a>13145       startTimestamp = rootLogger._born;
<a name="l13146"></a>13146     }
<a name="l13147"></a>13147     <span class="keywordflow">else</span> {
<a name="l13148"></a>13148       startSeq = this._lastSeq + 1;
<a name="l13149"></a>13149       startTimestamp = this._lastTimestamp;
<a name="l13150"></a>13150     }
<a name="l13151"></a>13151     var endSeq = $log.getCurrentSeq(),
<a name="l13152"></a>13152         endTimestamp = this._lastTimestamp = $microtime.now();
<a name="l13153"></a>13153 
<a name="l13154"></a>13154     <span class="keyword">function</span> traverseLogger(logger) {
<a name="l13155"></a>13155       var empty = <span class="keyword">true</span>;
<a name="l13156"></a>13156       <span class="comment">// speculatively start populating an output representation</span>
<a name="l13157"></a>13157       var outrep = logger.toJSON();
<a name="l13158"></a>13158       outrep.events = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13159"></a>13159       outrep.kids = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13160"></a>13160 
<a name="l13161"></a>13161       <span class="comment">// - check born/death</span>
<a name="l13162"></a>13162       <span class="comment">// actually, being born doesn&#39;t generate an event, so ignore.</span>
<a name="l13163"></a>13163       <span class="comment">//if (logger._born &gt;= startTimestamp)</span>
<a name="l13164"></a>13164       <span class="comment">//  empty = false;</span>
<a name="l13165"></a>13165       <span class="keywordflow">if</span> (logger._died !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l13166"></a>13166         empty = <span class="keyword">false</span>;
<a name="l13167"></a>13167 
<a name="l13168"></a>13168       <span class="comment">// - check events</span>
<a name="l13169"></a>13169       var outEvents = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13170"></a>13170       <span class="keywordflow">for</span> (var eventKey in logger._eventMap) {
<a name="l13171"></a>13171         var eventVal = logger._eventMap[eventKey];
<a name="l13172"></a>13172         <span class="keywordflow">if</span> (eventVal) {
<a name="l13173"></a>13173           empty = <span class="keyword">false</span>;
<a name="l13174"></a>13174           <span class="keywordflow">if</span> (outEvents === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l13175"></a>13175             outrep.events = outEvents = {};
<a name="l13176"></a>13176           outEvents[eventKey] = eventVal;
<a name="l13177"></a>13177           logger._eventMap[eventKey] = 0;
<a name="l13178"></a>13178         }
<a name="l13179"></a>13179       }
<a name="l13180"></a>13180 
<a name="l13181"></a>13181       <span class="comment">// - check and reap entries</span>
<a name="l13182"></a>13182       <span class="keywordflow">if</span> (outrep.entries.length) {
<a name="l13183"></a>13183         empty = <span class="keyword">false</span>;
<a name="l13184"></a>13184         <span class="comment">// (we keep/use outrep.entries, and zero the logger&#39;s entries)</span>
<a name="l13185"></a>13185         logger._entries = [];
<a name="l13186"></a>13186       }
<a name="l13187"></a>13187       <span class="keywordflow">else</span> {
<a name="l13188"></a>13188         <span class="comment">// Avoid subsequent mutation of the list mutating our representation</span>
<a name="l13189"></a>13189         <span class="comment">//  and without creating gratuitous garbage by using a shared empty</span>
<a name="l13190"></a>13190         <span class="comment">//  list for such cases.</span>
<a name="l13191"></a>13191         outrep.entries = EMPTY;
<a name="l13192"></a>13192       }
<a name="l13193"></a>13193 
<a name="l13194"></a>13194       <span class="comment">// - check and reap children</span>
<a name="l13195"></a>13195       <span class="keywordflow">if</span> (logger._kids &amp;&amp; logger._kids.length) {
<a name="l13196"></a>13196         <span class="keywordflow">for</span> (var iKid = 0; iKid &lt; logger._kids.length; iKid++) {
<a name="l13197"></a>13197           var kidLogger = logger._kids[iKid];
<a name="l13198"></a>13198           var kidrep = traverseLogger(kidLogger);
<a name="l13199"></a>13199           <span class="keywordflow">if</span> (kidrep) {
<a name="l13200"></a>13200             <span class="keywordflow">if</span> (!outrep.kids)
<a name="l13201"></a>13201               outrep.kids = [];
<a name="l13202"></a>13202             outrep.kids.push(kidrep);
<a name="l13203"></a>13203             empty = <span class="keyword">false</span>;
<a name="l13204"></a>13204           }
<a name="l13205"></a>13205           <span class="comment">// reap (and adjust iteration)</span>
<a name="l13206"></a>13206           <span class="keywordflow">if</span> (kidLogger._died !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l13207"></a>13207             logger._kids.splice(iKid--, 1);
<a name="l13208"></a>13208         }
<a name="l13209"></a>13209       }
<a name="l13210"></a>13210 
<a name="l13211"></a>13211       <span class="keywordflow">return</span> (empty ? <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> : outrep);
<a name="l13212"></a>13212     }
<a name="l13213"></a>13213 
<a name="l13214"></a>13214     <span class="keywordflow">return</span> {
<a name="l13215"></a>13215       begin: startTimestamp,
<a name="l13216"></a>13216       <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: endTimestamp,
<a name="l13217"></a>13217       logFrag: traverseLogger(rootLogger),
<a name="l13218"></a>13218     };
<a name="l13219"></a>13219   },
<a name="l13220"></a>13220 };
<a name="l13221"></a>13221 
<a name="l13222"></a>13222 }); <span class="comment">// end define</span>
<a name="l13223"></a>13223 ;
<a name="l13228"></a>13228 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/maildb&#39;</span>,
<a name="l13229"></a>13229   [
<a name="l13230"></a>13230     <span class="stringliteral">&#39;./worker-router&#39;</span>,
<a name="l13231"></a>13231     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l13232"></a>13232   ],
<a name="l13233"></a>13233   <span class="keyword">function</span>(
<a name="l13234"></a>13234     $router,
<a name="l13235"></a>13235     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l13236"></a>13236   ) {
<a name="l13237"></a>13237 
<a name="l13238"></a>13238 
<a name="l13239"></a>13239 var sendMessage = $router.registerCallbackType(<span class="stringliteral">&#39;maildb&#39;</span>);
<a name="l13240"></a>13240 
<a name="l13241"></a>13241 <span class="keyword">function</span> MailDB(testOptions) {
<a name="l13242"></a>13242   this._callbacksQueue = [];
<a name="l13243"></a>13243   <span class="keyword">function</span> processQueue() {
<a name="l13244"></a>13244     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;main thread reports DB ready&#39;</span>);
<a name="l13245"></a>13245     this._ready = <span class="keyword">true</span>;
<a name="l13246"></a>13246 
<a name="l13247"></a>13247     this._callbacksQueue.forEach(<span class="keyword">function</span> executeCallback(<a class="code" href="../../d2/d7d/jsapi_8h.html#a9c0cec265243907d0da86b92bda26eca">cb</a>) {
<a name="l13248"></a>13248       <a class="code" href="../../d2/d7d/jsapi_8h.html#a9c0cec265243907d0da86b92bda26eca">cb</a>();
<a name="l13249"></a>13249     });
<a name="l13250"></a>13250     this._callbacksQueue = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13251"></a>13251   }
<a name="l13252"></a>13252 
<a name="l13253"></a>13253   sendMessage(<span class="stringliteral">&#39;open&#39;</span>, [testOptions], processQueue.bind(<span class="keyword">this</span>));
<a name="l13254"></a>13254 }
<a name="l13255"></a>13255 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MailDB = MailDB;
<a name="l13256"></a>13256 MailDB.prototype = {
<a name="l13257"></a>13257   <a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a>: <span class="keyword">function</span>() {
<a name="l13258"></a>13258     sendMessage(<span class="stringliteral">&#39;close&#39;</span>);
<a name="l13259"></a>13259   },
<a name="l13260"></a>13260 
<a name="l13261"></a>13261   getConfig: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l13262"></a>13262     <span class="keywordflow">if</span> (!this._ready) {
<a name="l13263"></a>13263       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;deferring getConfig call until ready&#39;</span>);
<a name="l13264"></a>13264       this._callbacksQueue.push(this.getConfig.bind(<span class="keyword">this</span>, callback));
<a name="l13265"></a>13265       <span class="keywordflow">return</span>;
<a name="l13266"></a>13266     }
<a name="l13267"></a>13267 
<a name="l13268"></a>13268     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;issuing getConfig call to main thread&#39;</span>);
<a name="l13269"></a>13269     sendMessage(<span class="stringliteral">&#39;getConfig&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, callback);
<a name="l13270"></a>13270   },
<a name="l13271"></a>13271 
<a name="l13272"></a>13272   saveConfig: <span class="keyword">function</span>(<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>) {
<a name="l13273"></a>13273     sendMessage(<span class="stringliteral">&#39;saveConfig&#39;</span>, [<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>]);
<a name="l13274"></a>13274   },
<a name="l13275"></a>13275 
<a name="l13276"></a>13276   saveAccountDef: <span class="keyword">function</span>(<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, accountDef, folderInfo) {
<a name="l13277"></a>13277     sendMessage(<span class="stringliteral">&#39;saveAccountDef&#39;</span>, [ <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, accountDef, folderInfo ]);
<a name="l13278"></a>13278   },
<a name="l13279"></a>13279 
<a name="l13280"></a>13280   loadHeaderBlock: <span class="keyword">function</span>(folderId, blockId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l13281"></a>13281     sendMessage(<span class="stringliteral">&#39;loadHeaderBlock&#39;</span>, [ folderId, blockId], callback);
<a name="l13282"></a>13282   },
<a name="l13283"></a>13283 
<a name="l13284"></a>13284   loadBodyBlock: <span class="keyword">function</span>(folderId, blockId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l13285"></a>13285     sendMessage(<span class="stringliteral">&#39;loadBodyBlock&#39;</span>, [ folderId, blockId], callback);
<a name="l13286"></a>13286   },
<a name="l13287"></a>13287 
<a name="l13288"></a>13288   saveAccountFolderStates: <span class="keyword">function</span>(accountId, folderInfo, perFolderStuff,
<a name="l13289"></a>13289                                     deletedFolderIds, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, reuseTrans) {
<a name="l13290"></a>13290     var args = [ accountId, folderInfo, perFolderStuff, deletedFolderIds ];
<a name="l13291"></a>13291     sendMessage(<span class="stringliteral">&#39;saveAccountFolderStates&#39;</span>, args, callback);
<a name="l13292"></a>13292     <span class="comment">// XXX vn Does this deserve any purpose?</span>
<a name="l13293"></a>13293     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13294"></a>13294   },
<a name="l13295"></a>13295 
<a name="l13296"></a>13296   deleteAccount: <span class="keyword">function</span>(accountId) {
<a name="l13297"></a>13297     sendMessage(<span class="stringliteral">&#39;deleteAccount&#39;</span>, [accountId]);
<a name="l13298"></a>13298   },
<a name="l13299"></a>13299 };
<a name="l13300"></a>13300 
<a name="l13301"></a>13301 }); <span class="comment">// end define</span>
<a name="l13302"></a>13302 ;
<a name="l13303"></a>13303 <span class="comment">/*global define, console, setTimeout */</span>
<a name="l13326"></a>13326 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/cronsync&#39;</span>,
<a name="l13327"></a>13327   [
<a name="l13328"></a>13328     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l13329"></a>13329     <span class="stringliteral">&#39;./worker-router&#39;</span>,
<a name="l13330"></a>13330     <span class="stringliteral">&#39;./slice_bridge_proxy&#39;</span>,
<a name="l13331"></a>13331     <span class="stringliteral">&#39;./mailslice&#39;</span>,
<a name="l13332"></a>13332     <span class="stringliteral">&#39;prim&#39;</span>,
<a name="l13333"></a>13333     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l13334"></a>13334     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l13335"></a>13335   ],
<a name="l13336"></a>13336   <span class="keyword">function</span>(
<a name="l13337"></a>13337     $log,
<a name="l13338"></a>13338     $router,
<a name="l13339"></a>13339     $sliceBridgeProxy,
<a name="l13340"></a>13340     $mailslice,
<a name="l13341"></a>13341     $prim,
<a name="l13342"></a>13342     $module,
<a name="l13343"></a>13343     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l13344"></a>13344   ) {
<a name="l13345"></a>13345 
<a name="l13346"></a>13346 
<a name="l13350"></a>13350 var MINIMUM_SYNC_INTERVAL_MS = 60 * 1000;
<a name="l13351"></a>13351 
<a name="l13356"></a>13356 var MAX_SYNC_DURATION_MS = 3 * 60 * 1000;
<a name="l13357"></a>13357 
<a name="l13362"></a>13362 var MAX_MESSAGES_TO_REPORT_PER_ACCOUNT = 5;
<a name="l13363"></a>13363 
<a name="l13367"></a>13367 var MAX_SNIPPET_BYTES = 4 * 1024;
<a name="l13368"></a>13368 
<a name="l13369"></a>13369 <span class="keyword">function</span> <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l13370"></a>13370   <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;cronsync: &quot;</span> + <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> + <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l13371"></a>13371 }
<a name="l13372"></a>13372 
<a name="l13373"></a>13373 var SliceBridgeProxy = $sliceBridgeProxy.SliceBridgeProxy;
<a name="l13374"></a>13374 
<a name="l13375"></a>13375 <span class="keyword">function</span> makeSlice(storage, callback, parentLog) {
<a name="l13376"></a>13376   var proxy = <span class="keyword">new</span> SliceBridgeProxy({
<a name="l13377"></a>13377         __sendMessage: <span class="keyword">function</span>() {}
<a name="l13378"></a>13378       }, <span class="stringliteral">&#39;cron&#39;</span>),
<a name="l13379"></a>13379       slice = <span class="keyword">new</span> $mailslice.MailSlice(proxy, storage, parentLog),
<a name="l13380"></a>13380       oldStatus = proxy.sendStatus,
<a name="l13381"></a>13381       newHeaders = [];
<a name="l13382"></a>13382 
<a name="l13383"></a>13383   slice.onNewHeader = <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>) {
<a name="l13384"></a>13384     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;onNewHeader: &#39;</span> + header);
<a name="l13385"></a>13385     newHeaders.push(header);
<a name="l13386"></a>13386   };
<a name="l13387"></a>13387 
<a name="l13388"></a>13388   proxy.sendStatus = <span class="keyword">function</span>(<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, requested, moreExpected,
<a name="l13389"></a>13389                               progress, newEmailCount) {
<a name="l13390"></a>13390     oldStatus.apply(<span class="keyword">this</span>, arguments);
<a name="l13391"></a>13391     <span class="keywordflow">if</span> (requested &amp;&amp; !moreExpected &amp;&amp; callback) {
<a name="l13392"></a>13392       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(newHeaders);
<a name="l13393"></a>13393       slice.die();
<a name="l13394"></a>13394     }
<a name="l13395"></a>13395   };
<a name="l13396"></a>13396 
<a name="l13397"></a>13397   <span class="keywordflow">return</span> <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l13398"></a>13398 }
<a name="l13399"></a>13399 
<a name="l13404"></a>13404 <span class="keyword">function</span> CronSync(universe, _logParent) {
<a name="l13405"></a>13405   this._universe = universe;
<a name="l13406"></a>13406   this._universeDeferred = $prim();
<a name="l13407"></a>13407   this._isUniverseReady = <span class="keyword">false</span>;
<a name="l13408"></a>13408 
<a name="l13409"></a>13409   this._LOG = LOGFAB.CronSync(<span class="keyword">this</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, _logParent);
<a name="l13410"></a>13410 
<a name="l13411"></a>13411   this._activeSlices = [];
<a name="l13412"></a>13412 
<a name="l13413"></a>13413   this._completedEnsureSync = <span class="keyword">true</span>;
<a name="l13414"></a>13414   this._syncAccountsDone = <span class="keyword">true</span>;
<a name="l13415"></a>13415 
<a name="l13416"></a>13416   this._synced = [];
<a name="l13417"></a>13417 
<a name="l13418"></a>13418   this.sendCronSync = $router.registerSimple(<span class="stringliteral">&#39;cronsync&#39;</span>, <span class="keyword">function</span>(data) {
<a name="l13419"></a>13419     var args = data.args;
<a name="l13420"></a>13420     <span class="keywordflow">switch</span> (data.cmd) {
<a name="l13421"></a>13421       <span class="keywordflow">case</span> <span class="stringliteral">&#39;alarm&#39;</span>:
<a name="l13422"></a>13422         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;received an alarm via a message handler&#39;</span>);
<a name="l13423"></a>13423         this.onAlarm.apply(<span class="keyword">this</span>, args);
<a name="l13424"></a>13424         <span class="keywordflow">break</span>;
<a name="l13425"></a>13425       <span class="keywordflow">case</span> <span class="stringliteral">&#39;syncEnsured&#39;</span>:
<a name="l13426"></a>13426         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;received an syncEnsured via a message handler&#39;</span>);
<a name="l13427"></a>13427         this.onSyncEnsured.apply(<span class="keyword">this</span>, args);
<a name="l13428"></a>13428         <span class="keywordflow">break</span>;
<a name="l13429"></a>13429     }
<a name="l13430"></a>13430   }.bind(<span class="keyword">this</span>));
<a name="l13431"></a>13431   this.sendCronSync(<span class="stringliteral">&#39;hello&#39;</span>);
<a name="l13432"></a>13432 }
<a name="l13433"></a>13433 
<a name="l13434"></a>13434 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.CronSync = CronSync;
<a name="l13435"></a>13435 CronSync.prototype = {
<a name="l13436"></a>13436   _killSlices: <span class="keyword">function</span>() {
<a name="l13437"></a>13437     this._activeSlices.forEach(<span class="keyword">function</span>(slice) {
<a name="l13438"></a>13438       slice.die();
<a name="l13439"></a>13439     });
<a name="l13440"></a>13440   },
<a name="l13441"></a>13441 
<a name="l13442"></a>13442   onUniverseReady: <span class="keyword">function</span>() {
<a name="l13443"></a>13443     this._universeDeferred.resolve();
<a name="l13444"></a>13444 
<a name="l13445"></a>13445     this.ensureSync();
<a name="l13446"></a>13446   },
<a name="l13447"></a>13447 
<a name="l13448"></a>13448   whenUniverse: <span class="keyword">function</span>(fn) {
<a name="l13449"></a>13449     this._universeDeferred.promise.then(fn);
<a name="l13450"></a>13450   },
<a name="l13451"></a>13451 
<a name="l13455"></a>13455   ensureSync: <span class="keyword">function</span>() {
<a name="l13456"></a>13456     <span class="comment">// Only execute ensureSync if it is not already in progress.</span>
<a name="l13457"></a>13457     <span class="comment">// Otherwise, due to async timing of mozAlarm setting, could</span>
<a name="l13458"></a>13458     <span class="comment">// end up with two alarms for the same ID.</span>
<a name="l13459"></a>13459     <span class="keywordflow">if</span> (!this._completedEnsureSync)
<a name="l13460"></a>13460       <span class="keywordflow">return</span>;
<a name="l13461"></a>13461 
<a name="l13462"></a>13462     this._completedEnsureSync = <span class="keyword">false</span>;
<a name="l13463"></a>13463 
<a name="l13464"></a>13464     <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;ensureSync called&#39;</span>);
<a name="l13465"></a>13465 
<a name="l13466"></a>13466     this.whenUniverse(<span class="keyword">function</span>() {
<a name="l13467"></a>13467       var accounts = this._universe.accounts,
<a name="l13468"></a>13468           syncData = {};
<a name="l13469"></a>13469 
<a name="l13470"></a>13470       accounts.forEach(<span class="keyword">function</span>(account) {
<a name="l13471"></a>13471         <span class="comment">// Store data by interval, use a more obvious string</span>
<a name="l13472"></a>13472         <span class="comment">// key instead of just stringifying a number, which</span>
<a name="l13473"></a>13473         <span class="comment">// could be confused with an array construct.</span>
<a name="l13474"></a>13474         var interval = account.accountDef.syncInterval,
<a name="l13475"></a>13475             intervalKey = <span class="stringliteral">&#39;interval&#39;</span> + interval;
<a name="l13476"></a>13476 
<a name="l13477"></a>13477         <span class="keywordflow">if</span> (!syncData.hasOwnProperty(intervalKey)) {
<a name="l13478"></a>13478           syncData[intervalKey] = [];
<a name="l13479"></a>13479         }
<a name="l13480"></a>13480         syncData[intervalKey].push(account.id);
<a name="l13481"></a>13481       });
<a name="l13482"></a>13482 
<a name="l13483"></a>13483       this.sendCronSync(<span class="stringliteral">&#39;ensureSync&#39;</span>, [syncData]);
<a name="l13484"></a>13484     }.bind(<span class="keyword">this</span>));
<a name="l13485"></a>13485   },
<a name="l13486"></a>13486 
<a name="l13501"></a>13501   syncAccount: <span class="keyword">function</span>(account, doneCallback) {
<a name="l13502"></a>13502     <span class="comment">// - Skip syncing if we are offline or the account is disabled</span>
<a name="l13503"></a>13503     <span class="keywordflow">if</span> (!this._universe.online || !account.enabled) {
<a name="l13504"></a>13504       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;syncAcount early exit: online: &#39;</span> +
<a name="l13505"></a>13505             this._universe.online + <span class="stringliteral">&#39;, enabled: &#39;</span> + account.enabled);
<a name="l13506"></a>13506       doneCallback();
<a name="l13507"></a>13507       <span class="keywordflow">return</span>;
<a name="l13508"></a>13508     }
<a name="l13509"></a>13509 
<a name="l13510"></a>13510     var <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a> = <span class="keyword">function</span>(<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>) {
<a name="l13511"></a>13511       <span class="comment">// Wait for any in-process job operations to complete, so</span>
<a name="l13512"></a>13512       <span class="comment">// that the app is not killed in the middle of a sync.</span>
<a name="l13513"></a>13513       this._universe.waitForAccountOps(account, <span class="keyword">function</span>() {
<a name="l13514"></a>13514         <span class="comment">// Also wait for any account save to finish. Most</span>
<a name="l13515"></a>13515         <span class="comment">// likely failure will be new message headers not</span>
<a name="l13516"></a>13516         <span class="comment">// getting saved if the callback is not fired</span>
<a name="l13517"></a>13517         <span class="comment">// until after account saves.</span>
<a name="l13518"></a>13518         account.runAfterSaves(<span class="keyword">function</span>() {
<a name="l13519"></a>13519           doneCallback(result);
<a name="l13520"></a>13520         });
<a name="l13521"></a>13521       });
<a name="l13522"></a>13522     }.bind(<span class="keyword">this</span>);
<a name="l13523"></a>13523 
<a name="l13524"></a>13524     var inboxFolder = account.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>);
<a name="l13525"></a>13525     var storage = account.getFolderStorageForFolderId(inboxFolder.id);
<a name="l13526"></a>13526 
<a name="l13527"></a>13527     <span class="comment">// XXX check when the folder was most recently synchronized and skip this</span>
<a name="l13528"></a>13528     <span class="comment">// sync if it is sufficiently recent.</span>
<a name="l13529"></a>13529 
<a name="l13530"></a>13530     <span class="comment">// - Initiate a sync of the folder covering the desired time range.</span>
<a name="l13531"></a>13531     this._LOG.syncAccount_begin(account.id);
<a name="l13532"></a>13532 
<a name="l13533"></a>13533     var slice = makeSlice(storage, <span class="keyword">function</span>(newHeaders) {
<a name="l13534"></a>13534       this._LOG.syncAccount_end(account.id);
<a name="l13535"></a>13535       this._activeSlices.splice(this._activeSlices.indexOf(slice), 1);
<a name="l13536"></a>13536 
<a name="l13537"></a>13537       <span class="comment">// Reduce headers to the minimum number and data set needed for</span>
<a name="l13538"></a>13538       <span class="comment">// notifications.</span>
<a name="l13539"></a>13539       var notifyHeaders = [];
<a name="l13540"></a>13540       newHeaders.some(<span class="keyword">function</span>(header, i) {
<a name="l13541"></a>13541         notifyHeaders.push({
<a name="l13542"></a>13542           date: header.date,
<a name="l13543"></a>13543           from: header.author.name || header.author.address,
<a name="l13544"></a>13544           subject: header.subject,
<a name="l13545"></a>13545           accountId: account.id,
<a name="l13546"></a>13546           messageSuid: header.suid
<a name="l13547"></a>13547         });
<a name="l13548"></a>13548 
<a name="l13549"></a>13549         <span class="keywordflow">if</span> (i === MAX_MESSAGES_TO_REPORT_PER_ACCOUNT - 1)
<a name="l13550"></a>13550           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l13551"></a>13551       });
<a name="l13552"></a>13552 
<a name="l13553"></a>13553       <span class="keywordflow">if</span> (newHeaders.length) {
<a name="l13554"></a>13554         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Asking for snippets for &#39;</span> + notifyHeaders.length + <span class="stringliteral">&#39; headers&#39;</span>);
<a name="l13555"></a>13555         <span class="keywordflow">if</span> (this._universe.online){
<a name="l13556"></a>13556           this._universe.downloadBodies(
<a name="l13557"></a>13557             newHeaders.slice(0, MAX_MESSAGES_TO_REPORT_PER_ACCOUNT), {
<a name="l13558"></a>13558               maximumBytesToFetch: MAX_SNIPPET_BYTES
<a name="l13559"></a>13559             }, <span class="keyword">function</span>() {
<a name="l13560"></a>13560               <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;Notifying for &#39;</span> + newHeaders.length + <span class="stringliteral">&#39; headers&#39;</span>);
<a name="l13561"></a>13561               <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>([newHeaders.length, notifyHeaders]);
<a name="l13562"></a>13562           }.bind(<span class="keyword">this</span>));
<a name="l13563"></a>13563         } <span class="keywordflow">else</span> {
<a name="l13564"></a>13564           <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;UNIVERSE OFFLINE. Notifying for &#39;</span> + newHeaders.length +
<a name="l13565"></a>13565                 <span class="stringliteral">&#39; headers&#39;</span>);
<a name="l13566"></a>13566           <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>([newHeaders.length, notifyHeaders]);
<a name="l13567"></a>13567         }
<a name="l13568"></a>13568       } <span class="keywordflow">else</span> {
<a name="l13569"></a>13569         <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l13570"></a>13570       }
<a name="l13571"></a>13571     }.bind(<span class="keyword">this</span>), this._LOG);
<a name="l13572"></a>13572 
<a name="l13573"></a>13573     this._activeSlices.push(slice);
<a name="l13574"></a>13574     <span class="comment">// Pass true to force contacting the server.</span>
<a name="l13575"></a>13575     storage.sliceOpenMostRecent(slice, <span class="keyword">true</span>);
<a name="l13576"></a>13576   },
<a name="l13577"></a>13577 
<a name="l13578"></a>13578   onAlarm: <span class="keyword">function</span>(accountIds) {
<a name="l13579"></a>13579     this.whenUniverse(<span class="keyword">function</span>() {
<a name="l13580"></a>13580       this._LOG.alarmFired();
<a name="l13581"></a>13581 
<a name="l13582"></a>13582       <span class="keywordflow">if</span> (!accountIds)
<a name="l13583"></a>13583         <span class="keywordflow">return</span>;
<a name="l13584"></a>13584 
<a name="l13585"></a>13585       var accounts = this._universe.accounts,
<a name="l13586"></a>13586           targetAccounts = [],
<a name="l13587"></a>13587           <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a> = [];
<a name="l13588"></a>13588 
<a name="l13589"></a>13589       this._universe.__notifyStartedCronSync(accountIds);
<a name="l13590"></a>13590 
<a name="l13591"></a>13591       <span class="comment">// Make sure the acount IDs are still valid. This is to protect agains</span>
<a name="l13592"></a>13592       <span class="comment">// an account deletion that did not clean up any alarms correctly.</span>
<a name="l13593"></a>13593       accountIds.forEach(<span class="keyword">function</span>(<span class="keywordtype">id</span>) {
<a name="l13594"></a>13594         accounts.some(<span class="keyword">function</span>(account) {
<a name="l13595"></a>13595           <span class="keywordflow">if</span> (account.id === <span class="keywordtype">id</span>) {
<a name="l13596"></a>13596             targetAccounts.push(account);
<a name="l13597"></a>13597             <a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>.push(<span class="keywordtype">id</span>);
<a name="l13598"></a>13598             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l13599"></a>13599           }
<a name="l13600"></a>13600         });
<a name="l13601"></a>13601       });
<a name="l13602"></a>13602 
<a name="l13603"></a>13603       <span class="comment">// Flip switch to say account syncing is in progress.</span>
<a name="l13604"></a>13604       this._syncAccountsDone = <span class="keyword">false</span>;
<a name="l13605"></a>13605 
<a name="l13606"></a>13606       <span class="comment">// Make sure next alarm is set up. In the case of a cold start</span>
<a name="l13607"></a>13607       <span class="comment">// background sync, this is a bit redundant in that the startup</span>
<a name="l13608"></a>13608       <span class="comment">// of the mailuniverse would trigger this work. However, if the</span>
<a name="l13609"></a>13609       <span class="comment">// app is already running, need to be sure next alarm is set up,</span>
<a name="l13610"></a>13610       <span class="comment">// so ensure the next sync is set up here. Do it here instead of</span>
<a name="l13611"></a>13611       <span class="comment">// after a sync in case an error in sync would prevent the next</span>
<a name="l13612"></a>13612       <span class="comment">// sync from getting scheduled.</span>
<a name="l13613"></a>13613       this.ensureSync();
<a name="l13614"></a>13614 
<a name="l13615"></a>13615       var syncMax = targetAccounts.length,
<a name="l13616"></a>13616           syncCount = 0,
<a name="l13617"></a>13617           accountsResults = {
<a name="l13618"></a>13618             accountIds: accountIds
<a name="l13619"></a>13619           };
<a name="l13620"></a>13620 
<a name="l13621"></a>13621       var done = <span class="keyword">function</span>() {
<a name="l13622"></a>13622         syncCount += 1;
<a name="l13623"></a>13623         <span class="keywordflow">if</span> (syncCount &lt; syncMax)
<a name="l13624"></a>13624           <span class="keywordflow">return</span>;
<a name="l13625"></a>13625 
<a name="l13626"></a>13626         <span class="comment">// Kill off any slices that still exist from the last sync.</span>
<a name="l13627"></a>13627         this._killSlices();
<a name="l13628"></a>13628 
<a name="l13629"></a>13629         <span class="comment">// Wrap up the sync</span>
<a name="l13630"></a>13630         this._syncAccountsDone = <span class="keyword">true</span>;
<a name="l13631"></a>13631         this._onSyncDone = <span class="keyword">function</span>() {
<a name="l13632"></a>13632           <span class="keywordflow">if</span> (this._synced.length) {
<a name="l13633"></a>13633             accountsResults.updates = this._synced;
<a name="l13634"></a>13634             this._synced = [];
<a name="l13635"></a>13635           }
<a name="l13636"></a>13636 
<a name="l13637"></a>13637           this._universe.__notifyStoppedCronSync(accountsResults);
<a name="l13638"></a>13638         }.bind(<span class="keyword">this</span>);
<a name="l13639"></a>13639 
<a name="l13640"></a>13640         this._checkSyncDone();
<a name="l13641"></a>13641       }.bind(<span class="keyword">this</span>);
<a name="l13642"></a>13642 
<a name="l13643"></a>13643       <span class="comment">// Nothing new to sync, probably old accounts. Just return and indicate</span>
<a name="l13644"></a>13644       <span class="comment">// that syncing is done.</span>
<a name="l13645"></a>13645       <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d85/video_8js.html#a5d11ee175d66e98c6d8211b9d4c1c0b4">ids</a>.length) {
<a name="l13646"></a>13646         <span class="keywordflow">return</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l13647"></a>13647       }
<a name="l13648"></a>13648 
<a name="l13649"></a>13649       targetAccounts.forEach(<span class="keyword">function</span>(account) {
<a name="l13650"></a>13650         this.syncAccount(account, <span class="keyword">function</span> (result) {
<a name="l13651"></a>13651           <span class="keywordflow">if</span> (result) {
<a name="l13652"></a>13652             this._synced.push({
<a name="l13653"></a>13653               <span class="keywordtype">id</span>: account.id,
<a name="l13654"></a>13654               <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: account.identities[0].address,
<a name="l13655"></a>13655               count: result[0],
<a name="l13656"></a>13656               latestMessageInfos: result[1]
<a name="l13657"></a>13657             });
<a name="l13658"></a>13658           }
<a name="l13659"></a>13659           <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l13660"></a>13660         }.bind(<span class="keyword">this</span>));
<a name="l13661"></a>13661       }.bind(<span class="keyword">this</span>));
<a name="l13662"></a>13662     }.bind(<span class="keyword">this</span>));
<a name="l13663"></a>13663   },
<a name="l13664"></a>13664 
<a name="l13670"></a>13670   _checkSyncDone: <span class="keyword">function</span>() {
<a name="l13671"></a>13671     <span class="keywordflow">if</span> (!this._completedEnsureSync || !this._syncAccountsDone)
<a name="l13672"></a>13672       <span class="keywordflow">return</span>;
<a name="l13673"></a>13673 
<a name="l13674"></a>13674     <span class="keywordflow">if</span> (this._onSyncDone) {
<a name="l13675"></a>13675       this._onSyncDone();
<a name="l13676"></a>13676       this._onSyncDone = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13677"></a>13677     }
<a name="l13678"></a>13678   },
<a name="l13679"></a>13679 
<a name="l13687"></a>13687   onSyncEnsured: <span class="keyword">function</span>() {
<a name="l13688"></a>13688     this._completedEnsureSync = <span class="keyword">true</span>;
<a name="l13689"></a>13689     this._checkSyncDone();
<a name="l13690"></a>13690   },
<a name="l13691"></a>13691 
<a name="l13692"></a>13692   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>() {
<a name="l13693"></a>13693     $router.unregister(<span class="stringliteral">&#39;cronsync&#39;</span>);
<a name="l13694"></a>13694     this._killSlices();
<a name="l13695"></a>13695   }
<a name="l13696"></a>13696 };
<a name="l13697"></a>13697 
<a name="l13698"></a>13698 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l13699"></a>13699   CronSync: {
<a name="l13700"></a>13700     type: $log.DAEMON,
<a name="l13701"></a>13701     events: {
<a name="l13702"></a>13702       alarmFired: {},
<a name="l13703"></a>13703     },
<a name="l13704"></a>13704     TEST_ONLY_events: {
<a name="l13705"></a>13705     },
<a name="l13706"></a>13706     asyncJobs: {
<a name="l13707"></a>13707       syncAccount: { <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l13708"></a>13708     },
<a name="l13709"></a>13709     errors: {
<a name="l13710"></a>13710     },
<a name="l13711"></a>13711     calls: {
<a name="l13712"></a>13712     },
<a name="l13713"></a>13713     TEST_ONLY_calls: {
<a name="l13714"></a>13714     },
<a name="l13715"></a>13715   },
<a name="l13716"></a>13716 });
<a name="l13717"></a>13717 
<a name="l13718"></a>13718 }); <span class="comment">// end define</span>
<a name="l13719"></a>13719 ;
<a name="l13724"></a>13724 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/accountcommon&#39;</span>,
<a name="l13725"></a>13725   [
<a name="l13726"></a>13726     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l13727"></a>13727     <span class="stringliteral">&#39;./a64&#39;</span>,
<a name="l13728"></a>13728     <span class="stringliteral">&#39;require&#39;</span>,
<a name="l13729"></a>13729     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l13730"></a>13730     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l13731"></a>13731   ],
<a name="l13732"></a>13732   <span class="keyword">function</span>(
<a name="l13733"></a>13733     $log,
<a name="l13734"></a>13734     $a64,
<a name="l13735"></a>13735     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l13736"></a>13736     $module,
<a name="l13737"></a>13737     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l13738"></a>13738   ) {
<a name="l13739"></a>13739 
<a name="l13740"></a>13740 <span class="comment">// The number of milliseconds to wait for various (non-ActiveSync) XHRs to</span>
<a name="l13741"></a>13741 <span class="comment">// complete during the autoconfiguration process. This value is intentionally</span>
<a name="l13742"></a>13742 <span class="comment">// fairly large so that we don&#39;t abort an XHR just because the network is</span>
<a name="l13743"></a>13743 <span class="comment">// spotty.</span>
<a name="l13744"></a>13744 var AUTOCONFIG_TIMEOUT_MS = 30 * 1000;
<a name="l13745"></a>13745 
<a name="l13746"></a>13746 var Configurators = {
<a name="l13747"></a>13747   <span class="stringliteral">&#39;imap+smtp&#39;</span>: <span class="stringliteral">&#39;./composite/configurator&#39;</span>,
<a name="l13748"></a>13748   <span class="stringliteral">&#39;activesync&#39;</span>: <span class="stringliteral">&#39;./activesync/configurator&#39;</span>
<a name="l13749"></a>13749 };
<a name="l13750"></a>13750 
<a name="l13751"></a>13751 <span class="keyword">function</span> accountTypeToClass(type, callback) {
<a name="l13752"></a>13752   var configuratorId = Configurators[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] || <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l13753"></a>13753 
<a name="l13754"></a>13754   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> configuratorId === <span class="stringliteral">&#39;string&#39;</span>) {
<a name="l13755"></a>13755     <span class="comment">//A dynamically loaded account.</span>
<a name="l13756"></a>13756     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([configuratorId], <span class="keyword">function</span>(mod) {
<a name="l13757"></a>13757       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(mod.account.Account);
<a name="l13758"></a>13758     });
<a name="l13759"></a>13759   } <span class="keywordflow">else</span> {
<a name="l13760"></a>13760     <span class="comment">// Preserve next turn semantics that happen with</span>
<a name="l13761"></a>13761     <span class="comment">// the require call.</span>
<a name="l13762"></a>13762     <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span> () {
<a name="l13763"></a>13763       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l13764"></a>13764     }, 4);
<a name="l13765"></a>13765   }
<a name="l13766"></a>13766 }
<a name="l13767"></a>13767 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.accountTypeToClass = accountTypeToClass;
<a name="l13768"></a>13768 
<a name="l13769"></a>13769 <span class="comment">// Simple hard-coded autoconfiguration by domain...</span>
<a name="l13770"></a>13770 var autoconfigByDomain = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>._autoconfigByDomain = {
<a name="l13771"></a>13771   <span class="stringliteral">&#39;localhost&#39;</span>: {
<a name="l13772"></a>13772     type: <span class="stringliteral">&#39;imap+smtp&#39;</span>,
<a name="l13773"></a>13773     incoming: {
<a name="l13774"></a>13774       hostname: <span class="stringliteral">&#39;localhost&#39;</span>,
<a name="l13775"></a>13775       <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: 143,
<a name="l13776"></a>13776       socketType: <span class="stringliteral">&#39;plain&#39;</span>,
<a name="l13777"></a>13777       username: <span class="stringliteral">&#39;%EMAILLOCALPART%&#39;</span>,
<a name="l13778"></a>13778     },
<a name="l13779"></a>13779     outgoing: {
<a name="l13780"></a>13780       hostname: <span class="stringliteral">&#39;localhost&#39;</span>,
<a name="l13781"></a>13781       <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: 25,
<a name="l13782"></a>13782       socketType: <span class="stringliteral">&#39;plain&#39;</span>,
<a name="l13783"></a>13783       username: <span class="stringliteral">&#39;%EMAILLOCALPART%&#39;</span>,
<a name="l13784"></a>13784     },
<a name="l13785"></a>13785   },
<a name="l13786"></a>13786   <span class="stringliteral">&#39;fakeimaphost&#39;</span>: {
<a name="l13787"></a>13787     type: <span class="stringliteral">&#39;imap+smtp&#39;</span>,
<a name="l13788"></a>13788     incoming: {
<a name="l13789"></a>13789       hostname: <span class="stringliteral">&#39;localhost&#39;</span>,
<a name="l13790"></a>13790       <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: 0,
<a name="l13791"></a>13791       socketType: <span class="stringliteral">&#39;plain&#39;</span>,
<a name="l13792"></a>13792       username: <span class="stringliteral">&#39;%EMAILLOCALPART%&#39;</span>,
<a name="l13793"></a>13793     },
<a name="l13794"></a>13794     outgoing: {
<a name="l13795"></a>13795       hostname: <span class="stringliteral">&#39;localhost&#39;</span>,
<a name="l13796"></a>13796       <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: 0,
<a name="l13797"></a>13797       socketType: <span class="stringliteral">&#39;plain&#39;</span>,
<a name="l13798"></a>13798       username: <span class="stringliteral">&#39;%EMAILLOCALPART%&#39;</span>,
<a name="l13799"></a>13799     },
<a name="l13800"></a>13800   },
<a name="l13801"></a>13801   <span class="stringliteral">&#39;slocalhost&#39;</span>: {
<a name="l13802"></a>13802     type: <span class="stringliteral">&#39;imap+smtp&#39;</span>,
<a name="l13803"></a>13803     incoming: {
<a name="l13804"></a>13804       hostname: <span class="stringliteral">&#39;localhost&#39;</span>,
<a name="l13805"></a>13805       <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: 993,
<a name="l13806"></a>13806       socketType: <span class="stringliteral">&#39;SSL&#39;</span>,
<a name="l13807"></a>13807       username: <span class="stringliteral">&#39;%EMAILLOCALPART%&#39;</span>,
<a name="l13808"></a>13808     },
<a name="l13809"></a>13809     outgoing: {
<a name="l13810"></a>13810       hostname: <span class="stringliteral">&#39;localhost&#39;</span>,
<a name="l13811"></a>13811       <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>: 465,
<a name="l13812"></a>13812       socketType: <span class="stringliteral">&#39;SSL&#39;</span>,
<a name="l13813"></a>13813       username: <span class="stringliteral">&#39;%EMAILLOCALPART%&#39;</span>,
<a name="l13814"></a>13814     },
<a name="l13815"></a>13815   },
<a name="l13816"></a>13816   <span class="stringliteral">&#39;fakeashost&#39;</span>: {
<a name="l13817"></a>13817     type: <span class="stringliteral">&#39;activesync&#39;</span>,
<a name="l13818"></a>13818     displayName: <span class="stringliteral">&#39;Test&#39;</span>,
<a name="l13819"></a>13819     incoming: {
<a name="l13820"></a>13820       <span class="comment">// This string will be clobbered with the correct port number when running</span>
<a name="l13821"></a>13821       <span class="comment">// as a unit test.</span>
<a name="l13822"></a>13822       <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a>: <span class="stringliteral">&#39;http://localhost:8880&#39;</span>,
<a name="l13823"></a>13823       username: <span class="stringliteral">&#39;%EMAILADDRESS%&#39;</span>,
<a name="l13824"></a>13824     },
<a name="l13825"></a>13825   },
<a name="l13826"></a>13826   <span class="comment">// like slocalhost, really just exists to generate a test failure</span>
<a name="l13827"></a>13827   <span class="stringliteral">&#39;saslocalhost&#39;</span>: {
<a name="l13828"></a>13828     type: <span class="stringliteral">&#39;activesync&#39;</span>,
<a name="l13829"></a>13829     displayName: <span class="stringliteral">&#39;Test&#39;</span>,
<a name="l13830"></a>13830     incoming: {
<a name="l13831"></a>13831       <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a>: <span class="stringliteral">&#39;https://localhost:443&#39;</span>,
<a name="l13832"></a>13832       username: <span class="stringliteral">&#39;%EMAILADDRESS%&#39;</span>,
<a name="l13833"></a>13833     },
<a name="l13834"></a>13834   },
<a name="l13835"></a>13835   <span class="comment">// Mapping for a nonexistent domain for testing a bad domain without it being</span>
<a name="l13836"></a>13836   <span class="comment">// detected ahead of time by the autoconfiguration logic or otherwise.</span>
<a name="l13837"></a>13837   <span class="stringliteral">&#39;nonesuch.nonesuch&#39;</span>: {
<a name="l13838"></a>13838     type: <span class="stringliteral">&#39;imap+smtp&#39;</span>,
<a name="l13839"></a>13839     imapHost: <span class="stringliteral">&#39;nonesuch.nonesuch&#39;</span>,
<a name="l13840"></a>13840     imapPort: 993,
<a name="l13841"></a>13841     imapCrypto: <span class="keyword">true</span>,
<a name="l13842"></a>13842     smtpHost: <span class="stringliteral">&#39;nonesuch.nonesuch&#39;</span>,
<a name="l13843"></a>13843     smtpPort: 465,
<a name="l13844"></a>13844     smtpCrypto: <span class="keyword">true</span>,
<a name="l13845"></a>13845     usernameIsFullEmail: <span class="keyword">false</span>,
<a name="l13846"></a>13846   },
<a name="l13847"></a>13847 };
<a name="l13848"></a>13848 
<a name="l13857"></a>13857 <span class="keyword">function</span> recreateIdentities(universe, accountId, oldIdentities) {
<a name="l13858"></a>13858   var identities = [];
<a name="l13859"></a>13859   <span class="keywordflow">for</span> (var iter in Iterator(oldIdentities)) {
<a name="l13860"></a>13860     var oldIdentity = iter[1];
<a name="l13861"></a>13861     identities.push({
<a name="l13862"></a>13862       <span class="keywordtype">id</span>: accountId + <span class="charliteral">&#39;/&#39;</span> + $a64.encodeInt(universe.config.nextIdentityNum++),
<a name="l13863"></a>13863       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: oldIdentity.name,
<a name="l13864"></a>13864       <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: oldIdentity.address,
<a name="l13865"></a>13865       replyTo: oldIdentity.replyTo,
<a name="l13866"></a>13866       signature: oldIdentity.signature,
<a name="l13867"></a>13867     });
<a name="l13868"></a>13868   }
<a name="l13869"></a>13869   <span class="keywordflow">return</span> identities;
<a name="l13870"></a>13870 }
<a name="l13871"></a>13871 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.recreateIdentities = recreateIdentities;
<a name="l13872"></a>13872 
<a name="l13932"></a>13932 <span class="keyword">function</span> Autoconfigurator(_LOG) {
<a name="l13933"></a>13933   this._LOG = _LOG;
<a name="l13934"></a>13934   this.<a class="code" href="../../da/d32/prio_8h.html#a0f2163507f01dc9bb68ca5c72cacaa34">timeout</a> = AUTOCONFIG_TIMEOUT_MS;
<a name="l13935"></a>13935 }
<a name="l13936"></a>13936 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.Autoconfigurator = Autoconfigurator;
<a name="l13937"></a>13937 Autoconfigurator.prototype = {
<a name="l13952"></a>13952   _fatalErrors: [<span class="stringliteral">&#39;bad-user-or-pass&#39;</span>, <span class="stringliteral">&#39;not-authorized&#39;</span>],
<a name="l13953"></a>13953 
<a name="l13961"></a>13961   _isSuccessOrFatal: <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
<a name="l13962"></a>13962     <span class="keywordflow">return</span> !error || this._fatalErrors.indexOf(error) !== -1;
<a name="l13963"></a>13963   },
<a name="l13964"></a>13964 
<a name="l13965"></a>13965   <span class="comment">// XXX: Go through these functions and make sure the callbacks provide</span>
<a name="l13966"></a>13966   <span class="comment">// sufficiently useful error strings.</span>
<a name="l13967"></a>13967 
<a name="l13976"></a>13976   _getXmlConfig: <span class="keyword">function</span> getXmlConfig(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, callback) {
<a name="l13977"></a>13977     var <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a> = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a2619068a621e6b22d7995161b2cea021">XMLHttpRequest</a>({mozSystem: <span class="keyword">true</span>});
<a name="l13978"></a>13978     xhr.open(<span class="stringliteral">&#39;GET&#39;</span>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, <span class="keyword">true</span>);
<a name="l13979"></a>13979     xhr.timeout = this.<a class="code" href="../../da/d32/prio_8h.html#a0f2163507f01dc9bb68ca5c72cacaa34">timeout</a>;
<a name="l13980"></a>13980 
<a name="l13981"></a>13981     xhr.onload = <span class="keyword">function</span>() {
<a name="l13982"></a>13982       <span class="keywordflow">if</span> (xhr.status &lt; 200 || xhr.status &gt;= 300) {
<a name="l13983"></a>13983         <span class="comment">// Non-fatal failure to get the config info.  While a 404 is the</span>
<a name="l13984"></a>13984         <span class="comment">// expected case, this is the appropriate error for weirder cases too.</span>
<a name="l13985"></a>13985         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;no-config-info&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: xhr.status });
<a name="l13986"></a>13986         <span class="keywordflow">return</span>;
<a name="l13987"></a>13987       }
<a name="l13988"></a>13988       <span class="comment">// XXX: For reasons which are currently unclear (possibly a platform</span>
<a name="l13989"></a>13989       <span class="comment">// issue), trying to use responseXML results in a SecurityError when</span>
<a name="l13990"></a>13990       <span class="comment">// running XPath queries. So let&#39;s just do an end-run around the</span>
<a name="l13991"></a>13991       <span class="comment">// &quot;security&quot;.</span>
<a name="l13992"></a>13992       <span class="keyword">self</span>.postMessage({
<a name="l13993"></a>13993         uid: 0,
<a name="l13994"></a>13994         type: <span class="stringliteral">&#39;configparser&#39;</span>,
<a name="l13995"></a>13995         cmd: <span class="stringliteral">&#39;accountcommon&#39;</span>,
<a name="l13996"></a>13996         args: [xhr.responseText]
<a name="l13997"></a>13997       });
<a name="l13998"></a>13998 
<a name="l13999"></a>13999       <span class="keyword">self</span>.addEventListener(<span class="stringliteral">&#39;message&#39;</span>, <span class="keyword">function</span> onworkerresponse(evt) {
<a name="l14000"></a>14000         var data = evt.data;
<a name="l14001"></a>14001         <span class="keywordflow">if</span> (data.type != <span class="stringliteral">&#39;configparser&#39;</span> || data.cmd != <span class="stringliteral">&#39;accountcommon&#39;</span>) {
<a name="l14002"></a>14002           <span class="keywordflow">return</span>;
<a name="l14003"></a>14003         }
<a name="l14004"></a>14004         <span class="keyword">self</span>.removeEventListener(evt.type, onworkerresponse);
<a name="l14005"></a>14005         var args = data.args;
<a name="l14006"></a>14006         var <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a> = args[0], <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a> = args[1];
<a name="l14007"></a>14007         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(config ? <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> : <span class="stringliteral">&#39;no-config-info&#39;</span>, config,
<a name="l14008"></a>14008                  config ? null : { status: status });
<a name="l14009"></a>14009       });
<a name="l14010"></a>14010     };
<a name="l14011"></a>14011 
<a name="l14012"></a>14012     xhr.ontimeout = xhr.onerror = <span class="keyword">function</span>() {
<a name="l14013"></a>14013       <span class="comment">// The effective result is a failure to get configuration info, but make</span>
<a name="l14014"></a>14014       <span class="comment">// sure the status conveys that a timeout occurred.</span>
<a name="l14015"></a>14015       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;no-config-info&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: <span class="stringliteral">&#39;timeout&#39;</span> });
<a name="l14016"></a>14016     };
<a name="l14017"></a>14017     xhr.onerror = <span class="keyword">function</span>() {
<a name="l14018"></a>14018       <span class="comment">// The effective result is a failure to get configuration info, but make</span>
<a name="l14019"></a>14019       <span class="comment">// sure the status conveys that a timeout occurred.</span>
<a name="l14020"></a>14020       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;no-config-info&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: <span class="stringliteral">&#39;error&#39;</span> });
<a name="l14021"></a>14021     };
<a name="l14022"></a>14022 
<a name="l14023"></a>14023     <span class="comment">// Gecko currently throws in send() if the file we&#39;re opening doesn&#39;t exist.</span>
<a name="l14024"></a>14024     <span class="comment">// This is almost certainly wrong, but let&#39;s just work around it for now.</span>
<a name="l14025"></a>14025     <span class="keywordflow">try</span> {
<a name="l14026"></a>14026       xhr.send();
<a name="l14027"></a>14027     }
<a name="l14028"></a>14028     <span class="keywordflow">catch</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l14029"></a>14029       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;no-config-info&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: 404 });
<a name="l14030"></a>14030     }
<a name="l14031"></a>14031   },
<a name="l14032"></a>14032 
<a name="l14040"></a>14040   _getConfigFromLocalFile: <span class="keyword">function</span> getConfigFromLocalFile(domain, callback) {
<a name="l14041"></a>14041     this._getXmlConfig(<span class="stringliteral">&#39;/autoconfig/&#39;</span> + encodeURIComponent(domain), callback);
<a name="l14042"></a>14042   },
<a name="l14043"></a>14043 
<a name="l14052"></a>14052   _getConfigFromAutodiscover: <span class="keyword">function</span> getConfigFromAutodiscover(userDetails,
<a name="l14053"></a>14053                                                                  callback) {
<a name="l14054"></a>14054 
<a name="l14055"></a>14055     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l14056"></a>14056     <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;activesync/protocol&#39;</span>], <span class="keyword">function</span> (protocol) {
<a name="l14057"></a>14057       protocol.autodiscover(userDetails.emailAddress, userDetails.password,
<a name="l14058"></a>14058                             <span class="keyword">self</span>.timeout, <span class="keyword">function</span>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>) {
<a name="l14059"></a>14059         <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (error) {
<a name="l14060"></a>14060           var failureType = <span class="stringliteral">&#39;no-config-info&#39;</span>,
<a name="l14061"></a>14061               failureDetails = {};
<a name="l14062"></a>14062 
<a name="l14063"></a>14063           <span class="keywordflow">if</span> (error instanceof protocol.HttpError) {
<a name="l14064"></a>14064             <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (error.status === 401)
<a name="l14065"></a>14065               failureType = <span class="stringliteral">&#39;bad-user-or-pass&#39;</span>;
<a name="l14066"></a>14066             <span class="keywordflow">else</span> <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (error.status === 403)
<a name="l14067"></a>14067               failureType = <span class="stringliteral">&#39;not-authorized&#39;</span>;
<a name="l14068"></a>14068             <span class="keywordflow">else</span>
<a name="l14069"></a>14069               failureDetails.status = error.status;
<a name="l14070"></a>14070           }
<a name="l14071"></a>14071           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(failureType, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, failureDetails);
<a name="l14072"></a>14072           <span class="keywordflow">return</span>;
<a name="l14073"></a>14073         }
<a name="l14074"></a>14074 
<a name="l14075"></a>14075         var autoconfig = {
<a name="l14076"></a>14076           type: <span class="stringliteral">&#39;activesync&#39;</span>,
<a name="l14077"></a>14077           displayName: <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.user.name,
<a name="l14078"></a>14078           incoming: {
<a name="l14079"></a>14079             <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a>: <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.mobileSyncServer.url,
<a name="l14080"></a>14080             username: <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.user.email
<a name="l14081"></a>14081           },
<a name="l14082"></a>14082         };
<a name="l14083"></a>14083         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, autoconfig, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l14084"></a>14084       });
<a name="l14085"></a>14085     });
<a name="l14086"></a>14086   },
<a name="l14087"></a>14087 
<a name="l14098"></a>14098   _getConfigFromDomain: <span class="keyword">function</span> getConfigFromDomain(userDetails, domain,
<a name="l14099"></a>14099                                                      callback) {
<a name="l14100"></a>14100     var suffix = <span class="stringliteral">&#39;/mail/config-v1.1.xml?emailaddress=&#39;</span> +
<a name="l14101"></a>14101                  encodeURIComponent(userDetails.emailAddress);
<a name="l14102"></a>14102     var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> = <span class="stringliteral">&#39;http://autoconfig.&#39;</span> + domain + suffix;
<a name="l14103"></a>14103     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l14104"></a>14104 
<a name="l14105"></a>14105     this._getXmlConfig(url, <span class="keyword">function</span>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails) {
<a name="l14106"></a>14106       <span class="keywordflow">if</span> (<span class="keyword">self</span>._isSuccessOrFatal(error)) {
<a name="l14107"></a>14107         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails);
<a name="l14108"></a>14108         <span class="keywordflow">return</span>;
<a name="l14109"></a>14109       }
<a name="l14110"></a>14110 
<a name="l14111"></a>14111       <span class="comment">// See &lt;http://tools.ietf.org/html/draft-nottingham-site-meta-04&gt;.</span>
<a name="l14112"></a>14112       var url = <span class="stringliteral">&#39;http://&#39;</span> + domain + <span class="stringliteral">&#39;/.well-known/autoconfig&#39;</span> + suffix;
<a name="l14113"></a>14113       <span class="keyword">self</span>._getXmlConfig(url, callback);
<a name="l14114"></a>14114     });
<a name="l14115"></a>14115   },
<a name="l14116"></a>14116 
<a name="l14124"></a>14124   _getConfigFromDB: <span class="keyword">function</span> getConfigFromDB(domain, callback) {
<a name="l14125"></a>14125     this._getXmlConfig(<span class="stringliteral">&#39;https://live.mozillamessaging.com/autoconfig/v1.1/&#39;</span> +
<a name="l14126"></a>14126                        encodeURIComponent(domain), callback);
<a name="l14127"></a>14127   },
<a name="l14128"></a>14128 
<a name="l14137"></a>14137   _getMX: <span class="keyword">function</span> getMX(domain, callback) {
<a name="l14138"></a>14138     var xhr = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a2619068a621e6b22d7995161b2cea021">XMLHttpRequest</a>({mozSystem: <span class="keyword">true</span>});
<a name="l14139"></a>14139     xhr.open(<span class="stringliteral">&#39;GET&#39;</span>, <span class="stringliteral">&#39;https://live.mozillamessaging.com/dns/mx/&#39;</span> +
<a name="l14140"></a>14140              encodeURIComponent(domain), <span class="keyword">true</span>);
<a name="l14141"></a>14141     xhr.timeout = this.<a class="code" href="../../da/d32/prio_8h.html#a0f2163507f01dc9bb68ca5c72cacaa34">timeout</a>;
<a name="l14142"></a>14142 
<a name="l14143"></a>14143     xhr.onload = <span class="keyword">function</span>() {
<a name="l14144"></a>14144       <span class="keywordflow">if</span> (xhr.status === 200)
<a name="l14145"></a>14145         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, xhr.responseText.split(<span class="charliteral">&#39;\n&#39;</span>)[0], <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l14146"></a>14146       <span class="keywordflow">else</span>
<a name="l14147"></a>14147         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;no-config-info&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: <span class="stringliteral">&#39;mx&#39;</span> + xhr.status });
<a name="l14148"></a>14148     };
<a name="l14149"></a>14149 
<a name="l14150"></a>14150     xhr.ontimeout = <span class="keyword">function</span>() {
<a name="l14151"></a>14151       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;no-config-info&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: <span class="stringliteral">&#39;mxtimeout&#39;</span> });
<a name="l14152"></a>14152     };
<a name="l14153"></a>14153     xhr.onerror = <span class="keyword">function</span>() {
<a name="l14154"></a>14154       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;no-config-info&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: <span class="stringliteral">&#39;mxerror&#39;</span> });
<a name="l14155"></a>14155     };
<a name="l14156"></a>14156 
<a name="l14157"></a>14157     xhr.send();
<a name="l14158"></a>14158   },
<a name="l14159"></a>14159 
<a name="l14168"></a>14168   _getConfigFromMX: <span class="keyword">function</span> getConfigFromMX(domain, callback) {
<a name="l14169"></a>14169     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l14170"></a>14170     this._getMX(domain, <span class="keyword">function</span>(error, mxDomain, errorDetails) {
<a name="l14171"></a>14171       <span class="keywordflow">if</span> (error)
<a name="l14172"></a>14172         <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(error, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, errorDetails);
<a name="l14173"></a>14173 
<a name="l14174"></a>14174       <span class="comment">// XXX: We need to normalize the domain here to get the base domain, but</span>
<a name="l14175"></a>14175       <span class="comment">// that&#39;s complicated because people like putting dots in TLDs. For now,</span>
<a name="l14176"></a>14176       <span class="comment">// let&#39;s just pretend no one would do such a horrible thing.</span>
<a name="l14177"></a>14177       mxDomain = mxDomain.split(<span class="charliteral">&#39;.&#39;</span>).slice(-2).join(<span class="charliteral">&#39;.&#39;</span>).toLowerCase();
<a name="l14178"></a>14178       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Found MX for&#39;</span>, mxDomain);
<a name="l14179"></a>14179 
<a name="l14180"></a>14180       <span class="keywordflow">if</span> (domain === mxDomain)
<a name="l14181"></a>14181         <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;no-config-info&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>: <span class="stringliteral">&#39;mxsame&#39;</span> });
<a name="l14182"></a>14182 
<a name="l14183"></a>14183       <span class="comment">// If we found a different domain after MX lookup, we should look in our</span>
<a name="l14184"></a>14184       <span class="comment">// local file store (mostly to support Google Apps domains) and, if that</span>
<a name="l14185"></a>14185       <span class="comment">// doesn&#39;t work, the Mozilla ISPDB.</span>
<a name="l14186"></a>14186       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Looking in local file store&#39;</span>);
<a name="l14187"></a>14187       <span class="keyword">self</span>._getConfigFromLocalFile(mxDomain, <span class="keyword">function</span>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>,
<a name="l14188"></a>14188                                                       errorDetails) {
<a name="l14189"></a>14189         <span class="comment">// (Local XML lookup should not have any fatal errors)</span>
<a name="l14190"></a>14190         <span class="keywordflow">if</span> (!error) {
<a name="l14191"></a>14191           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails);
<a name="l14192"></a>14192           <span class="keywordflow">return</span>;
<a name="l14193"></a>14193         }
<a name="l14194"></a>14194 
<a name="l14195"></a>14195         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Looking in the Mozilla ISPDB&#39;</span>);
<a name="l14196"></a>14196         <span class="keyword">self</span>._getConfigFromDB(mxDomain, callback);
<a name="l14197"></a>14197       });
<a name="l14198"></a>14198     });
<a name="l14199"></a>14199   },
<a name="l14200"></a>14200 
<a name="l14210"></a>14210   getConfig: <span class="keyword">function</span> getConfig(userDetails, callback) {
<a name="l14211"></a>14211     var details = userDetails.emailAddress.split(<span class="charliteral">&#39;@&#39;</span>);
<a name="l14212"></a>14212     var emailLocalPart = details[0], emailDomainPart = details[1];
<a name="l14213"></a>14213     var domain = emailDomainPart.toLowerCase();
<a name="l14214"></a>14214     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Attempting to get autoconfiguration for&#39;</span>, domain);
<a name="l14215"></a>14215 
<a name="l14216"></a>14216     var placeholderFields = {
<a name="l14217"></a>14217       incoming: [<span class="stringliteral">&#39;username&#39;</span>, <span class="stringliteral">&#39;hostname&#39;</span>, <span class="stringliteral">&#39;server&#39;</span>],
<a name="l14218"></a>14218       outgoing: [<span class="stringliteral">&#39;username&#39;</span>, <span class="stringliteral">&#39;hostname&#39;</span>],
<a name="l14219"></a>14219     };
<a name="l14220"></a>14220 
<a name="l14221"></a>14221     <span class="keyword">function</span> fillPlaceholder(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>) {
<a name="l14222"></a>14222       <span class="keywordflow">return</span> <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>.replace(<span class="stringliteral">&#39;%EMAILADDRESS%&#39;</span>, userDetails.emailAddress)
<a name="l14223"></a>14223                   .replace(<span class="stringliteral">&#39;%EMAILLOCALPART%&#39;</span>, emailLocalPart)
<a name="l14224"></a>14224                   .replace(<span class="stringliteral">&#39;%EMAILDOMAIN%&#39;</span>, emailDomainPart)
<a name="l14225"></a>14225                   .replace(<span class="stringliteral">&#39;%REALNAME%&#39;</span>, userDetails.displayName);
<a name="l14226"></a>14226     }
<a name="l14227"></a>14227 
<a name="l14228"></a>14228     <span class="comment">// Saved autodiscover errors that we report in the event we come to the</span>
<a name="l14229"></a>14229     <span class="comment">// end of the process and we failed to create an account.</span>
<a name="l14230"></a>14230     var autodiscoverError = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, autodiscoverErrorDetails = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l14231"></a>14231 
<a name="l14232"></a>14232     <span class="keyword">function</span> onComplete(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails) {
<a name="l14233"></a>14233       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(error ? <span class="stringliteral">&#39;FAILURE&#39;</span> : <span class="stringliteral">&#39;SUCCESS&#39;</span>);
<a name="l14234"></a>14234 
<a name="l14235"></a>14235       <span class="comment">// Fill any placeholder strings in the configuration object we retrieved.</span>
<a name="l14236"></a>14236       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>) {
<a name="l14237"></a>14237         <span class="keywordflow">for</span> (var iter in Iterator(placeholderFields)) {
<a name="l14238"></a>14238           var serverType = iter[0], fields = iter[1];
<a name="l14239"></a>14239           <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.hasOwnProperty(serverType))
<a name="l14240"></a>14240             <span class="keywordflow">continue</span>;
<a name="l14241"></a>14241 
<a name="l14242"></a>14242           var <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a> = <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>[serverType];
<a name="l14243"></a>14243           <span class="keywordflow">for</span> (var iter2 in Iterator(fields)) {
<a name="l14244"></a>14244             var field = iter2[1];
<a name="l14245"></a>14245             <span class="keywordflow">if</span> (server.hasOwnProperty(field))
<a name="l14246"></a>14246               server[field] = fillPlaceholder(server[field]);
<a name="l14247"></a>14247           }
<a name="l14248"></a>14248         }
<a name="l14249"></a>14249       }
<a name="l14250"></a>14250 
<a name="l14251"></a>14251       <span class="comment">// If we had a saved autodiscover error, report that instead of whatever</span>
<a name="l14252"></a>14252       <span class="comment">// happened in the subsequent ISPDB stages.</span>
<a name="l14253"></a>14253       <span class="keywordflow">if</span> (error &amp;&amp; autodiscoverError) {
<a name="l14254"></a>14254         error = autodiscoverError;
<a name="l14255"></a>14255         errorDetails = autodiscoverErrorDetails;
<a name="l14256"></a>14256       }
<a name="l14257"></a>14257 
<a name="l14258"></a>14258       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails);
<a name="l14259"></a>14259     }
<a name="l14260"></a>14260 
<a name="l14261"></a>14261     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Looking in GELAM&#39;</span>);
<a name="l14262"></a>14262     <span class="keywordflow">if</span> (autoconfigByDomain.hasOwnProperty(domain)) {
<a name="l14263"></a>14263       onComplete(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, autoconfigByDomain[domain]);
<a name="l14264"></a>14264       <span class="keywordflow">return</span>;
<a name="l14265"></a>14265     }
<a name="l14266"></a>14266 
<a name="l14267"></a>14267     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l14268"></a>14268     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Looking in local file store&#39;</span>);
<a name="l14269"></a>14269     this._getConfigFromLocalFile(domain, <span class="keyword">function</span>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails) {
<a name="l14270"></a>14270       <span class="keywordflow">if</span> (<span class="keyword">self</span>._isSuccessOrFatal(error)) {
<a name="l14271"></a>14271         onComplete(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails);
<a name="l14272"></a>14272         <span class="keywordflow">return</span>;
<a name="l14273"></a>14273       }
<a name="l14274"></a>14274 
<a name="l14275"></a>14275       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Looking at domain (Thunderbird autoconfig standard)&#39;</span>);
<a name="l14276"></a>14276       <span class="keyword">self</span>._getConfigFromDomain(userDetails, domain, <span class="keyword">function</span>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>,
<a name="l14277"></a>14277                                                               errorDetails) {
<a name="l14278"></a>14278         <span class="keywordflow">if</span> (<span class="keyword">self</span>._isSuccessOrFatal(error)) {
<a name="l14279"></a>14279           onComplete(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails);
<a name="l14280"></a>14280           <span class="keywordflow">return</span>;
<a name="l14281"></a>14281         }
<a name="l14282"></a>14282 
<a name="l14283"></a>14283         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Trying ActiveSync domain autodiscover&#39;</span>);
<a name="l14284"></a>14284         <span class="keyword">self</span>._getConfigFromAutodiscover(userDetails, <span class="keyword">function</span>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>,
<a name="l14285"></a>14285                                                               errorDetails) {
<a name="l14286"></a>14286           <span class="comment">// We treat ActiveSync autodiscover failures specially because of the</span>
<a name="l14287"></a>14287           <span class="comment">// odd situation documented on</span>
<a name="l14288"></a>14288           <span class="comment">// https://bugzilla.mozilla.org/show_bug.cgi?id=921529 where</span>
<a name="l14289"></a>14289           <span class="comment">// t-mobile.de has ActiveSync and IMAP servers, but the ActiveSync</span>
<a name="l14290"></a>14290           <span class="comment">// server use costs extra and the autodiscover process was stopping us</span>
<a name="l14291"></a>14291           <span class="comment">// before we&#39;d try IMAP.</span>
<a name="l14292"></a>14292 
<a name="l14293"></a>14293           <span class="comment">// So, if there was no error, go directly to success.</span>
<a name="l14294"></a>14294           <span class="keywordflow">if</span> (!error) {
<a name="l14295"></a>14295             onComplete(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails);
<a name="l14296"></a>14296             <span class="keywordflow">return</span>;
<a name="l14297"></a>14297           }
<a name="l14298"></a>14298           <span class="comment">// Otherwise, save off the error if it was &#39;not-authorized&#39; and</span>
<a name="l14299"></a>14299           <span class="comment">// continue the autoconfig process.  We will clobber *whatever* error</span>
<a name="l14300"></a>14300           <span class="comment">// is reported with these errors if we fail to create the account.</span>
<a name="l14301"></a>14301           <span class="comment">// The rationale/discussion is at:</span>
<a name="l14302"></a>14302           <span class="comment">// https://bugzilla.mozilla.org/show_bug.cgi?id=921529#c3</span>
<a name="l14303"></a>14303           <span class="keywordflow">if</span> (error === <span class="stringliteral">&#39;not-authorized&#39;</span>) {
<a name="l14304"></a>14304             autodiscoverError = <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>;
<a name="l14305"></a>14305             autodiscoverErrorDetails = errorDetails;
<a name="l14306"></a>14306           }
<a name="l14307"></a>14307           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">self</span>._isSuccessOrFatal(error)) {
<a name="l14308"></a>14308             onComplete(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails);
<a name="l14309"></a>14309             <span class="keywordflow">return</span>;
<a name="l14310"></a>14310           }
<a name="l14311"></a>14311 
<a name="l14312"></a>14312           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Looking in the Mozilla ISPDB&#39;</span>);
<a name="l14313"></a>14313           <span class="keyword">self</span>._getConfigFromDB(domain, <span class="keyword">function</span>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails) {
<a name="l14314"></a>14314             <span class="keywordflow">if</span> (<span class="keyword">self</span>._isSuccessOrFatal(error)) {
<a name="l14315"></a>14315               onComplete(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails);
<a name="l14316"></a>14316               <span class="keywordflow">return</span>;
<a name="l14317"></a>14317             }
<a name="l14318"></a>14318 
<a name="l14319"></a>14319             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;  Looking up MX&#39;</span>);
<a name="l14320"></a>14320             <span class="keyword">self</span>._getConfigFromMX(domain, onComplete);
<a name="l14321"></a>14321           });
<a name="l14322"></a>14322         });
<a name="l14323"></a>14323       });
<a name="l14324"></a>14324     });
<a name="l14325"></a>14325   },
<a name="l14326"></a>14326 
<a name="l14338"></a>14338   tryToCreateAccount: <span class="keyword">function</span>(universe, userDetails, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l14339"></a>14339     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l14340"></a>14340     this.getConfig(userDetails, <span class="keyword">function</span>(error, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, errorDetails) {
<a name="l14341"></a>14341       <span class="keywordflow">if</span> (error)
<a name="l14342"></a>14342         <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(error, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, errorDetails);
<a name="l14343"></a>14343 
<a name="l14344"></a>14344       <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([Configurators[<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.type]], <a class="code" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> (mod) {
<a name="l14345"></a>14345         mod.configurator.tryToCreateAccount(universe, userDetails, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>,
<a name="l14346"></a>14346                                       callback, <span class="keyword">self</span>._LOG);
<a name="l14347"></a>14347       });
<a name="l14348"></a>14348     });
<a name="l14349"></a>14349   },
<a name="l14350"></a>14350 };
<a name="l14351"></a>14351 
<a name="l14361"></a>14361 <span class="keyword">function</span> recreateAccount(universe, oldVersion, accountInfo, callback) {
<a name="l14362"></a>14362   <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([Configurators[accountInfo.def.type]], <a class="code" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> (mod) {
<a name="l14363"></a>14363     mod.configurator.recreateAccount(universe, oldVersion,
<a name="l14364"></a>14364                                      accountInfo, callback);
<a name="l14365"></a>14365   });
<a name="l14366"></a>14366 }
<a name="l14367"></a>14367 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.recreateAccount = recreateAccount;
<a name="l14368"></a>14368 
<a name="l14369"></a>14369 <span class="keyword">function</span> tryToManuallyCreateAccount(universe, userDetails, domainInfo, callback,
<a name="l14370"></a>14370                                     _LOG) {
<a name="l14371"></a>14371   <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([Configurators[domainInfo.type]], <a class="code" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> (mod) {
<a name="l14372"></a>14372     mod.configurator.tryToCreateAccount(universe, userDetails, domainInfo,
<a name="l14373"></a>14373                                         callback, _LOG);
<a name="l14374"></a>14374   });
<a name="l14375"></a>14375 }
<a name="l14376"></a>14376 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.tryToManuallyCreateAccount = tryToManuallyCreateAccount;
<a name="l14377"></a>14377 
<a name="l14378"></a>14378 }); <span class="comment">// end define</span>
<a name="l14379"></a>14379 ;
<a name="l14383"></a>14383 <span class="comment">/*global define, console, window, Blob */</span>
<a name="l14384"></a>14384 
<a name="l14385"></a>14385 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/mailuniverse&#39;</span>,
<a name="l14386"></a>14386   [
<a name="l14387"></a>14387     <span class="stringliteral">&#39;rdcommon/log&#39;</span>,
<a name="l14388"></a>14388     <span class="stringliteral">&#39;rdcommon/logreaper&#39;</span>,
<a name="l14389"></a>14389     <span class="stringliteral">&#39;./a64&#39;</span>,
<a name="l14390"></a>14390     <span class="stringliteral">&#39;./syncbase&#39;</span>,
<a name="l14391"></a>14391     <span class="stringliteral">&#39;./worker-router&#39;</span>,
<a name="l14392"></a>14392     <span class="stringliteral">&#39;./maildb&#39;</span>,
<a name="l14393"></a>14393     <span class="stringliteral">&#39;./cronsync&#39;</span>,
<a name="l14394"></a>14394     <span class="stringliteral">&#39;./accountcommon&#39;</span>,
<a name="l14395"></a>14395     <span class="stringliteral">&#39;module&#39;</span>,
<a name="l14396"></a>14396     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l14397"></a>14397   ],
<a name="l14398"></a>14398   <span class="keyword">function</span>(
<a name="l14399"></a>14399     $log,
<a name="l14400"></a>14400     $logreaper,
<a name="l14401"></a>14401     $a64,
<a name="l14402"></a>14402     $syncbase,
<a name="l14403"></a>14403     $router,
<a name="l14404"></a>14404     $maildb,
<a name="l14405"></a>14405     $cronsync,
<a name="l14406"></a>14406     $acctcommon,
<a name="l14407"></a>14407     $module,
<a name="l14408"></a>14408     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l14409"></a>14409   ) {
<a name="l14410"></a>14410 
<a name="l14420"></a>14420 var MAX_MUTATIONS_FOR_UNDO = 10;
<a name="l14421"></a>14421 
<a name="l14426"></a>14426 var MAX_LOG_BACKLOG = 30;
<a name="l14427"></a>14427 
<a name="l14436"></a>14436 <span class="keyword">function</span> makeBridgeFn(bridgeMethod) {
<a name="l14437"></a>14437   <span class="keywordflow">return</span> <span class="keyword">function</span>(a1, a2, a3) {
<a name="l14438"></a>14438     <span class="keywordflow">for</span> (var iBridge = 0; iBridge &lt; this._bridges.length; iBridge++) {
<a name="l14439"></a>14439       var bridge = this._bridges[iBridge];
<a name="l14440"></a>14440       bridge[bridgeMethod](a1, a2, a3);
<a name="l14441"></a>14441     }
<a name="l14442"></a>14442   };
<a name="l14443"></a>14443 }
<a name="l14444"></a>14444 
<a name="l14674"></a>14674 <span class="keyword">function</span> MailUniverse(callAfterBigBang, online, testOptions) {
<a name="l14676"></a>14676   this.accounts = [];
<a name="l14677"></a>14677   this._accountsById = {};
<a name="l14678"></a>14678 
<a name="l14680"></a>14680   this.identities = [];
<a name="l14681"></a>14681   this._identitiesById = {};
<a name="l14682"></a>14682 
<a name="l14711"></a>14711   this._opsByAccount = {};
<a name="l14712"></a>14712   <span class="comment">// populated by waitForAccountOps, invoked when all ops complete</span>
<a name="l14713"></a>14713   this._opCompletionListenersByAccount = {};
<a name="l14714"></a>14714   <span class="comment">// maps longtermId to a callback that cares. non-persisted.</span>
<a name="l14715"></a>14715   this._opCallbacks = {};
<a name="l14716"></a>14716 
<a name="l14717"></a>14717   this._bridges = [];
<a name="l14718"></a>14718 
<a name="l14719"></a>14719   this._testModeDisablingLocalOps = <span class="keyword">false</span>;
<a name="l14721"></a>14721   this._testModeFakeNavigator = (testOptions &amp;&amp; testOptions.fakeNavigator) ||
<a name="l14722"></a>14722                                 <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l14723"></a>14723 
<a name="l14724"></a>14724   <span class="comment">// We used to try and use navigator.connection, but it&#39;s not supported on B2G,</span>
<a name="l14725"></a>14725   <span class="comment">// so we have to use navigator.onLine like suckers.</span>
<a name="l14726"></a>14726   this.online = <span class="keyword">true</span>; <span class="comment">// just so we don&#39;t cause an offline-&gt;online transition</span>
<a name="l14727"></a>14727   <span class="comment">// Events for online/offline are now pushed into us externally.  They need</span>
<a name="l14728"></a>14728   <span class="comment">// to be bridged from the main thread anyways, so no point faking the event</span>
<a name="l14729"></a>14729   <span class="comment">// listener.</span>
<a name="l14730"></a>14730   this._onConnectionChange(online);
<a name="l14731"></a>14731 
<a name="l14732"></a>14732   <span class="comment">// Track the mode of the universe. Values are:</span>
<a name="l14733"></a>14733   <span class="comment">// &#39;cron&#39;: started up in background to do tasks like sync.</span>
<a name="l14734"></a>14734   <span class="comment">// &#39;interactive&#39;: at some point during its life, it was used to</span>
<a name="l14735"></a>14735   <span class="comment">// provide functionality to a user interface. Once it goes</span>
<a name="l14736"></a>14736   <span class="comment">// &#39;interactive&#39;, it cannot switch back to &#39;cron&#39;.</span>
<a name="l14737"></a>14737   this._mode = <span class="stringliteral">&#39;cron&#39;</span>;
<a name="l14738"></a>14738 
<a name="l14743"></a>14743   this._deferredOpTimeout = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l14744"></a>14744   this._boundQueueDeferredOps = this._queueDeferredOps.bind(<span class="keyword">this</span>);
<a name="l14745"></a>14745 
<a name="l14746"></a>14746   this.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l14747"></a>14747   this._logReaper = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l14748"></a>14748   this._logBacklog = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l14749"></a>14749 
<a name="l14750"></a>14750   this._LOG = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l14751"></a>14751   this._db = <span class="keyword">new</span> $maildb.MailDB(testOptions);
<a name="l14752"></a>14752   this._cronSync = <span class="keyword">new</span> $cronsync.CronSync(<span class="keyword">this</span>);
<a name="l14753"></a>14753   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l14754"></a>14754   this._db.getConfig(<span class="keyword">function</span>(configObj, accountInfos, lazyCarryover) {
<a name="l14755"></a>14755     <span class="keyword">function</span> setupLogging(<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>) {
<a name="l14756"></a>14756       <span class="keywordflow">if</span> (<span class="keyword">self</span>.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.debugLogging) {
<a name="l14757"></a>14757         <span class="keywordflow">if</span> (<span class="keyword">self</span>.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.debugLogging !== <span class="stringliteral">&#39;dangerous&#39;</span>) {
<a name="l14758"></a>14758           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;GENERAL LOGGING ENABLED!&#39;</span>);
<a name="l14759"></a>14759           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;(CIRCULAR EVENT LOGGING WITH NON-SENSITIVE DATA)&#39;</span>);
<a name="l14760"></a>14760           $log.enableGeneralLogging();
<a name="l14761"></a>14761         }
<a name="l14762"></a>14762         <span class="keywordflow">else</span> {
<a name="l14763"></a>14763           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;</span>);
<a name="l14764"></a>14764           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;DANGEROUS USER-DATA ENTRAINING LOGGING ENABLED !!!&#39;</span>);
<a name="l14765"></a>14765           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#39;</span>);
<a name="l14766"></a>14766           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;This means contents of e-mails and passwords if you&#39;</span>);
<a name="l14767"></a>14767           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;set up a new account.  (The IMAP protocol sanitizes&#39;</span>);
<a name="l14768"></a>14768           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;passwords, but the bridge logger may not.)&#39;</span>);
<a name="l14769"></a>14769           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;...................................................&#39;</span>);
<a name="l14770"></a>14770           $log.DEBUG_markAllFabsUnderTest();
<a name="l14771"></a>14771         }
<a name="l14772"></a>14772       }
<a name="l14773"></a>14773     }
<a name="l14774"></a>14774 
<a name="l14775"></a>14775     var accountInfo, <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l14776"></a>14776     var doneCount = 0;
<a name="l14777"></a>14777     var accountCount = accountInfos.length;
<a name="l14778"></a>14778     <span class="keywordflow">if</span> (configObj) {
<a name="l14779"></a>14779       <span class="keyword">self</span>.config = configObj;
<a name="l14780"></a>14780       setupLogging();
<a name="l14781"></a>14781       <span class="keyword">self</span>._LOG = LOGFAB.MailUniverse(<span class="keyword">self</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l14782"></a>14782       <span class="keywordflow">if</span> (<span class="keyword">self</span>.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.debugLogging)
<a name="l14783"></a>14783         <span class="keyword">self</span>._enableCircularLogging();
<a name="l14784"></a>14784 
<a name="l14785"></a>14785       <span class="keyword">self</span>._LOG.configLoaded(<span class="keyword">self</span>.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, accountInfos);
<a name="l14786"></a>14786 
<a name="l14787"></a>14787       <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>() {
<a name="l14788"></a>14788         doneCount += 1;
<a name="l14789"></a>14789         <span class="keywordflow">if</span> (doneCount === accountCount) {
<a name="l14790"></a>14790           <span class="keyword">self</span>._initFromConfig();
<a name="l14791"></a>14791           callAfterBigBang();
<a name="l14792"></a>14792         }
<a name="l14793"></a>14793       }
<a name="l14794"></a>14794 
<a name="l14795"></a>14795       <span class="keywordflow">if</span> (accountCount) {
<a name="l14796"></a>14796         <span class="keywordflow">for</span> (i = 0; i &lt; accountCount; i++) {
<a name="l14797"></a>14797           accountInfo = accountInfos[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l14798"></a>14798           <span class="keyword">self</span>._loadAccount(accountInfo.def, accountInfo.folderInfo,
<a name="l14799"></a>14799                             <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, done);
<a name="l14800"></a>14800         }
<a name="l14801"></a>14801 
<a name="l14802"></a>14802         <span class="comment">// return since _loadAccount needs to finish before completing</span>
<a name="l14803"></a>14803         <span class="comment">// the flow in done().</span>
<a name="l14804"></a>14804         <span class="keywordflow">return</span>;
<a name="l14805"></a>14805       }
<a name="l14806"></a>14806     }
<a name="l14807"></a>14807     <span class="keywordflow">else</span> {
<a name="l14808"></a>14808       <span class="keyword">self</span>.config = {
<a name="l14809"></a>14809         <span class="comment">// We need to put the id in here because our startup query can&#39;t</span>
<a name="l14810"></a>14810         <span class="comment">// efficiently get both the key name and the value, just the values.</span>
<a name="l14811"></a>14811         <span class="keywordtype">id</span>: <span class="stringliteral">&#39;config&#39;</span>,
<a name="l14812"></a>14812         nextAccountNum: 0,
<a name="l14813"></a>14813         nextIdentityNum: 0,
<a name="l14814"></a>14814         debugLogging: lazyCarryover ? lazyCarryover.config.debugLogging : <span class="keyword">false</span>
<a name="l14815"></a>14815       };
<a name="l14816"></a>14816       setupLogging();
<a name="l14817"></a>14817       <span class="keyword">self</span>._LOG = LOGFAB.MailUniverse(<span class="keyword">self</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l14818"></a>14818       <span class="keywordflow">if</span> (<span class="keyword">self</span>.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.debugLogging)
<a name="l14819"></a>14819         <span class="keyword">self</span>._enableCircularLogging();
<a name="l14820"></a>14820       <span class="keyword">self</span>._db.saveConfig(<span class="keyword">self</span>.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>);
<a name="l14821"></a>14821 
<a name="l14822"></a>14822       <span class="comment">// - Try to re-create any accounts using old account infos.</span>
<a name="l14823"></a>14823       <span class="keywordflow">if</span> (lazyCarryover) {
<a name="l14824"></a>14824         <span class="keyword">self</span>._LOG.configMigrating(lazyCarryover);
<a name="l14825"></a>14825         var waitingCount = lazyCarryover.accountInfos.length;
<a name="l14826"></a>14826         var oldVersion = lazyCarryover.oldVersion;
<a name="l14827"></a>14827         <span class="keywordflow">for</span> (i = 0; i &lt; lazyCarryover.accountInfos.length; i++) {
<a name="l14828"></a>14828           var accountInfo = lazyCarryover.accountInfos[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l14829"></a>14829           $acctcommon.recreateAccount(<span class="keyword">self</span>, oldVersion, accountInfo,
<a name="l14830"></a>14830                                       <span class="keyword">function</span>() {
<a name="l14831"></a>14831             <span class="comment">// We don&#39;t care how they turn out, just that they get a chance</span>
<a name="l14832"></a>14832             <span class="comment">// to run to completion before we call our bootstrap complete.</span>
<a name="l14833"></a>14833             <span class="keywordflow">if</span> (--waitingCount === 0) {
<a name="l14834"></a>14834               <span class="keyword">self</span>._initFromConfig();
<a name="l14835"></a>14835               callAfterBigBang();
<a name="l14836"></a>14836             }
<a name="l14837"></a>14837           });
<a name="l14838"></a>14838         }
<a name="l14839"></a>14839         <span class="comment">// Do not let callAfterBigBang get called.</span>
<a name="l14840"></a>14840         <span class="keywordflow">return</span>;
<a name="l14841"></a>14841       }
<a name="l14842"></a>14842       <span class="keywordflow">else</span> {
<a name="l14843"></a>14843         <span class="keyword">self</span>._LOG.configCreated(<span class="keyword">self</span>.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>);
<a name="l14844"></a>14844       }
<a name="l14845"></a>14845     }
<a name="l14846"></a>14846     <span class="keyword">self</span>._initFromConfig();
<a name="l14847"></a>14847     callAfterBigBang();
<a name="l14848"></a>14848   });
<a name="l14849"></a>14849 }
<a name="l14850"></a>14850 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MailUniverse = MailUniverse;
<a name="l14851"></a>14851 MailUniverse.prototype = {
<a name="l14853"></a>14853   <span class="comment">// Logging</span>
<a name="l14854"></a>14854   _enableCircularLogging: <span class="keyword">function</span>() {
<a name="l14855"></a>14855     this._logReaper = <span class="keyword">new</span> $logreaper.LogReaper(this._LOG);
<a name="l14856"></a>14856     this._logBacklog = [];
<a name="l14857"></a>14857     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setInterval(
<a name="l14858"></a>14858       <span class="keyword">function</span>() {
<a name="l14859"></a>14859         var logTimeSlice = this._logReaper.reapHierLogTimeSlice();
<a name="l14860"></a>14860         <span class="comment">// if nothing interesting happened, this could be empty, yos.</span>
<a name="l14861"></a>14861         <span class="keywordflow">if</span> (logTimeSlice.logFrag) {
<a name="l14862"></a>14862           this._logBacklog.push(logTimeSlice);
<a name="l14863"></a>14863           <span class="comment">// throw something away if we&#39;ve got too much stuff already</span>
<a name="l14864"></a>14864           <span class="keywordflow">if</span> (this._logBacklog.length &gt; MAX_LOG_BACKLOG)
<a name="l14865"></a>14865             this._logBacklog.shift();
<a name="l14866"></a>14866         }
<a name="l14867"></a>14867       }.bind(<span class="keyword">this</span>),
<a name="l14868"></a>14868       1000);
<a name="l14869"></a>14869   },
<a name="l14870"></a>14870 
<a name="l14871"></a>14871   createLogBacklogRep: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>) {
<a name="l14872"></a>14872     <span class="keywordflow">return</span> {
<a name="l14873"></a>14873       type: <span class="stringliteral">&#39;backlog&#39;</span>,
<a name="l14874"></a>14874       <span class="keywordtype">id</span>: <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>,
<a name="l14875"></a>14875       schema: $log.provideSchemaForAllKnownFabs(),
<a name="l14876"></a>14876       <a class="code" href="../../da/d32/prio_8h.html#ace472eba56c6e9d5827066f1dbbfd525">backlog</a>: this._logBacklog,
<a name="l14877"></a>14877     };
<a name="l14878"></a>14878   },
<a name="l14879"></a>14879 
<a name="l14880"></a>14880   dumpLogToDeviceStorage: <span class="keyword">function</span>() {
<a name="l14881"></a>14881     <span class="comment">// This reuses the existing registration if one exists.</span>
<a name="l14882"></a>14882     var sendMessage = $router.registerCallbackType(<span class="stringliteral">&#39;devicestorage&#39;</span>);
<a name="l14883"></a>14883     <span class="keywordflow">try</span> {
<a name="l14884"></a>14884       var blob = <span class="keyword">new</span> <a class="code" href="../../d7/d4b/namespacemozilla_1_1dom.html#a739d106dcb2584188674bb530d99233e">Blob</a>([JSON.stringify(<span class="keyword">this</span>.createLogBacklogRep())],
<a name="l14885"></a>14885                           {
<a name="l14886"></a>14886                             type: <span class="stringliteral">&#39;application/json&#39;</span>,
<a name="l14887"></a>14887                             endings: <span class="stringliteral">&#39;transparent&#39;</span>
<a name="l14888"></a>14888                           });
<a name="l14889"></a>14889       var <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a> = <span class="stringliteral">&#39;gem-log-&#39;</span> + Date.now() + <span class="stringliteral">&#39;.json&#39;</span>;
<a name="l14890"></a>14890       sendMessage(<span class="stringliteral">&#39;save&#39;</span>, [<span class="stringliteral">&#39;sdcard&#39;</span>, blob, filename], <span class="keyword">function</span>(<a class="code" href="../../db/df4/geoloc_8js.html#a15b4f92b0ef49ac05f43437f3d85ae46">success</a>, err, savedFile) {
<a name="l14891"></a>14891         <span class="keywordflow">if</span> (<a class="code" href="../../db/df4/geoloc_8js.html#a15b4f92b0ef49ac05f43437f3d85ae46">success</a>)
<a name="l14892"></a>14892           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;saved log to &quot;sdcard&quot; devicestorage:&#39;</span>, savedFile);
<a name="l14893"></a>14893         <span class="keywordflow">else</span>
<a name="l14894"></a>14894           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;failed to save log to&#39;</span>, filename);
<a name="l14895"></a>14895 
<a name="l14896"></a>14896       });
<a name="l14897"></a>14897     }
<a name="l14898"></a>14898     <span class="keywordflow">catch</span>(ex) {
<a name="l14899"></a>14899       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Problem dumping log to device storage:&#39;</span>, ex,
<a name="l14900"></a>14900                     <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l14901"></a>14901     }
<a name="l14902"></a>14902   },
<a name="l14903"></a>14903 
<a name="l14905"></a>14905   <span class="comment">// Config / Settings</span>
<a name="l14906"></a>14906 
<a name="l14910"></a>14910   _initFromConfig: <span class="keyword">function</span>() {
<a name="l14911"></a>14911     this._cronSync.onUniverseReady();
<a name="l14912"></a>14912   },
<a name="l14913"></a>14913 
<a name="l14917"></a>14917   exposeConfigForClient: <span class="keyword">function</span>() {
<a name="l14918"></a>14918     <span class="comment">// eventually, iterate over a whitelist, but for now, it&#39;s easy...</span>
<a name="l14919"></a>14919     <span class="keywordflow">return</span> {
<a name="l14920"></a>14920       debugLogging: this.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.debugLogging
<a name="l14921"></a>14921     };
<a name="l14922"></a>14922   },
<a name="l14923"></a>14923 
<a name="l14924"></a>14924   modifyConfig: <span class="keyword">function</span>(changes) {
<a name="l14925"></a>14925     <span class="keywordflow">for</span> (var key in changes) {
<a name="l14926"></a>14926       var val = changes[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l14927"></a>14927       <span class="keywordflow">switch</span> (key) {
<a name="l14928"></a>14928         <span class="keywordflow">case</span> <span class="stringliteral">&#39;debugLogging&#39;</span>:
<a name="l14929"></a>14929           <span class="keywordflow">break</span>;
<a name="l14930"></a>14930         <span class="keywordflow">default</span>:
<a name="l14931"></a>14931           <span class="keywordflow">continue</span>;
<a name="l14932"></a>14932       }
<a name="l14933"></a>14933       this.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a>;
<a name="l14934"></a>14934     }
<a name="l14935"></a>14935     this._db.saveConfig(this.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>);
<a name="l14936"></a>14936     this.__notifyConfig();
<a name="l14937"></a>14937   },
<a name="l14938"></a>14938 
<a name="l14939"></a>14939   __notifyConfig: <span class="keyword">function</span>() {
<a name="l14940"></a>14940     var <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a> = this.exposeConfigForClient();
<a name="l14941"></a>14941     <span class="keywordflow">for</span> (var iBridge = 0; iBridge &lt; this._bridges.length; iBridge++) {
<a name="l14942"></a>14942       var bridge = this._bridges[iBridge];
<a name="l14943"></a>14943       bridge.notifyConfig(config);
<a name="l14944"></a>14944     }
<a name="l14945"></a>14945   },
<a name="l14946"></a>14946 
<a name="l14947"></a>14947   setInteractive: <span class="keyword">function</span>() {
<a name="l14948"></a>14948     this._mode = <span class="stringliteral">&#39;interactive&#39;</span>;
<a name="l14949"></a>14949   },
<a name="l14950"></a>14950 
<a name="l14952"></a>14952   _onConnectionChange: <span class="keyword">function</span>(isOnline) {
<a name="l14953"></a>14953     var wasOnline = this.online;
<a name="l14959"></a>14959     this.online = this._testModeFakeNavigator ?
<a name="l14960"></a>14960                     this._testModeFakeNavigator.onLine : isOnline;
<a name="l14961"></a>14961     <span class="comment">// Knowing when the app thinks it is online/offline is going to be very</span>
<a name="l14962"></a>14962     <span class="comment">// useful for our console.log debug spew.</span>
<a name="l14963"></a>14963     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Email knows that it is:&#39;</span>, this.online ? <span class="stringliteral">&#39;online&#39;</span> : <span class="stringliteral">&#39;offline&#39;</span>,
<a name="l14964"></a>14964                 <span class="stringliteral">&#39;and previously was:&#39;</span>, wasOnline ? <span class="stringliteral">&#39;online&#39;</span> : <span class="stringliteral">&#39;offline&#39;</span>);
<a name="l14974"></a>14974     this.minimizeNetworkUsage = <span class="keyword">true</span>;
<a name="l14984"></a>14984     this.networkCostsMoney = <span class="keyword">true</span>;
<a name="l14985"></a>14985 
<a name="l14986"></a>14986     <span class="keywordflow">if</span> (!wasOnline &amp;&amp; this.online) {
<a name="l14987"></a>14987       <span class="comment">// - check if we have any pending actions to run and run them if so.</span>
<a name="l14988"></a>14988       <span class="keywordflow">for</span> (var iAcct = 0; iAcct &lt; this.accounts.length; iAcct++) {
<a name="l14989"></a>14989         this._resumeOpProcessingForAccount(this.accounts[iAcct]);
<a name="l14990"></a>14990       }
<a name="l14991"></a>14991     }
<a name="l14992"></a>14992   },
<a name="l14993"></a>14993 
<a name="l14998"></a>14998   _dispatchLocalOpForAccount: <span class="keyword">function</span>(account, op) {
<a name="l14999"></a>14999     var queues = this._opsByAccount[account.id];
<a name="l15000"></a>15000     queues.active = <span class="keyword">true</span>;
<a name="l15001"></a>15001 
<a name="l15002"></a>15002     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>;
<a name="l15003"></a>15003     <span class="keywordflow">switch</span> (op.lifecycle) {
<a name="l15004"></a>15004       <span class="keywordflow">case</span> <span class="stringliteral">&#39;do&#39;</span>:
<a name="l15005"></a>15005         mode = <span class="stringliteral">&#39;local_do&#39;</span>;
<a name="l15006"></a>15006         op.localStatus = <span class="stringliteral">&#39;doing&#39;</span>;
<a name="l15007"></a>15007         <span class="keywordflow">break</span>;
<a name="l15008"></a>15008       <span class="keywordflow">case</span> <span class="stringliteral">&#39;undo&#39;</span>:
<a name="l15009"></a>15009         mode = <span class="stringliteral">&#39;local_undo&#39;</span>;
<a name="l15010"></a>15010         op.localStatus = <span class="stringliteral">&#39;undoing&#39;</span>;
<a name="l15011"></a>15011         <span class="keywordflow">break</span>;
<a name="l15012"></a>15012       <span class="keywordflow">default</span>:
<a name="l15013"></a>15013         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Illegal lifecycle state for local op&#39;</span>);
<a name="l15014"></a>15014     }
<a name="l15015"></a>15015 
<a name="l15016"></a>15016     account.runOp(
<a name="l15017"></a>15017       op, mode,
<a name="l15018"></a>15018       this._localOpCompleted.bind(<span class="keyword">this</span>, account, op));
<a name="l15019"></a>15019   },
<a name="l15020"></a>15020 
<a name="l15025"></a>15025   _dispatchServerOpForAccount: <span class="keyword">function</span>(account, op) {
<a name="l15026"></a>15026     var queues = this._opsByAccount[account.id];
<a name="l15027"></a>15027     queues.active = <span class="keyword">true</span>;
<a name="l15028"></a>15028 
<a name="l15029"></a>15029     var mode = op.lifecycle;
<a name="l15030"></a>15030     <span class="keywordflow">if</span> (op.serverStatus === <span class="stringliteral">&#39;check&#39;</span>)
<a name="l15031"></a>15031       mode = <span class="stringliteral">&#39;check&#39;</span>;
<a name="l15032"></a>15032     op.serverStatus = mode + <span class="stringliteral">&#39;ing&#39;</span>;
<a name="l15033"></a>15033 
<a name="l15034"></a>15034     account.runOp(
<a name="l15035"></a>15035       op, mode,
<a name="l15036"></a>15036       this._serverOpCompleted.bind(<span class="keyword">this</span>, account, op));
<a name="l15037"></a>15037   },
<a name="l15038"></a>15038 
<a name="l15042"></a>15042   _resumeOpProcessingForAccount: <span class="keyword">function</span>(account) {
<a name="l15043"></a>15043     var queues = this._opsByAccount[account.id];
<a name="l15044"></a>15044     <span class="keywordflow">if</span> (!account.enabled)
<a name="l15045"></a>15045       <span class="keywordflow">return</span>;
<a name="l15046"></a>15046     <span class="comment">// Nothing to do if there&#39;s a local op running</span>
<a name="l15047"></a>15047     <span class="keywordflow">if</span> (!queues.local.length &amp;&amp;
<a name="l15048"></a>15048         queues.server.length &amp;&amp;
<a name="l15049"></a>15049         <span class="comment">// (it&#39;s possible there is still an active job right now)</span>
<a name="l15050"></a>15050         (queues.server[0].serverStatus !== <span class="stringliteral">&#39;doing&#39;</span> &amp;&amp;
<a name="l15051"></a>15051          queues.server[0].serverStatus !== <span class="stringliteral">&#39;undoing&#39;</span>)) {
<a name="l15052"></a>15052       var op = queues.server[0];
<a name="l15053"></a>15053       this._dispatchServerOpForAccount(account, op);
<a name="l15054"></a>15054     }
<a name="l15055"></a>15055   },
<a name="l15056"></a>15056 
<a name="l15057"></a>15057   registerBridge: <span class="keyword">function</span>(mailBridge) {
<a name="l15058"></a>15058     this._bridges.push(mailBridge);
<a name="l15059"></a>15059   },
<a name="l15060"></a>15060 
<a name="l15061"></a>15061   unregisterBridge: <span class="keyword">function</span>(mailBridge) {
<a name="l15062"></a>15062     var idx = this._bridges.indexOf(mailBridge);
<a name="l15063"></a>15063     <span class="keywordflow">if</span> (idx !== -1)
<a name="l15064"></a>15064       this._bridges.splice(idx, 1);
<a name="l15065"></a>15065   },
<a name="l15066"></a>15066 
<a name="l15067"></a>15067   tryToCreateAccount: <span class="keyword">function</span> mu_tryToCreateAccount(userDetails, domainInfo,
<a name="l15068"></a>15068                                                      callback) {
<a name="l15069"></a>15069     <span class="keywordflow">if</span> (!this.online) {
<a name="l15070"></a>15070       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;offline&#39;</span>);
<a name="l15071"></a>15071       <span class="keywordflow">return</span>;
<a name="l15072"></a>15072     }
<a name="l15073"></a>15073     <span class="keywordflow">if</span> (!userDetails.forceCreate) {
<a name="l15074"></a>15074       <span class="keywordflow">for</span> (var i = 0; i &lt; this.accounts.length; i++) {
<a name="l15075"></a>15075         <span class="keywordflow">if</span> (userDetails.emailAddress ===
<a name="l15076"></a>15076             <span class="keyword">this</span>.accounts[i].identities[0].address) {
<a name="l15077"></a>15077           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="stringliteral">&#39;user-account-exists&#39;</span>);
<a name="l15078"></a>15078           <span class="keywordflow">return</span>;
<a name="l15079"></a>15079         }
<a name="l15080"></a>15080       }
<a name="l15081"></a>15081     }
<a name="l15082"></a>15082 
<a name="l15083"></a>15083     <span class="keywordflow">if</span> (domainInfo) {
<a name="l15084"></a>15084       $acctcommon.tryToManuallyCreateAccount(<span class="keyword">this</span>, userDetails, domainInfo,
<a name="l15085"></a>15085                                              callback, this._LOG);
<a name="l15086"></a>15086     }
<a name="l15087"></a>15087     <span class="keywordflow">else</span> {
<a name="l15088"></a>15088       <span class="comment">// XXX: store configurator on this object so we can abort the connections</span>
<a name="l15089"></a>15089       <span class="comment">// if necessary.</span>
<a name="l15090"></a>15090       var configurator = <span class="keyword">new</span> $acctcommon.Autoconfigurator(this._LOG);
<a name="l15091"></a>15091       configurator.tryToCreateAccount(<span class="keyword">this</span>, userDetails, callback);
<a name="l15092"></a>15092     }
<a name="l15093"></a>15093   },
<a name="l15094"></a>15094 
<a name="l15098"></a>15098   deleteAccount: <span class="keyword">function</span>(accountId) {
<a name="l15099"></a>15099     var savedEx = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l15100"></a>15100     var account = this._accountsById[accountId];
<a name="l15101"></a>15101     <span class="keywordflow">try</span> {
<a name="l15102"></a>15102       account.accountDeleted();
<a name="l15103"></a>15103     }
<a name="l15104"></a>15104     <span class="keywordflow">catch</span> (ex) {
<a name="l15105"></a>15105       <span class="comment">// save the failure until after we have done other cleanup.</span>
<a name="l15106"></a>15106       savedEx = ex;
<a name="l15107"></a>15107     }
<a name="l15108"></a>15108     this._db.deleteAccount(accountId);
<a name="l15109"></a>15109 
<a name="l15110"></a>15110     <span class="keyword">delete</span> this._accountsById[accountId];
<a name="l15111"></a>15111     var idx = this.accounts.indexOf(account);
<a name="l15112"></a>15112     this.accounts.splice(idx, 1);
<a name="l15113"></a>15113 
<a name="l15114"></a>15114     <span class="keywordflow">for</span> (var i = 0; i &lt; account.identities.length; i++) {
<a name="l15115"></a>15115       var identity = account.identities[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l15116"></a>15116       idx = this.identities.indexOf(identity);
<a name="l15117"></a>15117       this.identities.splice(idx, 1);
<a name="l15118"></a>15118       <span class="keyword">delete</span> this._identitiesById[identity.id];
<a name="l15119"></a>15119     }
<a name="l15120"></a>15120 
<a name="l15121"></a>15121     <span class="keyword">delete</span> this._opsByAccount[accountId];
<a name="l15122"></a>15122     <span class="keyword">delete</span> this._opCompletionListenersByAccount[accountId];
<a name="l15123"></a>15123 
<a name="l15124"></a>15124     this.__notifyRemovedAccount(accountId);
<a name="l15125"></a>15125 
<a name="l15126"></a>15126     <span class="keywordflow">if</span> (savedEx)
<a name="l15127"></a>15127       <span class="keywordflow">throw</span> savedEx;
<a name="l15128"></a>15128   },
<a name="l15129"></a>15129 
<a name="l15130"></a>15130   saveAccountDef: <span class="keyword">function</span>(accountDef, folderInfo) {
<a name="l15131"></a>15131     this._db.saveAccountDef(this.config, accountDef, folderInfo);
<a name="l15132"></a>15132     var account = this.getAccountForAccountId(accountDef.id);
<a name="l15133"></a>15133 
<a name="l15134"></a>15134     <span class="comment">// Make sure syncs are still accurate, since syncInterval</span>
<a name="l15135"></a>15135     <span class="comment">// could have changed.</span>
<a name="l15136"></a>15136     this._cronSync.ensureSync();
<a name="l15137"></a>15137 
<a name="l15138"></a>15138     <span class="comment">// If account exists, notify of modification. However on first</span>
<a name="l15139"></a>15139     <span class="comment">// save, the account does not exist yet.</span>
<a name="l15140"></a>15140     <span class="keywordflow">if</span> (account)
<a name="l15141"></a>15141       this.__notifyModifiedAccount(account);
<a name="l15142"></a>15142   },
<a name="l15143"></a>15143 
<a name="l15148"></a>15148   _loadAccount: <span class="keyword">function</span> mu__loadAccount(accountDef, folderInfo,
<a name="l15149"></a>15149                                          receiveProtoConn, callback) {
<a name="l15150"></a>15150     $acctcommon.accountTypeToClass(accountDef.type, <a class="code" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> (<a class="code" href="../../d8/d14/_cloud_apps_8js.html#af72715521e98346fe28d30efb7887846">constructor</a>) {
<a name="l15151"></a>15151       <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d14/_cloud_apps_8js.html#af72715521e98346fe28d30efb7887846">constructor</a>) {
<a name="l15152"></a>15152         this._LOG.badAccountType(accountDef.type);
<a name="l15153"></a>15153         <span class="keywordflow">return</span>;
<a name="l15154"></a>15154       }
<a name="l15155"></a>15155       var account = <span class="keyword">new</span> <a class="code" href="../../d8/d14/_cloud_apps_8js.html#af72715521e98346fe28d30efb7887846">constructor</a>(<span class="keyword">this</span>, accountDef, folderInfo, this._db,
<a name="l15156"></a>15156                                     receiveProtoConn, this._LOG);
<a name="l15157"></a>15157 
<a name="l15158"></a>15158       this.accounts.push(account);
<a name="l15159"></a>15159       this._accountsById[account.id] = account;
<a name="l15160"></a>15160       this._opsByAccount[account.id] = {
<a name="l15161"></a>15161         active: <span class="keyword">false</span>,
<a name="l15162"></a>15162         local: [],
<a name="l15163"></a>15163         server: [],
<a name="l15164"></a>15164         deferred: []
<a name="l15165"></a>15165       };
<a name="l15166"></a>15166       this._opCompletionListenersByAccount[account.id] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l15167"></a>15167 
<a name="l15168"></a>15168       <span class="keywordflow">for</span> (var iIdent = 0; iIdent &lt; accountDef.identities.length; iIdent++) {
<a name="l15169"></a>15169         var identity = accountDef.identities[iIdent];
<a name="l15170"></a>15170         this.identities.push(identity);
<a name="l15171"></a>15171         this._identitiesById[identity.id] = <a class="code" href="../../d3/d91/j3d_8js.html#a6e4df2a24032d4c8c7ac7809c4514de5">identity</a>;
<a name="l15172"></a>15172       }
<a name="l15173"></a>15173 
<a name="l15174"></a>15174       this.__notifyAddedAccount(account);
<a name="l15175"></a>15175 
<a name="l15176"></a>15176       <span class="comment">// - issue a (non-persisted) syncFolderList if needed</span>
<a name="l15177"></a>15177       var timeSinceLastFolderSync = Date.now() - account.meta.lastFolderSyncAt;
<a name="l15178"></a>15178       <span class="keywordflow">if</span> (timeSinceLastFolderSync &gt;= $syncbase.SYNC_FOLDER_LIST_EVERY_MS)
<a name="l15179"></a>15179         this.syncFolderList(account);
<a name="l15180"></a>15180 
<a name="l15181"></a>15181       <span class="comment">// - check for mutations that still need to be processed</span>
<a name="l15182"></a>15182       <span class="comment">// This will take care of deferred mutations too because they are still</span>
<a name="l15183"></a>15183       <span class="comment">// maintained in this list.</span>
<a name="l15184"></a>15184       <span class="keywordflow">for</span> (var i = 0; i &lt; account.mutations.length; i++) {
<a name="l15185"></a>15185         var op = account.mutations[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l15186"></a>15186         <span class="keywordflow">if</span> (op.lifecycle !== <span class="stringliteral">&#39;done&#39;</span> &amp;&amp; op.lifecycle !== <span class="stringliteral">&#39;undone&#39;</span> &amp;&amp;
<a name="l15187"></a>15187             op.lifecycle !== <span class="stringliteral">&#39;moot&#39;</span>) {
<a name="l15188"></a>15188           <span class="comment">// For localStatus, we currently expect it to be consistent with the</span>
<a name="l15189"></a>15189           <span class="comment">// state of the folder&#39;s database.  We expect this to be true going</span>
<a name="l15190"></a>15190           <span class="comment">// forward and as we make changes because when we save the account&#39;s</span>
<a name="l15191"></a>15191           <span class="comment">// operation status, we should also be saving the folder changes at the</span>
<a name="l15192"></a>15192           <span class="comment">// same time.</span>
<a name="l15193"></a>15193           <span class="comment">//</span>
<a name="l15194"></a>15194           <span class="comment">// The same cannot be said for serverStatus, so we need to check.  See</span>
<a name="l15195"></a>15195           <span class="comment">// comments about operations elsewhere (currently in imap/jobs.js).</span>
<a name="l15196"></a>15196           op.serverStatus = <span class="stringliteral">&#39;check&#39;</span>;
<a name="l15197"></a>15197           this._queueAccountOp(account, op);
<a name="l15198"></a>15198         }
<a name="l15199"></a>15199       }
<a name="l15200"></a>15200       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(account);
<a name="l15201"></a>15201     }.bind(<span class="keyword">this</span>));
<a name="l15202"></a>15202   },
<a name="l15203"></a>15203 
<a name="l15211"></a>15211   __reportAccountProblem: <span class="keyword">function</span>(account, problem) {
<a name="l15212"></a>15212     <span class="comment">// nothing to do if the problem is already known</span>
<a name="l15213"></a>15213     <span class="keywordflow">if</span> (account.problems.indexOf(problem) !== -1)
<a name="l15214"></a>15214       <span class="keywordflow">return</span>;
<a name="l15215"></a>15215     account.problems.push(problem);
<a name="l15216"></a>15216     account.enabled = <span class="keyword">false</span>;
<a name="l15217"></a>15217 
<a name="l15218"></a>15218     this.__notifyModifiedAccount(account);
<a name="l15219"></a>15219 
<a name="l15220"></a>15220     <span class="keywordflow">switch</span> (problem) {
<a name="l15221"></a>15221       <span class="keywordflow">case</span> <span class="stringliteral">&#39;bad-user-or-pass&#39;</span>:
<a name="l15222"></a>15222       <span class="keywordflow">case</span> <span class="stringliteral">&#39;imap-disabled&#39;</span>:
<a name="l15223"></a>15223       <span class="keywordflow">case</span> <span class="stringliteral">&#39;needs-app-pass&#39;</span>:
<a name="l15224"></a>15224         this.__notifyBadLogin(account, problem);
<a name="l15225"></a>15225         <span class="keywordflow">break</span>;
<a name="l15226"></a>15226     }
<a name="l15227"></a>15227   },
<a name="l15228"></a>15228 
<a name="l15229"></a>15229   __removeAccountProblem: <span class="keyword">function</span>(account, problem) {
<a name="l15230"></a>15230     var idx = account.problems.indexOf(problem);
<a name="l15231"></a>15231     <span class="keywordflow">if</span> (idx === -1)
<a name="l15232"></a>15232       <span class="keywordflow">return</span>;
<a name="l15233"></a>15233     account.problems.splice(idx, 1);
<a name="l15234"></a>15234     account.enabled = (account.problems.length === 0);
<a name="l15235"></a>15235 
<a name="l15236"></a>15236     this.__notifyModifiedAccount(account);
<a name="l15237"></a>15237 
<a name="l15238"></a>15238     <span class="keywordflow">if</span> (account.enabled)
<a name="l15239"></a>15239       this._resumeOpProcessingForAccount(account);
<a name="l15240"></a>15240   },
<a name="l15241"></a>15241 
<a name="l15242"></a>15242   clearAccountProblems: <span class="keyword">function</span>(account) {
<a name="l15243"></a>15243     <span class="comment">// TODO: this would be a great time to have any slices that had stalled</span>
<a name="l15244"></a>15244     <span class="comment">// syncs do whatever it takes to make them happen again.</span>
<a name="l15245"></a>15245     account.enabled = <span class="keyword">true</span>;
<a name="l15246"></a>15246     account.problems = [];
<a name="l15247"></a>15247     this._resumeOpProcessingForAccount(account);
<a name="l15248"></a>15248   },
<a name="l15249"></a>15249 
<a name="l15250"></a>15250   <span class="comment">// expects (account, problem)</span>
<a name="l15251"></a>15251   __notifyBadLogin: makeBridgeFn(<span class="stringliteral">&#39;notifyBadLogin&#39;</span>),
<a name="l15252"></a>15252 
<a name="l15253"></a>15253   <span class="comment">// expects (account)</span>
<a name="l15254"></a>15254   __notifyAddedAccount: makeBridgeFn(<span class="stringliteral">&#39;notifyAccountAdded&#39;</span>),
<a name="l15255"></a>15255 
<a name="l15256"></a>15256   <span class="comment">// expects (account)</span>
<a name="l15257"></a>15257   __notifyModifiedAccount: makeBridgeFn(<span class="stringliteral">&#39;notifyAccountModified&#39;</span>),
<a name="l15258"></a>15258 
<a name="l15259"></a>15259   <span class="comment">// expects (accountId)</span>
<a name="l15260"></a>15260   __notifyRemovedAccount: makeBridgeFn(<span class="stringliteral">&#39;notifyAccountRemoved&#39;</span>),
<a name="l15261"></a>15261 
<a name="l15262"></a>15262   <span class="comment">// expects (account, folderMeta)</span>
<a name="l15263"></a>15263   __notifyAddedFolder: makeBridgeFn(<span class="stringliteral">&#39;notifyFolderAdded&#39;</span>),
<a name="l15264"></a>15264 
<a name="l15265"></a>15265   <span class="comment">// expects (account, folderMeta)</span>
<a name="l15266"></a>15266   __notifyModifiedFolder: makeBridgeFn(<span class="stringliteral">&#39;notifyFolderModified&#39;</span>),
<a name="l15267"></a>15267 
<a name="l15268"></a>15268   <span class="comment">// expects (account, folderMeta)</span>
<a name="l15269"></a>15269   __notifyRemovedFolder: makeBridgeFn(<span class="stringliteral">&#39;notifyFolderRemoved&#39;</span>),
<a name="l15270"></a>15270 
<a name="l15271"></a>15271   <span class="comment">// expects (suid, detail, body)</span>
<a name="l15272"></a>15272   __notifyModifiedBody: makeBridgeFn(<span class="stringliteral">&#39;notifyBodyModified&#39;</span>),
<a name="l15273"></a>15273 
<a name="l15274"></a>15274 
<a name="l15276"></a>15276   <span class="comment">// cronsync Stuff</span>
<a name="l15277"></a>15277 
<a name="l15278"></a>15278   <span class="comment">// expects (accountIds)</span>
<a name="l15279"></a>15279   __notifyStartedCronSync: makeBridgeFn(<span class="stringliteral">&#39;notifyCronSyncStart&#39;</span>),
<a name="l15280"></a>15280 
<a name="l15281"></a>15281   <span class="comment">// expects (accountsResults)</span>
<a name="l15282"></a>15282   __notifyStoppedCronSync: makeBridgeFn(<span class="stringliteral">&#39;notifyCronSyncStop&#39;</span>),
<a name="l15283"></a>15283 
<a name="l15285"></a>15285   <span class="comment">// Lifetime Stuff</span>
<a name="l15286"></a>15286 
<a name="l15290"></a>15290   saveUniverseState: <span class="keyword">function</span>() {
<a name="l15291"></a>15291     var curTrans = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l15292"></a>15292 
<a name="l15293"></a>15293     <span class="keywordflow">for</span> (var iAcct = 0; iAcct &lt; this.accounts.length; iAcct++) {
<a name="l15294"></a>15294       var account = this.accounts[iAcct];
<a name="l15295"></a>15295       curTrans = account.saveAccountState(curTrans, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;saveUniverse&#39;</span>);
<a name="l15296"></a>15296     }
<a name="l15297"></a>15297   },
<a name="l15298"></a>15298 
<a name="l15310"></a>15310   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l15311"></a>15311     var waitCount = this.accounts.length;
<a name="l15312"></a>15312     <span class="comment">// (only used if a &#39;callback&#39; is passed)</span>
<a name="l15313"></a>15313     <span class="keyword">function</span> accountShutdownCompleted() {
<a name="l15314"></a>15314       <span class="keywordflow">if</span> (--waitCount === 0)
<a name="l15315"></a>15315         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l15316"></a>15316     }
<a name="l15317"></a>15317     <span class="keywordflow">for</span> (var iAcct = 0; iAcct &lt; this.accounts.length; iAcct++) {
<a name="l15318"></a>15318       var account = this.accounts[iAcct];
<a name="l15319"></a>15319       <span class="comment">// only need to pass our handler if clean shutdown is desired</span>
<a name="l15320"></a>15320       account.shutdown(callback ? accountShutdownCompleted : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l15321"></a>15321     }
<a name="l15322"></a>15322 
<a name="l15323"></a>15323     this._cronSync.shutdown();
<a name="l15324"></a>15324     this._db.close();
<a name="l15325"></a>15325     <span class="keywordflow">if</span> (this._LOG)
<a name="l15326"></a>15326       this._LOG.__die();
<a name="l15327"></a>15327 
<a name="l15328"></a>15328     <span class="keywordflow">if</span> (!this.accounts.length)
<a name="l15329"></a>15329       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l15330"></a>15330   },
<a name="l15331"></a>15331 
<a name="l15333"></a>15333   <span class="comment">// Lookups: Account, Folder, Identity</span>
<a name="l15334"></a>15334 
<a name="l15335"></a>15335   getAccountForAccountId: <span class="keyword">function</span> mu_getAccountForAccountId(accountId) {
<a name="l15336"></a>15336     <span class="keywordflow">return</span> this._accountsById[accountId];
<a name="l15337"></a>15337   },
<a name="l15338"></a>15338 
<a name="l15342"></a>15342   getAccountForFolderId: <span class="keyword">function</span> mu_getAccountForFolderId(folderId) {
<a name="l15343"></a>15343     var accountId = folderId.substring(0, folderId.indexOf(<span class="charliteral">&#39;/&#39;</span>)),
<a name="l15344"></a>15344         account = this._accountsById[accountId];
<a name="l15345"></a>15345     <span class="keywordflow">return</span> account;
<a name="l15346"></a>15346   },
<a name="l15347"></a>15347 
<a name="l15351"></a>15351   getAccountForMessageSuid: <span class="keyword">function</span> mu_getAccountForMessageSuid(messageSuid) {
<a name="l15352"></a>15352     var accountId = messageSuid.substring(0, messageSuid.indexOf(<span class="charliteral">&#39;/&#39;</span>)),
<a name="l15353"></a>15353         account = this._accountsById[accountId];
<a name="l15354"></a>15354     <span class="keywordflow">return</span> account;
<a name="l15355"></a>15355   },
<a name="l15356"></a>15356 
<a name="l15357"></a>15357   getFolderStorageForFolderId: <span class="keyword">function</span> mu_getFolderStorageForFolderId(
<a name="l15358"></a>15358                                  folderId) {
<a name="l15359"></a>15359     var account = this.getAccountForFolderId(folderId);
<a name="l15360"></a>15360     <span class="keywordflow">return</span> account.getFolderStorageForFolderId(folderId);
<a name="l15361"></a>15361   },
<a name="l15362"></a>15362 
<a name="l15363"></a>15363   getFolderStorageForMessageSuid: <span class="keyword">function</span> mu_getFolderStorageForFolderId(
<a name="l15364"></a>15364                                     messageSuid) {
<a name="l15365"></a>15365     var folderId = messageSuid.substring(0, messageSuid.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>)),
<a name="l15366"></a>15366         account = this.getAccountForFolderId(folderId);
<a name="l15367"></a>15367     <span class="keywordflow">return</span> account.getFolderStorageForFolderId(folderId);
<a name="l15368"></a>15368   },
<a name="l15369"></a>15369 
<a name="l15370"></a>15370   getAccountForSenderIdentityId: <span class="keyword">function</span> mu_getAccountForSenderIdentityId(
<a name="l15371"></a>15371                                    identityId) {
<a name="l15372"></a>15372     var accountId = identityId.substring(0, identityId.indexOf(<span class="charliteral">&#39;/&#39;</span>)),
<a name="l15373"></a>15373         account = this._accountsById[accountId];
<a name="l15374"></a>15374     <span class="keywordflow">return</span> account;
<a name="l15375"></a>15375   },
<a name="l15376"></a>15376 
<a name="l15377"></a>15377   getIdentityForSenderIdentityId: <span class="keyword">function</span> mu_getIdentityForSenderIdentityId(
<a name="l15378"></a>15378                                     identityId) {
<a name="l15379"></a>15379     <span class="keywordflow">return</span> this._identitiesById[identityId];
<a name="l15380"></a>15380   },
<a name="l15381"></a>15381 
<a name="l15383"></a>15383   <span class="comment">// Message Mutation and Undoing</span>
<a name="l15384"></a>15384 
<a name="l15391"></a>15391   _partitionMessagesByAccount: <span class="keyword">function</span>(messageNamers, targetAccountId) {
<a name="l15392"></a>15392     var results = [], acctToMsgs = {};
<a name="l15393"></a>15393 
<a name="l15394"></a>15394     <span class="keywordflow">for</span> (var i = 0; i &lt; messageNamers.length; i++) {
<a name="l15395"></a>15395       var messageNamer = messageNamers[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l15396"></a>15396           messageSuid = messageNamer.suid,
<a name="l15397"></a>15397           accountId = messageSuid.substring(0, messageSuid.indexOf(<span class="charliteral">&#39;/&#39;</span>));
<a name="l15398"></a>15398       <span class="keywordflow">if</span> (!acctToMsgs.hasOwnProperty(accountId)) {
<a name="l15399"></a>15399         var messages = [messageNamer];
<a name="l15400"></a>15400         results.push({
<a name="l15401"></a>15401           account: this._accountsById[accountId],
<a name="l15402"></a>15402           messages: messages,
<a name="l15403"></a>15403           crossAccount: (targetAccountId &amp;&amp; targetAccountId !== accountId),
<a name="l15404"></a>15404         });
<a name="l15405"></a>15405         acctToMsgs[accountId] = messages;
<a name="l15406"></a>15406       }
<a name="l15407"></a>15407       <span class="keywordflow">else</span> {
<a name="l15408"></a>15408         acctToMsgs[accountId].push(messageNamer);
<a name="l15409"></a>15409       }
<a name="l15410"></a>15410     }
<a name="l15411"></a>15411 
<a name="l15412"></a>15412     <span class="keywordflow">return</span> <a class="code" href="../../de/d4d/ns_i_d_o_m_speech_recognition_event_8idl.html#a004e752a63561c4c9bfd98d2be668a5d">results</a>;
<a name="l15413"></a>15413   },
<a name="l15414"></a>15414 
<a name="l15420"></a>15420   _deferOp: <span class="keyword">function</span>(account, op) {
<a name="l15421"></a>15421     this._opsByAccount[account.id].deferred.push(op.longtermId);
<a name="l15422"></a>15422     <span class="keywordflow">if</span> (this._deferredOpTimeout !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l15423"></a>15423       this._deferredOpTimeout = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(
<a name="l15424"></a>15424         this._boundQueueDeferredOps, $syncbase.DEFERRED_OP_DELAY_MS);
<a name="l15425"></a>15425   },
<a name="l15426"></a>15426 
<a name="l15433"></a>15433   _queueDeferredOps: <span class="keyword">function</span>() {
<a name="l15434"></a>15434     this._deferredOpTimeout = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l15435"></a>15435 
<a name="l15436"></a>15436     <span class="comment">// If not in &#39;interactive&#39; mode, then this is just a short</span>
<a name="l15437"></a>15437     <span class="comment">// &#39;cron&#39; existence that needs to shut down soon. Wait one</span>
<a name="l15438"></a>15438     <span class="comment">// more cycle in case the app switches over to &#39;interactive&#39;</span>
<a name="l15439"></a>15439     <span class="comment">// in the meantime.</span>
<a name="l15440"></a>15440     <span class="keywordflow">if</span> (this._mode !== <span class="stringliteral">&#39;interactive&#39;</span>) {
<a name="l15441"></a>15441       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;delaying deferred op since mode is &#39;</span> + this._mode);
<a name="l15442"></a>15442       this._deferredOpTimeout = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(
<a name="l15443"></a>15443         this._boundQueueDeferredOps, $syncbase.DEFERRED_OP_DELAY_MS);
<a name="l15444"></a>15444       <span class="keywordflow">return</span>;
<a name="l15445"></a>15445     }
<a name="l15446"></a>15446 
<a name="l15447"></a>15447     <span class="keywordflow">for</span> (var iAccount = 0; iAccount &lt; this.accounts.length; iAccount++) {
<a name="l15448"></a>15448       var account = this.accounts[iAccount],
<a name="l15449"></a>15449           queues = this._opsByAccount[account.id];
<a name="l15450"></a>15450       <span class="comment">// we need to mutate in-place, so concat is not an option</span>
<a name="l15451"></a>15451       <span class="keywordflow">while</span> (queues.deferred.length) {
<a name="l15452"></a>15452         var op = queues.deferred.shift();
<a name="l15453"></a>15453         <span class="comment">// There is no need to enqueue the operation if:</span>
<a name="l15454"></a>15454         <span class="comment">// - It&#39;s already enqueued because someone called undo</span>
<a name="l15455"></a>15455         <span class="comment">// - Undo got called and that ran to completion</span>
<a name="l15456"></a>15456         <span class="keywordflow">if</span> (queues.server.indexOf(op) === -1 &amp;&amp;
<a name="l15457"></a>15457             op.lifecycle !== <span class="stringliteral">&#39;undo&#39;</span>)
<a name="l15458"></a>15458           this._queueAccountOp(account, op);
<a name="l15459"></a>15459       }
<a name="l15460"></a>15460     }
<a name="l15461"></a>15461   },
<a name="l15462"></a>15462 
<a name="l15463"></a>15463   _localOpCompleted: <span class="keyword">function</span>(account, op, err, resultIfAny,
<a name="l15464"></a>15464                               accountSaveSuggested) {
<a name="l15465"></a>15465     var queues = this._opsByAccount[account.id],
<a name="l15466"></a>15466         serverQueue = queues.server,
<a name="l15467"></a>15467         localQueue = queues.local;
<a name="l15468"></a>15468     queues.active = <span class="keyword">false</span>;
<a name="l15469"></a>15469 
<a name="l15470"></a>15470     var removeFromServerQueue = <span class="keyword">false</span>,
<a name="l15471"></a>15471         completeOp = <span class="keyword">false</span>;
<a name="l15472"></a>15472     <span class="keywordflow">if</span> (err) {
<a name="l15473"></a>15473       <span class="keywordflow">switch</span> (err) {
<a name="l15474"></a>15474         <span class="comment">// Only defer is currently supported as a recoverable local failure</span>
<a name="l15475"></a>15475         <span class="comment">// type.</span>
<a name="l15476"></a>15476         <span class="keywordflow">case</span> <span class="stringliteral">&#39;defer&#39;</span>:
<a name="l15477"></a>15477           <span class="keywordflow">if</span> (++op.tryCount &lt; $syncbase.MAX_OP_TRY_COUNT) {
<a name="l15478"></a>15478             this._LOG.opDeferred(op.type, op.longtermId);
<a name="l15479"></a>15479             this._deferOp(account, op);
<a name="l15480"></a>15480             removeFromServerQueue = <span class="keyword">true</span>;
<a name="l15481"></a>15481             <span class="keywordflow">break</span>;
<a name="l15482"></a>15482           }
<a name="l15483"></a>15483           <span class="comment">// fall-through to an error</span>
<a name="l15484"></a>15484         <span class="keywordflow">default</span>:
<a name="l15485"></a>15485           this._LOG.opGaveUp(op.type, op.longtermId);
<a name="l15486"></a>15486           op.lifecycle = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15487"></a>15487           op.localStatus = <span class="stringliteral">&#39;unknown&#39;</span>;
<a name="l15488"></a>15488           op.serverStatus = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15489"></a>15489           removeFromServerQueue = <span class="keyword">true</span>;
<a name="l15490"></a>15490           completeOp = <span class="keyword">true</span>;
<a name="l15491"></a>15491           <span class="keywordflow">break</span>;
<a name="l15492"></a>15492       }
<a name="l15493"></a>15493     }
<a name="l15494"></a>15494     <span class="keywordflow">else</span> {
<a name="l15495"></a>15495       <span class="keywordflow">switch</span> (op.localStatus) {
<a name="l15496"></a>15496         <span class="keywordflow">case</span> <span class="stringliteral">&#39;doing&#39;</span>:
<a name="l15497"></a>15497           op.localStatus = <span class="stringliteral">&#39;done&#39;</span>;
<a name="l15498"></a>15498           <span class="keywordflow">if</span> (op.serverStatus === <span class="stringliteral">&#39;n/a&#39;</span>) {
<a name="l15499"></a>15499             op.lifecycle = <span class="stringliteral">&#39;done&#39;</span>;
<a name="l15500"></a>15500             completeOp = <span class="keyword">true</span>;
<a name="l15501"></a>15501           }
<a name="l15502"></a>15502           <span class="keywordflow">break</span>;
<a name="l15503"></a>15503         <span class="keywordflow">case</span> <span class="stringliteral">&#39;undoing&#39;</span>:
<a name="l15504"></a>15504           op.localStatus = <span class="stringliteral">&#39;undone&#39;</span>;
<a name="l15505"></a>15505           <span class="keywordflow">if</span> (op.serverStatus === <span class="stringliteral">&#39;n/a&#39;</span>) {
<a name="l15506"></a>15506             op.lifecycle = <span class="stringliteral">&#39;undone&#39;</span>;
<a name="l15507"></a>15507             completeOp = <span class="keyword">true</span>;
<a name="l15508"></a>15508           }
<a name="l15509"></a>15509           <span class="keywordflow">break</span>;
<a name="l15510"></a>15510       }
<a name="l15511"></a>15511 
<a name="l15512"></a>15512       <span class="comment">// This is a suggestion; in the event of high-throughput on operations,</span>
<a name="l15513"></a>15513       <span class="comment">// we probably don&#39;t want to save the account every tick, etc.</span>
<a name="l15514"></a>15514       <span class="keywordflow">if</span> (accountSaveSuggested)
<a name="l15515"></a>15515         account.saveAccountState(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;localOp&#39;</span>);
<a name="l15516"></a>15516     }
<a name="l15517"></a>15517 
<a name="l15518"></a>15518     <span class="keywordflow">if</span> (removeFromServerQueue) {
<a name="l15519"></a>15519       var idx = serverQueue.indexOf(op);
<a name="l15520"></a>15520       <span class="keywordflow">if</span> (idx !== -1)
<a name="l15521"></a>15521         serverQueue.splice(idx, 1);
<a name="l15522"></a>15522     }
<a name="l15523"></a>15523     localQueue.shift();
<a name="l15524"></a>15524 
<a name="l15525"></a>15525     <span class="keywordflow">if</span> (completeOp) {
<a name="l15526"></a>15526       <span class="keywordflow">if</span> (this._opCallbacks.hasOwnProperty(op.longtermId)) {
<a name="l15527"></a>15527         var callback = this._opCallbacks[op.longtermId];
<a name="l15528"></a>15528         <span class="keyword">delete</span> this._opCallbacks[op.longtermId];
<a name="l15529"></a>15529         <span class="keywordflow">try</span> {
<a name="l15530"></a>15530           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(err, resultIfAny, account, op);
<a name="l15531"></a>15531         }
<a name="l15532"></a>15532         <span class="keywordflow">catch</span>(ex) {
<a name="l15533"></a>15533           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(ex.message, ex.stack);
<a name="l15534"></a>15534           this._LOG.opCallbackErr(op.type);
<a name="l15535"></a>15535         }
<a name="l15536"></a>15536       }
<a name="l15537"></a>15537     }
<a name="l15538"></a>15538 
<a name="l15539"></a>15539     <span class="keywordflow">if</span> (localQueue.length) {
<a name="l15540"></a>15540       op = localQueue[0];
<a name="l15541"></a>15541       this._dispatchLocalOpForAccount(account, op);
<a name="l15542"></a>15542     }
<a name="l15543"></a>15543     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (serverQueue.length &amp;&amp; <span class="keyword">this</span>.online &amp;&amp; account.enabled) {
<a name="l15544"></a>15544       op = serverQueue[0];
<a name="l15545"></a>15545       this._dispatchServerOpForAccount(account, op);
<a name="l15546"></a>15546     }
<a name="l15547"></a>15547   },
<a name="l15548"></a>15548 
<a name="l15605"></a>15605   _serverOpCompleted: <span class="keyword">function</span>(account, op, err, resultIfAny,
<a name="l15606"></a>15606                                accountSaveSuggested) {
<a name="l15607"></a>15607     var queues = this._opsByAccount[account.id],
<a name="l15608"></a>15608         serverQueue = queues.server,
<a name="l15609"></a>15609         localQueue = queues.local;
<a name="l15610"></a>15610     queues.active = <span class="keyword">false</span>;
<a name="l15611"></a>15611 
<a name="l15612"></a>15612     <span class="keywordflow">if</span> (serverQueue[0] !== op)
<a name="l15613"></a>15613       this._LOG.opInvariantFailure();
<a name="l15614"></a>15614 
<a name="l15615"></a>15615     <span class="comment">// Should we attempt to retry (but fail if tryCount is reached)?</span>
<a name="l15616"></a>15616     var maybeRetry = <span class="keyword">false</span>;
<a name="l15617"></a>15617     <span class="comment">// Pop the event off the queue? (avoid bugs versus multiple calls)</span>
<a name="l15618"></a>15618     var consumeOp = <span class="keyword">true</span>;
<a name="l15619"></a>15619     <span class="comment">// Generate completion notifications for the op?</span>
<a name="l15620"></a>15620     var completeOp = <span class="keyword">true</span>;
<a name="l15621"></a>15621     <span class="keywordflow">if</span> (err) {
<a name="l15622"></a>15622       <span class="keywordflow">switch</span> (err) {
<a name="l15623"></a>15623         <span class="keywordflow">case</span> <span class="stringliteral">&#39;defer&#39;</span>:
<a name="l15624"></a>15624           <span class="keywordflow">if</span> (++op.tryCount &lt; $syncbase.MAX_OP_TRY_COUNT) {
<a name="l15625"></a>15625             <span class="comment">// Defer the operation if we still want to do the thing, but skip</span>
<a name="l15626"></a>15626             <span class="comment">// deferring if we are now trying to undo the thing.</span>
<a name="l15627"></a>15627             <span class="keywordflow">if</span> (op.serverStatus === <span class="stringliteral">&#39;doing&#39;</span> &amp;&amp; op.lifecycle === <span class="stringliteral">&#39;do&#39;</span>) {
<a name="l15628"></a>15628               this._LOG.opDeferred(op.type, op.longtermId);
<a name="l15629"></a>15629               this._deferOp(account, op);
<a name="l15630"></a>15630             }
<a name="l15631"></a>15631             <span class="comment">// remove the op from the queue, but don&#39;t mark it completed</span>
<a name="l15632"></a>15632             completeOp = <span class="keyword">false</span>;
<a name="l15633"></a>15633           }
<a name="l15634"></a>15634           <span class="keywordflow">else</span> {
<a name="l15635"></a>15635             op.lifecycle = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15636"></a>15636             op.serverStatus = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15637"></a>15637           }
<a name="l15638"></a>15638           <span class="keywordflow">break</span>;
<a name="l15639"></a>15639         <span class="keywordflow">case</span> <span class="stringliteral">&#39;aborted-retry&#39;</span>:
<a name="l15640"></a>15640           op.tryCount++;
<a name="l15641"></a>15641           maybeRetry = <span class="keyword">true</span>;
<a name="l15642"></a>15642           <span class="keywordflow">break</span>;
<a name="l15643"></a>15643         <span class="keywordflow">default</span>: <span class="comment">// (unknown case)</span>
<a name="l15644"></a>15644           op.tryCount += $syncbase.OP_UNKNOWN_ERROR_TRY_COUNT_INCREMENT;
<a name="l15645"></a>15645           maybeRetry = <span class="keyword">true</span>;
<a name="l15646"></a>15646           <span class="keywordflow">break</span>;
<a name="l15647"></a>15647         <span class="keywordflow">case</span> <span class="stringliteral">&#39;failure-give-up&#39;</span>:
<a name="l15648"></a>15648           this._LOG.opGaveUp(op.type, op.longtermId);
<a name="l15649"></a>15649           <span class="comment">// we complete the op, but the error flag is propagated</span>
<a name="l15650"></a>15650           op.lifecycle = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15651"></a>15651           op.serverStatus = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15652"></a>15652           <span class="keywordflow">break</span>;
<a name="l15653"></a>15653         <span class="keywordflow">case</span> <span class="stringliteral">&#39;moot&#39;</span>:
<a name="l15654"></a>15654           this._LOG.opMooted(op.type, op.longtermId);
<a name="l15655"></a>15655           <span class="comment">// we complete the op, but the error flag is propagated</span>
<a name="l15656"></a>15656           op.lifecycle = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15657"></a>15657           op.serverStatus = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15658"></a>15658           <span class="keywordflow">break</span>;
<a name="l15659"></a>15659       }
<a name="l15660"></a>15660     }
<a name="l15661"></a>15661     <span class="keywordflow">else</span> {
<a name="l15662"></a>15662       <span class="keywordflow">switch</span> (op.serverStatus) {
<a name="l15663"></a>15663         <span class="keywordflow">case</span> <span class="stringliteral">&#39;checking&#39;</span>:
<a name="l15664"></a>15664           <span class="comment">// Update the status, and figure out if there is any work to do based</span>
<a name="l15665"></a>15665           <span class="comment">// on our desire.</span>
<a name="l15666"></a>15666           <span class="keywordflow">switch</span> (resultIfAny) {
<a name="l15667"></a>15667             <span class="keywordflow">case</span> <span class="stringliteral">&#39;checked-notyet&#39;</span>:
<a name="l15668"></a>15668             <span class="keywordflow">case</span> <span class="stringliteral">&#39;coherent-notyet&#39;</span>:
<a name="l15669"></a>15669               op.serverStatus = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l15670"></a>15670               <span class="keywordflow">break</span>;
<a name="l15671"></a>15671             <span class="keywordflow">case</span> <span class="stringliteral">&#39;idempotent&#39;</span>:
<a name="l15672"></a>15672               <span class="keywordflow">if</span> (op.lifecycle === <span class="stringliteral">&#39;do&#39;</span> || op.lifecycle === <span class="stringliteral">&#39;done&#39;</span>)
<a name="l15673"></a>15673                 op.serverStatus = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l15674"></a>15674               <span class="keywordflow">else</span>
<a name="l15675"></a>15675                 op.serverStatus = <span class="stringliteral">&#39;done&#39;</span>;
<a name="l15676"></a>15676               <span class="keywordflow">break</span>;
<a name="l15677"></a>15677             <span class="keywordflow">case</span> <span class="stringliteral">&#39;happened&#39;</span>:
<a name="l15678"></a>15678               op.serverStatus = <span class="stringliteral">&#39;done&#39;</span>;
<a name="l15679"></a>15679               <span class="keywordflow">break</span>;
<a name="l15680"></a>15680             <span class="keywordflow">case</span> <span class="stringliteral">&#39;moot&#39;</span>:
<a name="l15681"></a>15681               op.lifecycle = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15682"></a>15682               op.serverStatus = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15683"></a>15683               <span class="keywordflow">break</span>;
<a name="l15684"></a>15684             <span class="comment">// this is the same thing as defer.</span>
<a name="l15685"></a>15685             <span class="keywordflow">case</span> <span class="stringliteral">&#39;bailed&#39;</span>:
<a name="l15686"></a>15686               this._LOG.opDeferred(op.type, op.longtermId);
<a name="l15687"></a>15687               this._deferOp(account, op);
<a name="l15688"></a>15688               completeOp = <span class="keyword">false</span>;
<a name="l15689"></a>15689               <span class="keywordflow">break</span>;
<a name="l15690"></a>15690           }
<a name="l15691"></a>15691           <span class="keywordflow">break</span>;
<a name="l15692"></a>15692         <span class="keywordflow">case</span> <span class="stringliteral">&#39;doing&#39;</span>:
<a name="l15693"></a>15693           op.serverStatus = <span class="stringliteral">&#39;done&#39;</span>;
<a name="l15694"></a>15694           <span class="comment">// lifecycle may have changed to &#39;undo&#39;; don&#39;t mutate if so</span>
<a name="l15695"></a>15695           <span class="keywordflow">if</span> (op.lifecycle === <span class="stringliteral">&#39;do&#39;</span>)
<a name="l15696"></a>15696             op.lifecycle = <span class="stringliteral">&#39;done&#39;</span>;
<a name="l15697"></a>15697           <span class="keywordflow">break</span>;
<a name="l15698"></a>15698         <span class="keywordflow">case</span> <span class="stringliteral">&#39;undoing&#39;</span>:
<a name="l15699"></a>15699           op.serverStatus = <span class="stringliteral">&#39;undone&#39;</span>;
<a name="l15700"></a>15700           <span class="comment">// this will always be true until we gain &#39;redo&#39; functionality</span>
<a name="l15701"></a>15701           <span class="keywordflow">if</span> (op.lifecycle === <span class="stringliteral">&#39;undo&#39;</span>)
<a name="l15702"></a>15702             op.lifecycle = <span class="stringliteral">&#39;undone&#39;</span>;
<a name="l15703"></a>15703           <span class="keywordflow">break</span>;
<a name="l15704"></a>15704       }
<a name="l15705"></a>15705       <span class="comment">// If we still want to do something, then don&#39;t consume the op.</span>
<a name="l15706"></a>15706       <span class="keywordflow">if</span> (op.lifecycle === <span class="stringliteral">&#39;do&#39;</span> || op.lifecycle === <span class="stringliteral">&#39;undo&#39;</span>)
<a name="l15707"></a>15707         consumeOp = <span class="keyword">false</span>;
<a name="l15708"></a>15708     }
<a name="l15709"></a>15709 
<a name="l15710"></a>15710     <span class="keywordflow">if</span> (maybeRetry) {
<a name="l15711"></a>15711       <span class="keywordflow">if</span> (op.tryCount &lt; $syncbase.MAX_OP_TRY_COUNT) {
<a name="l15712"></a>15712         <span class="comment">// We&#39;re still good to try again, but we will need to check the status</span>
<a name="l15713"></a>15713         <span class="comment">// first.</span>
<a name="l15714"></a>15714         op.serverStatus = <span class="stringliteral">&#39;check&#39;</span>;
<a name="l15715"></a>15715         consumeOp = <span class="keyword">false</span>;
<a name="l15716"></a>15716       }
<a name="l15717"></a>15717       <span class="keywordflow">else</span> {
<a name="l15718"></a>15718         this._LOG.opTryLimitReached(op.type, op.longtermId);
<a name="l15719"></a>15719         <span class="comment">// we complete the op, but the error flag is propagated</span>
<a name="l15720"></a>15720         op.lifecycle = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15721"></a>15721         op.serverStatus = <span class="stringliteral">&#39;moot&#39;</span>;
<a name="l15722"></a>15722       }
<a name="l15723"></a>15723     }
<a name="l15724"></a>15724 
<a name="l15725"></a>15725     <span class="keywordflow">if</span> (consumeOp)
<a name="l15726"></a>15726       serverQueue.shift();
<a name="l15727"></a>15727 
<a name="l15728"></a>15728     <span class="comment">// Some completeOp callbacks want to wait for account</span>
<a name="l15729"></a>15729     <span class="comment">// save but they are triggered before save is attempted,</span>
<a name="l15730"></a>15730     <span class="comment">// for the account to properly trigger runAfterSaves</span>
<a name="l15731"></a>15731     <span class="comment">// callbacks, so set a flag indicating save state here.</span>
<a name="l15732"></a>15732     <span class="keywordflow">if</span> (accountSaveSuggested)
<a name="l15733"></a>15733       account._saveAccountIsImminent = <span class="keyword">true</span>;
<a name="l15734"></a>15734 
<a name="l15735"></a>15735     <span class="keywordflow">if</span> (completeOp) {
<a name="l15736"></a>15736       <span class="keywordflow">if</span> (this._opCallbacks.hasOwnProperty(op.longtermId)) {
<a name="l15737"></a>15737         var callback = this._opCallbacks[op.longtermId];
<a name="l15738"></a>15738         <span class="keyword">delete</span> this._opCallbacks[op.longtermId];
<a name="l15739"></a>15739         <span class="keywordflow">try</span> {
<a name="l15740"></a>15740           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(err, resultIfAny, account, op);
<a name="l15741"></a>15741         }
<a name="l15742"></a>15742         <span class="keywordflow">catch</span>(ex) {
<a name="l15743"></a>15743           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(ex.message, ex.stack);
<a name="l15744"></a>15744           this._LOG.opCallbackErr(op.type);
<a name="l15745"></a>15745         }
<a name="l15746"></a>15746       }
<a name="l15747"></a>15747 
<a name="l15748"></a>15748       <span class="comment">// This is a suggestion; in the event of high-throughput on operations,</span>
<a name="l15749"></a>15749       <span class="comment">// we probably don&#39;t want to save the account every tick, etc.</span>
<a name="l15750"></a>15750       <span class="keywordflow">if</span> (accountSaveSuggested) {
<a name="l15751"></a>15751         account._saveAccountIsImminent = <span class="keyword">false</span>;
<a name="l15752"></a>15752         account.saveAccountState(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;serverOp&#39;</span>);
<a name="l15753"></a>15753       }
<a name="l15754"></a>15754     }
<a name="l15755"></a>15755 
<a name="l15756"></a>15756     <span class="keywordflow">if</span> (localQueue.length) {
<a name="l15757"></a>15757       op = localQueue[0];
<a name="l15758"></a>15758       this._dispatchLocalOpForAccount(account, op);
<a name="l15759"></a>15759     }
<a name="l15760"></a>15760     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (serverQueue.length &amp;&amp; <span class="keyword">this</span>.online &amp;&amp; account.enabled) {
<a name="l15761"></a>15761       op = serverQueue[0];
<a name="l15762"></a>15762       this._dispatchServerOpForAccount(account, op);
<a name="l15763"></a>15763     }
<a name="l15764"></a>15764     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (this._opCompletionListenersByAccount[account.id]) {
<a name="l15765"></a>15765       this._opCompletionListenersByAccount[account.id](account);
<a name="l15766"></a>15766       this._opCompletionListenersByAccount[account.id] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l15767"></a>15767     }
<a name="l15768"></a>15768   },
<a name="l15769"></a>15769 
<a name="l15787"></a>15787   _queueAccountOp: <span class="keyword">function</span>(account, op, optionalCallback) {
<a name="l15788"></a>15788     <span class="comment">// - Name the op, register callbacks</span>
<a name="l15789"></a>15789     <span class="keywordflow">if</span> (op.longtermId === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l15790"></a>15790       <span class="comment">// mutation job must be persisted until completed otherwise bad thing</span>
<a name="l15791"></a>15791       <span class="comment">// will happen.</span>
<a name="l15792"></a>15792       op.longtermId = account.id + <span class="charliteral">&#39;/&#39;</span> +
<a name="l15793"></a>15793                         $a64.encodeInt(account.meta.nextMutationNum++);
<a name="l15794"></a>15794       account.mutations.push(op);
<a name="l15795"></a>15795       <span class="comment">// Clear out any completed/dead operations that put us over the undo</span>
<a name="l15796"></a>15796       <span class="comment">// threshold.</span>
<a name="l15797"></a>15797       <span class="keywordflow">while</span> (account.mutations.length &gt; MAX_MUTATIONS_FOR_UNDO &amp;&amp;
<a name="l15798"></a>15798              (account.mutations[0].lifecycle === <span class="stringliteral">&#39;done&#39;</span>) ||
<a name="l15799"></a>15799              (account.mutations[0].lifecycle === <span class="stringliteral">&#39;undone&#39;</span>) ||
<a name="l15800"></a>15800              (account.mutations[0].lifecycle === <span class="stringliteral">&#39;moot&#39;</span>)) {
<a name="l15801"></a>15801         account.mutations.shift();
<a name="l15802"></a>15802       }
<a name="l15803"></a>15803     }
<a name="l15804"></a>15804     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op.longtermId === <span class="stringliteral">&#39;session&#39;</span>) {
<a name="l15805"></a>15805       op.longtermId = account.id + <span class="charliteral">&#39;/&#39;</span> +
<a name="l15806"></a>15806                         $a64.encodeInt(account.meta.nextMutationNum++);
<a name="l15807"></a>15807     }
<a name="l15808"></a>15808 
<a name="l15809"></a>15809     <span class="keywordflow">if</span> (optionalCallback)
<a name="l15810"></a>15810       this._opCallbacks[op.longtermId] = optionalCallback;
<a name="l15811"></a>15811 
<a name="l15812"></a>15812     <span class="comment">// - Enqueue</span>
<a name="l15813"></a>15813     var queues = this._opsByAccount[account.id];
<a name="l15814"></a>15814     <span class="comment">// Local processing needs to happen if we&#39;re not in the right local state.</span>
<a name="l15815"></a>15815     <span class="keywordflow">if</span> (!this._testModeDisablingLocalOps &amp;&amp;
<a name="l15816"></a>15816         ((op.lifecycle === <span class="stringliteral">&#39;do&#39;</span> &amp;&amp; op.localStatus === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) ||
<a name="l15817"></a>15817          (op.lifecycle === <span class="stringliteral">&#39;undo&#39;</span> &amp;&amp; op.localStatus !== <span class="stringliteral">&#39;undone&#39;</span> &amp;&amp;
<a name="l15818"></a>15818           op.localStatus !== <span class="stringliteral">&#39;unknown&#39;</span>)))
<a name="l15819"></a>15819       queues.local.push(op);
<a name="l15820"></a>15820     <span class="keywordflow">if</span> (op.serverStatus !== <span class="stringliteral">&#39;n/a&#39;</span> &amp;&amp; op.serverStatus !== <span class="stringliteral">&#39;moot&#39;</span>)
<a name="l15821"></a>15821       queues.server.push(op);
<a name="l15822"></a>15822 
<a name="l15823"></a>15823     <span class="comment">// If there is already something active, don&#39;t do anything!</span>
<a name="l15824"></a>15824     <span class="keywordflow">if</span> (queues.active) {
<a name="l15825"></a>15825     }
<a name="l15826"></a>15826     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (queues.local.length) {
<a name="l15827"></a>15827       <span class="comment">// Only actually dispatch if there is only the op we just (maybe).</span>
<a name="l15828"></a>15828       <span class="keywordflow">if</span> (queues.local.length === 1 &amp;&amp; queues.local[0] === op)
<a name="l15829"></a>15829         this._dispatchLocalOpForAccount(account, op);
<a name="l15830"></a>15830       <span class="comment">// else: we grabbed control flow to avoid the server queue running</span>
<a name="l15831"></a>15831     }
<a name="l15832"></a>15832     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (queues.server.length === 1 &amp;&amp; queues.server[0] === op &amp;&amp;
<a name="l15833"></a>15833              <span class="keyword">this</span>.online &amp;&amp; account.enabled) {
<a name="l15834"></a>15834       this._dispatchServerOpForAccount(account, op);
<a name="l15835"></a>15835     }
<a name="l15836"></a>15836 
<a name="l15837"></a>15837     <span class="keywordflow">return</span> op.longtermId;
<a name="l15838"></a>15838   },
<a name="l15839"></a>15839 
<a name="l15840"></a>15840   waitForAccountOps: <span class="keyword">function</span>(account, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l15841"></a>15841     var queues = this._opsByAccount[account.id];
<a name="l15842"></a>15842     <span class="keywordflow">if</span> (queues.local.length === 0 &amp;&amp;
<a name="l15843"></a>15843        (queues.server.length === 0 || !<span class="keyword">this</span>.online || !account.enabled))
<a name="l15844"></a>15844       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l15845"></a>15845     <span class="keywordflow">else</span>
<a name="l15846"></a>15846       this._opCompletionListenersByAccount[account.id] = <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>;
<a name="l15847"></a>15847   },
<a name="l15848"></a>15848 
<a name="l15849"></a>15849   syncFolderList: <span class="keyword">function</span>(account, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l15850"></a>15850     this._queueAccountOp(
<a name="l15851"></a>15851       account,
<a name="l15852"></a>15852       {
<a name="l15853"></a>15853         type: <span class="stringliteral">&#39;syncFolderList&#39;</span>,
<a name="l15854"></a>15854         longtermId: <span class="stringliteral">&#39;session&#39;</span>,
<a name="l15855"></a>15855         lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l15856"></a>15856         localStatus: <span class="stringliteral">&#39;done&#39;</span>,
<a name="l15857"></a>15857         serverStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l15858"></a>15858         tryCount: 0,
<a name="l15859"></a>15859         humanOp: <span class="stringliteral">&#39;syncFolderList&#39;</span>
<a name="l15860"></a>15860       },
<a name="l15861"></a>15861       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l15862"></a>15862   },
<a name="l15863"></a>15863 
<a name="l15870"></a>15870   purgeExcessMessages: <span class="keyword">function</span>(account, folderId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l15871"></a>15871     this._queueAccountOp(
<a name="l15872"></a>15872       account,
<a name="l15873"></a>15873       {
<a name="l15874"></a>15874         type: <span class="stringliteral">&#39;purgeExcessMessages&#39;</span>,
<a name="l15875"></a>15875         longtermId: <span class="stringliteral">&#39;session&#39;</span>,
<a name="l15876"></a>15876         lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l15877"></a>15877         localStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l15878"></a>15878         serverStatus: <span class="stringliteral">&#39;n/a&#39;</span>,
<a name="l15879"></a>15879         tryCount: 0,
<a name="l15880"></a>15880         humanOp: <span class="stringliteral">&#39;purgeExcessMessages&#39;</span>,
<a name="l15881"></a>15881         folderId: folderId
<a name="l15882"></a>15882       },
<a name="l15883"></a>15883       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l15884"></a>15884   },
<a name="l15885"></a>15885 
<a name="l15889"></a>15889   downloadMessageBodyReps: <span class="keyword">function</span>(suid, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l15890"></a>15890     var account = this.getAccountForMessageSuid(suid);
<a name="l15891"></a>15891     this._queueAccountOp(
<a name="l15892"></a>15892       account,
<a name="l15893"></a>15893       {
<a name="l15894"></a>15894         type: <span class="stringliteral">&#39;downloadBodyReps&#39;</span>,
<a name="l15895"></a>15895         longtermId: <span class="stringliteral">&#39;session&#39;</span>,
<a name="l15896"></a>15896         lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l15897"></a>15897         localStatus: <span class="stringliteral">&#39;done&#39;</span>,
<a name="l15898"></a>15898         serverStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l15899"></a>15899         tryCount: 0,
<a name="l15900"></a>15900         humanOp: <span class="stringliteral">&#39;downloadBodyReps&#39;</span>,
<a name="l15901"></a>15901         messageSuid: suid,
<a name="l15902"></a>15902         messageDate: date
<a name="l15903"></a>15903       },
<a name="l15904"></a>15904       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>
<a name="l15905"></a>15905     );
<a name="l15906"></a>15906   },
<a name="l15907"></a>15907 
<a name="l15908"></a>15908   downloadBodies: <span class="keyword">function</span>(messages, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l15909"></a>15909     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(options) === <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l15910"></a>15910       callback = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>;
<a name="l15911"></a>15911       options = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l15912"></a>15912     }
<a name="l15913"></a>15913 
<a name="l15914"></a>15914     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l15915"></a>15915     var pending = 0;
<a name="l15916"></a>15916 
<a name="l15917"></a>15917     <span class="keyword">function</span> next() {
<a name="l15918"></a>15918       <span class="keywordflow">if</span> (!--pending) {
<a name="l15919"></a>15919         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l15920"></a>15920       }
<a name="l15921"></a>15921     }
<a name="l15922"></a>15922     this._partitionMessagesByAccount(messages, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>).forEach(<span class="keyword">function</span>(x) {
<a name="l15923"></a>15923       pending++;
<a name="l15924"></a>15924       <span class="keyword">self</span>._queueAccountOp(
<a name="l15925"></a>15925         x.account,
<a name="l15926"></a>15926         {
<a name="l15927"></a>15927           type: <span class="stringliteral">&#39;downloadBodies&#39;</span>,
<a name="l15928"></a>15928           longtermId: <span class="stringliteral">&#39;session&#39;</span>, <span class="comment">// don&#39;t persist this job.</span>
<a name="l15929"></a>15929           lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l15930"></a>15930           localStatus: <span class="stringliteral">&#39;done&#39;</span>,
<a name="l15931"></a>15931           serverStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l15932"></a>15932           tryCount: 0,
<a name="l15933"></a>15933           humanOp: <span class="stringliteral">&#39;downloadBodies&#39;</span>,
<a name="l15934"></a>15934           messages: x.messages,
<a name="l15935"></a>15935           options: options
<a name="l15936"></a>15936         },
<a name="l15937"></a>15937         next
<a name="l15938"></a>15938       );
<a name="l15939"></a>15939     });
<a name="l15940"></a>15940   },
<a name="l15941"></a>15941 
<a name="l15951"></a>15951   downloadMessageAttachments: <span class="keyword">function</span>(messageSuid, messageDate,
<a name="l15952"></a>15952                                        relPartIndices, attachmentIndices,
<a name="l15953"></a>15953                                        <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l15954"></a>15954     var account = this.getAccountForMessageSuid(messageSuid);
<a name="l15955"></a>15955     var longtermId = this._queueAccountOp(
<a name="l15956"></a>15956       account,
<a name="l15957"></a>15957       {
<a name="l15958"></a>15958         type: <span class="stringliteral">&#39;download&#39;</span>,
<a name="l15959"></a>15959         longtermId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l15960"></a>15960         lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l15961"></a>15961         localStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l15962"></a>15962         serverStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l15963"></a>15963         tryCount: 0,
<a name="l15964"></a>15964         humanOp: <span class="stringliteral">&#39;download&#39;</span>,
<a name="l15965"></a>15965         messageSuid: messageSuid,
<a name="l15966"></a>15966         messageDate: messageDate,
<a name="l15967"></a>15967         relPartIndices: relPartIndices,
<a name="l15968"></a>15968         attachmentIndices: attachmentIndices
<a name="l15969"></a>15969       },
<a name="l15970"></a>15970       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l15971"></a>15971   },
<a name="l15972"></a>15972 
<a name="l15973"></a>15973   modifyMessageTags: <span class="keyword">function</span>(humanOp, messageSuids, addTags, removeTags) {
<a name="l15974"></a>15974     var <span class="keyword">self</span> = <span class="keyword">this</span>, longtermIds = [];
<a name="l15975"></a>15975     this._partitionMessagesByAccount(messageSuids, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>).forEach(<span class="keyword">function</span>(x) {
<a name="l15976"></a>15976       var longtermId = <span class="keyword">self</span>._queueAccountOp(
<a name="l15977"></a>15977         x.account,
<a name="l15978"></a>15978         {
<a name="l15979"></a>15979           type: <span class="stringliteral">&#39;modtags&#39;</span>,
<a name="l15980"></a>15980           longtermId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l15981"></a>15981           lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l15982"></a>15982           localStatus: null,
<a name="l15983"></a>15983           serverStatus: null,
<a name="l15984"></a>15984           tryCount: 0,
<a name="l15985"></a>15985           humanOp: humanOp,
<a name="l15986"></a>15986           messages: x.messages,
<a name="l15987"></a>15987           addTags: addTags,
<a name="l15988"></a>15988           removeTags: removeTags,
<a name="l15989"></a>15989           <span class="comment">// how many messages have had their tags changed already.</span>
<a name="l15990"></a>15990           progress: 0,
<a name="l15991"></a>15991         });
<a name="l15992"></a>15992       longtermIds.push(longtermId);
<a name="l15993"></a>15993     });
<a name="l15994"></a>15994     <span class="keywordflow">return</span> longtermIds;
<a name="l15995"></a>15995   },
<a name="l15996"></a>15996 
<a name="l15997"></a>15997   moveMessages: <span class="keyword">function</span>(messageSuids, targetFolderId) {
<a name="l15998"></a>15998     var <span class="keyword">self</span> = <span class="keyword">this</span>, longtermIds = [],
<a name="l15999"></a>15999         targetFolderAccount = this.getAccountForFolderId(targetFolderId);
<a name="l16000"></a>16000     this._partitionMessagesByAccount(messageSuids, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>).forEach(<span class="keyword">function</span>(x) {
<a name="l16001"></a>16001       <span class="comment">// TODO: implement cross-account moves and then remove this constraint</span>
<a name="l16002"></a>16002       <span class="comment">// and instead schedule the cross-account move.</span>
<a name="l16003"></a>16003       <span class="keywordflow">if</span> (x.account !== targetFolderAccount)
<a name="l16004"></a>16004         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;cross-account moves not currently supported!&#39;</span>);
<a name="l16005"></a>16005       var longtermId = <span class="keyword">self</span>._queueAccountOp(
<a name="l16006"></a>16006         x.account,
<a name="l16007"></a>16007         {
<a name="l16008"></a>16008           type: <span class="stringliteral">&#39;move&#39;</span>,
<a name="l16009"></a>16009           longtermId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16010"></a>16010           lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l16011"></a>16011           localStatus: null,
<a name="l16012"></a>16012           serverStatus: null,
<a name="l16013"></a>16013           tryCount: 0,
<a name="l16014"></a>16014           humanOp: <span class="stringliteral">&#39;move&#39;</span>,
<a name="l16015"></a>16015           messages: x.messages,
<a name="l16016"></a>16016           targetFolder: targetFolderId,
<a name="l16017"></a>16017         });
<a name="l16018"></a>16018       longtermIds.push(longtermId);
<a name="l16019"></a>16019     });
<a name="l16020"></a>16020     <span class="keywordflow">return</span> longtermIds;
<a name="l16021"></a>16021   },
<a name="l16022"></a>16022 
<a name="l16023"></a>16023   deleteMessages: <span class="keyword">function</span>(messageSuids) {
<a name="l16024"></a>16024     var <span class="keyword">self</span> = <span class="keyword">this</span>, longtermIds = [];
<a name="l16025"></a>16025     this._partitionMessagesByAccount(messageSuids, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>).forEach(<span class="keyword">function</span>(x) {
<a name="l16026"></a>16026       var longtermId = <span class="keyword">self</span>._queueAccountOp(
<a name="l16027"></a>16027         x.account,
<a name="l16028"></a>16028         {
<a name="l16029"></a>16029           type: <span class="stringliteral">&#39;delete&#39;</span>,
<a name="l16030"></a>16030           longtermId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16031"></a>16031           lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l16032"></a>16032           localStatus: null,
<a name="l16033"></a>16033           serverStatus: null,
<a name="l16034"></a>16034           tryCount: 0,
<a name="l16035"></a>16035           humanOp: <span class="stringliteral">&#39;delete&#39;</span>,
<a name="l16036"></a>16036           messages: x.messages
<a name="l16037"></a>16037         });
<a name="l16038"></a>16038       longtermIds.push(longtermId);
<a name="l16039"></a>16039     });
<a name="l16040"></a>16040     <span class="keywordflow">return</span> longtermIds;
<a name="l16041"></a>16041   },
<a name="l16042"></a>16042 
<a name="l16043"></a>16043   appendMessages: <span class="keyword">function</span>(folderId, messages) {
<a name="l16044"></a>16044     var account = this.getAccountForFolderId(folderId);
<a name="l16045"></a>16045     var longtermId = this._queueAccountOp(
<a name="l16046"></a>16046       account,
<a name="l16047"></a>16047       {
<a name="l16048"></a>16048         type: <span class="stringliteral">&#39;append&#39;</span>,
<a name="l16049"></a>16049         longtermId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16050"></a>16050         lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l16051"></a>16051         localStatus: <span class="stringliteral">&#39;done&#39;</span>,
<a name="l16052"></a>16052         serverStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16053"></a>16053         tryCount: 0,
<a name="l16054"></a>16054         humanOp: <span class="stringliteral">&#39;append&#39;</span>,
<a name="l16055"></a>16055         messages: messages,
<a name="l16056"></a>16056         folderId: folderId,
<a name="l16057"></a>16057       });
<a name="l16058"></a>16058     <span class="keywordflow">return</span> [longtermId];
<a name="l16059"></a>16059   },
<a name="l16060"></a>16060 
<a name="l16064"></a>16064   saveDraft: <span class="keyword">function</span>(account, existingNamer, <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, body, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l16065"></a>16065     this._queueAccountOp(
<a name="l16066"></a>16066       account,
<a name="l16067"></a>16067       {
<a name="l16068"></a>16068         type: <span class="stringliteral">&#39;saveDraft&#39;</span>,
<a name="l16069"></a>16069         longtermId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16070"></a>16070         lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l16071"></a>16071         localStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16072"></a>16072         serverStatus: <span class="stringliteral">&#39;n/a&#39;</span>, <span class="comment">// local-only currently</span>
<a name="l16073"></a>16073         tryCount: 0,
<a name="l16074"></a>16074         humanOp: <span class="stringliteral">&#39;saveDraft&#39;</span>,
<a name="l16075"></a>16075         existingNamer: existingNamer,
<a name="l16076"></a>16076         header: <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>,
<a name="l16077"></a>16077         body: body
<a name="l16078"></a>16078       },
<a name="l16079"></a>16079       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>
<a name="l16080"></a>16080     );
<a name="l16081"></a>16081   },
<a name="l16082"></a>16082 
<a name="l16083"></a>16083   deleteDraft: <span class="keyword">function</span>(account, messageNamer, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l16084"></a>16084     this._queueAccountOp(
<a name="l16085"></a>16085       account,
<a name="l16086"></a>16086       {
<a name="l16087"></a>16087         type: <span class="stringliteral">&#39;deleteDraft&#39;</span>,
<a name="l16088"></a>16088         longtermId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16089"></a>16089         lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l16090"></a>16090         localStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16091"></a>16091         serverStatus: <span class="stringliteral">&#39;n/a&#39;</span>, <span class="comment">// local-only currently</span>
<a name="l16092"></a>16092         tryCount: 0,
<a name="l16093"></a>16093         humanOp: <span class="stringliteral">&#39;deleteDraft&#39;</span>,
<a name="l16094"></a>16094         messageNamer: messageNamer
<a name="l16095"></a>16095       },
<a name="l16096"></a>16096       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>
<a name="l16097"></a>16097     );
<a name="l16098"></a>16098 
<a name="l16099"></a>16099   },
<a name="l16100"></a>16100 
<a name="l16143"></a>16143   createFolder: <span class="keyword">function</span>(accountId, parentFolderId, folderName,
<a name="l16144"></a>16144                          containOnlyOtherFolders, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l16145"></a>16145     var account = this.getAccountForAccountId(accountId);
<a name="l16146"></a>16146     var longtermId = this._queueAccountOp(
<a name="l16147"></a>16147       account,
<a name="l16148"></a>16148       {
<a name="l16149"></a>16149         type: <span class="stringliteral">&#39;createFolder&#39;</span>,
<a name="l16150"></a>16150         longtermId: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16151"></a>16151         lifecycle: <span class="stringliteral">&#39;do&#39;</span>,
<a name="l16152"></a>16152         localStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16153"></a>16153         serverStatus: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l16154"></a>16154         tryCount: 0,
<a name="l16155"></a>16155         humanOp: <span class="stringliteral">&#39;createFolder&#39;</span>,
<a name="l16156"></a>16156         parentFolderId: parentFolderId,
<a name="l16157"></a>16157         folderName: folderName,
<a name="l16158"></a>16158         containOnlyOtherFolders: containOnlyOtherFolders
<a name="l16159"></a>16159       },
<a name="l16160"></a>16160       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l16161"></a>16161     <span class="keywordflow">return</span> [longtermId];
<a name="l16162"></a>16162   },
<a name="l16163"></a>16163 
<a name="l16168"></a>16168   undoMutation: <span class="keyword">function</span>(longtermIds) {
<a name="l16169"></a>16169     <span class="keywordflow">for</span> (var i = 0; i &lt; longtermIds.length; i++) {
<a name="l16170"></a>16170       var longtermId = longtermIds[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l16171"></a>16171           account = this.getAccountForFolderId(longtermId), <span class="comment">// (it&#39;s fine)</span>
<a name="l16172"></a>16172           queues = this._opsByAccount[account.id];
<a name="l16173"></a>16173 
<a name="l16174"></a>16174       <span class="keywordflow">for</span> (var iOp = 0; iOp &lt; account.mutations.length; iOp++) {
<a name="l16175"></a>16175         var op = account.mutations[iOp];
<a name="l16176"></a>16176         <span class="keywordflow">if</span> (op.longtermId === longtermId) {
<a name="l16177"></a>16177           <span class="comment">// There is nothing to do if we have already processed the request or</span>
<a name="l16178"></a>16178           <span class="comment">// or the op has already been fully undone.</span>
<a name="l16179"></a>16179           <span class="keywordflow">if</span> (op.lifecycle === <span class="stringliteral">&#39;undo&#39;</span> || op.lifecycle === <span class="stringliteral">&#39;undone&#39;</span>) {
<a name="l16180"></a>16180             <span class="keywordflow">continue</span>;
<a name="l16181"></a>16181           }
<a name="l16182"></a>16182 
<a name="l16183"></a>16183           <span class="comment">// Queue an undo operation if we&#39;re already done.</span>
<a name="l16184"></a>16184           <span class="keywordflow">if</span> (op.lifecycle === <span class="stringliteral">&#39;done&#39;</span>) {
<a name="l16185"></a>16185             op.lifecycle = <span class="stringliteral">&#39;undo&#39;</span>;
<a name="l16186"></a>16186             this._queueAccountOp(account, op);
<a name="l16187"></a>16187             <span class="keywordflow">continue</span>;
<a name="l16188"></a>16188           }
<a name="l16189"></a>16189           <span class="comment">// else op.lifecycle === &#39;do&#39;</span>
<a name="l16190"></a>16190 
<a name="l16191"></a>16191           <span class="comment">// If we have not yet started processing the operation, we can</span>
<a name="l16192"></a>16192           <span class="comment">// simply remove the operation from the local queue.</span>
<a name="l16193"></a>16193           var idx = queues.local.indexOf(op);
<a name="l16194"></a>16194           <span class="keywordflow">if</span> (idx !== -1) {
<a name="l16195"></a>16195               op.lifecycle = <span class="stringliteral">&#39;undone&#39;</span>;
<a name="l16196"></a>16196               queues.local.splice(idx, 1);
<a name="l16197"></a>16197               <span class="keywordflow">continue</span>;
<a name="l16198"></a>16198           }
<a name="l16199"></a>16199           <span class="comment">// (the operation must have already been run locally, which means</span>
<a name="l16200"></a>16200           <span class="comment">// that at the very least we need to local_undo, so queue it.)</span>
<a name="l16201"></a>16201 
<a name="l16202"></a>16202           op.lifecycle = <span class="stringliteral">&#39;undo&#39;</span>;
<a name="l16203"></a>16203           this._queueAccountOp(account, op);
<a name="l16204"></a>16204         }
<a name="l16205"></a>16205       }
<a name="l16206"></a>16206     }
<a name="l16207"></a>16207   },
<a name="l16208"></a>16208 
<a name="l16210"></a>16210 };
<a name="l16211"></a>16211 
<a name="l16212"></a>16212 var LOGFAB = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.LOGFAB = $log.register($module, {
<a name="l16213"></a>16213   MailUniverse: {
<a name="l16214"></a>16214     type: $log.ACCOUNT,
<a name="l16215"></a>16215     events: {
<a name="l16216"></a>16216       configCreated: {},
<a name="l16217"></a>16217       configMigrating: {},
<a name="l16218"></a>16218       configLoaded: {},
<a name="l16219"></a>16219       createAccount: { type: <span class="keyword">true</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l16220"></a>16220       opDeferred: { type: <span class="keyword">true</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l16221"></a>16221       opTryLimitReached: { type: <span class="keyword">true</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l16222"></a>16222       opGaveUp: { type: <span class="keyword">true</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l16223"></a>16223       opMooted: { type: <span class="keyword">true</span>, <span class="keywordtype">id</span>: <span class="keyword">false</span> },
<a name="l16224"></a>16224     },
<a name="l16225"></a>16225     TEST_ONLY_events: {
<a name="l16226"></a>16226       configCreated: { config: <span class="keyword">false</span> },
<a name="l16227"></a>16227       configMigrating: { lazyCarryover: <span class="keyword">false</span> },
<a name="l16228"></a>16228       configLoaded: { config: <span class="keyword">false</span>, accounts: <span class="keyword">false</span> },
<a name="l16229"></a>16229       createAccount: { <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="keyword">false</span> },
<a name="l16230"></a>16230     },
<a name="l16231"></a>16231     errors: {
<a name="l16232"></a>16232       badAccountType: { type: <span class="keyword">true</span> },
<a name="l16233"></a>16233       opCallbackErr: { type: <span class="keyword">false</span> },
<a name="l16234"></a>16234       opInvariantFailure: {},
<a name="l16235"></a>16235     },
<a name="l16236"></a>16236   },
<a name="l16237"></a>16237 });
<a name="l16238"></a>16238 
<a name="l16239"></a>16239 }); <span class="comment">// end define</span>
<a name="l16240"></a>16240 ;
<a name="l16241"></a>16241 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/worker-setup&#39;</span>,
<a name="l16242"></a>16242   [
<a name="l16243"></a>16243     <span class="stringliteral">&#39;./shim-sham&#39;</span>,
<a name="l16244"></a>16244     <span class="stringliteral">&#39;./worker-router&#39;</span>,
<a name="l16245"></a>16245     <span class="stringliteral">&#39;./mailbridge&#39;</span>,
<a name="l16246"></a>16246     <span class="stringliteral">&#39;./mailuniverse&#39;</span>,
<a name="l16247"></a>16247     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l16248"></a>16248   ],
<a name="l16249"></a>16249   <span class="keyword">function</span>(
<a name="l16250"></a>16250     $shim_setup,
<a name="l16251"></a>16251     $router,
<a name="l16252"></a>16252     $mailbridge,
<a name="l16253"></a>16253     $mailuniverse,
<a name="l16254"></a>16254     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l16255"></a>16255   ) {
<a name="l16256"></a>16256 
<a name="l16257"></a>16257 
<a name="l16258"></a>16258 var routerBridgeMaker = $router.registerInstanceType(<span class="stringliteral">&#39;bridge&#39;</span>);
<a name="l16259"></a>16259 
<a name="l16260"></a>16260 var bridgeUniqueIdentifier = 0;
<a name="l16261"></a>16261 <span class="keyword">function</span> createBridgePair(universe) {
<a name="l16262"></a>16262   var uid = bridgeUniqueIdentifier++;
<a name="l16263"></a>16263 
<a name="l16264"></a>16264   var TMB = <span class="keyword">new</span> $mailbridge.MailBridge(universe);
<a name="l16265"></a>16265   var routerInfo = routerBridgeMaker.register(<span class="keyword">function</span>(data) {
<a name="l16266"></a>16266     TMB.__receiveMessage(data.msg);
<a name="l16267"></a>16267   });
<a name="l16268"></a>16268   var sendMessage = routerInfo.sendMessage;
<a name="l16269"></a>16269 
<a name="l16270"></a>16270   TMB.__sendMessage = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l16271"></a>16271     TMB._LOG.send(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>.type, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>);
<a name="l16272"></a>16272     sendMessage(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>);
<a name="l16273"></a>16273   };
<a name="l16274"></a>16274 
<a name="l16275"></a>16275   <span class="comment">// Let&#39;s say hello to the main thread in order to generate a</span>
<a name="l16276"></a>16276   <span class="comment">// corresponding mailAPI.</span>
<a name="l16277"></a>16277   TMB.__sendMessage({
<a name="l16278"></a>16278     type: <span class="stringliteral">&#39;hello&#39;</span>,
<a name="l16279"></a>16279     config: universe.exposeConfigForClient()
<a name="l16280"></a>16280   });
<a name="l16281"></a>16281 }
<a name="l16282"></a>16282 
<a name="l16283"></a>16283 var universe = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l16284"></a>16284 
<a name="l16285"></a>16285 <span class="keyword">function</span> onUniverse() {
<a name="l16286"></a>16286   createBridgePair(universe);
<a name="l16287"></a>16287   <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&quot;Mail universe/bridge created and notified!&quot;</span>);
<a name="l16288"></a>16288 }
<a name="l16289"></a>16289 
<a name="l16290"></a>16290 var sendControl = $router.registerSimple(<span class="stringliteral">&#39;control&#39;</span>, <span class="keyword">function</span>(data) {
<a name="l16291"></a>16291   var args = data.args;
<a name="l16292"></a>16292   <span class="keywordflow">switch</span> (data.cmd) {
<a name="l16293"></a>16293     <span class="keywordflow">case</span> <span class="stringliteral">&#39;hello&#39;</span>:
<a name="l16294"></a>16294       universe = <span class="keyword">new</span> $mailuniverse.MailUniverse(onUniverse, args[0]);
<a name="l16295"></a>16295       <span class="keywordflow">break</span>;
<a name="l16296"></a>16296 
<a name="l16297"></a>16297     <span class="keywordflow">case</span> <span class="stringliteral">&#39;online&#39;</span>:
<a name="l16298"></a>16298     <span class="keywordflow">case</span> <span class="stringliteral">&#39;offline&#39;</span>:
<a name="l16299"></a>16299       universe._onConnectionChange(args[0]);
<a name="l16300"></a>16300       <span class="keywordflow">break</span>;
<a name="l16301"></a>16301   }
<a name="l16302"></a>16302 });
<a name="l16303"></a>16303 sendControl(<span class="stringliteral">&#39;hello&#39;</span>);
<a name="l16304"></a>16304 
<a name="l16306"></a>16306 
<a name="l16307"></a>16307 });
<a name="l16308"></a>16308 
<a name="l16309"></a>16309 <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&quot;mailapi/worker-setup&quot;</span>]);
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../de/db5/build__stage_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html">worker-bootstrap.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:55:39に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
