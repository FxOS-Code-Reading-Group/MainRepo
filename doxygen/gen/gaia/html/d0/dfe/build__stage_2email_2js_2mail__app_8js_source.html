<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: mail_app.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d0/dfe/build__stage_2email_2js_2mail__app_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">mail_app.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00007"></a>00007 <span class="comment">//Going sloppy to avoid &#39;use strict&#39; string cost, but strict practices should</span>
<a name="l00008"></a>00008 <span class="comment">//be followed.</span>
<a name="l00009"></a>00009 <span class="comment">/*jslint sloppy: true, nomen: true, regexp: true */</span>
<a name="l00010"></a>00010 <span class="comment">/*global setTimeout, process, document, navigator, importScripts */</span>
<a name="l00011"></a>00011 
<a name="l00012"></a><a class="code" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html#a44c2a92e377407b0af593e79fa27596f">00012</a> var <a class="code" href="../../d9/d2e/alameda_8js.html#a44c2a92e377407b0af593e79fa27596f">requirejs</a>, <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>;
<a name="l00013"></a><a class="code" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html#a57efe929cc6b44042891d05e15cec785">00013</a> (<span class="keyword">function</span> (<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a5363025b2c2d773292f0f064aeb11f9e">global</a>, <a class="code" href="../../d6/da5/libpinyin_8js.html#a15c298ba1ef694b2dfafb07508cb8645">undef</a>) {
<a name="l00014"></a>00014     var prim, topReq, dataMain,
<a name="l00015"></a>00015         bootstrapConfig = <a class="code" href="../../d9/d2e/alameda_8js.html#a44c2a92e377407b0af593e79fa27596f">requirejs</a> || <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>,
<a name="l00016"></a>00016         hasOwn = Object.prototype.hasOwnProperty,
<a name="l00017"></a>00017         contexts = {},
<a name="l00018"></a>00018         queue = [],
<a name="l00019"></a>00019         currDirRegExp = /^\.\<span class="comment">//,</span>
<a name="l00020"></a>00020         urlRegExp = /^\/|\:|\?|\.js$/,
<a name="l00021"></a>00021         commentRegExp = /(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg,
<a name="l00022"></a>00022         cjsRequireRegExp = /[^.]\s*require\s*\(\s*[<span class="stringliteral">&quot;&#39;]([^&#39;&quot;</span>\s]+)[<span class="stringliteral">&quot;&#39;]\s*\)/g,</span>
<a name="l00023"></a>00023 <span class="stringliteral">        jsSuffixRegExp = /\.js$/;</span>
<a name="l00024"></a>00024 <span class="stringliteral"></span>
<a name="l00025"></a>00025 <span class="stringliteral">    if (typeof requirejs === &#39;function&#39;) {</span>
<a name="l00026"></a>00026 <span class="stringliteral">        return;</span>
<a name="l00027"></a>00027 <span class="stringliteral">    }</span>
<a name="l00028"></a>00028 <span class="stringliteral"></span>
<a name="l00029"></a>00029 <span class="stringliteral">    function hasProp(obj, prop) {</span>
<a name="l00030"></a>00030 <span class="stringliteral">        return hasOwn.call(obj, prop);</span>
<a name="l00031"></a>00031 <span class="stringliteral">    }</span>
<a name="l00032"></a>00032 <span class="stringliteral"></span>
<a name="l00033"></a>00033 <span class="stringliteral">    function getOwn(obj, prop) {</span>
<a name="l00034"></a>00034 <span class="stringliteral">        return obj &amp;&amp; hasProp(obj, prop) &amp;&amp; obj[prop];</span>
<a name="l00035"></a>00035 <span class="stringliteral">    }</span>
<a name="l00036"></a>00036 <span class="stringliteral"></span>
<a name="l00042"></a>00042 <span class="stringliteral">    function eachProp(obj, func) {</span>
<a name="l00043"></a>00043 <span class="stringliteral">        var prop;</span>
<a name="l00044"></a>00044 <span class="stringliteral">        for (prop in obj) {</span>
<a name="l00045"></a>00045 <span class="stringliteral">            if (hasProp(obj, prop)) {</span>
<a name="l00046"></a>00046 <span class="stringliteral">                if (func(obj[prop], prop)) {</span>
<a name="l00047"></a>00047 <span class="stringliteral">                    break;</span>
<a name="l00048"></a>00048 <span class="stringliteral">                }</span>
<a name="l00049"></a>00049 <span class="stringliteral">            }</span>
<a name="l00050"></a>00050 <span class="stringliteral">        }</span>
<a name="l00051"></a>00051 <span class="stringliteral">    }</span>
<a name="l00052"></a>00052 <span class="stringliteral"></span>
<a name="l00057"></a>00057 <span class="stringliteral">    function mixin(target, source, force, deepStringMixin) {</span>
<a name="l00058"></a>00058 <span class="stringliteral">        if (source) {</span>
<a name="l00059"></a>00059 <span class="stringliteral">            eachProp(source, function (value, prop) {</span>
<a name="l00060"></a>00060 <span class="stringliteral">                if (force || !hasProp(target, prop)) {</span>
<a name="l00061"></a>00061 <span class="stringliteral">                    if (deepStringMixin &amp;&amp; typeof value !== &#39;string&#39;) {</span>
<a name="l00062"></a>00062 <span class="stringliteral">                        if (!target[prop]) {</span>
<a name="l00063"></a>00063 <span class="stringliteral">                            target[prop] = {};</span>
<a name="l00064"></a>00064 <span class="stringliteral">                        }</span>
<a name="l00065"></a>00065 <span class="stringliteral">                        mixin(target[prop], value, force, deepStringMixin);</span>
<a name="l00066"></a>00066 <span class="stringliteral">                    } else {</span>
<a name="l00067"></a>00067 <span class="stringliteral">                        target[prop] = value;</span>
<a name="l00068"></a>00068 <span class="stringliteral">                    }</span>
<a name="l00069"></a>00069 <span class="stringliteral">                }</span>
<a name="l00070"></a>00070 <span class="stringliteral">            });</span>
<a name="l00071"></a>00071 <span class="stringliteral">        }</span>
<a name="l00072"></a>00072 <span class="stringliteral">        return target;</span>
<a name="l00073"></a>00073 <span class="stringliteral">    }</span>
<a name="l00074"></a>00074 <span class="stringliteral"></span>
<a name="l00075"></a>00075 <span class="stringliteral">    //Allow getting a global that expressed in</span>
<a name="l00076"></a>00076 <span class="stringliteral">    //dot notation, like &#39;a.b.c&#39;.</span>
<a name="l00077"></a>00077 <span class="stringliteral">    function getGlobal(value) {</span>
<a name="l00078"></a>00078 <span class="stringliteral">        if (!value) {</span>
<a name="l00079"></a>00079 <span class="stringliteral">            return value;</span>
<a name="l00080"></a>00080 <span class="stringliteral">        }</span>
<a name="l00081"></a>00081 <span class="stringliteral">        var g = global;</span>
<a name="l00082"></a>00082 <span class="stringliteral">        value.split(&#39;.&#39;).forEach(function (part) {</span>
<a name="l00083"></a>00083 <span class="stringliteral">            g = g[part];</span>
<a name="l00084"></a>00084 <span class="stringliteral">        });</span>
<a name="l00085"></a>00085 <span class="stringliteral">        return g;</span>
<a name="l00086"></a>00086 <span class="stringliteral">    }</span>
<a name="l00087"></a>00087 <span class="stringliteral"></span>
<a name="l00088"></a>00088 <span class="stringliteral">    //START prim</span>
<a name="l00102"></a>00102 <span class="stringliteral">    /*global setImmediate, process, setTimeout */</span>
<a name="l00103"></a>00103 <span class="stringliteral">    (function () {</span>
<a name="l00104"></a>00104 <span class="stringliteral">        </span>
<a name="l00105"></a>00105 <span class="stringliteral">        var waitingId,</span>
<a name="l00106"></a>00106 <span class="stringliteral">            waiting = [];</span>
<a name="l00107"></a>00107 <span class="stringliteral"></span>
<a name="l00108"></a>00108 <span class="stringliteral">        function check(p) {</span>
<a name="l00109"></a>00109 <span class="stringliteral">            if (hasProp(p, &#39;e&#39;) || hasProp(p, &#39;v&#39;)) {</span>
<a name="l00110"></a>00110 <span class="stringliteral">                throw new Error(&#39;nope&#39;);</span>
<a name="l00111"></a>00111 <span class="stringliteral">            }</span>
<a name="l00112"></a>00112 <span class="stringliteral">            return true;</span>
<a name="l00113"></a>00113 <span class="stringliteral">        }</span>
<a name="l00114"></a>00114 <span class="stringliteral"></span>
<a name="l00115"></a>00115 <span class="stringliteral">        function callWaiting() {</span>
<a name="l00116"></a>00116 <span class="stringliteral">            waitingId = 0;</span>
<a name="l00117"></a>00117 <span class="stringliteral">            var w = waiting;</span>
<a name="l00118"></a>00118 <span class="stringliteral">            waiting = [];</span>
<a name="l00119"></a>00119 <span class="stringliteral">            while (w.length) {</span>
<a name="l00120"></a>00120 <span class="stringliteral">                w.shift()();</span>
<a name="l00121"></a>00121 <span class="stringliteral">            }</span>
<a name="l00122"></a>00122 <span class="stringliteral">        }</span>
<a name="l00123"></a>00123 <span class="stringliteral"></span>
<a name="l00124"></a>00124 <span class="stringliteral">        function asyncTick(fn) {</span>
<a name="l00125"></a>00125 <span class="stringliteral">            waiting.push(fn);</span>
<a name="l00126"></a>00126 <span class="stringliteral">            if (!waitingId) {</span>
<a name="l00127"></a>00127 <span class="stringliteral">                waitingId = setTimeout(callWaiting, 0);</span>
<a name="l00128"></a>00128 <span class="stringliteral">            }</span>
<a name="l00129"></a>00129 <span class="stringliteral">        }</span>
<a name="l00130"></a>00130 <span class="stringliteral"></span>
<a name="l00131"></a>00131 <span class="stringliteral">        function syncTick(fn) {</span>
<a name="l00132"></a>00132 <span class="stringliteral">            fn();</span>
<a name="l00133"></a>00133 <span class="stringliteral">        }</span>
<a name="l00134"></a>00134 <span class="stringliteral"></span>
<a name="l00135"></a>00135 <span class="stringliteral">        function notify(ary, value) {</span>
<a name="l00136"></a>00136 <span class="stringliteral">            prim.nextTick(function () {</span>
<a name="l00137"></a>00137 <span class="stringliteral">                ary.forEach(function (item) {</span>
<a name="l00138"></a>00138 <span class="stringliteral">                    item(value);</span>
<a name="l00139"></a>00139 <span class="stringliteral">                });</span>
<a name="l00140"></a>00140 <span class="stringliteral">            });</span>
<a name="l00141"></a>00141 <span class="stringliteral">        }</span>
<a name="l00142"></a>00142 <span class="stringliteral"></span>
<a name="l00143"></a>00143 <span class="stringliteral">        prim = function prim(options) {</span>
<a name="l00144"></a>00144 <span class="stringliteral">            var p,</span>
<a name="l00145"></a>00145 <span class="stringliteral">                ok = [],</span>
<a name="l00146"></a>00146 <span class="stringliteral">                fail = [],</span>
<a name="l00147"></a>00147 <span class="stringliteral">                nextTick = options &amp;&amp; options.sync ? syncTick : prim.nextTick;</span>
<a name="l00148"></a>00148 <span class="stringliteral"></span>
<a name="l00149"></a>00149 <span class="stringliteral">            return (p = {</span>
<a name="l00150"></a>00150 <span class="stringliteral">                callback: function (yes, no) {</span>
<a name="l00151"></a>00151 <span class="stringliteral">                    if (no) {</span>
<a name="l00152"></a>00152 <span class="stringliteral">                        p.errback(no);</span>
<a name="l00153"></a>00153 <span class="stringliteral">                    }</span>
<a name="l00154"></a>00154 <span class="stringliteral"></span>
<a name="l00155"></a>00155 <span class="stringliteral">                    if (hasProp(p, &#39;v&#39;)) {</span>
<a name="l00156"></a>00156 <span class="stringliteral">                        nextTick(function () {</span>
<a name="l00157"></a>00157 <span class="stringliteral">                            yes(p.v);</span>
<a name="l00158"></a>00158 <span class="stringliteral">                        });</span>
<a name="l00159"></a>00159 <span class="stringliteral">                    } else {</span>
<a name="l00160"></a>00160 <span class="stringliteral">                        ok.push(yes);</span>
<a name="l00161"></a>00161 <span class="stringliteral">                    }</span>
<a name="l00162"></a>00162 <span class="stringliteral">                },</span>
<a name="l00163"></a>00163 <span class="stringliteral"></span>
<a name="l00164"></a>00164 <span class="stringliteral">                errback: function (no) {</span>
<a name="l00165"></a>00165 <span class="stringliteral">                    if (hasProp(p, &#39;e&#39;)) {</span>
<a name="l00166"></a>00166 <span class="stringliteral">                        nextTick(function () {</span>
<a name="l00167"></a>00167 <span class="stringliteral">                            no(p.e);</span>
<a name="l00168"></a>00168 <span class="stringliteral">                        });</span>
<a name="l00169"></a>00169 <span class="stringliteral">                    } else {</span>
<a name="l00170"></a>00170 <span class="stringliteral">                        fail.push(no);</span>
<a name="l00171"></a>00171 <span class="stringliteral">                    }</span>
<a name="l00172"></a>00172 <span class="stringliteral">                },</span>
<a name="l00173"></a>00173 <span class="stringliteral"></span>
<a name="l00174"></a>00174 <span class="stringliteral">                finished: function () {</span>
<a name="l00175"></a>00175 <span class="stringliteral">                    return hasProp(p, &#39;e&#39;) || hasProp(p, &#39;v&#39;);</span>
<a name="l00176"></a>00176 <span class="stringliteral">                },</span>
<a name="l00177"></a>00177 <span class="stringliteral"></span>
<a name="l00178"></a>00178 <span class="stringliteral">                rejected: function () {</span>
<a name="l00179"></a>00179 <span class="stringliteral">                    return hasProp(p, &#39;e&#39;);</span>
<a name="l00180"></a>00180 <span class="stringliteral">                },</span>
<a name="l00181"></a>00181 <span class="stringliteral"></span>
<a name="l00182"></a>00182 <span class="stringliteral">                resolve: function (v) {</span>
<a name="l00183"></a>00183 <span class="stringliteral">                    if (check(p)) {</span>
<a name="l00184"></a>00184 <span class="stringliteral">                        p.v = v;</span>
<a name="l00185"></a>00185 <span class="stringliteral">                        notify(ok, v);</span>
<a name="l00186"></a>00186 <span class="stringliteral">                    }</span>
<a name="l00187"></a>00187 <span class="stringliteral">                    return p;</span>
<a name="l00188"></a>00188 <span class="stringliteral">                },</span>
<a name="l00189"></a>00189 <span class="stringliteral">                reject: function (e) {</span>
<a name="l00190"></a>00190 <span class="stringliteral">                    if (check(p)) {</span>
<a name="l00191"></a>00191 <span class="stringliteral">                        p.e = e;</span>
<a name="l00192"></a>00192 <span class="stringliteral">                        notify(fail, e);</span>
<a name="l00193"></a>00193 <span class="stringliteral">                    }</span>
<a name="l00194"></a>00194 <span class="stringliteral">                    return p;</span>
<a name="l00195"></a>00195 <span class="stringliteral">                },</span>
<a name="l00196"></a>00196 <span class="stringliteral"></span>
<a name="l00197"></a>00197 <span class="stringliteral">                start: function (fn) {</span>
<a name="l00198"></a>00198 <span class="stringliteral">                    p.resolve();</span>
<a name="l00199"></a>00199 <span class="stringliteral">                    return p.promise.then(fn);</span>
<a name="l00200"></a>00200 <span class="stringliteral">                },</span>
<a name="l00201"></a>00201 <span class="stringliteral"></span>
<a name="l00202"></a>00202 <span class="stringliteral">                promise: {</span>
<a name="l00203"></a>00203 <span class="stringliteral">                    then: function (yes, no) {</span>
<a name="l00204"></a>00204 <span class="stringliteral">                        var next = prim(options);</span>
<a name="l00205"></a>00205 <span class="stringliteral"></span>
<a name="l00206"></a>00206 <span class="stringliteral">                        p.callback(function (v) {</span>
<a name="l00207"></a>00207 <span class="stringliteral">                            try {</span>
<a name="l00208"></a>00208 <span class="stringliteral">                                if (yes &amp;&amp; typeof yes === &#39;function&#39;) {</span>
<a name="l00209"></a>00209 <span class="stringliteral">                                    v = yes(v);</span>
<a name="l00210"></a>00210 <span class="stringliteral">                                }</span>
<a name="l00211"></a>00211 <span class="stringliteral"></span>
<a name="l00212"></a>00212 <span class="stringliteral">                                if (v &amp;&amp; typeof v.then === &#39;function&#39;) {</span>
<a name="l00213"></a>00213 <span class="stringliteral">                                    v.then(next.resolve, next.reject);</span>
<a name="l00214"></a>00214 <span class="stringliteral">                                } else {</span>
<a name="l00215"></a>00215 <span class="stringliteral">                                    next.resolve(v);</span>
<a name="l00216"></a>00216 <span class="stringliteral">                                }</span>
<a name="l00217"></a>00217 <span class="stringliteral">                            } catch (e) {</span>
<a name="l00218"></a>00218 <span class="stringliteral">                                next.reject(e);</span>
<a name="l00219"></a>00219 <span class="stringliteral">                            }</span>
<a name="l00220"></a>00220 <span class="stringliteral">                        }, function (e) {</span>
<a name="l00221"></a>00221 <span class="stringliteral">                            var err;</span>
<a name="l00222"></a>00222 <span class="stringliteral"></span>
<a name="l00223"></a>00223 <span class="stringliteral">                            try {</span>
<a name="l00224"></a>00224 <span class="stringliteral">                                if (!no || typeof no !== &#39;function&#39;) {</span>
<a name="l00225"></a>00225 <span class="stringliteral">                                    next.reject(e);</span>
<a name="l00226"></a>00226 <span class="stringliteral">                                } else {</span>
<a name="l00227"></a>00227 <span class="stringliteral">                                    err = no(e);</span>
<a name="l00228"></a>00228 <span class="stringliteral"></span>
<a name="l00229"></a>00229 <span class="stringliteral">                                    if (err &amp;&amp; typeof err.then === &#39;function&#39;) {</span>
<a name="l00230"></a>00230 <span class="stringliteral">                                        err.then(next.resolve, next.reject);</span>
<a name="l00231"></a>00231 <span class="stringliteral">                                    } else {</span>
<a name="l00232"></a>00232 <span class="stringliteral">                                        next.resolve(err);</span>
<a name="l00233"></a>00233 <span class="stringliteral">                                    }</span>
<a name="l00234"></a>00234 <span class="stringliteral">                                }</span>
<a name="l00235"></a>00235 <span class="stringliteral">                            } catch (e2) {</span>
<a name="l00236"></a>00236 <span class="stringliteral">                                next.reject(e2);</span>
<a name="l00237"></a>00237 <span class="stringliteral">                            }</span>
<a name="l00238"></a>00238 <span class="stringliteral">                        });</span>
<a name="l00239"></a>00239 <span class="stringliteral"></span>
<a name="l00240"></a>00240 <span class="stringliteral">                        return next.promise;</span>
<a name="l00241"></a>00241 <span class="stringliteral">                    },</span>
<a name="l00242"></a>00242 <span class="stringliteral"></span>
<a name="l00243"></a>00243 <span class="stringliteral">                    fail: function (no) {</span>
<a name="l00244"></a>00244 <span class="stringliteral">                        return p.promise.then(null, no);</span>
<a name="l00245"></a>00245 <span class="stringliteral">                    },</span>
<a name="l00246"></a>00246 <span class="stringliteral"></span>
<a name="l00247"></a>00247 <span class="stringliteral">                    end: function () {</span>
<a name="l00248"></a>00248 <span class="stringliteral">                        p.errback(function (e) {</span>
<a name="l00249"></a>00249 <span class="stringliteral">                            throw e;</span>
<a name="l00250"></a>00250 <span class="stringliteral">                        });</span>
<a name="l00251"></a>00251 <span class="stringliteral">                    }</span>
<a name="l00252"></a>00252 <span class="stringliteral">                }</span>
<a name="l00253"></a>00253 <span class="stringliteral">            });</span>
<a name="l00254"></a>00254 <span class="stringliteral">        };</span>
<a name="l00255"></a>00255 <span class="stringliteral">        prim.serial = function (ary) {</span>
<a name="l00256"></a>00256 <span class="stringliteral">            var result = prim().resolve().promise;</span>
<a name="l00257"></a>00257 <span class="stringliteral">            ary.forEach(function (item) {</span>
<a name="l00258"></a>00258 <span class="stringliteral">                result = result.then(function () {</span>
<a name="l00259"></a>00259 <span class="stringliteral">                    return item();</span>
<a name="l00260"></a>00260 <span class="stringliteral">                });</span>
<a name="l00261"></a>00261 <span class="stringliteral">            });</span>
<a name="l00262"></a>00262 <span class="stringliteral">            return result;</span>
<a name="l00263"></a>00263 <span class="stringliteral">        };</span>
<a name="l00264"></a>00264 <span class="stringliteral"></span>
<a name="l00265"></a>00265 <span class="stringliteral">        prim.nextTick = typeof setImmediate === &#39;function&#39; ? setImmediate :</span>
<a name="l00266"></a>00266 <span class="stringliteral">            (typeof process !== &#39;undefined&#39; &amp;&amp; process.nextTick ?</span>
<a name="l00267"></a>00267 <span class="stringliteral">                process.nextTick : (typeof setTimeout !== &#39;undefined&#39; ?</span>
<a name="l00268"></a>00268 <span class="stringliteral">                    asyncTick : syncTick));</span>
<a name="l00269"></a>00269 <span class="stringliteral">    }());</span>
<a name="l00270"></a>00270 <span class="stringliteral">    //END prim</span>
<a name="l00271"></a>00271 <span class="stringliteral"></span>
<a name="l00272"></a>00272 <span class="stringliteral">    function newContext(contextName) {</span>
<a name="l00273"></a>00273 <span class="stringliteral">        var req, main, makeMap, callDep, handlers, checkingLater, load, context,</span>
<a name="l00274"></a>00274 <span class="stringliteral">            defined = {},</span>
<a name="l00275"></a>00275 <span class="stringliteral">            waiting = {},</span>
<a name="l00276"></a>00276 <span class="stringliteral">            config = {</span>
<a name="l00277"></a>00277 <span class="stringliteral">                //Defaults. Do not set a default for map</span>
<a name="l00278"></a>00278 <span class="stringliteral">                //config to speed up normalize(), which</span>
<a name="l00279"></a>00279 <span class="stringliteral">                //will run faster if there is no default.</span>
<a name="l00280"></a>00280 <span class="stringliteral">                waitSeconds: 7,</span>
<a name="l00281"></a>00281 <span class="stringliteral">                baseUrl: &#39;./&#39;,</span>
<a name="l00282"></a>00282 <span class="stringliteral">                paths: {},</span>
<a name="l00283"></a>00283 <span class="stringliteral">                pkgs: {},</span>
<a name="l00284"></a>00284 <span class="stringliteral">                shim: {},</span>
<a name="l00285"></a>00285 <span class="stringliteral">                config: {}</span>
<a name="l00286"></a>00286 <span class="stringliteral">            },</span>
<a name="l00287"></a>00287 <span class="stringliteral">            mapCache = {},</span>
<a name="l00288"></a>00288 <span class="stringliteral">            requireDeferreds = [],</span>
<a name="l00289"></a>00289 <span class="stringliteral">            deferreds = {},</span>
<a name="l00290"></a>00290 <span class="stringliteral">            calledDefine = {},</span>
<a name="l00291"></a>00291 <span class="stringliteral">            calledPlugin = {},</span>
<a name="l00292"></a>00292 <span class="stringliteral">            loadCount = 0,</span>
<a name="l00293"></a>00293 <span class="stringliteral">            startTime = (new Date()).getTime(),</span>
<a name="l00294"></a>00294 <span class="stringliteral">            errCount = 0,</span>
<a name="l00295"></a>00295 <span class="stringliteral">            trackedErrors = {},</span>
<a name="l00296"></a>00296 <span class="stringliteral">            urlFetched = {};</span>
<a name="l00297"></a>00297 <span class="stringliteral"></span>
<a name="l00307"></a>00307 <span class="stringliteral">        function trimDots(ary) {</span>
<a name="l00308"></a>00308 <span class="stringliteral">            var i, part;</span>
<a name="l00309"></a>00309 <span class="stringliteral">            for (i = 0; ary[i]; i += 1) {</span>
<a name="l00310"></a>00310 <span class="stringliteral">                part = ary[i];</span>
<a name="l00311"></a>00311 <span class="stringliteral">                if (part === &#39;.&#39;) {</span>
<a name="l00312"></a>00312 <span class="stringliteral">                    ary.splice(i, 1);</span>
<a name="l00313"></a>00313 <span class="stringliteral">                    i -= 1;</span>
<a name="l00314"></a>00314 <span class="stringliteral">                } else if (part === &#39;..&#39;) {</span>
<a name="l00315"></a>00315 <span class="stringliteral">                    if (i === 1 &amp;&amp; (ary[2] === &#39;..&#39; || ary[0] === &#39;..&#39;)) {</span>
<a name="l00316"></a>00316 <span class="stringliteral">                        //End of the line. Keep at least one non-dot</span>
<a name="l00317"></a>00317 <span class="stringliteral">                        //path segment at the front so it can be mapped</span>
<a name="l00318"></a>00318 <span class="stringliteral">                        //correctly to disk. Otherwise, there is likely</span>
<a name="l00319"></a>00319 <span class="stringliteral">                        //no path mapping for a path starting with &#39;..&#39;.</span>
<a name="l00320"></a>00320 <span class="stringliteral">                        //This can still fail, but catches the most reasonable</span>
<a name="l00321"></a>00321 <span class="stringliteral">                        //uses of ..</span>
<a name="l00322"></a>00322 <span class="stringliteral">                        break;</span>
<a name="l00323"></a>00323 <span class="stringliteral">                    } else if (i &gt; 0) {</span>
<a name="l00324"></a>00324 <span class="stringliteral">                        ary.splice(i - 1, 2);</span>
<a name="l00325"></a>00325 <span class="stringliteral">                        i -= 2;</span>
<a name="l00326"></a>00326 <span class="stringliteral">                    }</span>
<a name="l00327"></a>00327 <span class="stringliteral">                }</span>
<a name="l00328"></a>00328 <span class="stringliteral">            }</span>
<a name="l00329"></a>00329 <span class="stringliteral">        }</span>
<a name="l00330"></a>00330 <span class="stringliteral"></span>
<a name="l00341"></a>00341 <span class="stringliteral">        function normalize(name, baseName, applyMap) {</span>
<a name="l00342"></a>00342 <span class="stringliteral">            var pkgName, pkgConfig, mapValue, nameParts, i, j, nameSegment,</span>
<a name="l00343"></a>00343 <span class="stringliteral">                foundMap, foundI, foundStarMap, starI,</span>
<a name="l00344"></a>00344 <span class="stringliteral">                baseParts = baseName &amp;&amp; baseName.split(&#39;/&#39;),</span>
<a name="l00345"></a>00345 <span class="stringliteral">                normalizedBaseParts = baseParts,</span>
<a name="l00346"></a>00346 <span class="stringliteral">                map = applyMap &amp;&amp; config.map,</span>
<a name="l00347"></a>00347 <span class="stringliteral">                starMap = map &amp;&amp; map[&#39;*&#39;];</span>
<a name="l00348"></a>00348 <span class="stringliteral"></span>
<a name="l00349"></a>00349 <span class="stringliteral">            //Adjust any relative paths.</span>
<a name="l00350"></a>00350 <span class="stringliteral">            if (name &amp;&amp; name.charAt(0) === &#39;.&#39;) {</span>
<a name="l00351"></a>00351 <span class="stringliteral">                //If have a base name, try to normalize against it,</span>
<a name="l00352"></a>00352 <span class="stringliteral">                //otherwise, assume it is a top-level require that will</span>
<a name="l00353"></a>00353 <span class="stringliteral">                //be relative to baseUrl in the end.</span>
<a name="l00354"></a>00354 <span class="stringliteral">                if (baseName) {</span>
<a name="l00355"></a>00355 <span class="stringliteral">                    if (getOwn(config.pkgs, baseName)) {</span>
<a name="l00356"></a>00356 <span class="stringliteral">                        //If the baseName is a package name, then just treat it as one</span>
<a name="l00357"></a>00357 <span class="stringliteral">                        //name to concat the name with.</span>
<a name="l00358"></a>00358 <span class="stringliteral">                        normalizedBaseParts = baseParts = [baseName];</span>
<a name="l00359"></a>00359 <span class="stringliteral">                    } else {</span>
<a name="l00360"></a>00360 <span class="stringliteral">                        //Convert baseName to array, and lop off the last part,</span>
<a name="l00361"></a>00361 <span class="stringliteral">                        //so that . matches that &#39;directory&#39; and not name of the baseName&#39;s</span>
<a name="l00362"></a>00362 <span class="stringliteral">                        //module. For instance, baseName of &#39;one/two/three&#39;, maps to</span>
<a name="l00363"></a>00363 <span class="stringliteral">                        //&#39;one/two/three.js&#39;, but we want the directory, &#39;one/two&#39; for</span>
<a name="l00364"></a>00364 <span class="stringliteral">                        //this normalization.</span>
<a name="l00365"></a>00365 <span class="stringliteral">                        normalizedBaseParts = baseParts.slice(0, baseParts.length - 1);</span>
<a name="l00366"></a>00366 <span class="stringliteral">                    }</span>
<a name="l00367"></a>00367 <span class="stringliteral"></span>
<a name="l00368"></a>00368 <span class="stringliteral">                    name = normalizedBaseParts.concat(name.split(&#39;/&#39;));</span>
<a name="l00369"></a>00369 <span class="stringliteral">                    trimDots(name);</span>
<a name="l00370"></a>00370 <span class="stringliteral"></span>
<a name="l00371"></a>00371 <span class="stringliteral">                    //Some use of packages may use a . path to reference the</span>
<a name="l00372"></a>00372 <span class="stringliteral">                    //&#39;main&#39; module name, so normalize for that.</span>
<a name="l00373"></a>00373 <span class="stringliteral">                    pkgConfig = getOwn(config.pkgs, (pkgName = name[0]));</span>
<a name="l00374"></a>00374 <span class="stringliteral">                    name = name.join(&#39;/&#39;);</span>
<a name="l00375"></a>00375 <span class="stringliteral">                    if (pkgConfig &amp;&amp; name === pkgName + &#39;/&#39; + pkgConfig.main) {</span>
<a name="l00376"></a>00376 <span class="stringliteral">                        name = pkgName;</span>
<a name="l00377"></a>00377 <span class="stringliteral">                    }</span>
<a name="l00378"></a>00378 <span class="stringliteral">                } else if (name.indexOf(&#39;./&#39;) === 0) {</span>
<a name="l00379"></a>00379 <span class="stringliteral">                    // No baseName, so this is ID is resolved relative</span>
<a name="l00380"></a>00380 <span class="stringliteral">                    // to baseUrl, pull off the leading dot.</span>
<a name="l00381"></a>00381 <span class="stringliteral">                    name = name.substring(2);</span>
<a name="l00382"></a>00382 <span class="stringliteral">                }</span>
<a name="l00383"></a>00383 <span class="stringliteral">            }</span>
<a name="l00384"></a>00384 <span class="stringliteral"></span>
<a name="l00385"></a>00385 <span class="stringliteral">            //Apply map config if available.</span>
<a name="l00386"></a>00386 <span class="stringliteral">            if (applyMap &amp;&amp; (baseParts || starMap) &amp;&amp; map) {</span>
<a name="l00387"></a>00387 <span class="stringliteral">                nameParts = name.split(&#39;/&#39;);</span>
<a name="l00388"></a>00388 <span class="stringliteral"></span>
<a name="l00389"></a>00389 <span class="stringliteral">                for (i = nameParts.length; i &gt; 0; i -= 1) {</span>
<a name="l00390"></a>00390 <span class="stringliteral">                    nameSegment = nameParts.slice(0, i).join(&#39;/&#39;);</span>
<a name="l00391"></a>00391 <span class="stringliteral"></span>
<a name="l00392"></a>00392 <span class="stringliteral">                    if (baseParts) {</span>
<a name="l00393"></a>00393 <span class="stringliteral">                        //Find the longest baseName segment match in the config.</span>
<a name="l00394"></a>00394 <span class="stringliteral">                        //So, do joins on the biggest to smallest lengths of baseParts.</span>
<a name="l00395"></a>00395 <span class="stringliteral">                        for (j = baseParts.length; j &gt; 0; j -= 1) {</span>
<a name="l00396"></a>00396 <span class="stringliteral">                            mapValue = getOwn(map, baseParts.slice(0, j).join(&#39;/&#39;));</span>
<a name="l00397"></a>00397 <span class="stringliteral"></span>
<a name="l00398"></a>00398 <span class="stringliteral">                            //baseName segment has config, find if it has one for</span>
<a name="l00399"></a>00399 <span class="stringliteral">                            //this name.</span>
<a name="l00400"></a>00400 <span class="stringliteral">                            if (mapValue) {</span>
<a name="l00401"></a>00401 <span class="stringliteral">                                mapValue = getOwn(mapValue, nameSegment);</span>
<a name="l00402"></a>00402 <span class="stringliteral">                                if (mapValue) {</span>
<a name="l00403"></a>00403 <span class="stringliteral">                                    //Match, update name to the new value.</span>
<a name="l00404"></a>00404 <span class="stringliteral">                                    foundMap = mapValue;</span>
<a name="l00405"></a>00405 <span class="stringliteral">                                    foundI = i;</span>
<a name="l00406"></a>00406 <span class="stringliteral">                                    break;</span>
<a name="l00407"></a>00407 <span class="stringliteral">                                }</span>
<a name="l00408"></a>00408 <span class="stringliteral">                            }</span>
<a name="l00409"></a>00409 <span class="stringliteral">                        }</span>
<a name="l00410"></a>00410 <span class="stringliteral">                    }</span>
<a name="l00411"></a>00411 <span class="stringliteral"></span>
<a name="l00412"></a>00412 <span class="stringliteral">                    if (foundMap) {</span>
<a name="l00413"></a>00413 <span class="stringliteral">                        break;</span>
<a name="l00414"></a>00414 <span class="stringliteral">                    }</span>
<a name="l00415"></a>00415 <span class="stringliteral"></span>
<a name="l00416"></a>00416 <span class="stringliteral">                    //Check for a star map match, but just hold on to it,</span>
<a name="l00417"></a>00417 <span class="stringliteral">                    //if there is a shorter segment match later in a matching</span>
<a name="l00418"></a>00418 <span class="stringliteral">                    //config, then favor over this star map.</span>
<a name="l00419"></a>00419 <span class="stringliteral">                    if (!foundStarMap &amp;&amp; starMap &amp;&amp; getOwn(starMap, nameSegment)) {</span>
<a name="l00420"></a>00420 <span class="stringliteral">                        foundStarMap = getOwn(starMap, nameSegment);</span>
<a name="l00421"></a>00421 <span class="stringliteral">                        starI = i;</span>
<a name="l00422"></a>00422 <span class="stringliteral">                    }</span>
<a name="l00423"></a>00423 <span class="stringliteral">                }</span>
<a name="l00424"></a>00424 <span class="stringliteral"></span>
<a name="l00425"></a>00425 <span class="stringliteral">                if (!foundMap &amp;&amp; foundStarMap) {</span>
<a name="l00426"></a>00426 <span class="stringliteral">                    foundMap = foundStarMap;</span>
<a name="l00427"></a>00427 <span class="stringliteral">                    foundI = starI;</span>
<a name="l00428"></a>00428 <span class="stringliteral">                }</span>
<a name="l00429"></a>00429 <span class="stringliteral"></span>
<a name="l00430"></a>00430 <span class="stringliteral">                if (foundMap) {</span>
<a name="l00431"></a>00431 <span class="stringliteral">                    nameParts.splice(0, foundI, foundMap);</span>
<a name="l00432"></a>00432 <span class="stringliteral">                    name = nameParts.join(&#39;/&#39;);</span>
<a name="l00433"></a>00433 <span class="stringliteral">                }</span>
<a name="l00434"></a>00434 <span class="stringliteral">            }</span>
<a name="l00435"></a>00435 <span class="stringliteral"></span>
<a name="l00436"></a>00436 <span class="stringliteral">            return name;</span>
<a name="l00437"></a>00437 <span class="stringliteral">        }</span>
<a name="l00438"></a>00438 <span class="stringliteral"></span>
<a name="l00439"></a>00439 <span class="stringliteral"></span>
<a name="l00440"></a>00440 <span class="stringliteral">        function makeShimExports(value) {</span>
<a name="l00441"></a>00441 <span class="stringliteral">            function fn() {</span>
<a name="l00442"></a>00442 <span class="stringliteral">                var ret;</span>
<a name="l00443"></a>00443 <span class="stringliteral">                if (value.init) {</span>
<a name="l00444"></a>00444 <span class="stringliteral">                    ret = value.init.apply(global, arguments);</span>
<a name="l00445"></a>00445 <span class="stringliteral">                }</span>
<a name="l00446"></a>00446 <span class="stringliteral">                return ret || (value.exports &amp;&amp; getGlobal(value.exports));</span>
<a name="l00447"></a>00447 <span class="stringliteral">            }</span>
<a name="l00448"></a>00448 <span class="stringliteral">            return fn;</span>
<a name="l00449"></a>00449 <span class="stringliteral">        }</span>
<a name="l00450"></a>00450 <span class="stringliteral"></span>
<a name="l00451"></a>00451 <span class="stringliteral">        function takeQueue(anonId) {</span>
<a name="l00452"></a>00452 <span class="stringliteral">            var i, id, args, shim;</span>
<a name="l00453"></a>00453 <span class="stringliteral">            for (i = 0; i &lt; queue.length; i += 1) {</span>
<a name="l00454"></a>00454 <span class="stringliteral">                //Peek to see if anon</span>
<a name="l00455"></a>00455 <span class="stringliteral">                if (typeof queue[i][0] !== &#39;string&#39;) {</span>
<a name="l00456"></a>00456 <span class="stringliteral">                    if (anonId) {</span>
<a name="l00457"></a>00457 <span class="stringliteral">                        queue[i].unshift(anonId);</span>
<a name="l00458"></a>00458 <span class="stringliteral">                        anonId = undef;</span>
<a name="l00459"></a>00459 <span class="stringliteral">                    } else {</span>
<a name="l00460"></a>00460 <span class="stringliteral">                        //Not our anon module, stop.</span>
<a name="l00461"></a>00461 <span class="stringliteral">                        break;</span>
<a name="l00462"></a>00462 <span class="stringliteral">                    }</span>
<a name="l00463"></a>00463 <span class="stringliteral">                }</span>
<a name="l00464"></a>00464 <span class="stringliteral">                args = queue.shift();</span>
<a name="l00465"></a>00465 <span class="stringliteral">                id = args[0];</span>
<a name="l00466"></a>00466 <span class="stringliteral">                i -= 1;</span>
<a name="l00467"></a>00467 <span class="stringliteral"></span>
<a name="l00468"></a>00468 <span class="stringliteral">                if (!hasProp(defined, id) &amp;&amp; !hasProp(waiting, id)) {</span>
<a name="l00469"></a>00469 <span class="stringliteral">                    if (hasProp(deferreds, id)) {</span>
<a name="l00470"></a>00470 <span class="stringliteral">                        main.apply(undef, args);</span>
<a name="l00471"></a>00471 <span class="stringliteral">                    } else {</span>
<a name="l00472"></a>00472 <span class="stringliteral">                        waiting[id] = args;</span>
<a name="l00473"></a>00473 <span class="stringliteral">                    }</span>
<a name="l00474"></a>00474 <span class="stringliteral">                }</span>
<a name="l00475"></a>00475 <span class="stringliteral">            }</span>
<a name="l00476"></a>00476 <span class="stringliteral"></span>
<a name="l00477"></a>00477 <span class="stringliteral">            //if get to the end and still have anonId, then could be</span>
<a name="l00478"></a>00478 <span class="stringliteral">            //a shimmed dependency.</span>
<a name="l00479"></a>00479 <span class="stringliteral">            if (anonId) {</span>
<a name="l00480"></a>00480 <span class="stringliteral">                shim = getOwn(config.shim, anonId) || {};</span>
<a name="l00481"></a>00481 <span class="stringliteral">                main(anonId, shim.deps || [], shim.exportsFn);</span>
<a name="l00482"></a>00482 <span class="stringliteral">            }</span>
<a name="l00483"></a>00483 <span class="stringliteral">        }</span>
<a name="l00484"></a>00484 <span class="stringliteral"></span>
<a name="l00485"></a>00485 <span class="stringliteral">        function makeRequire(relName, topLevel) {</span>
<a name="l00486"></a>00486 <span class="stringliteral">            var req = function (deps, callback, errback, alt) {</span>
<a name="l00487"></a>00487 <span class="stringliteral">                var name, cfg;</span>
<a name="l00488"></a>00488 <span class="stringliteral"></span>
<a name="l00489"></a>00489 <span class="stringliteral">                if (topLevel) {</span>
<a name="l00490"></a>00490 <span class="stringliteral">                    takeQueue();</span>
<a name="l00491"></a>00491 <span class="stringliteral">                }</span>
<a name="l00492"></a>00492 <span class="stringliteral"></span>
<a name="l00493"></a>00493 <span class="stringliteral">                if (typeof deps === &quot;</span><span class="keywordtype">string</span><span class="stringliteral">&quot;) {</span>
<a name="l00494"></a>00494 <span class="stringliteral">                    if (handlers[deps]) {</span>
<a name="l00495"></a>00495 <span class="stringliteral">                        return handlers[deps](relName);</span>
<a name="l00496"></a>00496 <span class="stringliteral">                    }</span>
<a name="l00497"></a>00497 <span class="stringliteral">                    //Just return the module wanted. In this scenario, the</span>
<a name="l00498"></a>00498 <span class="stringliteral">                    //deps arg is the module name, and second arg (if passed)</span>
<a name="l00499"></a>00499 <span class="stringliteral">                    //is just the relName.</span>
<a name="l00500"></a>00500 <span class="stringliteral">                    //Normalize module name, if it contains . or ..</span>
<a name="l00501"></a>00501 <span class="stringliteral">                    name = makeMap(deps, relName, true).id;</span>
<a name="l00502"></a>00502 <span class="stringliteral">                    if (!hasProp(defined, name)) {</span>
<a name="l00503"></a>00503 <span class="stringliteral">                        throw new Error(&#39;Not loaded: &#39; + name);</span>
<a name="l00504"></a>00504 <span class="stringliteral">                    }</span>
<a name="l00505"></a>00505 <span class="stringliteral">                    return defined[name];</span>
<a name="l00506"></a>00506 <span class="stringliteral">                } else if (deps &amp;&amp; !Array.isArray(deps)) {</span>
<a name="l00507"></a>00507 <span class="stringliteral">                    //deps is a config object, not an array.</span>
<a name="l00508"></a>00508 <span class="stringliteral">                    cfg = deps;</span>
<a name="l00509"></a>00509 <span class="stringliteral">                    deps = undef;</span>
<a name="l00510"></a>00510 <span class="stringliteral"></span>
<a name="l00511"></a>00511 <span class="stringliteral">                    if (Array.isArray(callback)) {</span>
<a name="l00512"></a>00512 <span class="stringliteral">                        //callback is an array, which means it is a dependency list.</span>
<a name="l00513"></a>00513 <span class="stringliteral">                        //Adjust args if there are dependencies</span>
<a name="l00514"></a>00514 <span class="stringliteral">                        deps = callback;</span>
<a name="l00515"></a>00515 <span class="stringliteral">                        callback = errback;</span>
<a name="l00516"></a>00516 <span class="stringliteral">                        errback = alt;</span>
<a name="l00517"></a>00517 <span class="stringliteral">                    }</span>
<a name="l00518"></a>00518 <span class="stringliteral"></span>
<a name="l00519"></a>00519 <span class="stringliteral">                    if (topLevel) {</span>
<a name="l00520"></a>00520 <span class="stringliteral">                        //Could be a new context, so call returned require</span>
<a name="l00521"></a>00521 <span class="stringliteral">                        return req.config(cfg)(deps, callback, errback);</span>
<a name="l00522"></a>00522 <span class="stringliteral">                    }</span>
<a name="l00523"></a>00523 <span class="stringliteral">                }</span>
<a name="l00524"></a>00524 <span class="stringliteral"></span>
<a name="l00525"></a>00525 <span class="stringliteral">                //Support require([&#39;a&#39;])</span>
<a name="l00526"></a>00526 <span class="stringliteral">                callback = callback || function () {};</span>
<a name="l00527"></a>00527 <span class="stringliteral"></span>
<a name="l00528"></a>00528 <span class="stringliteral">                //Simulate async callback;</span>
<a name="l00529"></a>00529 <span class="stringliteral">                prim.nextTick(function () {</span>
<a name="l00530"></a>00530 <span class="stringliteral">                    //Grab any modules that were defined after a</span>
<a name="l00531"></a>00531 <span class="stringliteral">                    //require call.</span>
<a name="l00532"></a>00532 <span class="stringliteral">                    takeQueue();</span>
<a name="l00533"></a>00533 <span class="stringliteral">                    main(undef, deps || [], callback, errback, relName);</span>
<a name="l00534"></a>00534 <span class="stringliteral">                });</span>
<a name="l00535"></a>00535 <span class="stringliteral"></span>
<a name="l00536"></a>00536 <span class="stringliteral">                return req;</span>
<a name="l00537"></a>00537 <span class="stringliteral">            };</span>
<a name="l00538"></a>00538 <span class="stringliteral"></span>
<a name="l00539"></a>00539 <span class="stringliteral">            req.isBrowser = typeof document !== &#39;undefined&#39; &amp;&amp;</span>
<a name="l00540"></a>00540 <span class="stringliteral">                typeof navigator !== &#39;undefined&#39;;</span>
<a name="l00541"></a>00541 <span class="stringliteral"></span>
<a name="l00542"></a>00542 <span class="stringliteral">            req.nameToUrl = function (moduleName, ext) {</span>
<a name="l00543"></a>00543 <span class="stringliteral">                var paths, pkgs, pkg, pkgPath, syms, i, parentModule, url,</span>
<a name="l00544"></a>00544 <span class="stringliteral">                    parentPath;</span>
<a name="l00545"></a>00545 <span class="stringliteral"></span>
<a name="l00546"></a>00546 <span class="stringliteral">                //If a colon is in the URL, it indicates a protocol is used and it is just</span>
<a name="l00547"></a>00547 <span class="stringliteral">                //an URL to a file, or if it starts with a slash, contains a query arg (i.e. ?)</span>
<a name="l00548"></a>00548 <span class="stringliteral">                //or ends with .js, then assume the user meant to use an url and not a module id.</span>
<a name="l00549"></a>00549 <span class="stringliteral">                //The slash is important for protocol-less URLs as well as full paths.</span>
<a name="l00550"></a>00550 <span class="stringliteral">                if (urlRegExp.test(moduleName)) {</span>
<a name="l00551"></a>00551 <span class="stringliteral">                    //Just a plain path, not module name lookup, so just return it.</span>
<a name="l00552"></a>00552 <span class="stringliteral">                    //Add extension if it is included. This is a bit wonky, only non-.js things pass</span>
<a name="l00553"></a>00553 <span class="stringliteral">                    //an extension, this method probably needs to be reworked.</span>
<a name="l00554"></a>00554 <span class="stringliteral">                    url = moduleName + (ext || &#39;&#39;);</span>
<a name="l00555"></a>00555 <span class="stringliteral">                } else {</span>
<a name="l00556"></a>00556 <span class="stringliteral">                    //A module that needs to be converted to a path.</span>
<a name="l00557"></a>00557 <span class="stringliteral">                    paths = config.paths;</span>
<a name="l00558"></a>00558 <span class="stringliteral">                    pkgs = config.pkgs;</span>
<a name="l00559"></a>00559 <span class="stringliteral"></span>
<a name="l00560"></a>00560 <span class="stringliteral">                    syms = moduleName.split(&#39;/&#39;);</span>
<a name="l00561"></a>00561 <span class="stringliteral">                    //For each module name segment, see if there is a path</span>
<a name="l00562"></a>00562 <span class="stringliteral">                    //registered for it. Start with most specific name</span>
<a name="l00563"></a>00563 <span class="stringliteral">                    //and work up from it.</span>
<a name="l00564"></a>00564 <span class="stringliteral">                    for (i = syms.length; i &gt; 0; i -= 1) {</span>
<a name="l00565"></a>00565 <span class="stringliteral">                        parentModule = syms.slice(0, i).join(&#39;/&#39;);</span>
<a name="l00566"></a>00566 <span class="stringliteral">                        pkg = getOwn(pkgs, parentModule);</span>
<a name="l00567"></a>00567 <span class="stringliteral">                        parentPath = getOwn(paths, parentModule);</span>
<a name="l00568"></a>00568 <span class="stringliteral">                        if (parentPath) {</span>
<a name="l00569"></a>00569 <span class="stringliteral">                            //If an array, it means there are a few choices,</span>
<a name="l00570"></a>00570 <span class="stringliteral">                            //Choose the one that is desired</span>
<a name="l00571"></a>00571 <span class="stringliteral">                            if (Array.isArray(parentPath)) {</span>
<a name="l00572"></a>00572 <span class="stringliteral">                                parentPath = parentPath[0];</span>
<a name="l00573"></a>00573 <span class="stringliteral">                            }</span>
<a name="l00574"></a>00574 <span class="stringliteral">                            syms.splice(0, i, parentPath);</span>
<a name="l00575"></a>00575 <span class="stringliteral">                            break;</span>
<a name="l00576"></a>00576 <span class="stringliteral">                        } else if (pkg) {</span>
<a name="l00577"></a>00577 <span class="stringliteral">                            //If module name is just the package name, then looking</span>
<a name="l00578"></a>00578 <span class="stringliteral">                            //for the main module.</span>
<a name="l00579"></a>00579 <span class="stringliteral">                            if (moduleName === pkg.name) {</span>
<a name="l00580"></a>00580 <span class="stringliteral">                                pkgPath = pkg.location + &#39;/&#39; + pkg.main;</span>
<a name="l00581"></a>00581 <span class="stringliteral">                            } else {</span>
<a name="l00582"></a>00582 <span class="stringliteral">                                pkgPath = pkg.location;</span>
<a name="l00583"></a>00583 <span class="stringliteral">                            }</span>
<a name="l00584"></a>00584 <span class="stringliteral">                            syms.splice(0, i, pkgPath);</span>
<a name="l00585"></a>00585 <span class="stringliteral">                            break;</span>
<a name="l00586"></a>00586 <span class="stringliteral">                        }</span>
<a name="l00587"></a>00587 <span class="stringliteral">                    }</span>
<a name="l00588"></a>00588 <span class="stringliteral"></span>
<a name="l00589"></a>00589 <span class="stringliteral">                    //Join the path parts together, then figure out if baseUrl is needed.</span>
<a name="l00590"></a>00590 <span class="stringliteral">                    url = syms.join(&#39;/&#39;);</span>
<a name="l00591"></a>00591 <span class="stringliteral">                    url += (ext || (/\?/.test(url) ? &#39;&#39; : &#39;.js&#39;));</span>
<a name="l00592"></a>00592 <span class="stringliteral">                    url = (url.charAt(0) === &#39;/&#39; || url.match(/^[\w\+\.\-]+:/) ? &#39;&#39; : config.baseUrl) + url;</span>
<a name="l00593"></a>00593 <span class="stringliteral">                }</span>
<a name="l00594"></a>00594 <span class="stringliteral"></span>
<a name="l00595"></a>00595 <span class="stringliteral">                return config.urlArgs ? url +</span>
<a name="l00596"></a>00596 <span class="stringliteral">                                        ((url.indexOf(&#39;?&#39;) === -1 ? &#39;?&#39; : &#39;&amp;&#39;) +</span>
<a name="l00597"></a>00597 <span class="stringliteral">                                         config.urlArgs) : url;</span>
<a name="l00598"></a>00598 <span class="stringliteral">            };</span>
<a name="l00599"></a>00599 <span class="stringliteral"></span>
<a name="l00605"></a>00605 <span class="stringliteral">            req.toUrl = function (moduleNamePlusExt) {</span>
<a name="l00606"></a>00606 <span class="stringliteral">                var index = moduleNamePlusExt.lastIndexOf(&#39;.&#39;),</span>
<a name="l00607"></a>00607 <span class="stringliteral">                    ext = null;</span>
<a name="l00608"></a>00608 <span class="stringliteral"></span>
<a name="l00609"></a>00609 <span class="stringliteral">                if (index !== -1) {</span>
<a name="l00610"></a>00610 <span class="stringliteral">                    ext = moduleNamePlusExt.substring(index, moduleNamePlusExt.length);</span>
<a name="l00611"></a>00611 <span class="stringliteral">                    moduleNamePlusExt = moduleNamePlusExt.substring(0, index);</span>
<a name="l00612"></a>00612 <span class="stringliteral">                }</span>
<a name="l00613"></a>00613 <span class="stringliteral"></span>
<a name="l00614"></a>00614 <span class="stringliteral">                return req.nameToUrl(normalize(moduleNamePlusExt, relName), ext);</span>
<a name="l00615"></a>00615 <span class="stringliteral">            };</span>
<a name="l00616"></a>00616 <span class="stringliteral"></span>
<a name="l00617"></a>00617 <span class="stringliteral">            req.defined = function (id) {</span>
<a name="l00618"></a>00618 <span class="stringliteral">                return hasProp(defined, makeMap(id, relName, true).id);</span>
<a name="l00619"></a>00619 <span class="stringliteral">            };</span>
<a name="l00620"></a>00620 <span class="stringliteral"></span>
<a name="l00621"></a>00621 <span class="stringliteral">            req.specified = function (id) {</span>
<a name="l00622"></a>00622 <span class="stringliteral">                id = makeMap(id, relName, true).id;</span>
<a name="l00623"></a>00623 <span class="stringliteral">                return hasProp(defined, id) || hasProp(deferreds, id);</span>
<a name="l00624"></a>00624 <span class="stringliteral">            };</span>
<a name="l00625"></a>00625 <span class="stringliteral"></span>
<a name="l00626"></a>00626 <span class="stringliteral">            return req;</span>
<a name="l00627"></a>00627 <span class="stringliteral">        }</span>
<a name="l00628"></a>00628 <span class="stringliteral"></span>
<a name="l00629"></a>00629 <span class="stringliteral">        function resolve(name, d, value) {</span>
<a name="l00630"></a>00630 <span class="stringliteral">            if (name) {</span>
<a name="l00631"></a>00631 <span class="stringliteral">                defined[name] = value;</span>
<a name="l00632"></a>00632 <span class="stringliteral">            }</span>
<a name="l00633"></a>00633 <span class="stringliteral">            d.resolve(value);</span>
<a name="l00634"></a>00634 <span class="stringliteral">        }</span>
<a name="l00635"></a>00635 <span class="stringliteral"></span>
<a name="l00636"></a>00636 <span class="stringliteral">        function makeNormalize(relName) {</span>
<a name="l00637"></a>00637 <span class="stringliteral">            return function (name) {</span>
<a name="l00638"></a>00638 <span class="stringliteral">                return normalize(name, relName, true);</span>
<a name="l00639"></a>00639 <span class="stringliteral">            };</span>
<a name="l00640"></a>00640 <span class="stringliteral">        }</span>
<a name="l00641"></a>00641 <span class="stringliteral"></span>
<a name="l00642"></a>00642 <span class="stringliteral">        function defineModule(d) {</span>
<a name="l00643"></a>00643 <span class="stringliteral">            var name = d.map.id,</span>
<a name="l00644"></a>00644 <span class="stringliteral">                ret = d.factory.apply(defined[name], d.values);</span>
<a name="l00645"></a>00645 <span class="stringliteral"></span>
<a name="l00646"></a>00646 <span class="stringliteral">            if (name) {</span>
<a name="l00647"></a>00647 <span class="stringliteral">                //If setting exports via &quot;</span><a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a><span class="stringliteral">&quot; is in play,</span>
<a name="l00648"></a>00648 <span class="stringliteral">                //favor that over return value and exports.</span>
<a name="l00649"></a>00649 <span class="stringliteral">                //After that, favor a non-undefined return</span>
<a name="l00650"></a>00650 <span class="stringliteral">                //value over exports use.</span>
<a name="l00651"></a>00651 <span class="stringliteral">                if (d.cjsModule &amp;&amp; d.cjsModule.exports !== undef &amp;&amp;</span>
<a name="l00652"></a>00652 <span class="stringliteral">                        d.cjsModule.exports !== defined[name]) {</span>
<a name="l00653"></a>00653 <span class="stringliteral">                    ret = d.cjsModule.exports;</span>
<a name="l00654"></a>00654 <span class="stringliteral">                } else if (ret === undef &amp;&amp; d.usingExports) {</span>
<a name="l00655"></a>00655 <span class="stringliteral">                    ret = defined[name];</span>
<a name="l00656"></a>00656 <span class="stringliteral">                }</span>
<a name="l00657"></a>00657 <span class="stringliteral">            } else {</span>
<a name="l00658"></a>00658 <span class="stringliteral">                //Remove the require deferred from the list to</span>
<a name="l00659"></a>00659 <span class="stringliteral">                //make cycle searching faster. Do not need to track</span>
<a name="l00660"></a>00660 <span class="stringliteral">                //it anymore either.</span>
<a name="l00661"></a>00661 <span class="stringliteral">                requireDeferreds.splice(requireDeferreds.indexOf(d), 1);</span>
<a name="l00662"></a>00662 <span class="stringliteral">            }</span>
<a name="l00663"></a>00663 <span class="stringliteral">            resolve(name, d, ret);</span>
<a name="l00664"></a>00664 <span class="stringliteral">        }</span>
<a name="l00665"></a>00665 <span class="stringliteral"></span>
<a name="l00666"></a>00666 <span class="stringliteral">        //This method is attached to every module deferred,</span>
<a name="l00667"></a>00667 <span class="stringliteral">        //so the &quot;</span><span class="keyword">this</span><span class="stringliteral">&quot; in here is the module deferred object.</span>
<a name="l00668"></a>00668 <span class="stringliteral">        function depFinished(val, i) {</span>
<a name="l00669"></a>00669 <span class="stringliteral">            if (!this.rejected() &amp;&amp; !this.depDefined[i]) {</span>
<a name="l00670"></a>00670 <span class="stringliteral">                this.depDefined[i] = true;</span>
<a name="l00671"></a>00671 <span class="stringliteral">                this.depCount += 1;</span>
<a name="l00672"></a>00672 <span class="stringliteral">                this.values[i] = val;</span>
<a name="l00673"></a>00673 <span class="stringliteral">                if (!this.depending &amp;&amp; this.depCount === this.depMax) {</span>
<a name="l00674"></a>00674 <span class="stringliteral">                    defineModule(this);</span>
<a name="l00675"></a>00675 <span class="stringliteral">                }</span>
<a name="l00676"></a>00676 <span class="stringliteral">            }</span>
<a name="l00677"></a>00677 <span class="stringliteral">        }</span>
<a name="l00678"></a>00678 <span class="stringliteral"></span>
<a name="l00679"></a>00679 <span class="stringliteral">        function makeDefer(name) {</span>
<a name="l00680"></a>00680 <span class="stringliteral">            var d = prim({</span>
<a name="l00681"></a>00681 <span class="stringliteral">                sync: !!name</span>
<a name="l00682"></a>00682 <span class="stringliteral">            });</span>
<a name="l00683"></a>00683 <span class="stringliteral">            d.map = name ? makeMap(name, null, true) : {};</span>
<a name="l00684"></a>00684 <span class="stringliteral">            d.depCount = 0;</span>
<a name="l00685"></a>00685 <span class="stringliteral">            d.depMax = 0;</span>
<a name="l00686"></a>00686 <span class="stringliteral">            d.values = [];</span>
<a name="l00687"></a>00687 <span class="stringliteral">            d.depDefined = [];</span>
<a name="l00688"></a>00688 <span class="stringliteral">            d.depFinished = depFinished;</span>
<a name="l00689"></a>00689 <span class="stringliteral">            if (d.map.pr) {</span>
<a name="l00690"></a>00690 <span class="stringliteral">                //Plugin resource ID, implicitly</span>
<a name="l00691"></a>00691 <span class="stringliteral">                //depends on plugin. Track it in deps</span>
<a name="l00692"></a>00692 <span class="stringliteral">                //so cycle breaking can work</span>
<a name="l00693"></a>00693 <span class="stringliteral">                d.deps = [makeMap(d.map.pr)];</span>
<a name="l00694"></a>00694 <span class="stringliteral">            }</span>
<a name="l00695"></a>00695 <span class="stringliteral">            return d;</span>
<a name="l00696"></a>00696 <span class="stringliteral">        }</span>
<a name="l00697"></a>00697 <span class="stringliteral"></span>
<a name="l00698"></a>00698 <span class="stringliteral">        function getDefer(name) {</span>
<a name="l00699"></a>00699 <span class="stringliteral">            var d;</span>
<a name="l00700"></a>00700 <span class="stringliteral">            if (name) {</span>
<a name="l00701"></a>00701 <span class="stringliteral">                d = hasProp(deferreds, name) &amp;&amp; deferreds[name];</span>
<a name="l00702"></a>00702 <span class="stringliteral">                if (!d) {</span>
<a name="l00703"></a>00703 <span class="stringliteral">                    d = deferreds[name] = makeDefer(name);</span>
<a name="l00704"></a>00704 <span class="stringliteral">                }</span>
<a name="l00705"></a>00705 <span class="stringliteral">            } else {</span>
<a name="l00706"></a>00706 <span class="stringliteral">                d = makeDefer();</span>
<a name="l00707"></a>00707 <span class="stringliteral">                requireDeferreds.push(d);</span>
<a name="l00708"></a>00708 <span class="stringliteral">            }</span>
<a name="l00709"></a>00709 <span class="stringliteral">            return d;</span>
<a name="l00710"></a>00710 <span class="stringliteral">        }</span>
<a name="l00711"></a>00711 <span class="stringliteral"></span>
<a name="l00712"></a>00712 <span class="stringliteral">        function makeErrback(d, name) {</span>
<a name="l00713"></a>00713 <span class="stringliteral">            return function (err) {</span>
<a name="l00714"></a>00714 <span class="stringliteral">                if (!d.rejected()) {</span>
<a name="l00715"></a>00715 <span class="stringliteral">                    if (!err.dynaId) {</span>
<a name="l00716"></a>00716 <span class="stringliteral">                        err.dynaId = &#39;id&#39; + (errCount += 1);</span>
<a name="l00717"></a>00717 <span class="stringliteral">                        err.requireModules = [name];</span>
<a name="l00718"></a>00718 <span class="stringliteral">                    }</span>
<a name="l00719"></a>00719 <span class="stringliteral">                    d.reject(err);</span>
<a name="l00720"></a>00720 <span class="stringliteral">                }</span>
<a name="l00721"></a>00721 <span class="stringliteral">            };</span>
<a name="l00722"></a>00722 <span class="stringliteral">        }</span>
<a name="l00723"></a>00723 <span class="stringliteral"></span>
<a name="l00724"></a>00724 <span class="stringliteral">        function waitForDep(depMap, relName, d, i) {</span>
<a name="l00725"></a>00725 <span class="stringliteral">            d.depMax += 1;</span>
<a name="l00726"></a>00726 <span class="stringliteral"></span>
<a name="l00727"></a>00727 <span class="stringliteral">            //Do the fail at the end to catch errors</span>
<a name="l00728"></a>00728 <span class="stringliteral">            //in the then callback execution.</span>
<a name="l00729"></a>00729 <span class="stringliteral">            callDep(depMap, relName).then(function (val) {</span>
<a name="l00730"></a>00730 <span class="stringliteral">                d.depFinished(val, i);</span>
<a name="l00731"></a>00731 <span class="stringliteral">            }, makeErrback(d, depMap.id)).fail(makeErrback(d, d.map.id));</span>
<a name="l00732"></a>00732 <span class="stringliteral">        }</span>
<a name="l00733"></a>00733 <span class="stringliteral"></span>
<a name="l00734"></a>00734 <span class="stringliteral">        function makeLoad(id) {</span>
<a name="l00735"></a>00735 <span class="stringliteral">            var fromTextCalled;</span>
<a name="l00736"></a>00736 <span class="stringliteral">            function load(value) {</span>
<a name="l00737"></a>00737 <span class="stringliteral">                //Protect against older plugins that call load after</span>
<a name="l00738"></a>00738 <span class="stringliteral">                //calling load.fromText</span>
<a name="l00739"></a>00739 <span class="stringliteral">                if (!fromTextCalled) {</span>
<a name="l00740"></a>00740 <span class="stringliteral">                    resolve(id, getDefer(id), value);</span>
<a name="l00741"></a>00741 <span class="stringliteral">                }</span>
<a name="l00742"></a>00742 <span class="stringliteral">            }</span>
<a name="l00743"></a>00743 <span class="stringliteral"></span>
<a name="l00744"></a>00744 <span class="stringliteral">            load.error = function (err) {</span>
<a name="l00745"></a>00745 <span class="stringliteral">                getDefer(id).reject(err);</span>
<a name="l00746"></a>00746 <span class="stringliteral">            };</span>
<a name="l00747"></a>00747 <span class="stringliteral"></span>
<a name="l00748"></a>00748 <span class="stringliteral">            load.fromText = function (text, textAlt) {</span>
<a name="l00749"></a>00749 <span class="stringliteral">                /*jslint evil: true */</span>
<a name="l00750"></a>00750 <span class="stringliteral">                var d = getDefer(id),</span>
<a name="l00751"></a>00751 <span class="stringliteral">                    map = makeMap(makeMap(id).n),</span>
<a name="l00752"></a>00752 <span class="stringliteral">                    plainId = map.id;</span>
<a name="l00753"></a>00753 <span class="stringliteral"></span>
<a name="l00754"></a>00754 <span class="stringliteral">                fromTextCalled = true;</span>
<a name="l00755"></a>00755 <span class="stringliteral"></span>
<a name="l00756"></a>00756 <span class="stringliteral">                //Set up the factory just to be a return of the value from</span>
<a name="l00757"></a>00757 <span class="stringliteral">                //plainId.</span>
<a name="l00758"></a>00758 <span class="stringliteral">                d.factory = function (p, val) {</span>
<a name="l00759"></a>00759 <span class="stringliteral">                    return val;</span>
<a name="l00760"></a>00760 <span class="stringliteral">                };</span>
<a name="l00761"></a>00761 <span class="stringliteral"></span>
<a name="l00762"></a>00762 <span class="stringliteral">                //As of requirejs 2.1.0, support just passing the text, to reinforce</span>
<a name="l00763"></a>00763 <span class="stringliteral">                //fromText only being called once per resource. Still</span>
<a name="l00764"></a>00764 <span class="stringliteral">                //support old style of passing moduleName but discard</span>
<a name="l00765"></a>00765 <span class="stringliteral">                //that moduleName in favor of the internal ref.</span>
<a name="l00766"></a>00766 <span class="stringliteral">                if (textAlt) {</span>
<a name="l00767"></a>00767 <span class="stringliteral">                    text = textAlt;</span>
<a name="l00768"></a>00768 <span class="stringliteral">                }</span>
<a name="l00769"></a>00769 <span class="stringliteral"></span>
<a name="l00770"></a>00770 <span class="stringliteral">                //Transfer any config to this other module.</span>
<a name="l00771"></a>00771 <span class="stringliteral">                if (hasProp(config.config, id)) {</span>
<a name="l00772"></a>00772 <span class="stringliteral">                    config.config[plainId] = config.config[id];</span>
<a name="l00773"></a>00773 <span class="stringliteral">                }</span>
<a name="l00774"></a>00774 <span class="stringliteral"></span>
<a name="l00775"></a>00775 <span class="stringliteral">                try {</span>
<a name="l00776"></a>00776 <span class="stringliteral">                    req.exec(text);</span>
<a name="l00777"></a>00777 <span class="stringliteral">                } catch (e) {</span>
<a name="l00778"></a>00778 <span class="stringliteral">                    throw new Error(&#39;fromText eval for &#39; + plainId +</span>
<a name="l00779"></a>00779 <span class="stringliteral">                                    &#39; failed: &#39; + e);</span>
<a name="l00780"></a>00780 <span class="stringliteral">                }</span>
<a name="l00781"></a>00781 <span class="stringliteral"></span>
<a name="l00782"></a>00782 <span class="stringliteral">                //Execute any waiting define created by the plainId</span>
<a name="l00783"></a>00783 <span class="stringliteral">                takeQueue(plainId);</span>
<a name="l00784"></a>00784 <span class="stringliteral"></span>
<a name="l00785"></a>00785 <span class="stringliteral">                //Mark this as a dependency for the plugin</span>
<a name="l00786"></a>00786 <span class="stringliteral">                //resource</span>
<a name="l00787"></a>00787 <span class="stringliteral">                d.deps = [map];</span>
<a name="l00788"></a>00788 <span class="stringliteral">                waitForDep(map, null, d, d.deps.length);</span>
<a name="l00789"></a>00789 <span class="stringliteral">            };</span>
<a name="l00790"></a>00790 <span class="stringliteral"></span>
<a name="l00791"></a>00791 <span class="stringliteral">            return load;</span>
<a name="l00792"></a>00792 <span class="stringliteral">        }</span>
<a name="l00793"></a>00793 <span class="stringliteral"></span>
<a name="l00794"></a>00794 <span class="stringliteral">        load = typeof importScripts === &#39;function&#39; ?</span>
<a name="l00795"></a>00795 <span class="stringliteral">                function (map) {</span>
<a name="l00796"></a>00796 <span class="stringliteral">                    var url = map.url;</span>
<a name="l00797"></a>00797 <span class="stringliteral">                    if (urlFetched[url]) {</span>
<a name="l00798"></a>00798 <span class="stringliteral">                        return;</span>
<a name="l00799"></a>00799 <span class="stringliteral">                    }</span>
<a name="l00800"></a>00800 <span class="stringliteral">                    urlFetched[url] = true;</span>
<a name="l00801"></a>00801 <span class="stringliteral"></span>
<a name="l00802"></a>00802 <span class="stringliteral">                    //Ask for the deferred so loading is triggered.</span>
<a name="l00803"></a>00803 <span class="stringliteral">                    //Do this before loading, since loading is sync.</span>
<a name="l00804"></a>00804 <span class="stringliteral">                    getDefer(map.id);</span>
<a name="l00805"></a>00805 <span class="stringliteral">                    importScripts(url);</span>
<a name="l00806"></a>00806 <span class="stringliteral">                    takeQueue(map.id);</span>
<a name="l00807"></a>00807 <span class="stringliteral">                } :</span>
<a name="l00808"></a>00808 <span class="stringliteral">                function (map) {</span>
<a name="l00809"></a>00809 <span class="stringliteral">                    var script,</span>
<a name="l00810"></a>00810 <span class="stringliteral">                        id = map.id,</span>
<a name="l00811"></a>00811 <span class="stringliteral">                        url = map.url;</span>
<a name="l00812"></a>00812 <span class="stringliteral"></span>
<a name="l00813"></a>00813 <span class="stringliteral">                    if (urlFetched[url]) {</span>
<a name="l00814"></a>00814 <span class="stringliteral">                        return;</span>
<a name="l00815"></a>00815 <span class="stringliteral">                    }</span>
<a name="l00816"></a>00816 <span class="stringliteral">                    urlFetched[url] = true;</span>
<a name="l00817"></a>00817 <span class="stringliteral"></span>
<a name="l00818"></a>00818 <span class="stringliteral">                    script = document.createElement(&#39;script&#39;);</span>
<a name="l00819"></a>00819 <span class="stringliteral">                    script.setAttribute(&#39;data-requiremodule&#39;, id);</span>
<a name="l00820"></a>00820 <span class="stringliteral">                    script.type = config.scriptType || &#39;text/javascript&#39;;</span>
<a name="l00821"></a>00821 <span class="stringliteral">                    script.charset = &#39;utf-8&#39;;</span>
<a name="l00822"></a>00822 <span class="stringliteral">                    script.async = true;</span>
<a name="l00823"></a>00823 <span class="stringliteral"></span>
<a name="l00824"></a>00824 <span class="stringliteral">                    loadCount += 1;</span>
<a name="l00825"></a>00825 <span class="stringliteral"></span>
<a name="l00826"></a>00826 <span class="stringliteral">                    script.addEventListener(&#39;load&#39;, function () {</span>
<a name="l00827"></a>00827 <span class="stringliteral">                        loadCount -= 1;</span>
<a name="l00828"></a>00828 <span class="stringliteral">                        takeQueue(id);</span>
<a name="l00829"></a>00829 <span class="stringliteral">                    }, false);</span>
<a name="l00830"></a>00830 <span class="stringliteral">                    script.addEventListener(&#39;error&#39;, function () {</span>
<a name="l00831"></a>00831 <span class="stringliteral">                        loadCount -= 1;</span>
<a name="l00832"></a>00832 <span class="stringliteral">                        var err,</span>
<a name="l00833"></a>00833 <span class="stringliteral">                            pathConfig = getOwn(config.paths, id),</span>
<a name="l00834"></a>00834 <span class="stringliteral">                            d = getOwn(deferreds, id);</span>
<a name="l00835"></a>00835 <span class="stringliteral">                        if (pathConfig &amp;&amp; Array.isArray(pathConfig) &amp;&amp; pathConfig.length &gt; 1) {</span>
<a name="l00836"></a>00836 <span class="stringliteral">                            script.parentNode.removeChild(script);</span>
<a name="l00837"></a>00837 <span class="stringliteral">                            //Pop off the first array value, since it failed, and</span>
<a name="l00838"></a>00838 <span class="stringliteral">                            //retry</span>
<a name="l00839"></a>00839 <span class="stringliteral">                            pathConfig.shift();</span>
<a name="l00840"></a>00840 <span class="stringliteral">                            d.map = makeMap(id);</span>
<a name="l00841"></a>00841 <span class="stringliteral">                            load(d.map);</span>
<a name="l00842"></a>00842 <span class="stringliteral">                        } else {</span>
<a name="l00843"></a>00843 <span class="stringliteral">                            err = new Error(&#39;Load failed: &#39; + id + &#39;: &#39; + script.src);</span>
<a name="l00844"></a>00844 <span class="stringliteral">                            err.requireModules = [id];</span>
<a name="l00845"></a>00845 <span class="stringliteral">                            getDefer(id).reject(err);</span>
<a name="l00846"></a>00846 <span class="stringliteral">                        }</span>
<a name="l00847"></a>00847 <span class="stringliteral">                    }, false);</span>
<a name="l00848"></a>00848 <span class="stringliteral"></span>
<a name="l00849"></a>00849 <span class="stringliteral">                    script.src = url;</span>
<a name="l00850"></a>00850 <span class="stringliteral"></span>
<a name="l00851"></a>00851 <span class="stringliteral">                    document.head.appendChild(script);</span>
<a name="l00852"></a>00852 <span class="stringliteral">                };</span>
<a name="l00853"></a>00853 <span class="stringliteral"></span>
<a name="l00854"></a>00854 <span class="stringliteral">        function callPlugin(plugin, map, relName) {</span>
<a name="l00855"></a>00855 <span class="stringliteral">            plugin.load(map.n, makeRequire(relName), makeLoad(map.id), {});</span>
<a name="l00856"></a>00856 <span class="stringliteral">        }</span>
<a name="l00857"></a>00857 <span class="stringliteral"></span>
<a name="l00858"></a>00858 <span class="stringliteral">        callDep = function (map, relName) {</span>
<a name="l00859"></a>00859 <span class="stringliteral">            var args,</span>
<a name="l00860"></a>00860 <span class="stringliteral">                name = map.id,</span>
<a name="l00861"></a>00861 <span class="stringliteral">                shim = config.shim[name];</span>
<a name="l00862"></a>00862 <span class="stringliteral"></span>
<a name="l00863"></a>00863 <span class="stringliteral">            if (hasProp(waiting, name)) {</span>
<a name="l00864"></a>00864 <span class="stringliteral">                args = waiting[name];</span>
<a name="l00865"></a>00865 <span class="stringliteral">                delete waiting[name];</span>
<a name="l00866"></a>00866 <span class="stringliteral">                main.apply(undef, args);</span>
<a name="l00867"></a>00867 <span class="stringliteral">            } else if (!hasProp(deferreds, name)) {</span>
<a name="l00868"></a>00868 <span class="stringliteral">                if (map.pr) {</span>
<a name="l00869"></a>00869 <span class="stringliteral">                    return callDep(makeMap(map.pr)).then(function (plugin) {</span>
<a name="l00870"></a>00870 <span class="stringliteral">                        //Redo map now that plugin is known to be loaded</span>
<a name="l00871"></a>00871 <span class="stringliteral">                        var newMap = makeMap(name, relName, true),</span>
<a name="l00872"></a>00872 <span class="stringliteral">                            newId = newMap.id,</span>
<a name="l00873"></a>00873 <span class="stringliteral">                            shim = getOwn(config.shim, newId);</span>
<a name="l00874"></a>00874 <span class="stringliteral"></span>
<a name="l00875"></a>00875 <span class="stringliteral">                        //Make sure to only call load once per resource. Many</span>
<a name="l00876"></a>00876 <span class="stringliteral">                        //calls could have been queued waiting for plugin to load.</span>
<a name="l00877"></a>00877 <span class="stringliteral">                        if (!hasProp(calledPlugin, newId)) {</span>
<a name="l00878"></a>00878 <span class="stringliteral">                            calledPlugin[newId] = true;</span>
<a name="l00879"></a>00879 <span class="stringliteral">                            if (shim &amp;&amp; shim.deps) {</span>
<a name="l00880"></a>00880 <span class="stringliteral">                                req(shim.deps, function () {</span>
<a name="l00881"></a>00881 <span class="stringliteral">                                    callPlugin(plugin, newMap, relName);</span>
<a name="l00882"></a>00882 <span class="stringliteral">                                });</span>
<a name="l00883"></a>00883 <span class="stringliteral">                            } else {</span>
<a name="l00884"></a>00884 <span class="stringliteral">                                callPlugin(plugin, newMap, relName);</span>
<a name="l00885"></a>00885 <span class="stringliteral">                            }</span>
<a name="l00886"></a>00886 <span class="stringliteral">                        }</span>
<a name="l00887"></a>00887 <span class="stringliteral">                        return getDefer(newId).promise;</span>
<a name="l00888"></a>00888 <span class="stringliteral">                    });</span>
<a name="l00889"></a>00889 <span class="stringliteral">                } else if (shim &amp;&amp; shim.deps) {</span>
<a name="l00890"></a>00890 <span class="stringliteral">                    req(shim.deps, function () {</span>
<a name="l00891"></a>00891 <span class="stringliteral">                        load(map);</span>
<a name="l00892"></a>00892 <span class="stringliteral">                    });</span>
<a name="l00893"></a>00893 <span class="stringliteral">                } else {</span>
<a name="l00894"></a>00894 <span class="stringliteral">                    load(map);</span>
<a name="l00895"></a>00895 <span class="stringliteral">                }</span>
<a name="l00896"></a>00896 <span class="stringliteral">            }</span>
<a name="l00897"></a>00897 <span class="stringliteral"></span>
<a name="l00898"></a>00898 <span class="stringliteral">            return getDefer(name).promise;</span>
<a name="l00899"></a>00899 <span class="stringliteral">        };</span>
<a name="l00900"></a>00900 <span class="stringliteral"></span>
<a name="l00901"></a>00901 <span class="stringliteral">        //Turns a plugin!resource to [plugin, resource]</span>
<a name="l00902"></a>00902 <span class="stringliteral">        //with the plugin being undefined if the name</span>
<a name="l00903"></a>00903 <span class="stringliteral">        //did not have a plugin prefix.</span>
<a name="l00904"></a>00904 <span class="stringliteral">        function splitPrefix(name) {</span>
<a name="l00905"></a>00905 <span class="stringliteral">            var prefix,</span>
<a name="l00906"></a>00906 <span class="stringliteral">                index = name ? name.indexOf(&#39;!&#39;) : -1;</span>
<a name="l00907"></a>00907 <span class="stringliteral">            if (index &gt; -1) {</span>
<a name="l00908"></a>00908 <span class="stringliteral">                prefix = name.substring(0, index);</span>
<a name="l00909"></a>00909 <span class="stringliteral">                name = name.substring(index + 1, name.length);</span>
<a name="l00910"></a>00910 <span class="stringliteral">            }</span>
<a name="l00911"></a>00911 <span class="stringliteral">            return [prefix, name];</span>
<a name="l00912"></a>00912 <span class="stringliteral">        }</span>
<a name="l00913"></a>00913 <span class="stringliteral"></span>
<a name="l00919"></a>00919 <span class="stringliteral">        makeMap = function (name, relName, applyMap) {</span>
<a name="l00920"></a>00920 <span class="stringliteral">            if (typeof name !== &#39;string&#39;) {</span>
<a name="l00921"></a>00921 <span class="stringliteral">                return name;</span>
<a name="l00922"></a>00922 <span class="stringliteral">            }</span>
<a name="l00923"></a>00923 <span class="stringliteral"></span>
<a name="l00924"></a>00924 <span class="stringliteral">            var plugin, url, parts, prefix, result,</span>
<a name="l00925"></a>00925 <span class="stringliteral">                cacheKey = name + &#39; &amp; &#39; + (relName || &#39;&#39;) + &#39; &amp; &#39; + !!applyMap;</span>
<a name="l00926"></a>00926 <span class="stringliteral"></span>
<a name="l00927"></a>00927 <span class="stringliteral">            parts = splitPrefix(name);</span>
<a name="l00928"></a>00928 <span class="stringliteral">            prefix = parts[0];</span>
<a name="l00929"></a>00929 <span class="stringliteral">            name = parts[1];</span>
<a name="l00930"></a>00930 <span class="stringliteral"></span>
<a name="l00931"></a>00931 <span class="stringliteral">            if (!prefix &amp;&amp; hasProp(mapCache, cacheKey)) {</span>
<a name="l00932"></a>00932 <span class="stringliteral">                return mapCache[cacheKey];</span>
<a name="l00933"></a>00933 <span class="stringliteral">            }</span>
<a name="l00934"></a>00934 <span class="stringliteral"></span>
<a name="l00935"></a>00935 <span class="stringliteral">            if (prefix) {</span>
<a name="l00936"></a>00936 <span class="stringliteral">                prefix = normalize(prefix, relName, applyMap);</span>
<a name="l00937"></a>00937 <span class="stringliteral">                plugin = hasProp(defined, prefix) &amp;&amp; defined[prefix];</span>
<a name="l00938"></a>00938 <span class="stringliteral">            }</span>
<a name="l00939"></a>00939 <span class="stringliteral"></span>
<a name="l00940"></a>00940 <span class="stringliteral">            //Normalize according</span>
<a name="l00941"></a>00941 <span class="stringliteral">            if (prefix) {</span>
<a name="l00942"></a>00942 <span class="stringliteral">                if (plugin &amp;&amp; plugin.normalize) {</span>
<a name="l00943"></a>00943 <span class="stringliteral">                    name = plugin.normalize(name, makeNormalize(relName));</span>
<a name="l00944"></a>00944 <span class="stringliteral">                } else {</span>
<a name="l00945"></a>00945 <span class="stringliteral">                    name = normalize(name, relName, applyMap);</span>
<a name="l00946"></a>00946 <span class="stringliteral">                }</span>
<a name="l00947"></a>00947 <span class="stringliteral">            } else {</span>
<a name="l00948"></a>00948 <span class="stringliteral">                name = normalize(name, relName, applyMap);</span>
<a name="l00949"></a>00949 <span class="stringliteral">                parts = splitPrefix(name);</span>
<a name="l00950"></a>00950 <span class="stringliteral">                prefix = parts[0];</span>
<a name="l00951"></a>00951 <span class="stringliteral">                name = parts[1];</span>
<a name="l00952"></a>00952 <span class="stringliteral"></span>
<a name="l00953"></a>00953 <span class="stringliteral">                url = req.nameToUrl(name);</span>
<a name="l00954"></a>00954 <span class="stringliteral">            }</span>
<a name="l00955"></a>00955 <span class="stringliteral"></span>
<a name="l00956"></a>00956 <span class="stringliteral">            //Using ridiculous property names for space reasons</span>
<a name="l00957"></a>00957 <span class="stringliteral">            result = {</span>
<a name="l00958"></a>00958 <span class="stringliteral">                id: prefix ? prefix + &#39;!&#39; + name : name, //fullName</span>
<a name="l00959"></a>00959 <span class="stringliteral">                n: name,</span>
<a name="l00960"></a>00960 <span class="stringliteral">                pr: prefix,</span>
<a name="l00961"></a>00961 <span class="stringliteral">                url: url</span>
<a name="l00962"></a>00962 <span class="stringliteral">            };</span>
<a name="l00963"></a>00963 <span class="stringliteral"></span>
<a name="l00964"></a>00964 <span class="stringliteral">            if (!prefix) {</span>
<a name="l00965"></a>00965 <span class="stringliteral">                mapCache[cacheKey] = result;</span>
<a name="l00966"></a>00966 <span class="stringliteral">            }</span>
<a name="l00967"></a>00967 <span class="stringliteral"></span>
<a name="l00968"></a>00968 <span class="stringliteral">            return result;</span>
<a name="l00969"></a>00969 <span class="stringliteral">        };</span>
<a name="l00970"></a>00970 <span class="stringliteral"></span>
<a name="l00971"></a>00971 <span class="stringliteral">        function makeConfig(name) {</span>
<a name="l00972"></a>00972 <span class="stringliteral">            return function () {</span>
<a name="l00973"></a>00973 <span class="stringliteral">                return config.config[name] || {};</span>
<a name="l00974"></a>00974 <span class="stringliteral">            };</span>
<a name="l00975"></a>00975 <span class="stringliteral">        }</span>
<a name="l00976"></a>00976 <span class="stringliteral"></span>
<a name="l00977"></a>00977 <span class="stringliteral">        handlers = {</span>
<a name="l00978"></a>00978 <span class="stringliteral">            require: function (name) {</span>
<a name="l00979"></a>00979 <span class="stringliteral">                return makeRequire(name);</span>
<a name="l00980"></a>00980 <span class="stringliteral">            },</span>
<a name="l00981"></a>00981 <span class="stringliteral">            exports: function (name) {</span>
<a name="l00982"></a>00982 <span class="stringliteral">                var e = defined[name];</span>
<a name="l00983"></a>00983 <span class="stringliteral">                if (typeof e !== &#39;undefined&#39;) {</span>
<a name="l00984"></a>00984 <span class="stringliteral">                    return e;</span>
<a name="l00985"></a>00985 <span class="stringliteral">                } else {</span>
<a name="l00986"></a>00986 <span class="stringliteral">                    return (defined[name] = {});</span>
<a name="l00987"></a>00987 <span class="stringliteral">                }</span>
<a name="l00988"></a>00988 <span class="stringliteral">            },</span>
<a name="l00989"></a>00989 <span class="stringliteral">            module: function (name) {</span>
<a name="l00990"></a>00990 <span class="stringliteral">                return {</span>
<a name="l00991"></a>00991 <span class="stringliteral">                    id: name,</span>
<a name="l00992"></a>00992 <span class="stringliteral">                    uri: &#39;&#39;,</span>
<a name="l00993"></a>00993 <span class="stringliteral">                    exports: defined[name],</span>
<a name="l00994"></a>00994 <span class="stringliteral">                    config: makeConfig(name)</span>
<a name="l00995"></a>00995 <span class="stringliteral">                };</span>
<a name="l00996"></a>00996 <span class="stringliteral">            }</span>
<a name="l00997"></a>00997 <span class="stringliteral">        };</span>
<a name="l00998"></a>00998 <span class="stringliteral"></span>
<a name="l00999"></a>00999 <span class="stringliteral">        function breakCycle(d, traced, processed) {</span>
<a name="l01000"></a>01000 <span class="stringliteral">            var id = d.map.id;</span>
<a name="l01001"></a>01001 <span class="stringliteral"></span>
<a name="l01002"></a>01002 <span class="stringliteral">            traced[id] = true;</span>
<a name="l01003"></a>01003 <span class="stringliteral">            if (!d.finished() &amp;&amp; d.deps) {</span>
<a name="l01004"></a>01004 <span class="stringliteral">                d.deps.forEach(function (depMap) {</span>
<a name="l01005"></a>01005 <span class="stringliteral">                    var depIndex,</span>
<a name="l01006"></a>01006 <span class="stringliteral">                        depId = depMap.id,</span>
<a name="l01007"></a>01007 <span class="stringliteral">                        dep = !hasProp(handlers, depId) &amp;&amp; getDefer(depId);</span>
<a name="l01008"></a>01008 <span class="stringliteral"></span>
<a name="l01009"></a>01009 <span class="stringliteral">                    //Only force things that have not completed</span>
<a name="l01010"></a>01010 <span class="stringliteral">                    //being defined, so still in the registry,</span>
<a name="l01011"></a>01011 <span class="stringliteral">                    //and only if it has not been matched up</span>
<a name="l01012"></a>01012 <span class="stringliteral">                    //in the module already.</span>
<a name="l01013"></a>01013 <span class="stringliteral">                    if (dep &amp;&amp; !dep.finished() &amp;&amp; !processed[depId]) {</span>
<a name="l01014"></a>01014 <span class="stringliteral">                        if (hasProp(traced, depId)) {</span>
<a name="l01015"></a>01015 <span class="stringliteral">                            d.deps.some(function (depMap, i) {</span>
<a name="l01016"></a>01016 <span class="stringliteral">                                if (depMap.id === depId) {</span>
<a name="l01017"></a>01017 <span class="stringliteral">                                    depIndex = i;</span>
<a name="l01018"></a>01018 <span class="stringliteral">                                    return true;</span>
<a name="l01019"></a>01019 <span class="stringliteral">                                }</span>
<a name="l01020"></a>01020 <span class="stringliteral">                            });</span>
<a name="l01021"></a>01021 <span class="stringliteral">                            d.depFinished(defined[depId], depIndex);</span>
<a name="l01022"></a>01022 <span class="stringliteral">                        } else {</span>
<a name="l01023"></a>01023 <span class="stringliteral">                            breakCycle(dep, traced, processed);</span>
<a name="l01024"></a>01024 <span class="stringliteral">                        }</span>
<a name="l01025"></a>01025 <span class="stringliteral">                    }</span>
<a name="l01026"></a>01026 <span class="stringliteral">                });</span>
<a name="l01027"></a>01027 <span class="stringliteral">            }</span>
<a name="l01028"></a>01028 <span class="stringliteral">            processed[id] = true;</span>
<a name="l01029"></a>01029 <span class="stringliteral">        }</span>
<a name="l01030"></a>01030 <span class="stringliteral"></span>
<a name="l01031"></a>01031 <span class="stringliteral">        function check(d) {</span>
<a name="l01032"></a>01032 <span class="stringliteral">            var err,</span>
<a name="l01033"></a>01033 <span class="stringliteral">                notFinished = [],</span>
<a name="l01034"></a>01034 <span class="stringliteral">                waitInterval = config.waitSeconds * 1000,</span>
<a name="l01035"></a>01035 <span class="stringliteral">                //It is possible to disable the wait interval by using waitSeconds of 0.</span>
<a name="l01036"></a>01036 <span class="stringliteral">                expired = waitInterval &amp;&amp; (startTime + waitInterval) &lt; (new Date()).getTime();</span>
<a name="l01037"></a>01037 <span class="stringliteral"></span>
<a name="l01038"></a>01038 <span class="stringliteral">            if (loadCount === 0) {</span>
<a name="l01039"></a>01039 <span class="stringliteral">                //If passed in a deferred, it is for a specific require call.</span>
<a name="l01040"></a>01040 <span class="stringliteral">                //Could be a sync case that needs resolution right away.</span>
<a name="l01041"></a>01041 <span class="stringliteral">                //Otherwise, if no deferred, means a nextTick and all</span>
<a name="l01042"></a>01042 <span class="stringliteral">                //waiting require deferreds should be checked.</span>
<a name="l01043"></a>01043 <span class="stringliteral">                if (d) {</span>
<a name="l01044"></a>01044 <span class="stringliteral">                    if (!d.finished()) {</span>
<a name="l01045"></a>01045 <span class="stringliteral">                        breakCycle(d, {}, {});</span>
<a name="l01046"></a>01046 <span class="stringliteral">                    }</span>
<a name="l01047"></a>01047 <span class="stringliteral">                } else if (requireDeferreds.length) {</span>
<a name="l01048"></a>01048 <span class="stringliteral">                    requireDeferreds.forEach(function (d) {</span>
<a name="l01049"></a>01049 <span class="stringliteral">                        breakCycle(d, {}, {});</span>
<a name="l01050"></a>01050 <span class="stringliteral">                    });</span>
<a name="l01051"></a>01051 <span class="stringliteral">                }</span>
<a name="l01052"></a>01052 <span class="stringliteral">            }</span>
<a name="l01053"></a>01053 <span class="stringliteral"></span>
<a name="l01054"></a>01054 <span class="stringliteral">            //If still waiting on loads, and the waiting load is something</span>
<a name="l01055"></a>01055 <span class="stringliteral">            //other than a plugin resource, or there are still outstanding</span>
<a name="l01056"></a>01056 <span class="stringliteral">            //scripts, then just try back later.</span>
<a name="l01057"></a>01057 <span class="stringliteral">            if (expired) {</span>
<a name="l01058"></a>01058 <span class="stringliteral">                //If wait time expired, throw error of unloaded modules.</span>
<a name="l01059"></a>01059 <span class="stringliteral">                eachProp(deferreds, function (d) {</span>
<a name="l01060"></a>01060 <span class="stringliteral">                    if (!d.finished()) {</span>
<a name="l01061"></a>01061 <span class="stringliteral">                        notFinished.push(d.map.id);</span>
<a name="l01062"></a>01062 <span class="stringliteral">                    }</span>
<a name="l01063"></a>01063 <span class="stringliteral">                });</span>
<a name="l01064"></a>01064 <span class="stringliteral">                err = new Error(&#39;Timeout for modules: &#39; + notFinished);</span>
<a name="l01065"></a>01065 <span class="stringliteral">                err.requireModules = notFinished;</span>
<a name="l01066"></a>01066 <span class="stringliteral">                req.onError(err);</span>
<a name="l01067"></a>01067 <span class="stringliteral">            } else if (loadCount || requireDeferreds.length) {</span>
<a name="l01068"></a>01068 <span class="stringliteral">                //Something is still waiting to load. Wait for it, but only</span>
<a name="l01069"></a>01069 <span class="stringliteral">                //if a later check is not already scheduled.</span>
<a name="l01070"></a>01070 <span class="stringliteral">                if (!checkingLater) {</span>
<a name="l01071"></a>01071 <span class="stringliteral">                    checkingLater = true;</span>
<a name="l01072"></a>01072 <span class="stringliteral">                    prim.nextTick(function () {</span>
<a name="l01073"></a>01073 <span class="stringliteral">                        checkingLater = false;</span>
<a name="l01074"></a>01074 <span class="stringliteral">                        check();</span>
<a name="l01075"></a>01075 <span class="stringliteral">                    });</span>
<a name="l01076"></a>01076 <span class="stringliteral">                }</span>
<a name="l01077"></a>01077 <span class="stringliteral">            }</span>
<a name="l01078"></a>01078 <span class="stringliteral">        }</span>
<a name="l01079"></a>01079 <span class="stringliteral"></span>
<a name="l01080"></a>01080 <span class="stringliteral">        //Used to break out of the promise try/catch chains.</span>
<a name="l01081"></a>01081 <span class="stringliteral">        function delayedError(e) {</span>
<a name="l01082"></a>01082 <span class="stringliteral">            prim.nextTick(function () {</span>
<a name="l01083"></a>01083 <span class="stringliteral">                if (!e.dynaId || !trackedErrors[e.dynaId]) {</span>
<a name="l01084"></a>01084 <span class="stringliteral">                    trackedErrors[e.dynaId] = true;</span>
<a name="l01085"></a>01085 <span class="stringliteral">                    req.onError(e);</span>
<a name="l01086"></a>01086 <span class="stringliteral">                }</span>
<a name="l01087"></a>01087 <span class="stringliteral">            });</span>
<a name="l01088"></a>01088 <span class="stringliteral">        }</span>
<a name="l01089"></a>01089 <span class="stringliteral"></span>
<a name="l01090"></a>01090 <span class="stringliteral">        main = function (name, deps, factory, errback, relName) {</span>
<a name="l01091"></a>01091 <span class="stringliteral">            //Only allow main calling once per module.</span>
<a name="l01092"></a>01092 <span class="stringliteral">            if (name &amp;&amp; hasProp(calledDefine, name)) {</span>
<a name="l01093"></a>01093 <span class="stringliteral">                return;</span>
<a name="l01094"></a>01094 <span class="stringliteral">            }</span>
<a name="l01095"></a>01095 <span class="stringliteral">            calledDefine[name] = true;</span>
<a name="l01096"></a>01096 <span class="stringliteral"></span>
<a name="l01097"></a>01097 <span class="stringliteral">            var d = getDefer(name);</span>
<a name="l01098"></a>01098 <span class="stringliteral"></span>
<a name="l01099"></a>01099 <span class="stringliteral">            //This module may not have dependencies</span>
<a name="l01100"></a>01100 <span class="stringliteral">            if (deps &amp;&amp; !Array.isArray(deps)) {</span>
<a name="l01101"></a>01101 <span class="stringliteral">                //deps is not an array, so probably means</span>
<a name="l01102"></a>01102 <span class="stringliteral">                //an object literal or factory function for</span>
<a name="l01103"></a>01103 <span class="stringliteral">                //the value. Adjust args.</span>
<a name="l01104"></a>01104 <span class="stringliteral">                factory = deps;</span>
<a name="l01105"></a>01105 <span class="stringliteral">                deps = [];</span>
<a name="l01106"></a>01106 <span class="stringliteral">            }</span>
<a name="l01107"></a>01107 <span class="stringliteral"></span>
<a name="l01108"></a>01108 <span class="stringliteral">            d.promise.fail(errback || delayedError);</span>
<a name="l01109"></a>01109 <span class="stringliteral"></span>
<a name="l01110"></a>01110 <span class="stringliteral">            //Use name if no relName</span>
<a name="l01111"></a>01111 <span class="stringliteral">            relName = relName || name;</span>
<a name="l01112"></a>01112 <span class="stringliteral"></span>
<a name="l01113"></a>01113 <span class="stringliteral">            //Call the factory to define the module, if necessary.</span>
<a name="l01114"></a>01114 <span class="stringliteral">            if (typeof factory === &#39;function&#39;) {</span>
<a name="l01115"></a>01115 <span class="stringliteral"></span>
<a name="l01116"></a>01116 <span class="stringliteral">                if (!deps.length &amp;&amp; factory.length) {</span>
<a name="l01117"></a>01117 <span class="stringliteral">                    //Remove comments from the callback string,</span>
<a name="l01118"></a>01118 <span class="stringliteral">                    //look for require calls, and pull them into the dependencies,</span>
<a name="l01119"></a>01119 <span class="stringliteral">                    //but only if there are function args.</span>
<a name="l01120"></a>01120 <span class="stringliteral">                    factory</span>
<a name="l01121"></a>01121 <span class="stringliteral">                        .toString()</span>
<a name="l01122"></a>01122 <span class="stringliteral">                        .replace(commentRegExp, &#39;&#39;)</span>
<a name="l01123"></a>01123 <span class="stringliteral">                        .replace(cjsRequireRegExp, function (match, dep) {</span>
<a name="l01124"></a>01124 <span class="stringliteral">                            deps.push(dep);</span>
<a name="l01125"></a>01125 <span class="stringliteral">                        });</span>
<a name="l01126"></a>01126 <span class="stringliteral"></span>
<a name="l01127"></a>01127 <span class="stringliteral">                    //May be a CommonJS thing even without require calls, but still</span>
<a name="l01128"></a>01128 <span class="stringliteral">                    //could use exports, and module. Avoid doing exports and module</span>
<a name="l01129"></a>01129 <span class="stringliteral">                    //work though if it just needs require.</span>
<a name="l01130"></a>01130 <span class="stringliteral">                    //REQUIRES the function to expect the CommonJS variables in the</span>
<a name="l01131"></a>01131 <span class="stringliteral">                    //order listed below.</span>
<a name="l01132"></a>01132 <span class="stringliteral">                    deps = (factory.length === 1 ?</span>
<a name="l01133"></a>01133 <span class="stringliteral">                            [&#39;require&#39;] :</span>
<a name="l01134"></a>01134 <span class="stringliteral">                            [&#39;require&#39;, &#39;exports&#39;, &#39;module&#39;]).concat(deps);</span>
<a name="l01135"></a>01135 <span class="stringliteral">                }</span>
<a name="l01136"></a>01136 <span class="stringliteral"></span>
<a name="l01137"></a>01137 <span class="stringliteral">                //Save info for use later.</span>
<a name="l01138"></a>01138 <span class="stringliteral">                d.factory = factory;</span>
<a name="l01139"></a>01139 <span class="stringliteral">                d.deps = deps;</span>
<a name="l01140"></a>01140 <span class="stringliteral"></span>
<a name="l01141"></a>01141 <span class="stringliteral">                d.depending = true;</span>
<a name="l01142"></a>01142 <span class="stringliteral">                deps.forEach(function (depName, i) {</span>
<a name="l01143"></a>01143 <span class="stringliteral">                    var depMap;</span>
<a name="l01144"></a>01144 <span class="stringliteral">                    deps[i] = depMap = makeMap(depName, relName, true);</span>
<a name="l01145"></a>01145 <span class="stringliteral">                    depName = depMap.id;</span>
<a name="l01146"></a>01146 <span class="stringliteral"></span>
<a name="l01147"></a>01147 <span class="stringliteral">                    //Fast path CommonJS standard dependencies.</span>
<a name="l01148"></a>01148 <span class="stringliteral">                    if (depName === &quot;</span><a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a><span class="stringliteral">&quot;) {</span>
<a name="l01149"></a>01149 <span class="stringliteral">                        d.values[i] = handlers.require(name);</span>
<a name="l01150"></a>01150 <span class="stringliteral">                    } else if (depName === &quot;</span><a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a><span class="stringliteral">&quot;) {</span>
<a name="l01151"></a>01151 <span class="stringliteral">                        //CommonJS module spec 1.1</span>
<a name="l01152"></a>01152 <span class="stringliteral">                        d.values[i] = handlers.exports(name);</span>
<a name="l01153"></a>01153 <span class="stringliteral">                        d.usingExports = true;</span>
<a name="l01154"></a>01154 <span class="stringliteral">                    } else if (depName === &quot;</span><a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a><span class="stringliteral">&quot;) {</span>
<a name="l01155"></a>01155 <span class="stringliteral">                        //CommonJS module spec 1.1</span>
<a name="l01156"></a>01156 <span class="stringliteral">                        d.values[i] = d.cjsModule = handlers.module(name);</span>
<a name="l01157"></a>01157 <span class="stringliteral">                    } else {</span>
<a name="l01158"></a>01158 <span class="stringliteral">                        waitForDep(depMap, relName, d, i);</span>
<a name="l01159"></a>01159 <span class="stringliteral">                    }</span>
<a name="l01160"></a>01160 <span class="stringliteral">                });</span>
<a name="l01161"></a>01161 <span class="stringliteral">                d.depending = false;</span>
<a name="l01162"></a>01162 <span class="stringliteral"></span>
<a name="l01163"></a>01163 <span class="stringliteral">                //Some modules just depend on the require, exports, modules, so</span>
<a name="l01164"></a>01164 <span class="stringliteral">                //trigger their definition here if so.</span>
<a name="l01165"></a>01165 <span class="stringliteral">                if (d.depCount === d.depMax) {</span>
<a name="l01166"></a>01166 <span class="stringliteral">                    defineModule(d);</span>
<a name="l01167"></a>01167 <span class="stringliteral">                }</span>
<a name="l01168"></a>01168 <span class="stringliteral">            } else if (name) {</span>
<a name="l01169"></a>01169 <span class="stringliteral">                //May just be an object definition for the module. Only</span>
<a name="l01170"></a>01170 <span class="stringliteral">                //worry about defining if have a module name.</span>
<a name="l01171"></a>01171 <span class="stringliteral">                resolve(name, d, factory);</span>
<a name="l01172"></a>01172 <span class="stringliteral">            }</span>
<a name="l01173"></a>01173 <span class="stringliteral"></span>
<a name="l01174"></a>01174 <span class="stringliteral">            startTime = (new Date()).getTime();</span>
<a name="l01175"></a>01175 <span class="stringliteral"></span>
<a name="l01176"></a>01176 <span class="stringliteral">            if (!name) {</span>
<a name="l01177"></a>01177 <span class="stringliteral">                check(d);</span>
<a name="l01178"></a>01178 <span class="stringliteral">            }</span>
<a name="l01179"></a>01179 <span class="stringliteral">        };</span>
<a name="l01180"></a>01180 <span class="stringliteral"></span>
<a name="l01181"></a>01181 <span class="stringliteral">        req = makeRequire(null, true);</span>
<a name="l01182"></a>01182 <span class="stringliteral"></span>
<a name="l01183"></a>01183 <span class="stringliteral">        /*</span>
<a name="l01184"></a>01184 <span class="stringliteral">         * Just drops the config on the floor, but returns req in case</span>
<a name="l01185"></a>01185 <span class="stringliteral">         * the config return value is used.</span>
<a name="l01186"></a>01186 <span class="stringliteral">         */</span>
<a name="l01187"></a>01187 <span class="stringliteral">        req.config = function (cfg) {</span>
<a name="l01188"></a>01188 <span class="stringliteral">            if (cfg.context &amp;&amp; cfg.context !== contextName) {</span>
<a name="l01189"></a>01189 <span class="stringliteral">                return newContext(cfg.context).config(cfg);</span>
<a name="l01190"></a>01190 <span class="stringliteral">            }</span>
<a name="l01191"></a>01191 <span class="stringliteral"></span>
<a name="l01192"></a>01192 <span class="stringliteral">            //Since config changed, mapCache may not be valid any more.</span>
<a name="l01193"></a>01193 <span class="stringliteral">            mapCache = {};</span>
<a name="l01194"></a>01194 <span class="stringliteral"></span>
<a name="l01195"></a>01195 <span class="stringliteral">            //Make sure the baseUrl ends in a slash.</span>
<a name="l01196"></a>01196 <span class="stringliteral">            if (cfg.baseUrl) {</span>
<a name="l01197"></a>01197 <span class="stringliteral">                if (cfg.baseUrl.charAt(cfg.baseUrl.length - 1) !== &#39;/&#39;) {</span>
<a name="l01198"></a>01198 <span class="stringliteral">                    cfg.baseUrl += &#39;/&#39;;</span>
<a name="l01199"></a>01199 <span class="stringliteral">                }</span>
<a name="l01200"></a>01200 <span class="stringliteral">            }</span>
<a name="l01201"></a>01201 <span class="stringliteral"></span>
<a name="l01202"></a>01202 <span class="stringliteral">            //Save off the paths and packages since they require special processing,</span>
<a name="l01203"></a>01203 <span class="stringliteral">            //they are additive.</span>
<a name="l01204"></a>01204 <span class="stringliteral">            var primId,</span>
<a name="l01205"></a>01205 <span class="stringliteral">                pkgs = config.pkgs,</span>
<a name="l01206"></a>01206 <span class="stringliteral">                shim = config.shim,</span>
<a name="l01207"></a>01207 <span class="stringliteral">                objs = {</span>
<a name="l01208"></a>01208 <span class="stringliteral">                    paths: true,</span>
<a name="l01209"></a>01209 <span class="stringliteral">                    config: true,</span>
<a name="l01210"></a>01210 <span class="stringliteral">                    map: true</span>
<a name="l01211"></a>01211 <span class="stringliteral">                };</span>
<a name="l01212"></a>01212 <span class="stringliteral"></span>
<a name="l01213"></a>01213 <span class="stringliteral">            eachProp(cfg, function (value, prop) {</span>
<a name="l01214"></a>01214 <span class="stringliteral">                if (objs[prop]) {</span>
<a name="l01215"></a>01215 <span class="stringliteral">                    if (prop === &#39;map&#39;) {</span>
<a name="l01216"></a>01216 <span class="stringliteral">                        if (!config.map) {</span>
<a name="l01217"></a>01217 <span class="stringliteral">                            config.map = {};</span>
<a name="l01218"></a>01218 <span class="stringliteral">                        }</span>
<a name="l01219"></a>01219 <span class="stringliteral">                        mixin(config[prop], value, true, true);</span>
<a name="l01220"></a>01220 <span class="stringliteral">                    } else {</span>
<a name="l01221"></a>01221 <span class="stringliteral">                        mixin(config[prop], value, true);</span>
<a name="l01222"></a>01222 <span class="stringliteral">                    }</span>
<a name="l01223"></a>01223 <span class="stringliteral">                } else {</span>
<a name="l01224"></a>01224 <span class="stringliteral">                    config[prop] = value;</span>
<a name="l01225"></a>01225 <span class="stringliteral">                }</span>
<a name="l01226"></a>01226 <span class="stringliteral">            });</span>
<a name="l01227"></a>01227 <span class="stringliteral"></span>
<a name="l01228"></a>01228 <span class="stringliteral">            //Merge shim</span>
<a name="l01229"></a>01229 <span class="stringliteral">            if (cfg.shim) {</span>
<a name="l01230"></a>01230 <span class="stringliteral">                eachProp(cfg.shim, function (value, id) {</span>
<a name="l01231"></a>01231 <span class="stringliteral">                    //Normalize the structure</span>
<a name="l01232"></a>01232 <span class="stringliteral">                    if (Array.isArray(value)) {</span>
<a name="l01233"></a>01233 <span class="stringliteral">                        value = {</span>
<a name="l01234"></a>01234 <span class="stringliteral">                            deps: value</span>
<a name="l01235"></a>01235 <span class="stringliteral">                        };</span>
<a name="l01236"></a>01236 <span class="stringliteral">                    }</span>
<a name="l01237"></a>01237 <span class="stringliteral">                    if ((value.exports || value.init) &amp;&amp; !value.exportsFn) {</span>
<a name="l01238"></a>01238 <span class="stringliteral">                        value.exportsFn = makeShimExports(value);</span>
<a name="l01239"></a>01239 <span class="stringliteral">                    }</span>
<a name="l01240"></a>01240 <span class="stringliteral">                    shim[id] = value;</span>
<a name="l01241"></a>01241 <span class="stringliteral">                });</span>
<a name="l01242"></a>01242 <span class="stringliteral">                config.shim = shim;</span>
<a name="l01243"></a>01243 <span class="stringliteral">            }</span>
<a name="l01244"></a>01244 <span class="stringliteral"></span>
<a name="l01245"></a>01245 <span class="stringliteral">            //Adjust packages if necessary.</span>
<a name="l01246"></a>01246 <span class="stringliteral">            if (cfg.packages) {</span>
<a name="l01247"></a>01247 <span class="stringliteral">                cfg.packages.forEach(function (pkgObj) {</span>
<a name="l01248"></a>01248 <span class="stringliteral">                    var location;</span>
<a name="l01249"></a>01249 <span class="stringliteral"></span>
<a name="l01250"></a>01250 <span class="stringliteral">                    pkgObj = typeof pkgObj === &#39;string&#39; ? { name: pkgObj } : pkgObj;</span>
<a name="l01251"></a>01251 <span class="stringliteral">                    location = pkgObj.location;</span>
<a name="l01252"></a>01252 <span class="stringliteral"></span>
<a name="l01253"></a>01253 <span class="stringliteral">                    //Create a brand new object on pkgs, since currentPackages can</span>
<a name="l01254"></a>01254 <span class="stringliteral">                    //be passed in again, and config.pkgs is the internal transformed</span>
<a name="l01255"></a>01255 <span class="stringliteral">                    //state for all package configs.</span>
<a name="l01256"></a>01256 <span class="stringliteral">                    pkgs[pkgObj.name] = {</span>
<a name="l01257"></a>01257 <span class="stringliteral">                        name: pkgObj.name,</span>
<a name="l01258"></a>01258 <span class="stringliteral">                        location: location || pkgObj.name,</span>
<a name="l01259"></a>01259 <span class="stringliteral">                        //Remove leading dot in main, so main paths are normalized,</span>
<a name="l01260"></a>01260 <span class="stringliteral">                        //and remove any trailing .js, since different package</span>
<a name="l01261"></a>01261 <span class="stringliteral">                        //envs have different conventions: some use a module name,</span>
<a name="l01262"></a>01262 <span class="stringliteral">                        //some use a file name.</span>
<a name="l01263"></a>01263 <span class="stringliteral">                        main: (pkgObj.main || &#39;main&#39;)</span>
<a name="l01264"></a>01264 <span class="stringliteral">                              .replace(currDirRegExp, &#39;&#39;)</span>
<a name="l01265"></a>01265 <span class="stringliteral">                              .replace(jsSuffixRegExp, &#39;&#39;)</span>
<a name="l01266"></a>01266 <span class="stringliteral">                    };</span>
<a name="l01267"></a>01267 <span class="stringliteral">                });</span>
<a name="l01268"></a>01268 <span class="stringliteral"></span>
<a name="l01269"></a>01269 <span class="stringliteral">                //Done with modifications, assing packages back to context config</span>
<a name="l01270"></a>01270 <span class="stringliteral">                config.pkgs = pkgs;</span>
<a name="l01271"></a>01271 <span class="stringliteral">            }</span>
<a name="l01272"></a>01272 <span class="stringliteral"></span>
<a name="l01273"></a>01273 <span class="stringliteral">            //If want prim injected, inject it now.</span>
<a name="l01274"></a>01274 <span class="stringliteral">            primId = config.definePrim;</span>
<a name="l01275"></a>01275 <span class="stringliteral">            if (primId) {</span>
<a name="l01276"></a>01276 <span class="stringliteral">                waiting[primId] = [primId, [], function () { return prim; }];</span>
<a name="l01277"></a>01277 <span class="stringliteral">            }</span>
<a name="l01278"></a>01278 <span class="stringliteral"></span>
<a name="l01279"></a>01279 <span class="stringliteral">            //If a deps array or a config callback is specified, then call</span>
<a name="l01280"></a>01280 <span class="stringliteral">            //require with those args. This is useful when require is defined as a</span>
<a name="l01281"></a>01281 <span class="stringliteral">            //config object before require.js is loaded.</span>
<a name="l01282"></a>01282 <span class="stringliteral">            if (cfg.deps) {</span>
<a name="l01283"></a>01283 <span class="stringliteral">                req(cfg.deps, cfg.callback);</span>
<a name="l01284"></a>01284 <span class="stringliteral">            }</span>
<a name="l01285"></a>01285 <span class="stringliteral"></span>
<a name="l01286"></a>01286 <span class="stringliteral">            return req;</span>
<a name="l01287"></a>01287 <span class="stringliteral">        };</span>
<a name="l01288"></a>01288 <span class="stringliteral"></span>
<a name="l01289"></a>01289 <span class="stringliteral">        req.onError = function (err) {</span>
<a name="l01290"></a>01290 <span class="stringliteral">            throw err;</span>
<a name="l01291"></a>01291 <span class="stringliteral">        };</span>
<a name="l01292"></a>01292 <span class="stringliteral"></span>
<a name="l01293"></a>01293 <span class="stringliteral">        context = {</span>
<a name="l01294"></a>01294 <span class="stringliteral">            id: contextName,</span>
<a name="l01295"></a>01295 <span class="stringliteral">            defined: defined,</span>
<a name="l01296"></a>01296 <span class="stringliteral">            waiting: waiting,</span>
<a name="l01297"></a>01297 <span class="stringliteral">            config: config,</span>
<a name="l01298"></a>01298 <span class="stringliteral">            deferreds: deferreds</span>
<a name="l01299"></a>01299 <span class="stringliteral">        };</span>
<a name="l01300"></a>01300 <span class="stringliteral"></span>
<a name="l01301"></a>01301 <span class="stringliteral">        contexts[contextName] = context;</span>
<a name="l01302"></a>01302 <span class="stringliteral"></span>
<a name="l01303"></a>01303 <span class="stringliteral">        return req;</span>
<a name="l01304"></a>01304 <span class="stringliteral">    }</span>
<a name="l01305"></a>01305 <span class="stringliteral"></span>
<a name="l01306"></a>01306 <span class="stringliteral">    requirejs = topReq = newContext(&#39;_&#39;);</span>
<a name="l01307"></a>01307 <span class="stringliteral"></span>
<a name="l01308"></a>01308 <span class="stringliteral">    if (typeof require !== &#39;function&#39;) {</span>
<a name="l01309"></a>01309 <span class="stringliteral">        require = topReq;</span>
<a name="l01310"></a>01310 <span class="stringliteral">    }</span>
<a name="l01311"></a>01311 <span class="stringliteral"></span>
<a name="l01318"></a>01318 <span class="stringliteral">    topReq.exec = function (text) {</span>
<a name="l01319"></a>01319 <span class="stringliteral">        /*jslint evil: true */</span>
<a name="l01320"></a>01320 <span class="stringliteral">        return eval(text);</span>
<a name="l01321"></a>01321 <span class="stringliteral">    };</span>
<a name="l01322"></a>01322 <span class="stringliteral"></span>
<a name="l01323"></a>01323 <span class="stringliteral">    topReq.contexts = contexts;</span>
<a name="l01324"></a>01324 <span class="stringliteral"></span>
<a name="l01325"></a>01325 <span class="stringliteral">    define = function () {</span>
<a name="l01326"></a>01326 <span class="stringliteral">        queue.push([].slice.call(arguments, 0));</span>
<a name="l01327"></a>01327 <span class="stringliteral">    };</span>
<a name="l01328"></a>01328 <span class="stringliteral"></span>
<a name="l01329"></a>01329 <span class="stringliteral">    define.amd = {</span>
<a name="l01330"></a>01330 <span class="stringliteral">        jQuery: true</span>
<a name="l01331"></a>01331 <span class="stringliteral">    };</span>
<a name="l01332"></a>01332 <span class="stringliteral"></span>
<a name="l01333"></a>01333 <span class="stringliteral">    if (bootstrapConfig) {</span>
<a name="l01334"></a>01334 <span class="stringliteral">        topReq.config(bootstrapConfig);</span>
<a name="l01335"></a>01335 <span class="stringliteral">    }</span>
<a name="l01336"></a>01336 <span class="stringliteral"></span>
<a name="l01337"></a>01337 <span class="stringliteral">    //data-main support.</span>
<a name="l01338"></a>01338 <span class="stringliteral">    if (topReq.isBrowser) {</span>
<a name="l01339"></a>01339 <span class="stringliteral">        dataMain = document.querySelectorAll(&#39;script[data-main]&#39;)[0];</span>
<a name="l01340"></a>01340 <span class="stringliteral">        dataMain = dataMain &amp;&amp; dataMain.getAttribute(&#39;data-main&#39;);</span>
<a name="l01341"></a>01341 <span class="stringliteral">        if (dataMain) {</span>
<a name="l01342"></a>01342 <span class="stringliteral">            //Strip off any trailing .js since dataMain is now</span>
<a name="l01343"></a>01343 <span class="stringliteral">            //like a module name.</span>
<a name="l01344"></a>01344 <span class="stringliteral">            dataMain = dataMain.replace(jsSuffixRegExp, &#39;&#39;);</span>
<a name="l01345"></a>01345 <span class="stringliteral">            topReq([dataMain]);</span>
<a name="l01346"></a>01346 <span class="stringliteral">        }</span>
<a name="l01347"></a>01347 <span class="stringliteral">    }</span>
<a name="l01348"></a>01348 <span class="stringliteral">}(this));</span>
<a name="l01349"></a>01349 <span class="stringliteral"></span>
<a name="l01350"></a>01350 <span class="stringliteral">define(&quot;</span>alameda<span class="stringliteral">&quot;, function(){});</span>
<a name="l01351"></a>01351 <span class="stringliteral"></span>
<a name="l01352"></a>01352 <span class="stringliteral">/*global define, setTimeout */</span>
<a name="l01353"></a>01353 <span class="stringliteral">/*</span>
<a name="l01354"></a>01354 <span class="stringliteral"> * Custom events lib. Notable features:</span>
<a name="l01355"></a>01355 <span class="stringliteral"> *</span>
<a name="l01356"></a>01356 <span class="stringliteral"> * - the module itself is an event emitter. Useful for &quot;</span><a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a5363025b2c2d773292f0f064aeb11f9e">global</a><span class="stringliteral">&quot; pub/sub.</span>
<a name="l01357"></a>01357 <span class="stringliteral"> * - evt.mix can be used to mix in an event emitter into existing object.</span>
<a name="l01358"></a>01358 <span class="stringliteral"> * - notification of listeners is done in a try/catch, so all listeners</span>
<a name="l01359"></a>01359 <span class="stringliteral"> *   are notified even if one fails. Errors are thrown async via setTimeout</span>
<a name="l01360"></a>01360 <span class="stringliteral"> *   so that all the listeners can be notified without escaping from the</span>
<a name="l01361"></a>01361 <span class="stringliteral"> *   code via a throw within the listener group notification.</span>
<a name="l01362"></a>01362 <span class="stringliteral"> * - new evt.Emitter() can be used to create a new instance of an</span>
<a name="l01363"></a>01363 <span class="stringliteral"> *   event emitter.</span>
<a name="l01364"></a>01364 <span class="stringliteral"> * - Uses &quot;</span><span class="keyword">this</span><span class="stringliteral">&quot; insternally, so always call object with the emitter args</span>
<a name="l01365"></a>01365 <span class="stringliteral"> *</span>
<a name="l01366"></a>01366 <span class="stringliteral"> */</span>
<a name="l01367"></a>01367 <span class="stringliteral">define(&#39;evt&#39;,[],function() {</span>
<a name="l01368"></a>01368 <span class="stringliteral"></span>
<a name="l01369"></a>01369 <span class="stringliteral">  var evt,</span>
<a name="l01370"></a>01370 <span class="stringliteral">      slice = Array.prototype.slice,</span>
<a name="l01371"></a>01371 <span class="stringliteral">      props = [&#39;_events&#39;, &#39;_pendingEvents&#39;, &#39;on&#39;, &#39;once&#39;, &#39;latest&#39;,</span>
<a name="l01372"></a>01372 <span class="stringliteral">               &#39;latestOnce&#39;, &#39;removeListener&#39;, &#39;emitWhenListener&#39;, &#39;emit&#39;];</span>
<a name="l01373"></a>01373 <span class="stringliteral"></span>
<a name="l01374"></a>01374 <span class="stringliteral">  function Emitter() {</span>
<a name="l01375"></a>01375 <span class="stringliteral">    this._events = {};</span>
<a name="l01376"></a>01376 <span class="stringliteral">    this._pendingEvents = {};</span>
<a name="l01377"></a>01377 <span class="stringliteral">  }</span>
<a name="l01378"></a>01378 <span class="stringliteral"></span>
<a name="l01379"></a>01379 <span class="stringliteral">  Emitter.prototype = {</span>
<a name="l01380"></a>01380 <span class="stringliteral">    on: function(id, fn) {</span>
<a name="l01381"></a>01381 <span class="stringliteral">      var listeners = this._events[id],</span>
<a name="l01382"></a>01382 <span class="stringliteral">          pending = this._pendingEvents[id];</span>
<a name="l01383"></a>01383 <span class="stringliteral">      if (!listeners) {</span>
<a name="l01384"></a>01384 <span class="stringliteral">        listeners = this._events[id] = [];</span>
<a name="l01385"></a>01385 <span class="stringliteral">      }</span>
<a name="l01386"></a>01386 <span class="stringliteral">      listeners.push(fn);</span>
<a name="l01387"></a>01387 <span class="stringliteral"></span>
<a name="l01388"></a>01388 <span class="stringliteral">      if (pending) {</span>
<a name="l01389"></a>01389 <span class="stringliteral">        pending.forEach(function(args) {</span>
<a name="l01390"></a>01390 <span class="stringliteral">          fn.apply(null, args);</span>
<a name="l01391"></a>01391 <span class="stringliteral">        });</span>
<a name="l01392"></a>01392 <span class="stringliteral">        delete this._pendingEvents[id];</span>
<a name="l01393"></a>01393 <span class="stringliteral">      }</span>
<a name="l01394"></a>01394 <span class="stringliteral">      return this;</span>
<a name="l01395"></a>01395 <span class="stringliteral">    },</span>
<a name="l01396"></a>01396 <span class="stringliteral"></span>
<a name="l01397"></a>01397 <span class="stringliteral">    once: function(id, fn) {</span>
<a name="l01398"></a>01398 <span class="stringliteral">      var self = this,</span>
<a name="l01399"></a>01399 <span class="stringliteral">          fired = false;</span>
<a name="l01400"></a>01400 <span class="stringliteral">      function one() {</span>
<a name="l01401"></a>01401 <span class="stringliteral">        if (fired)</span>
<a name="l01402"></a>01402 <span class="stringliteral">          return;</span>
<a name="l01403"></a>01403 <span class="stringliteral">        fired = true;</span>
<a name="l01404"></a>01404 <span class="stringliteral">        fn.apply(null, arguments);</span>
<a name="l01405"></a>01405 <span class="stringliteral">        // Remove at a further turn so that the event</span>
<a name="l01406"></a>01406 <span class="stringliteral">        // forEach in emit does not get modified during</span>
<a name="l01407"></a>01407 <span class="stringliteral">        // this turn.</span>
<a name="l01408"></a>01408 <span class="stringliteral">        setTimeout(function() {</span>
<a name="l01409"></a>01409 <span class="stringliteral">          self.removeListener(id, one);</span>
<a name="l01410"></a>01410 <span class="stringliteral">        });</span>
<a name="l01411"></a>01411 <span class="stringliteral">      }</span>
<a name="l01412"></a>01412 <span class="stringliteral">      return this.on(id, one);</span>
<a name="l01413"></a>01413 <span class="stringliteral">    },</span>
<a name="l01414"></a>01414 <span class="stringliteral"></span>
<a name="l01427"></a>01427 <span class="stringliteral">    latest: function(id, fn) {</span>
<a name="l01428"></a>01428 <span class="stringliteral">      if (this[id] &amp;&amp; !this._pendingEvents[id]) {</span>
<a name="l01429"></a>01429 <span class="stringliteral">        fn(this[id]);</span>
<a name="l01430"></a>01430 <span class="stringliteral">      }</span>
<a name="l01431"></a>01431 <span class="stringliteral">      this.on(id, fn);</span>
<a name="l01432"></a>01432 <span class="stringliteral">    },</span>
<a name="l01433"></a>01433 <span class="stringliteral"></span>
<a name="l01439"></a>01439 <span class="stringliteral">    latestOnce: function(id, fn) {</span>
<a name="l01440"></a>01440 <span class="stringliteral">      if (this[id] &amp;&amp; !this._pendingEvents[id])</span>
<a name="l01441"></a>01441 <span class="stringliteral">        fn(this[id]);</span>
<a name="l01442"></a>01442 <span class="stringliteral">      else</span>
<a name="l01443"></a>01443 <span class="stringliteral">        this.once(id, fn);</span>
<a name="l01444"></a>01444 <span class="stringliteral">    },</span>
<a name="l01445"></a>01445 <span class="stringliteral"></span>
<a name="l01446"></a>01446 <span class="stringliteral">    removeListener: function(id, fn) {</span>
<a name="l01447"></a>01447 <span class="stringliteral">      var i,</span>
<a name="l01448"></a>01448 <span class="stringliteral">          listeners = this._events[id];</span>
<a name="l01449"></a>01449 <span class="stringliteral">      if (listeners) {</span>
<a name="l01450"></a>01450 <span class="stringliteral">        i = listeners.indexOf(fn);</span>
<a name="l01451"></a>01451 <span class="stringliteral">        if (i !== -1) {</span>
<a name="l01452"></a>01452 <span class="stringliteral">          listeners.splice(i, 1);</span>
<a name="l01453"></a>01453 <span class="stringliteral">        }</span>
<a name="l01454"></a>01454 <span class="stringliteral">        if (listeners.length === 0)</span>
<a name="l01455"></a>01455 <span class="stringliteral">          delete this._events[id];</span>
<a name="l01456"></a>01456 <span class="stringliteral">      }</span>
<a name="l01457"></a>01457 <span class="stringliteral">    },</span>
<a name="l01458"></a>01458 <span class="stringliteral"></span>
<a name="l01465"></a>01465 <span class="stringliteral">    emitWhenListener: function(id) {</span>
<a name="l01466"></a>01466 <span class="stringliteral">      var listeners = this._events[id];</span>
<a name="l01467"></a>01467 <span class="stringliteral">      if (listeners) {</span>
<a name="l01468"></a>01468 <span class="stringliteral">        this.emit.apply(this, arguments);</span>
<a name="l01469"></a>01469 <span class="stringliteral">      } else {</span>
<a name="l01470"></a>01470 <span class="stringliteral">        if (!this._pendingEvents[id])</span>
<a name="l01471"></a>01471 <span class="stringliteral">          this._pendingEvents[id] = [];</span>
<a name="l01472"></a>01472 <span class="stringliteral">        this._pendingEvents[id].push(slice.call(arguments, 1));</span>
<a name="l01473"></a>01473 <span class="stringliteral">      }</span>
<a name="l01474"></a>01474 <span class="stringliteral">    },</span>
<a name="l01475"></a>01475 <span class="stringliteral"></span>
<a name="l01476"></a>01476 <span class="stringliteral">    emit: function(id) {</span>
<a name="l01477"></a>01477 <span class="stringliteral">      var args = slice.call(arguments, 1),</span>
<a name="l01478"></a>01478 <span class="stringliteral">          listeners = this._events[id];</span>
<a name="l01479"></a>01479 <span class="stringliteral">      if (listeners) {</span>
<a name="l01480"></a>01480 <span class="stringliteral">        listeners.forEach(function(fn) {</span>
<a name="l01481"></a>01481 <span class="stringliteral">          try {</span>
<a name="l01482"></a>01482 <span class="stringliteral">            fn.apply(null, args);</span>
<a name="l01483"></a>01483 <span class="stringliteral">          } catch (e) {</span>
<a name="l01484"></a>01484 <span class="stringliteral">            // Throw at later turn so that other listeners</span>
<a name="l01485"></a>01485 <span class="stringliteral">            // can complete. While this messes with the</span>
<a name="l01486"></a>01486 <span class="stringliteral">            // stack for the error, continued operation is</span>
<a name="l01487"></a>01487 <span class="stringliteral">            // valued more in this tradeoff.</span>
<a name="l01488"></a>01488 <span class="stringliteral">            setTimeout(function() {</span>
<a name="l01489"></a>01489 <span class="stringliteral">              throw e;</span>
<a name="l01490"></a>01490 <span class="stringliteral">            });</span>
<a name="l01491"></a>01491 <span class="stringliteral">          }</span>
<a name="l01492"></a>01492 <span class="stringliteral">        });</span>
<a name="l01493"></a>01493 <span class="stringliteral">      }</span>
<a name="l01494"></a>01494 <span class="stringliteral">    }</span>
<a name="l01495"></a>01495 <span class="stringliteral">  };</span>
<a name="l01496"></a>01496 <span class="stringliteral"></span>
<a name="l01497"></a>01497 <span class="stringliteral">  evt = new Emitter();</span>
<a name="l01498"></a>01498 <span class="stringliteral">  evt.Emitter = Emitter;</span>
<a name="l01499"></a>01499 <span class="stringliteral"></span>
<a name="l01500"></a>01500 <span class="stringliteral">  evt.mix = function(obj) {</span>
<a name="l01501"></a>01501 <span class="stringliteral">    var e = new Emitter();</span>
<a name="l01502"></a>01502 <span class="stringliteral">    props.forEach(function(prop) {</span>
<a name="l01503"></a>01503 <span class="stringliteral">      if (obj.hasOwnProperty(prop)) {</span>
<a name="l01504"></a>01504 <span class="stringliteral">        throw new Error(&#39;Object already has a property &quot;</span><span class="stringliteral">&#39; + prop + &#39;</span><span class="stringliteral">&quot;&#39;);</span>
<a name="l01505"></a>01505 <span class="stringliteral">      }</span>
<a name="l01506"></a>01506 <span class="stringliteral">      obj[prop] = e[prop];</span>
<a name="l01507"></a>01507 <span class="stringliteral">    });</span>
<a name="l01508"></a>01508 <span class="stringliteral">    return obj;</span>
<a name="l01509"></a>01509 <span class="stringliteral">  };</span>
<a name="l01510"></a>01510 <span class="stringliteral"></span>
<a name="l01511"></a>01511 <span class="stringliteral">  return evt;</span>
<a name="l01512"></a>01512 <span class="stringliteral">});</span>
<a name="l01513"></a>01513 <span class="stringliteral"></span>
<a name="l01514"></a>01514 <span class="stringliteral">/*jshint browser: true */</span>
<a name="l01515"></a>01515 <span class="stringliteral">/*globals define */</span>
<a name="l01516"></a>01516 <span class="stringliteral"></span>
<a name="l01528"></a>01528 <span class="stringliteral">define(&#39;app_self&#39;,[&#39;require&#39;,&#39;exports&#39;,&#39;module&#39;,&#39;evt&#39;],function(require, exports, module) {</span>
<a name="l01529"></a>01529 <span class="stringliteral">  var evt = require(&#39;evt&#39;);</span>
<a name="l01530"></a>01530 <span class="stringliteral"></span>
<a name="l01531"></a>01531 <span class="stringliteral">  var appSelf = evt.mix({}),</span>
<a name="l01532"></a>01532 <span class="stringliteral">      mozApps = navigator.mozApps,</span>
<a name="l01533"></a>01533 <span class="stringliteral">      oldLatest = appSelf.latest,</span>
<a name="l01534"></a>01534 <span class="stringliteral">      loaded = false;</span>
<a name="l01535"></a>01535 <span class="stringliteral"></span>
<a name="l01536"></a>01536 <span class="stringliteral">  if (!mozApps) {</span>
<a name="l01537"></a>01537 <span class="stringliteral">    appSelf.self = {};</span>
<a name="l01538"></a>01538 <span class="stringliteral">    loaded = true;</span>
<a name="l01539"></a>01539 <span class="stringliteral">  }</span>
<a name="l01540"></a>01540 <span class="stringliteral"></span>
<a name="l01541"></a>01541 <span class="stringliteral">  function loadSelf() {</span>
<a name="l01542"></a>01542 <span class="stringliteral">    mozApps.getSelf().onsuccess = function(event) {</span>
<a name="l01543"></a>01543 <span class="stringliteral">      loaded = true;</span>
<a name="l01544"></a>01544 <span class="stringliteral">      var app = event.target.result;</span>
<a name="l01545"></a>01545 <span class="stringliteral">      appSelf.self = app;</span>
<a name="l01546"></a>01546 <span class="stringliteral">      appSelf.emit(&#39;self&#39;, appSelf.self);</span>
<a name="l01547"></a>01547 <span class="stringliteral">    };</span>
<a name="l01548"></a>01548 <span class="stringliteral">  }</span>
<a name="l01549"></a>01549 <span class="stringliteral"></span>
<a name="l01550"></a>01550 <span class="stringliteral">  // Override latest to only do the work when something actually wants to</span>
<a name="l01551"></a>01551 <span class="stringliteral">  // listen.</span>
<a name="l01552"></a>01552 <span class="stringliteral">  appSelf.latest = function(id) {</span>
<a name="l01553"></a>01553 <span class="stringliteral">    if (!loaded)</span>
<a name="l01554"></a>01554 <span class="stringliteral">      loadSelf();</span>
<a name="l01555"></a>01555 <span class="stringliteral"></span>
<a name="l01556"></a>01556 <span class="stringliteral">    if (id !== &#39;self&#39;)</span>
<a name="l01557"></a>01557 <span class="stringliteral">      throw new Error(module.id + &#39; only supports &quot;</span><span class="keyword">self</span><span class="stringliteral">&quot; property&#39;);</span>
<a name="l01558"></a>01558 <span class="stringliteral"></span>
<a name="l01559"></a>01559 <span class="stringliteral">    return oldLatest.apply(this, arguments);</span>
<a name="l01560"></a>01560 <span class="stringliteral">  };</span>
<a name="l01561"></a>01561 <span class="stringliteral"></span>
<a name="l01562"></a>01562 <span class="stringliteral">  return appSelf;</span>
<a name="l01563"></a>01563 <span class="stringliteral">});</span>
<a name="l01564"></a>01564 <span class="stringliteral"></span>
<a name="l01565"></a>01565 <span class="stringliteral">/*global define */</span>
<a name="l01566"></a>01566 <span class="stringliteral">define(&#39;query_string&#39;,[],function() {</span>
<a name="l01567"></a>01567 <span class="stringliteral">  var queryString = {</span>
<a name="l01574"></a>01574 <span class="stringliteral">    toObject: function toObject(value) {</span>
<a name="l01575"></a>01575 <span class="stringliteral">      if (!value)</span>
<a name="l01576"></a>01576 <span class="stringliteral">        return null;</span>
<a name="l01577"></a>01577 <span class="stringliteral"></span>
<a name="l01578"></a>01578 <span class="stringliteral">      var result = {};</span>
<a name="l01579"></a>01579 <span class="stringliteral"></span>
<a name="l01580"></a>01580 <span class="stringliteral">      value.split(&#39;&amp;&#39;).forEach(function(keyValue) {</span>
<a name="l01581"></a>01581 <span class="stringliteral">        var pair = keyValue.split(&#39;=&#39;);</span>
<a name="l01582"></a>01582 <span class="stringliteral">        result[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);</span>
<a name="l01583"></a>01583 <span class="stringliteral">      });</span>
<a name="l01584"></a>01584 <span class="stringliteral">      return result;</span>
<a name="l01585"></a>01585 <span class="stringliteral">    },</span>
<a name="l01586"></a>01586 <span class="stringliteral"></span>
<a name="l01587"></a>01587 <span class="stringliteral">    fromObject: function fromObject(object) {</span>
<a name="l01588"></a>01588 <span class="stringliteral">      var result = &#39;&#39;;</span>
<a name="l01589"></a>01589 <span class="stringliteral">      Object.keys(object).forEach(function(key) {</span>
<a name="l01590"></a>01590 <span class="stringliteral">        result += (result ? &#39;&amp;&#39; : &#39;&#39;) + encodeURIComponent(key) +</span>
<a name="l01591"></a>01591 <span class="stringliteral">                 &#39;=&#39; + encodeURIComponent(object[key]);</span>
<a name="l01592"></a>01592 <span class="stringliteral">      });</span>
<a name="l01593"></a>01593 <span class="stringliteral">      return result;</span>
<a name="l01594"></a>01594 <span class="stringliteral">    }</span>
<a name="l01595"></a>01595 <span class="stringliteral">  };</span>
<a name="l01596"></a>01596 <span class="stringliteral"></span>
<a name="l01597"></a>01597 <span class="stringliteral">  return queryString;</span>
<a name="l01598"></a>01598 <span class="stringliteral">});</span>
<a name="l01599"></a>01599 <span class="stringliteral"></span>
<a name="l01600"></a>01600 <span class="stringliteral">define(&#39;query_uri&#39;,[],function() {</span>
<a name="l01601"></a>01601 <span class="stringliteral">  function queryURI(uri) {</span>
<a name="l01602"></a>01602 <span class="stringliteral">    function addressesToArray(addresses) {</span>
<a name="l01603"></a>01603 <span class="stringliteral">      if (!addresses)</span>
<a name="l01604"></a>01604 <span class="stringliteral">        return [];</span>
<a name="l01605"></a>01605 <span class="stringliteral">      addresses = addresses.split(/[,;]/);</span>
<a name="l01606"></a>01606 <span class="stringliteral">      var addressesArray = addresses.filter(function notEmpty(addr) {</span>
<a name="l01607"></a>01607 <span class="stringliteral">        return addr.trim() !== &#39;&#39;;</span>
<a name="l01608"></a>01608 <span class="stringliteral">      });</span>
<a name="l01609"></a>01609 <span class="stringliteral">      return addressesArray;</span>
<a name="l01610"></a>01610 <span class="stringliteral">    }</span>
<a name="l01611"></a>01611 <span class="stringliteral">    var mailtoReg = /^mailto:(.*)/i;</span>
<a name="l01612"></a>01612 <span class="stringliteral"></span>
<a name="l01613"></a>01613 <span class="stringliteral">    if (uri.match(mailtoReg)) {</span>
<a name="l01614"></a>01614 <span class="stringliteral">      uri = uri.match(mailtoReg)[1];</span>
<a name="l01615"></a>01615 <span class="stringliteral">      var parts = uri.split(&#39;?&#39;);</span>
<a name="l01616"></a>01616 <span class="stringliteral">      var subjectReg = /(?:^|&amp;)subject=([^\&amp;]*)/i,</span>
<a name="l01617"></a>01617 <span class="stringliteral">      bodyReg = /(?:^|&amp;)body=([^\&amp;]*)/i,</span>
<a name="l01618"></a>01618 <span class="stringliteral">      ccReg = /(?:^|&amp;)cc=([^\&amp;]*)/i,</span>
<a name="l01619"></a>01619 <span class="stringliteral">      bccReg = /(?:^|&amp;)bcc=([^\&amp;]*)/i;</span>
<a name="l01620"></a>01620 <span class="stringliteral">      // Check if the &#39;to&#39; field is set and properly decode it</span>
<a name="l01621"></a>01621 <span class="stringliteral">      var to = parts[0] ? addressesToArray(decodeURIComponent(parts[0])) : [],</span>
<a name="l01622"></a>01622 <span class="stringliteral">      subject,</span>
<a name="l01623"></a>01623 <span class="stringliteral">      body,</span>
<a name="l01624"></a>01624 <span class="stringliteral">      cc,</span>
<a name="l01625"></a>01625 <span class="stringliteral">      bcc;</span>
<a name="l01626"></a>01626 <span class="stringliteral"></span>
<a name="l01627"></a>01627 <span class="stringliteral">      if (parts.length == 2) {</span>
<a name="l01628"></a>01628 <span class="stringliteral">        var data = parts[1];</span>
<a name="l01629"></a>01629 <span class="stringliteral">        if (data.match(subjectReg))</span>
<a name="l01630"></a>01630 <span class="stringliteral">          subject = decodeURIComponent(data.match(subjectReg)[1]);</span>
<a name="l01631"></a>01631 <span class="stringliteral">        if (data.match(bodyReg))</span>
<a name="l01632"></a>01632 <span class="stringliteral">          body = decodeURIComponent(data.match(bodyReg)[1]);</span>
<a name="l01633"></a>01633 <span class="stringliteral">        if (data.match(ccReg))</span>
<a name="l01634"></a>01634 <span class="stringliteral">          cc = addressesToArray(decodeURIComponent(data.match(ccReg)[1]));</span>
<a name="l01635"></a>01635 <span class="stringliteral">        if (parts[1].match(bccReg))</span>
<a name="l01636"></a>01636 <span class="stringliteral">          bcc = addressesToArray(decodeURIComponent(data.match(bccReg)[1]));</span>
<a name="l01637"></a>01637 <span class="stringliteral">      }</span>
<a name="l01638"></a>01638 <span class="stringliteral">        return [to, subject, body, cc, bcc];</span>
<a name="l01639"></a>01639 <span class="stringliteral">    }</span>
<a name="l01640"></a>01640 <span class="stringliteral"></span>
<a name="l01641"></a>01641 <span class="stringliteral">  }</span>
<a name="l01642"></a>01642 <span class="stringliteral"></span>
<a name="l01643"></a>01643 <span class="stringliteral">  return queryURI;</span>
<a name="l01644"></a>01644 <span class="stringliteral">});</span>
<a name="l01645"></a>01645 <span class="stringliteral"></span>
<a name="l01646"></a>01646 <span class="stringliteral">/*jshint browser: true */</span>
<a name="l01647"></a>01647 <span class="stringliteral">/*global define, console */</span>
<a name="l01648"></a>01648 <span class="stringliteral">define(&#39;app_messages&#39;,[&#39;require&#39;,&#39;app_self&#39;,&#39;evt&#39;,&#39;query_string&#39;,&#39;query_uri&#39;],function(require) {</span>
<a name="l01649"></a>01649 <span class="stringliteral">  var appSelf = require(&#39;app_self&#39;),</span>
<a name="l01650"></a>01650 <span class="stringliteral">      evt = require(&#39;evt&#39;),</span>
<a name="l01651"></a>01651 <span class="stringliteral">      queryString = require(&#39;query_string&#39;),</span>
<a name="l01652"></a>01652 <span class="stringliteral">      queryURI = require(&#39;query_uri&#39;);</span>
<a name="l01653"></a>01653 <span class="stringliteral"></span>
<a name="l01654"></a>01654 <span class="stringliteral">  var pending = {};</span>
<a name="l01655"></a>01655 <span class="stringliteral">  // htmlCacheRestorePendingMessage defined in html_cache_restore,</span>
<a name="l01656"></a>01656 <span class="stringliteral">  // see comment for it.</span>
<a name="l01657"></a>01657 <span class="stringliteral">  var cachedList = (window.htmlCacheRestorePendingMessage &amp;&amp;</span>
<a name="l01658"></a>01658 <span class="stringliteral">                    window.htmlCacheRestorePendingMessage.length) ?</span>
<a name="l01659"></a>01659 <span class="stringliteral">      window.htmlCacheRestorePendingMessage : [];</span>
<a name="l01660"></a>01660 <span class="stringliteral">  // Convert the cached list to named properties on pending.</span>
<a name="l01661"></a>01661 <span class="stringliteral">  cachedList.forEach(function(type) {</span>
<a name="l01662"></a>01662 <span class="stringliteral">    pending[type] = true;</span>
<a name="l01663"></a>01663 <span class="stringliteral">  });</span>
<a name="l01664"></a>01664 <span class="stringliteral"></span>
<a name="l01665"></a>01665 <span class="stringliteral">  var appMessages = evt.mix({</span>
<a name="l01672"></a>01672 <span class="stringliteral">    hasPending: function(type) {</span>
<a name="l01673"></a>01673 <span class="stringliteral">      return pending.hasOwnProperty(type) ||</span>
<a name="l01674"></a>01674 <span class="stringliteral">             (navigator.mozHasPendingMessage &amp;&amp;</span>
<a name="l01675"></a>01675 <span class="stringliteral">              navigator.mozHasPendingMessage(type));</span>
<a name="l01676"></a>01676 <span class="stringliteral">    },</span>
<a name="l01677"></a>01677 <span class="stringliteral"></span>
<a name="l01683"></a>01683 <span class="stringliteral">    onActivityRequest: function(req) {</span>
<a name="l01684"></a>01684 <span class="stringliteral">      // Parse the activity request.</span>
<a name="l01685"></a>01685 <span class="stringliteral">      var source = req.source;</span>
<a name="l01686"></a>01686 <span class="stringliteral">      var sourceData = source.data;</span>
<a name="l01687"></a>01687 <span class="stringliteral">      var activityName = source.name;</span>
<a name="l01688"></a>01688 <span class="stringliteral">      var dataType = sourceData.type;</span>
<a name="l01689"></a>01689 <span class="stringliteral">      var url = sourceData.url || sourceData.URI;</span>
<a name="l01690"></a>01690 <span class="stringliteral"></span>
<a name="l01691"></a>01691 <span class="stringliteral">      // To assist in bug analysis, log the start of the activity here.</span>
<a name="l01692"></a>01692 <span class="stringliteral">      console.log(&#39;Received activity: &#39; + activityName);</span>
<a name="l01693"></a>01693 <span class="stringliteral"></span>
<a name="l01694"></a>01694 <span class="stringliteral">      var data = {};</span>
<a name="l01695"></a>01695 <span class="stringliteral">      if (dataType === &#39;url&#39;) {</span>
<a name="l01696"></a>01696 <span class="stringliteral">        data.body = url;</span>
<a name="l01697"></a>01697 <span class="stringliteral">      } else {</span>
<a name="l01698"></a>01698 <span class="stringliteral">        var urlParts = url ? queryURI(url) : [];</span>
<a name="l01699"></a>01699 <span class="stringliteral">        data.to = urlParts[0];</span>
<a name="l01700"></a>01700 <span class="stringliteral">        data.subject = urlParts[1];</span>
<a name="l01701"></a>01701 <span class="stringliteral">        data.body = typeof urlParts[2] === &#39;string&#39; ? urlParts[2] : null;</span>
<a name="l01702"></a>01702 <span class="stringliteral">        data.cc = urlParts[3];</span>
<a name="l01703"></a>01703 <span class="stringliteral">        data.bcc = urlParts[4];</span>
<a name="l01704"></a>01704 <span class="stringliteral">        data.attachmentBlobs = sourceData.blobs;</span>
<a name="l01705"></a>01705 <span class="stringliteral">        data.attachmentNames = sourceData.filenames;</span>
<a name="l01706"></a>01706 <span class="stringliteral">      }</span>
<a name="l01707"></a>01707 <span class="stringliteral"></span>
<a name="l01708"></a>01708 <span class="stringliteral">      this.emitWhenListener(&#39;activity&#39;, activityName, data, req);</span>
<a name="l01709"></a>01709 <span class="stringliteral">    },</span>
<a name="l01710"></a>01710 <span class="stringliteral"></span>
<a name="l01711"></a>01711 <span class="stringliteral">    onNotification: function(msg) {</span>
<a name="l01712"></a>01712 <span class="stringliteral">      // Skip notification events that are not from a notification</span>
<a name="l01713"></a>01713 <span class="stringliteral">      // &quot;</span>click<span class="stringliteral">&quot;. The system app will also notify this method of</span>
<a name="l01714"></a>01714 <span class="stringliteral">      // any close events for notificaitons, which are not at all</span>
<a name="l01715"></a>01715 <span class="stringliteral">      // interesting, at least for the purposes here.</span>
<a name="l01716"></a>01716 <span class="stringliteral">      if (!msg.clicked)</span>
<a name="l01717"></a>01717 <span class="stringliteral">        return;</span>
<a name="l01718"></a>01718 <span class="stringliteral"></span>
<a name="l01719"></a>01719 <span class="stringliteral">      // icon url parsing is a cray cray way to pass day day</span>
<a name="l01720"></a>01720 <span class="stringliteral">      var data = queryString.toObject((msg.imageURL || &#39;&#39;).split(&#39;#&#39;)[1]);</span>
<a name="l01721"></a>01721 <span class="stringliteral"></span>
<a name="l01722"></a>01722 <span class="stringliteral">      if (document.hidden) {</span>
<a name="l01723"></a>01723 <span class="stringliteral">        appSelf.latest(&#39;self&#39;, function(app) {</span>
<a name="l01724"></a>01724 <span class="stringliteral">          app.launch();</span>
<a name="l01725"></a>01725 <span class="stringliteral">        });</span>
<a name="l01726"></a>01726 <span class="stringliteral">      }</span>
<a name="l01727"></a>01727 <span class="stringliteral"></span>
<a name="l01728"></a>01728 <span class="stringliteral">      this.emitWhenListener(&#39;notification&#39;, data);</span>
<a name="l01729"></a>01729 <span class="stringliteral">    }</span>
<a name="l01730"></a>01730 <span class="stringliteral">  });</span>
<a name="l01731"></a>01731 <span class="stringliteral"></span>
<a name="l01732"></a>01732 <span class="stringliteral">  if (&#39;mozSetMessageHandler&#39; in navigator) {</span>
<a name="l01733"></a>01733 <span class="stringliteral">    navigator.mozSetMessageHandler(</span>
<a name="l01734"></a>01734 <span class="stringliteral">        &#39;activity&#39;, appMessages.onActivityRequest.bind(appMessages));</span>
<a name="l01735"></a>01735 <span class="stringliteral">    navigator.mozSetMessageHandler(</span>
<a name="l01736"></a>01736 <span class="stringliteral">        &#39;notification&#39;, appMessages.onNotification.bind(appMessages));</span>
<a name="l01737"></a>01737 <span class="stringliteral">    evt.on(</span>
<a name="l01738"></a>01738 <span class="stringliteral">        &#39;notification&#39;, appMessages.onNotification.bind(appMessages));</span>
<a name="l01739"></a>01739 <span class="stringliteral"></span>
<a name="l01740"></a>01740 <span class="stringliteral">    // Do not listen for navigator.mozSetMessageHandler(&#39;alarm&#39;) type, that is</span>
<a name="l01741"></a>01741 <span class="stringliteral">    // only done in the back end&#39;s cronsync for now.</span>
<a name="l01742"></a>01742 <span class="stringliteral">  } else {</span>
<a name="l01743"></a>01743 <span class="stringliteral">    console.warn(&#39;Activity support disabled!&#39;);</span>
<a name="l01744"></a>01744 <span class="stringliteral">  }</span>
<a name="l01745"></a>01745 <span class="stringliteral"></span>
<a name="l01746"></a>01746 <span class="stringliteral">  return appMessages;</span>
<a name="l01747"></a>01747 <span class="stringliteral">});</span>
<a name="l01748"></a>01748 <span class="stringliteral"></span>
<a name="l01749"></a>01749 <span class="stringliteral">/*global document, console, setTimeout, define: true */</span>
<a name="l01750"></a>01750 <span class="stringliteral"></span>
<a name="l01751"></a>01751 <span class="stringliteral">define(&#39;html_cache&#39;,[&#39;require&#39;,&#39;exports&#39;,&#39;module&#39;],function(require, exports) {</span>
<a name="l01752"></a>01752 <span class="stringliteral"></span>
<a name="l01758"></a>01758 <span class="stringliteral">var CACHE_VERSION = &#39;828c1204670f02805458d1d964fe015475fcb221&#39;;</span>
<a name="l01759"></a>01759 <span class="stringliteral"></span>
<a name="l01765"></a>01765 <span class="stringliteral">exports.save = function htmlCacheSave(html) {</span>
<a name="l01766"></a>01766 <span class="stringliteral">  html = encodeURIComponent(CACHE_VERSION + &#39;:&#39; + html);</span>
<a name="l01767"></a>01767 <span class="stringliteral"></span>
<a name="l01768"></a>01768 <span class="stringliteral">  // Set to 20 years from now.</span>
<a name="l01769"></a>01769 <span class="stringliteral">  var expiry = Date.now() + (20 * 365 * 24 * 60 * 60 * 1000);</span>
<a name="l01770"></a>01770 <span class="stringliteral">  expiry = (new Date(expiry)).toUTCString();</span>
<a name="l01771"></a>01771 <span class="stringliteral"></span>
<a name="l01772"></a>01772 <span class="stringliteral">  // Split string into segments.</span>
<a name="l01773"></a>01773 <span class="stringliteral">  var index = 0;</span>
<a name="l01774"></a>01774 <span class="stringliteral">  var endPoint = 0;</span>
<a name="l01775"></a>01775 <span class="stringliteral">  var length = html.length;</span>
<a name="l01776"></a>01776 <span class="stringliteral"></span>
<a name="l01777"></a>01777 <span class="stringliteral">  for (var i = 0; i &lt; length; i = endPoint, index += 1) {</span>
<a name="l01778"></a>01778 <span class="stringliteral">    // Max per-cookie length is around 4097 bytes for firefox.</span>
<a name="l01779"></a>01779 <span class="stringliteral">    // Give some space for key and allow i18n chars, which may</span>
<a name="l01780"></a>01780 <span class="stringliteral">    // take two bytes, end up with 2030. This page used</span>
<a name="l01781"></a>01781 <span class="stringliteral">    // to test cookie limits: http://browsercookielimits.x64.me/</span>
<a name="l01782"></a>01782 <span class="stringliteral">    endPoint = 2030 + i;</span>
<a name="l01783"></a>01783 <span class="stringliteral">    if (endPoint &gt; length) {</span>
<a name="l01784"></a>01784 <span class="stringliteral">      endPoint = length;</span>
<a name="l01785"></a>01785 <span class="stringliteral">    }</span>
<a name="l01786"></a>01786 <span class="stringliteral"></span>
<a name="l01787"></a>01787 <span class="stringliteral">    document.cookie = &#39;htmlc&#39; + index + &#39;=&#39; + html.substring(i, endPoint) +</span>
<a name="l01788"></a>01788 <span class="stringliteral">                      &#39;; expires=&#39; + expiry;</span>
<a name="l01789"></a>01789 <span class="stringliteral">  }</span>
<a name="l01790"></a>01790 <span class="stringliteral"></span>
<a name="l01791"></a>01791 <span class="stringliteral">  // If previous cookie was bigger, clear out the other values,</span>
<a name="l01792"></a>01792 <span class="stringliteral">  // to make sure they do not interfere later when reading and</span>
<a name="l01793"></a>01793 <span class="stringliteral">  // reassembling. If the cache saved is too big, just clear it as</span>
<a name="l01794"></a>01794 <span class="stringliteral">  // there will likely be cache corruption/partial, bad HTML saved</span>
<a name="l01795"></a>01795 <span class="stringliteral">  // otherwise.</span>
<a name="l01796"></a>01796 <span class="stringliteral">  var maxSegment = 40;</span>
<a name="l01797"></a>01797 <span class="stringliteral">  if (index &gt; 39) {</span>
<a name="l01798"></a>01798 <span class="stringliteral">    index = 0;</span>
<a name="l01799"></a>01799 <span class="stringliteral">    console.log(&#39;htmlCache.save TOO BIG. Removing all of it.&#39;);</span>
<a name="l01800"></a>01800 <span class="stringliteral">  }</span>
<a name="l01801"></a>01801 <span class="stringliteral">  for (i = index; i &lt; maxSegment; i++) {</span>
<a name="l01802"></a>01802 <span class="stringliteral">    document.cookie = &#39;htmlc&#39; + i + &#39;=; expires=&#39; + expiry;</span>
<a name="l01803"></a>01803 <span class="stringliteral">  }</span>
<a name="l01804"></a>01804 <span class="stringliteral"></span>
<a name="l01805"></a>01805 <span class="stringliteral">  console.log(&#39;htmlCache.save: &#39; + html.length + &#39; in &#39; +</span>
<a name="l01806"></a>01806 <span class="stringliteral">              (index) + &#39; segments&#39;);</span>
<a name="l01807"></a>01807 <span class="stringliteral">};</span>
<a name="l01808"></a>01808 <span class="stringliteral"></span>
<a name="l01815"></a>01815 <span class="stringliteral">exports.saveFromNode = function saveFromNode(node) {</span>
<a name="l01816"></a>01816 <span class="stringliteral">  // Make sure card will be visible in center of window. For example,</span>
<a name="l01817"></a>01817 <span class="stringliteral">  // if user clicks on &quot;</span><a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a86efbc42dbdb988b9a864b83af26e0de">search</a><span class="stringliteral">&quot; or some other card is showing when</span>
<a name="l01818"></a>01818 <span class="stringliteral">  // message list&#39;s atTop is received, then the node could be</span>
<a name="l01819"></a>01819 <span class="stringliteral">  // off-screen when it is passed to this function.</span>
<a name="l01820"></a>01820 <span class="stringliteral">  var cl = node.classList;</span>
<a name="l01821"></a>01821 <span class="stringliteral">  cl.remove(&#39;before&#39;);</span>
<a name="l01822"></a>01822 <span class="stringliteral">  cl.remove(&#39;after&#39;);</span>
<a name="l01823"></a>01823 <span class="stringliteral">  cl.add(&#39;center&#39;);</span>
<a name="l01824"></a>01824 <span class="stringliteral"></span>
<a name="l01825"></a>01825 <span class="stringliteral">  var html = node.outerHTML;</span>
<a name="l01826"></a>01826 <span class="stringliteral">  exports.save(html);</span>
<a name="l01827"></a>01827 <span class="stringliteral">};</span>
<a name="l01828"></a>01828 <span class="stringliteral"></span>
<a name="l01832"></a>01832 <span class="stringliteral">var delayedSaveId = 0;</span>
<a name="l01833"></a>01833 <span class="stringliteral"></span>
<a name="l01837"></a>01837 <span class="stringliteral">var delayedNode = &#39;&#39;;</span>
<a name="l01838"></a>01838 <span class="stringliteral"></span>
<a name="l01845"></a>01845 <span class="stringliteral">exports.delayedSaveFromNode = function delayedSaveFromNode(node) {</span>
<a name="l01846"></a>01846 <span class="stringliteral">  delayedNode = node;</span>
<a name="l01847"></a>01847 <span class="stringliteral">  if (!delayedSaveId) {</span>
<a name="l01848"></a>01848 <span class="stringliteral">    delayedSaveId = setTimeout(function() {</span>
<a name="l01849"></a>01849 <span class="stringliteral">      delayedSaveId = 0;</span>
<a name="l01850"></a>01850 <span class="stringliteral">      exports.saveFromNode(delayedNode);</span>
<a name="l01851"></a>01851 <span class="stringliteral">      delayedNode = null;</span>
<a name="l01852"></a>01852 <span class="stringliteral">    }, 500);</span>
<a name="l01853"></a>01853 <span class="stringliteral">  }</span>
<a name="l01854"></a>01854 <span class="stringliteral">};</span>
<a name="l01855"></a>01855 <span class="stringliteral"></span>
<a name="l01856"></a>01856 <span class="stringliteral">});</span>
<a name="l01857"></a>01857 <span class="stringliteral"></span>
<a name="l01858"></a>01858 <span class="stringliteral">define(&#39;l10n&#39;,{</span>
<a name="l01859"></a>01859 <span class="stringliteral">  load: function(id, require, onload, config) {</span>
<a name="l01860"></a>01860 <span class="stringliteral">    if (config.isBuild)</span>
<a name="l01861"></a>01861 <span class="stringliteral">      return onload();</span>
<a name="l01862"></a>01862 <span class="stringliteral"></span>
<a name="l01863"></a>01863 <span class="stringliteral">    require([&#39;l10nbase&#39;, &#39;l10ndate&#39;], function() {</span>
<a name="l01864"></a>01864 <span class="stringliteral">      if (navigator.mozL10n.readyState === &#39;complete&#39;) {</span>
<a name="l01865"></a>01865 <span class="stringliteral">        onload(navigator.mozL10n);</span>
<a name="l01866"></a>01866 <span class="stringliteral">      } else {</span>
<a name="l01867"></a>01867 <span class="stringliteral">        navigator.mozL10n.ready(function() {</span>
<a name="l01868"></a>01868 <span class="stringliteral">          onload(navigator.mozL10n);</span>
<a name="l01869"></a>01869 <span class="stringliteral">        });</span>
<a name="l01870"></a>01870 <span class="stringliteral">      }</span>
<a name="l01871"></a>01871 <span class="stringliteral">    });</span>
<a name="l01872"></a>01872 <span class="stringliteral">  }</span>
<a name="l01873"></a>01873 <span class="stringliteral">});</span>
<a name="l01874"></a>01874 <span class="stringliteral"></span>
<a name="l01875"></a>01875 <span class="stringliteral">define(&#39;tmpl&#39;,[&#39;l10n!&#39;], function(mozL10n) {</span>
<a name="l01876"></a>01876 <span class="stringliteral">  var tmpl = {</span>
<a name="l01877"></a>01877 <span class="stringliteral">    pluginBuilder: &#39;./tmpl_builder&#39;,</span>
<a name="l01878"></a>01878 <span class="stringliteral"></span>
<a name="l01879"></a>01879 <span class="stringliteral">    toDom: function(text) {</span>
<a name="l01880"></a>01880 <span class="stringliteral">        var temp = document.createElement(&#39;div&#39;);</span>
<a name="l01881"></a>01881 <span class="stringliteral">        temp.innerHTML = text;</span>
<a name="l01882"></a>01882 <span class="stringliteral">        var node = temp.children[0];</span>
<a name="l01883"></a>01883 <span class="stringliteral">        mozL10n.translate(node);</span>
<a name="l01884"></a>01884 <span class="stringliteral">        return node;</span>
<a name="l01885"></a>01885 <span class="stringliteral">    },</span>
<a name="l01886"></a>01886 <span class="stringliteral"></span>
<a name="l01887"></a>01887 <span class="stringliteral">    load: function(id, require, onload, config) {</span>
<a name="l01888"></a>01888 <span class="stringliteral">      require([&#39;text!&#39; + id], function(text) {</span>
<a name="l01889"></a>01889 <span class="stringliteral">        onload(tmpl.toDom(text));</span>
<a name="l01890"></a>01890 <span class="stringliteral">      });</span>
<a name="l01891"></a>01891 <span class="stringliteral">    }</span>
<a name="l01892"></a>01892 <span class="stringliteral">  };</span>
<a name="l01893"></a>01893 <span class="stringliteral"></span>
<a name="l01894"></a>01894 <span class="stringliteral">  return tmpl;</span>
<a name="l01895"></a>01895 <span class="stringliteral">});</span>
<a name="l01896"></a>01896 <span class="stringliteral"></span>
<a name="l01897"></a>01897 <span class="stringliteral">define(&#39;tmpl!cards/toaster.html&#39;,[&#39;tmpl&#39;], function (tmpl) { return tmpl.toDom(&#39;&lt;section role=&quot;</span><a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a><span class="stringliteral">&quot; class=&quot;</span>banner customized collapsed<span class="stringliteral">&quot;&gt;\n  &lt;button class=&quot;</span>toaster-<a class="code" href="../../dc/d35/inline-receiver_8js.html#a01de14b323a40639980004403daa8432">cancel</a>-btn <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>-<a class="code" href="../../d3/d91/j3d_8js.html#a47b6aed05bc344861b52fe3ffb7a1edd">left</a>-btn<span class="stringliteral">&quot;&gt;\n    &lt;span class=&quot;</span>icon icon-<a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a><span class="stringliteral">&quot;&gt;&lt;/span&gt;\n  &lt;/button&gt;\n  &lt;p&gt;Toaster Title&lt;/p&gt;\n  &lt;button data-l10n-id=&quot;</span>toaster-undo<span class="stringliteral">&quot; class=&quot;</span>toaster-banner-undo<span class="stringliteral">&quot;&gt;&lt;/button&gt;\n  &lt;button data-l10n-id=&quot;</span>toaster-retry<span class="stringliteral">&quot; class=&quot;</span>toaster-banner-retry<span class="stringliteral">&quot;&gt;&lt;/button&gt;\n&lt;/section&gt;&#39;); });</span>
<a name="l01898"></a>01898 <span class="stringliteral"></span>
<a name="l01899"></a>01899 <span class="stringliteral">/*global define */</span>
<a name="l01900"></a>01900 <span class="stringliteral">define(&#39;folder_depth_classes&#39;,[],function() {</span>
<a name="l01901"></a>01901 <span class="stringliteral"></span>
<a name="l01902"></a>01902 <span class="stringliteral">return [</span>
<a name="l01903"></a>01903 <span class="stringliteral">  &#39;fld-folder-depth0&#39;,</span>
<a name="l01904"></a>01904 <span class="stringliteral">  &#39;fld-folder-depth1&#39;,</span>
<a name="l01905"></a>01905 <span class="stringliteral">  &#39;fld-folder-depth2&#39;,</span>
<a name="l01906"></a>01906 <span class="stringliteral">  &#39;fld-folder-depth3&#39;,</span>
<a name="l01907"></a>01907 <span class="stringliteral">  &#39;fld-folder-depth4&#39;,</span>
<a name="l01908"></a>01908 <span class="stringliteral">  &#39;fld-folder-depth5&#39;,</span>
<a name="l01909"></a>01909 <span class="stringliteral">  &#39;fld-folder-depthmax&#39;</span>
<a name="l01910"></a>01910 <span class="stringliteral">];</span>
<a name="l01911"></a>01911 <span class="stringliteral"></span>
<a name="l01912"></a>01912 <span class="stringliteral">});</span>
<a name="l01913"></a>01913 <span class="stringliteral"></span>
<a name="l01914"></a>01914 <span class="stringliteral">/*</span>
<a name="l01915"></a>01915 <span class="stringliteral">!! Warning !!</span>
<a name="l01916"></a>01916 <span class="stringliteral">  This value selector is modified for email folder selection only.</span>
<a name="l01917"></a>01917 <span class="stringliteral">  API and layout are changed because of the sub-folder indentation display.</span>
<a name="l01918"></a>01918 <span class="stringliteral">  Please reference the original version selector in contact app before using.</span>
<a name="l01919"></a>01919 <span class="stringliteral"></span>
<a name="l01920"></a>01920 <span class="stringliteral">How to:</span>
<a name="l01921"></a>01921 <span class="stringliteral">  var prompt1 = new ValueSelector(&#39;Dummy title 1&#39;, [</span>
<a name="l01922"></a>01922 <span class="stringliteral">    {</span>
<a name="l01923"></a>01923 <span class="stringliteral">      label: &#39;Dummy element&#39;,</span>
<a name="l01924"></a>01924 <span class="stringliteral">      callback: function() {</span>
<a name="l01925"></a>01925 <span class="stringliteral">        alert(&#39;Define an action here!&#39;);</span>
<a name="l01926"></a>01926 <span class="stringliteral">      }</span>
<a name="l01927"></a>01927 <span class="stringliteral">    }</span>
<a name="l01928"></a>01928 <span class="stringliteral">  ]);</span>
<a name="l01929"></a>01929 <span class="stringliteral"></span>
<a name="l01930"></a>01930 <span class="stringliteral">  prompt1.addToList(&#39;Another button&#39;, function(){alert(&#39;Another action&#39;);});</span>
<a name="l01931"></a>01931 <span class="stringliteral">  prompt1.show();</span>
<a name="l01932"></a>01932 <span class="stringliteral">*/</span>
<a name="l01933"></a>01933 <span class="stringliteral">/*jshint browser: true */</span>
<a name="l01934"></a>01934 <span class="stringliteral">/*global alert, define */</span>
<a name="l01935"></a>01935 <span class="stringliteral">define(&#39;value_selector&#39;,[&#39;require&#39;,&#39;folder_depth_classes&#39;,&#39;l10n!&#39;],function(require) {</span>
<a name="l01936"></a>01936 <span class="stringliteral"></span>
<a name="l01937"></a>01937 <span class="stringliteral">var FOLDER_DEPTH_CLASSES = require(&#39;folder_depth_classes&#39;),</span>
<a name="l01938"></a>01938 <span class="stringliteral">    mozL10n = require(&#39;l10n!&#39;);</span>
<a name="l01939"></a>01939 <span class="stringliteral"></span>
<a name="l01940"></a>01940 <span class="stringliteral">function ValueSelector(title, list) {</span>
<a name="l01941"></a>01941 <span class="stringliteral">  var init, show, hide, render, setTitle, emptyList, addToList,</span>
<a name="l01942"></a>01942 <span class="stringliteral">      data, el;</span>
<a name="l01943"></a>01943 <span class="stringliteral"></span>
<a name="l01944"></a>01944 <span class="stringliteral">  init = function() {</span>
<a name="l01945"></a>01945 <span class="stringliteral">    var strPopup, body, section, btnCancel, cancelStr;</span>
<a name="l01946"></a>01946 <span class="stringliteral"></span>
<a name="l01947"></a>01947 <span class="stringliteral">    // Model. By having dummy data in the model,</span>
<a name="l01948"></a>01948 <span class="stringliteral">    // it make it easier for othe developers to catch up to speed</span>
<a name="l01949"></a>01949 <span class="stringliteral">    data = {</span>
<a name="l01950"></a>01950 <span class="stringliteral">      title: &#39;No Title&#39;,</span>
<a name="l01951"></a>01951 <span class="stringliteral">      list: [</span>
<a name="l01952"></a>01952 <span class="stringliteral">        {</span>
<a name="l01953"></a>01953 <span class="stringliteral">          label: &#39;Dummy element&#39;,</span>
<a name="l01954"></a>01954 <span class="stringliteral">          callback: function() {</span>
<a name="l01955"></a>01955 <span class="stringliteral">            alert(&#39;Define an action here!&#39;);</span>
<a name="l01956"></a>01956 <span class="stringliteral">          }</span>
<a name="l01957"></a>01957 <span class="stringliteral">        }</span>
<a name="l01958"></a>01958 <span class="stringliteral">      ]</span>
<a name="l01959"></a>01959 <span class="stringliteral">    };</span>
<a name="l01960"></a>01960 <span class="stringliteral"></span>
<a name="l01961"></a>01961 <span class="stringliteral">    body = document.body;</span>
<a name="l01962"></a>01962 <span class="stringliteral">    cancelStr = mozL10n.get(&#39;message-multiedit-cancel&#39;);</span>
<a name="l01963"></a>01963 <span class="stringliteral"></span>
<a name="l01964"></a>01964 <span class="stringliteral">    el = document.createElement(&#39;section&#39;);</span>
<a name="l01965"></a>01965 <span class="stringliteral">    el.setAttribute(&#39;class&#39;, &#39;valueselector&#39;);</span>
<a name="l01966"></a>01966 <span class="stringliteral">    el.setAttribute(&#39;role&#39;, &#39;region&#39;);</span>
<a name="l01967"></a>01967 <span class="stringliteral"></span>
<a name="l01968"></a>01968 <span class="stringliteral">    strPopup = &#39;&lt;div role=&quot;</span><a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a><span class="stringliteral">&quot;&gt;&#39;;</span>
<a name="l01969"></a>01969 <span class="stringliteral">    strPopup += &#39;  &lt;div class=&quot;</span>center<span class="stringliteral">&quot;&gt;&#39;;</span>
<a name="l01970"></a>01970 <span class="stringliteral">    strPopup += &#39;    &lt;h3&gt;No Title&lt;/h3&gt;&#39;;</span>
<a name="l01971"></a>01971 <span class="stringliteral">    strPopup += &#39;    &lt;ul&gt;&#39;;</span>
<a name="l01972"></a>01972 <span class="stringliteral">    strPopup += &#39;      &lt;li&gt;&#39;;</span>
<a name="l01973"></a>01973 <span class="stringliteral">    strPopup += &#39;        &lt;label class=&quot;</span>pack-radio<span class="stringliteral">&quot;&gt;&#39;;</span>
<a name="l01974"></a>01974 <span class="stringliteral">    strPopup += &#39;          &lt;input type=&quot;</span>radio<span class="stringliteral">&quot; name=&quot;</span>option<span class="stringliteral">&quot;&gt;&#39;;</span>
<a name="l01975"></a>01975 <span class="stringliteral">    strPopup += &#39;          &lt;span&gt;Dummy element&lt;/span&gt;&#39;;</span>
<a name="l01976"></a>01976 <span class="stringliteral">    strPopup += &#39;        &lt;/label&gt;&#39;;</span>
<a name="l01977"></a>01977 <span class="stringliteral">    strPopup += &#39;      &lt;/li&gt;&#39;;</span>
<a name="l01978"></a>01978 <span class="stringliteral">    strPopup += &#39;    &lt;/ul&gt;&#39;;</span>
<a name="l01979"></a>01979 <span class="stringliteral">    strPopup += &#39;  &lt;/div&gt;&#39;;</span>
<a name="l01980"></a>01980 <span class="stringliteral">    strPopup += &#39;  &lt;menu&gt;&#39;;</span>
<a name="l01981"></a>01981 <span class="stringliteral">    strPopup += &#39;    &lt;button&gt;&#39; + cancelStr + &#39;&lt;/button&gt;&#39;;</span>
<a name="l01982"></a>01982 <span class="stringliteral">    strPopup += &#39;  &lt;/menu&gt;&#39;;</span>
<a name="l01983"></a>01983 <span class="stringliteral">    strPopup += &#39;&lt;/div&gt;&#39;;</span>
<a name="l01984"></a>01984 <span class="stringliteral"></span>
<a name="l01985"></a>01985 <span class="stringliteral">    el.innerHTML += strPopup;</span>
<a name="l01986"></a>01986 <span class="stringliteral">    body.appendChild(el);</span>
<a name="l01987"></a>01987 <span class="stringliteral"></span>
<a name="l01988"></a>01988 <span class="stringliteral">    btnCancel = el.querySelector(&#39;button&#39;);</span>
<a name="l01989"></a>01989 <span class="stringliteral">    btnCancel.addEventListener(&#39;click&#39;, function() {</span>
<a name="l01990"></a>01990 <span class="stringliteral">      hide();</span>
<a name="l01991"></a>01991 <span class="stringliteral">    });</span>
<a name="l01992"></a>01992 <span class="stringliteral"></span>
<a name="l01993"></a>01993 <span class="stringliteral">    // Empty dummy data</span>
<a name="l01994"></a>01994 <span class="stringliteral">    emptyList();</span>
<a name="l01995"></a>01995 <span class="stringliteral"></span>
<a name="l01996"></a>01996 <span class="stringliteral">    // Apply optional actions while initializing</span>
<a name="l01997"></a>01997 <span class="stringliteral">    if (typeof title === &#39;string&#39;) {</span>
<a name="l01998"></a>01998 <span class="stringliteral">      setTitle(title);</span>
<a name="l01999"></a>01999 <span class="stringliteral">    }</span>
<a name="l02000"></a>02000 <span class="stringliteral"></span>
<a name="l02001"></a>02001 <span class="stringliteral">    if (Array.isArray(list)) {</span>
<a name="l02002"></a>02002 <span class="stringliteral">      data.list = list;</span>
<a name="l02003"></a>02003 <span class="stringliteral">    }</span>
<a name="l02004"></a>02004 <span class="stringliteral">  };</span>
<a name="l02005"></a>02005 <span class="stringliteral"></span>
<a name="l02006"></a>02006 <span class="stringliteral">  show = function() {</span>
<a name="l02007"></a>02007 <span class="stringliteral">    render();</span>
<a name="l02008"></a>02008 <span class="stringliteral">    el.classList.add(&#39;visible&#39;);</span>
<a name="l02009"></a>02009 <span class="stringliteral">  };</span>
<a name="l02010"></a>02010 <span class="stringliteral"></span>
<a name="l02011"></a>02011 <span class="stringliteral">  hide = function() {</span>
<a name="l02012"></a>02012 <span class="stringliteral">    el.classList.remove(&#39;visible&#39;);</span>
<a name="l02013"></a>02013 <span class="stringliteral">    emptyList();</span>
<a name="l02014"></a>02014 <span class="stringliteral">  };</span>
<a name="l02015"></a>02015 <span class="stringliteral"></span>
<a name="l02016"></a>02016 <span class="stringliteral">  render = function() {</span>
<a name="l02017"></a>02017 <span class="stringliteral">    var title = el.querySelector(&#39;h3&#39;),</span>
<a name="l02018"></a>02018 <span class="stringliteral">        list = el.querySelector(&#39;ul&#39;);</span>
<a name="l02019"></a>02019 <span class="stringliteral"></span>
<a name="l02020"></a>02020 <span class="stringliteral">    title.textContent = data.title;</span>
<a name="l02021"></a>02021 <span class="stringliteral"></span>
<a name="l02022"></a>02022 <span class="stringliteral">    list.innerHTML = &#39;&#39;;</span>
<a name="l02023"></a>02023 <span class="stringliteral">    for (var i = 0; i &lt; data.list.length; i++) {</span>
<a name="l02024"></a>02024 <span class="stringliteral">      var li = document.createElement(&#39;li&#39;),</span>
<a name="l02025"></a>02025 <span class="stringliteral">          label = document.createElement(&#39;label&#39;),</span>
<a name="l02026"></a>02026 <span class="stringliteral">          input = document.createElement(&#39;input&#39;),</span>
<a name="l02027"></a>02027 <span class="stringliteral">          span = document.createElement(&#39;span&#39;),</span>
<a name="l02028"></a>02028 <span class="stringliteral">          text = document.createTextNode(data.list[i].label);</span>
<a name="l02029"></a>02029 <span class="stringliteral"></span>
<a name="l02030"></a>02030 <span class="stringliteral">      input.setAttribute(&#39;type&#39;, &#39;radio&#39;);</span>
<a name="l02031"></a>02031 <span class="stringliteral">      input.setAttribute(&#39;name&#39;, &#39;option&#39;);</span>
<a name="l02032"></a>02032 <span class="stringliteral">      label.classList.add(&#39;pack-radio&#39;);</span>
<a name="l02033"></a>02033 <span class="stringliteral">      label.appendChild(input);</span>
<a name="l02034"></a>02034 <span class="stringliteral">      label.appendChild(span);</span>
<a name="l02035"></a>02035 <span class="stringliteral">      label.appendChild(text);</span>
<a name="l02036"></a>02036 <span class="stringliteral">      // Here we apply the folder-card&#39;s depth indentation to represent label.</span>
<a name="l02037"></a>02037 <span class="stringliteral">      var depthIdx = data.list[i].depth;</span>
<a name="l02038"></a>02038 <span class="stringliteral">      depthIdx = Math.min(FOLDER_DEPTH_CLASSES.length - 1, depthIdx);</span>
<a name="l02039"></a>02039 <span class="stringliteral">      label.classList.add(FOLDER_DEPTH_CLASSES[depthIdx]);</span>
<a name="l02040"></a>02040 <span class="stringliteral">      li.addEventListener(&#39;click&#39;, data.list[i].callback, false);</span>
<a name="l02041"></a>02041 <span class="stringliteral">      li.appendChild(label);</span>
<a name="l02042"></a>02042 <span class="stringliteral">      list.appendChild(li);</span>
<a name="l02043"></a>02043 <span class="stringliteral">    }</span>
<a name="l02044"></a>02044 <span class="stringliteral">  };</span>
<a name="l02045"></a>02045 <span class="stringliteral"></span>
<a name="l02046"></a>02046 <span class="stringliteral">  setTitle = function(str) {</span>
<a name="l02047"></a>02047 <span class="stringliteral">    data.title = str;</span>
<a name="l02048"></a>02048 <span class="stringliteral">  };</span>
<a name="l02049"></a>02049 <span class="stringliteral"></span>
<a name="l02050"></a>02050 <span class="stringliteral">  emptyList = function() {</span>
<a name="l02051"></a>02051 <span class="stringliteral">    data.list = [];</span>
<a name="l02052"></a>02052 <span class="stringliteral">  };</span>
<a name="l02053"></a>02053 <span class="stringliteral"></span>
<a name="l02054"></a>02054 <span class="stringliteral">  addToList = function(label, depth, callback) {</span>
<a name="l02055"></a>02055 <span class="stringliteral">    data.list.push({</span>
<a name="l02056"></a>02056 <span class="stringliteral">      label: label,</span>
<a name="l02057"></a>02057 <span class="stringliteral">      depth: depth,</span>
<a name="l02058"></a>02058 <span class="stringliteral">      callback: callback</span>
<a name="l02059"></a>02059 <span class="stringliteral">    });</span>
<a name="l02060"></a>02060 <span class="stringliteral">  };</span>
<a name="l02061"></a>02061 <span class="stringliteral"></span>
<a name="l02062"></a>02062 <span class="stringliteral">  init();</span>
<a name="l02063"></a>02063 <span class="stringliteral"></span>
<a name="l02064"></a>02064 <span class="stringliteral">  return{</span>
<a name="l02065"></a>02065 <span class="stringliteral">    init: init,</span>
<a name="l02066"></a>02066 <span class="stringliteral">    show: show,</span>
<a name="l02067"></a>02067 <span class="stringliteral">    hide: hide,</span>
<a name="l02068"></a>02068 <span class="stringliteral">    setTitle: setTitle,</span>
<a name="l02069"></a>02069 <span class="stringliteral">    addToList: addToList,</span>
<a name="l02070"></a>02070 <span class="stringliteral">    List: list</span>
<a name="l02071"></a>02071 <span class="stringliteral">  };</span>
<a name="l02072"></a>02072 <span class="stringliteral">}</span>
<a name="l02073"></a>02073 <span class="stringliteral"></span>
<a name="l02074"></a>02074 <span class="stringliteral">return ValueSelector;</span>
<a name="l02075"></a>02075 <span class="stringliteral"></span>
<a name="l02076"></a>02076 <span class="stringliteral">});</span>
<a name="l02077"></a>02077 <span class="stringliteral"></span>
<a name="l02078"></a>02078 <span class="stringliteral">/*</span>
<a name="l02079"></a>02079 <span class="stringliteral"> * This file goes along with shared/style/input_areas.css</span>
<a name="l02080"></a>02080 <span class="stringliteral"> * and is required to make the &lt;button type=&quot;</span><a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a><span class="stringliteral">&quot;&gt; buttons work to clear</span>
<a name="l02081"></a>02081 <span class="stringliteral"> * the form fields they are associated with.</span>
<a name="l02082"></a>02082 <span class="stringliteral"> *</span>
<a name="l02083"></a>02083 <span class="stringliteral"> * Bug 830127 should fix input_areas.css and move this JS functionality</span>
<a name="l02084"></a>02084 <span class="stringliteral"> * to a shared JS file, so this file won&#39;t be in the email app for long.</span>
<a name="l02085"></a>02085 <span class="stringliteral"> */</span>
<a name="l02086"></a>02086 <span class="stringliteral">define(&#39;input_areas&#39;,[&#39;require&#39;,&#39;exports&#39;,&#39;module&#39;],function(require, exports) {</span>
<a name="l02087"></a>02087 <span class="stringliteral">  return function hookupInputAreaResetButtons(e) {</span>
<a name="l02088"></a>02088 <span class="stringliteral">    // This selector is from shared/style/input_areas.css</span>
<a name="l02089"></a>02089 <span class="stringliteral">    var selector = &#39;form p input + button[type=&quot;</span><a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a><span class="stringliteral">&quot;],&#39; +</span>
<a name="l02090"></a>02090 <span class="stringliteral">          &#39;form p textarea + button[type=&quot;</span><a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a><span class="stringliteral">&quot;]&#39;;</span>
<a name="l02091"></a>02091 <span class="stringliteral">    var resetButtons = e.querySelectorAll(selector);</span>
<a name="l02092"></a>02092 <span class="stringliteral">    for (var i = 0, n = resetButtons.length; i &lt; n; i++) {</span>
<a name="l02093"></a>02093 <span class="stringliteral">      resetButtons[i].addEventListener(&#39;mousedown&#39;, function(e) {</span>
<a name="l02094"></a>02094 <span class="stringliteral">        e.preventDefault();   // Don&#39;t take focus from the input field</span>
<a name="l02095"></a>02095 <span class="stringliteral">      });</span>
<a name="l02096"></a>02096 <span class="stringliteral">      resetButtons[i].addEventListener(&#39;click&#39;, function(e) {</span>
<a name="l02097"></a>02097 <span class="stringliteral">        e.target.previousElementSibling.value = &#39;&#39;; // Clear input field</span>
<a name="l02098"></a>02098 <span class="stringliteral">        e.preventDefault();   // Don&#39;t reset the rest of the form.</span>
<a name="l02099"></a>02099 <span class="stringliteral">      });</span>
<a name="l02100"></a>02100 <span class="stringliteral">    }</span>
<a name="l02101"></a>02101 <span class="stringliteral">  };</span>
<a name="l02102"></a>02102 <span class="stringliteral">});</span>
<a name="l02103"></a>02103 <span class="stringliteral"></span>
<a name="l02107"></a>02107 <span class="stringliteral">/*jshint browser: true */</span>
<a name="l02108"></a>02108 <span class="stringliteral">/*global define, console, hookupInputAreaResetButtons */</span>
<a name="l02109"></a>02109 <span class="stringliteral">define(&#39;mail_common&#39;,[&#39;require&#39;,&#39;exports&#39;,&#39;module&#39;,&#39;l10n!&#39;,&#39;tmpl!./cards/toaster.html&#39;,&#39;value_selector&#39;,&#39;input_areas&#39;],function(require, exports) {</span>
<a name="l02110"></a>02110 <span class="stringliteral"></span>
<a name="l02111"></a>02111 <span class="stringliteral">var Cards, Toaster,</span>
<a name="l02112"></a>02112 <span class="stringliteral">    mozL10n = require(&#39;l10n!&#39;),</span>
<a name="l02113"></a>02113 <span class="stringliteral">    toasterNode = require(&#39;tmpl!./cards/toaster.html&#39;),</span>
<a name="l02114"></a>02114 <span class="stringliteral">    ValueSelector = require(&#39;value_selector&#39;);</span>
<a name="l02115"></a>02115 <span class="stringliteral"></span>
<a name="l02116"></a>02116 <span class="stringliteral">var hookupInputAreaResetButtons = require(&#39;input_areas&#39;);</span>
<a name="l02117"></a>02117 <span class="stringliteral"></span>
<a name="l02118"></a>02118 <span class="stringliteral">function addClass(domNode, name) {</span>
<a name="l02119"></a>02119 <span class="stringliteral">  if (domNode) {</span>
<a name="l02120"></a>02120 <span class="stringliteral">    domNode.classList.add(name);</span>
<a name="l02121"></a>02121 <span class="stringliteral">  }</span>
<a name="l02122"></a>02122 <span class="stringliteral">}</span>
<a name="l02123"></a>02123 <span class="stringliteral"></span>
<a name="l02124"></a>02124 <span class="stringliteral">function removeClass(domNode, name) {</span>
<a name="l02125"></a>02125 <span class="stringliteral">  if (domNode) {</span>
<a name="l02126"></a>02126 <span class="stringliteral">    domNode.classList.remove(name);</span>
<a name="l02127"></a>02127 <span class="stringliteral">  }</span>
<a name="l02128"></a>02128 <span class="stringliteral">}</span>
<a name="l02129"></a>02129 <span class="stringliteral"></span>
<a name="l02130"></a>02130 <span class="stringliteral">function batchAddClass(domNode, searchClass, classToAdd) {</span>
<a name="l02131"></a>02131 <span class="stringliteral">  var nodes = domNode.getElementsByClassName(searchClass);</span>
<a name="l02132"></a>02132 <span class="stringliteral">  for (var i = 0; i &lt; nodes.length; i++) {</span>
<a name="l02133"></a>02133 <span class="stringliteral">    nodes[i].classList.add(classToAdd);</span>
<a name="l02134"></a>02134 <span class="stringliteral">  }</span>
<a name="l02135"></a>02135 <span class="stringliteral">}</span>
<a name="l02136"></a>02136 <span class="stringliteral"></span>
<a name="l02137"></a>02137 <span class="stringliteral">function batchRemoveClass(domNode, searchClass, classToRemove) {</span>
<a name="l02138"></a>02138 <span class="stringliteral">  var nodes = domNode.getElementsByClassName(searchClass);</span>
<a name="l02139"></a>02139 <span class="stringliteral">  for (var i = 0; i &lt; nodes.length; i++) {</span>
<a name="l02140"></a>02140 <span class="stringliteral">    nodes[i].classList.remove(classToRemove);</span>
<a name="l02141"></a>02141 <span class="stringliteral">  }</span>
<a name="l02142"></a>02142 <span class="stringliteral">}</span>
<a name="l02143"></a>02143 <span class="stringliteral"></span>
<a name="l02144"></a>02144 <span class="stringliteral">var MATCHED_TEXT_CLASS = &#39;highlight&#39;;</span>
<a name="l02145"></a>02145 <span class="stringliteral"></span>
<a name="l02146"></a>02146 <span class="stringliteral">function appendMatchItemTo(matchItem, node) {</span>
<a name="l02147"></a>02147 <span class="stringliteral">  var text = matchItem.text;</span>
<a name="l02148"></a>02148 <span class="stringliteral">  var idx = 0;</span>
<a name="l02149"></a>02149 <span class="stringliteral">  for (var iRun = 0; iRun &lt;= matchItem.matchRuns.length; iRun++) {</span>
<a name="l02150"></a>02150 <span class="stringliteral">    var run;</span>
<a name="l02151"></a>02151 <span class="stringliteral">    if (iRun === matchItem.matchRuns.length)</span>
<a name="l02152"></a>02152 <span class="stringliteral">      run = { start: text.length, length: 0 };</span>
<a name="l02153"></a>02153 <span class="stringliteral">    else</span>
<a name="l02154"></a>02154 <span class="stringliteral">      run = matchItem.matchRuns[iRun];</span>
<a name="l02155"></a>02155 <span class="stringliteral"></span>
<a name="l02156"></a>02156 <span class="stringliteral">    // generate the un-highlighted span</span>
<a name="l02157"></a>02157 <span class="stringliteral">    if (run.start &gt; idx) {</span>
<a name="l02158"></a>02158 <span class="stringliteral">      var tnode = document.createTextNode(text.substring(idx, run.start));</span>
<a name="l02159"></a>02159 <span class="stringliteral">      node.appendChild(tnode);</span>
<a name="l02160"></a>02160 <span class="stringliteral">    }</span>
<a name="l02161"></a>02161 <span class="stringliteral"></span>
<a name="l02162"></a>02162 <span class="stringliteral">    if (!run.length)</span>
<a name="l02163"></a>02163 <span class="stringliteral">      continue;</span>
<a name="l02164"></a>02164 <span class="stringliteral">    var hspan = document.createElement(&#39;span&#39;);</span>
<a name="l02165"></a>02165 <span class="stringliteral">    hspan.classList.add(MATCHED_TEXT_CLASS);</span>
<a name="l02166"></a>02166 <span class="stringliteral">    hspan.textContent = text.substr(run.start, run.length);</span>
<a name="l02167"></a>02167 <span class="stringliteral">    node.appendChild(hspan);</span>
<a name="l02168"></a>02168 <span class="stringliteral">    idx = run.start + run.length;</span>
<a name="l02169"></a>02169 <span class="stringliteral">  }</span>
<a name="l02170"></a>02170 <span class="stringliteral">}</span>
<a name="l02171"></a>02171 <span class="stringliteral"></span>
<a name="l02177"></a>02177 <span class="stringliteral">function bindContainerHandler(containerNode, eventName, func) {</span>
<a name="l02178"></a>02178 <span class="stringliteral">  containerNode.addEventListener(eventName, function(event) {</span>
<a name="l02179"></a>02179 <span class="stringliteral">    var node = event.target;</span>
<a name="l02180"></a>02180 <span class="stringliteral">    // bail if they clicked on the container and not a child...</span>
<a name="l02181"></a>02181 <span class="stringliteral">    if (node === containerNode)</span>
<a name="l02182"></a>02182 <span class="stringliteral">      return;</span>
<a name="l02183"></a>02183 <span class="stringliteral">    while (node &amp;&amp; node.parentNode !== containerNode) {</span>
<a name="l02184"></a>02184 <span class="stringliteral">      node = node.parentNode;</span>
<a name="l02185"></a>02185 <span class="stringliteral">    }</span>
<a name="l02186"></a>02186 <span class="stringliteral">    func(node, event);</span>
<a name="l02187"></a>02187 <span class="stringliteral">  }, false);</span>
<a name="l02188"></a>02188 <span class="stringliteral">}</span>
<a name="l02189"></a>02189 <span class="stringliteral"></span>
<a name="l02196"></a>02196 <span class="stringliteral">function bindContainerClickAndHold(containerNode, clickFunc, holdFunc) {</span>
<a name="l02197"></a>02197 <span class="stringliteral">  // Rather than tracking suppressClick ourselves in here, we maintain the</span>
<a name="l02198"></a>02198 <span class="stringliteral">  // state globally in Cards.  The rationale is that popup menus will be</span>
<a name="l02199"></a>02199 <span class="stringliteral">  // triggered on contextmenu, which transfers responsibility of the click</span>
<a name="l02200"></a>02200 <span class="stringliteral">  // event to the popup handling logic.  There is also no chance for multiple</span>
<a name="l02201"></a>02201 <span class="stringliteral">  // contextmenu events overlapping (that we would consider reasonable).</span>
<a name="l02202"></a>02202 <span class="stringliteral">  bindContainerHandler(</span>
<a name="l02203"></a>02203 <span class="stringliteral">    containerNode, &#39;click&#39;,</span>
<a name="l02204"></a>02204 <span class="stringliteral">    function(node, event) {</span>
<a name="l02205"></a>02205 <span class="stringliteral">      if (Cards._suppressClick) {</span>
<a name="l02206"></a>02206 <span class="stringliteral">        Cards._suppressClick = false;</span>
<a name="l02207"></a>02207 <span class="stringliteral">        return;</span>
<a name="l02208"></a>02208 <span class="stringliteral">      }</span>
<a name="l02209"></a>02209 <span class="stringliteral">      clickFunc(node, event);</span>
<a name="l02210"></a>02210 <span class="stringliteral">    });</span>
<a name="l02211"></a>02211 <span class="stringliteral">  bindContainerHandler(</span>
<a name="l02212"></a>02212 <span class="stringliteral">    containerNode, &#39;contextmenu&#39;,</span>
<a name="l02213"></a>02213 <span class="stringliteral">    function(node, event) {</span>
<a name="l02214"></a>02214 <span class="stringliteral">      // Always preventDefault, as this terminates processing of the click as a</span>
<a name="l02215"></a>02215 <span class="stringliteral">      // drag event.</span>
<a name="l02216"></a>02216 <span class="stringliteral">      event.preventDefault();</span>
<a name="l02217"></a>02217 <span class="stringliteral">      // suppress the subsequent click if this was actually a left click</span>
<a name="l02218"></a>02218 <span class="stringliteral">      if (event.button === 0) {</span>
<a name="l02219"></a>02219 <span class="stringliteral">        Cards._suppressClick = true;</span>
<a name="l02220"></a>02220 <span class="stringliteral">      }</span>
<a name="l02221"></a>02221 <span class="stringliteral"></span>
<a name="l02222"></a>02222 <span class="stringliteral">      return holdFunc(node, event);</span>
<a name="l02223"></a>02223 <span class="stringliteral">    });</span>
<a name="l02224"></a>02224 <span class="stringliteral">}</span>
<a name="l02225"></a>02225 <span class="stringliteral"></span>
<a name="l02231"></a>02231 <span class="stringliteral">Cards = {</span>
<a name="l02232"></a>02232 <span class="stringliteral">  /* @dictof[</span>
<a name="l02233"></a>02233 <span class="stringliteral">   *   @key[name String]</span>
<a name="l02234"></a>02234 <span class="stringliteral">   *   @value[@dict[</span>
<a name="l02235"></a>02235 <span class="stringliteral">   *     @key[name String]{</span>
<a name="l02236"></a>02236 <span class="stringliteral">   *       The name of the card, which should also be the name of the css class</span>
<a name="l02237"></a>02237 <span class="stringliteral">   *       used for the card when &#39;card-&#39; is prepended.</span>
<a name="l02238"></a>02238 <span class="stringliteral">   *     }</span>
<a name="l02239"></a>02239 <span class="stringliteral">   *     @key[modes @dictof[</span>
<a name="l02240"></a>02240 <span class="stringliteral">   *       @key[modeName String]</span>
<a name="l02241"></a>02241 <span class="stringliteral">   *       @value[modeDef @dict[</span>
<a name="l02242"></a>02242 <span class="stringliteral">   *         @key[tray Boolean]{</span>
<a name="l02243"></a>02243 <span class="stringliteral">   *           Should this card be displayed as a tray that leaves the edge of</span>
<a name="l02244"></a>02244 <span class="stringliteral">   *           the adjacent card visible?  (The width of the edge being a</span>
<a name="l02245"></a>02245 <span class="stringliteral">   *           value consistent across all cards.)</span>
<a name="l02246"></a>02246 <span class="stringliteral">   *         }</span>
<a name="l02247"></a>02247 <span class="stringliteral">   *       ]</span>
<a name="l02248"></a>02248 <span class="stringliteral">   *     ]]</span>
<a name="l02249"></a>02249 <span class="stringliteral">   *     @key[constructor Function]{</span>
<a name="l02250"></a>02250 <span class="stringliteral">   *       The constructor to use to create an instance of the card.</span>
<a name="l02251"></a>02251 <span class="stringliteral">   *     }</span>
<a name="l02252"></a>02252 <span class="stringliteral">   *   ]]</span>
<a name="l02253"></a>02253 <span class="stringliteral">   * ]</span>
<a name="l02254"></a>02254 <span class="stringliteral">   */</span>
<a name="l02255"></a>02255 <span class="stringliteral">  _cardDefs: {},</span>
<a name="l02256"></a>02256 <span class="stringliteral"></span>
<a name="l02257"></a>02257 <span class="stringliteral">  /* @listof[@typedef[CardInstance @dict[</span>
<a name="l02258"></a>02258 <span class="stringliteral">   *   @key[domNode]{</span>
<a name="l02259"></a>02259 <span class="stringliteral">   *   }</span>
<a name="l02260"></a>02260 <span class="stringliteral">   *   @key[cardDef]</span>
<a name="l02261"></a>02261 <span class="stringliteral">   *   @key[modeDef]</span>
<a name="l02262"></a>02262 <span class="stringliteral">   *   @key[left Number]{</span>
<a name="l02263"></a>02263 <span class="stringliteral">   *     Left offset of the card in #cards.</span>
<a name="l02264"></a>02264 <span class="stringliteral">   *   }</span>
<a name="l02265"></a>02265 <span class="stringliteral">   *   @key[cardImpl]{</span>
<a name="l02266"></a>02266 <span class="stringliteral">   *     The result of calling the card&#39;s constructor.</span>
<a name="l02267"></a>02267 <span class="stringliteral">   *   }</span>
<a name="l02268"></a>02268 <span class="stringliteral">   * ]]]{</span>
<a name="l02269"></a>02269 <span class="stringliteral">   *   Existing cards, left-to-right, new cards getting pushed onto the right.</span>
<a name="l02270"></a>02270 <span class="stringliteral">   * }</span>
<a name="l02271"></a>02271 <span class="stringliteral">   */</span>
<a name="l02272"></a>02272 <span class="stringliteral">  _cardStack: [],</span>
<a name="l02273"></a>02273 <span class="stringliteral">  activeCardIndex: -1,</span>
<a name="l02274"></a>02274 <span class="stringliteral">  /*</span>
<a name="l02275"></a>02275 <span class="stringliteral">   * @oneof[null @listof[cardName modeName]]{</span>
<a name="l02276"></a>02276 <span class="stringliteral">   *   If a lazy load is causing us to have to wait before we push a card, this</span>
<a name="l02277"></a>02277 <span class="stringliteral">   *   is the type of card we are planning to push.  This is used by hasCard</span>
<a name="l02278"></a>02278 <span class="stringliteral">   *   to avoid returning misleading answers while an async push is happening.</span>
<a name="l02279"></a>02279 <span class="stringliteral">   * }</span>
<a name="l02280"></a>02280 <span class="stringliteral">   */</span>
<a name="l02281"></a>02281 <span class="stringliteral">  _pendingPush: null,</span>
<a name="l02282"></a>02282 <span class="stringliteral"></span>
<a name="l02287"></a>02287 <span class="stringliteral">  _zIndex: 0,</span>
<a name="l02288"></a>02288 <span class="stringliteral"></span>
<a name="l02294"></a>02294 <span class="stringliteral">  _rootNode: null,</span>
<a name="l02299"></a>02299 <span class="stringliteral">  _containerNode: null,</span>
<a name="l02305"></a>02305 <span class="stringliteral">  _cardsNode: null,</span>
<a name="l02306"></a>02306 <span class="stringliteral"></span>
<a name="l02311"></a>02311 <span class="stringliteral">  _animatingDeadDomNodes: [],</span>
<a name="l02312"></a>02312 <span class="stringliteral"></span>
<a name="l02319"></a>02319 <span class="stringliteral">  _transitionCount: 0,</span>
<a name="l02320"></a>02320 <span class="stringliteral"></span>
<a name="l02325"></a>02325 <span class="stringliteral">  _suppressClick: false,</span>
<a name="l02331"></a>02331 <span class="stringliteral">  _trayActive: false,</span>
<a name="l02337"></a>02337 <span class="stringliteral">  _popupActive: null,</span>
<a name="l02343"></a>02343 <span class="stringliteral">  _eatingEventsUntilNextCard: false,</span>
<a name="l02344"></a>02344 <span class="stringliteral"></span>
<a name="l02348"></a>02348 <span class="stringliteral">  _init: function() {</span>
<a name="l02349"></a>02349 <span class="stringliteral">    this._rootNode = document.body;</span>
<a name="l02350"></a>02350 <span class="stringliteral">    this._containerNode = document.getElementById(&#39;cardContainer&#39;);</span>
<a name="l02351"></a>02351 <span class="stringliteral">    this._cardsNode = document.getElementById(&#39;cards&#39;);</span>
<a name="l02352"></a>02352 <span class="stringliteral"></span>
<a name="l02353"></a>02353 <span class="stringliteral">    this._containerNode.appendChild(toasterNode);</span>
<a name="l02354"></a>02354 <span class="stringliteral"></span>
<a name="l02355"></a>02355 <span class="stringliteral">    this._containerNode.addEventListener(&#39;click&#39;,</span>
<a name="l02356"></a>02356 <span class="stringliteral">                                         this._onMaybeIntercept.bind(this),</span>
<a name="l02357"></a>02357 <span class="stringliteral">                                         true);</span>
<a name="l02358"></a>02358 <span class="stringliteral">    this._containerNode.addEventListener(&#39;contextmenu&#39;,</span>
<a name="l02359"></a>02359 <span class="stringliteral">                                         this._onMaybeIntercept.bind(this),</span>
<a name="l02360"></a>02360 <span class="stringliteral">                                         true);</span>
<a name="l02361"></a>02361 <span class="stringliteral"></span>
<a name="l02362"></a>02362 <span class="stringliteral">    // XXX be more platform detecty. or just add more events. unless the</span>
<a name="l02363"></a>02363 <span class="stringliteral">    // prefixes are already gone with webkit and opera?</span>
<a name="l02364"></a>02364 <span class="stringliteral">    this._cardsNode.addEventListener(&#39;transitionend&#39;,</span>
<a name="l02365"></a>02365 <span class="stringliteral">                                     this._onTransitionEnd.bind(this),</span>
<a name="l02366"></a>02366 <span class="stringliteral">                                     false);</span>
<a name="l02367"></a>02367 <span class="stringliteral">  },</span>
<a name="l02368"></a>02368 <span class="stringliteral"></span>
<a name="l02373"></a>02373 <span class="stringliteral">  _onMaybeIntercept: function(event) {</span>
<a name="l02374"></a>02374 <span class="stringliteral">    // Contextmenu-derived click suppression wants to gobble an explicitly</span>
<a name="l02375"></a>02375 <span class="stringliteral">    // expected event, and so takes priority over other types of suppression.</span>
<a name="l02376"></a>02376 <span class="stringliteral">    if (event.type === &#39;click&#39; &amp;&amp; this._suppressClick) {</span>
<a name="l02377"></a>02377 <span class="stringliteral">      this._suppressClick = false;</span>
<a name="l02378"></a>02378 <span class="stringliteral">      event.stopPropagation();</span>
<a name="l02379"></a>02379 <span class="stringliteral">      return;</span>
<a name="l02380"></a>02380 <span class="stringliteral">    }</span>
<a name="l02381"></a>02381 <span class="stringliteral">    if (this._eatingEventsUntilNextCard) {</span>
<a name="l02382"></a>02382 <span class="stringliteral">      event.stopPropagation();</span>
<a name="l02383"></a>02383 <span class="stringliteral">      return;</span>
<a name="l02384"></a>02384 <span class="stringliteral">    }</span>
<a name="l02385"></a>02385 <span class="stringliteral">    if (this._popupActive) {</span>
<a name="l02386"></a>02386 <span class="stringliteral">      event.stopPropagation();</span>
<a name="l02387"></a>02387 <span class="stringliteral">      this._popupActive.close();</span>
<a name="l02388"></a>02388 <span class="stringliteral">      return;</span>
<a name="l02389"></a>02389 <span class="stringliteral">    }</span>
<a name="l02390"></a>02390 <span class="stringliteral"></span>
<a name="l02391"></a>02391 <span class="stringliteral">    // Find the card containing the event target.</span>
<a name="l02392"></a>02392 <span class="stringliteral">    var cardNode = event.target;</span>
<a name="l02393"></a>02393 <span class="stringliteral">    for (cardNode = event.target; cardNode; cardNode = cardNode.parentNode) {</span>
<a name="l02394"></a>02394 <span class="stringliteral">      if (cardNode.classList.contains(&#39;card&#39;))</span>
<a name="l02395"></a>02395 <span class="stringliteral">        break;</span>
<a name="l02396"></a>02396 <span class="stringliteral">    }</span>
<a name="l02397"></a>02397 <span class="stringliteral"></span>
<a name="l02398"></a>02398 <span class="stringliteral">    // If tray is active and the click is in the card that is after</span>
<a name="l02399"></a>02399 <span class="stringliteral">    // current card (in the gutter), then just transition back to</span>
<a name="l02400"></a>02400 <span class="stringliteral">    // that card.</span>
<a name="l02401"></a>02401 <span class="stringliteral">    if (this._trayActive &amp;&amp; cardNode &amp;&amp; cardNode.classList.contains(&#39;after&#39;)) {</span>
<a name="l02402"></a>02402 <span class="stringliteral">      event.stopPropagation();</span>
<a name="l02403"></a>02403 <span class="stringliteral"></span>
<a name="l02404"></a>02404 <span class="stringliteral">      // Look for a card with a data-tray-target attribute</span>
<a name="l02405"></a>02405 <span class="stringliteral">      var targetIndex = -1;</span>
<a name="l02406"></a>02406 <span class="stringliteral">      this._cardStack.some(function(card, i) {</span>
<a name="l02407"></a>02407 <span class="stringliteral">        if (card.domNode.hasAttribute(&#39;data-tray-target&#39;)) {</span>
<a name="l02408"></a>02408 <span class="stringliteral">          targetIndex = i;</span>
<a name="l02409"></a>02409 <span class="stringliteral">          return true;</span>
<a name="l02410"></a>02410 <span class="stringliteral">        }</span>
<a name="l02411"></a>02411 <span class="stringliteral">      });</span>
<a name="l02412"></a>02412 <span class="stringliteral"></span>
<a name="l02413"></a>02413 <span class="stringliteral">      // Choose a default of one card ahead</span>
<a name="l02414"></a>02414 <span class="stringliteral">      if (targetIndex === -1)</span>
<a name="l02415"></a>02415 <span class="stringliteral">        targetIndex = this.activeCardIndex + 1;</span>
<a name="l02416"></a>02416 <span class="stringliteral"></span>
<a name="l02417"></a>02417 <span class="stringliteral">      var indexDiff = targetIndex - (this.activeCardIndex + 1);</span>
<a name="l02418"></a>02418 <span class="stringliteral">      if (indexDiff &gt; 0) {</span>
<a name="l02419"></a>02419 <span class="stringliteral">        this._afterTransitionAction = (function() {</span>
<a name="l02420"></a>02420 <span class="stringliteral">          this.removeCardAndSuccessors(this._cardStack[0].domNode,</span>
<a name="l02421"></a>02421 <span class="stringliteral">                                       &#39;none&#39;, indexDiff);</span>
<a name="l02422"></a>02422 <span class="stringliteral">          this.moveToCard(targetIndex, &#39;animate&#39;, &#39;forward&#39;);</span>
<a name="l02423"></a>02423 <span class="stringliteral">        }.bind(this));</span>
<a name="l02424"></a>02424 <span class="stringliteral">      }</span>
<a name="l02425"></a>02425 <span class="stringliteral"></span>
<a name="l02426"></a>02426 <span class="stringliteral">      this.moveToCard(this.activeCardIndex + 1, &#39;animate&#39;, &#39;forward&#39;);</span>
<a name="l02427"></a>02427 <span class="stringliteral">    }</span>
<a name="l02428"></a>02428 <span class="stringliteral">  },</span>
<a name="l02429"></a>02429 <span class="stringliteral"></span>
<a name="l02439"></a>02439 <span class="stringliteral">  pushDefaultCard: function(onPushed) {},</span>
<a name="l02440"></a>02440 <span class="stringliteral"></span>
<a name="l02441"></a>02441 <span class="stringliteral">  defineCard: function(cardDef) {</span>
<a name="l02442"></a>02442 <span class="stringliteral">    if (!cardDef.name)</span>
<a name="l02443"></a>02443 <span class="stringliteral">      throw new Error(&#39;The card type needs a name&#39;);</span>
<a name="l02444"></a>02444 <span class="stringliteral">    if (this._cardDefs.hasOwnProperty(cardDef.name))</span>
<a name="l02445"></a>02445 <span class="stringliteral">      throw new Error(&#39;Duplicate card name: &#39; + cardDef.name);</span>
<a name="l02446"></a>02446 <span class="stringliteral">    this._cardDefs[cardDef.name] = cardDef;</span>
<a name="l02447"></a>02447 <span class="stringliteral"></span>
<a name="l02448"></a>02448 <span class="stringliteral">    // normalize the modes</span>
<a name="l02449"></a>02449 <span class="stringliteral">    for (var modeName in cardDef.modes) {</span>
<a name="l02450"></a>02450 <span class="stringliteral">      var mode = cardDef.modes[modeName];</span>
<a name="l02451"></a>02451 <span class="stringliteral">      if (!mode.hasOwnProperty(&#39;tray&#39;))</span>
<a name="l02452"></a>02452 <span class="stringliteral">        mode.tray = false;</span>
<a name="l02453"></a>02453 <span class="stringliteral">      mode.name = modeName;</span>
<a name="l02454"></a>02454 <span class="stringliteral">    }</span>
<a name="l02455"></a>02455 <span class="stringliteral">  },</span>
<a name="l02456"></a>02456 <span class="stringliteral"></span>
<a name="l02457"></a>02457 <span class="stringliteral">  defineCardWithDefaultMode: function(name, defaultMode, constructor,</span>
<a name="l02458"></a>02458 <span class="stringliteral">                                      templateNode) {</span>
<a name="l02459"></a>02459 <span class="stringliteral">    var cardDef = {</span>
<a name="l02460"></a>02460 <span class="stringliteral">      name: name,</span>
<a name="l02461"></a>02461 <span class="stringliteral">      modes: {},</span>
<a name="l02462"></a>02462 <span class="stringliteral">      constructor: constructor,</span>
<a name="l02463"></a>02463 <span class="stringliteral">      templateNode: templateNode</span>
<a name="l02464"></a>02464 <span class="stringliteral">    };</span>
<a name="l02465"></a>02465 <span class="stringliteral">    cardDef.modes[&#39;default&#39;] = defaultMode;</span>
<a name="l02466"></a>02466 <span class="stringliteral">    this.defineCard(cardDef);</span>
<a name="l02467"></a>02467 <span class="stringliteral">  },</span>
<a name="l02468"></a>02468 <span class="stringliteral"></span>
<a name="l02472"></a>02472 <span class="stringliteral">  /* @args[</span>
<a name="l02473"></a>02473 <span class="stringliteral">   *   @param[type]</span>
<a name="l02474"></a>02474 <span class="stringliteral">   *   @param[mode String]{</span>
<a name="l02475"></a>02475 <span class="stringliteral">   *   }</span>
<a name="l02476"></a>02476 <span class="stringliteral">   *   @param[showMethod @oneof[</span>
<a name="l02477"></a>02477 <span class="stringliteral">   *     @case[&#39;animate&#39;]{</span>
<a name="l02478"></a>02478 <span class="stringliteral">   *       Perform an animated scrolling transition.</span>
<a name="l02479"></a>02479 <span class="stringliteral">   *     }</span>
<a name="l02480"></a>02480 <span class="stringliteral">   *     @case[&#39;immediate&#39;]{</span>
<a name="l02481"></a>02481 <span class="stringliteral">   *       Immediately warp to the card without animation.</span>
<a name="l02482"></a>02482 <span class="stringliteral">   *     }</span>
<a name="l02483"></a>02483 <span class="stringliteral">   *     @case[&#39;none&#39;]{</span>
<a name="l02484"></a>02484 <span class="stringliteral">   *       Don&#39;t touch the view at all.</span>
<a name="l02485"></a>02485 <span class="stringliteral">   *     }</span>
<a name="l02486"></a>02486 <span class="stringliteral">   *   ]]</span>
<a name="l02487"></a>02487 <span class="stringliteral">   *   @param[args Object]{</span>
<a name="l02488"></a>02488 <span class="stringliteral">   *     An arguments object to provide to the card&#39;s constructor when</span>
<a name="l02489"></a>02489 <span class="stringliteral">   *     instantiating.</span>
<a name="l02490"></a>02490 <span class="stringliteral">   *   }</span>
<a name="l02491"></a>02491 <span class="stringliteral">   *   @param[placement #:optional @oneof[</span>
<a name="l02492"></a>02492 <span class="stringliteral">   *     @case[undefined]{</span>
<a name="l02493"></a>02493 <span class="stringliteral">   *       The card gets pushed onto the end of the stack.</span>
<a name="l02494"></a>02494 <span class="stringliteral">   *     }</span>
<a name="l02495"></a>02495 <span class="stringliteral">   *     @case[&#39;left&#39;]{</span>
<a name="l02496"></a>02496 <span class="stringliteral">   *       The card gets inserted to the left of the current card.</span>
<a name="l02497"></a>02497 <span class="stringliteral">   *     }</span>
<a name="l02498"></a>02498 <span class="stringliteral">   *     @case[&#39;right&#39;]{</span>
<a name="l02499"></a>02499 <span class="stringliteral">   *       The card gets inserted to the right of the current card.</span>
<a name="l02500"></a>02500 <span class="stringliteral">   *     }</span>
<a name="l02501"></a>02501 <span class="stringliteral">   *   }</span>
<a name="l02502"></a>02502 <span class="stringliteral">   * ]</span>
<a name="l02503"></a>02503 <span class="stringliteral">   */</span>
<a name="l02504"></a>02504 <span class="stringliteral">  pushCard: function(type, mode, showMethod, args, placement) {</span>
<a name="l02505"></a>02505 <span class="stringliteral">    var cardDef = this._cardDefs[type];</span>
<a name="l02506"></a>02506 <span class="stringliteral">    var typePrefix = type.split(&#39;-&#39;)[0];</span>
<a name="l02507"></a>02507 <span class="stringliteral"></span>
<a name="l02508"></a>02508 <span class="stringliteral">    args = args || {};</span>
<a name="l02509"></a>02509 <span class="stringliteral"></span>
<a name="l02510"></a>02510 <span class="stringliteral">    if (!cardDef) {</span>
<a name="l02511"></a>02511 <span class="stringliteral">      var cbArgs = Array.slice(arguments);</span>
<a name="l02512"></a>02512 <span class="stringliteral">      this._pendingPush = [type, mode];</span>
<a name="l02513"></a>02513 <span class="stringliteral"></span>
<a name="l02514"></a>02514 <span class="stringliteral">      // Only eat clicks if the card will be visibly displayed.</span>
<a name="l02515"></a>02515 <span class="stringliteral">      if (showMethod !== &#39;none&#39;)</span>
<a name="l02516"></a>02516 <span class="stringliteral">        this.eatEventsUntilNextCard();</span>
<a name="l02517"></a>02517 <span class="stringliteral"></span>
<a name="l02518"></a>02518 <span class="stringliteral">      require([&#39;cards/&#39; + type], function() {</span>
<a name="l02519"></a>02519 <span class="stringliteral">        this.pushCard.apply(this, cbArgs);</span>
<a name="l02520"></a>02520 <span class="stringliteral">      }.bind(this));</span>
<a name="l02521"></a>02521 <span class="stringliteral">      return;</span>
<a name="l02522"></a>02522 <span class="stringliteral">    }</span>
<a name="l02523"></a>02523 <span class="stringliteral"></span>
<a name="l02524"></a>02524 <span class="stringliteral">    this._pendingPush = null;</span>
<a name="l02525"></a>02525 <span class="stringliteral"></span>
<a name="l02526"></a>02526 <span class="stringliteral">    var modeDef = cardDef.modes[mode];</span>
<a name="l02527"></a>02527 <span class="stringliteral">    if (!modeDef)</span>
<a name="l02528"></a>02528 <span class="stringliteral">      throw new Error(&#39;No such card mode: &#39; + mode);</span>
<a name="l02529"></a>02529 <span class="stringliteral"></span>
<a name="l02530"></a>02530 <span class="stringliteral">    console.log(&#39;pushCard for type: &#39; + type);</span>
<a name="l02531"></a>02531 <span class="stringliteral"></span>
<a name="l02532"></a>02532 <span class="stringliteral">    var domNode = args.cachedNode ?</span>
<a name="l02533"></a>02533 <span class="stringliteral">                  args.cachedNode : cardDef.templateNode.cloneNode(true);</span>
<a name="l02534"></a>02534 <span class="stringliteral"></span>
<a name="l02535"></a>02535 <span class="stringliteral">    domNode.setAttribute(&#39;data-type&#39;, type);</span>
<a name="l02536"></a>02536 <span class="stringliteral">    domNode.setAttribute(&#39;data-mode&#39;, mode);</span>
<a name="l02537"></a>02537 <span class="stringliteral"></span>
<a name="l02538"></a>02538 <span class="stringliteral">    var cardImpl = new cardDef.constructor(domNode, mode, args);</span>
<a name="l02539"></a>02539 <span class="stringliteral">    var cardInst = {</span>
<a name="l02540"></a>02540 <span class="stringliteral">      domNode: domNode,</span>
<a name="l02541"></a>02541 <span class="stringliteral">      cardDef: cardDef,</span>
<a name="l02542"></a>02542 <span class="stringliteral">      modeDef: modeDef,</span>
<a name="l02543"></a>02543 <span class="stringliteral">      cardImpl: cardImpl</span>
<a name="l02544"></a>02544 <span class="stringliteral">    };</span>
<a name="l02545"></a>02545 <span class="stringliteral">    var cardIndex, insertBuddy;</span>
<a name="l02546"></a>02546 <span class="stringliteral">    if (!placement) {</span>
<a name="l02547"></a>02547 <span class="stringliteral">      cardIndex = this._cardStack.length;</span>
<a name="l02548"></a>02548 <span class="stringliteral">      insertBuddy = null;</span>
<a name="l02549"></a>02549 <span class="stringliteral">      domNode.classList.add(cardIndex === 0 ? &#39;before&#39; : &#39;after&#39;);</span>
<a name="l02550"></a>02550 <span class="stringliteral">    }</span>
<a name="l02551"></a>02551 <span class="stringliteral">    else if (placement === &#39;left&#39;) {</span>
<a name="l02552"></a>02552 <span class="stringliteral">      cardIndex = this.activeCardIndex++;</span>
<a name="l02553"></a>02553 <span class="stringliteral">      insertBuddy = this._cardsNode.children[cardIndex];</span>
<a name="l02554"></a>02554 <span class="stringliteral">      domNode.classList.add(&#39;before&#39;);</span>
<a name="l02555"></a>02555 <span class="stringliteral">    }</span>
<a name="l02556"></a>02556 <span class="stringliteral">    else if (placement === &#39;right&#39;) {</span>
<a name="l02557"></a>02557 <span class="stringliteral">      cardIndex = this.activeCardIndex + 1;</span>
<a name="l02558"></a>02558 <span class="stringliteral">      if (cardIndex &gt;= this._cardStack.length)</span>
<a name="l02559"></a>02559 <span class="stringliteral">        insertBuddy = null;</span>
<a name="l02560"></a>02560 <span class="stringliteral">      else</span>
<a name="l02561"></a>02561 <span class="stringliteral">        insertBuddy = this._cardsNode.children[cardIndex];</span>
<a name="l02562"></a>02562 <span class="stringliteral">      domNode.classList.add(&#39;after&#39;);</span>
<a name="l02563"></a>02563 <span class="stringliteral">    }</span>
<a name="l02564"></a>02564 <span class="stringliteral">    this._cardStack.splice(cardIndex, 0, cardInst);</span>
<a name="l02565"></a>02565 <span class="stringliteral"></span>
<a name="l02566"></a>02566 <span class="stringliteral">    if (!args.cachedNode)</span>
<a name="l02567"></a>02567 <span class="stringliteral">      this._cardsNode.insertBefore(domNode, insertBuddy);</span>
<a name="l02568"></a>02568 <span class="stringliteral"></span>
<a name="l02569"></a>02569 <span class="stringliteral">    // If the card has any &lt;button type=&quot;</span><a class="code" href="../../db/dac/mock__picker_8js.html#aed26045338f591d889d2a8bf699451ef">reset</a><span class="stringliteral">&quot;&gt; buttons,</span>
<a name="l02570"></a>02570 <span class="stringliteral">    // make them clear the field they&#39;re next to and not the entire form.</span>
<a name="l02571"></a>02571 <span class="stringliteral">    // See input_areas.js and shared/style/input_areas.css.</span>
<a name="l02572"></a>02572 <span class="stringliteral">    hookupInputAreaResetButtons(domNode);</span>
<a name="l02573"></a>02573 <span class="stringliteral"></span>
<a name="l02574"></a>02574 <span class="stringliteral">    if (&#39;postInsert&#39; in cardImpl)</span>
<a name="l02575"></a>02575 <span class="stringliteral">      cardImpl.postInsert();</span>
<a name="l02576"></a>02576 <span class="stringliteral"></span>
<a name="l02577"></a>02577 <span class="stringliteral">    if (showMethod !== &#39;none&#39;) {</span>
<a name="l02578"></a>02578 <span class="stringliteral">      // make sure the reflow sees the new node so that the animation</span>
<a name="l02579"></a>02579 <span class="stringliteral">      // later is smooth.</span>
<a name="l02580"></a>02580 <span class="stringliteral">      if (!args.cachedNode)</span>
<a name="l02581"></a>02581 <span class="stringliteral">        domNode.clientWidth;</span>
<a name="l02582"></a>02582 <span class="stringliteral"></span>
<a name="l02583"></a>02583 <span class="stringliteral">      this._showCard(cardIndex, showMethod, &#39;forward&#39;);</span>
<a name="l02584"></a>02584 <span class="stringliteral">    }</span>
<a name="l02585"></a>02585 <span class="stringliteral"></span>
<a name="l02586"></a>02586 <span class="stringliteral">    if (args.onPushed)</span>
<a name="l02587"></a>02587 <span class="stringliteral">      args.onPushed(cardImpl);</span>
<a name="l02588"></a>02588 <span class="stringliteral">  },</span>
<a name="l02589"></a>02589 <span class="stringliteral"></span>
<a name="l02590"></a>02590 <span class="stringliteral">  _findCardUsingTypeAndMode: function(type, mode) {</span>
<a name="l02591"></a>02591 <span class="stringliteral">    for (var i = 0; i &lt; this._cardStack.length; i++) {</span>
<a name="l02592"></a>02592 <span class="stringliteral">      var cardInst = this._cardStack[i];</span>
<a name="l02593"></a>02593 <span class="stringliteral">      if (cardInst.cardDef.name === type &amp;&amp;</span>
<a name="l02594"></a>02594 <span class="stringliteral">          cardInst.modeDef.name === mode) {</span>
<a name="l02595"></a>02595 <span class="stringliteral">        return i;</span>
<a name="l02596"></a>02596 <span class="stringliteral">      }</span>
<a name="l02597"></a>02597 <span class="stringliteral">    }</span>
<a name="l02598"></a>02598 <span class="stringliteral">  },</span>
<a name="l02599"></a>02599 <span class="stringliteral"></span>
<a name="l02600"></a>02600 <span class="stringliteral">  _findCardUsingImpl: function(impl) {</span>
<a name="l02601"></a>02601 <span class="stringliteral">    for (var i = 0; i &lt; this._cardStack.length; i++) {</span>
<a name="l02602"></a>02602 <span class="stringliteral">      var cardInst = this._cardStack[i];</span>
<a name="l02603"></a>02603 <span class="stringliteral">      if (cardInst.cardImpl === impl)</span>
<a name="l02604"></a>02604 <span class="stringliteral">        return i;</span>
<a name="l02605"></a>02605 <span class="stringliteral">    }</span>
<a name="l02606"></a>02606 <span class="stringliteral">  },</span>
<a name="l02607"></a>02607 <span class="stringliteral"></span>
<a name="l02608"></a>02608 <span class="stringliteral">  _findCard: function(query, skipFail) {</span>
<a name="l02609"></a>02609 <span class="stringliteral">    var result;</span>
<a name="l02610"></a>02610 <span class="stringliteral">    if (Array.isArray(query))</span>
<a name="l02611"></a>02611 <span class="stringliteral">      result = this._findCardUsingTypeAndMode(query[0], query[1], skipFail);</span>
<a name="l02612"></a>02612 <span class="stringliteral">    else if (typeof(query) === &#39;number&#39;) // index number</span>
<a name="l02613"></a>02613 <span class="stringliteral">      result = query;</span>
<a name="l02614"></a>02614 <span class="stringliteral">    else</span>
<a name="l02615"></a>02615 <span class="stringliteral">      result = this._findCardUsingImpl(query);</span>
<a name="l02616"></a>02616 <span class="stringliteral"></span>
<a name="l02617"></a>02617 <span class="stringliteral">    if (result &gt; -1)</span>
<a name="l02618"></a>02618 <span class="stringliteral">      return result;</span>
<a name="l02619"></a>02619 <span class="stringliteral">    else if (!skipFail)</span>
<a name="l02620"></a>02620 <span class="stringliteral">      throw new Error(&#39;Unable to find card with query:&#39;, query);</span>
<a name="l02621"></a>02621 <span class="stringliteral">    else</span>
<a name="l02622"></a>02622 <span class="stringliteral">      // Returning undefined explicitly so that index comparisons, like</span>
<a name="l02623"></a>02623 <span class="stringliteral">      // the one in hasCard, are correct.</span>
<a name="l02624"></a>02624 <span class="stringliteral">      return undefined;</span>
<a name="l02625"></a>02625 <span class="stringliteral">  },</span>
<a name="l02626"></a>02626 <span class="stringliteral"></span>
<a name="l02627"></a>02627 <span class="stringliteral">  hasCard: function(query) {</span>
<a name="l02628"></a>02628 <span class="stringliteral">    if (this._pendingPush &amp;&amp; Array.isArray(query) &amp;&amp; query.length === 2 &amp;&amp;</span>
<a name="l02629"></a>02629 <span class="stringliteral">        this._pendingPush[0] === query[0] &amp;&amp;</span>
<a name="l02630"></a>02630 <span class="stringliteral">        this._pendingPush[1] === query[1])</span>
<a name="l02631"></a>02631 <span class="stringliteral">      return true;</span>
<a name="l02632"></a>02632 <span class="stringliteral"></span>
<a name="l02633"></a>02633 <span class="stringliteral">    return this._findCard(query, true) &gt; -1;</span>
<a name="l02634"></a>02634 <span class="stringliteral">  },</span>
<a name="l02635"></a>02635 <span class="stringliteral"></span>
<a name="l02636"></a>02636 <span class="stringliteral">  isVisible: function(cardImpl) {</span>
<a name="l02637"></a>02637 <span class="stringliteral">    return !!(cardImpl.domNode &amp;&amp;</span>
<a name="l02638"></a>02638 <span class="stringliteral">              cardImpl.domNode.classList.contains(&#39;center&#39;));</span>
<a name="l02639"></a>02639 <span class="stringliteral">  },</span>
<a name="l02640"></a>02640 <span class="stringliteral"></span>
<a name="l02641"></a>02641 <span class="stringliteral">  findCardObject: function(query) {</span>
<a name="l02642"></a>02642 <span class="stringliteral">    return this._cardStack[this._findCard(query)];</span>
<a name="l02643"></a>02643 <span class="stringliteral">  },</span>
<a name="l02644"></a>02644 <span class="stringliteral"></span>
<a name="l02645"></a>02645 <span class="stringliteral">  folderSelector: function(callback) {</span>
<a name="l02646"></a>02646 <span class="stringliteral">    var self = this;</span>
<a name="l02647"></a>02647 <span class="stringliteral"></span>
<a name="l02648"></a>02648 <span class="stringliteral">    require([&#39;model&#39;, &#39;value_selector&#39;], function(model) {</span>
<a name="l02649"></a>02649 <span class="stringliteral">      // XXX: Unified folders will require us to make sure we get the folder</span>
<a name="l02650"></a>02650 <span class="stringliteral">      //      list for the account the message originates from.</span>
<a name="l02651"></a>02651 <span class="stringliteral">      if (!self.folderPrompt) {</span>
<a name="l02652"></a>02652 <span class="stringliteral">        var selectorTitle = mozL10n.get(&#39;messages-folder-select&#39;);</span>
<a name="l02653"></a>02653 <span class="stringliteral">        self.folderPrompt = new ValueSelector(selectorTitle);</span>
<a name="l02654"></a>02654 <span class="stringliteral">      }</span>
<a name="l02655"></a>02655 <span class="stringliteral"></span>
<a name="l02656"></a>02656 <span class="stringliteral">      model.latestOnce(&#39;foldersSlice&#39;, function(foldersSlice) {</span>
<a name="l02657"></a>02657 <span class="stringliteral">        var folders = foldersSlice.items;</span>
<a name="l02658"></a>02658 <span class="stringliteral">        for (var i = 0; i &lt; folders.length; i++) {</span>
<a name="l02659"></a>02659 <span class="stringliteral">          var folder = folders[i];</span>
<a name="l02660"></a>02660 <span class="stringliteral">          self.folderPrompt.addToList(folder.name, folder.depth,</span>
<a name="l02661"></a>02661 <span class="stringliteral">            function(folder) {</span>
<a name="l02662"></a>02662 <span class="stringliteral">              return function() {</span>
<a name="l02663"></a>02663 <span class="stringliteral">                self.folderPrompt.hide();</span>
<a name="l02664"></a>02664 <span class="stringliteral">                callback(folder);</span>
<a name="l02665"></a>02665 <span class="stringliteral">              };</span>
<a name="l02666"></a>02666 <span class="stringliteral">            }(folder));</span>
<a name="l02667"></a>02667 <span class="stringliteral"></span>
<a name="l02668"></a>02668 <span class="stringliteral">        }</span>
<a name="l02669"></a>02669 <span class="stringliteral">        self.folderPrompt.show();</span>
<a name="l02670"></a>02670 <span class="stringliteral">      });</span>
<a name="l02671"></a>02671 <span class="stringliteral">    });</span>
<a name="l02672"></a>02672 <span class="stringliteral">  },</span>
<a name="l02673"></a>02673 <span class="stringliteral"></span>
<a name="l02674"></a>02674 <span class="stringliteral">  moveToCard: function(query, showMethod) {</span>
<a name="l02675"></a>02675 <span class="stringliteral">    this._showCard(this._findCard(query), showMethod || &#39;animate&#39;);</span>
<a name="l02676"></a>02676 <span class="stringliteral">  },</span>
<a name="l02677"></a>02677 <span class="stringliteral"></span>
<a name="l02678"></a>02678 <span class="stringliteral">  tellCard: function(query, what) {</span>
<a name="l02679"></a>02679 <span class="stringliteral">    var cardIndex = this._findCard(query),</span>
<a name="l02680"></a>02680 <span class="stringliteral">        cardInst = this._cardStack[cardIndex];</span>
<a name="l02681"></a>02681 <span class="stringliteral">    if (!(&#39;told&#39; in cardInst.cardImpl))</span>
<a name="l02682"></a>02682 <span class="stringliteral">      console.warn(&quot;</span>Tried <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> tell <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a> card that<span class="stringliteral">&#39;s not listening!&quot;, query, what);</span>
<a name="l02683"></a>02683 <span class="stringliteral">    else</span>
<a name="l02684"></a>02684 <span class="stringliteral">      cardInst.cardImpl.told(what);</span>
<a name="l02685"></a>02685 <span class="stringliteral">  },</span>
<a name="l02686"></a>02686 <span class="stringliteral"></span>
<a name="l02692"></a>02692 <span class="stringliteral">  _createMaskForNode: function(domNode, bounds) {</span>
<a name="l02693"></a>02693 <span class="stringliteral">    var anchorIn = this._rootNode, cleanupDivs = [];</span>
<a name="l02694"></a>02694 <span class="stringliteral">    var uiWidth = this._containerNode.offsetWidth,</span>
<a name="l02695"></a>02695 <span class="stringliteral">        uiHeight = this._containerNode.offsetHeight;</span>
<a name="l02696"></a>02696 <span class="stringliteral"></span>
<a name="l02697"></a>02697 <span class="stringliteral">    // inclusive pixel coverage</span>
<a name="l02698"></a>02698 <span class="stringliteral">    function addMask(left, top, right, bottom) {</span>
<a name="l02699"></a>02699 <span class="stringliteral">      var node = document.createElement(&#39;</span>div<span class="stringliteral">&#39;);</span>
<a name="l02700"></a>02700 <span class="stringliteral">      node.classList.add(&#39;</span>popup-<a class="code" href="../../d6/d1b/pprthred_8h.html#a0ef3d0e16cb97cc7f7a7493c13119571">mask</a><span class="stringliteral">&#39;);</span>
<a name="l02701"></a>02701 <span class="stringliteral">      node.style.left = left + &#39;</span>px<span class="stringliteral">&#39;;</span>
<a name="l02702"></a>02702 <span class="stringliteral">      node.style.top = top + &#39;</span>px<span class="stringliteral">&#39;;</span>
<a name="l02703"></a>02703 <span class="stringliteral">      node.style.width = (right - left + 1) + &#39;</span>px<span class="stringliteral">&#39;;</span>
<a name="l02704"></a>02704 <span class="stringliteral">      node.style.height = (bottom - top + 1) + &#39;</span>px<span class="stringliteral">&#39;;</span>
<a name="l02705"></a>02705 <span class="stringliteral">      cleanupDivs.push(node);</span>
<a name="l02706"></a>02706 <span class="stringliteral">      anchorIn.appendChild(node);</span>
<a name="l02707"></a>02707 <span class="stringliteral">    }</span>
<a name="l02708"></a>02708 <span class="stringliteral">    if (bounds.left &gt; 1)</span>
<a name="l02709"></a>02709 <span class="stringliteral">      addMask(0, bounds.top, bounds.left - 1, bounds.bottom);</span>
<a name="l02710"></a>02710 <span class="stringliteral">    if (bounds.top &gt; 0)</span>
<a name="l02711"></a>02711 <span class="stringliteral">      addMask(0, 0, uiWidth - 1, bounds.top - 1);</span>
<a name="l02712"></a>02712 <span class="stringliteral">    if (bounds.right &lt; uiWidth - 1)</span>
<a name="l02713"></a>02713 <span class="stringliteral">      addMask(bounds.right + 1, bounds.top, uiWidth - 1, bounds.bottom);</span>
<a name="l02714"></a>02714 <span class="stringliteral">    if (bounds.bottom &lt; uiHeight - 1)</span>
<a name="l02715"></a>02715 <span class="stringliteral">      addMask(0, bounds.bottom + 1, uiWidth - 1, uiHeight - 1);</span>
<a name="l02716"></a>02716 <span class="stringliteral">    return function() {</span>
<a name="l02717"></a>02717 <span class="stringliteral">      for (var i = 0; i &lt; cleanupDivs.length; i++) {</span>
<a name="l02718"></a>02718 <span class="stringliteral">        anchorIn.removeChild(cleanupDivs[i]);</span>
<a name="l02719"></a>02719 <span class="stringliteral">      }</span>
<a name="l02720"></a>02720 <span class="stringliteral">    };</span>
<a name="l02721"></a>02721 <span class="stringliteral">  },</span>
<a name="l02722"></a>02722 <span class="stringliteral"></span>
<a name="l02729"></a>02729 <span class="stringliteral">  /* @args[</span>
<a name="l02730"></a>02730 <span class="stringliteral">   *   @param[cardDomNode]{</span>
<a name="l02731"></a>02731 <span class="stringliteral">   *     The DOM node that is the first card to remove; all of the cards to its</span>
<a name="l02732"></a>02732 <span class="stringliteral">   *     right will also be removed.  If null is passed it is understood you</span>
<a name="l02733"></a>02733 <span class="stringliteral">   *     want to remove all cards.</span>
<a name="l02734"></a>02734 <span class="stringliteral">   *   }</span>
<a name="l02735"></a>02735 <span class="stringliteral">   *   @param[showMethod @oneof[</span>
<a name="l02736"></a>02736 <span class="stringliteral">   *     @case[&#39;</span>animate<span class="stringliteral">&#39;]{</span>
<a name="l02737"></a>02737 <span class="stringliteral">   *       Perform an animated scrolling transition.</span>
<a name="l02738"></a>02738 <span class="stringliteral">   *     }</span>
<a name="l02739"></a>02739 <span class="stringliteral">   *     @case[&#39;</span>immediate<span class="stringliteral">&#39;]{</span>
<a name="l02740"></a>02740 <span class="stringliteral">   *       Immediately warp to the card without animation.</span>
<a name="l02741"></a>02741 <span class="stringliteral">   *     }</span>
<a name="l02742"></a>02742 <span class="stringliteral">   *     @case[&#39;</span>none<span class="stringliteral">&#39;]{</span>
<a name="l02743"></a>02743 <span class="stringliteral">   *       Remove the nodes immediately, don&#39;</span>t <span class="keywordflow">do</span> anything about the <a class="code" href="../../db/d80/download_8js.html#acc4e419f5bedc9e697af56e25c615638">view</a>
<a name="l02744"></a>02744    *       <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>.  You only want <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> <span class="keywordflow">do</span> <span class="keyword">this</span> <span class="keywordflow">if</span> you are going <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> <a class="code" href="../../d6/da5/libpinyin_8js.html#a52101983b19adda1d8740c8b3d4aa0dc">push</a> one
<a name="l02745"></a>02745    *       or more cards and the last card will <a class="code" href="../../d3/d5d/server__helper_8js.html#ab43a71f75fab9690a61a26dbbb0e4836">use</a> <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a> transition of <span class="stringliteral">&#39;immediate&#39;</span>.
<a name="l02746"></a>02746    *     }
<a name="l02747"></a>02747    *   ]]
<a name="l02748"></a>02748    *   @param[numCards #:optional Number]{
<a name="l02749"></a>02749    *     The number of cards <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> <span class="keyword">remove</span>.  If <a class="code" href="../../d0/d90/tests_2python_2gaia-unit-tests_2_r_e_a_d_m_e_8md.html#a3cdff4cbbd51515bc7bfe68e93b79d43">omitted</a>, all the cards <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> the <a class="code" href="../../d2/d7d/jsapi_8h.html#a06a61119547d88fbcdf5e877c6c9057e">right</a>
<a name="l02750"></a>02750    *     of <span class="keyword">this</span> card are removed as well.
<a name="l02751"></a>02751    *   }
<a name="l02752"></a>02752    *   @param[nextCardSpec #:optional]{
<a name="l02753"></a>02753    *     If <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a> showMethod is not <span class="stringliteral">&#39;none&#39;</span>, the card <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> <a class="code" href="../../d4/dc5/handled__call_8js.html#a849945b83cbf2e6fcd68a90c133c1824">show</a> after removal.
<a name="l02754"></a>02754    *   }
<a name="l02755"></a>02755    * ]
<a name="l02756"></a>02756    */
<a name="l02757"></a>02757   removeCardAndSuccessors: <span class="keyword">function</span>(cardDomNode, showMethod, numCards,
<a name="l02758"></a>02758                                     nextCardSpec) {
<a name="l02759"></a>02759     <span class="keywordflow">if</span> (!this._cardStack.length)
<a name="l02760"></a>02760       <span class="keywordflow">return</span>;
<a name="l02761"></a>02761 
<a name="l02762"></a>02762     <span class="keywordflow">if</span> (cardDomNode &amp;&amp; this._cardStack.length === 1) {
<a name="l02763"></a>02763       <span class="comment">// No card to go to when done, so ask for a default</span>
<a name="l02764"></a>02764       <span class="comment">// card and continue work once it exists.</span>
<a name="l02765"></a>02765       <span class="keywordflow">return</span> Cards.pushDefaultCard(<span class="keyword">function</span>() {
<a name="l02766"></a>02766         this.removeCardAndSuccessors(cardDomNode, showMethod, numCards,
<a name="l02767"></a>02767                                     nextCardSpec);
<a name="l02768"></a>02768       }.bind(<span class="keyword">this</span>));
<a name="l02769"></a>02769     }
<a name="l02770"></a>02770 
<a name="l02771"></a>02771     var firstIndex, iCard, cardInst;
<a name="l02772"></a>02772     <span class="keywordflow">if</span> (cardDomNode === undefined) {
<a name="l02773"></a>02773       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;undefined is not a valid card spec!&#39;</span>);
<a name="l02774"></a>02774     }
<a name="l02775"></a>02775     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cardDomNode === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l02776"></a>02776       firstIndex = 0;
<a name="l02777"></a>02777       <span class="comment">// reset the z-index to 0 since we may have cards in the stack that</span>
<a name="l02778"></a>02778       <span class="comment">// adjusted the z-index (and we are definitively clearing all cards).</span>
<a name="l02779"></a>02779       this._zIndex = 0;
<a name="l02780"></a>02780     }
<a name="l02781"></a>02781     <span class="keywordflow">else</span> {
<a name="l02782"></a>02782       <span class="keywordflow">for</span> (iCard = this._cardStack.length - 1; iCard &gt;= 0; iCard--) {
<a name="l02783"></a>02783         cardInst = this._cardStack[iCard];
<a name="l02784"></a>02784         <span class="keywordflow">if</span> (cardInst.domNode === cardDomNode) {
<a name="l02785"></a>02785           firstIndex = iCard;
<a name="l02786"></a>02786           <span class="keywordflow">break</span>;
<a name="l02787"></a>02787         }
<a name="l02788"></a>02788       }
<a name="l02789"></a>02789       <span class="keywordflow">if</span> (firstIndex === undefined)
<a name="l02790"></a>02790         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;No card represented by that DOM node&#39;</span>);
<a name="l02791"></a>02791     }
<a name="l02792"></a>02792     <span class="keywordflow">if</span> (!numCards)
<a name="l02793"></a>02793       numCards = this._cardStack.length - firstIndex;
<a name="l02794"></a>02794 
<a name="l02795"></a>02795     <span class="keywordflow">if</span> (showMethod !== <span class="stringliteral">&#39;none&#39;</span>) {
<a name="l02796"></a>02796       var nextCardIndex = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02797"></a>02797       <span class="keywordflow">if</span> (nextCardSpec)
<a name="l02798"></a>02798         nextCardIndex = this._findCard(nextCardSpec);
<a name="l02799"></a>02799       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (this._cardStack.length)
<a name="l02800"></a>02800         nextCardIndex = Math.min(firstIndex - 1, this._cardStack.length - 1);
<a name="l02801"></a>02801 
<a name="l02802"></a>02802       this._showCard(nextCardIndex, showMethod, <span class="stringliteral">&#39;back&#39;</span>);
<a name="l02803"></a>02803     }
<a name="l02804"></a>02804 
<a name="l02805"></a>02805     <span class="comment">// Update activeCardIndex if nodes were removed that would affect its</span>
<a name="l02806"></a>02806     <span class="comment">// value.</span>
<a name="l02807"></a>02807     <span class="keywordflow">if</span> (firstIndex &lt;= this.activeCardIndex) {
<a name="l02808"></a>02808       this.activeCardIndex -= numCards;
<a name="l02809"></a>02809       <span class="keywordflow">if</span> (this.activeCardIndex &lt; -1) {
<a name="l02810"></a>02810         this.activeCardIndex = -1;
<a name="l02811"></a>02811       }
<a name="l02812"></a>02812     }
<a name="l02813"></a>02813 
<a name="l02814"></a>02814     var deadCardInsts = this._cardStack.splice(
<a name="l02815"></a>02815                           firstIndex, numCards);
<a name="l02816"></a>02816     <span class="keywordflow">for</span> (iCard = 0; iCard &lt; deadCardInsts.length; iCard++) {
<a name="l02817"></a>02817       cardInst = deadCardInsts[iCard];
<a name="l02818"></a>02818       <span class="keywordflow">try</span> {
<a name="l02819"></a>02819         cardInst.cardImpl.die();
<a name="l02820"></a>02820       }
<a name="l02821"></a>02821       <span class="keywordflow">catch</span> (ex) {
<a name="l02822"></a>02822         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;Problem cleaning up card:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l02823"></a>02823       }
<a name="l02824"></a>02824       <span class="keywordflow">switch</span> (showMethod) {
<a name="l02825"></a>02825         <span class="keywordflow">case</span> <span class="stringliteral">&#39;animate&#39;</span>:
<a name="l02826"></a>02826         <span class="keywordflow">case</span> <span class="stringliteral">&#39;immediate&#39;</span>: <span class="comment">// XXX handle properly</span>
<a name="l02827"></a>02827           this._animatingDeadDomNodes.push(cardInst.domNode);
<a name="l02828"></a>02828           <span class="keywordflow">break</span>;
<a name="l02829"></a>02829         <span class="keywordflow">case</span> <span class="stringliteral">&#39;none&#39;</span>:
<a name="l02830"></a>02830           cardInst.domNode.parentNode.removeChild(cardInst.domNode);
<a name="l02831"></a>02831           <span class="keywordflow">break</span>;
<a name="l02832"></a>02832       }
<a name="l02833"></a>02833     }
<a name="l02834"></a>02834   },
<a name="l02835"></a>02835 
<a name="l02839"></a>02839   removeAllCards: <span class="keyword">function</span>() {
<a name="l02840"></a>02840     <span class="keywordflow">return</span> this.removeCardAndSuccessors(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;none&#39;</span>);
<a name="l02841"></a>02841   },
<a name="l02842"></a>02842 
<a name="l02843"></a>02843   _showCard: <span class="keyword">function</span>(cardIndex, showMethod, navDirection) {
<a name="l02844"></a>02844     <span class="comment">// Do not do anything if this is a show card for the current card.</span>
<a name="l02845"></a>02845     <span class="keywordflow">if</span> (cardIndex === this.activeCardIndex) {
<a name="l02846"></a>02846       <span class="keywordflow">return</span>;
<a name="l02847"></a>02847     }
<a name="l02848"></a>02848 
<a name="l02849"></a>02849     <span class="keywordflow">if</span> (cardIndex &gt; this._cardStack.length - 1) {
<a name="l02850"></a>02850       <span class="comment">// Some cards were removed, adjust.</span>
<a name="l02851"></a>02851       cardIndex = this._cardStack.length - 1;
<a name="l02852"></a>02852     }
<a name="l02853"></a>02853     <span class="keywordflow">if</span> (this.activeCardIndex &gt; this._cardStack.length - 1) {
<a name="l02854"></a>02854       this.activeCardIndex = -1;
<a name="l02855"></a>02855     }
<a name="l02856"></a>02856 
<a name="l02857"></a>02857     <span class="keywordflow">if</span> (this.activeCardIndex === -1) {
<a name="l02858"></a>02858       this.activeCardIndex = cardIndex === 0 ? cardIndex : cardIndex - 1;
<a name="l02859"></a>02859     }
<a name="l02860"></a>02860 
<a name="l02861"></a>02861     var cardInst = (cardIndex !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) ? this._cardStack[cardIndex] : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02862"></a>02862     var beginNode = this._cardStack[this.activeCardIndex].domNode;
<a name="l02863"></a>02863     var endNode = this._cardStack[cardIndex].domNode;
<a name="l02864"></a>02864     var isForward = navDirection === <span class="stringliteral">&#39;forward&#39;</span>;
<a name="l02865"></a>02865 
<a name="l02866"></a>02866     <span class="keywordflow">if</span> (this._cardStack.length === 1) {
<a name="l02867"></a>02867       <span class="comment">// Reset zIndex so that it does not grow ever higher when all but</span>
<a name="l02868"></a>02868       <span class="comment">// one card are removed</span>
<a name="l02869"></a>02869       this._zIndex = 0;
<a name="l02870"></a>02870     }
<a name="l02871"></a>02871 
<a name="l02872"></a>02872     <span class="comment">// If going forward and it is an overlay node, then do not animate the</span>
<a name="l02873"></a>02873     <span class="comment">// beginning node, it will just sit under the overlay.</span>
<a name="l02874"></a>02874     <span class="keywordflow">if</span> (isForward &amp;&amp; endNode.classList.contains(<span class="stringliteral">&#39;anim-overlay&#39;</span>)) {
<a name="l02875"></a>02875       beginNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02876"></a>02876 
<a name="l02877"></a>02877       <span class="comment">// anim-overlays are the transitions to new layers in the stack. If</span>
<a name="l02878"></a>02878       <span class="comment">// starting a new one, it is forward movement and needs a new zIndex.</span>
<a name="l02879"></a>02879       <span class="comment">// Otherwise, going back to</span>
<a name="l02880"></a>02880       this._zIndex += 10;
<a name="l02881"></a>02881     }
<a name="l02882"></a>02882 
<a name="l02883"></a>02883     <span class="comment">// If going back and the beginning node was an overlay, do not animate</span>
<a name="l02884"></a>02884     <span class="comment">// the end node, since it should just be hidden under the overlay.</span>
<a name="l02885"></a>02885     <span class="keywordflow">if</span> (beginNode &amp;&amp; beginNode.classList.contains(<span class="stringliteral">&#39;anim-overlay&#39;</span>)) {
<a name="l02886"></a>02886       <span class="keywordflow">if</span> (isForward) {
<a name="l02887"></a>02887         <span class="comment">// If a forward animation and overlay had a vertical transition,</span>
<a name="l02888"></a>02888         <span class="comment">// disable it, use normal horizontal transition.</span>
<a name="l02889"></a>02889         <span class="keywordflow">if</span> (showMethod !== <span class="stringliteral">&#39;immediate&#39;</span> &amp;&amp;
<a name="l02890"></a>02890             beginNode.classList.contains(<span class="stringliteral">&#39;anim-vertical&#39;</span>)) {
<a name="l02891"></a>02891           removeClass(beginNode, <span class="stringliteral">&#39;anim-vertical&#39;</span>);
<a name="l02892"></a>02892           <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(beginNode, <span class="stringliteral">&#39;disabled-anim-vertical&#39;</span>);
<a name="l02893"></a>02893         }
<a name="l02894"></a>02894       } <span class="keywordflow">else</span> {
<a name="l02895"></a>02895         endNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02896"></a>02896         this._zIndex -= 10;
<a name="l02897"></a>02897       }
<a name="l02898"></a>02898     }
<a name="l02899"></a>02899 
<a name="l02900"></a>02900     <span class="comment">// If the zindex is not zero, then in an overlay stack, adjust zindex</span>
<a name="l02901"></a>02901     <span class="comment">// accordingly.</span>
<a name="l02902"></a>02902     <span class="keywordflow">if</span> (endNode &amp;&amp; isForward &amp;&amp; this._zIndex) {
<a name="l02903"></a>02903       endNode.style.zIndex = this._zIndex;
<a name="l02904"></a>02904     }
<a name="l02905"></a>02905 
<a name="l02906"></a>02906     var cardsNode = this._cardsNode;
<a name="l02907"></a>02907 
<a name="l02908"></a>02908     <span class="keywordflow">if</span> (showMethod === <span class="stringliteral">&#39;immediate&#39;</span>) {
<a name="l02909"></a>02909       <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(beginNode, <span class="stringliteral">&#39;no-anim&#39;</span>);
<a name="l02910"></a>02910       <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(endNode, <span class="stringliteral">&#39;no-anim&#39;</span>);
<a name="l02911"></a>02911 
<a name="l02912"></a>02912       <span class="comment">// make sure the reflow sees the transition is turned off.</span>
<a name="l02913"></a>02913       cardsNode.clientWidth;
<a name="l02914"></a>02914       <span class="comment">// explicitly clear since there will be no animation</span>
<a name="l02915"></a>02915       this._eatingEventsUntilNextCard = <span class="keyword">false</span>;
<a name="l02916"></a>02916     }
<a name="l02917"></a>02917     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (showMethod === <span class="stringliteral">&#39;none&#39;</span>) {
<a name="l02918"></a>02918       <span class="comment">// do not set _eatingEventsUntilNextCard, but don&#39;t clear it either.</span>
<a name="l02919"></a>02919     }
<a name="l02920"></a>02920     <span class="keywordflow">else</span> {
<a name="l02921"></a>02921       this._transitionCount = (beginNode &amp;&amp; endNode) ? 2 : 1;
<a name="l02922"></a>02922       this._eatingEventsUntilNextCard = <span class="keyword">true</span>;
<a name="l02923"></a>02923     }
<a name="l02924"></a>02924 
<a name="l02925"></a>02925     <span class="keywordflow">if</span> (this.activeCardIndex === cardIndex) {
<a name="l02926"></a>02926       <span class="comment">// same node, no transition, just bootstrapping UI.</span>
<a name="l02927"></a>02927       removeClass(beginNode, <span class="stringliteral">&#39;before&#39;</span>);
<a name="l02928"></a>02928       removeClass(beginNode, <span class="stringliteral">&#39;after&#39;</span>);
<a name="l02929"></a>02929       <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(beginNode, <span class="stringliteral">&#39;center&#39;</span>);
<a name="l02930"></a>02930     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (this.activeCardIndex &gt; cardIndex) {
<a name="l02931"></a>02931       <span class="comment">// back</span>
<a name="l02932"></a>02932       removeClass(beginNode, <span class="stringliteral">&#39;center&#39;</span>);
<a name="l02933"></a>02933       <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(beginNode, <span class="stringliteral">&#39;after&#39;</span>);
<a name="l02934"></a>02934 
<a name="l02935"></a>02935       removeClass(endNode, <span class="stringliteral">&#39;before&#39;</span>);
<a name="l02936"></a>02936       <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(endNode, <span class="stringliteral">&#39;center&#39;</span>);
<a name="l02937"></a>02937     } <span class="keywordflow">else</span> {
<a name="l02938"></a>02938       <span class="comment">// forward</span>
<a name="l02939"></a>02939       removeClass(beginNode, <span class="stringliteral">&#39;center&#39;</span>);
<a name="l02940"></a>02940       <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(beginNode, <span class="stringliteral">&#39;before&#39;</span>);
<a name="l02941"></a>02941 
<a name="l02942"></a>02942       removeClass(endNode, <span class="stringliteral">&#39;after&#39;</span>);
<a name="l02943"></a>02943       <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(endNode, <span class="stringliteral">&#39;center&#39;</span>);
<a name="l02944"></a>02944     }
<a name="l02945"></a>02945 
<a name="l02946"></a>02946     <span class="keywordflow">if</span> (showMethod === <span class="stringliteral">&#39;immediate&#39;</span>) {
<a name="l02947"></a>02947       <span class="comment">// make sure the instantaneous transition is seen before we turn</span>
<a name="l02948"></a>02948       <span class="comment">// transitions back on.</span>
<a name="l02949"></a>02949       cardsNode.clientWidth;
<a name="l02950"></a>02950 
<a name="l02951"></a>02951       removeClass(beginNode, <span class="stringliteral">&#39;no-anim&#39;</span>);
<a name="l02952"></a>02952       removeClass(endNode, <span class="stringliteral">&#39;no-anim&#39;</span>);
<a name="l02953"></a>02953 
<a name="l02954"></a>02954       <span class="keywordflow">if</span> (cardInst &amp;&amp; cardInst.onCardVisible)
<a name="l02955"></a>02955         cardInst.onCardVisible();
<a name="l02956"></a>02956     }
<a name="l02957"></a>02957 
<a name="l02958"></a>02958     <span class="comment">// Hide toaster while active card index changed:</span>
<a name="l02959"></a>02959     Toaster.hide();
<a name="l02960"></a>02960 
<a name="l02961"></a>02961     this.activeCardIndex = cardIndex;
<a name="l02962"></a>02962     <span class="keywordflow">if</span> (cardInst)
<a name="l02963"></a>02963       this._trayActive = cardInst.modeDef.tray;
<a name="l02964"></a>02964   },
<a name="l02965"></a>02965 
<a name="l02966"></a>02966   _onTransitionEnd: <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l02967"></a>02967     var activeCard = this._cardStack[this.activeCardIndex];
<a name="l02968"></a>02968     <span class="comment">// If no current card, this could be initial setup from cache, no valid</span>
<a name="l02969"></a>02969     <span class="comment">// cards yet, so bail.</span>
<a name="l02970"></a>02970     <span class="keywordflow">if</span> (!activeCard)
<a name="l02971"></a>02971       <span class="keywordflow">return</span>;
<a name="l02972"></a>02972 
<a name="l02973"></a>02973     <span class="comment">// Multiple cards can animate, so there can be multiple transitionend</span>
<a name="l02974"></a>02974     <span class="comment">// events. Only do the end work when all have finished animating.</span>
<a name="l02975"></a>02975     <span class="keywordflow">if</span> (this._transitionCount &gt; 0)
<a name="l02976"></a>02976       this._transitionCount -= 1;
<a name="l02977"></a>02977 
<a name="l02978"></a>02978     <span class="keywordflow">if</span> (this._transitionCount === 0) {
<a name="l02979"></a>02979       <span class="keywordflow">if</span> (this._eatingEventsUntilNextCard) {
<a name="l02980"></a>02980         this._eatingEventsUntilNextCard = <span class="keyword">false</span>;
<a name="l02981"></a>02981       }
<a name="l02982"></a>02982       <span class="keywordflow">if</span> (this._animatingDeadDomNodes.length) {
<a name="l02983"></a>02983         <span class="comment">// Use a setTimeout to give the animation some space to settle.</span>
<a name="l02984"></a>02984         <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() {
<a name="l02985"></a>02985           this._animatingDeadDomNodes.forEach(<span class="keyword">function</span>(domNode) {
<a name="l02986"></a>02986             <span class="keywordflow">if</span> (domNode.parentNode)
<a name="l02987"></a>02987               domNode.parentNode.removeChild(domNode);
<a name="l02988"></a>02988           });
<a name="l02989"></a>02989           this._animatingDeadDomNodes = [];
<a name="l02990"></a>02990         }.bind(<span class="keyword">this</span>), 100);
<a name="l02991"></a>02991       }
<a name="l02992"></a>02992 
<a name="l02993"></a>02993       <span class="comment">// If an vertical overlay transition was was disabled, if</span>
<a name="l02994"></a>02994       <span class="comment">// current node index is an overlay, enable it again.</span>
<a name="l02995"></a>02995       var endNode = activeCard.domNode;
<a name="l02996"></a>02996       <span class="keywordflow">if</span> (endNode.classList.contains(<span class="stringliteral">&#39;disabled-anim-vertical&#39;</span>)) {
<a name="l02997"></a>02997         removeClass(endNode, <span class="stringliteral">&#39;disabled-anim-vertical&#39;</span>);
<a name="l02998"></a>02998         <a class="code" href="../../d1/dce/utils_81_83_8js.html#ab2dd12912db5889a88d2afd001785fa7">addClass</a>(endNode, <span class="stringliteral">&#39;anim-vertical&#39;</span>);
<a name="l02999"></a>02999       }
<a name="l03000"></a>03000 
<a name="l03001"></a>03001       <span class="comment">// Popup toaster that pended for previous card view.</span>
<a name="l03002"></a>03002       var pendingToaster = Toaster.pendingStack.slice(-1)[0];
<a name="l03003"></a>03003       <span class="keywordflow">if</span> (pendingToaster) {
<a name="l03004"></a>03004         pendingToaster();
<a name="l03005"></a>03005         Toaster.pendingStack.pop();
<a name="l03006"></a>03006       }
<a name="l03007"></a>03007 
<a name="l03008"></a>03008       <span class="comment">// If any action to do at the end of transition trigger now.</span>
<a name="l03009"></a>03009       <span class="keywordflow">if</span> (this._afterTransitionAction) {
<a name="l03010"></a>03010         var afterTransitionAction = this._afterTransitionAction;
<a name="l03011"></a>03011         this._afterTransitionAction = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03012"></a>03012         afterTransitionAction();
<a name="l03013"></a>03013       }
<a name="l03014"></a>03014 
<a name="l03015"></a>03015       <span class="keywordflow">if</span> (activeCard.cardImpl.onCardVisible)
<a name="l03016"></a>03016         activeCard.cardImpl.onCardVisible();
<a name="l03017"></a>03017 
<a name="l03018"></a>03018       <span class="comment">// If the card has next cards that can be preloaded, load them now.</span>
<a name="l03019"></a>03019       <span class="comment">// Use of nextCards should be balanced with startup performance.</span>
<a name="l03020"></a>03020       <span class="comment">// nextCards can result in smoother transitions to new cards on first</span>
<a name="l03021"></a>03021       <span class="comment">// navigation to that new card type, but loading the extra module may</span>
<a name="l03022"></a>03022       <span class="comment">// also compete with current card and data model performance.</span>
<a name="l03023"></a>03023       var nextCards = activeCard.cardImpl.nextCards;
<a name="l03024"></a>03024       <span class="keywordflow">if</span> (nextCards) {
<a name="l03025"></a>03025         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Preloading cards: &#39;</span> + nextCards);
<a name="l03026"></a>03026         <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(nextCards.map(<span class="keyword">function</span>(<span class="keywordtype">id</span>) {
<a name="l03027"></a>03027           <span class="keywordflow">return</span> <span class="stringliteral">&#39;cards/&#39;</span> + <span class="keywordtype">id</span>;
<a name="l03028"></a>03028         }));
<a name="l03029"></a>03029       }
<a name="l03030"></a>03030     }
<a name="l03031"></a>03031   },
<a name="l03032"></a>03032 
<a name="l03047"></a>03047   eatEventsUntilNextCard: <span class="keyword">function</span>() {
<a name="l03048"></a>03048     this._eatingEventsUntilNextCard = <span class="keyword">true</span>;
<a name="l03049"></a>03049   },
<a name="l03050"></a>03050 
<a name="l03056"></a>03056   stopEatingEvents: <span class="keyword">function</span>() {
<a name="l03057"></a>03057     this._eatingEventsUntilNextCard = <span class="keyword">false</span>;
<a name="l03058"></a>03058   },
<a name="l03059"></a>03059 
<a name="l03065"></a>03065   assertNoCards: <span class="keyword">function</span>() {
<a name="l03066"></a>03066     <span class="keywordflow">if</span> (this._cardStack.length)
<a name="l03067"></a>03067       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;There are &#39;</span> + this._cardStack.length + <span class="stringliteral">&#39; cards but&#39;</span> +
<a name="l03068"></a>03068                       <span class="stringliteral">&#39; there should be ZERO&#39;</span>);
<a name="l03069"></a>03069   }
<a name="l03070"></a>03070 };
<a name="l03071"></a>03071 
<a name="l03076"></a>03076 Toaster = {
<a name="l03077"></a>03077   <span class="keyword">get</span> body() {
<a name="l03078"></a>03078     <span class="keyword">delete</span> this.body;
<a name="l03079"></a>03079     <span class="keywordflow">return</span> this.body =
<a name="l03080"></a>03080            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;section[role=&quot;status&quot;]&#39;</span>);
<a name="l03081"></a>03081   },
<a name="l03082"></a>03082   <span class="keyword">get</span> <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>() {
<a name="l03083"></a>03083     <span class="keyword">delete</span> this.<a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>;
<a name="l03084"></a>03084     <span class="keywordflow">return</span> this.<a class="code" href="../../dd/dfa/classtext.html">text</a> =
<a name="l03085"></a>03085            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;section[role=&quot;status&quot;] p&#39;</span>);
<a name="l03086"></a>03086   },
<a name="l03087"></a>03087   <span class="keyword">get</span> undoBtn() {
<a name="l03088"></a>03088     <span class="keyword">delete</span> this.undoBtn;
<a name="l03089"></a>03089     <span class="keywordflow">return</span> this.undoBtn =
<a name="l03090"></a>03090            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;.toaster-banner-undo&#39;</span>);
<a name="l03091"></a>03091   },
<a name="l03092"></a>03092   <span class="keyword">get</span> retryBtn() {
<a name="l03093"></a>03093     <span class="keyword">delete</span> this.retryBtn;
<a name="l03094"></a>03094     <span class="keywordflow">return</span> this.retryBtn =
<a name="l03095"></a>03095            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;.toaster-banner-retry&#39;</span>);
<a name="l03096"></a>03096   },
<a name="l03097"></a>03097 
<a name="l03098"></a>03098   undoableOp: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03099"></a>03099   retryCallback: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03100"></a>03100 
<a name="l03104"></a>03104   _timeout: 5000,
<a name="l03108"></a>03108   _animationHandler: <span class="keyword">function</span>() {
<a name="l03109"></a>03109     this.body.addEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <span class="keyword">this</span>, <span class="keyword">false</span>);
<a name="l03110"></a>03110     this.body.classList.add(<span class="stringliteral">&#39;fadeout&#39;</span>);
<a name="l03111"></a>03111   },
<a name="l03118"></a>03118   _listeners: [],
<a name="l03119"></a>03119 
<a name="l03120"></a>03120   pendingStack: [],
<a name="l03121"></a>03121 
<a name="l03132"></a>03132   logMutation: <span class="keyword">function</span>(undoableOp, pending) {
<a name="l03133"></a>03133     <span class="keywordflow">if</span> (pending) {
<a name="l03134"></a>03134       this.pendingStack.push(this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a849945b83cbf2e6fcd68a90c133c1824">show</a>.bind(<span class="keyword">this</span>, <span class="stringliteral">&#39;undo&#39;</span>, undoableOp));
<a name="l03135"></a>03135     } <span class="keywordflow">else</span> {
<a name="l03136"></a>03136       this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a849945b83cbf2e6fcd68a90c133c1824">show</a>(<span class="stringliteral">&#39;undo&#39;</span>, undoableOp);
<a name="l03137"></a>03137     }
<a name="l03138"></a>03138   },
<a name="l03139"></a>03139 
<a name="l03144"></a>03144   logRetryable: <span class="keyword">function</span>(retryStringId, retryCallback) {
<a name="l03145"></a>03145     this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a849945b83cbf2e6fcd68a90c133c1824">show</a>(<span class="stringliteral">&#39;retry&#39;</span>, retryStringId, retryCallback);
<a name="l03146"></a>03146   },
<a name="l03147"></a>03147 
<a name="l03148"></a>03148   <a class="code" href="../../dd/d6d/mock__spinner_8js.html#a7773a8226815156633260eafd5fc229e">handleEvent</a>: <span class="keyword">function</span>(evt) {
<a name="l03149"></a>03149     <span class="keywordflow">switch</span> (evt.type) {
<a name="l03150"></a>03150       <span class="keywordflow">case</span> <span class="stringliteral">&#39;click&#39;</span> :
<a name="l03151"></a>03151         var classList = evt.target.classList;
<a name="l03152"></a>03152         <span class="keywordflow">if</span> (classList.contains(<span class="stringliteral">&#39;toaster-banner-undo&#39;</span>)) {
<a name="l03153"></a>03153           this.undoableOp.undo();
<a name="l03154"></a>03154           this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a28d5a0efd4d16e885ff9a16e6b30a6a2">hide</a>();
<a name="l03155"></a>03155         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (classList.contains(<span class="stringliteral">&#39;toaster-banner-retry&#39;</span>)) {
<a name="l03156"></a>03156           <span class="keywordflow">if</span> (this.retryCallback)
<a name="l03157"></a>03157             this.retryCallback();
<a name="l03158"></a>03158           this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a28d5a0efd4d16e885ff9a16e6b30a6a2">hide</a>();
<a name="l03159"></a>03159         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (classList.contains(<span class="stringliteral">&#39;toaster-cancel-btn&#39;</span>)) {
<a name="l03160"></a>03160           this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a28d5a0efd4d16e885ff9a16e6b30a6a2">hide</a>();
<a name="l03161"></a>03161         }
<a name="l03162"></a>03162         <span class="keywordflow">break</span>;
<a name="l03163"></a>03163       <span class="keywordflow">case</span> <span class="stringliteral">&#39;transitionend&#39;</span> :
<a name="l03164"></a>03164         this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a28d5a0efd4d16e885ff9a16e6b30a6a2">hide</a>();
<a name="l03165"></a>03165         <span class="keywordflow">break</span>;
<a name="l03166"></a>03166     }
<a name="l03167"></a>03167   },
<a name="l03168"></a>03168 
<a name="l03169"></a>03169   <a class="code" href="../../d4/dc5/handled__call_8js.html#a849945b83cbf2e6fcd68a90c133c1824">show</a>: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, operation, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03170"></a>03170     <span class="comment">// Close previous toaster before showing the new one.</span>
<a name="l03171"></a>03171     <span class="keywordflow">if</span> (!this.body.classList.contains(<span class="stringliteral">&#39;collapsed&#39;</span>)) {
<a name="l03172"></a>03172       this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a28d5a0efd4d16e885ff9a16e6b30a6a2">hide</a>();
<a name="l03173"></a>03173     }
<a name="l03174"></a>03174 
<a name="l03175"></a>03175     var <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>, textId, showUndo = <span class="keyword">false</span>;
<a name="l03176"></a>03176     var undoBtn = this.body.querySelector(<span class="stringliteral">&#39;.toaster-banner-undo&#39;</span>);
<a name="l03177"></a>03177     <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;undo&#39;</span>) {
<a name="l03178"></a>03178       this.undoableOp = operation;
<a name="l03179"></a>03179       <span class="comment">// There is no need to show toaster if affected message count &lt; 1</span>
<a name="l03180"></a>03180       <span class="keywordflow">if</span> (!this.undoableOp || this.undoableOp.affectedCount &lt; 1) {
<a name="l03181"></a>03181         <span class="keywordflow">return</span>;
<a name="l03182"></a>03182       }
<a name="l03183"></a>03183       textId = <span class="stringliteral">&#39;toaster-message-&#39;</span> + this.undoableOp.operation;
<a name="l03184"></a>03184       text = <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(textId, { <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>: this.undoableOp.affectedCount });
<a name="l03185"></a>03185       <span class="comment">// https://bugzilla.mozilla.org/show_bug.cgi?id=804916</span>
<a name="l03186"></a>03186       <span class="comment">// Remove undo email move/delete UI for V1.</span>
<a name="l03187"></a>03187       showUndo = (this.undoableOp.operation !== <span class="stringliteral">&#39;move&#39;</span> &amp;&amp;
<a name="l03188"></a>03188                   this.undoableOp.operation !== <span class="stringliteral">&#39;delete&#39;</span>);
<a name="l03189"></a>03189     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;retry&#39;</span>) {
<a name="l03190"></a>03190       textId = <span class="stringliteral">&#39;toaster-retryable-&#39;</span> + operation;
<a name="l03191"></a>03191       text = <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(textId);
<a name="l03192"></a>03192       this.retryCallback = <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>;
<a name="l03193"></a>03193     <span class="comment">// XXX I assume this is for debug purposes?</span>
<a name="l03194"></a>03194     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;text&#39;</span>) {
<a name="l03195"></a>03195       text = operation;
<a name="l03196"></a>03196     }
<a name="l03197"></a>03197 
<a name="l03198"></a>03198     <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;undo&#39;</span> &amp;&amp; showUndo)
<a name="l03199"></a>03199       this.undoBtn.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l03200"></a>03200     <span class="keywordflow">else</span>
<a name="l03201"></a>03201       this.undoBtn.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l03202"></a>03202     <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;retry&#39;</span>)
<a name="l03203"></a>03203       this.retryBtn.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l03204"></a>03204     <span class="keywordflow">else</span>
<a name="l03205"></a>03205       this.retryBtn.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l03206"></a>03206 
<a name="l03207"></a>03207     this.body.title = <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>;
<a name="l03208"></a>03208     this.text.textContent = <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>;
<a name="l03209"></a>03209     this.body.addEventListener(<span class="stringliteral">&#39;click&#39;</span>, <span class="keyword">this</span>, <span class="keyword">false</span>);
<a name="l03210"></a>03210     this.body.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l03211"></a>03211     this.fadeTimeout = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(this._animationHandler.bind(<span class="keyword">this</span>),
<a name="l03212"></a>03212                                          this._timeout);
<a name="l03213"></a>03213   },
<a name="l03214"></a>03214 
<a name="l03215"></a>03215   <a class="code" href="../../d4/dc5/handled__call_8js.html#a28d5a0efd4d16e885ff9a16e6b30a6a2">hide</a>: <span class="keyword">function</span>() {
<a name="l03216"></a>03216     this.body.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l03217"></a>03217     this.body.classList.remove(<span class="stringliteral">&#39;fadeout&#39;</span>);
<a name="l03218"></a>03218     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.clearTimeout(this.fadeTimeout);
<a name="l03219"></a>03219     this.fadeTimeout = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03220"></a>03220     this.body.removeEventListener(<span class="stringliteral">&#39;click&#39;</span>, <span class="keyword">this</span>);
<a name="l03221"></a>03221     this.body.removeEventListener(<span class="stringliteral">&#39;transitionend&#39;</span>, <span class="keyword">this</span>);
<a name="l03222"></a>03222 
<a name="l03223"></a>03223     <span class="comment">// Clear operations:</span>
<a name="l03224"></a>03224     this.undoableOp = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03225"></a>03225     this.retryCallback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03226"></a>03226   }
<a name="l03227"></a>03227 };
<a name="l03228"></a>03228 
<a name="l03234"></a>03234 var <a class="code" href="../../d3/d42/camera_2js_2confirm_8js.html#a62ff52c410e9de0d9973e5297755e83c">ConfirmDialog</a> = {
<a name="l03235"></a>03235   <a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03236"></a>03236   <a class="code" href="../../d4/dc5/handled__call_8js.html#a849945b83cbf2e6fcd68a90c133c1824">show</a>: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a>, <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#ab77aa8c2fa705d45d7ff1db3a11306ae">confirm</a>, <a class="code" href="../../dc/d35/inline-receiver_8js.html#a01de14b323a40639980004403daa8432">cancel</a>) {
<a name="l03237"></a>03237     this.<a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a>;
<a name="l03238"></a>03238     var formSubmit = <span class="keyword">function</span>(evt) {
<a name="l03239"></a>03239       this.<a class="code" href="../../d4/dc5/handled__call_8js.html#a28d5a0efd4d16e885ff9a16e6b30a6a2">hide</a>();
<a name="l03240"></a>03240       <span class="keywordflow">switch</span> (evt.explicitOriginalTarget.id) {
<a name="l03241"></a>03241         <span class="keywordflow">case</span> confirm.id:
<a name="l03242"></a>03242           confirm.handler();
<a name="l03243"></a>03243           <span class="keywordflow">break</span>;
<a name="l03244"></a>03244         <span class="keywordflow">case</span> <a class="code" href="../../dc/d35/inline-receiver_8js.html#a01de14b323a40639980004403daa8432">cancel</a>.id:
<a name="l03245"></a>03245           <span class="keywordflow">if</span> (<a class="code" href="../../dc/d35/inline-receiver_8js.html#a01de14b323a40639980004403daa8432">cancel</a>.handler)
<a name="l03246"></a>03246             <a class="code" href="../../dc/d35/inline-receiver_8js.html#a01de14b323a40639980004403daa8432">cancel</a>.handler();
<a name="l03247"></a>03247           <span class="keywordflow">break</span>;
<a name="l03248"></a>03248       }
<a name="l03249"></a>03249       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03250"></a>03250     };
<a name="l03251"></a>03251     <a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a>.addEventListener(<span class="stringliteral">&#39;submit&#39;</span>, formSubmit.bind(<span class="keyword">this</span>));
<a name="l03252"></a>03252     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.body.appendChild(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a>);
<a name="l03253"></a>03253   },
<a name="l03254"></a>03254   <a class="code" href="../../d4/dc5/handled__call_8js.html#a28d5a0efd4d16e885ff9a16e6b30a6a2">hide</a>: <span class="keyword">function</span>() {
<a name="l03255"></a>03255     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.body.removeChild(this.<a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a>);
<a name="l03256"></a>03256   }
<a name="l03257"></a>03257 };
<a name="l03259"></a>03259 <span class="comment">// Attachment Formatting Helpers</span>
<a name="l03260"></a>03260 
<a name="l03266"></a>03266 <span class="keyword">function</span> prettyFileSize(sizeInBytes) {
<a name="l03267"></a>03267   var kilos = Math.ceil(sizeInBytes / 1024);
<a name="l03268"></a>03268   <span class="keywordflow">return</span> <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;attachment-size-kib&#39;</span>, { kilobytes: kilos });
<a name="l03269"></a>03269 }
<a name="l03270"></a>03270 
<a name="l03274"></a>03274 <span class="keyword">function</span> prettyDate(<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>, useCompactFormat) {
<a name="l03275"></a>03275   var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a9cf09a2972472098a4c689fd988f4dfc">f</a> = <span class="keyword">new</span> <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.DateTimeFormat();
<a name="l03276"></a>03276   <span class="keywordflow">return</span> f.fromNow(<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>, useCompactFormat);
<a name="l03277"></a>03277 }
<a name="l03278"></a>03278 
<a name="l03279"></a>03279 (<span class="keyword">function</span>() {
<a name="l03280"></a>03280   var formatter = <span class="keyword">new</span> <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.DateTimeFormat();
<a name="l03281"></a>03281   var updatePrettyDate = <span class="keyword">function</span> updatePrettyDate() {
<a name="l03282"></a>03282     var labels = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelectorAll(<span class="stringliteral">&#39;[data-time]&#39;</span>);
<a name="l03283"></a>03283     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = labels.length;
<a name="l03284"></a>03284     <span class="keywordflow">while</span> (i--) {
<a name="l03285"></a>03285       labels[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].textContent = formatter.fromNow(
<a name="l03286"></a>03286         labels[i].dataset.time,
<a name="l03287"></a>03287         <span class="comment">// the presence of the attribute is our indicator; not its value</span>
<a name="l03288"></a>03288         <span class="stringliteral">&#39;compactFormat&#39;</span> in labels[i].dataset);
<a name="l03289"></a>03289     }
<a name="l03290"></a>03290   };
<a name="l03291"></a>03291   var timer = <a class="code" href="../../da/da1/timers_8js.html#a810d0ceb38081cd3ca4c39b096dcaa26">setInterval</a>(updatePrettyDate, 60 * 1000);
<a name="l03292"></a>03292 
<a name="l03293"></a>03293   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;message&#39;</span>, <span class="keyword">function</span> visibleAppUpdatePrettyDate(evt) {
<a name="l03294"></a>03294     var <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = evt.data;
<a name="l03295"></a>03295     <span class="keywordflow">if</span> (!data || (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(data) !== <span class="stringliteral">&#39;object&#39;</span>) ||
<a name="l03296"></a>03296         !(<span class="stringliteral">&#39;message&#39;</span> in data) || data.message !== <span class="stringliteral">&#39;visibilitychange&#39;</span>)
<a name="l03297"></a>03297       <span class="keywordflow">return</span>;
<a name="l03298"></a>03298     <a class="code" href="../../da/da1/timers_8js.html#ab37ff0db33a3bf80b0163adc40a58424">clearTimeout</a>(timer);
<a name="l03299"></a>03299     <span class="keywordflow">if</span> (!data.hidden) {
<a name="l03300"></a>03300       updatePrettyDate();
<a name="l03301"></a>03301       timer = <a class="code" href="../../da/da1/timers_8js.html#a810d0ceb38081cd3ca4c39b096dcaa26">setInterval</a>(updatePrettyDate, 60 * 1000);
<a name="l03302"></a>03302     }
<a name="l03303"></a>03303   });
<a name="l03304"></a>03304 })();
<a name="l03305"></a>03305 
<a name="l03307"></a>03307 
<a name="l03321"></a>03321 <span class="keyword">function</span> FormNavigation(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>) {
<a name="l03322"></a>03322   <span class="keyword">function</span> <a class="code" href="../../d1/d83/toolkit_8js.html#a97d2dfc7eacd4130836f6cf8b6766d1e">extend</a>(destination, source) {
<a name="l03323"></a>03323     <span class="keywordflow">for</span> (var property in source)
<a name="l03324"></a>03324       destination[property] = source[property];
<a name="l03325"></a>03325     <span class="keywordflow">return</span> destination;
<a name="l03326"></a>03326   }
<a name="l03327"></a>03327 
<a name="l03328"></a>03328   <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.formElem) {
<a name="l03329"></a>03329     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;The form element should be defined.&#39;</span>);
<a name="l03330"></a>03330   }
<a name="l03331"></a>03331 
<a name="l03332"></a>03332   var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l03333"></a>03333   this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = <a class="code" href="../../d1/d83/toolkit_8js.html#a97d2dfc7eacd4130836f6cf8b6766d1e">extend</a>({
<a name="l03334"></a>03334     formElem: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03335"></a>03335     checkFormValidity: <span class="keyword">function</span> checkFormValidity() {
<a name="l03336"></a>03336       <span class="keywordflow">return</span> <span class="keyword">self</span>.options.formElem.checkValidity();
<a name="l03337"></a>03337     },
<a name="l03338"></a>03338     onLast: <span class="keyword">function</span>() {}
<a name="l03339"></a>03339   }, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>);
<a name="l03340"></a>03340 
<a name="l03341"></a>03341   this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.formElem.addEventListener(<span class="stringliteral">&#39;keypress&#39;</span>,
<a name="l03342"></a>03342     this.onKeyPress.bind(<span class="keyword">this</span>));
<a name="l03343"></a>03343 }
<a name="l03344"></a>03344 
<a name="l03345"></a>03345 FormNavigation.prototype = {
<a name="l03346"></a>03346   onKeyPress: <span class="keyword">function</span> formNav_onKeyPress(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l03347"></a>03347     <span class="keywordflow">if</span> (<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.keyCode === 13) {
<a name="l03348"></a>03348       <span class="comment">// If the user hit enter, focus the next form element, or, if the current</span>
<a name="l03349"></a>03349       <span class="comment">// element is the last one and the form is valid, submit the form.</span>
<a name="l03350"></a>03350       var nextInput = this.focusNextInput(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>);
<a name="l03351"></a>03351       <span class="keywordflow">if</span> (!nextInput &amp;&amp; this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.checkFormValidity()) {
<a name="l03352"></a>03352         this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.onLast();
<a name="l03353"></a>03353       }
<a name="l03354"></a>03354     }
<a name="l03355"></a>03355   },
<a name="l03356"></a>03356 
<a name="l03357"></a>03357   focusNextInput: <span class="keyword">function</span> formNav_focusNextInput(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l03358"></a>03358     var currentInput = <span class="keyword">event</span>.target;
<a name="l03359"></a>03359     var inputElems = this.<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.formElem.getElementsByTagName(<span class="stringliteral">&#39;input&#39;</span>);
<a name="l03360"></a>03360     var currentInputFound = <span class="keyword">false</span>;
<a name="l03361"></a>03361 
<a name="l03362"></a>03362     <span class="keywordflow">for</span> (var i = 0; i &lt; inputElems.length; i++) {
<a name="l03363"></a>03363       var <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a> = inputElems[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03364"></a>03364       <span class="keywordflow">if</span> (currentInput === input) {
<a name="l03365"></a>03365         currentInputFound = <span class="keyword">true</span>;
<a name="l03366"></a>03366         <span class="keywordflow">continue</span>;
<a name="l03367"></a>03367       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!currentInputFound) {
<a name="l03368"></a>03368         <span class="keywordflow">continue</span>;
<a name="l03369"></a>03369       }
<a name="l03370"></a>03370 
<a name="l03371"></a>03371       <span class="keywordflow">if</span> (input.type === <span class="stringliteral">&#39;hidden&#39;</span> || input.type === <span class="stringliteral">&#39;button&#39;</span>) {
<a name="l03372"></a>03372         <span class="keywordflow">continue</span>;
<a name="l03373"></a>03373       }
<a name="l03374"></a>03374 
<a name="l03375"></a>03375       input.focus();
<a name="l03376"></a>03376       <span class="keywordflow">if</span> (<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.activeElement !== input) {
<a name="l03377"></a>03377         <span class="comment">// We couldn&#39;t focus the element we wanted.  Try with the next one.</span>
<a name="l03378"></a>03378         <span class="keywordflow">continue</span>;
<a name="l03379"></a>03379       }
<a name="l03380"></a>03380       <span class="keywordflow">return</span> <a class="code" href="../../d6/da7/wire__format__lite_8h.html#a2965939d8d22ec60c89f74062f0c370c">input</a>;
<a name="l03381"></a>03381     }
<a name="l03382"></a>03382 
<a name="l03383"></a>03383     <span class="comment">// If we couldn&#39;t find anything to focus, just blur the initial element.</span>
<a name="l03384"></a>03384     currentInput.blur();
<a name="l03385"></a>03385     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03386"></a>03386   }
<a name="l03387"></a>03387 };
<a name="l03388"></a>03388 
<a name="l03396"></a>03396 <span class="keyword">function</span> displaySubject(subjectNode, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>) {
<a name="l03397"></a>03397   var <a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>.subject &amp;&amp; <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>.subject.trim();
<a name="l03398"></a>03398   <span class="keywordflow">if</span> (subject) {
<a name="l03399"></a>03399     subjectNode.textContent = <a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a>;
<a name="l03400"></a>03400     subjectNode.classList.remove(<span class="stringliteral">&#39;msg-no-subject&#39;</span>);
<a name="l03401"></a>03401   }
<a name="l03402"></a>03402   <span class="keywordflow">else</span> {
<a name="l03403"></a>03403     subjectNode.textContent = <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;message-no-subject&#39;</span>);
<a name="l03404"></a>03404     subjectNode.classList.add(<span class="stringliteral">&#39;msg-no-subject&#39;</span>);
<a name="l03405"></a>03405   }
<a name="l03406"></a>03406 }
<a name="l03407"></a>03407 
<a name="l03408"></a>03408 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.Cards = Cards;
<a name="l03409"></a>03409 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.Toaster = Toaster;
<a name="l03410"></a>03410 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ConfirmDialog = <a class="code" href="../../d3/d42/camera_2js_2confirm_8js.html#a62ff52c410e9de0d9973e5297755e83c">ConfirmDialog</a>;
<a name="l03411"></a>03411 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.FormNavigation = FormNavigation;
<a name="l03412"></a>03412 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.prettyDate = prettyDate;
<a name="l03413"></a>03413 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.prettyFileSize = prettyFileSize;
<a name="l03414"></a>03414 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.batchAddClass = batchAddClass;
<a name="l03415"></a>03415 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.bindContainerClickAndHold = bindContainerClickAndHold;
<a name="l03416"></a>03416 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.bindContainerHandler = bindContainerHandler;
<a name="l03417"></a>03417 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.appendMatchItemTo = appendMatchItemTo;
<a name="l03418"></a>03418 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.bindContainerHandler = bindContainerHandler;
<a name="l03419"></a>03419 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.displaySubject = displaySubject;
<a name="l03420"></a>03420 });
<a name="l03421"></a>03421 
<a name="l03422"></a>03422 <span class="comment">/*global define, console */</span>
<a name="l03423"></a>03423 
<a name="l03424"></a>03424 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;model&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;evt&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>) {
<a name="l03425"></a>03425   var evt = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;evt&#39;</span>);
<a name="l03426"></a>03426 
<a name="l03427"></a>03427   <span class="keyword">function</span> dieOnFatalError(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l03428"></a>03428     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;FATAL:&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>);
<a name="l03429"></a>03429     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>);
<a name="l03430"></a>03430   }
<a name="l03431"></a>03431 
<a name="l03454"></a>03454   var <a class="code" href="../../d9/d04/expat_8h.html#ac517f0c27408fbd365e7dd34e032faca">model</a> = {
<a name="l03455"></a>03455     firstRun: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03456"></a>03456 
<a name="l03462"></a>03462     acctsSlice: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03463"></a>03463 
<a name="l03469"></a>03469     account: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03470"></a>03470 
<a name="l03476"></a>03476     foldersSlice: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03477"></a>03477 
<a name="l03483"></a>03483     folder: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03484"></a>03484 
<a name="l03485"></a>03485     _callEmit: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>) {
<a name="l03486"></a>03486       this.emitWhenListener(<span class="keywordtype">id</span>, <span class="keyword">this</span>[<span class="keywordtype">id</span>]);
<a name="l03487"></a>03487     },
<a name="l03488"></a>03488 
<a name="l03489"></a>03489     inited: <span class="keyword">false</span>,
<a name="l03490"></a>03490 
<a name="l03495"></a>03495     hasAccount: <span class="keyword">function</span>() {
<a name="l03496"></a>03496       <span class="keywordflow">return</span> !!(model.acctsSlice &amp;&amp;
<a name="l03497"></a>03497                 model.acctsSlice.items &amp;&amp;
<a name="l03498"></a>03498                 model.acctsSlice.items.length);
<a name="l03499"></a>03499     },
<a name="l03500"></a>03500 
<a name="l03508"></a>03508     getAccount: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>) {
<a name="l03509"></a>03509       <span class="keywordflow">if</span> (!model.acctsSlice || !model.acctsSlice.items)
<a name="l03510"></a>03510         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;No acctsSlice available&#39;</span>);
<a name="l03511"></a>03511 
<a name="l03512"></a>03512       var targetAccount;
<a name="l03513"></a>03513       model.acctsSlice.items.some(<span class="keyword">function</span>(account) {
<a name="l03514"></a>03514         <span class="keywordflow">if</span> (account.id === <span class="keywordtype">id</span>)
<a name="l03515"></a>03515           <span class="keywordflow">return</span> !!(targetAccount = account);
<a name="l03516"></a>03516       });
<a name="l03517"></a>03517 
<a name="l03518"></a>03518       <span class="keywordflow">return</span> targetAccount;
<a name="l03519"></a>03519     },
<a name="l03520"></a>03520 
<a name="l03529"></a>03529     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(showLatest, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03530"></a>03530       <span class="comment">// Set inited to false to indicate initialization is in progress.</span>
<a name="l03531"></a>03531       this.inited = <span class="keyword">false</span>;
<a name="l03532"></a>03532       <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>([<span class="stringliteral">&#39;api&#39;</span>], <span class="keyword">function</span>(MailAPI) {
<a name="l03533"></a>03533         <span class="keywordflow">if</span> (!this.api) {
<a name="l03534"></a>03534           this.api = MailAPI;
<a name="l03535"></a>03535           this._callEmit(<span class="stringliteral">&#39;api&#39;</span>, this.api);
<a name="l03536"></a>03536         }
<a name="l03537"></a>03537 
<a name="l03538"></a>03538         <span class="comment">// If already initialized before, clear out previous state.</span>
<a name="l03539"></a>03539         this.<a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>();
<a name="l03540"></a>03540 
<a name="l03541"></a>03541         var acctsSlice = this.acctsSlice = MailAPI.viewAccounts(<span class="keyword">false</span>);
<a name="l03542"></a>03542         acctsSlice.oncomplete = (<span class="keyword">function</span>() {
<a name="l03543"></a>03543           <span class="keywordflow">if</span> (acctsSlice.items.length) {
<a name="l03544"></a>03544             <span class="comment">// For now, just use the first one; we do attempt to put unified</span>
<a name="l03545"></a>03545             <span class="comment">// first so this should generally do the right thing.</span>
<a name="l03546"></a>03546             <span class="comment">// XXX: Because we don&#39;t have unified account now, we should</span>
<a name="l03547"></a>03547             <span class="comment">//      switch to the latest account which user just added.</span>
<a name="l03548"></a>03548             var account = showLatest ? acctsSlice.items.slice(-1)[0] :
<a name="l03549"></a>03549                                        acctsSlice.defaultAccount;
<a name="l03550"></a>03550 
<a name="l03551"></a>03551             this.changeAccount(account, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l03552"></a>03552           }
<a name="l03553"></a>03553 
<a name="l03554"></a>03554           this.inited = <span class="keyword">true</span>;
<a name="l03555"></a>03555           this._callEmit(<span class="stringliteral">&#39;acctsSlice&#39;</span>);
<a name="l03556"></a>03556         }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>);
<a name="l03557"></a>03557       }.bind(<span class="keyword">this</span>));
<a name="l03558"></a>03558     },
<a name="l03559"></a>03559 
<a name="l03567"></a>03567     changeAccount: <span class="keyword">function</span>(account, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03568"></a>03568       <span class="comment">// Do not bother if account is the same.</span>
<a name="l03569"></a>03569       <span class="keywordflow">if</span> (this.account &amp;&amp; this.account.id === account.id) {
<a name="l03570"></a>03570         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>)
<a name="l03571"></a>03571           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l03572"></a>03572         <span class="keywordflow">return</span>;
<a name="l03573"></a>03573       }
<a name="l03574"></a>03574 
<a name="l03575"></a>03575       this._dieFolders();
<a name="l03576"></a>03576 
<a name="l03577"></a>03577       this.account = account;
<a name="l03578"></a>03578       this._callEmit(<span class="stringliteral">&#39;account&#39;</span>);
<a name="l03579"></a>03579 
<a name="l03580"></a>03580       var foldersSlice = this.api.viewFolders(<span class="stringliteral">&#39;account&#39;</span>, account);
<a name="l03581"></a>03581       foldersSlice.oncomplete = (<span class="keyword">function</span>() {
<a name="l03582"></a>03582         this.foldersSlice = foldersSlice;
<a name="l03583"></a>03583         this.selectInbox(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l03584"></a>03584         this._callEmit(<span class="stringliteral">&#39;foldersSlice&#39;</span>);
<a name="l03585"></a>03585       }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>);
<a name="l03586"></a>03586     },
<a name="l03587"></a>03587 
<a name="l03593"></a>03593     changeAccountFromId: <span class="keyword">function</span>(accountId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03594"></a>03594       <span class="keywordflow">if</span> (!this.acctsSlice || !this.acctsSlice.items.length)
<a name="l03595"></a>03595         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;No accounts available&#39;</span>);
<a name="l03596"></a>03596 
<a name="l03597"></a>03597       this.acctsSlice.items.some(<span class="keyword">function</span>(account) {
<a name="l03598"></a>03598         <span class="keywordflow">if</span> (account.id === accountId) {
<a name="l03599"></a>03599           <span class="keyword">this</span>.changeAccount(account, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l03600"></a>03600           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03601"></a>03601         }
<a name="l03602"></a>03602       }.bind(<span class="keyword">this</span>));
<a name="l03603"></a>03603     },
<a name="l03604"></a>03604 
<a name="l03611"></a>03611     changeFolder: <span class="keyword">function</span>(folder) {
<a name="l03612"></a>03612       this.folder = folder;
<a name="l03613"></a>03613       this._callEmit(<span class="stringliteral">&#39;folder&#39;</span>);
<a name="l03614"></a>03614     },
<a name="l03615"></a>03615 
<a name="l03622"></a>03622     selectInbox: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03623"></a>03623       <span class="keywordflow">if</span> (!this.foldersSlice)
<a name="l03624"></a>03624         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;No foldersSlice available&#39;</span>);
<a name="l03625"></a>03625 
<a name="l03626"></a>03626       var inboxFolder = this.foldersSlice.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>);
<a name="l03627"></a>03627       <span class="keywordflow">if</span> (!inboxFolder)
<a name="l03628"></a>03628         dieOnFatalError(<span class="stringliteral">&#39;We have an account without an inbox!&#39;</span>,
<a name="l03629"></a>03629                         this.foldersSlice.items);
<a name="l03630"></a>03630 
<a name="l03631"></a>03631       <span class="keywordflow">if</span> (this.folder &amp;&amp; this.folder.id === inboxFolder.id) {
<a name="l03632"></a>03632         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>)
<a name="l03633"></a>03633           <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l03634"></a>03634       } <span class="keywordflow">else</span> {
<a name="l03635"></a>03635         <span class="keywordflow">if</span> (<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>)
<a name="l03636"></a>03636           this.<a class="code" href="../../de/dfc/events_8js.html#a801b0668ecf79a79c81f75dbbabb4ebf">once</a>(<span class="stringliteral">&#39;folder&#39;</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l03637"></a>03637 
<a name="l03638"></a>03638         this.changeFolder(inboxFolder);
<a name="l03639"></a>03639       }
<a name="l03640"></a>03640     },
<a name="l03641"></a>03641 
<a name="l03649"></a>03649     notifyInboxMessages: <span class="keyword">function</span>(accountUpdate) {
<a name="l03650"></a>03650       <span class="keywordflow">if</span> (accountUpdate.id === <span class="keyword">this</span>.account.id)
<a name="l03651"></a>03651         model.emit(<span class="stringliteral">&#39;newInboxMessages&#39;</span>, accountUpdate.count);
<a name="l03652"></a>03652     },
<a name="l03653"></a>03653 
<a name="l03654"></a>03654     _dieFolders: <span class="keyword">function</span>() {
<a name="l03655"></a>03655       <span class="keywordflow">if</span> (this.foldersSlice)
<a name="l03656"></a>03656         this.foldersSlice.die();
<a name="l03657"></a>03657       this.foldersSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03658"></a>03658 
<a name="l03659"></a>03659       this.folder = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03660"></a>03660     },
<a name="l03661"></a>03661 
<a name="l03662"></a>03662     <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span>() {
<a name="l03663"></a>03663       <span class="keywordflow">if</span> (this.acctsSlice)
<a name="l03664"></a>03664         this.acctsSlice.die();
<a name="l03665"></a>03665       this.acctsSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03666"></a>03666       this.account = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03667"></a>03667 
<a name="l03668"></a>03668       this._dieFolders();
<a name="l03669"></a>03669     }
<a name="l03670"></a>03670   };
<a name="l03671"></a>03671 
<a name="l03672"></a>03672   <span class="keywordflow">return</span> evt.mix(model);
<a name="l03673"></a>03673 });
<a name="l03674"></a>03674 
<a name="l03675"></a>03675 <span class="comment">/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- /</span>
<a name="l03676"></a>03676 <span class="comment">/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */</span>
<a name="l03677"></a>03677 
<a name="l03678"></a>03678 
<a name="l03679"></a>03679 
<a name="l03685"></a><a class="code" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html#ace607ad6a39fc866ed0cc75f0e085e04">03685</a> var <a class="code" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html#ace607ad6a39fc866ed0cc75f0e085e04">NotificationHelper</a> = {
<a name="l03686"></a>03686   _referencesArray: [],
<a name="l03687"></a>03687 
<a name="l03688"></a>03688   getIconURI: <span class="keyword">function</span> nc_getIconURI(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a7b225fcb720e4d5ed2bbf60e28a25e6d">app</a>, entryPoint) {
<a name="l03689"></a>03689     var icons = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a7b225fcb720e4d5ed2bbf60e28a25e6d">app</a>.manifest.icons;
<a name="l03690"></a>03690 
<a name="l03691"></a>03691     <span class="keywordflow">if</span> (entryPoint) {
<a name="l03692"></a>03692       icons = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a7b225fcb720e4d5ed2bbf60e28a25e6d">app</a>.manifest.entry_points[entryPoint].icons;
<a name="l03693"></a>03693     }
<a name="l03694"></a>03694 
<a name="l03695"></a>03695     <span class="keywordflow">if</span> (!icons)
<a name="l03696"></a>03696       <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03697"></a>03697 
<a name="l03698"></a>03698     var sizes = Object.keys(icons).map(<span class="keyword">function</span> <a class="code" href="../../d1/d22/ical_8js.html#a2c438207bb0df36648d3da7ccaac2441">parse</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l03699"></a>03699       <span class="keywordflow">return</span> parseInt(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, 10);
<a name="l03700"></a>03700     });
<a name="l03701"></a>03701     sizes.sort(<span class="keyword">function</span>(x, y) { <span class="keywordflow">return</span> y - x; });
<a name="l03702"></a>03702 
<a name="l03703"></a>03703     var HVGA = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.documentElement.clientWidth &lt; 480;
<a name="l03704"></a>03704     var <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> = sizes[HVGA ? sizes.length - 1 : 0];
<a name="l03705"></a>03705     <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a7b225fcb720e4d5ed2bbf60e28a25e6d">app</a>.installOrigin + icons[<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>];
<a name="l03706"></a>03706   },
<a name="l03707"></a>03707 
<a name="l03708"></a>03708   <a class="code" href="../../df/d65/openaudio_8js.html#a4379e0d0aa0995d904faac29a324b51b">send</a>: <span class="keyword">function</span> nc_send(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa5a506cf1e53b91549e35a5d3bc3dc06">title</a>, body, icon, clickCB, closeCB) {
<a name="l03709"></a>03709     <span class="keywordflow">if</span> (!(<span class="stringliteral">&#39;mozNotification&#39;</span> in <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>))
<a name="l03710"></a>03710       <span class="keywordflow">return</span>;
<a name="l03711"></a>03711 
<a name="l03712"></a>03712     var notification = navigator.mozNotification.createNotification(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa5a506cf1e53b91549e35a5d3bc3dc06">title</a>,
<a name="l03713"></a>03713                                                                     body, icon);
<a name="l03714"></a>03714 
<a name="l03715"></a>03715     notification.onclick = (<span class="keyword">function</span>() {
<a name="l03716"></a>03716       <span class="keywordflow">if</span> (clickCB)
<a name="l03717"></a>03717         clickCB();
<a name="l03718"></a>03718 
<a name="l03719"></a>03719       this._forget(notification);
<a name="l03720"></a>03720     }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>);
<a name="l03721"></a>03721 
<a name="l03722"></a>03722     notification.onclose = (<span class="keyword">function</span>() {
<a name="l03723"></a>03723       <span class="keywordflow">if</span> (closeCB)
<a name="l03724"></a>03724         closeCB();
<a name="l03725"></a>03725 
<a name="l03726"></a>03726       this._forget(notification);
<a name="l03727"></a>03727     }).<a class="code" href="../../d3/d91/j3d_8js.html#a1ad2f17c038f79ef240a44e21a46ef14">bind</a>(<span class="keyword">this</span>);
<a name="l03728"></a>03728 
<a name="l03729"></a>03729     notification.show();
<a name="l03730"></a>03730     this._keep(notification);
<a name="l03731"></a>03731   },
<a name="l03732"></a>03732 
<a name="l03733"></a>03733   _keep: <span class="keyword">function</span> nc_keep(notification) {
<a name="l03734"></a>03734     this._referencesArray.push(notification);
<a name="l03735"></a>03735   },
<a name="l03736"></a>03736   _forget: <span class="keyword">function</span> nc_forget(notification) {
<a name="l03737"></a>03737     this._referencesArray.splice(
<a name="l03738"></a>03738       this._referencesArray.indexOf(notification), 1
<a name="l03739"></a>03739     );
<a name="l03740"></a>03740   }
<a name="l03741"></a>03741 };
<a name="l03742"></a>03742 
<a name="l03743"></a>03743 
<a name="l03744"></a>03744 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&quot;shared/js/notification_helper&quot;</span>, (<span class="keyword">function</span> (<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a5363025b2c2d773292f0f064aeb11f9e">global</a>) {
<a name="l03745"></a>03745     <span class="keywordflow">return</span> <span class="keyword">function</span> () {
<a name="l03746"></a>03746         var <a class="code" href="../../d6/da5/libpinyin_8js.html#a2a7ba084dafcf16766cf163d1f5fbbba">ret</a>, fn;
<a name="l03747"></a>03747         <span class="keywordflow">return</span> ret || <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a5363025b2c2d773292f0f064aeb11f9e">global</a>.NotificationHelper;
<a name="l03748"></a>03748     };
<a name="l03749"></a>03749 }(<span class="keyword">this</span>)));
<a name="l03750"></a>03750 
<a name="l03751"></a>03751 <span class="comment">/*jshint browser: true */</span>
<a name="l03752"></a>03752 <span class="comment">/*global define, console, plog, Notification */</span>
<a name="l03753"></a>03753 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;sync&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;app_self&#39;</span>,<span class="stringliteral">&#39;evt&#39;</span>,<span class="stringliteral">&#39;model&#39;</span>,<span class="stringliteral">&#39;l10n!&#39;</span>,<span class="stringliteral">&#39;shared/js/notification_helper&#39;</span>,<span class="stringliteral">&#39;query_string&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>) {
<a name="l03754"></a>03754 
<a name="l03755"></a>03755   var appSelf = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;app_self&#39;</span>),
<a name="l03756"></a>03756       evt = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;evt&#39;</span>),
<a name="l03757"></a>03757       model = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;model&#39;</span>),
<a name="l03758"></a>03758       <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;l10n!&#39;</span>),
<a name="l03759"></a>03759       notificationHelper = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;shared/js/notification_helper&#39;</span>),
<a name="l03760"></a>03760       <a class="code" href="../../d3/d91/j3d_8js.html#a93f1c40a78764fdbe9fd7854e7685d5f">fromObject</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;query_string&#39;</span>).fromObject;
<a name="l03761"></a>03761 
<a name="l03762"></a>03762   model.latestOnce(<span class="stringliteral">&#39;api&#39;</span>, <span class="keyword">function</span>(api) {
<a name="l03763"></a>03763     var hasBeenVisible = !<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.hidden,
<a name="l03764"></a>03764         waitingOnCron = {};
<a name="l03765"></a>03765 
<a name="l03766"></a>03766     <span class="comment">// Let the back end know the app is interactive, not just</span>
<a name="l03767"></a>03767     <span class="comment">// a quick sync and shutdown case, so that it knows it can</span>
<a name="l03768"></a>03768     <span class="comment">// do extra work.</span>
<a name="l03769"></a>03769     <span class="keywordflow">if</span> (hasBeenVisible) {
<a name="l03770"></a>03770       api.setInteractive();
<a name="l03771"></a>03771     }
<a name="l03772"></a>03772 
<a name="l03773"></a>03773     <span class="comment">// If the page is ever not hidden, then do not close it later.</span>
<a name="l03774"></a>03774     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.addEventListener(<span class="stringliteral">&#39;visibilitychange&#39;</span>,
<a name="l03775"></a>03775       <span class="keyword">function</span> onVisibilityChange() {
<a name="l03776"></a>03776         <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.hidden) {
<a name="l03777"></a>03777           hasBeenVisible = <span class="keyword">true</span>;
<a name="l03778"></a>03778           api.setInteractive();
<a name="l03779"></a>03779         }
<a name="l03780"></a>03780     }, <span class="keyword">false</span>);
<a name="l03781"></a>03781 
<a name="l03782"></a>03782     <span class="comment">// Creates a string key from an array of string IDs. Uses a space</span>
<a name="l03783"></a>03783     <span class="comment">// separator since that cannot show up in an ID.</span>
<a name="l03784"></a>03784     <span class="keyword">function</span> makeAccountKey(accountIds) {
<a name="l03785"></a>03785       <span class="keywordflow">return</span> <span class="stringliteral">&#39;id&#39;</span> + accountIds.join(<span class="charliteral">&#39; &#39;</span>);
<a name="l03786"></a>03786     }
<a name="l03787"></a>03787 
<a name="l03788"></a>03788     var sendNotification;
<a name="l03789"></a>03789     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d8/d86/apps_2calendar_2js_2notification_8js.html#a855f04bb46ade5ca1acc34941474cc54">Notification</a> === <span class="stringliteral">&#39;undefined&#39;</span>) {
<a name="l03790"></a>03790       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;email: notifications not available&#39;</span>);
<a name="l03791"></a>03791       sendNotification = <span class="keyword">function</span>() {};
<a name="l03792"></a>03792     } <span class="keywordflow">else</span> {
<a name="l03793"></a>03793       sendNotification = <span class="keyword">function</span>(notificationId, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa5a506cf1e53b91549e35a5d3bc3dc06">title</a>, body, <a class="code" href="../../dc/db8/system_2test_2unit_2action__menu__test_8js.html#ab7e06d3fa6e5b9f42c44a95747abfabc">iconUrl</a>) {
<a name="l03794"></a>03794         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;Notification sent for &#39;</span> + notificationId);
<a name="l03795"></a>03795 
<a name="l03796"></a>03796         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d86/apps_2calendar_2js_2notification_8js.html#a855f04bb46ade5ca1acc34941474cc54">Notification</a>.permission !== <span class="stringliteral">&#39;granted&#39;</span>) {
<a name="l03797"></a>03797           <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;email: notification skipped, permission: &#39;</span> +
<a name="l03798"></a>03798                       <a class="code" href="../../d8/d86/apps_2calendar_2js_2notification_8js.html#a855f04bb46ade5ca1acc34941474cc54">Notification</a>.permission);
<a name="l03799"></a>03799           <span class="keywordflow">return</span>;
<a name="l03800"></a>03800         }
<a name="l03801"></a>03801 
<a name="l03802"></a>03802         <span class="comment">//TODO: consider setting dir and lang?</span>
<a name="l03803"></a>03803         <span class="comment">//https://developer.mozilla.org/en-US/docs/Web/API/notification</span>
<a name="l03804"></a>03804         var notification = <span class="keyword">new</span> <a class="code" href="../../d8/d86/apps_2calendar_2js_2notification_8js.html#a855f04bb46ade5ca1acc34941474cc54">Notification</a>(title, {
<a name="l03805"></a>03805           body: body,
<a name="l03806"></a>03806           icon: <a class="code" href="../../dc/db8/system_2test_2unit_2action__menu__test_8js.html#ab7e06d3fa6e5b9f42c44a95747abfabc">iconUrl</a>,
<a name="l03807"></a>03807           tag: notificationId
<a name="l03808"></a>03808         });
<a name="l03809"></a>03809 
<a name="l03810"></a>03810         <span class="comment">// If the app is open, but in the background, when the notification</span>
<a name="l03811"></a>03811         <span class="comment">// comes in, then we do not get notifived via our mozSetMessageHandler</span>
<a name="l03812"></a>03812         <span class="comment">// that is set elsewhere. Instead need to listen to click event</span>
<a name="l03813"></a>03813         <span class="comment">// and synthesize an &quot;event&quot; ourselves.</span>
<a name="l03814"></a>03814         notification.onclick = <span class="keyword">function</span>() {
<a name="l03815"></a>03815           evt.emit(<span class="stringliteral">&#39;notification&#39;</span>, {
<a name="l03816"></a>03816             clicked: <span class="keyword">true</span>,
<a name="l03817"></a>03817             imageURL: <a class="code" href="../../dc/db8/system_2test_2unit_2action__menu__test_8js.html#ab7e06d3fa6e5b9f42c44a95747abfabc">iconUrl</a>,
<a name="l03818"></a>03818             tag: notificationId
<a name="l03819"></a>03819           });
<a name="l03820"></a>03820         };
<a name="l03821"></a>03821       };
<a name="l03822"></a>03822     }
<a name="l03823"></a>03823 
<a name="l03824"></a>03824     api.oncronsyncstart = <span class="keyword">function</span>(accountIds) {
<a name="l03825"></a>03825       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;email oncronsyncstart: &#39;</span> + accountIds);
<a name="l03826"></a>03826       var accountKey = makeAccountKey(accountIds);
<a name="l03827"></a>03827       waitingOnCron[accountKey] = <span class="keyword">true</span>;
<a name="l03828"></a>03828     };
<a name="l03829"></a>03829 
<a name="l03830"></a>03830     <span class="keyword">function</span> makeNotificationDesc(infos) {
<a name="l03831"></a>03831       <span class="comment">// For now, just list who the mails are from, as there is no formatting</span>
<a name="l03832"></a>03832       <span class="comment">// possibilities in the existing notifications for the description</span>
<a name="l03833"></a>03833       <span class="comment">// section. Even new lines do not seem to work.</span>
<a name="l03834"></a>03834       var froms = [];
<a name="l03835"></a>03835 
<a name="l03836"></a>03836       infos.forEach(<span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>) {
<a name="l03837"></a>03837         <span class="keywordflow">if</span> (froms.indexOf(<a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.from) === -1)
<a name="l03838"></a>03838           froms.push(<a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.from);
<a name="l03839"></a>03839       });
<a name="l03840"></a>03840       <span class="keywordflow">return</span> froms.join(<span class="stringliteral">&#39;, &#39;</span>);
<a name="l03841"></a>03841     }
<a name="l03842"></a>03842 
<a name="l03843"></a>03843     <span class="comment">/*</span>
<a name="l03844"></a>03844 <span class="comment">    accountsResults is an object with the following structure:</span>
<a name="l03845"></a>03845 <span class="comment">      accountIds: array of string account IDs.</span>
<a name="l03846"></a>03846 <span class="comment">      updates: array of objects includes properties:</span>
<a name="l03847"></a>03847 <span class="comment">        id: accountId,</span>
<a name="l03848"></a>03848 <span class="comment">        name: account name,</span>
<a name="l03849"></a>03849 <span class="comment">        count: number of new messages total</span>
<a name="l03850"></a>03850 <span class="comment">        latestMessageInfos: array of latest message info objects,</span>
<a name="l03851"></a>03851 <span class="comment">        with properties:</span>
<a name="l03852"></a>03852 <span class="comment">          - from</span>
<a name="l03853"></a>03853 <span class="comment">          - subject</span>
<a name="l03854"></a>03854 <span class="comment">          - accountId</span>
<a name="l03855"></a>03855 <span class="comment">          - messageSuid</span>
<a name="l03856"></a>03856 <span class="comment">     */</span>
<a name="l03857"></a>03857     api.oncronsyncstop = <span class="keyword">function</span>(accountsResults) {
<a name="l03858"></a>03858       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;email oncronsyncstop: &#39;</span> + accountsResults.accountIds);
<a name="l03859"></a>03859 
<a name="l03860"></a>03860       appSelf.latest(<span class="stringliteral">&#39;self&#39;</span>, <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a7b225fcb720e4d5ed2bbf60e28a25e6d">app</a>) {
<a name="l03861"></a>03861 
<a name="l03862"></a>03862         model.latestOnce(<span class="stringliteral">&#39;account&#39;</span>, <span class="keyword">function</span>(currentAccount) {
<a name="l03863"></a>03863           var <a class="code" href="../../dc/db8/system_2test_2unit_2action__menu__test_8js.html#ab7e06d3fa6e5b9f42c44a95747abfabc">iconUrl</a> = notificationHelper.getIconURI(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a7b225fcb720e4d5ed2bbf60e28a25e6d">app</a>);
<a name="l03864"></a>03864           <span class="keywordflow">if</span> (accountsResults.updates) {
<a name="l03865"></a>03865             accountsResults.updates.forEach(<span class="keyword">function</span>(<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>) {
<a name="l03866"></a>03866               <span class="comment">// If the current account is being shown, then just send</span>
<a name="l03867"></a>03867               <span class="comment">// an update to the model to indicate new messages, as</span>
<a name="l03868"></a>03868               <span class="comment">// the notification will happen within the app for that</span>
<a name="l03869"></a>03869               <span class="comment">// case.</span>
<a name="l03870"></a>03870               <span class="keywordflow">if</span> (currentAccount.id === <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.id &amp;&amp; !<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.hidden) {
<a name="l03871"></a>03871                 model.notifyInboxMessages(<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>);
<a name="l03872"></a>03872                 <span class="keywordflow">return</span>;
<a name="l03873"></a>03873               }
<a name="l03874"></a>03874 
<a name="l03875"></a>03875               <span class="comment">// If this account does not want notifications of new messages</span>
<a name="l03876"></a>03876               <span class="comment">// stop doing work.</span>
<a name="l03877"></a>03877               <span class="keywordflow">if</span> (!model.getAccount(<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.id).notifyOnNew)
<a name="l03878"></a>03878                 <span class="keywordflow">return</span>;
<a name="l03879"></a>03879 
<a name="l03880"></a>03880               var dataString;
<a name="l03881"></a>03881 
<a name="l03882"></a>03882               <span class="keywordflow">if</span> (<a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozNotification) {
<a name="l03883"></a>03883                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.count &gt; 1) {
<a name="l03884"></a>03884                   dataString = <a class="code" href="../../d3/d91/j3d_8js.html#a93f1c40a78764fdbe9fd7854e7685d5f">fromObject</a>({
<a name="l03885"></a>03885                     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;message_list&#39;</span>,
<a name="l03886"></a>03886                     accountId: <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.id
<a name="l03887"></a>03887                   });
<a name="l03888"></a>03888 
<a name="l03889"></a>03889                   sendNotification(
<a name="l03890"></a>03890                     <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.id,
<a name="l03891"></a>03891                     <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;new-emails-notify&#39;</span>, {
<a name="l03892"></a>03892                       <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>: <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.count,
<a name="l03893"></a>03893                       accountName: <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.address
<a name="l03894"></a>03894                     }),
<a name="l03895"></a>03895                     makeNotificationDesc(<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.latestMessageInfos.sort(
<a name="l03896"></a>03896                                            <span class="keyword">function</span>(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) {
<a name="l03897"></a>03897                                              <span class="keywordflow">return</span> <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.date - <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.date;
<a name="l03898"></a>03898                                            }
<a name="l03899"></a>03899                                         )),
<a name="l03900"></a>03900                     iconUrl + <span class="charliteral">&#39;#&#39;</span> + dataString
<a name="l03901"></a>03901                   );
<a name="l03902"></a>03902                 } <span class="keywordflow">else</span> {
<a name="l03903"></a>03903                   <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.latestMessageInfos.forEach(<span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>) {
<a name="l03904"></a>03904                       dataString = <a class="code" href="../../d3/d91/j3d_8js.html#a93f1c40a78764fdbe9fd7854e7685d5f">fromObject</a>({
<a name="l03905"></a>03905                         <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;message_reader&#39;</span>,
<a name="l03906"></a>03906                         accountId: <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.accountId,
<a name="l03907"></a>03907                         messageSuid: <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.messageSuid
<a name="l03908"></a>03908                       });
<a name="l03909"></a>03909 
<a name="l03910"></a>03910                     sendNotification(
<a name="l03911"></a>03911                       <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>.id,
<a name="l03912"></a>03912                       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.subject,
<a name="l03913"></a>03913                       <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>.from,
<a name="l03914"></a>03914                       iconUrl + <span class="charliteral">&#39;#&#39;</span> + dataString
<a name="l03915"></a>03915                     );
<a name="l03916"></a>03916                   });
<a name="l03917"></a>03917                 }
<a name="l03918"></a>03918               }
<a name="l03919"></a>03919             });
<a name="l03920"></a>03920           }
<a name="l03921"></a>03921         });
<a name="l03922"></a>03922 
<a name="l03923"></a>03923         evt.emit(<span class="stringliteral">&#39;cronSyncStop&#39;</span>, accountsResults.accountIds);
<a name="l03924"></a>03924 
<a name="l03925"></a>03925         <span class="comment">// Mark this accountId set as no longer waiting.</span>
<a name="l03926"></a>03926         var accountKey = makeAccountKey(accountsResults.accountIds);
<a name="l03927"></a>03927         waitingOnCron[accountKey] = <span class="keyword">false</span>;
<a name="l03928"></a>03928         var stillWaiting = Object.keys(waitingOnCron).some(<span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>) {
<a name="l03929"></a>03929           <span class="keywordflow">return</span> !!waitingOnCron[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l03930"></a>03930         });
<a name="l03931"></a>03931 
<a name="l03932"></a>03932         <span class="keywordflow">if</span> (!hasBeenVisible &amp;&amp; !stillWaiting) {
<a name="l03933"></a>03933           var <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a> = <span class="stringliteral">&#39;mail sync complete, closing mail app&#39;</span>;
<a name="l03934"></a>03934           <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d9/dea/apps_2email_2js_2html__cache__restore_8js.html#ab58111f3414504d8d22ab71fc2c9089e">plog</a> === <span class="stringliteral">&#39;function&#39;</span>)
<a name="l03935"></a>03935             <a class="code" href="../../d9/dea/apps_2email_2js_2html__cache__restore_8js.html#ab58111f3414504d8d22ab71fc2c9089e">plog</a>(msg);
<a name="l03936"></a>03936           <span class="keywordflow">else</span>
<a name="l03937"></a>03937             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(msg);
<a name="l03938"></a>03938 
<a name="l03939"></a>03939           <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.close();
<a name="l03940"></a>03940         }
<a name="l03941"></a>03941       });
<a name="l03942"></a>03942     };
<a name="l03943"></a>03943 
<a name="l03944"></a>03944   });
<a name="l03945"></a>03945 });
<a name="l03946"></a>03946 
<a name="l03947"></a>03947 <span class="comment">/*jshint browser: true */</span>
<a name="l03948"></a>03948 <span class="comment">/*globals define, console */</span>
<a name="l03949"></a>03949 
<a name="l03950"></a>03950 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;wake_locks&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;evt&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>) {
<a name="l03951"></a>03951   var lockTimeouts = {},
<a name="l03952"></a>03952       evt = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;evt&#39;</span>),
<a name="l03953"></a>03953       allLocks = {},
<a name="l03954"></a>03954 
<a name="l03955"></a>03955       <span class="comment">// Only allow keeping the locks for a maximum of 45 seconds.</span>
<a name="l03956"></a>03956       <span class="comment">// This is to prevent a long, problematic sync from consuming</span>
<a name="l03957"></a>03957       <span class="comment">// all of the battery power in the phone. A more sophisticated</span>
<a name="l03958"></a>03958       <span class="comment">// method may be to adjust the size of the timeout based on</span>
<a name="l03959"></a>03959       <span class="comment">// past performance, but that would mean keeping a persistent</span>
<a name="l03960"></a>03960       <span class="comment">// log of attempts. This naive approach just tries to catch the</span>
<a name="l03961"></a>03961       <span class="comment">// most likely set of failures: just a temporary really bad</span>
<a name="l03962"></a>03962       <span class="comment">// cell network situation that once the next sync happens, the</span>
<a name="l03963"></a>03963       <span class="comment">// issue is resolved.</span>
<a name="l03964"></a>03964       maxLockInterval = 45000;
<a name="l03965"></a>03965 
<a name="l03966"></a>03966   <span class="keyword">function</span> clearLocks(accountKey) {
<a name="l03967"></a>03967     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;email: clearing wake locks for &quot;&#39;</span> + accountKey + <span class="charliteral">&#39;&quot;&#39;</span>);
<a name="l03968"></a>03968 
<a name="l03969"></a>03969     <span class="comment">// Clear timer</span>
<a name="l03970"></a>03970     var lockTimeoutId = lockTimeouts[accountKey];
<a name="l03971"></a>03971     <span class="keywordflow">if</span> (lockTimeoutId)
<a name="l03972"></a>03972       <a class="code" href="../../da/da1/timers_8js.html#ab37ff0db33a3bf80b0163adc40a58424">clearTimeout</a>(lockTimeoutId);
<a name="l03973"></a>03973     lockTimeouts[accountKey] = 0;
<a name="l03974"></a>03974 
<a name="l03975"></a>03975     <span class="comment">// Clear the locks</span>
<a name="l03976"></a>03976     var locks = allLocks[accountKey];
<a name="l03977"></a>03977     allLocks[accountKey] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03978"></a>03978     <span class="keywordflow">if</span> (locks) {
<a name="l03979"></a>03979       locks.forEach(<span class="keyword">function</span>(<a class="code" href="../../df/d6d/prpdce_8h.html#a3a0acaef79170339a71bc1c4c54ad225">lock</a>) {
<a name="l03980"></a>03980         <a class="code" href="../../df/d6d/prpdce_8h.html#a3a0acaef79170339a71bc1c4c54ad225">lock</a>.unlock();
<a name="l03981"></a>03981       });
<a name="l03982"></a>03982     }
<a name="l03983"></a>03983   }
<a name="l03984"></a>03984 
<a name="l03985"></a>03985   <span class="comment">// Creates a string key from an array of string IDs. Uses a space</span>
<a name="l03986"></a>03986   <span class="comment">// separator since that cannot show up in an ID.</span>
<a name="l03987"></a>03987   <span class="keyword">function</span> makeAccountKey(accountIds) {
<a name="l03988"></a>03988     <span class="keywordflow">return</span> <span class="stringliteral">&#39;id&#39;</span> + accountIds.join(<span class="charliteral">&#39; &#39;</span>);
<a name="l03989"></a>03989   }
<a name="l03990"></a>03990 
<a name="l03991"></a>03991   <span class="keyword">function</span> onCronStop(accountIds) {
<a name="l03992"></a>03992     clearLocks(makeAccountKey(accountIds));
<a name="l03993"></a>03993   }
<a name="l03994"></a>03994 
<a name="l03995"></a>03995   evt.on(<span class="stringliteral">&#39;cronSyncWakeLocks&#39;</span>, <span class="keyword">function</span>(accountKey, locks) {
<a name="l03996"></a>03996     <span class="keywordflow">if</span> (lockTimeouts[accountKey]) {
<a name="l03997"></a>03997       <span class="comment">// Only support one set of locks. Better to err on the side of</span>
<a name="l03998"></a>03998       <span class="comment">// saving the battery and not continue syncing vs supporting a</span>
<a name="l03999"></a>03999       <span class="comment">// pathologic error that leads to a compound set of locks but</span>
<a name="l04000"></a>04000       <span class="comment">// end up with more syncs completing.</span>
<a name="l04001"></a>04001       clearLocks(accountKey);
<a name="l04002"></a>04002     }
<a name="l04003"></a>04003 
<a name="l04004"></a>04004     allLocks[accountKey] = locks;
<a name="l04005"></a>04005 
<a name="l04006"></a>04006     lockTimeouts[accountKey] = <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(clearLocks.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, accountKey),
<a name="l04007"></a>04007                                           maxLockInterval);
<a name="l04008"></a>04008   });
<a name="l04009"></a>04009 
<a name="l04010"></a>04010   evt.on(<span class="stringliteral">&#39;cronSyncStop&#39;</span>, onCronStop);
<a name="l04011"></a>04011 });
<a name="l04012"></a>04012 
<a name="l04013"></a>04013 <span class="comment">// when running in B2G, send output to the console, ANSI-style</span>
<a name="l04014"></a><a class="code" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html#a38196167766bdd6dc96ba928e4dcccd1">04014</a> <span class="keywordflow">if</span> (<span class="stringliteral">&#39;mozTCPSocket&#39;</span> in <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.navigator) {
<a name="l04015"></a>04015   <span class="keyword">function</span> <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#acca0830549ecf3f74253c2e401a9dda2">consoleHelper</a>() {
<a name="l04016"></a>04016     var <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a> = arguments[0] + <span class="charliteral">&#39;:&#39;</span>;
<a name="l04017"></a>04017     <span class="keywordflow">for</span> (var i = 1; i &lt; arguments.length; i++) {
<a name="l04018"></a>04018       msg += <span class="charliteral">&#39; &#39;</span> + arguments[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l04019"></a>04019     }
<a name="l04020"></a>04020     msg += <span class="stringliteral">&#39;\x1b[0m\n&#39;</span>;
<a name="l04021"></a>04021     <a class="code" href="../../d6/d1b/pprthred_8h.html#a49e6921d95ff0b994cd312b3f856a8a6">dump</a>(msg);
<a name="l04022"></a>04022   }
<a name="l04023"></a>04023   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console = {
<a name="l04024"></a>04024     <a class="code" href="../../d8/dfa/init_8js.html#aad81d14d4c8eea114056d7dc1f18f9b7">log</a>: <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#acca0830549ecf3f74253c2e401a9dda2">consoleHelper</a>.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;\x1b[32mLOG&#39;</span>),
<a name="l04025"></a>04025     <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>: <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#acca0830549ecf3f74253c2e401a9dda2">consoleHelper</a>.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;\x1b[31mERR&#39;</span>),
<a name="l04026"></a>04026     <a class="code" href="../../d9/d04/expat_8h.html#ad737df79bb5419e4bac72f823f6fdec9">info</a>: <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#acca0830549ecf3f74253c2e401a9dda2">consoleHelper</a>.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;\x1b[36mINF&#39;</span>),
<a name="l04027"></a>04027     warn: <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#acca0830549ecf3f74253c2e401a9dda2">consoleHelper</a>.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;\x1b[33mWAR&#39;</span>)
<a name="l04028"></a>04028   };
<a name="l04029"></a>04029 }
<a name="l04030"></a><a class="code" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html#a967fa8bfed0d474ca27756b00f6abf8e">04030</a> <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.onerror = <span class="keyword">function</span> errHandler(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>) {
<a name="l04031"></a>04031   <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;onerror reporting:&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>, <span class="charliteral">&#39;@&#39;</span>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, <span class="charliteral">&#39;:&#39;</span>, <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a>);
<a name="l04032"></a>04032   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04033"></a>04033 };
<a name="l04034"></a>04034 
<a name="l04035"></a>04035 
<a name="l04036"></a>04036 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&quot;console_hook&quot;</span>, <span class="keyword">function</span>(){});
<a name="l04037"></a>04037 
<a name="l04038"></a>04038 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;tmpl!cards/message_list.html&#39;</span>,[<span class="stringliteral">&#39;tmpl&#39;</span>], <span class="keyword">function</span> (tmpl) { <span class="keywordflow">return</span> tmpl.toDom(<span class="stringliteral">&#39;&lt;!-- Lists the messages in a folder --&gt;\n&lt;div class=&quot;card-message-list card&quot; data-tray-target&gt;\n  &lt;!-- Non-search header --&gt;\n  &lt;section class=&quot;msg-list-header msg-nonsearch-only&quot; role=&quot;region&quot;&gt;\n    &lt;header&gt;\n      &lt;a href=&quot;#&quot; class=&quot;msg-folder-list-btn&quot;&gt;\n        &lt;span class=&quot;icon icon-menu&quot;&gt;menu&lt;/span&gt;\n      &lt;/a&gt;\n      &lt;menu type=&quot;toolbar&quot;&gt;\n        &lt;a href=&quot;#&quot; class=&quot;msg-compose-btn&quot;&gt;\n          &lt;span class=&quot;icon icon-compose&quot;&gt;compose&lt;/span&gt;\n        &lt;/a&gt;\n      &lt;/menu&gt;\n      &lt;h1 class=&quot;msg-list-header-folder-label header-label&quot;&gt;&lt;/h1&gt;\n    &lt;/header&gt;\n  &lt;/section&gt;\n  &lt;!-- Multi-edit state header --&gt;\n  &lt;section class=&quot;msg-listedit-header skin-dark collapsed&quot; role=&quot;region&quot;&gt;\n    &lt;header&gt;\n      &lt;a href=&quot;#&quot; class=&quot;msg-listedit-cancel-btn&quot;&gt;\n        &lt;span class=&quot;icon icon-close&quot;&gt;&lt;/span&gt;\n      &lt;/a&gt;\n      &lt;h1 class=&quot;msg-listedit-header-label&quot;&gt;&lt;/h1&gt;\n    &lt;/header&gt;\n  &lt;/section&gt;\n  &lt;!-- Search header --&gt;\n  &lt;section role=&quot;region&quot;\n           class=&quot;msg-search-header msg-search-only&quot;&gt;\n    &lt;header&gt;\n      &lt;a href=&quot;#&quot; class=&quot;msg-search-cancel&quot;&gt;\n        &lt;span class=&quot;icon icon-close&quot;\n              data-l10n-id=&quot;message-search-cancel-accessible&quot;&gt;&lt;/span&gt;\n      &lt;/a&gt;\n      &lt;form&gt;\n        &lt;input type=&quot;text&quot; required=&quot;required&quot; class=&quot;msg-search-text&quot;\n               data-l10n-id=&quot;message-search-input&quot; /&gt;\n        &lt;button type=&quot;reset&quot; data-l10n-id=&quot;form-clear-input&quot;&gt;&lt;/button&gt;\n      &lt;/form&gt;\n    &lt;/header&gt;\n    &lt;!-- Search filter switcher --&gt;\n    &lt;header class=&quot;msg-search-controls-bar&quot;&gt;\n      &lt;ul role=&quot;tablist&quot; class=&quot;filter&quot; data-type=&quot;filter&quot; data-items=&quot;5&quot;&gt;\n        &lt;li role=&quot;tab&quot; class=&quot;msg-search-from msg-search-filter&quot;\n            data-filter=&quot;author&quot;&gt;\n          &lt;a data-l10n-id=&quot;message-search-from&quot;&gt;FroM&lt;/a&gt;&lt;/li&gt;\n        &lt;li role=&quot;tab&quot; class=&quot;msg-search-to msg-search-filter&quot;\n            data-filter=&quot;recipients&quot;&gt;\n          &lt;a data-l10n-id=&quot;message-search-to&quot;&gt;tO&lt;/a&gt;&lt;/li&gt;\n        &lt;li role=&quot;tab&quot; class=&quot;msg-search-subject msg-search-filter&quot;\n             data-filter=&quot;subject&quot;&gt;\n          &lt;a data-l10n-id=&quot;message-search-subject&quot;&gt;SubjecT&lt;/a&gt;\n        &lt;/li&gt;\n        &lt;li role=&quot;tab&quot; class=&quot;msg-search-body msg-search-filter&quot;\n             data-filter=&quot;body&quot;&gt;\n          &lt;a data-l10n-id=&quot;message-search-body&quot;&gt;BodY&lt;/a&gt;&lt;/li&gt;\n        &lt;li role=&quot;tab&quot; class=&quot;msg-search-body msg-search-filter&quot;\n            data-filter=&quot;all&quot; aria-selected&gt;\n          &lt;a data-l10n-id=&quot;message-search-all&quot;&gt;AlL&lt;/a&gt;&lt;/li&gt;\n      &lt;/ul&gt;\n    &lt;/header&gt;\n  &lt;/section&gt;\n  &lt;!-- Scroll region --&gt;\n  &lt;div class=&quot;msg-list-scrollouter&quot;&gt;\n    &lt;!-- exists so we can force a minimum height --&gt;\n    &lt;div class=&quot;msg-list-scrollinner&quot;&gt;\n      &lt;!-- The search textbox hides under the lip of the messages.\n           As soon as any typing happens in it, we push the search\n           controls card. --&gt;\n      &lt;div class=&quot;msg-search-tease-bar msg-nonsearch-only&quot;&gt;\n        &lt;input class=&quot;msg-search-text-tease&quot; type=&quot;text&quot;\n               data-l10n-id=&quot;message-search-input&quot; /&gt;\n      &lt;/div&gt;\n      &lt;div class=&quot;msg-messages-container&quot;&gt;\n      &lt;/div&gt;\n      &lt;!-- maintain vertical space for the syncing/sync more div\&#39;s\n           regardless of their displayed status so we don\&#39;t scroll them\n           out of the way --&gt;\n      &lt;div class=&quot;msg-messages-sync-container&quot;&gt;\n        &lt;p class=&quot;msg-messages-syncing collapsed&quot;&gt;\n          &lt;span data-l10n-id=&quot;messages-syncing&quot;&gt;Message loadinG&lt;/span&gt;\n        &lt;/p&gt;\n        &lt;p class=&quot;msg-messages-sync-more collapsed&quot;&gt;\n          &lt;span data-l10n-id=&quot;messages-sync-more&quot;&gt;SynC MorE&lt;/span&gt;\n        &lt;/p&gt;\n      &lt;/div&gt;\n      &lt;div class=&quot;bottom-toolbar-spacer&quot;&gt;&lt;/div&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n  &lt;!-- New email notification bar --&gt;\n  &lt;div class=&quot;msg-list-topbar collapsed&quot;&gt;&lt;/div&gt;\n  &lt;!-- Conveys background send, plus undo-able recent actions --&gt;\n  &lt;div class=&quot;msg-activity-infobar hidden&quot;&gt;\n  &lt;/div&gt;\n  &lt;!-- Toolbar for non-multi-edit state --&gt;\n  &lt;div class=&quot;msg-list-action-toolbar bottom-toolbar&quot;&gt;\n    &lt;button class=&quot;msg-refresh-btn bottom-btn msg-nonsearch-only&quot;\n            data-state=&quot;synchronized&quot;&gt;&lt;/button&gt;\n    &lt;button class=&quot;msg-search-btn bottom-btn msg-nonsearch-only&quot;&gt;&lt;/button&gt;\n    &lt;button class=&quot;msg-edit-btn bottom-btn&quot;&gt;&lt;/button&gt;\n  &lt;/div&gt;\n  &lt;!-- Toolbar for multi-edit state --&gt;\n  &lt;div class=&quot;msg-listedit-action-toolbar bottom-edit-toolbar bottom-toolbar collapsed&quot;&gt;\n    &lt;button class=&quot;msg-delete-btn bottom-btn&quot;&gt;&lt;/button&gt;\n    &lt;button class=&quot;msg-star-btn bottom-btn&quot;&gt;&lt;/button&gt;\n    &lt;button class=&quot;msg-mark-read-btn bottom-btn&quot;&gt;&lt;/button&gt;\n    &lt;button class=&quot;msg-move-btn bottom-btn&quot;&gt;&lt;/button&gt;\n  &lt;/div&gt;\n  &lt;div class=&quot;msg-list-empty-container collapsed&quot;&gt;\n    &lt;p class=&quot;msg-list-empty-message-text&quot; data-l10n-id=&quot;messages-folder-empty&quot;&gt;No messagE&lt;/p&gt;\n  &lt;/div&gt;\n&lt;/div&gt;\n&#39;</span>); });
<a name="l04039"></a>04039 
<a name="l04040"></a>04040 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;tmpl!cards/msg/header_item.html&#39;</span>,[<span class="stringliteral">&#39;tmpl&#39;</span>], <span class="keyword">function</span> (tmpl) { <span class="keywordflow">return</span> tmpl.toDom(<span class="stringliteral">&#39;&lt;a class=&quot;msg-header-item&quot;&gt;\n  &lt;label class=&quot;pack-checkbox negative&quot;&gt;\n    &lt;input type=&quot;checkbox&quot;&gt;&lt;span&gt;&lt;/span&gt;\n  &lt;/label&gt;\n  &lt;div class=&quot;msg-header-unread-section&quot;&gt;&lt;/div&gt;\n  &lt;div class=&quot;msg-header-details-section&quot;&gt;\n    &lt;span class=&quot;msg-header-author-and-date&quot;&gt;\n      &lt;span class=&quot;msg-header-author&quot;&gt;&lt;/span&gt;\n      &lt;span class=&quot;msg-header-date&quot;&gt;&lt;/span&gt;\n    &lt;/span&gt;&lt;span class=&quot;msg-header-subject&quot;&gt;&lt;/span&gt;\n    &lt;span class=&quot;msg-header-snippet&quot;&gt;&lt;/span&gt;\n  &lt;/div&gt;&lt;div class=&quot;msg-header-icons-section&quot;&gt;\n    &lt;span class=&quot;msg-header-star&quot;&gt;&lt;/span&gt;\n    &lt;span class=&quot;msg-header-attachments&quot;&gt;&lt;/span&gt;\n  &lt;/div&gt;&lt;div class=&quot;msg-header-avatar-section&quot;&gt;\n  &lt;/div&gt;&lt;/a&gt;\n&#39;</span>); });
<a name="l04041"></a>04041 
<a name="l04042"></a>04042 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;tmpl!cards/msg/delete_confirm.html&#39;</span>,[<span class="stringliteral">&#39;tmpl&#39;</span>], <span class="keyword">function</span> (tmpl) { <span class="keywordflow">return</span> tmpl.toDom(<span class="stringliteral">&#39;&lt;form role=&quot;dialog&quot; class=&quot;msg-delete-confirm&quot; data-type=&quot;confirm&quot;&gt;\n  &lt;section&gt;\n    &lt;h1 data-l10n-id=&quot;confirm-dialog-title&quot;&gt;ConfirmatioN&lt;/h1&gt;\n    &lt;p&gt;&lt;span data-l10n-id=&quot;message-edit-delete-confirm&quot;&gt;&lt;/span&gt;&lt;/p&gt;\n  &lt;/section&gt;\n  &lt;menu&gt;\n    &lt;button id=&quot;msg-delete-cancel&quot; data-l10n-id=&quot;message-multiedit-cancel&quot;&gt;CanceL&lt;/button&gt;\n    &lt;button id=&quot;msg-delete-ok&quot; class=&quot;danger&quot; data-l10n-id=&quot;message-edit-menu-delete&quot;&gt;OK&lt;/button&gt;\n  &lt;/menu&gt;\n&lt;/form&gt;&#39;</span>); });
<a name="l04043"></a>04043 
<a name="l04044"></a>04044 
<a name="l04051"></a>04051 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;message_list_topbar&#39;</span>,[<span class="stringliteral">&#39;l10n!&#39;</span>], <span class="keyword">function</span>(<a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>) {
<a name="l04057"></a>04057 <span class="keyword">function</span> MessageListTopbar(scrollContainer, newEmailCount) {
<a name="l04058"></a>04058   this._scrollContainer = scrollContainer;
<a name="l04059"></a>04059   this._newEmailCount = newEmailCount;
<a name="l04060"></a>04060 }
<a name="l04061"></a>04061 
<a name="l04062"></a>04062 
<a name="l04066"></a>04066 MessageListTopbar.CLASS_NAME = <span class="stringliteral">&#39;msg-list-topbar&#39;</span>;
<a name="l04067"></a>04067 
<a name="l04068"></a>04068 
<a name="l04073"></a>04073 MessageListTopbar.DISAPPEARS_AFTER_MILLIS = 5000;
<a name="l04074"></a>04074 
<a name="l04075"></a>04075 
<a name="l04076"></a>04076 MessageListTopbar.prototype = {
<a name="l04081"></a>04081   _el: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04082"></a>04082 
<a name="l04083"></a>04083 
<a name="l04088"></a>04088   _scrollContainer: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04089"></a>04089 
<a name="l04090"></a>04090 
<a name="l04095"></a>04095   _newEmailCount: 0,
<a name="l04096"></a>04096 
<a name="l04097"></a>04097 
<a name="l04103"></a>04103   decorate: <span class="keyword">function</span>(el) {
<a name="l04104"></a>04104     el.addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this._onclick.bind(<span class="keyword">this</span>));
<a name="l04105"></a>04105     this._el = el;
<a name="l04106"></a>04106     this.updateNewEmailCount();
<a name="l04107"></a>04107     <span class="keywordflow">return</span> this._el;
<a name="l04108"></a>04108   },
<a name="l04109"></a>04109 
<a name="l04110"></a>04110 
<a name="l04115"></a>04115   <a class="code" href="../../de/df6/homescreen_2js_2page_8js.html#ae7817194480cfc900873938c8e7dd602">render</a>: <span class="keyword">function</span>() {
<a name="l04116"></a>04116     this._el.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04117"></a>04117     <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(
<a name="l04118"></a>04118         this.<a class="code" href="../../db/d0b/_image_editor_8js.html#ab508a76bce0563fb932c738c5d3ff9ed">destroy</a>.bind(<span class="keyword">this</span>),
<a name="l04119"></a>04119         MessageListTopbar.DISAPPEARS_AFTER_MILLIS
<a name="l04120"></a>04120     );
<a name="l04121"></a>04121   },
<a name="l04122"></a>04122 
<a name="l04123"></a>04123 
<a name="l04127"></a>04127   <a class="code" href="../../db/d0b/_image_editor_8js.html#ab508a76bce0563fb932c738c5d3ff9ed">destroy</a>: <span class="keyword">function</span>() {
<a name="l04128"></a>04128     <span class="keywordflow">if</span> (this._el) {
<a name="l04129"></a>04129       this._el.removeEventListener(<span class="stringliteral">&#39;click&#39;</span>, this._onclick.bind(<span class="keyword">this</span>));
<a name="l04130"></a>04130       this._el.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04131"></a>04131       this._el.textContent = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04132"></a>04132       this._el = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04133"></a>04133     }
<a name="l04134"></a>04134   },
<a name="l04135"></a>04135 
<a name="l04136"></a>04136 
<a name="l04140"></a>04140   getElement: <span class="keyword">function</span>() {
<a name="l04141"></a>04141     <span class="keywordflow">return</span> this._el;
<a name="l04142"></a>04142   },
<a name="l04143"></a>04143 
<a name="l04144"></a>04144 
<a name="l04148"></a>04148   updateNewEmailCount: <span class="keyword">function</span>(newEmailCount) {
<a name="l04149"></a>04149     <span class="keywordflow">if</span> (newEmailCount !== undefined) {
<a name="l04150"></a>04150       this._newEmailCount += newEmailCount;
<a name="l04151"></a>04151     }
<a name="l04152"></a>04152 
<a name="l04153"></a>04153     <span class="keywordflow">if</span> (this._el !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l04154"></a>04154       this._el.textContent =
<a name="l04155"></a>04155           <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;new-emails&#39;</span>, { <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>: this._newEmailCount });
<a name="l04156"></a>04156     }
<a name="l04157"></a>04157   },
<a name="l04158"></a>04158 
<a name="l04159"></a>04159 
<a name="l04163"></a>04163   _onclick: <span class="keyword">function</span>(evt) {
<a name="l04164"></a>04164     this.<a class="code" href="../../db/d0b/_image_editor_8js.html#ab508a76bce0563fb932c738c5d3ff9ed">destroy</a>();
<a name="l04165"></a>04165 
<a name="l04166"></a>04166     var scrollTop = this._scrollContainer.scrollTop;
<a name="l04167"></a>04167     var dest = this._getScrollDestination();
<a name="l04168"></a>04168     <span class="keywordflow">if</span> (scrollTop &lt;= dest) {
<a name="l04169"></a>04169       <span class="keywordflow">return</span>;
<a name="l04170"></a>04170     }
<a name="l04171"></a>04171 
<a name="l04172"></a>04172     this._scrollUp(this._scrollContainer, dest, 0, 50);
<a name="l04173"></a>04173   },
<a name="l04174"></a>04174 
<a name="l04175"></a>04175 
<a name="l04184"></a>04184   _scrollUp: <span class="keyword">function</span>(el, dest, <a class="code" href="../../da/d32/prio_8h.html#a0f2163507f01dc9bb68ca5c72cacaa34">timeout</a>, inc) {
<a name="l04185"></a>04185     var next = el.scrollTop - inc;
<a name="l04186"></a>04186     <span class="keywordflow">if</span> (dest &gt;= next) {
<a name="l04187"></a>04187       <span class="comment">// This is the last scroll.</span>
<a name="l04188"></a>04188       el.scrollTop = dest;
<a name="l04189"></a>04189       <span class="keywordflow">return</span>;
<a name="l04190"></a>04190     }
<a name="l04191"></a>04191 
<a name="l04192"></a>04192     el.scrollTop = next;
<a name="l04193"></a>04193     <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(this._scrollUp.bind(<span class="keyword">this</span>, el, dest, timeout, inc), <a class="code" href="../../da/d32/prio_8h.html#a0f2163507f01dc9bb68ca5c72cacaa34">timeout</a>);
<a name="l04194"></a>04194   },
<a name="l04195"></a>04195 
<a name="l04196"></a>04196 
<a name="l04202"></a>04202   _getScrollDestination: <span class="keyword">function</span>() {
<a name="l04203"></a>04203     var searchBar =
<a name="l04204"></a>04204         <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(<span class="stringliteral">&#39;msg-search-tease-bar&#39;</span>)[0];
<a name="l04205"></a>04205     <span class="keywordflow">return</span> searchBar.offsetHeight;
<a name="l04206"></a>04206   }
<a name="l04207"></a>04207 };
<a name="l04208"></a>04208 
<a name="l04209"></a>04209 <span class="keywordflow">return</span> MessageListTopbar;
<a name="l04210"></a>04210 });
<a name="l04211"></a>04211 
<a name="l04212"></a>04212 
<a name="l04213"></a>04213 <span class="comment">/*jshint browser: true */</span>
<a name="l04214"></a>04214 <span class="comment">/*global define, console */</span>
<a name="l04215"></a>04215 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;cards/message_list&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;tmpl!./message_list.html&#39;</span>,<span class="stringliteral">&#39;tmpl!./msg/header_item.html&#39;</span>,<span class="stringliteral">&#39;tmpl!./msg/delete_confirm.html&#39;</span>,<span class="stringliteral">&#39;mail_common&#39;</span>,<span class="stringliteral">&#39;model&#39;</span>,<span class="stringliteral">&#39;html_cache&#39;</span>,<span class="stringliteral">&#39;message_list_topbar&#39;</span>,<span class="stringliteral">&#39;l10n!&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>) {
<a name="l04216"></a>04216 
<a name="l04217"></a>04217 var templateNode = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;tmpl!./message_list.html&#39;</span>),
<a name="l04218"></a>04218     msgHeaderItemNode = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;tmpl!./msg/header_item.html&#39;</span>),
<a name="l04219"></a>04219     deleteConfirmMsgNode = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;tmpl!./msg/delete_confirm.html&#39;</span>),
<a name="l04220"></a>04220     common = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;mail_common&#39;</span>),
<a name="l04221"></a>04221     model = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;model&#39;</span>),
<a name="l04222"></a>04222     htmlCache = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;html_cache&#39;</span>),
<a name="l04223"></a>04223     MessageListTopbar = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;message_list_topbar&#39;</span>),
<a name="l04224"></a>04224     <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;l10n!&#39;</span>),
<a name="l04225"></a>04225     Cards = common.Cards,
<a name="l04226"></a>04226     Toaster = common.Toaster,
<a name="l04227"></a>04227     ConfirmDialog = common.ConfirmDialog,
<a name="l04228"></a>04228     batchAddClass = common.batchAddClass,
<a name="l04229"></a>04229     bindContainerClickAndHold = common.bindContainerClickAndHold,
<a name="l04230"></a>04230     bindContainerHandler = common.bindContainerHandler,
<a name="l04231"></a>04231     appendMatchItemTo = common.appendMatchItemTo,
<a name="l04232"></a>04232     displaySubject = common.displaySubject,
<a name="l04233"></a>04233     prettyDate = common.prettyDate;
<a name="l04234"></a>04234 
<a name="l04239"></a>04239 var SCROLL_MIN_BUFFER_SCREENS = 2;
<a name="l04243"></a>04243 var SCROLL_MAX_RETENTION_SCREENS = 7;
<a name="l04244"></a>04244 
<a name="l04249"></a>04249 var SCROLL_DELAY = 50;
<a name="l04250"></a>04250 
<a name="l04255"></a>04255 var MINIMUM_ITEMS_FOR_SCROLL_CALC = 10;
<a name="l04256"></a>04256 
<a name="l04260"></a>04260 var MAXIMUM_MS_BETWEEN_SNIPPET_REQUEST = 6000;
<a name="l04261"></a>04261 
<a name="l04265"></a>04265 var MAXIMUM_BYTES_PER_MESSAGE_DURING_SCROLL = 4 * 1024;
<a name="l04266"></a>04266 
<a name="l04315"></a>04315 <span class="keyword">function</span> MessageListCard(domNode, <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l04316"></a>04316   this.domNode = domNode;
<a name="l04317"></a>04317   this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> = <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>;
<a name="l04318"></a>04318   this.scrollNode = domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-list-scrollouter&#39;</span>)[0];
<a name="l04319"></a>04319 
<a name="l04320"></a>04320   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === <span class="stringliteral">&#39;nonsearch&#39;</span>)
<a name="l04321"></a>04321     batchAddClass(domNode, <span class="stringliteral">&#39;msg-search-only&#39;</span>, <span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04322"></a>04322   <span class="keywordflow">else</span>
<a name="l04323"></a>04323     batchAddClass(domNode, <span class="stringliteral">&#39;msg-nonsearch-only&#39;</span>, <span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04324"></a>04324 
<a name="l04325"></a>04325   this.messagesContainer =
<a name="l04326"></a>04326     domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-messages-container&#39;</span>)[0];
<a name="l04327"></a>04327 
<a name="l04328"></a>04328   this.messageEmptyContainer =
<a name="l04329"></a>04329     domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-list-empty-container&#39;</span>)[0];
<a name="l04330"></a>04330   <span class="comment">// - message actions</span>
<a name="l04331"></a>04331   bindContainerClickAndHold(
<a name="l04332"></a>04332     this.messagesContainer,
<a name="l04333"></a>04333     <span class="comment">// clicking shows the message reader for a message</span>
<a name="l04334"></a>04334     this.onClickMessage.bind(<span class="keyword">this</span>),
<a name="l04335"></a>04335     <span class="comment">// press-and-hold shows the single-message mutation options</span>
<a name="l04336"></a>04336     this.onHoldMessage.bind(<span class="keyword">this</span>));
<a name="l04337"></a>04337 
<a name="l04338"></a>04338   <span class="comment">// - less-than-infinite scrolling</span>
<a name="l04339"></a>04339   this.scrollContainer =
<a name="l04340"></a>04340     domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-list-scrollouter&#39;</span>)[0];
<a name="l04341"></a>04341   this.scrollContainer.addEventListener(<span class="stringliteral">&#39;scroll&#39;</span>, this.onScroll.bind(<span class="keyword">this</span>),
<a name="l04342"></a>04342                                         <span class="keyword">false</span>);
<a name="l04343"></a>04343   this.syncingNode =
<a name="l04344"></a>04344     domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-messages-syncing&#39;</span>)[0];
<a name="l04345"></a>04345   this.syncMoreNode =
<a name="l04346"></a>04346     domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-messages-sync-more&#39;</span>)[0];
<a name="l04347"></a>04347   this.syncMoreNode
<a name="l04348"></a>04348     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onGetMoreMessages.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l04349"></a>04349 
<a name="l04350"></a>04350   <span class="comment">// - header buttons: non-edit mode</span>
<a name="l04351"></a>04351   domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-folder-list-btn&#39;</span>)[0]
<a name="l04352"></a>04352     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onShowFolders.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l04353"></a>04353   domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-compose-btn&#39;</span>)[0]
<a name="l04354"></a>04354     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onCompose.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l04355"></a>04355 
<a name="l04356"></a>04356   <span class="comment">// - toolbar: non-edit mode</span>
<a name="l04357"></a>04357   this.toolbar = {};
<a name="l04358"></a>04358   this.toolbar.searchBtn = domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-search-btn&#39;</span>)[0];
<a name="l04359"></a>04359   this.toolbar.searchBtn
<a name="l04360"></a>04360     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onSearchButton.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l04361"></a>04361   this.toolbar.editBtn = domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-edit-btn&#39;</span>)[0];
<a name="l04362"></a>04362   this.toolbar.editBtn
<a name="l04363"></a>04363     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.setEditMode.bind(<span class="keyword">this</span>, <span class="keyword">true</span>), <span class="keyword">false</span>);
<a name="l04364"></a>04364   this.toolbar.refreshBtn =
<a name="l04365"></a>04365     domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-refresh-btn&#39;</span>)[0];
<a name="l04366"></a>04366   this.toolbar.refreshBtn
<a name="l04367"></a>04367     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onRefresh.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l04368"></a>04368 
<a name="l04369"></a>04369   <span class="comment">// - header buttons: edit mode</span>
<a name="l04370"></a>04370   domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-listedit-cancel-btn&#39;</span>)[0]
<a name="l04371"></a>04371     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.setEditMode.bind(<span class="keyword">this</span>, <span class="keyword">false</span>), <span class="keyword">false</span>);
<a name="l04372"></a>04372 
<a name="l04373"></a>04373   <span class="comment">// - toolbar: edit mode</span>
<a name="l04374"></a>04374   domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-star-btn&#39;</span>)[0]
<a name="l04375"></a>04375     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onStarMessages.bind(<span class="keyword">this</span>, <span class="keyword">true</span>), <span class="keyword">false</span>);
<a name="l04376"></a>04376   domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-mark-read-btn&#39;</span>)[0]
<a name="l04377"></a>04377     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onMarkMessagesRead.bind(<span class="keyword">this</span>, <span class="keyword">true</span>), <span class="keyword">false</span>);
<a name="l04378"></a>04378   domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-delete-btn&#39;</span>)[0]
<a name="l04379"></a>04379     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onDeleteMessages.bind(<span class="keyword">this</span>, <span class="keyword">true</span>), <span class="keyword">false</span>);
<a name="l04380"></a>04380   this.toolbar.moveBtn = domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-move-btn&#39;</span>)[0];
<a name="l04381"></a>04381   this.toolbar.moveBtn
<a name="l04382"></a>04382     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onMoveMessages.bind(<span class="keyword">this</span>, <span class="keyword">true</span>), <span class="keyword">false</span>);
<a name="l04383"></a>04383 
<a name="l04384"></a>04384   <span class="comment">// -- non-search mode</span>
<a name="l04385"></a>04385   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === <span class="stringliteral">&#39;nonsearch&#39;</span>) {
<a name="l04386"></a>04386     <span class="comment">// - search teaser bar</span>
<a name="l04387"></a>04387     <span class="comment">// Focusing the teaser bar&#39;s text field is the same as hitting the search</span>
<a name="l04388"></a>04388     <span class="comment">// button.</span>
<a name="l04389"></a>04389     domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-search-text-tease&#39;</span>)[0]
<a name="l04390"></a>04390       .addEventListener(<span class="stringliteral">&#39;focus&#39;</span>, this.onSearchButton.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l04391"></a>04391   }
<a name="l04392"></a>04392   <span class="comment">// -- search mode</span>
<a name="l04393"></a>04393   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === <span class="stringliteral">&#39;search&#39;</span>) {
<a name="l04394"></a>04394     domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-search-cancel&#39;</span>)[0]
<a name="l04395"></a>04395       .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onCancelSearch.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l04396"></a>04396 
<a name="l04397"></a>04397     bindContainerHandler(
<a name="l04398"></a>04398       domNode.getElementsByClassName(<span class="stringliteral">&#39;filter&#39;</span>)[0],
<a name="l04399"></a>04399       <span class="stringliteral">&#39;click&#39;</span>, this.onSearchFilterClick.bind(<span class="keyword">this</span>));
<a name="l04400"></a>04400     this.searchInput = domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-search-text&#39;</span>)[0];
<a name="l04401"></a>04401     this.searchInput.addEventListener(
<a name="l04402"></a>04402       <span class="stringliteral">&#39;input&#39;</span>, this.onSearchTextChange.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l04403"></a>04403   }
<a name="l04404"></a>04404 
<a name="l04405"></a>04405   <span class="comment">// convenience wrapper for context.</span>
<a name="l04406"></a>04406   this._onScroll = this._onScroll.bind(<span class="keyword">this</span>);
<a name="l04407"></a>04407 
<a name="l04408"></a>04408   this.editMode = <span class="keyword">false</span>;
<a name="l04409"></a>04409   this.selectedMessages = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04410"></a>04410 
<a name="l04411"></a>04411   this.curFolder = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04412"></a>04412   this.messagesSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04413"></a>04413   this.isIncomingFolder = <span class="keyword">true</span>;
<a name="l04414"></a>04414   this._boundSliceRequestComplete = this.onSliceRequestComplete.bind(<span class="keyword">this</span>);
<a name="l04415"></a>04415 
<a name="l04416"></a>04416   this.usingCachedNode = !!<a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>.cachedNode;
<a name="l04417"></a>04417 
<a name="l04418"></a>04418   this._boundFolderChanged = this._folderChanged.bind(<span class="keyword">this</span>);
<a name="l04419"></a>04419   model.latest(<span class="stringliteral">&#39;folder&#39;</span>, this._boundFolderChanged);
<a name="l04420"></a>04420 
<a name="l04421"></a>04421   this._boundOnNewMail = this.onNewMail.bind(<span class="keyword">this</span>);
<a name="l04422"></a>04422   model.on(<span class="stringliteral">&#39;newInboxMessages&#39;</span>, this._boundOnNewMail);
<a name="l04423"></a>04423 }
<a name="l04424"></a>04424 MessageListCard.prototype = {
<a name="l04433"></a>04433   PROGRESS_CANDYBAR_TIMEOUT_MS: 2000,
<a name="l04434"></a>04434 
<a name="l04439"></a>04439   _topbar: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04440"></a>04440 
<a name="l04441"></a>04441   postInsert: <span class="keyword">function</span>() {
<a name="l04442"></a>04442     this._hideSearchBoxByScrolling();
<a name="l04443"></a>04443 
<a name="l04444"></a>04444     <span class="keywordflow">if</span> (this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === <span class="stringliteral">&#39;search&#39;</span>)
<a name="l04445"></a>04445       this.searchInput.focus();
<a name="l04446"></a>04446   },
<a name="l04447"></a>04447 
<a name="l04448"></a>04448   onSearchButton: <span class="keyword">function</span>() {
<a name="l04449"></a>04449     <span class="comment">// Do not bother if there is no current folder.</span>
<a name="l04450"></a>04450     <span class="keywordflow">if</span> (!this.curFolder)
<a name="l04451"></a>04451       <span class="keywordflow">return</span>;
<a name="l04452"></a>04452 
<a name="l04453"></a>04453     Cards.pushCard(
<a name="l04454"></a>04454       <span class="stringliteral">&#39;message_list&#39;</span>, <span class="stringliteral">&#39;search&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>,
<a name="l04455"></a>04455       {
<a name="l04456"></a>04456         folder: this.curFolder
<a name="l04457"></a>04457       });
<a name="l04458"></a>04458   },
<a name="l04459"></a>04459 
<a name="l04460"></a>04460   setEditMode: <span class="keyword">function</span>(editMode) {
<a name="l04461"></a>04461     <span class="comment">// Do not bother if this is triggered before</span>
<a name="l04462"></a>04462     <span class="comment">// a folder has loaded.</span>
<a name="l04463"></a>04463     <span class="keywordflow">if</span> (!this.curFolder)
<a name="l04464"></a>04464       <span class="keywordflow">return</span>;
<a name="l04465"></a>04465 
<a name="l04466"></a>04466     var domNode = this.domNode;
<a name="l04467"></a>04467     <span class="comment">// XXX the manual DOM play here is now a bit overkill; we should very</span>
<a name="l04468"></a>04468     <span class="comment">// probably switch top having the CSS do this for us or at least invest</span>
<a name="l04469"></a>04469     <span class="comment">// some time in cleanup.</span>
<a name="l04470"></a>04470     var normalHeader = domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-list-header&#39;</span>)[0],
<a name="l04471"></a>04471         searchHeader = domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-search-header&#39;</span>)[0],
<a name="l04472"></a>04472         editHeader = domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-listedit-header&#39;</span>)[0],
<a name="l04473"></a>04473         normalToolbar =
<a name="l04474"></a>04474           domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-list-action-toolbar&#39;</span>)[0],
<a name="l04475"></a>04475         editToolbar =
<a name="l04476"></a>04476           domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-listedit-action-toolbar&#39;</span>)[0];
<a name="l04477"></a>04477 
<a name="l04478"></a>04478     this.editMode = editMode;
<a name="l04479"></a>04479 
<a name="l04480"></a>04480     <span class="keywordflow">if</span> (editMode) {
<a name="l04481"></a>04481       normalHeader.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04482"></a>04482       searchHeader.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04483"></a>04483       normalToolbar.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04484"></a>04484       editHeader.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04485"></a>04485       editToolbar.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04486"></a>04486       this.messagesContainer.classList.add(<span class="stringliteral">&#39;show-edit&#39;</span>);
<a name="l04487"></a>04487 
<a name="l04488"></a>04488       this.selectedMessages = [];
<a name="l04489"></a>04489       var cbs = this.messagesContainer.querySelectorAll(<span class="stringliteral">&#39;input[type=checkbox]&#39;</span>);
<a name="l04490"></a>04490       <span class="keywordflow">for</span> (var i = 0; i &lt; cbs.length; i++) {
<a name="l04491"></a>04491         cbs[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].checked = <span class="keyword">false</span>;
<a name="l04492"></a>04492       }
<a name="l04493"></a>04493       this.selectedMessagesUpdated();
<a name="l04494"></a>04494     }
<a name="l04495"></a>04495     <span class="keywordflow">else</span> {
<a name="l04496"></a>04496       <span class="keywordflow">if</span> (this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === <span class="stringliteral">&#39;nonsearch&#39;</span>)
<a name="l04497"></a>04497         normalHeader.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04498"></a>04498       <span class="keywordflow">else</span>
<a name="l04499"></a>04499         searchHeader.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04500"></a>04500       normalToolbar.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04501"></a>04501       editHeader.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04502"></a>04502       editToolbar.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04503"></a>04503       this.messagesContainer.classList.remove(<span class="stringliteral">&#39;show-edit&#39;</span>);
<a name="l04504"></a>04504 
<a name="l04505"></a>04505       <span class="comment">// (Do this based on the DOM nodes actually present; if the user has been</span>
<a name="l04506"></a>04506       <span class="comment">// scrolling a lot, this.selectedMessages may contain messages that no</span>
<a name="l04507"></a>04507       <span class="comment">// longer have a domNode around.)</span>
<a name="l04508"></a>04508       var selectedMsgNodes =
<a name="l04509"></a>04509         domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-item-selected&#39;</span>);
<a name="l04510"></a>04510       <span class="keywordflow">for</span> (var i = selectedMsgNodes.length - 1; i &gt;= 0; i--) {
<a name="l04511"></a>04511         selectedMsgNodes[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].classList.remove(<span class="stringliteral">&#39;msg-header-item-selected&#39;</span>);
<a name="l04512"></a>04512       }
<a name="l04513"></a>04513 
<a name="l04514"></a>04514       this.selectedMessages = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04515"></a>04515     }
<a name="l04516"></a>04516 
<a name="l04517"></a>04517     <span class="comment">// UXXX do we want to disable the buttons if nothing is selected?</span>
<a name="l04518"></a>04518   },
<a name="l04519"></a>04519 
<a name="l04525"></a>04525   selectedMessagesUpdated: <span class="keyword">function</span>() {
<a name="l04526"></a>04526     var headerNode =
<a name="l04527"></a>04527       this.domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-listedit-header-label&#39;</span>)[0];
<a name="l04528"></a>04528     headerNode.textContent =
<a name="l04529"></a>04529       <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;message-multiedit-header&#39;</span>,
<a name="l04530"></a>04530                   { <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>: this.selectedMessages.length });
<a name="l04531"></a>04531 
<a name="l04532"></a>04532     var starBtn = this.domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-star-btn&#39;</span>)[0],
<a name="l04533"></a>04533         readBtn = this.domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-mark-read-btn&#39;</span>)[0];
<a name="l04534"></a>04534 
<a name="l04535"></a>04535     <span class="comment">// Enabling/disabling rules (not UX-signed-off):  Our bias is that people</span>
<a name="l04536"></a>04536     <span class="comment">// want to star messages and mark messages unread (since it they naturally</span>
<a name="l04537"></a>04537     <span class="comment">// end up unread), so unless messages are all in this state, we assume that</span>
<a name="l04538"></a>04538     <span class="comment">// is the desired action.</span>
<a name="l04539"></a>04539     var numStarred = 0, numRead = 0;
<a name="l04540"></a>04540     <span class="keywordflow">for</span> (var i = 0; i &lt; this.selectedMessages.length; i++) {
<a name="l04541"></a>04541       var <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a> = this.selectedMessages[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l04542"></a>04542       <span class="keywordflow">if</span> (msg.isStarred)
<a name="l04543"></a>04543         numStarred++;
<a name="l04544"></a>04544       <span class="keywordflow">if</span> (msg.isRead)
<a name="l04545"></a>04545         numRead++;
<a name="l04546"></a>04546     }
<a name="l04547"></a>04547 
<a name="l04548"></a>04548     <span class="comment">// Unstar if everything is starred, otherwise star</span>
<a name="l04549"></a>04549     this.setAsStarred = !(numStarred &amp;&amp; numStarred ===
<a name="l04550"></a>04550                           this.selectedMessages.length);
<a name="l04551"></a>04551     <span class="comment">// Mark read if everything is unread, otherwise unread</span>
<a name="l04552"></a>04552     this.setAsRead = (this.selectedMessages.length &amp;&amp; numRead === 0);
<a name="l04553"></a>04553 
<a name="l04554"></a>04554     <span class="keywordflow">if</span> (!this.setAsStarred)
<a name="l04555"></a>04555       starBtn.classList.add(<span class="stringliteral">&#39;msg-btn-active&#39;</span>);
<a name="l04556"></a>04556     <span class="keywordflow">else</span>
<a name="l04557"></a>04557       starBtn.classList.remove(<span class="stringliteral">&#39;msg-btn-active&#39;</span>);
<a name="l04558"></a>04558 
<a name="l04559"></a>04559     <span class="keywordflow">if</span> (this.setAsRead)
<a name="l04560"></a>04560       readBtn.classList.add(<span class="stringliteral">&#39;msg-btn-active&#39;</span>);
<a name="l04561"></a>04561     <span class="keywordflow">else</span>
<a name="l04562"></a>04562       readBtn.classList.remove(<span class="stringliteral">&#39;msg-btn-active&#39;</span>);
<a name="l04563"></a>04563   },
<a name="l04564"></a>04564 
<a name="l04565"></a>04565   _hideSearchBoxByScrolling: <span class="keyword">function</span>() {
<a name="l04566"></a>04566     <span class="comment">// scroll the search bit out of the way</span>
<a name="l04567"></a>04567     var searchBar =
<a name="l04568"></a>04568       this.domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-search-tease-bar&#39;</span>)[0];
<a name="l04569"></a>04569 
<a name="l04570"></a>04570     <span class="comment">// Search bar could have been collapsed with a cache load, make sure</span>
<a name="l04571"></a>04571     <span class="comment">// it is visible</span>
<a name="l04572"></a>04572     searchBar.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04573"></a>04573 
<a name="l04574"></a>04574     this.scrollNode.scrollTop = searchBar.offsetHeight;
<a name="l04575"></a>04575   },
<a name="l04576"></a>04576 
<a name="l04577"></a>04577   onShowFolders: <span class="keyword">function</span>() {
<a name="l04578"></a>04578     var query = [<span class="stringliteral">&#39;folder_picker&#39;</span>, <span class="stringliteral">&#39;navigation&#39;</span>];
<a name="l04579"></a>04579     <span class="keywordflow">if</span> (Cards.hasCard(query)) {
<a name="l04580"></a>04580       Cards.moveToCard(query);
<a name="l04581"></a>04581     } <span class="keywordflow">else</span> {
<a name="l04582"></a>04582       <span class="comment">// Add navigation, but before the message list.</span>
<a name="l04583"></a>04583       Cards.pushCard(
<a name="l04584"></a>04584         <span class="stringliteral">&#39;folder_picker&#39;</span>, <span class="stringliteral">&#39;navigation&#39;</span>, <span class="stringliteral">&#39;none&#39;</span>,
<a name="l04585"></a>04585         {
<a name="l04586"></a>04586           onPushed: <span class="keyword">function</span>() {
<a name="l04587"></a>04587             <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() {
<a name="l04588"></a>04588             <span class="comment">// Do showCard here instead of using an &#39;animate&#39;</span>
<a name="l04589"></a>04589             <span class="comment">// for the pushCard call, since the styling of</span>
<a name="l04590"></a>04590             <span class="comment">// the folder_picker uses new images that need to</span>
<a name="l04591"></a>04591             <span class="comment">// load, and if &#39;animate&#39; is used, the banner</span>
<a name="l04592"></a>04592             <span class="comment">// gradient is not loaded during the transition.</span>
<a name="l04593"></a>04593             <span class="comment">// The setTimeout also gives the header image a</span>
<a name="l04594"></a>04594             <span class="comment">// chance to finish loading. Without it, there is</span>
<a name="l04595"></a>04595             <span class="comment">// still a white flash. Going lower than 50, not</span>
<a name="l04596"></a>04596             <span class="comment">// specifying a value, still resulted in white flash.</span>
<a name="l04597"></a>04597             Cards.moveToCard(query);
<a name="l04598"></a>04598           }, 50);
<a name="l04599"></a>04599           }.bind(<span class="keyword">this</span>)
<a name="l04600"></a>04600         },
<a name="l04601"></a>04601         <span class="comment">// Place to left of message list</span>
<a name="l04602"></a>04602         <span class="stringliteral">&#39;left&#39;</span>);
<a name="l04603"></a>04603     }
<a name="l04604"></a>04604   },
<a name="l04605"></a>04605 
<a name="l04606"></a>04606   onCompose: <span class="keyword">function</span>() {
<a name="l04607"></a>04607     Cards.pushCard(<span class="stringliteral">&#39;compose&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>);
<a name="l04608"></a>04608   },
<a name="l04609"></a>04609 
<a name="l04614"></a>04614   showFolder: <span class="keyword">function</span>(folder, forceNewSlice) {
<a name="l04615"></a>04615     <span class="keywordflow">if</span> (folder === this.curFolder &amp;&amp; !forceNewSlice)
<a name="l04616"></a>04616       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04617"></a>04617 
<a name="l04618"></a>04618     <span class="keywordflow">if</span> (this.messagesSlice) {
<a name="l04619"></a>04619       this.messagesSlice.die();
<a name="l04620"></a>04620       this.messagesSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04621"></a>04621       this.messagesContainer.innerHTML = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04622"></a>04622     }
<a name="l04623"></a>04623 
<a name="l04624"></a>04624     this.curFolder = folder;
<a name="l04625"></a>04625 
<a name="l04626"></a>04626     <span class="keywordflow">switch</span> (folder.type) {
<a name="l04627"></a>04627       <span class="keywordflow">case</span> <span class="stringliteral">&#39;drafts&#39;</span>:
<a name="l04628"></a>04628       <span class="keywordflow">case</span> <span class="stringliteral">&#39;localdrafts&#39;</span>:
<a name="l04629"></a>04629       <span class="keywordflow">case</span> <span class="stringliteral">&#39;sent&#39;</span>:
<a name="l04630"></a>04630         this.isIncomingFolder = <span class="keyword">false</span>;
<a name="l04631"></a>04631         <span class="keywordflow">break</span>;
<a name="l04632"></a>04632       <span class="keywordflow">default</span>:
<a name="l04633"></a>04633         this.isIncomingFolder = <span class="keyword">true</span>;
<a name="l04634"></a>04634         <span class="keywordflow">break</span>;
<a name="l04635"></a>04635     }
<a name="l04636"></a>04636 
<a name="l04637"></a>04637     this.domNode.getElementsByClassName(<span class="stringliteral">&#39;msg-list-header-folder-label&#39;</span>)[0]
<a name="l04638"></a>04638       .textContent = folder.name;
<a name="l04639"></a>04639 
<a name="l04640"></a>04640     this.hideEmptyLayout();
<a name="l04641"></a>04641 
<a name="l04642"></a>04642     <span class="comment">// you can&#39;t refresh the localdrafts folder or move messages out of it.</span>
<a name="l04643"></a>04643     <span class="keywordflow">if</span> (folder.type === <span class="stringliteral">&#39;localdrafts&#39;</span>) {
<a name="l04644"></a>04644       this.toolbar.refreshBtn.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04645"></a>04645       this.toolbar.moveBtn.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04646"></a>04646     }
<a name="l04647"></a>04647     <span class="keywordflow">else</span> {
<a name="l04648"></a>04648       this.toolbar.refreshBtn.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04649"></a>04649       this.toolbar.moveBtn.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04650"></a>04650     }
<a name="l04651"></a>04651 
<a name="l04652"></a>04652     <span class="comment">// We are creating a new slice, so any pending snippet requests are moot.</span>
<a name="l04653"></a>04653     this._snippetRequestPending = <span class="keyword">false</span>;
<a name="l04654"></a>04654     this.messagesSlice = model.api.viewFolderMessages(folder);
<a name="l04655"></a>04655 
<a name="l04656"></a>04656     this.messagesSlice.onsplice = this.onMessagesSplice.bind(<span class="keyword">this</span>);
<a name="l04657"></a>04657     this.messagesSlice.onchange = this.onMessagesChange.bind(<span class="keyword">this</span>);
<a name="l04658"></a>04658     this.messagesSlice.onstatus = this.onStatusChange.bind(<span class="keyword">this</span>);
<a name="l04659"></a>04659     this.messagesSlice.oncomplete = this._boundSliceRequestComplete;
<a name="l04660"></a>04660     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04661"></a>04661   },
<a name="l04662"></a>04662 
<a name="l04663"></a>04663   showSearch: <span class="keyword">function</span>(folder, phrase, <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a>) {
<a name="l04664"></a>04664     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;sf: showSearch. phrase:&#39;</span>, phrase, phrase.length);
<a name="l04665"></a>04665     var tab = this.domNode.getElementsByClassName(<span class="stringliteral">&#39;filter&#39;</span>)[0];
<a name="l04666"></a>04666     var <a class="code" href="../../da/df2/namespacexml2dict.html#aaabd7336a42f36f8a79edd9e5fc821cf">nodes</a> = tab.getElementsByClassName(<span class="stringliteral">&#39;msg-search-filter&#39;</span>);
<a name="l04667"></a>04667     <span class="keywordflow">if</span> (this.messagesSlice) {
<a name="l04668"></a>04668       this.messagesSlice.die();
<a name="l04669"></a>04669       this.messagesSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04670"></a>04670       this.messagesContainer.innerHTML = <span class="stringliteral">&#39;&#39;</span>;
<a name="l04671"></a>04671     }
<a name="l04672"></a>04672     this.curFolder = folder;
<a name="l04673"></a>04673     this.curPhrase = phrase;
<a name="l04674"></a>04674     this.curFilter = <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a>;
<a name="l04675"></a>04675 
<a name="l04676"></a>04676     <span class="keywordflow">for</span> (var i = 0; i &lt; nodes.length; i++) {
<a name="l04677"></a>04677       <span class="keywordflow">if</span> (nodes[i].dataset.filter != <span class="keyword">this</span>.curFilter) {
<a name="l04678"></a>04678         nodes[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].setAttribute(<span class="stringliteral">&#39;aria-selected&#39;</span>, <span class="stringliteral">&#39;false&#39;</span>);
<a name="l04679"></a>04679         <span class="keywordflow">continue</span>;
<a name="l04680"></a>04680       }
<a name="l04681"></a>04681       nodes[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].setAttribute(<span class="stringliteral">&#39;aria-selected&#39;</span>, <span class="stringliteral">&#39;true&#39;</span>);
<a name="l04682"></a>04682     }
<a name="l04683"></a>04683     <span class="keywordflow">if</span> (phrase.length &lt; 1)
<a name="l04684"></a>04684       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04685"></a>04685 
<a name="l04686"></a>04686     <span class="comment">// We are creating a new slice, so any pending snippet requests are moot.</span>
<a name="l04687"></a>04687     this._snippetRequestPending = <span class="keyword">false</span>;
<a name="l04688"></a>04688     this.messagesSlice = model.api.searchFolderMessages(
<a name="l04689"></a>04689       folder, phrase,
<a name="l04690"></a>04690       {
<a name="l04691"></a>04691         <a class="code" href="../../dd/dc4/namespacesetup.html#a7b92894168460f935bc49467954c4a92">author</a>: <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> === <span class="stringliteral">&#39;all&#39;</span> || <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> === <span class="stringliteral">&#39;author&#39;</span>,
<a name="l04692"></a>04692         recipients: <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> === <span class="stringliteral">&#39;all&#39;</span> || <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> === <span class="stringliteral">&#39;recipients&#39;</span>,
<a name="l04693"></a>04693         subject: <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> === <span class="stringliteral">&#39;all&#39;</span> || <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> === <span class="stringliteral">&#39;subject&#39;</span>,
<a name="l04694"></a>04694         body: <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> === <span class="stringliteral">&#39;all&#39;</span> || <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#ab628e67f85699825109c59795f6ece42">filter</a> === <span class="stringliteral">&#39;body&#39;</span>
<a name="l04695"></a>04695       });
<a name="l04696"></a>04696     this.messagesSlice.onsplice = this.onMessagesSplice.bind(<span class="keyword">this</span>);
<a name="l04697"></a>04697     this.messagesSlice.onchange = this.updateMatchedMessageDom.bind(<span class="keyword">this</span>,
<a name="l04698"></a>04698                                                                     <span class="keyword">false</span>);
<a name="l04699"></a>04699     this.messagesSlice.onstatus = this.onStatusChange.bind(<span class="keyword">this</span>);
<a name="l04700"></a>04700     this.messagesSlice.oncomplete = this._boundSliceRequestComplete;
<a name="l04701"></a>04701     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04702"></a>04702   },
<a name="l04703"></a>04703 
<a name="l04704"></a>04704   onSearchFilterClick: <span class="keyword">function</span>(filterNode, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l04705"></a>04705     this.showSearch(this.curFolder, this.searchInput.value,
<a name="l04706"></a>04706                     filterNode.dataset.filter);
<a name="l04707"></a>04707   },
<a name="l04708"></a>04708 
<a name="l04709"></a>04709   onSearchTextChange: <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l04710"></a>04710     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;sf: typed, now:&#39;</span>, this.searchInput.value);
<a name="l04711"></a>04711     this.showSearch(this.curFolder, this.searchInput.value, <span class="keyword">this</span>.curFilter);
<a name="l04712"></a>04712   },
<a name="l04713"></a>04713 
<a name="l04714"></a>04714   onCancelSearch: <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l04715"></a>04715     <span class="keywordflow">try</span> {
<a name="l04716"></a>04716       <span class="keywordflow">if</span> (this.messagesSlice)
<a name="l04717"></a>04717         this.messagesSlice.die();
<a name="l04718"></a>04718     }
<a name="l04719"></a>04719     <span class="keywordflow">catch</span> (ex) {
<a name="l04720"></a>04720       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;problem killing slice:&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l04721"></a>04721     }
<a name="l04722"></a>04722     this.messagesSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04723"></a>04723     Cards.removeCardAndSuccessors(this.domNode, <span class="stringliteral">&#39;animate&#39;</span>);
<a name="l04724"></a>04724   },
<a name="l04725"></a>04725 
<a name="l04726"></a>04726   onGetMoreMessages: <span class="keyword">function</span>() {
<a name="l04727"></a>04727     <span class="keywordflow">if</span> (!this.messagesSlice)
<a name="l04728"></a>04728       <span class="keywordflow">return</span>;
<a name="l04729"></a>04729 
<a name="l04730"></a>04730     this.messagesSlice.requestGrowth(1, <span class="keyword">true</span>);
<a name="l04731"></a>04731     <span class="comment">// Provide instant feedback that they pressed the button by hiding the</span>
<a name="l04732"></a>04732     <span class="comment">// button.  However, don&#39;t show &#39;synchronizing&#39; because that might not</span>
<a name="l04733"></a>04733     <span class="comment">// actually happen.</span>
<a name="l04734"></a>04734     this.syncMoreNode.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04735"></a>04735   },
<a name="l04736"></a>04736 
<a name="l04737"></a>04737   onStatusChange: <span class="keyword">function</span>(newStatus) {
<a name="l04738"></a>04738     <span class="keywordflow">switch</span> (newStatus) {
<a name="l04739"></a>04739       <span class="keywordflow">case</span> <span class="stringliteral">&#39;synchronizing&#39;</span>:
<a name="l04740"></a>04740       <span class="keywordflow">case</span> <span class="stringliteral">&#39;syncblocked&#39;</span>:
<a name="l04741"></a>04741         this.syncingNode.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04742"></a>04742         this.syncMoreNode.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04743"></a>04743         this.hideEmptyLayout();
<a name="l04744"></a>04744 
<a name="l04745"></a>04745         this.toolbar.refreshBtn.dataset.state = <span class="stringliteral">&#39;synchronizing&#39;</span>;
<a name="l04746"></a>04746         <span class="keywordflow">break</span>;
<a name="l04747"></a>04747       <span class="keywordflow">case</span> <span class="stringliteral">&#39;syncfailed&#39;</span>:
<a name="l04748"></a>04748         <span class="comment">// If there was a problem talking to the server, notify the user and</span>
<a name="l04749"></a>04749         <span class="comment">// provide a means to attempt to talk to the server again.  We have made</span>
<a name="l04750"></a>04750         <span class="comment">// onRefresh pretty clever, so it can do all the legwork on</span>
<a name="l04751"></a>04751         <span class="comment">// accomplishing this goal.</span>
<a name="l04752"></a>04752         Toaster.logRetryable(newStatus, this.onRefresh.bind(<span class="keyword">this</span>));
<a name="l04753"></a>04753 
<a name="l04754"></a>04754         <span class="comment">// Fall through...</span>
<a name="l04755"></a>04755       <span class="keywordflow">case</span> <span class="stringliteral">&#39;synced&#39;</span>:
<a name="l04756"></a>04756         this.toolbar.refreshBtn.dataset.state = <span class="stringliteral">&#39;synchronized&#39;</span>;
<a name="l04757"></a>04757         this.syncingNode.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04758"></a>04758         <span class="keywordflow">break</span>;
<a name="l04759"></a>04759     }
<a name="l04760"></a>04760   },
<a name="l04761"></a>04761 
<a name="l04766"></a>04766   showEmptyLayout: <span class="keyword">function</span>() {
<a name="l04767"></a>04767     var text = this.domNode.
<a name="l04768"></a>04768       getElementsByClassName(<span class="stringliteral">&#39;msg-list-empty-message-text&#39;</span>)[0];
<a name="l04769"></a>04769 
<a name="l04770"></a>04770     this._clearCachedMessages();
<a name="l04771"></a>04771 
<a name="l04772"></a>04772     text.textContent = this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> == <span class="stringliteral">&#39;search&#39;</span> ?
<a name="l04773"></a>04773       <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;messages-search-empty&#39;</span>) :
<a name="l04774"></a>04774       <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;messages-folder-empty&#39;</span>);
<a name="l04775"></a>04775     this.messageEmptyContainer.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04776"></a>04776     this.toolbar.editBtn.classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l04777"></a>04777     this.toolbar.searchBtn.classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l04778"></a>04778     this._hideSearchBoxByScrolling();
<a name="l04779"></a>04779   },
<a name="l04784"></a>04784   hideEmptyLayout: <span class="keyword">function</span>() {
<a name="l04785"></a>04785     this.messageEmptyContainer.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04786"></a>04786     this.toolbar.editBtn.classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l04787"></a>04787     this.toolbar.searchBtn.classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l04788"></a>04788   },
<a name="l04789"></a>04789 
<a name="l04790"></a>04790 
<a name="l04794"></a>04794   onSliceRequestComplete: <span class="keyword">function</span>(newEmailCount) {
<a name="l04795"></a>04795     <span class="comment">// We always want our logic to fire, but complete auto-clears before firing.</span>
<a name="l04796"></a>04796     this.messagesSlice.oncomplete = this._boundSliceRequestComplete;
<a name="l04797"></a>04797 
<a name="l04798"></a>04798     <span class="keywordflow">if</span> (this.messagesSlice.userCanGrowDownwards)
<a name="l04799"></a>04799       this.syncMoreNode.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04800"></a>04800     <span class="keywordflow">else</span>
<a name="l04801"></a>04801       this.syncMoreNode.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l04802"></a>04802 
<a name="l04803"></a>04803     <span class="comment">// Show empty layout, unless this is a slice with fake data that</span>
<a name="l04804"></a>04804     <span class="comment">// will get changed soon.</span>
<a name="l04805"></a>04805     <span class="keywordflow">if</span> (this.messagesSlice.items.length === 0) {
<a name="l04806"></a>04806       this.showEmptyLayout();
<a name="l04807"></a>04807     }
<a name="l04808"></a>04808 
<a name="l04809"></a>04809     this.onNewMail(newEmailCount);
<a name="l04810"></a>04810 
<a name="l04811"></a>04811     <span class="comment">// Consider requesting more data or discarding data based on scrolling that</span>
<a name="l04812"></a>04812     <span class="comment">// has happened since we issued the request.  (While requests were pending,</span>
<a name="l04813"></a>04813     <span class="comment">// onScroll ignored scroll events.)</span>
<a name="l04814"></a>04814     this._onScroll(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l04815"></a>04815   },
<a name="l04816"></a>04816 
<a name="l04817"></a>04817   onNewMail: <span class="keyword">function</span>(newEmailCount) {
<a name="l04818"></a>04818     var inboxFolder = model.foldersSlice.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>);
<a name="l04819"></a>04819 
<a name="l04820"></a>04820     <span class="keywordflow">if</span> (inboxFolder.id === <span class="keyword">this</span>.curFolder.id &amp;&amp;
<a name="l04821"></a>04821         newEmailCount &amp;&amp; newEmailCount !== <a class="code" href="../../d2/da3/namespacegoogle_1_1protobuf_1_1internal.html#a2b5ccba6031cb434232aa272f11038e6">NaN</a> &amp;&amp; newEmailCount !== 0) {
<a name="l04822"></a>04822       <span class="keywordflow">if</span> (!Cards.isVisible(<span class="keyword">this</span>)) {
<a name="l04823"></a>04823         this._whenVisible = this.onNewMail.bind(<span class="keyword">this</span>, newEmailCount);
<a name="l04824"></a>04824         <span class="keywordflow">return</span>;
<a name="l04825"></a>04825       }
<a name="l04826"></a>04826 
<a name="l04827"></a>04827       <span class="comment">// Decorate or update the little notification bar that tells the user</span>
<a name="l04828"></a>04828       <span class="comment">// how many new emails they&#39;ve received after a sync.</span>
<a name="l04829"></a>04829       <span class="keywordflow">if</span> (this._topbar &amp;&amp; this._topbar.getElement() !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l04830"></a>04830         <span class="comment">// Update the existing status bar.</span>
<a name="l04831"></a>04831         this._topbar.updateNewEmailCount(newEmailCount);
<a name="l04832"></a>04832       } <span class="keywordflow">else</span> {
<a name="l04833"></a>04833         this._topbar = <span class="keyword">new</span> MessageListTopbar(
<a name="l04834"></a>04834             this.scrollContainer, newEmailCount);
<a name="l04835"></a>04835 
<a name="l04836"></a>04836         var el =
<a name="l04837"></a>04837             <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(MessageListTopbar.CLASS_NAME)[0];
<a name="l04838"></a>04838         this._topbar.decorate(el);
<a name="l04839"></a>04839         this._topbar.render();
<a name="l04840"></a>04840       }
<a name="l04841"></a>04841     }
<a name="l04842"></a>04842   },
<a name="l04843"></a>04843 
<a name="l04844"></a>04844   onScroll: <span class="keyword">function</span>(evt) {
<a name="l04845"></a>04845     <span class="keywordflow">if</span> (this._pendingScrollEvent) {
<a name="l04846"></a>04846       <span class="keywordflow">return</span>;
<a name="l04847"></a>04847     }
<a name="l04848"></a>04848 
<a name="l04849"></a>04849     this._pendingScrollEvent = <span class="keyword">true</span>;
<a name="l04850"></a>04850     this._scrollTimer = <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(this._onScroll, SCROLL_DELAY, evt);
<a name="l04851"></a>04851   },
<a name="l04852"></a>04852 
<a name="l04862"></a>04862   _onScroll: <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l04863"></a>04863     <span class="keywordflow">if</span> (this._pendingScrollEvent) {
<a name="l04864"></a>04864       this._pendingScrollEvent = <span class="keyword">false</span>;
<a name="l04865"></a>04865     }
<a name="l04866"></a>04866 
<a name="l04867"></a>04867 
<a name="l04868"></a>04868     <span class="comment">// Defer processing until any pending requests have completed;</span>
<a name="l04869"></a>04869     <span class="comment">// `onSliceRequestComplete` will call us.</span>
<a name="l04870"></a>04870     <span class="keywordflow">if</span> (!this.messagesSlice || this.messagesSlice.pendingRequestCount)
<a name="l04871"></a>04871       <span class="keywordflow">return</span>;
<a name="l04872"></a>04872 
<a name="l04873"></a>04873     <span class="keywordflow">if</span> (!this._hasSnippetRequest()) {
<a name="l04874"></a>04874       this._requestSnippets();
<a name="l04875"></a>04875     }
<a name="l04876"></a>04876 
<a name="l04877"></a>04877     var curScrollTop = this.scrollContainer.scrollTop,
<a name="l04878"></a>04878         viewHeight = this.scrollContainer.clientHeight;
<a name="l04879"></a>04879 
<a name="l04880"></a>04880     var preScreens = curScrollTop / viewHeight,
<a name="l04881"></a>04881         postScreens = (this.scrollContainer.scrollHeight -
<a name="l04882"></a>04882                        (curScrollTop + viewHeight)) /
<a name="l04883"></a>04883                       viewHeight;
<a name="l04884"></a>04884 
<a name="l04885"></a>04885     var shrinkLowIncl = 0,
<a name="l04886"></a>04886         shrinkHighIncl = this.messagesSlice.items.length - 1,
<a name="l04887"></a>04887         messageNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, targOff;
<a name="l04888"></a>04888     <span class="keywordflow">if</span> (preScreens &lt; SCROLL_MIN_BUFFER_SCREENS &amp;&amp;
<a name="l04889"></a>04889         !this.messagesSlice.atTop) {
<a name="l04890"></a>04890       this.messagesSlice.requestGrowth(-1);
<a name="l04891"></a>04891       <span class="keywordflow">return</span>;
<a name="l04892"></a>04892     }
<a name="l04893"></a>04893     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (preScreens &gt; SCROLL_MAX_RETENTION_SCREENS) {
<a name="l04894"></a>04894       <span class="comment">// Take off one screen at a time.</span>
<a name="l04895"></a>04895       targOff = curScrollTop -
<a name="l04896"></a>04896                 (viewHeight * (SCROLL_MAX_RETENTION_SCREENS - 1));
<a name="l04897"></a>04897       <span class="keywordflow">for</span> (messageNode = this.messagesContainer.firstElementChild;
<a name="l04898"></a>04898            messageNode.offsetTop + messageNode.clientHeight &lt; targOff;
<a name="l04899"></a>04899            messageNode = messageNode.nextElementSibling) {
<a name="l04900"></a>04900         shrinkLowIncl++;
<a name="l04901"></a>04901       }
<a name="l04902"></a>04902     }
<a name="l04903"></a>04903 
<a name="l04904"></a>04904     <span class="keywordflow">if</span> (postScreens &lt; SCROLL_MIN_BUFFER_SCREENS &amp;&amp;
<a name="l04905"></a>04905         !this.messagesSlice.atBottom) {
<a name="l04906"></a>04906       this.messagesSlice.requestGrowth(1);
<a name="l04907"></a>04907     }
<a name="l04908"></a>04908     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (postScreens &gt; SCROLL_MAX_RETENTION_SCREENS) {
<a name="l04909"></a>04909       targOff = curScrollTop +
<a name="l04910"></a>04910                 this.scrollContainer.clientHeight +
<a name="l04911"></a>04911                 (viewHeight * (SCROLL_MAX_RETENTION_SCREENS - 1));
<a name="l04912"></a>04912       <span class="keywordflow">for</span> (messageNode = this.messagesContainer.lastElementChild;
<a name="l04913"></a>04913            messageNode.offsetTop &gt; targOff;
<a name="l04914"></a>04914            messageNode = messageNode.previousElementSibling) {
<a name="l04915"></a>04915         shrinkHighIncl--;
<a name="l04916"></a>04916       }
<a name="l04917"></a>04917     }
<a name="l04918"></a>04918 
<a name="l04919"></a>04919     <span class="keywordflow">if</span> (shrinkLowIncl !== 0 ||
<a name="l04920"></a>04920         shrinkHighIncl !== this.messagesSlice.items.length - 1) {
<a name="l04921"></a>04921       this.messagesSlice.requestShrinkage(shrinkLowIncl, shrinkHighIncl);
<a name="l04922"></a>04922     }
<a name="l04923"></a>04923 
<a name="l04924"></a>04924   },
<a name="l04925"></a>04925 
<a name="l04926"></a>04926   _hasSnippetRequest: <span class="keyword">function</span>() {
<a name="l04927"></a>04927     var <a class="code" href="../../db/d13/ns_i_d_o_m_device_proximity_event_8idl.html#a0b0ede69e8156eb97acc579b88e883de">max</a> = MAXIMUM_MS_BETWEEN_SNIPPET_REQUEST;
<a name="l04928"></a>04928     var now = Date.now();
<a name="l04929"></a>04929 
<a name="l04930"></a>04930     <span class="comment">// if we before the maximum time to wait between requests...</span>
<a name="l04931"></a>04931     var beforeTimeout =
<a name="l04932"></a>04932       (this._lastSnippetRequest + <a class="code" href="../../db/d13/ns_i_d_o_m_device_proximity_event_8idl.html#a0b0ede69e8156eb97acc579b88e883de">max</a>) &gt; now;
<a name="l04933"></a>04933 
<a name="l04934"></a>04934     <span class="comment">// there is an important case where the backend may be slow OR have some</span>
<a name="l04935"></a>04935     <span class="comment">// fatal error which would prevent us from ever requesting an new set of</span>
<a name="l04936"></a>04936     <span class="comment">// snippets because we wait until the last batch finishes... To prevent that</span>
<a name="l04937"></a>04937     <span class="comment">// from ever happening we maintain the request start time and if more then</span>
<a name="l04938"></a>04938     <span class="comment">// MAXIMUM_MS_BETWEEN_SNIPPET_REQUEST passes we issue a new request.</span>
<a name="l04939"></a>04939     <span class="keywordflow">if</span> (
<a name="l04940"></a>04940       this._snippetRequestPending &amp;&amp;
<a name="l04941"></a>04941       beforeTimeout
<a name="l04942"></a>04942     ) {
<a name="l04943"></a>04943       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l04944"></a>04944     }
<a name="l04945"></a>04945 
<a name="l04946"></a>04946     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l04947"></a>04947   },
<a name="l04948"></a>04948 
<a name="l04949"></a>04949   _pendingSnippetRequest: <span class="keyword">function</span>() {
<a name="l04950"></a>04950     this._snippetRequestPending = <span class="keyword">true</span>;
<a name="l04951"></a>04951     this._lastSnippetRequest = Date.now();
<a name="l04952"></a>04952   },
<a name="l04953"></a>04953 
<a name="l04954"></a>04954   _clearSnippetRequest: <span class="keyword">function</span>() {
<a name="l04955"></a>04955     this._snippetRequestPending = <span class="keyword">false</span>;
<a name="l04956"></a>04956   },
<a name="l04957"></a>04957 
<a name="l04958"></a>04958   _requestSnippets: <span class="keyword">function</span>() {
<a name="l04959"></a>04959     var items = this.messagesSlice.items;
<a name="l04960"></a>04960     var <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a> = items.length;
<a name="l04961"></a>04961 
<a name="l04962"></a>04962     <span class="keywordflow">if</span> (!len)
<a name="l04963"></a>04963       <span class="keywordflow">return</span>;
<a name="l04964"></a>04964 
<a name="l04965"></a>04965     var clearSnippets = this._clearSnippetRequest.bind(<span class="keyword">this</span>);
<a name="l04966"></a>04966     var <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = {
<a name="l04967"></a>04967       <span class="comment">// this is per message</span>
<a name="l04968"></a>04968       maximumBytesToFetch: MAXIMUM_BYTES_PER_MESSAGE_DURING_SCROLL
<a name="l04969"></a>04969     };
<a name="l04970"></a>04970 
<a name="l04971"></a>04971     <span class="keywordflow">if</span> (len &lt; MINIMUM_ITEMS_FOR_SCROLL_CALC) {
<a name="l04972"></a>04972       this._pendingSnippetRequest();
<a name="l04973"></a>04973       this.messagesSlice.maybeRequestBodies(0, 9, options, clearSnippets);
<a name="l04974"></a>04974       <span class="keywordflow">return</span>;
<a name="l04975"></a>04975     }
<a name="l04976"></a>04976 
<a name="l04977"></a>04977     <span class="comment">// get the scrollable offset</span>
<a name="l04978"></a>04978     <span class="keywordflow">if</span> (!this._scrollContainerOffset) {
<a name="l04979"></a>04979       this._scrollContainerRect =
<a name="l04980"></a>04980         this.scrollContainer.getBoundingClientRect();
<a name="l04981"></a>04981     }
<a name="l04982"></a>04982 
<a name="l04983"></a>04983     var constOffset = this._scrollContainerRect.top;
<a name="l04984"></a>04984 
<a name="l04985"></a>04985     <span class="comment">// determine where we are in the list;</span>
<a name="l04986"></a>04986     var topOffset = (
<a name="l04987"></a>04987       items[0].element.getBoundingClientRect().top - constOffset
<a name="l04988"></a>04988     );
<a name="l04989"></a>04989 
<a name="l04990"></a>04990     <span class="comment">// the distance between items. It is expected to remain fairly constant</span>
<a name="l04991"></a>04991     <span class="comment">// throughout the list so we only need to calculate it once.</span>
<a name="l04992"></a>04992 
<a name="l04993"></a>04993     var distance = this._distanceBetweenMessages;
<a name="l04994"></a>04994     <span class="keywordflow">if</span> (!distance) {
<a name="l04995"></a>04995       this._distanceBetweenMessages = distance = Math.abs(
<a name="l04996"></a>04996         topOffset -
<a name="l04997"></a>04997         (items[1].element.getBoundingClientRect().top - constOffset)
<a name="l04998"></a>04998       );
<a name="l04999"></a>04999     }
<a name="l05000"></a>05000 
<a name="l05001"></a>05001     <span class="comment">// starting offset to begin fetching snippets</span>
<a name="l05002"></a>05002     var startOffset = Math.floor(Math.abs(topOffset / distance));
<a name="l05003"></a>05003 
<a name="l05004"></a>05004     this._snippetsPerScrollTick = (
<a name="l05005"></a>05005       this._snippetsPerScrollTick ||
<a name="l05006"></a>05006       Math.ceil(this._scrollContainerRect.height / distance)
<a name="l05007"></a>05007     );
<a name="l05008"></a>05008 
<a name="l05009"></a>05009 
<a name="l05010"></a>05010     this._pendingSnippetRequest();
<a name="l05011"></a>05011     this.messagesSlice.maybeRequestBodies(
<a name="l05012"></a>05012       startOffset,
<a name="l05013"></a>05013       startOffset + this._snippetsPerScrollTick,
<a name="l05014"></a>05014       options,
<a name="l05015"></a>05015       clearSnippets
<a name="l05016"></a>05016     );
<a name="l05017"></a>05017 
<a name="l05018"></a>05018   },
<a name="l05019"></a>05019 
<a name="l05024"></a>05024   _cacheListLimit: 7,
<a name="l05025"></a>05025 
<a name="l05030"></a>05030   _cacheDomTimeoutId: 0,
<a name="l05031"></a>05031 
<a name="l05035"></a>05035   _cacheDom: <span class="keyword">function</span>() {
<a name="l05036"></a>05036     this._cacheDomTimeoutId = 0;
<a name="l05037"></a>05037 
<a name="l05038"></a>05038     var cacheNode = this.domNode.cloneNode(<span class="keyword">true</span>);
<a name="l05039"></a>05039 
<a name="l05040"></a>05040 
<a name="l05041"></a>05041     <span class="comment">// Hide search field as it will not operate and gets scrolled out</span>
<a name="l05042"></a>05042     <span class="comment">// of view after real load.</span>
<a name="l05043"></a>05043     var removableCacheNode = cacheNode.querySelector(<span class="stringliteral">&#39;.msg-search-tease-bar&#39;</span>);
<a name="l05044"></a>05044     <span class="keywordflow">if</span> (removableCacheNode)
<a name="l05045"></a>05045       removableCacheNode.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l05046"></a>05046 
<a name="l05047"></a>05047     <span class="comment">// Hide &quot;new mail&quot; topbar too</span>
<a name="l05048"></a>05048     removableCacheNode = cacheNode
<a name="l05049"></a>05049                            .querySelector(<span class="charliteral">&#39;.&#39;</span> + MessageListTopbar.CLASS_NAME);
<a name="l05050"></a>05050     <span class="keywordflow">if</span> (removableCacheNode)
<a name="l05051"></a>05051       removableCacheNode.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l05052"></a>05052 
<a name="l05053"></a>05053     <span class="comment">// Trim the message list to _cacheListLimit.</span>
<a name="l05054"></a>05054     <span class="keywordflow">if</span> (this.messagesContainer.children.length &gt; <span class="keyword">this</span>._cacheListLimit) {
<a name="l05055"></a>05055       var msgContainer = cacheNode
<a name="l05056"></a>05056                         .getElementsByClassName(<span class="stringliteral">&#39;msg-messages-container&#39;</span>)[0];
<a name="l05057"></a>05057       <span class="keywordflow">for</span> (var childIndex = msgContainer.children.length - 1;
<a name="l05058"></a>05058                             childIndex &gt; <span class="keyword">this</span>._cacheListLimit - 1;
<a name="l05059"></a>05059                             childIndex--) {
<a name="l05060"></a>05060         var childNode = msgContainer.children[childIndex];
<a name="l05061"></a>05061         childNode.parentNode.removeChild(childNode);
<a name="l05062"></a>05062       }
<a name="l05063"></a>05063     }
<a name="l05064"></a>05064     htmlCache.saveFromNode(cacheNode);
<a name="l05065"></a>05065   },
<a name="l05066"></a>05066 
<a name="l05073"></a>05073   _considerCacheDom: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>) {
<a name="l05074"></a>05074     <span class="comment">// Only bother if not already waiting to update cache and</span>
<a name="l05075"></a>05075     <span class="keywordflow">if</span> (!this._cacheDomTimeoutId &amp;&amp;
<a name="l05076"></a>05076         <span class="comment">// is for the folder that is considered cacheable (default inbox)</span>
<a name="l05077"></a>05077         this.cacheableFolderId === this.curFolder.id &amp;&amp;
<a name="l05078"></a>05078         <span class="comment">// if our slice is showing the newest messages in the folder and</span>
<a name="l05079"></a>05079         <span class="keyword">this</span>.messagesSlice.atTop &amp;&amp;
<a name="l05080"></a>05080         <span class="comment">// if actually got a numeric index and</span>
<a name="l05081"></a>05081         (<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> || <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> === 0) &amp;&amp;
<a name="l05082"></a>05082         <span class="comment">// if it affects the data we cache</span>
<a name="l05083"></a>05083         <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> &lt; this._cacheListLimit &amp;&amp;
<a name="l05084"></a>05084         <span class="comment">// is in non-search mode</span>
<a name="l05085"></a>05085         this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> === <span class="stringliteral">&#39;nonsearch&#39;</span>) {
<a name="l05086"></a>05086       this._cacheDomTimeoutId = <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(this._cacheDom.bind(<span class="keyword">this</span>), 600);
<a name="l05087"></a>05087     }
<a name="l05088"></a>05088   },
<a name="l05089"></a>05089 
<a name="l05103"></a>05103   _clearCachedMessages: <span class="keyword">function</span>() {
<a name="l05104"></a>05104     <span class="keywordflow">if</span> (this.usingCachedNode) {
<a name="l05105"></a>05105       this.messagesContainer.innerHTML = <span class="stringliteral">&#39;&#39;</span>;
<a name="l05106"></a>05106       this.usingCachedNode = <span class="keyword">false</span>;
<a name="l05107"></a>05107     }
<a name="l05108"></a>05108   },
<a name="l05109"></a>05109 
<a name="l05110"></a>05110   onMessagesSplice: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>, howMany, addedItems,
<a name="l05111"></a>05111                              requested, moreExpected, fake) {
<a name="l05112"></a>05112     <span class="comment">// If no work to do, just skip it.</span>
<a name="l05113"></a>05113     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> === 0 &amp;&amp; howMany === 0 &amp;&amp; !addedItems.length)
<a name="l05114"></a>05114       <span class="keywordflow">return</span>;
<a name="l05115"></a>05115 
<a name="l05116"></a>05116     var prevHeight;
<a name="l05117"></a>05117     <span class="comment">// - removed messages</span>
<a name="l05118"></a>05118     <span class="keywordflow">if</span> (howMany) {
<a name="l05119"></a>05119       <span class="keywordflow">if</span> (fake &amp;&amp; <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> === 0 &amp;&amp; this.messagesSlice.items.length === howMany &amp;&amp;
<a name="l05120"></a>05120           !addedItems.length) {
<a name="l05121"></a>05121       } <span class="keywordflow">else</span> {
<a name="l05122"></a>05122         <span class="comment">// Regular remove for current call.</span>
<a name="l05123"></a>05123         <span class="comment">// Plan to fixup the scroll position if we are deleting a message that</span>
<a name="l05124"></a>05124         <span class="comment">// starts before the (visible) scrolled area.  (We add the container&#39;s</span>
<a name="l05125"></a>05125         <span class="comment">// start offset because it is as big as the occluding header bar.)</span>
<a name="l05126"></a>05126         prevHeight = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05127"></a>05127         <span class="keywordflow">if</span> (this.messagesSlice.items[<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>].element.offsetTop &lt;
<a name="l05128"></a>05128             <span class="keyword">this</span>.scrollContainer.scrollTop + <span class="keyword">this</span>.messagesContainer.offsetTop) {
<a name="l05129"></a>05129           prevHeight = this.messagesContainer.clientHeight;
<a name="l05130"></a>05130         }
<a name="l05131"></a>05131 
<a name="l05132"></a>05132         <span class="keywordflow">for</span> (var i = <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> + howMany - 1; i &gt;= <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>; i--) {
<a name="l05133"></a>05133           var <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a> = this.messagesSlice.items[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l05134"></a>05134           message.element.parentNode.removeChild(message.element);
<a name="l05135"></a>05135         }
<a name="l05136"></a>05136 
<a name="l05137"></a>05137         <span class="comment">// If fixup is requred, adjust.</span>
<a name="l05138"></a>05138         <span class="keywordflow">if</span> (prevHeight !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l05139"></a>05139           this.scrollContainer.scrollTop -=
<a name="l05140"></a>05140             (prevHeight - this.messagesContainer.clientHeight);
<a name="l05141"></a>05141         }
<a name="l05142"></a>05142 
<a name="l05143"></a>05143         <span class="comment">// Check the message count after deletion:</span>
<a name="l05144"></a>05144         <span class="keywordflow">if</span> (this.messagesContainer.children.length === 0) {
<a name="l05145"></a>05145           this.showEmptyLayout();
<a name="l05146"></a>05146         }
<a name="l05147"></a>05147       }
<a name="l05148"></a>05148     }
<a name="l05149"></a>05149 
<a name="l05150"></a>05150     this._clearCachedMessages();
<a name="l05151"></a>05151 
<a name="l05152"></a>05152     <span class="comment">// - added/existing</span>
<a name="l05153"></a>05153     var insertBuddy, <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l05154"></a>05154     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> &gt;= this.messagesContainer.childElementCount)
<a name="l05155"></a>05155       insertBuddy = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05156"></a>05156     <span class="keywordflow">else</span>
<a name="l05157"></a>05157       insertBuddy = this.messagesContainer.children[<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>];
<a name="l05158"></a>05158     <span class="keywordflow">if</span> (insertBuddy &amp;&amp;
<a name="l05159"></a>05159         (insertBuddy.offsetTop &lt;
<a name="l05160"></a>05160          <span class="keyword">this</span>.scrollContainer.scrollTop + <span class="keyword">this</span>.messagesContainer.offsetTop))
<a name="l05161"></a>05161       prevHeight = this.messagesContainer.clientHeight;
<a name="l05162"></a>05162     <span class="keywordflow">else</span>
<a name="l05163"></a>05163       prevHeight = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05164"></a>05164 
<a name="l05165"></a>05165     <span class="comment">// Remove the no message text while new messages added:</span>
<a name="l05166"></a>05166     <span class="keywordflow">if</span> (addedItems.length &gt; 0) {
<a name="l05167"></a>05167       this.hideEmptyLayout();
<a name="l05168"></a>05168     }
<a name="l05169"></a>05169 
<a name="l05170"></a>05170     addedItems.forEach(<span class="keyword">function</span>(message, i) {
<a name="l05171"></a>05171       var domMessage;
<a name="l05172"></a>05172       domMessage = message.element = msgHeaderItemNode.cloneNode(<span class="keyword">true</span>);
<a name="l05173"></a>05173 
<a name="l05174"></a>05174       <span class="keywordflow">if</span> (<span class="keyword">self</span>.mode === <span class="stringliteral">&#39;nonsearch&#39;</span>) {
<a name="l05175"></a>05175         domMessage.message = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>;
<a name="l05176"></a>05176         <span class="keyword">self</span>.updateMessageDom(<span class="keyword">true</span>, message);
<a name="l05177"></a>05177       }
<a name="l05178"></a>05178       <span class="keywordflow">else</span> {
<a name="l05179"></a>05179         domMessage.message = message.header;
<a name="l05180"></a>05180         <span class="keyword">self</span>.updateMatchedMessageDom(<span class="keyword">true</span>, message);
<a name="l05181"></a>05181       }
<a name="l05182"></a>05182 
<a name="l05183"></a>05183       <span class="keyword">self</span>.messagesContainer.insertBefore(domMessage, insertBuddy);
<a name="l05184"></a>05184     });
<a name="l05185"></a>05185 
<a name="l05186"></a>05186     <span class="keywordflow">if</span> (prevHeight) {
<a name="l05187"></a>05187       this.scrollContainer.scrollTop +=
<a name="l05188"></a>05188         (this.messagesContainer.clientHeight - prevHeight);
<a name="l05189"></a>05189     }
<a name="l05190"></a>05190 
<a name="l05191"></a>05191     <span class="comment">// Only cache if it is an add or remove of items</span>
<a name="l05192"></a>05192     <span class="keywordflow">if</span> (addedItems.length || howMany) {
<a name="l05193"></a>05193       this._considerCacheDom(<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>);
<a name="l05194"></a>05194     }
<a name="l05195"></a>05195   },
<a name="l05196"></a>05196 
<a name="l05197"></a>05197   onMessagesChange: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>) {
<a name="l05198"></a>05198     this.updateMessageDom(<span class="keyword">false</span>, message);
<a name="l05199"></a>05199 
<a name="l05200"></a>05200     <span class="comment">// Since the DOM change, cache may need to change.</span>
<a name="l05201"></a>05201     this._considerCacheDom(<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>);
<a name="l05202"></a>05202   },
<a name="l05203"></a>05203 
<a name="l05204"></a>05204   _updatePeepDom: <span class="keyword">function</span>(peep) {
<a name="l05205"></a>05205     peep.element.textContent = peep.name || peep.address;
<a name="l05206"></a>05206   },
<a name="l05207"></a>05207 
<a name="l05208"></a>05208   updateMessageDom: <span class="keyword">function</span>(firstTime, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>) {
<a name="l05209"></a>05209     var msgNode = message.element;
<a name="l05210"></a>05210 
<a name="l05211"></a>05211     <span class="comment">// ID is stored as a data- attribute so that it can survive</span>
<a name="l05212"></a>05212     <span class="comment">// serialization to HTML for storing in the HTML cache, and</span>
<a name="l05213"></a>05213     <span class="comment">// be usable before the actual data from the backend has</span>
<a name="l05214"></a>05214     <span class="comment">// loaded, as clicks to the message list are allowed before</span>
<a name="l05215"></a>05215     <span class="comment">// the back end is available. For this reason, click</span>
<a name="l05216"></a>05216     <span class="comment">// handlers should use dataset.id when wanting the ID.</span>
<a name="l05217"></a>05217     msgNode.dataset.id = message.id;
<a name="l05218"></a>05218 
<a name="l05219"></a>05219     <span class="comment">// some things only need to be done once</span>
<a name="l05220"></a>05220     var dateNode = msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-date&#39;</span>)[0];
<a name="l05221"></a>05221     <span class="keywordflow">if</span> (firstTime) {
<a name="l05222"></a>05222       var listPerson;
<a name="l05223"></a>05223       <span class="keywordflow">if</span> (this.isIncomingFolder)
<a name="l05224"></a>05224         listPerson = message.author;
<a name="l05225"></a>05225       <span class="comment">// XXX This is not to UX spec, but this is a stop-gap and that would</span>
<a name="l05226"></a>05226       <span class="comment">// require adding strings which we cannot justify as a slipstream fix.</span>
<a name="l05227"></a>05227       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message.to &amp;&amp; message.to.length)
<a name="l05228"></a>05228         listPerson = message.to[0];
<a name="l05229"></a>05229       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message.cc &amp;&amp; message.cc.length)
<a name="l05230"></a>05230         listPerson = message.cc[0];
<a name="l05231"></a>05231       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (message.bcc &amp;&amp; message.bcc.length)
<a name="l05232"></a>05232         listPerson = message.bcc[0];
<a name="l05233"></a>05233       <span class="keywordflow">else</span>
<a name="l05234"></a>05234         listPerson = message.author;
<a name="l05235"></a>05235 
<a name="l05236"></a>05236       <span class="comment">// author</span>
<a name="l05237"></a>05237       listPerson.element =
<a name="l05238"></a>05238         msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-author&#39;</span>)[0];
<a name="l05239"></a>05239       listPerson.onchange = this._updatePeepDom;
<a name="l05240"></a>05240       listPerson.onchange(listPerson);
<a name="l05241"></a>05241       <span class="comment">// date</span>
<a name="l05242"></a>05242       dateNode.dataset.time = message.date.valueOf();
<a name="l05243"></a>05243       dateNode.textContent = prettyDate(message.date);
<a name="l05244"></a>05244       <span class="comment">// subject</span>
<a name="l05245"></a>05245       displaySubject(msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-subject&#39;</span>)[0],
<a name="l05246"></a>05246                      <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>);
<a name="l05247"></a>05247       <span class="comment">// attachments</span>
<a name="l05248"></a>05248       <span class="keywordflow">if</span> (message.hasAttachments)
<a name="l05249"></a>05249         msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-attachments&#39;</span>)[0]
<a name="l05250"></a>05250           .classList.add(<span class="stringliteral">&#39;msg-header-attachments-yes&#39;</span>);
<a name="l05251"></a>05251     }
<a name="l05252"></a>05252 
<a name="l05253"></a>05253     <span class="comment">// snippet</span>
<a name="l05254"></a>05254     msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-snippet&#39;</span>)[0]
<a name="l05255"></a>05255       .textContent = message.snippet;
<a name="l05256"></a>05256 
<a name="l05257"></a>05257     <span class="comment">// unread (we use very specific classes directly on the nodes rather than</span>
<a name="l05258"></a>05258     <span class="comment">// child selectors for hypothetical speed)</span>
<a name="l05259"></a>05259     var unreadNode =
<a name="l05260"></a>05260       msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-unread-section&#39;</span>)[0];
<a name="l05261"></a>05261     <span class="keywordflow">if</span> (message.isRead) {
<a name="l05262"></a>05262       unreadNode.classList.remove(<span class="stringliteral">&#39;msg-header-unread-section-unread&#39;</span>);
<a name="l05263"></a>05263       dateNode.classList.remove(<span class="stringliteral">&#39;msg-header-date-unread&#39;</span>);
<a name="l05264"></a>05264     }
<a name="l05265"></a>05265     <span class="keywordflow">else</span> {
<a name="l05266"></a>05266       unreadNode.classList.add(<span class="stringliteral">&#39;msg-header-unread-section-unread&#39;</span>);
<a name="l05267"></a>05267       dateNode.classList.add(<span class="stringliteral">&#39;msg-header-date-unread&#39;</span>);
<a name="l05268"></a>05268     }
<a name="l05269"></a>05269     <span class="comment">// star</span>
<a name="l05270"></a>05270     var starNode = msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-star&#39;</span>)[0];
<a name="l05271"></a>05271     <span class="keywordflow">if</span> (message.isStarred)
<a name="l05272"></a>05272       starNode.classList.add(<span class="stringliteral">&#39;msg-header-star-starred&#39;</span>);
<a name="l05273"></a>05273     <span class="keywordflow">else</span>
<a name="l05274"></a>05274       starNode.classList.remove(<span class="stringliteral">&#39;msg-header-star-starred&#39;</span>);
<a name="l05275"></a>05275   },
<a name="l05276"></a>05276 
<a name="l05277"></a>05277   updateMatchedMessageDom: <span class="keyword">function</span>(firstTime, matchedHeader) {
<a name="l05278"></a>05278     var msgNode = matchedHeader.element,
<a name="l05279"></a>05279         matches = matchedHeader.matches,
<a name="l05280"></a>05280         message = matchedHeader.header;
<a name="l05281"></a>05281 
<a name="l05282"></a>05282     <span class="comment">// Even though updateMatchedMessageDom is only used in searches,</span>
<a name="l05283"></a>05283     <span class="comment">// which likely will not be cached, the dataset.is is set to</span>
<a name="l05284"></a>05284     <span class="comment">// maintain parity withe updateMessageDom and so click handlers</span>
<a name="l05285"></a>05285     <span class="comment">// can always just use the dataset property.</span>
<a name="l05286"></a>05286     msgNode.dataset.id = matchedHeader.id;
<a name="l05287"></a>05287 
<a name="l05288"></a>05288     <span class="comment">// some things only need to be done once</span>
<a name="l05289"></a>05289     var dateNode = msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-date&#39;</span>)[0];
<a name="l05290"></a>05290     <span class="keywordflow">if</span> (firstTime) {
<a name="l05291"></a>05291       <span class="comment">// author</span>
<a name="l05292"></a>05292       var authorNode = msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-author&#39;</span>)[0];
<a name="l05293"></a>05293       <span class="keywordflow">if</span> (matches.author) {
<a name="l05294"></a>05294         appendMatchItemTo(matches.author, authorNode);
<a name="l05295"></a>05295       }
<a name="l05296"></a>05296       <span class="keywordflow">else</span> {
<a name="l05297"></a>05297         <span class="comment">// we can only update the name if it wasn&#39;t matched on.</span>
<a name="l05298"></a>05298         message.author.element = authorNode;
<a name="l05299"></a>05299         message.author.onchange = this._updatePeepDom;
<a name="l05300"></a>05300         message.author.onchange(message.author);
<a name="l05301"></a>05301       }
<a name="l05302"></a>05302 
<a name="l05303"></a>05303       <span class="comment">// date</span>
<a name="l05304"></a>05304       dateNode.dataset.time = message.date.valueOf();
<a name="l05305"></a>05305       dateNode.textContent = prettyDate(message.date);
<a name="l05306"></a>05306 
<a name="l05307"></a>05307       <span class="comment">// subject</span>
<a name="l05308"></a>05308       var subjectNode = msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-subject&#39;</span>)[0];
<a name="l05309"></a>05309       <span class="keywordflow">if</span> (matches.subject)
<a name="l05310"></a>05310         appendMatchItemTo(matches.subject[0], subjectNode);
<a name="l05311"></a>05311       <span class="keywordflow">else</span>
<a name="l05312"></a>05312         displaySubject(subjectNode, message);
<a name="l05313"></a>05313 
<a name="l05314"></a>05314       <span class="comment">// snippet</span>
<a name="l05315"></a>05315       var snippetNode = msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-snippet&#39;</span>)[0];
<a name="l05316"></a>05316       <span class="keywordflow">if</span> (matches.body)
<a name="l05317"></a>05317        appendMatchItemTo(matches.body[0], snippetNode);
<a name="l05318"></a>05318       <span class="keywordflow">else</span>
<a name="l05319"></a>05319         snippetNode.textContent = message.snippet;
<a name="l05320"></a>05320 
<a name="l05321"></a>05321       <span class="comment">// attachments</span>
<a name="l05322"></a>05322       <span class="keywordflow">if</span> (message.hasAttachments)
<a name="l05323"></a>05323         msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-attachments&#39;</span>)[0]
<a name="l05324"></a>05324           .classList.add(<span class="stringliteral">&#39;msg-header-attachments-yes&#39;</span>);
<a name="l05325"></a>05325     }
<a name="l05326"></a>05326 
<a name="l05327"></a>05327     <span class="comment">// unread (we use very specific classes directly on the nodes rather than</span>
<a name="l05328"></a>05328     <span class="comment">// child selectors for hypothetical speed)</span>
<a name="l05329"></a>05329     var unreadNode =
<a name="l05330"></a>05330       msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-unread-section&#39;</span>)[0];
<a name="l05331"></a>05331     <span class="keywordflow">if</span> (message.isRead) {
<a name="l05332"></a>05332       unreadNode.classList.remove(<span class="stringliteral">&#39;msg-header-unread-section-unread&#39;</span>);
<a name="l05333"></a>05333       dateNode.classList.remove(<span class="stringliteral">&#39;msg-header-date-unread&#39;</span>);
<a name="l05334"></a>05334     }
<a name="l05335"></a>05335     <span class="keywordflow">else</span> {
<a name="l05336"></a>05336       unreadNode.classList.add(<span class="stringliteral">&#39;msg-header-unread-section-unread&#39;</span>);
<a name="l05337"></a>05337       dateNode.classList.add(<span class="stringliteral">&#39;msg-header-date-unread&#39;</span>);
<a name="l05338"></a>05338     }
<a name="l05339"></a>05339     <span class="comment">// star</span>
<a name="l05340"></a>05340     var starNode = msgNode.getElementsByClassName(<span class="stringliteral">&#39;msg-header-star&#39;</span>)[0];
<a name="l05341"></a>05341     <span class="keywordflow">if</span> (message.isStarred)
<a name="l05342"></a>05342       starNode.classList.add(<span class="stringliteral">&#39;msg-header-star-starred&#39;</span>);
<a name="l05343"></a>05343     <span class="keywordflow">else</span>
<a name="l05344"></a>05344       starNode.classList.remove(<span class="stringliteral">&#39;msg-header-star-starred&#39;</span>);
<a name="l05345"></a>05345   },
<a name="l05346"></a>05346 
<a name="l05351"></a>05351   onCardVisible: <span class="keyword">function</span>() {
<a name="l05352"></a>05352     <span class="keywordflow">if</span> (this._whenVisible) {
<a name="l05353"></a>05353       var fn = this._whenVisible;
<a name="l05354"></a>05354       this._whenVisible = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05355"></a>05355       fn();
<a name="l05356"></a>05356     }
<a name="l05357"></a>05357   },
<a name="l05358"></a>05358 
<a name="l05359"></a>05359   onClickMessage: <span class="keyword">function</span>(messageNode, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l05360"></a>05360     var <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a> = messageNode.message;
<a name="l05361"></a>05361     <span class="keywordflow">if</span> (this.editMode) {
<a name="l05362"></a>05362       var idx = this.selectedMessages.indexOf(header);
<a name="l05363"></a>05363       var <a class="code" href="../../d2/d7d/jsapi_8h.html#a9c0cec265243907d0da86b92bda26eca">cb</a> = messageNode.querySelector(<span class="stringliteral">&#39;input[type=checkbox]&#39;</span>);
<a name="l05364"></a>05364       <span class="keywordflow">if</span> (idx !== -1) {
<a name="l05365"></a>05365         this.selectedMessages.splice(idx, 1);
<a name="l05366"></a>05366         cb.checked = <span class="keyword">false</span>;
<a name="l05367"></a>05367       }
<a name="l05368"></a>05368       <span class="keywordflow">else</span> {
<a name="l05369"></a>05369         this.selectedMessages.push(header);
<a name="l05370"></a>05370         cb.checked = <span class="keyword">true</span>;
<a name="l05371"></a>05371       }
<a name="l05372"></a>05372       this.selectedMessagesUpdated();
<a name="l05373"></a>05373       <span class="keywordflow">return</span>;
<a name="l05374"></a>05374     }
<a name="l05375"></a>05375 
<a name="l05376"></a>05376     <span class="keywordflow">if</span> (this.curFolder &amp;&amp; this.curFolder.type === <span class="stringliteral">&#39;localdrafts&#39;</span>) {
<a name="l05377"></a>05377       var composer = header.editAsDraft(<span class="keyword">function</span>() {
<a name="l05378"></a>05378         Cards.pushCard(<span class="stringliteral">&#39;compose&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>,
<a name="l05379"></a>05379                        { composer: composer });
<a name="l05380"></a>05380       });
<a name="l05381"></a>05381       <span class="keywordflow">return</span>;
<a name="l05382"></a>05382     }
<a name="l05383"></a>05383 
<a name="l05384"></a>05384     Cards.pushCard(
<a name="l05385"></a>05385       <span class="stringliteral">&#39;message_reader&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>,
<a name="l05386"></a>05386       {
<a name="l05387"></a>05387         <span class="comment">// The header here may be undefined here, since the click</span>
<a name="l05388"></a>05388         <span class="comment">// could be on a cached HTML node before the back end has</span>
<a name="l05389"></a>05389         <span class="comment">// started up. It is OK if header is not available as the</span>
<a name="l05390"></a>05390         <span class="comment">// message_reader knows how to wait for the back end to</span>
<a name="l05391"></a>05391         <span class="comment">// start up to get the header value later.</span>
<a name="l05392"></a>05392         header: <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>,
<a name="l05393"></a>05393         <span class="comment">// Use the property on the HTML, since the click could be</span>
<a name="l05394"></a>05394         <span class="comment">// from a cached HTML node and the real data object may not</span>
<a name="l05395"></a>05395         <span class="comment">// be available yet.</span>
<a name="l05396"></a>05396         messageSuid: messageNode.dataset.id
<a name="l05397"></a>05397       });
<a name="l05398"></a>05398   },
<a name="l05399"></a>05399 
<a name="l05400"></a>05400   onHoldMessage: <span class="keyword">function</span>(messageNode, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l05401"></a>05401     <span class="keywordflow">if</span> (this.curFolder)
<a name="l05402"></a>05402       this.setEditMode(<span class="keyword">true</span>);
<a name="l05403"></a>05403   },
<a name="l05404"></a>05404 
<a name="l05405"></a>05405   onRefresh: <span class="keyword">function</span>() {
<a name="l05406"></a>05406     <span class="keywordflow">if</span> (!this.messagesSlice)
<a name="l05407"></a>05407       <span class="keywordflow">return</span>;
<a name="l05408"></a>05408 
<a name="l05409"></a>05409     <span class="keywordflow">switch</span> (this.messagesSlice.status) {
<a name="l05410"></a>05410       <span class="comment">// If we&#39;re still synchronizing, then the user is not well served by</span>
<a name="l05411"></a>05411       <span class="comment">// queueing a refresh yet, let&#39;s just squash this.</span>
<a name="l05412"></a>05412       <span class="keywordflow">case</span> <span class="stringliteral">&#39;new&#39;</span>:
<a name="l05413"></a>05413       <span class="keywordflow">case</span> <span class="stringliteral">&#39;synchronizing&#39;</span>:
<a name="l05414"></a>05414         <span class="keywordflow">break</span>;
<a name="l05415"></a>05415       <span class="comment">// If we fully synchronized, then yes, let us refresh.</span>
<a name="l05416"></a>05416       <span class="keywordflow">case</span> <span class="stringliteral">&#39;synced&#39;</span>:
<a name="l05417"></a>05417         this.messagesSlice.refresh();
<a name="l05418"></a>05418         <span class="keywordflow">break</span>;
<a name="l05419"></a>05419       <span class="comment">// If we failed to talk to the server, then let&#39;s only do a refresh if we</span>
<a name="l05420"></a>05420       <span class="comment">// know about any messages.  Otherwise let&#39;s just create a new slice by</span>
<a name="l05421"></a>05421       <span class="comment">// forcing reentry into the folder.</span>
<a name="l05422"></a>05422       <span class="keywordflow">case</span> <span class="stringliteral">&#39;syncfailed&#39;</span>:
<a name="l05423"></a>05423         <span class="keywordflow">if</span> (this.messagesSlice.items.length)
<a name="l05424"></a>05424           this.messagesSlice.refresh();
<a name="l05425"></a>05425         <span class="keywordflow">else</span>
<a name="l05426"></a>05426           this.showFolder(this.curFolder, <span class="comment">/* force new slice */</span> <span class="keyword">true</span>);
<a name="l05427"></a>05427         <span class="keywordflow">break</span>;
<a name="l05428"></a>05428     }
<a name="l05429"></a>05429   },
<a name="l05430"></a>05430 
<a name="l05431"></a>05431   onStarMessages: <span class="keyword">function</span>() {
<a name="l05432"></a>05432     var op = model.api.markMessagesStarred(this.selectedMessages,
<a name="l05433"></a>05433                                          this.setAsStarred);
<a name="l05434"></a>05434     this.setEditMode(<span class="keyword">false</span>);
<a name="l05435"></a>05435     Toaster.logMutation(op);
<a name="l05436"></a>05436   },
<a name="l05437"></a>05437 
<a name="l05438"></a>05438   onMarkMessagesRead: <span class="keyword">function</span>() {
<a name="l05439"></a>05439     var op = model.api.markMessagesRead(this.selectedMessages, this.setAsRead);
<a name="l05440"></a>05440     this.setEditMode(<span class="keyword">false</span>);
<a name="l05441"></a>05441     Toaster.logMutation(op);
<a name="l05442"></a>05442   },
<a name="l05443"></a>05443 
<a name="l05444"></a>05444   onDeleteMessages: <span class="keyword">function</span>() {
<a name="l05445"></a>05445     <span class="comment">// TODO: Batch delete back-end mail api is not ready for IMAP now.</span>
<a name="l05446"></a>05446     <span class="comment">//       Please verify this function under IMAP when api completed.</span>
<a name="l05447"></a>05447 
<a name="l05448"></a>05448     <span class="keywordflow">if</span> (this.selectedMessages.length === 0)
<a name="l05449"></a>05449       <span class="keywordflow">return</span>;
<a name="l05450"></a>05450 
<a name="l05451"></a>05451     var <a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a> = deleteConfirmMsgNode.cloneNode(<span class="keyword">true</span>);
<a name="l05452"></a>05452     var <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a4a1b5640b674da15d6f1b87899e53789">content</a> = dialog.getElementsByTagName(<span class="charliteral">&#39;p&#39;</span>)[0];
<a name="l05453"></a>05453     content.textContent = <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;message-multiedit-delete-confirm&#39;</span>,
<a name="l05454"></a>05454                                       { <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>: this.selectedMessages.length });
<a name="l05455"></a>05455     ConfirmDialog.show(dialog,
<a name="l05456"></a>05456       { <span class="comment">// Confirm</span>
<a name="l05457"></a>05457         <span class="keywordtype">id</span>: <span class="stringliteral">&#39;msg-delete-ok&#39;</span>,
<a name="l05458"></a>05458         <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a>: <span class="keyword">function</span>() {
<a name="l05459"></a>05459           var op = model.api.deleteMessages(this.selectedMessages);
<a name="l05460"></a>05460           Toaster.logMutation(op);
<a name="l05461"></a>05461           this.setEditMode(<span class="keyword">false</span>);
<a name="l05462"></a>05462         }.bind(<span class="keyword">this</span>)
<a name="l05463"></a>05463       },
<a name="l05464"></a>05464       { <span class="comment">// Cancel</span>
<a name="l05465"></a>05465         <span class="keywordtype">id</span>: <span class="stringliteral">&#39;msg-delete-cancel&#39;</span>,
<a name="l05466"></a>05466         <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>
<a name="l05467"></a>05467       }
<a name="l05468"></a>05468     );
<a name="l05469"></a>05469   },
<a name="l05470"></a>05470 
<a name="l05471"></a>05471   onMoveMessages: <span class="keyword">function</span>() {
<a name="l05472"></a>05472     <span class="comment">// TODO: Batch move back-end mail api is not ready now.</span>
<a name="l05473"></a>05473     <span class="comment">//       Please verify this function when api landed.</span>
<a name="l05474"></a>05474     Cards.folderSelector(<span class="keyword">function</span>(folder) {
<a name="l05475"></a>05475       var op = model.api.moveMessages(this.selectedMessages, folder);
<a name="l05476"></a>05476       Toaster.logMutation(op);
<a name="l05477"></a>05477       this.setEditMode(<span class="keyword">false</span>);
<a name="l05478"></a>05478     }.bind(<span class="keyword">this</span>));
<a name="l05479"></a>05479   },
<a name="l05480"></a>05480 
<a name="l05481"></a>05481   _folderChanged: <span class="keyword">function</span>(folder) {
<a name="l05482"></a>05482     <span class="comment">// It is possible that the notification of latest folder is fired</span>
<a name="l05483"></a>05483     <span class="comment">// but in the meantime the foldersSlice could be cleared due to</span>
<a name="l05484"></a>05484     <span class="comment">// a change in the current account, before this listener is called.</span>
<a name="l05485"></a>05485     <span class="comment">// So skip this work if no foldersSlice, this method will be called</span>
<a name="l05486"></a>05486     <span class="comment">// again soon.</span>
<a name="l05487"></a>05487     <span class="keywordflow">if</span> (!model.foldersSlice)
<a name="l05488"></a>05488       <span class="keywordflow">return</span>;
<a name="l05489"></a>05489 
<a name="l05490"></a>05490     <span class="comment">// Folder could have changed because account changed. Make sure</span>
<a name="l05491"></a>05491     <span class="comment">// the cacheableFolderId is still set correctly.</span>
<a name="l05492"></a>05492     var inboxFolder = model.foldersSlice.getFirstFolderWithType(<span class="stringliteral">&#39;inbox&#39;</span>);
<a name="l05493"></a>05493     this.cacheableFolderId = model.account === model.acctsSlice.defaultAccount ?
<a name="l05494"></a>05494                                                inboxFolder.id : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05495"></a>05495 
<a name="l05496"></a>05496     this.folder = folder;
<a name="l05497"></a>05497 
<a name="l05498"></a>05498     <span class="keywordflow">if</span> (this.mode == <span class="stringliteral">&#39;nonsearch&#39;</span>) {
<a name="l05499"></a>05499       <span class="keywordflow">if</span> (this.showFolder(folder)) {
<a name="l05500"></a>05500         this._hideSearchBoxByScrolling();
<a name="l05501"></a>05501       }
<a name="l05502"></a>05502     } <span class="keywordflow">else</span> {
<a name="l05503"></a>05503       this.showSearch(folder, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;all&#39;</span>);
<a name="l05504"></a>05504     }
<a name="l05505"></a>05505   },
<a name="l05506"></a>05506 
<a name="l05507"></a>05507   <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span>() {
<a name="l05508"></a>05508     <span class="keywordflow">if</span> (this.messagesSlice) {
<a name="l05509"></a>05509       this.messagesSlice.die();
<a name="l05510"></a>05510       this.messagesSlice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05511"></a>05511     }
<a name="l05512"></a>05512     model.removeListener(<span class="stringliteral">&#39;folder&#39;</span>, this._boundFolderChanged);
<a name="l05513"></a>05513     model.removeListener(<span class="stringliteral">&#39;newInboxMessages&#39;</span>, this._boundOnNewMail);
<a name="l05514"></a>05514   }
<a name="l05515"></a>05515 };
<a name="l05516"></a>05516 Cards.defineCard({
<a name="l05517"></a>05517   <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;message_list&#39;</span>,
<a name="l05518"></a>05518   <a class="code" href="../../df/d12/latin__test_8js.html#ad2cf4a40f77d475a65733c0477e3fba8">modes</a>: {
<a name="l05519"></a>05519     nonsearch: {
<a name="l05520"></a>05520       tray: <span class="keyword">false</span>
<a name="l05521"></a>05521     },
<a name="l05522"></a>05522     <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a86efbc42dbdb988b9a864b83af26e0de">search</a>: {
<a name="l05523"></a>05523       tray: <span class="keyword">false</span>
<a name="l05524"></a>05524     }
<a name="l05525"></a>05525   },
<a name="l05526"></a>05526   <a class="code" href="../../d8/d14/_cloud_apps_8js.html#af72715521e98346fe28d30efb7887846">constructor</a>: MessageListCard,
<a name="l05527"></a>05527   templateNode: templateNode
<a name="l05528"></a>05528 });
<a name="l05529"></a>05529 
<a name="l05530"></a>05530 <span class="keywordflow">return</span> MessageListCard;
<a name="l05531"></a>05531 });
<a name="l05532"></a>05532 
<a name="l05537"></a>05537 <span class="comment">/*jshint browser: true */</span>
<a name="l05538"></a>05538 <span class="comment">/*global define, requirejs, confirm, console, TestUrlResolver */</span>
<a name="l05539"></a>05539 
<a name="l05540"></a>05540 <span class="comment">// Set up loading of scripts, but only if not in tests, which set up</span>
<a name="l05541"></a>05541 <span class="comment">// their own config.</span>
<a name="l05542"></a><a class="code" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html#a7cd3df564e02ced42a2747c8eade794b">05542</a> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> TestUrlResolver === <span class="stringliteral">&#39;undefined&#39;</span>) {
<a name="l05543"></a>05543   <a class="code" href="../../d9/d2e/alameda_8js.html#a44c2a92e377407b0af593e79fa27596f">requirejs</a>.config({
<a name="l05544"></a>05544     baseUrl: <span class="stringliteral">&#39;js&#39;</span>,
<a name="l05545"></a>05545     paths: {
<a name="l05546"></a>05546       l10nbase: <span class="stringliteral">&#39;../shared/js/l10n&#39;</span>,
<a name="l05547"></a>05547       l10ndate: <span class="stringliteral">&#39;../shared/js/l10n_date&#39;</span>,
<a name="l05548"></a>05548       style: <span class="stringliteral">&#39;../style&#39;</span>,
<a name="l05549"></a>05549       <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a88b8a0ec29ea19ab8a79e10dd9cf3c04">shared</a>: <span class="stringliteral">&#39;../shared&#39;</span>,
<a name="l05550"></a>05550 
<a name="l05551"></a>05551       <span class="stringliteral">&#39;mailapi/main-frame-setup&#39;</span>: <span class="stringliteral">&#39;ext/mailapi/main-frame-setup&#39;</span>,
<a name="l05552"></a>05552       <span class="stringliteral">&#39;mailapi/main-frame-backend&#39;</span>: <span class="stringliteral">&#39;ext/mailapi/main-frame-backend&#39;</span>
<a name="l05553"></a>05553     },
<a name="l05554"></a>05554     map: {
<a name="l05555"></a>05555       <span class="charliteral">&#39;*&#39;</span>: {
<a name="l05556"></a>05556         <span class="stringliteral">&#39;api&#39;</span>: <span class="stringliteral">&#39;mailapi/main-frame-setup&#39;</span>
<a name="l05557"></a>05557       }
<a name="l05558"></a>05558     },
<a name="l05559"></a>05559     shim: {
<a name="l05560"></a>05560       l10ndate: [<span class="stringliteral">&#39;l10nbase&#39;</span>],
<a name="l05561"></a>05561 
<a name="l05562"></a>05562       <span class="stringliteral">&#39;shared/js/mime_mapper&#39;</span>: {
<a name="l05563"></a>05563         <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>: <span class="stringliteral">&#39;MimeMapper&#39;</span>
<a name="l05564"></a>05564       },
<a name="l05565"></a>05565 
<a name="l05566"></a>05566       <span class="stringliteral">&#39;shared/js/notification_helper&#39;</span>: {
<a name="l05567"></a>05567         <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>: <span class="stringliteral">&#39;NotificationHelper&#39;</span>
<a name="l05568"></a>05568       }
<a name="l05569"></a>05569     },
<a name="l05570"></a>05570     definePrim: <span class="stringliteral">&#39;prim&#39;</span>
<a name="l05571"></a>05571   });
<a name="l05572"></a>05572 }
<a name="l05573"></a>05573 
<a name="l05574"></a>05574 <span class="comment">// Named module, so it is the same before and after build, and referenced</span>
<a name="l05575"></a>05575 <span class="comment">// in the require at the end of this file.</span>
<a name="l05576"></a>05576 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mail_app&#39;</span>, [<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;exports&#39;</span>,<span class="stringliteral">&#39;module&#39;</span>,<span class="stringliteral">&#39;app_messages&#39;</span>,<span class="stringliteral">&#39;html_cache&#39;</span>,<span class="stringliteral">&#39;l10n!&#39;</span>,<span class="stringliteral">&#39;mail_common&#39;</span>,<span class="stringliteral">&#39;evt&#39;</span>,<span class="stringliteral">&#39;model&#39;</span>,<span class="stringliteral">&#39;sync&#39;</span>,<span class="stringliteral">&#39;wake_locks&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>, <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l05577"></a>05577 
<a name="l05578"></a>05578 var appMessages = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;app_messages&#39;</span>),
<a name="l05579"></a>05579     htmlCache = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;html_cache&#39;</span>),
<a name="l05580"></a>05580     <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;l10n!&#39;</span>),
<a name="l05581"></a>05581     common = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;mail_common&#39;</span>),
<a name="l05582"></a>05582     evt = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;evt&#39;</span>),
<a name="l05583"></a>05583     model = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;model&#39;</span>),
<a name="l05584"></a>05584     Cards = common.Cards,
<a name="l05585"></a>05585     activityCallback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05586"></a>05586 
<a name="l05587"></a>05587 <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;sync&#39;</span>);
<a name="l05588"></a>05588 <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;wake_locks&#39;</span>);
<a name="l05589"></a>05589 
<a name="l05590"></a>05590 model.latestOnce(<span class="stringliteral">&#39;api&#39;</span>, <span class="keyword">function</span>(api) {
<a name="l05591"></a>05591   <span class="comment">// If our password is bad, we need to pop up a card to ask for the updated</span>
<a name="l05592"></a>05592   <span class="comment">// password.</span>
<a name="l05593"></a>05593   api.onbadlogin = <span class="keyword">function</span>(account, problem) {
<a name="l05594"></a>05594     <span class="keywordflow">switch</span> (problem) {
<a name="l05595"></a>05595       <span class="keywordflow">case</span> <span class="stringliteral">&#39;bad-user-or-pass&#39;</span>:
<a name="l05596"></a>05596         Cards.pushCard(<span class="stringliteral">&#39;setup_fix_password&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>,
<a name="l05597"></a>05597                   { account: account, restoreCard: Cards.activeCardIndex },
<a name="l05598"></a>05598                   <span class="stringliteral">&#39;right&#39;</span>);
<a name="l05599"></a>05599         <span class="keywordflow">break</span>;
<a name="l05600"></a>05600       <span class="keywordflow">case</span> <span class="stringliteral">&#39;imap-disabled&#39;</span>:
<a name="l05601"></a>05601         Cards.pushCard(<span class="stringliteral">&#39;setup_fix_gmail_imap&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>,
<a name="l05602"></a>05602                   { account: account, restoreCard: Cards.activeCardIndex },
<a name="l05603"></a>05603                   <span class="stringliteral">&#39;right&#39;</span>);
<a name="l05604"></a>05604         <span class="keywordflow">break</span>;
<a name="l05605"></a>05605       <span class="keywordflow">case</span> <span class="stringliteral">&#39;needs-app-pass&#39;</span>:
<a name="l05606"></a>05606         Cards.pushCard(<span class="stringliteral">&#39;setup_fix_gmail_twofactor&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>,
<a name="l05607"></a>05607                   { account: account, restoreCard: Cards.activeCardIndex },
<a name="l05608"></a>05608                   <span class="stringliteral">&#39;right&#39;</span>);
<a name="l05609"></a>05609         <span class="keywordflow">break</span>;
<a name="l05610"></a>05610     }
<a name="l05611"></a>05611   };
<a name="l05612"></a>05612 
<a name="l05613"></a>05613   api.useLocalizedStrings({
<a name="l05614"></a>05614     wrote: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;reply-quoting-wrote&#39;</span>),
<a name="l05615"></a>05615     originalMessage: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;forward-original-message&#39;</span>),
<a name="l05616"></a>05616     forwardHeaderLabels: {
<a name="l05617"></a>05617       subject: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;forward-header-subject&#39;</span>),
<a name="l05618"></a>05618       <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;forward-header-date&#39;</span>),
<a name="l05619"></a>05619       from: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;forward-header-from&#39;</span>),
<a name="l05620"></a>05620       replyTo: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;forward-header-reply-to&#39;</span>),
<a name="l05621"></a>05621       <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;forward-header-to&#39;</span>),
<a name="l05622"></a>05622       <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;forward-header-cc&#39;</span>)
<a name="l05623"></a>05623     },
<a name="l05624"></a>05624     folderNames: {
<a name="l05625"></a>05625       inbox: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;folder-inbox&#39;</span>),
<a name="l05626"></a>05626       sent: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;folder-sent&#39;</span>),
<a name="l05627"></a>05627       drafts: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;folder-drafts&#39;</span>),
<a name="l05628"></a>05628       trash: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;folder-trash&#39;</span>),
<a name="l05629"></a>05629       queue: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;folder-queue&#39;</span>),
<a name="l05630"></a>05630       junk: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;folder-junk&#39;</span>),
<a name="l05631"></a>05631       archives: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;folder-archives&#39;</span>),
<a name="l05632"></a>05632       localdrafts: <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;folder-localdrafts&#39;</span>)
<a name="l05633"></a>05633     }
<a name="l05634"></a>05634   });
<a name="l05635"></a>05635 });
<a name="l05636"></a>05636 
<a name="l05637"></a>05637 <span class="comment">// Handle cases where a default card is needed for back navigation</span>
<a name="l05638"></a>05638 <span class="comment">// after a non-default entry point (like an activity) is triggered.</span>
<a name="l05639"></a>05639 Cards.pushDefaultCard = <span class="keyword">function</span>(onPushed) {
<a name="l05640"></a>05640   model.latestOnce(<span class="stringliteral">&#39;foldersSlice&#39;</span>, <span class="keyword">function</span>() {
<a name="l05641"></a>05641     Cards.pushCard(<span class="stringliteral">&#39;message_list&#39;</span>, <span class="stringliteral">&#39;nonsearch&#39;</span>, <span class="stringliteral">&#39;none&#39;</span>, {
<a name="l05642"></a>05642       onPushed: onPushed
<a name="l05643"></a>05643     },
<a name="l05644"></a>05644     <span class="comment">// Default to &quot;before&quot; placement.</span>
<a name="l05645"></a>05645     <span class="stringliteral">&#39;left&#39;</span>);
<a name="l05646"></a>05646   });
<a name="l05647"></a>05647 };
<a name="l05648"></a>05648 
<a name="l05649"></a>05649 Cards._init();
<a name="l05650"></a>05650 
<a name="l05651"></a>05651 var finalCardStateCallback,
<a name="l05652"></a>05652     waitForAppMessage = <span class="keyword">false</span>,
<a name="l05653"></a>05653     startedInBackground = <span class="keyword">false</span>,
<a name="l05654"></a>05654     cachedNode = Cards._cardsNode.children[0],
<a name="l05655"></a>05655     startCardId = cachedNode &amp;&amp; cachedNode.getAttribute(<span class="stringliteral">&#39;data-type&#39;</span>);
<a name="l05656"></a>05656 
<a name="l05657"></a>05657 var startCardArgs = {
<a name="l05658"></a>05658   <span class="stringliteral">&#39;setup_account_info&#39;</span>: [
<a name="l05659"></a>05659     <span class="stringliteral">&#39;setup_account_info&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;immediate&#39;</span>,
<a name="l05660"></a>05660     {
<a name="l05661"></a>05661       onPushed: <span class="keyword">function</span>(<a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a7d0f1de6f8101fa5b723f403effd4396">impl</a>) {
<a name="l05662"></a>05662         htmlCache.delayedSaveFromNode(<a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a7d0f1de6f8101fa5b723f403effd4396">impl</a>.domNode.cloneNode(<span class="keyword">true</span>));
<a name="l05663"></a>05663       }
<a name="l05664"></a>05664     }
<a name="l05665"></a>05665   ],
<a name="l05666"></a>05666   <span class="stringliteral">&#39;message_list&#39;</span>: [
<a name="l05667"></a>05667     <span class="stringliteral">&#39;message_list&#39;</span>, <span class="stringliteral">&#39;nonsearch&#39;</span>, <span class="stringliteral">&#39;immediate&#39;</span>, {}
<a name="l05668"></a>05668   ]
<a name="l05669"></a>05669 };
<a name="l05670"></a>05670 
<a name="l05671"></a>05671 <span class="keyword">function</span> pushStartCard(<span class="keywordtype">id</span>, addedArgs) {
<a name="l05672"></a>05672   var <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a> = startCardArgs[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>];
<a name="l05673"></a>05673   <span class="keywordflow">if</span> (!args)
<a name="l05674"></a>05674     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Invalid start card: &#39;</span> + <span class="keywordtype">id</span>);
<a name="l05675"></a>05675 
<a name="l05676"></a>05676   <span class="comment">//Add in cached node to use (could be null)</span>
<a name="l05677"></a>05677   args[3].cachedNode = cachedNode;
<a name="l05678"></a>05678 
<a name="l05679"></a>05679   <span class="comment">// Mix in addedArgs to the args object that is passed to pushCard.</span>
<a name="l05680"></a>05680   <span class="keywordflow">if</span> (addedArgs) {
<a name="l05681"></a>05681     Object.keys(addedArgs).forEach(<span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>) {
<a name="l05682"></a>05682       args[3][<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = addedArgs[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l05683"></a>05683     });
<a name="l05684"></a>05684   }
<a name="l05685"></a>05685 
<a name="l05686"></a>05686   <span class="keywordflow">return</span> Cards.pushCard.apply(Cards, args);
<a name="l05687"></a>05687 }
<a name="l05688"></a>05688 
<a name="l05689"></a>05689 <span class="keywordflow">if</span> (appMessages.hasPending(<span class="stringliteral">&#39;activity&#39;</span>) ||
<a name="l05690"></a>05690     appMessages.hasPending(<span class="stringliteral">&#39;notification&#39;</span>)) {
<a name="l05691"></a>05691   <span class="comment">// There is an activity, do not use the cache node, start fresh,</span>
<a name="l05692"></a>05692   <span class="comment">// and block normal first card selection, wait for activity.</span>
<a name="l05693"></a>05693   cachedNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05694"></a>05694   waitForAppMessage = <span class="keyword">true</span>;
<a name="l05695"></a>05695 }
<a name="l05696"></a>05696 
<a name="l05697"></a>05697 <span class="keywordflow">if</span> (appMessages.hasPending(<span class="stringliteral">&#39;alarm&#39;</span>)) {
<a name="l05698"></a>05698   <span class="comment">// There is an alarm, do not use the cache node, start fresh,</span>
<a name="l05699"></a>05699   <span class="comment">// as we were woken up just for the alarm.</span>
<a name="l05700"></a>05700   cachedNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05701"></a>05701   startedInBackground = <span class="keyword">true</span>;
<a name="l05702"></a>05702 }
<a name="l05703"></a>05703 
<a name="l05704"></a>05704 <span class="comment">// If still have a cached node, then show it.</span>
<a name="l05705"></a>05705 <span class="keywordflow">if</span> (cachedNode) {
<a name="l05706"></a>05706   <span class="comment">// Wire up a card implementation to the cached node.</span>
<a name="l05707"></a>05707   <span class="keywordflow">if</span> (startCardId) {
<a name="l05708"></a>05708     pushStartCard(startCardId);
<a name="l05709"></a>05709   } <span class="keywordflow">else</span> {
<a name="l05710"></a>05710     cachedNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05711"></a>05711   }
<a name="l05712"></a>05712 }
<a name="l05713"></a>05713 
<a name="l05721"></a>05721 <span class="keyword">function</span> resetCards(cardId, args) {
<a name="l05722"></a>05722   cachedNode = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05723"></a>05723 
<a name="l05724"></a>05724   var startArgs = startCardArgs[cardId],
<a name="l05725"></a>05725       query = [startArgs[0], startArgs[1]];
<a name="l05726"></a>05726 
<a name="l05727"></a>05727   <span class="keywordflow">if</span> (!Cards.hasCard(query)) {
<a name="l05728"></a>05728     Cards.removeAllCards();
<a name="l05729"></a>05729     pushStartCard(cardId, args);
<a name="l05730"></a>05730   }
<a name="l05731"></a>05731 }
<a name="l05732"></a>05732 
<a name="l05739"></a>05739 <span class="keyword">function</span> showFinalCardState(fn) {
<a name="l05740"></a>05740   <span class="keywordflow">if</span> (startedInBackground &amp;&amp; <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.hidden) {
<a name="l05741"></a>05741     finalCardStateCallback = fn;
<a name="l05742"></a>05742   } <span class="keywordflow">else</span> {
<a name="l05743"></a>05743     fn();
<a name="l05744"></a>05744   }
<a name="l05745"></a>05745 }
<a name="l05746"></a>05746 
<a name="l05751"></a>05751 <span class="keyword">function</span> showMessageList(args) {
<a name="l05752"></a>05752   showFinalCardState(<span class="keyword">function</span>() {
<a name="l05753"></a>05753     resetCards(<span class="stringliteral">&#39;message_list&#39;</span>, args);
<a name="l05754"></a>05754   });
<a name="l05755"></a>05755 }
<a name="l05756"></a>05756 
<a name="l05757"></a>05757 <span class="comment">// Handles visibility changes: if the app becomes visible</span>
<a name="l05758"></a>05758 <span class="comment">// being hidden via a cronsync startup, trigger UI creation.</span>
<a name="l05759"></a>05759 <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.addEventListener(<span class="stringliteral">&#39;visibilitychange&#39;</span>, <span class="keyword">function</span> onVisibilityChange() {
<a name="l05760"></a>05760   <span class="keywordflow">if</span> (startedInBackground &amp;&amp; finalCardStateCallback &amp;&amp; !<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.hidden) {
<a name="l05761"></a>05761     finalCardStateCallback();
<a name="l05762"></a>05762     finalCardStateCallback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05763"></a>05763   }
<a name="l05764"></a>05764 }, <span class="keyword">false</span>);
<a name="l05765"></a>05765 
<a name="l05766"></a>05766 <span class="comment">// Some event modifications during setup do not have full account</span>
<a name="l05767"></a>05767 <span class="comment">// IDs. This listener catches those modifications and applies</span>
<a name="l05768"></a>05768 <span class="comment">// them when the data is available.</span>
<a name="l05769"></a>05769 evt.on(<span class="stringliteral">&#39;accountModified&#39;</span>, <span class="keyword">function</span>(accountId, data) {
<a name="l05770"></a>05770   model.latestOnce(<span class="stringliteral">&#39;acctsSlice&#39;</span>, <span class="keyword">function</span>() {
<a name="l05771"></a>05771     var account = model.getAccount(accountId);
<a name="l05772"></a>05772     <span class="keywordflow">if</span> (account)
<a name="l05773"></a>05773       account.modifyAccount(data);
<a name="l05774"></a>05774   });
<a name="l05775"></a>05775 });
<a name="l05776"></a>05776 
<a name="l05777"></a>05777 <span class="comment">// The add account UI flow is requested.</span>
<a name="l05778"></a>05778 evt.on(<span class="stringliteral">&#39;addAccount&#39;</span>, <span class="keyword">function</span>() {
<a name="l05779"></a>05779   Cards.removeAllCards();
<a name="l05780"></a>05780 
<a name="l05781"></a>05781   <span class="comment">// Show the first setup card again.</span>
<a name="l05782"></a>05782   pushStartCard(<span class="stringliteral">&#39;setup_account_info&#39;</span>, {
<a name="l05783"></a>05783     allowBack: <span class="keyword">true</span>
<a name="l05784"></a>05784   });
<a name="l05785"></a>05785 });
<a name="l05786"></a>05786 
<a name="l05787"></a>05787 <span class="keyword">function</span> resetApp() {
<a name="l05788"></a>05788   Cards.removeAllCards();
<a name="l05789"></a>05789   model.init();
<a name="l05790"></a>05790 }
<a name="l05791"></a>05791 
<a name="l05792"></a>05792 <span class="comment">// An account was deleted. Burn it all to the ground and</span>
<a name="l05793"></a>05793 <span class="comment">// rise like a phoenix. Prefer a UI event vs. a slice</span>
<a name="l05794"></a>05794 <span class="comment">// listen to give flexibility about UI construction:</span>
<a name="l05795"></a>05795 <span class="comment">// an acctsSlice splice change may not warrant removing</span>
<a name="l05796"></a>05796 <span class="comment">// all the cards.</span>
<a name="l05797"></a>05797 evt.on(<span class="stringliteral">&#39;accountDeleted&#39;</span>, resetApp);
<a name="l05798"></a>05798 evt.on(<span class="stringliteral">&#39;resetApp&#39;</span>, resetApp);
<a name="l05799"></a>05799 
<a name="l05800"></a>05800 <span class="comment">// A request to show the latest account in the UI.</span>
<a name="l05801"></a>05801 <span class="comment">// Usually triggered after an account has been added.</span>
<a name="l05802"></a>05802 evt.on(<span class="stringliteral">&#39;showLatestAccount&#39;</span>, <span class="keyword">function</span>() {
<a name="l05803"></a>05803   Cards.removeAllCards();
<a name="l05804"></a>05804 
<a name="l05805"></a>05805   model.latestOnce(<span class="stringliteral">&#39;acctsSlice&#39;</span>, <span class="keyword">function</span>(acctsSlice) {
<a name="l05806"></a>05806     var account = acctsSlice.items[acctsSlice.items.length - 1];
<a name="l05807"></a>05807     model.changeAccount(account, <span class="keyword">function</span>() {
<a name="l05808"></a>05808       pushStartCard(<span class="stringliteral">&#39;message_list&#39;</span>);
<a name="l05809"></a>05809     });
<a name="l05810"></a>05810   });
<a name="l05811"></a>05811 });
<a name="l05812"></a>05812 
<a name="l05813"></a>05813 model.on(<span class="stringliteral">&#39;acctsSlice&#39;</span>, <span class="keyword">function</span>() {
<a name="l05814"></a>05814   <span class="keywordflow">if</span> (!model.hasAccount()) {
<a name="l05815"></a>05815     resetCards(<span class="stringliteral">&#39;setup_account_info&#39;</span>);
<a name="l05816"></a>05816   } <span class="keywordflow">else</span> {
<a name="l05817"></a>05817     model.latestOnce(<span class="stringliteral">&#39;foldersSlice&#39;</span>, <span class="keyword">function</span>() {
<a name="l05818"></a>05818       <span class="keywordflow">if</span> (waitForAppMessage)
<a name="l05819"></a>05819         <span class="keywordflow">return</span>;
<a name="l05820"></a>05820 
<a name="l05821"></a>05821       <span class="comment">// If an activity was waiting for an account, trigger it now.</span>
<a name="l05822"></a>05822       <span class="keywordflow">if</span> (activityCallback) {
<a name="l05823"></a>05823         var activityCb = activityCallback;
<a name="l05824"></a>05824         activityCallback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l05825"></a>05825         <span class="keywordflow">return</span> activityCb();
<a name="l05826"></a>05826       }
<a name="l05827"></a>05827 
<a name="l05828"></a>05828       showMessageList();
<a name="l05829"></a>05829     });
<a name="l05830"></a>05830   }
<a name="l05831"></a>05831 });
<a name="l05832"></a>05832 
<a name="l05833"></a>05833 appMessages.on(<span class="stringliteral">&#39;activity&#39;</span>, <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, data, rawActivity) {
<a name="l05834"></a>05834 
<a name="l05835"></a>05835   <span class="keyword">function</span> initComposer() {
<a name="l05836"></a>05836     Cards.pushCard(<span class="stringliteral">&#39;compose&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;immediate&#39;</span>, {
<a name="l05837"></a>05837       <a class="code" href="../../de/dc7/share-receiver_8js.html#add7056b1c8a53d2db94122b6cd76b964">activity</a>: rawActivity,
<a name="l05838"></a>05838       composerData: {
<a name="l05839"></a>05839         onComposer: <span class="keyword">function</span>(composer) {
<a name="l05840"></a>05840           var attachmentBlobs = data.attachmentBlobs;
<a name="l05841"></a>05841           <span class="comment">/* to/cc/bcc/subject/body all have default values that shouldn&#39;t</span>
<a name="l05842"></a>05842 <span class="comment">          be clobbered if they are not specified in the URI*/</span>
<a name="l05843"></a>05843           <span class="keywordflow">if</span> (data.to)
<a name="l05844"></a>05844             composer.to = data.to;
<a name="l05845"></a>05845           <span class="keywordflow">if</span> (data.subject)
<a name="l05846"></a>05846             composer.subject = data.subject;
<a name="l05847"></a>05847           <span class="keywordflow">if</span> (data.body)
<a name="l05848"></a>05848             composer.body = { text: data.body };
<a name="l05849"></a>05849           <span class="keywordflow">if</span> (data.cc)
<a name="l05850"></a>05850             composer.cc = data.cc;
<a name="l05851"></a>05851           <span class="keywordflow">if</span> (data.bcc)
<a name="l05852"></a>05852             composer.bcc = data.bcc;
<a name="l05853"></a>05853           <span class="keywordflow">if</span> (attachmentBlobs) {
<a name="l05854"></a>05854             <span class="keywordflow">for</span> (var iBlob = 0; iBlob &lt; attachmentBlobs.length; iBlob++) {
<a name="l05855"></a>05855               composer.addAttachment({
<a name="l05856"></a>05856                 <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: data.attachmentNames[iBlob],
<a name="l05857"></a>05857                 blob: attachmentBlobs[iBlob]
<a name="l05858"></a>05858               });
<a name="l05859"></a>05859             }
<a name="l05860"></a>05860           }
<a name="l05861"></a>05861         }
<a name="l05862"></a>05862       }
<a name="l05863"></a>05863     });
<a name="l05864"></a>05864   }
<a name="l05865"></a>05865 
<a name="l05866"></a>05866   <span class="keyword">function</span> promptEmptyAccount() {
<a name="l05867"></a>05867     var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a> = <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#ab77aa8c2fa705d45d7ff1db3a11306ae">confirm</a>(<a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;setup-empty-account-prompt&#39;</span>));
<a name="l05868"></a>05868     <span class="keywordflow">if</span> (!req) {
<a name="l05869"></a>05869       rawActivity.postError(<span class="stringliteral">&#39;cancelled&#39;</span>);
<a name="l05870"></a>05870     }
<a name="l05871"></a>05871 
<a name="l05872"></a>05872     <span class="comment">// No longer need to wait for the activity to complete, it needs</span>
<a name="l05873"></a>05873     <span class="comment">// normal card flow</span>
<a name="l05874"></a>05874     waitForAppMessage = <span class="keyword">false</span>;
<a name="l05875"></a>05875 
<a name="l05876"></a>05876     activityCallback = initComposer;
<a name="l05877"></a>05877   }
<a name="l05878"></a>05878 
<a name="l05879"></a>05879   <span class="keywordflow">if</span> (model.inited) {
<a name="l05880"></a>05880     <span class="keywordflow">if</span> (model.hasAccount()) {
<a name="l05881"></a>05881       initComposer();
<a name="l05882"></a>05882     } <span class="keywordflow">else</span> {
<a name="l05883"></a>05883       promptEmptyAccount();
<a name="l05884"></a>05884     }
<a name="l05885"></a>05885   } <span class="keywordflow">else</span> {
<a name="l05886"></a>05886     <span class="comment">// Be optimistic and start rendering compose as soon as possible</span>
<a name="l05887"></a>05887     <span class="comment">// In the edge case that email is not configured, then the empty</span>
<a name="l05888"></a>05888     <span class="comment">// account prompt will be triggered quickly in the next section.</span>
<a name="l05889"></a>05889     initComposer();
<a name="l05890"></a>05890 
<a name="l05891"></a>05891     model.latestOnce(<span class="stringliteral">&#39;acctsSlice&#39;</span>, <span class="keyword">function</span> activityOnAccount() {
<a name="l05892"></a>05892       <span class="keywordflow">if</span> (!model.hasAccount()) {
<a name="l05893"></a>05893         promptEmptyAccount();
<a name="l05894"></a>05894       }
<a name="l05895"></a>05895     });
<a name="l05896"></a>05896   }
<a name="l05897"></a>05897 });
<a name="l05898"></a>05898 
<a name="l05899"></a>05899 appMessages.on(<span class="stringliteral">&#39;notification&#39;</span>, <span class="keyword">function</span>(data) {
<a name="l05900"></a>05900   var <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = data ? data.type : <span class="stringliteral">&#39;&#39;</span>;
<a name="l05901"></a>05901 
<a name="l05902"></a>05902   model.latestOnce(<span class="stringliteral">&#39;foldersSlice&#39;</span>, <span class="keyword">function</span> latestFolderSlice() {
<a name="l05903"></a>05903     <span class="keyword">function</span> onCorrectFolder() {
<a name="l05904"></a>05904       <span class="keyword">function</span> onPushed() {
<a name="l05905"></a>05905         waitForAppMessage = <span class="keyword">false</span>;
<a name="l05906"></a>05906       }
<a name="l05907"></a>05907 
<a name="l05908"></a>05908       <span class="keywordflow">if</span> (type === <span class="stringliteral">&#39;message_list&#39;</span>) {
<a name="l05909"></a>05909         showMessageList({
<a name="l05910"></a>05910           onPushed: onPushed
<a name="l05911"></a>05911         });
<a name="l05912"></a>05912       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type === <span class="stringliteral">&#39;message_reader&#39;</span>) {
<a name="l05913"></a>05913         Cards.pushCard(data.type, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;immediate&#39;</span>, {
<a name="l05914"></a>05914           messageSuid: data.messageSuid,
<a name="l05915"></a>05915           backOnMissingMessage: <span class="keyword">true</span>,
<a name="l05916"></a>05916           onPushed: onPushed
<a name="l05917"></a>05917         });
<a name="l05918"></a>05918       } <span class="keywordflow">else</span> {
<a name="l05919"></a>05919         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;unhandled notification type: &#39;</span> + type);
<a name="l05920"></a>05920       }
<a name="l05921"></a>05921     }
<a name="l05922"></a>05922 
<a name="l05923"></a>05923     var acctsSlice = model.acctsSlice,
<a name="l05924"></a>05924         accountId = data.accountId;
<a name="l05925"></a>05925 
<a name="l05926"></a>05926     <span class="keywordflow">if</span> (model.account.id === accountId) {
<a name="l05927"></a>05927       <span class="keywordflow">return</span> model.selectInbox(onCorrectFolder);
<a name="l05928"></a>05928     } <span class="keywordflow">else</span> {
<a name="l05929"></a>05929       var newAccount;
<a name="l05930"></a>05930       acctsSlice.items.some(<span class="keyword">function</span>(account) {
<a name="l05931"></a>05931         <span class="keywordflow">if</span> (account.id === accountId) {
<a name="l05932"></a>05932           newAccount = account;
<a name="l05933"></a>05933           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l05934"></a>05934         }
<a name="l05935"></a>05935       });
<a name="l05936"></a>05936 
<a name="l05937"></a>05937       <span class="keywordflow">if</span> (newAccount) {
<a name="l05938"></a>05938         model.changeAccount(newAccount, onCorrectFolder);
<a name="l05939"></a>05939       }
<a name="l05940"></a>05940     }
<a name="l05941"></a>05941   });
<a name="l05942"></a>05942 });
<a name="l05943"></a>05943 
<a name="l05944"></a>05944 model.init();
<a name="l05945"></a>05945 });
<a name="l05946"></a>05946 
<a name="l05947"></a>05947 <span class="comment">// Run the app module, bring in fancy logging</span>
<a name="l05948"></a>05948 <a class="code" href="../../d9/d2e/alameda_8js.html#a44c2a92e377407b0af593e79fa27596f">requirejs</a>([<span class="stringliteral">&#39;console_hook&#39;</span>, <span class="stringliteral">&#39;cards/message_list&#39;</span>, <span class="stringliteral">&#39;mail_app&#39;</span>]);
<a name="l05949"></a>05949 
<a name="l05950"></a>05950 <span class="comment">/* -*- Mode: js; js-indent-level: 2; indent-tabs-mode: nil -*- */</span>
<a name="l05951"></a>05951 <span class="comment">/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */</span>
<a name="l05952"></a>05952 
<a name="l05953"></a>05953 
<a name="l05954"></a>05954 
<a name="l05960"></a>05960 (<span class="keyword">function</span>(<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>) {
<a name="l05961"></a>05961   var gL10nData = {};
<a name="l05962"></a>05962   var gLanguage = <span class="stringliteral">&#39;&#39;</span>;
<a name="l05963"></a>05963   var gMacros = {};
<a name="l05964"></a>05964   var gReadyState = <span class="stringliteral">&#39;loading&#39;</span>;
<a name="l05965"></a>05965 
<a name="l05966"></a>05966   <span class="comment">// DOM element properties that may be localized with a key:value pair.</span>
<a name="l05967"></a>05967   var gNestedProps = [<span class="stringliteral">&#39;style&#39;</span>, <span class="stringliteral">&#39;dataset&#39;</span>];
<a name="l05968"></a>05968 
<a name="l05969"></a>05969 
<a name="l05992"></a>05992   var gDefaultLocale = <span class="stringliteral">&#39;en-US&#39;</span>;
<a name="l05993"></a>05993 
<a name="l05994"></a>05994 
<a name="l06007"></a>06007   var gAsyncResourceLoading = <span class="keyword">true</span>; <span class="comment">// read-only</span>
<a name="l06008"></a>06008 
<a name="l06009"></a>06009 
<a name="l06018"></a>06018   var gDEBUG = 1;
<a name="l06019"></a>06019 
<a name="l06020"></a>06020   <span class="keyword">function</span> consoleLog(message) {
<a name="l06021"></a>06021     <span class="keywordflow">if</span> (gDEBUG &gt;= 2) {
<a name="l06022"></a>06022       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;[l10n] &#39;</span> + message);
<a name="l06023"></a>06023     }
<a name="l06024"></a>06024   };
<a name="l06025"></a>06025 
<a name="l06026"></a>06026   <span class="keyword">function</span> consoleWarn(message) {
<a name="l06027"></a>06027     <span class="keywordflow">if</span> (gDEBUG) {
<a name="l06028"></a>06028       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;[l10n] &#39;</span> + message);
<a name="l06029"></a>06029     }
<a name="l06030"></a>06030   };
<a name="l06031"></a>06031 
<a name="l06032"></a>06032   <span class="keyword">function</span> consoleWarn_missingKeys(untranslatedElements, lang) {
<a name="l06033"></a>06033     var len = untranslatedElements.length;
<a name="l06034"></a>06034     <span class="keywordflow">if</span> (!len || !gDEBUG) {
<a name="l06035"></a>06035       <span class="keywordflow">return</span>;
<a name="l06036"></a>06036     }
<a name="l06037"></a>06037 
<a name="l06038"></a>06038     var missingIDs = [];
<a name="l06039"></a>06039     <span class="keywordflow">for</span> (var i = 0; i &lt; <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>; i++) {
<a name="l06040"></a>06040       var l10nId = untranslatedElements[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].getAttribute(<span class="stringliteral">&#39;data-l10n-id&#39;</span>);
<a name="l06041"></a>06041       <span class="keywordflow">if</span> (missingIDs.indexOf(l10nId) &lt; 0) {
<a name="l06042"></a>06042         missingIDs.push(l10nId);
<a name="l06043"></a>06043       }
<a name="l06044"></a>06044     }
<a name="l06045"></a>06045     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;[l10n] &#39;</span> +
<a name="l06046"></a>06046         missingIDs.length + <span class="stringliteral">&#39; missing key(s) for [&#39;</span> + lang + <span class="stringliteral">&#39;]: &#39;</span> +
<a name="l06047"></a>06047         missingIDs.join(<span class="stringliteral">&#39;, &#39;</span>));
<a name="l06048"></a>06048   }
<a name="l06049"></a>06049 
<a name="l06050"></a>06050 
<a name="l06058"></a>06058   <span class="keyword">function</span> getL10nResourceLinks() {
<a name="l06059"></a>06059     <span class="keywordflow">return</span> <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelectorAll(<span class="stringliteral">&#39;link[type=&quot;application/l10n&quot;]&#39;</span>);
<a name="l06060"></a>06060   }
<a name="l06061"></a>06061 
<a name="l06062"></a>06062   <span class="keyword">function</span> getL10nDictionary(lang) {
<a name="l06063"></a>06063     var getInlineDict = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a38008f9ebcd87acfca726e35504b2e8d">locale</a>) {
<a name="l06064"></a>06064       var sel = <span class="stringliteral">&#39;script[type=&quot;application/l10n&quot;][lang=&quot;&#39;</span> + <a class="code" href="../../d2/d7d/jsapi_8h.html#a38008f9ebcd87acfca726e35504b2e8d">locale</a> + <span class="stringliteral">&#39;&quot;]&#39;</span>;
<a name="l06065"></a>06065       <span class="keywordflow">return</span> <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(sel);
<a name="l06066"></a>06066     };
<a name="l06067"></a>06067     <span class="comment">// TODO: support multiple internal JSON dictionaries</span>
<a name="l06068"></a>06068     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a31bd60a30b08f545ac3bb2e4c17c4d97">script</a> = getInlineDict(lang) || getInlineDict(gDefaultLocale);
<a name="l06069"></a>06069     <span class="keywordflow">return</span> script ? JSON.parse(script.innerHTML) : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l06070"></a>06070   }
<a name="l06071"></a>06071 
<a name="l06072"></a>06072   <span class="keyword">function</span> getTranslatableChildren(element) {
<a name="l06073"></a>06073     <span class="keywordflow">return</span> element ? element.querySelectorAll(<span class="stringliteral">&#39;*[data-l10n-id]&#39;</span>) : [];
<a name="l06074"></a>06074   }
<a name="l06075"></a>06075 
<a name="l06076"></a>06076   <span class="keyword">function</span> getL10nAttributes(element) {
<a name="l06077"></a>06077     <span class="keywordflow">if</span> (!element) {
<a name="l06078"></a>06078       <span class="keywordflow">return</span> {};
<a name="l06079"></a>06079     }
<a name="l06080"></a>06080 
<a name="l06081"></a>06081     var l10nId = element.getAttribute(<span class="stringliteral">&#39;data-l10n-id&#39;</span>);
<a name="l06082"></a>06082     var l10nArgs = element.getAttribute(<span class="stringliteral">&#39;data-l10n-args&#39;</span>);
<a name="l06083"></a>06083     var args = {};
<a name="l06084"></a>06084     <span class="keywordflow">if</span> (l10nArgs) {
<a name="l06085"></a>06085       <span class="keywordflow">try</span> {
<a name="l06086"></a>06086         args = JSON.parse(l10nArgs);
<a name="l06087"></a>06087       } <span class="keywordflow">catch</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l06088"></a>06088         consoleWarn(<span class="stringliteral">&#39;could not parse arguments for #&#39;</span> + l10nId);
<a name="l06089"></a>06089       }
<a name="l06090"></a>06090     }
<a name="l06091"></a>06091     <span class="keywordflow">return</span> { <span class="keywordtype">id</span>: l10nId, args: args };
<a name="l06092"></a>06092   }
<a name="l06093"></a>06093 
<a name="l06094"></a>06094   <span class="keyword">function</span> setTextContent(element, text) {
<a name="l06095"></a>06095     <span class="comment">// standard case: no element children</span>
<a name="l06096"></a>06096     <span class="keywordflow">if</span> (!element.firstElementChild) {
<a name="l06097"></a>06097       element.textContent = <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>;
<a name="l06098"></a>06098       <span class="keywordflow">return</span>;
<a name="l06099"></a>06099     }
<a name="l06100"></a>06100 
<a name="l06101"></a>06101     <span class="comment">// this element has element children: replace the content of the first</span>
<a name="l06102"></a>06102     <span class="comment">// (non-blank) child textNode and clear other child textNodes</span>
<a name="l06103"></a>06103     var found = <span class="keyword">false</span>;
<a name="l06104"></a>06104     var reNotBlank = /\S/;
<a name="l06105"></a>06105     <span class="keywordflow">for</span> (var child = element.firstChild; child; child = child.nextSibling) {
<a name="l06106"></a>06106       <span class="keywordflow">if</span> (child.nodeType === 3 &amp;&amp; reNotBlank.test(child.nodeValue)) {
<a name="l06107"></a>06107         <span class="keywordflow">if</span> (found) {
<a name="l06108"></a>06108           child.nodeValue = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06109"></a>06109         } <span class="keywordflow">else</span> {
<a name="l06110"></a>06110           child.nodeValue = <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>;
<a name="l06111"></a>06111           found = <span class="keyword">true</span>;
<a name="l06112"></a>06112         }
<a name="l06113"></a>06113       }
<a name="l06114"></a>06114     }
<a name="l06115"></a>06115     <span class="comment">// if no (non-empty) textNode is found, insert a textNode before the</span>
<a name="l06116"></a>06116     <span class="comment">// element&#39;s first child.</span>
<a name="l06117"></a>06117     <span class="keywordflow">if</span> (!found) {
<a name="l06118"></a>06118       element.insertBefore(<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createTextNode(text), element.firstChild);
<a name="l06119"></a>06119     }
<a name="l06120"></a>06120   }
<a name="l06121"></a>06121 
<a name="l06122"></a>06122   <span class="keyword">function</span> fireL10nReadyEvent() {
<a name="l06123"></a>06123     var evtObject = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createEvent(<span class="stringliteral">&#39;Event&#39;</span>);
<a name="l06124"></a>06124     evtObject.initEvent(<span class="stringliteral">&#39;localized&#39;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l06125"></a>06125     evtObject.language = gLanguage;
<a name="l06126"></a>06126     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.dispatchEvent(evtObject);
<a name="l06127"></a>06127   }
<a name="l06128"></a>06128 
<a name="l06129"></a>06129 
<a name="l06153"></a>06153   <span class="keyword">function</span> parseResource(href, lang, successCallback, failureCallback) {
<a name="l06154"></a>06154     var baseURL = href.replace(/\/[^\/]*$/, <span class="charliteral">&#39;/&#39;</span>);
<a name="l06155"></a>06155 
<a name="l06156"></a>06156     <span class="comment">// handle escaped characters (backslashes) in a string</span>
<a name="l06157"></a>06157     <span class="keyword">function</span> evalString(text) {
<a name="l06158"></a>06158       <span class="keywordflow">if</span> (text.lastIndexOf(<span class="charliteral">&#39;\\&#39;</span>) &lt; 0) {
<a name="l06159"></a>06159         <span class="keywordflow">return</span> <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>;
<a name="l06160"></a>06160       }
<a name="l06161"></a>06161       <span class="keywordflow">return</span> text.replace(/\\\\/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="charliteral">&#39;\\&#39;</span>)
<a name="l06162"></a>06162                  .replace(/\\<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="charliteral">&#39;\n&#39;</span>)
<a name="l06163"></a>06163                  .replace(/\\r/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="charliteral">&#39;\r&#39;</span>)
<a name="l06164"></a>06164                  .replace(/\\t/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="charliteral">&#39;\t&#39;</span>)
<a name="l06165"></a>06165                  .replace(/\\<a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="charliteral">&#39;\b&#39;</span>)
<a name="l06166"></a>06166                  .replace(/\\f/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="charliteral">&#39;\f&#39;</span>)
<a name="l06167"></a>06167                  .replace(/\\{/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="charliteral">&#39;{&#39;</span>)
<a name="l06168"></a>06168                  .<a class="code" href="../../dc/d89/wappush_2js_2message_8js.html#a7c5f9536f6c7849a4a7a592bfedf18f1">replace</a>(/\\}/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="charliteral">&#39;}&#39;</span>)
<a name="l06169"></a>06169                  .replace(/\\<span class="stringliteral">&quot;/g, &#39;&quot;</span><span class="stringliteral">&#39;)</span>
<a name="l06170"></a>06170 <span class="stringliteral">                 .replace(/\\&#39;</span>/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>, <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l06171"></a>06171     }
<a name="l06172"></a>06172 
<a name="l06173"></a>06173     <span class="comment">// parse *.properties text data into an l10n dictionary</span>
<a name="l06174"></a>06174     <span class="keyword">function</span> parseProperties(text) {
<a name="l06175"></a>06175       var dictionary = [];
<a name="l06176"></a>06176 
<a name="l06177"></a>06177       <span class="comment">// token expressions</span>
<a name="l06178"></a>06178       var reBlank = /^\s*|\s*$/;
<a name="l06179"></a>06179       var reComment = /^\s*#|^\s*$/;
<a name="l06180"></a>06180       var reSection = /^\s*\[(.*)\]\<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>*$/;
<a name="l06181"></a>06181       var reImport = /^\s*@import\s+<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>\((.*)\)\s*$/<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l06182"></a>06182       var reSplit = /^([^=\s]*)\<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>*=\<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>*(.+)$/;
<a name="l06183"></a>06183       var reUnicode = /\\u([0-9<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-fA-<a class="code" href="../../d9/d19/import__vcard__test_8js.html#a1fd406685cbdee605d0a7bebed56fdb0">F</a>]{1,4})/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>;
<a name="l06184"></a>06184       var reMultiline = /[^\\]\\$/;
<a name="l06185"></a>06185 
<a name="l06186"></a>06186       <span class="comment">// parse the *.properties file into an associative array</span>
<a name="l06187"></a>06187       <span class="keyword">function</span> parseRawLines(rawText, extendedSyntax) {
<a name="l06188"></a>06188         var entries = rawText.replace(reBlank, <span class="stringliteral">&#39;&#39;</span>).split(/[\r\<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>]+/);
<a name="l06189"></a>06189         var currentLang = <span class="charliteral">&#39;*&#39;</span>;
<a name="l06190"></a>06190         var genericLang = lang.replace(/-[<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-z]+$/i, <span class="stringliteral">&#39;&#39;</span>);
<a name="l06191"></a>06191         var skipLang = <span class="keyword">false</span>;
<a name="l06192"></a>06192         var <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06193"></a>06193 
<a name="l06194"></a>06194         <span class="keywordflow">for</span> (var i = 0; i &lt; entries.length; i++) {
<a name="l06195"></a>06195           var <a class="code" href="../../da/d7d/cook_8js.html#ae379b8c31475b8ad7712b7ead5ce1173">line</a> = entries[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l06196"></a>06196 
<a name="l06197"></a>06197           <span class="comment">// comment or blank line?</span>
<a name="l06198"></a>06198           <span class="keywordflow">if</span> (reComment.test(line)) {
<a name="l06199"></a>06199             <span class="keywordflow">continue</span>;
<a name="l06200"></a>06200           }
<a name="l06201"></a>06201 
<a name="l06202"></a>06202           <span class="comment">// multi-line?</span>
<a name="l06203"></a>06203           <span class="keywordflow">while</span> (reMultiline.test(line) &amp;&amp; i &lt; entries.length) {
<a name="l06204"></a>06204             line = line.slice(0, line.length - 1) +
<a name="l06205"></a>06205               entries[++<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].replace(reBlank, <span class="stringliteral">&#39;&#39;</span>);
<a name="l06206"></a>06206           }
<a name="l06207"></a>06207 
<a name="l06208"></a>06208           <span class="comment">// the extended syntax supports [lang] sections and @import rules</span>
<a name="l06209"></a>06209           <span class="keywordflow">if</span> (extendedSyntax) {
<a name="l06210"></a>06210             <span class="keywordflow">if</span> (reSection.test(line)) { <span class="comment">// section start?</span>
<a name="l06211"></a>06211               match = reSection.exec(line);
<a name="l06212"></a>06212               currentLang = match[1];
<a name="l06213"></a>06213               skipLang = (currentLang !== <span class="charliteral">&#39;*&#39;</span>) &amp;&amp;
<a name="l06214"></a>06214                   (currentLang !== lang) &amp;&amp; (currentLang !== genericLang);
<a name="l06215"></a>06215               <span class="keywordflow">continue</span>;
<a name="l06216"></a>06216             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (skipLang) {
<a name="l06217"></a>06217               <span class="keywordflow">continue</span>;
<a name="l06218"></a>06218             }
<a name="l06219"></a>06219             <span class="keywordflow">if</span> (reImport.test(line)) { <span class="comment">// @import rule?</span>
<a name="l06220"></a>06220               match = reImport.exec(line);
<a name="l06221"></a>06221               loadImport(baseURL + match[1]); <span class="comment">// load the resource synchronously</span>
<a name="l06222"></a>06222             }
<a name="l06223"></a>06223           }
<a name="l06224"></a>06224 
<a name="l06225"></a>06225           <span class="comment">// key-value pair</span>
<a name="l06226"></a>06226           var <a class="code" href="../../db/de5/namespacedefault__timezones.html#ac494636c41cb282619c68c44af233bc7">tmp</a> = line.match(reSplit);
<a name="l06227"></a>06227           <span class="keywordflow">if</span> (tmp &amp;&amp; tmp.length == 3) {
<a name="l06228"></a>06228             <span class="comment">// unescape unicode char codes if needed (e.g. &#39;\u00a0&#39;)</span>
<a name="l06229"></a>06229             var <a class="code" href="../../d7/d27/jpeglib_8h.html#abde23394a8cafaa525be2efd5c6d4b2e">val</a> = tmp[2].replace(reUnicode, <span class="keyword">function</span>(match, token) {
<a name="l06230"></a>06230               <span class="keywordflow">return</span> <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#aeb2b38c79f83ae9e5450c4f19e799fe0">unescape</a>(<span class="stringliteral">&#39;%u&#39;</span> + <span class="stringliteral">&#39;0000&#39;</span>.<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>(token.length) + token);
<a name="l06231"></a>06231             });
<a name="l06232"></a>06232             dictionary[tmp[1]] = evalString(val);
<a name="l06233"></a>06233           }
<a name="l06234"></a>06234         }
<a name="l06235"></a>06235       }
<a name="l06236"></a>06236 
<a name="l06237"></a>06237       <span class="comment">// import another *.properties file</span>
<a name="l06238"></a>06238       <span class="keyword">function</span> loadImport(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>) {
<a name="l06239"></a>06239         loadResource(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, <span class="keyword">function</span>(content) {
<a name="l06240"></a>06240           parseRawLines(content, <span class="keyword">false</span>); <span class="comment">// don&#39;t allow recursive imports</span>
<a name="l06241"></a>06241         }, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="keyword">false</span>); <span class="comment">// load synchronously</span>
<a name="l06242"></a>06242       }
<a name="l06243"></a>06243 
<a name="l06244"></a>06244       <span class="comment">// fill the dictionary</span>
<a name="l06245"></a>06245       parseRawLines(text, <span class="keyword">true</span>);
<a name="l06246"></a>06246       <span class="keywordflow">return</span> dictionary;
<a name="l06247"></a>06247     }
<a name="l06248"></a>06248 
<a name="l06249"></a>06249     <span class="comment">// load the specified resource file</span>
<a name="l06250"></a>06250     <span class="keyword">function</span> loadResource(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, onSuccess, onFailure, asynchronous) {
<a name="l06251"></a>06251       onSuccess = onSuccess || <span class="keyword">function</span> _onSuccess(data) {};
<a name="l06252"></a>06252       onFailure = onFailure || <span class="keyword">function</span> _onFailure() {
<a name="l06253"></a>06253         consoleWarn(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> + <span class="stringliteral">&#39; not found.&#39;</span>);
<a name="l06254"></a>06254       };
<a name="l06255"></a>06255 
<a name="l06256"></a>06256       var <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a> = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a2619068a621e6b22d7995161b2cea021">XMLHttpRequest</a>();
<a name="l06257"></a>06257       xhr.open(<span class="stringliteral">&#39;GET&#39;</span>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, asynchronous);
<a name="l06258"></a>06258       <span class="keywordflow">if</span> (xhr.overrideMimeType) {
<a name="l06259"></a>06259         xhr.overrideMimeType(<span class="stringliteral">&#39;text/plain; charset=utf-8&#39;</span>);
<a name="l06260"></a>06260       }
<a name="l06261"></a>06261       xhr.onreadystatechange = <span class="keyword">function</span>() {
<a name="l06262"></a>06262         <span class="keywordflow">if</span> (xhr.readyState == 4) {
<a name="l06263"></a>06263           <span class="keywordflow">if</span> (xhr.status == 200 || xhr.status === 0) {
<a name="l06264"></a>06264             onSuccess(xhr.responseText);
<a name="l06265"></a>06265           } <span class="keywordflow">else</span> {
<a name="l06266"></a>06266             onFailure();
<a name="l06267"></a>06267           }
<a name="l06268"></a>06268         }
<a name="l06269"></a>06269       };
<a name="l06270"></a>06270       xhr.onerror = onFailure;
<a name="l06271"></a>06271       xhr.ontimeout = onFailure;
<a name="l06272"></a>06272 
<a name="l06273"></a>06273       <span class="comment">// in Firefox OS with the app:// protocol, trying to XHR a non-existing</span>
<a name="l06274"></a>06274       <span class="comment">// URL will raise an exception here -- hence this ugly try...catch.</span>
<a name="l06275"></a>06275       <span class="keywordflow">try</span> {
<a name="l06276"></a>06276         xhr.send(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l06277"></a>06277       } <span class="keywordflow">catch</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l06278"></a>06278         onFailure();
<a name="l06279"></a>06279       }
<a name="l06280"></a>06280     }
<a name="l06281"></a>06281 
<a name="l06282"></a>06282     <span class="comment">// load and parse l10n data (warning: global variables are used here)</span>
<a name="l06283"></a>06283     loadResource(href, <span class="keyword">function</span>(response) {
<a name="l06284"></a>06284       <span class="keywordflow">if</span> (/\.json$/.<a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a4fe50fa16c059b33ed172c344bb3fc74">test</a>(href)) {
<a name="l06285"></a>06285         gL10nData = JSON.parse(response); <span class="comment">// TODO: support multiple JSON files</span>
<a name="l06286"></a>06286       } <span class="keywordflow">else</span> { <span class="comment">// *.ini or *.properties file</span>
<a name="l06287"></a>06287         var data = parseProperties(response);
<a name="l06288"></a>06288         <span class="keywordflow">for</span> (var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in data) {
<a name="l06289"></a>06289           var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>, prop, nestedProp, <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> = <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>.lastIndexOf(<span class="charliteral">&#39;.&#39;</span>);
<a name="l06290"></a>06290           <span class="keywordflow">if</span> (index &gt; 0) { <span class="comment">// a property name has been specified</span>
<a name="l06291"></a>06291             <span class="keywordtype">id</span> = <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>.slice(0, index);
<a name="l06292"></a>06292             prop = <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>.slice(index + 1);
<a name="l06293"></a>06293             index = <span class="keywordtype">id</span>.lastIndexOf(<span class="charliteral">&#39;.&#39;</span>);
<a name="l06294"></a>06294             <span class="keywordflow">if</span> (index &gt; 0) { <span class="comment">// a nested property may have been specified</span>
<a name="l06295"></a>06295               nestedProp = <span class="keywordtype">id</span>.substr(index + 1);
<a name="l06296"></a>06296               <span class="keywordflow">if</span> (gNestedProps.indexOf(nestedProp) &gt; -1) {
<a name="l06297"></a>06297                 <span class="keywordtype">id</span> = <span class="keywordtype">id</span>.substr(0, index);
<a name="l06298"></a>06298                 prop = nestedProp + <span class="charliteral">&#39;.&#39;</span> + prop;
<a name="l06299"></a>06299               }
<a name="l06300"></a>06300             }
<a name="l06301"></a>06301           } <span class="keywordflow">else</span> { <span class="comment">// no property name: assuming text content by default</span>
<a name="l06302"></a>06302             index = <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>.lastIndexOf(<span class="charliteral">&#39;[&#39;</span>);
<a name="l06303"></a>06303             <span class="keywordflow">if</span> (index &gt; 0) { <span class="comment">// we have a macro index</span>
<a name="l06304"></a>06304               <span class="keywordtype">id</span> = <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>.slice(0, index);
<a name="l06305"></a>06305               prop = <span class="charliteral">&#39;_&#39;</span> + <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>.slice(index);
<a name="l06306"></a>06306             } <span class="keywordflow">else</span> {
<a name="l06307"></a>06307               <span class="keywordtype">id</span> = <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>;
<a name="l06308"></a>06308               prop = <span class="charliteral">&#39;_&#39;</span>;
<a name="l06309"></a>06309             }
<a name="l06310"></a>06310           }
<a name="l06311"></a>06311           <span class="keywordflow">if</span> (!gL10nData[<span class="keywordtype">id</span>]) {
<a name="l06312"></a>06312             gL10nData[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>] = {};
<a name="l06313"></a>06313           }
<a name="l06314"></a>06314           gL10nData[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>][prop] = data[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l06315"></a>06315         }
<a name="l06316"></a>06316       }
<a name="l06317"></a>06317 
<a name="l06318"></a>06318       <span class="comment">// trigger callback</span>
<a name="l06319"></a>06319       <span class="keywordflow">if</span> (successCallback) {
<a name="l06320"></a>06320         successCallback();
<a name="l06321"></a>06321       }
<a name="l06322"></a>06322     }, failureCallback, gAsyncResourceLoading);
<a name="l06323"></a>06323   };
<a name="l06324"></a>06324 
<a name="l06325"></a>06325   <span class="comment">// load and parse all resources for the specified locale</span>
<a name="l06326"></a>06326   <span class="keyword">function</span> loadLocale(lang, translationRequired) {
<a name="l06327"></a>06327     <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a1ac2b96f3c890c1170f3be034398a81d">clear</a>();
<a name="l06328"></a>06328     gReadyState = <span class="stringliteral">&#39;loading&#39;</span>;
<a name="l06329"></a>06329     gLanguage = lang;
<a name="l06330"></a>06330 
<a name="l06331"></a>06331     var untranslatedElements = [];
<a name="l06332"></a>06332 
<a name="l06333"></a>06333     <span class="comment">// if there is an inline / pre-compiled dictionary,</span>
<a name="l06334"></a>06334     <span class="comment">// the current HTML document can be translated right now</span>
<a name="l06335"></a>06335     var inlineDict = getL10nDictionary(lang);
<a name="l06336"></a>06336     <span class="keywordflow">if</span> (inlineDict) {
<a name="l06337"></a>06337       gL10nData = inlineDict;
<a name="l06338"></a>06338       <span class="keywordflow">if</span> (translationRequired) {
<a name="l06339"></a>06339         untranslatedElements = translateFragment();
<a name="l06340"></a>06340       }
<a name="l06341"></a>06341     }
<a name="l06342"></a>06342 
<a name="l06343"></a>06343     <span class="comment">// translate the document if required and fire a `localized&#39; event</span>
<a name="l06344"></a>06344     <span class="keyword">function</span> <a class="code" href="../../db/d3b/vcard__parser_8js.html#a8633e06aad3ef79a5fd09e4a1fb409dd">finish</a>() {
<a name="l06345"></a>06345       <span class="keywordflow">if</span> (translationRequired) {
<a name="l06346"></a>06346         <span class="keywordflow">if</span> (!inlineDict) {
<a name="l06347"></a>06347           <span class="comment">// no inline dictionary has been used: translate the whole document</span>
<a name="l06348"></a>06348           untranslatedElements = translateFragment();
<a name="l06349"></a>06349         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (untranslatedElements.length) {
<a name="l06350"></a>06350           <span class="comment">// the document should have been already translated but the inline</span>
<a name="l06351"></a>06351           <span class="comment">// dictionary didn&#39;t include all necessary l10n keys:</span>
<a name="l06352"></a>06352           <span class="comment">// try to translate all remaining elements now</span>
<a name="l06353"></a>06353           untranslatedElements = translateElements(untranslatedElements);
<a name="l06354"></a>06354         }
<a name="l06355"></a>06355       }
<a name="l06356"></a>06356       <span class="comment">// tell the rest of the world we&#39;re done</span>
<a name="l06357"></a>06357       <span class="comment">// -- note that `gReadyState&#39; must be set before the `localized&#39; event is</span>
<a name="l06358"></a>06358       <span class="comment">//    fired for `localizeElement()&#39; to work as expected</span>
<a name="l06359"></a>06359       gReadyState = <span class="stringliteral">&#39;complete&#39;</span>;
<a name="l06360"></a>06360       fireL10nReadyEvent(lang);
<a name="l06361"></a>06361       consoleWarn_missingKeys(untranslatedElements, lang);
<a name="l06362"></a>06362     }
<a name="l06363"></a>06363 
<a name="l06364"></a>06364     <span class="comment">// l10n resource loader</span>
<a name="l06365"></a>06365     <span class="keyword">function</span> l10nResourceLink(link) {
<a name="l06371"></a>06371       var re = /\{\{\s*locale\s*\}\}/;
<a name="l06372"></a>06372 
<a name="l06373"></a>06373       var <a class="code" href="../../d1/d22/ical_8js.html#a2c438207bb0df36648d3da7ccaac2441">parse</a> = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a38008f9ebcd87acfca726e35504b2e8d">locale</a>, <a class="code" href="../../d8/deb/share_8js.html#ae63fb598d93a4bb590d74a27b9398c71">onload</a>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>) {
<a name="l06374"></a>06374         var href = <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#aeb2b38c79f83ae9e5450c4f19e799fe0">unescape</a>(link.href).replace(re, <a class="code" href="../../d2/d7d/jsapi_8h.html#a38008f9ebcd87acfca726e35504b2e8d">locale</a>);
<a name="l06375"></a>06375         parseResource(href, <a class="code" href="../../d2/d7d/jsapi_8h.html#a38008f9ebcd87acfca726e35504b2e8d">locale</a>, onload, <span class="keyword">function</span> notFound() {
<a name="l06376"></a>06376           consoleWarn(href + <span class="stringliteral">&#39; not found.&#39;</span>);
<a name="l06377"></a>06377           <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>();
<a name="l06378"></a>06378         });
<a name="l06379"></a>06379       };
<a name="l06380"></a>06380 
<a name="l06381"></a>06381       this.<a class="code" href="../../db/d6b/make__gaia__shared_8js.html#ac5aa547163f784b68be607a47eb170b1">load</a> = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a38008f9ebcd87acfca726e35504b2e8d">locale</a>, <a class="code" href="../../d8/deb/share_8js.html#ae63fb598d93a4bb590d74a27b9398c71">onload</a>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>) {
<a name="l06382"></a>06382         <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a> = <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a> || <span class="keyword">function</span>() {};
<a name="l06383"></a>06383         <a class="code" href="../../d1/d22/ical_8js.html#a2c438207bb0df36648d3da7ccaac2441">parse</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a38008f9ebcd87acfca726e35504b2e8d">locale</a>, onload, <span class="keyword">function</span> parseFallbackLocale() {
<a name="l06390"></a>06390           <span class="keywordflow">if</span> (re.test(<a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#aeb2b38c79f83ae9e5450c4f19e799fe0">unescape</a>(link.href)) &amp;&amp; gDefaultLocale != <a class="code" href="../../d2/d7d/jsapi_8h.html#a38008f9ebcd87acfca726e35504b2e8d">locale</a>) {
<a name="l06391"></a>06391             consoleLog(<span class="stringliteral">&#39;Trying the fallback locale: &#39;</span> + gDefaultLocale);
<a name="l06392"></a>06392             <a class="code" href="../../d1/d22/ical_8js.html#a2c438207bb0df36648d3da7ccaac2441">parse</a>(gDefaultLocale, onload, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>);
<a name="l06393"></a>06393           } <span class="keywordflow">else</span> {
<a name="l06394"></a>06394             <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>();
<a name="l06395"></a>06395           }
<a name="l06396"></a>06396         });
<a name="l06397"></a>06397       };
<a name="l06398"></a>06398     }
<a name="l06399"></a>06399 
<a name="l06400"></a>06400     <span class="comment">// check all &lt;link type=&quot;application/l10n&quot; href=&quot;...&quot; /&gt; nodes</span>
<a name="l06401"></a>06401     <span class="comment">// and load the resource files</span>
<a name="l06402"></a>06402     var resourceLinks = getL10nResourceLinks();
<a name="l06403"></a>06403     var resourceCount = resourceLinks.length;
<a name="l06404"></a>06404     <span class="keywordflow">if</span> (!resourceCount) {
<a name="l06405"></a>06405       consoleLog(<span class="stringliteral">&#39;no resource to load, early way out&#39;</span>);
<a name="l06406"></a>06406       translationRequired = <span class="keyword">false</span>;
<a name="l06407"></a>06407       <a class="code" href="../../db/d3b/vcard__parser_8js.html#a8633e06aad3ef79a5fd09e4a1fb409dd">finish</a>();
<a name="l06408"></a>06408     } <span class="keywordflow">else</span> {
<a name="l06409"></a>06409       var onResourceCallback = <span class="keyword">function</span>() {
<a name="l06410"></a>06410         <span class="keywordflow">if</span> (--resourceCount &lt;= 0) { <span class="comment">// &lt;=&gt; all resources have been XHR&#39;ed</span>
<a name="l06411"></a>06411           <a class="code" href="../../db/d3b/vcard__parser_8js.html#a8633e06aad3ef79a5fd09e4a1fb409dd">finish</a>();
<a name="l06412"></a>06412         }
<a name="l06413"></a>06413       };
<a name="l06414"></a>06414       <span class="keywordflow">for</span> (var i = 0, <a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a> = resourceCount; i &lt; <a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a>; i++) {
<a name="l06415"></a>06415         var resource = <span class="keyword">new</span> l10nResourceLink(resourceLinks[i]);
<a name="l06416"></a>06416         resource.load(lang, onResourceCallback, onResourceCallback);
<a name="l06417"></a>06417       }
<a name="l06418"></a>06418     }
<a name="l06419"></a>06419   }
<a name="l06420"></a>06420 
<a name="l06421"></a>06421   <span class="comment">// clear all l10n data</span>
<a name="l06422"></a>06422   <span class="keyword">function</span> <a class="code" href="../../d6/d40/build__stage_2email_2shared_2js_2media_2media__frame_8js.html#a1ac2b96f3c890c1170f3be034398a81d">clear</a>() {
<a name="l06423"></a>06423     gL10nData = {};
<a name="l06424"></a>06424     gLanguage = <span class="stringliteral">&#39;&#39;</span>;
<a name="l06425"></a>06425     <span class="comment">// TODO: clear all non predefined macros.</span>
<a name="l06426"></a>06426     <span class="comment">// There&#39;s no such macro /yet/ but we&#39;re planning to have some...</span>
<a name="l06427"></a>06427   }
<a name="l06428"></a>06428 
<a name="l06429"></a>06429 
<a name="l06446"></a>06446   var kPluralForms = [<span class="stringliteral">&#39;zero&#39;</span>, <span class="stringliteral">&#39;one&#39;</span>, <span class="stringliteral">&#39;two&#39;</span>, <span class="stringliteral">&#39;few&#39;</span>, <span class="stringliteral">&#39;many&#39;</span>, <span class="stringliteral">&#39;other&#39;</span>];
<a name="l06447"></a>06447 
<a name="l06448"></a>06448   <span class="keyword">function</span> getPluralRules(lang) {
<a name="l06449"></a>06449     var locales2rules = {
<a name="l06450"></a>06450       <span class="stringliteral">&#39;af&#39;</span>: 3,
<a name="l06451"></a>06451       <span class="stringliteral">&#39;ak&#39;</span>: 4,
<a name="l06452"></a>06452       <span class="stringliteral">&#39;am&#39;</span>: 4,
<a name="l06453"></a>06453       <span class="stringliteral">&#39;ar&#39;</span>: 1,
<a name="l06454"></a>06454       <span class="stringliteral">&#39;asa&#39;</span>: 3,
<a name="l06455"></a>06455       <span class="stringliteral">&#39;az&#39;</span>: 0,
<a name="l06456"></a>06456       <span class="stringliteral">&#39;be&#39;</span>: 11,
<a name="l06457"></a>06457       <span class="stringliteral">&#39;bem&#39;</span>: 3,
<a name="l06458"></a>06458       <span class="stringliteral">&#39;bez&#39;</span>: 3,
<a name="l06459"></a>06459       <span class="stringliteral">&#39;bg&#39;</span>: 3,
<a name="l06460"></a>06460       <span class="stringliteral">&#39;bh&#39;</span>: 4,
<a name="l06461"></a>06461       <span class="stringliteral">&#39;bm&#39;</span>: 0,
<a name="l06462"></a>06462       <span class="stringliteral">&#39;bn&#39;</span>: 3,
<a name="l06463"></a>06463       <span class="stringliteral">&#39;bo&#39;</span>: 0,
<a name="l06464"></a>06464       <span class="stringliteral">&#39;br&#39;</span>: 20,
<a name="l06465"></a>06465       <span class="stringliteral">&#39;brx&#39;</span>: 3,
<a name="l06466"></a>06466       <span class="stringliteral">&#39;bs&#39;</span>: 11,
<a name="l06467"></a>06467       <span class="stringliteral">&#39;ca&#39;</span>: 3,
<a name="l06468"></a>06468       <span class="stringliteral">&#39;cgg&#39;</span>: 3,
<a name="l06469"></a>06469       <span class="stringliteral">&#39;chr&#39;</span>: 3,
<a name="l06470"></a>06470       <span class="stringliteral">&#39;cs&#39;</span>: 12,
<a name="l06471"></a>06471       <span class="stringliteral">&#39;cy&#39;</span>: 17,
<a name="l06472"></a>06472       <span class="stringliteral">&#39;da&#39;</span>: 3,
<a name="l06473"></a>06473       <span class="stringliteral">&#39;de&#39;</span>: 3,
<a name="l06474"></a>06474       <span class="stringliteral">&#39;dv&#39;</span>: 3,
<a name="l06475"></a>06475       <span class="stringliteral">&#39;dz&#39;</span>: 0,
<a name="l06476"></a>06476       <span class="stringliteral">&#39;ee&#39;</span>: 3,
<a name="l06477"></a>06477       <span class="stringliteral">&#39;el&#39;</span>: 3,
<a name="l06478"></a>06478       <span class="stringliteral">&#39;en&#39;</span>: 3,
<a name="l06479"></a>06479       <span class="stringliteral">&#39;eo&#39;</span>: 3,
<a name="l06480"></a>06480       <span class="stringliteral">&#39;es&#39;</span>: 3,
<a name="l06481"></a>06481       <span class="stringliteral">&#39;et&#39;</span>: 3,
<a name="l06482"></a>06482       <span class="stringliteral">&#39;eu&#39;</span>: 3,
<a name="l06483"></a>06483       <span class="stringliteral">&#39;fa&#39;</span>: 0,
<a name="l06484"></a>06484       <span class="stringliteral">&#39;ff&#39;</span>: 5,
<a name="l06485"></a>06485       <span class="stringliteral">&#39;fi&#39;</span>: 3,
<a name="l06486"></a>06486       <span class="stringliteral">&#39;fil&#39;</span>: 4,
<a name="l06487"></a>06487       <span class="stringliteral">&#39;fo&#39;</span>: 3,
<a name="l06488"></a>06488       <span class="stringliteral">&#39;fr&#39;</span>: 5,
<a name="l06489"></a>06489       <span class="stringliteral">&#39;fur&#39;</span>: 3,
<a name="l06490"></a>06490       <span class="stringliteral">&#39;fy&#39;</span>: 3,
<a name="l06491"></a>06491       <span class="stringliteral">&#39;ga&#39;</span>: 8,
<a name="l06492"></a>06492       <span class="stringliteral">&#39;gd&#39;</span>: 24,
<a name="l06493"></a>06493       <span class="stringliteral">&#39;gl&#39;</span>: 3,
<a name="l06494"></a>06494       <span class="stringliteral">&#39;gsw&#39;</span>: 3,
<a name="l06495"></a>06495       <span class="stringliteral">&#39;gu&#39;</span>: 3,
<a name="l06496"></a>06496       <span class="stringliteral">&#39;guw&#39;</span>: 4,
<a name="l06497"></a>06497       <span class="stringliteral">&#39;gv&#39;</span>: 23,
<a name="l06498"></a>06498       <span class="stringliteral">&#39;ha&#39;</span>: 3,
<a name="l06499"></a>06499       <span class="stringliteral">&#39;haw&#39;</span>: 3,
<a name="l06500"></a>06500       <span class="stringliteral">&#39;he&#39;</span>: 2,
<a name="l06501"></a>06501       <span class="stringliteral">&#39;hi&#39;</span>: 4,
<a name="l06502"></a>06502       <span class="stringliteral">&#39;hr&#39;</span>: 11,
<a name="l06503"></a>06503       <span class="stringliteral">&#39;hu&#39;</span>: 0,
<a name="l06504"></a>06504       <span class="stringliteral">&#39;id&#39;</span>: 0,
<a name="l06505"></a>06505       <span class="stringliteral">&#39;ig&#39;</span>: 0,
<a name="l06506"></a>06506       <span class="stringliteral">&#39;ii&#39;</span>: 0,
<a name="l06507"></a>06507       <span class="stringliteral">&#39;is&#39;</span>: 3,
<a name="l06508"></a>06508       <span class="stringliteral">&#39;it&#39;</span>: 3,
<a name="l06509"></a>06509       <span class="stringliteral">&#39;iu&#39;</span>: 7,
<a name="l06510"></a>06510       <span class="stringliteral">&#39;ja&#39;</span>: 0,
<a name="l06511"></a>06511       <span class="stringliteral">&#39;jmc&#39;</span>: 3,
<a name="l06512"></a>06512       <span class="stringliteral">&#39;jv&#39;</span>: 0,
<a name="l06513"></a>06513       <span class="stringliteral">&#39;ka&#39;</span>: 0,
<a name="l06514"></a>06514       <span class="stringliteral">&#39;kab&#39;</span>: 5,
<a name="l06515"></a>06515       <span class="stringliteral">&#39;kaj&#39;</span>: 3,
<a name="l06516"></a>06516       <span class="stringliteral">&#39;kcg&#39;</span>: 3,
<a name="l06517"></a>06517       <span class="stringliteral">&#39;kde&#39;</span>: 0,
<a name="l06518"></a>06518       <span class="stringliteral">&#39;kea&#39;</span>: 0,
<a name="l06519"></a>06519       <span class="stringliteral">&#39;kk&#39;</span>: 3,
<a name="l06520"></a>06520       <span class="stringliteral">&#39;kl&#39;</span>: 3,
<a name="l06521"></a>06521       <span class="stringliteral">&#39;km&#39;</span>: 0,
<a name="l06522"></a>06522       <span class="stringliteral">&#39;kn&#39;</span>: 0,
<a name="l06523"></a>06523       <span class="stringliteral">&#39;ko&#39;</span>: 0,
<a name="l06524"></a>06524       <span class="stringliteral">&#39;ksb&#39;</span>: 3,
<a name="l06525"></a>06525       <span class="stringliteral">&#39;ksh&#39;</span>: 21,
<a name="l06526"></a>06526       <span class="stringliteral">&#39;ku&#39;</span>: 3,
<a name="l06527"></a>06527       <span class="stringliteral">&#39;kw&#39;</span>: 7,
<a name="l06528"></a>06528       <span class="stringliteral">&#39;lag&#39;</span>: 18,
<a name="l06529"></a>06529       <span class="stringliteral">&#39;lb&#39;</span>: 3,
<a name="l06530"></a>06530       <span class="stringliteral">&#39;lg&#39;</span>: 3,
<a name="l06531"></a>06531       <span class="stringliteral">&#39;ln&#39;</span>: 4,
<a name="l06532"></a>06532       <span class="stringliteral">&#39;lo&#39;</span>: 0,
<a name="l06533"></a>06533       <span class="stringliteral">&#39;lt&#39;</span>: 10,
<a name="l06534"></a>06534       <span class="stringliteral">&#39;lv&#39;</span>: 6,
<a name="l06535"></a>06535       <span class="stringliteral">&#39;mas&#39;</span>: 3,
<a name="l06536"></a>06536       <span class="stringliteral">&#39;mg&#39;</span>: 4,
<a name="l06537"></a>06537       <span class="stringliteral">&#39;mk&#39;</span>: 16,
<a name="l06538"></a>06538       <span class="stringliteral">&#39;ml&#39;</span>: 3,
<a name="l06539"></a>06539       <span class="stringliteral">&#39;mn&#39;</span>: 3,
<a name="l06540"></a>06540       <span class="stringliteral">&#39;mo&#39;</span>: 9,
<a name="l06541"></a>06541       <span class="stringliteral">&#39;mr&#39;</span>: 3,
<a name="l06542"></a>06542       <span class="stringliteral">&#39;ms&#39;</span>: 0,
<a name="l06543"></a>06543       <span class="stringliteral">&#39;mt&#39;</span>: 15,
<a name="l06544"></a>06544       <span class="stringliteral">&#39;my&#39;</span>: 0,
<a name="l06545"></a>06545       <span class="stringliteral">&#39;nah&#39;</span>: 3,
<a name="l06546"></a>06546       <span class="stringliteral">&#39;naq&#39;</span>: 7,
<a name="l06547"></a>06547       <span class="stringliteral">&#39;nb&#39;</span>: 3,
<a name="l06548"></a>06548       <span class="stringliteral">&#39;nd&#39;</span>: 3,
<a name="l06549"></a>06549       <span class="stringliteral">&#39;ne&#39;</span>: 3,
<a name="l06550"></a>06550       <span class="stringliteral">&#39;nl&#39;</span>: 3,
<a name="l06551"></a>06551       <span class="stringliteral">&#39;nn&#39;</span>: 3,
<a name="l06552"></a>06552       <span class="stringliteral">&#39;no&#39;</span>: 3,
<a name="l06553"></a>06553       <span class="stringliteral">&#39;nr&#39;</span>: 3,
<a name="l06554"></a>06554       <span class="stringliteral">&#39;nso&#39;</span>: 4,
<a name="l06555"></a>06555       <span class="stringliteral">&#39;ny&#39;</span>: 3,
<a name="l06556"></a>06556       <span class="stringliteral">&#39;nyn&#39;</span>: 3,
<a name="l06557"></a>06557       <span class="stringliteral">&#39;om&#39;</span>: 3,
<a name="l06558"></a>06558       <span class="stringliteral">&#39;or&#39;</span>: 3,
<a name="l06559"></a>06559       <span class="stringliteral">&#39;pa&#39;</span>: 3,
<a name="l06560"></a>06560       <span class="stringliteral">&#39;pap&#39;</span>: 3,
<a name="l06561"></a>06561       <span class="stringliteral">&#39;pl&#39;</span>: 13,
<a name="l06562"></a>06562       <span class="stringliteral">&#39;ps&#39;</span>: 3,
<a name="l06563"></a>06563       <span class="stringliteral">&#39;pt&#39;</span>: 3,
<a name="l06564"></a>06564       <span class="stringliteral">&#39;rm&#39;</span>: 3,
<a name="l06565"></a>06565       <span class="stringliteral">&#39;ro&#39;</span>: 9,
<a name="l06566"></a>06566       <span class="stringliteral">&#39;rof&#39;</span>: 3,
<a name="l06567"></a>06567       <span class="stringliteral">&#39;ru&#39;</span>: 11,
<a name="l06568"></a>06568       <span class="stringliteral">&#39;rwk&#39;</span>: 3,
<a name="l06569"></a>06569       <span class="stringliteral">&#39;sah&#39;</span>: 0,
<a name="l06570"></a>06570       <span class="stringliteral">&#39;saq&#39;</span>: 3,
<a name="l06571"></a>06571       <span class="stringliteral">&#39;se&#39;</span>: 7,
<a name="l06572"></a>06572       <span class="stringliteral">&#39;seh&#39;</span>: 3,
<a name="l06573"></a>06573       <span class="stringliteral">&#39;ses&#39;</span>: 0,
<a name="l06574"></a>06574       <span class="stringliteral">&#39;sg&#39;</span>: 0,
<a name="l06575"></a>06575       <span class="stringliteral">&#39;sh&#39;</span>: 11,
<a name="l06576"></a>06576       <span class="stringliteral">&#39;shi&#39;</span>: 19,
<a name="l06577"></a>06577       <span class="stringliteral">&#39;sk&#39;</span>: 12,
<a name="l06578"></a>06578       <span class="stringliteral">&#39;sl&#39;</span>: 14,
<a name="l06579"></a>06579       <span class="stringliteral">&#39;sma&#39;</span>: 7,
<a name="l06580"></a>06580       <span class="stringliteral">&#39;smi&#39;</span>: 7,
<a name="l06581"></a>06581       <span class="stringliteral">&#39;smj&#39;</span>: 7,
<a name="l06582"></a>06582       <span class="stringliteral">&#39;smn&#39;</span>: 7,
<a name="l06583"></a>06583       <span class="stringliteral">&#39;sms&#39;</span>: 7,
<a name="l06584"></a>06584       <span class="stringliteral">&#39;sn&#39;</span>: 3,
<a name="l06585"></a>06585       <span class="stringliteral">&#39;so&#39;</span>: 3,
<a name="l06586"></a>06586       <span class="stringliteral">&#39;sq&#39;</span>: 3,
<a name="l06587"></a>06587       <span class="stringliteral">&#39;sr&#39;</span>: 11,
<a name="l06588"></a>06588       <span class="stringliteral">&#39;ss&#39;</span>: 3,
<a name="l06589"></a>06589       <span class="stringliteral">&#39;ssy&#39;</span>: 3,
<a name="l06590"></a>06590       <span class="stringliteral">&#39;st&#39;</span>: 3,
<a name="l06591"></a>06591       <span class="stringliteral">&#39;sv&#39;</span>: 3,
<a name="l06592"></a>06592       <span class="stringliteral">&#39;sw&#39;</span>: 3,
<a name="l06593"></a>06593       <span class="stringliteral">&#39;syr&#39;</span>: 3,
<a name="l06594"></a>06594       <span class="stringliteral">&#39;ta&#39;</span>: 3,
<a name="l06595"></a>06595       <span class="stringliteral">&#39;te&#39;</span>: 3,
<a name="l06596"></a>06596       <span class="stringliteral">&#39;teo&#39;</span>: 3,
<a name="l06597"></a>06597       <span class="stringliteral">&#39;th&#39;</span>: 0,
<a name="l06598"></a>06598       <span class="stringliteral">&#39;ti&#39;</span>: 4,
<a name="l06599"></a>06599       <span class="stringliteral">&#39;tig&#39;</span>: 3,
<a name="l06600"></a>06600       <span class="stringliteral">&#39;tk&#39;</span>: 3,
<a name="l06601"></a>06601       <span class="stringliteral">&#39;tl&#39;</span>: 4,
<a name="l06602"></a>06602       <span class="stringliteral">&#39;tn&#39;</span>: 3,
<a name="l06603"></a>06603       <span class="stringliteral">&#39;to&#39;</span>: 0,
<a name="l06604"></a>06604       <span class="stringliteral">&#39;tr&#39;</span>: 0,
<a name="l06605"></a>06605       <span class="stringliteral">&#39;ts&#39;</span>: 3,
<a name="l06606"></a>06606       <span class="stringliteral">&#39;tzm&#39;</span>: 22,
<a name="l06607"></a>06607       <span class="stringliteral">&#39;uk&#39;</span>: 11,
<a name="l06608"></a>06608       <span class="stringliteral">&#39;ur&#39;</span>: 3,
<a name="l06609"></a>06609       <span class="stringliteral">&#39;ve&#39;</span>: 3,
<a name="l06610"></a>06610       <span class="stringliteral">&#39;vi&#39;</span>: 0,
<a name="l06611"></a>06611       <span class="stringliteral">&#39;vun&#39;</span>: 3,
<a name="l06612"></a>06612       <span class="stringliteral">&#39;wa&#39;</span>: 4,
<a name="l06613"></a>06613       <span class="stringliteral">&#39;wae&#39;</span>: 3,
<a name="l06614"></a>06614       <span class="stringliteral">&#39;wo&#39;</span>: 0,
<a name="l06615"></a>06615       <span class="stringliteral">&#39;xh&#39;</span>: 3,
<a name="l06616"></a>06616       <span class="stringliteral">&#39;xog&#39;</span>: 3,
<a name="l06617"></a>06617       <span class="stringliteral">&#39;yo&#39;</span>: 0,
<a name="l06618"></a>06618       <span class="stringliteral">&#39;zh&#39;</span>: 0,
<a name="l06619"></a>06619       <span class="stringliteral">&#39;zu&#39;</span>: 3
<a name="l06620"></a>06620     };
<a name="l06621"></a>06621 
<a name="l06622"></a>06622     <span class="comment">// utility functions for plural rules methods</span>
<a name="l06623"></a>06623     <span class="keyword">function</span> isIn(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>) {
<a name="l06624"></a>06624       <span class="keywordflow">return</span> <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.indexOf(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) !== -1;
<a name="l06625"></a>06625     }
<a name="l06626"></a>06626     <span class="keyword">function</span> isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>, <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>) {
<a name="l06627"></a>06627       <span class="keywordflow">return</span> <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a> &lt;= <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> &amp;&amp; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> &lt;= <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>;
<a name="l06628"></a>06628     }
<a name="l06629"></a>06629 
<a name="l06630"></a>06630     <span class="comment">// list of all plural rules methods:</span>
<a name="l06631"></a>06631     <span class="comment">// map an integer to the plural form name to use</span>
<a name="l06632"></a>06632     var pluralRules = {
<a name="l06633"></a>06633       <span class="charliteral">&#39;0&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06634"></a>06634         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06635"></a>06635       },
<a name="l06636"></a>06636       <span class="charliteral">&#39;1&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06637"></a>06637         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 3, 10)))
<a name="l06638"></a>06638           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06639"></a>06639         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> === 0)
<a name="l06640"></a>06640           <span class="keywordflow">return</span> <span class="stringliteral">&#39;zero&#39;</span>;
<a name="l06641"></a>06641         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 11, 99)))
<a name="l06642"></a>06642           <span class="keywordflow">return</span> <span class="stringliteral">&#39;many&#39;</span>;
<a name="l06643"></a>06643         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 2)
<a name="l06644"></a>06644           <span class="keywordflow">return</span> <span class="stringliteral">&#39;two&#39;</span>;
<a name="l06645"></a>06645         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06646"></a>06646           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06647"></a>06647         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06648"></a>06648       },
<a name="l06649"></a>06649       <span class="charliteral">&#39;2&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06650"></a>06650         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> !== 0 &amp;&amp; (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) === 0)
<a name="l06651"></a>06651           <span class="keywordflow">return</span> <span class="stringliteral">&#39;many&#39;</span>;
<a name="l06652"></a>06652         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 2)
<a name="l06653"></a>06653           <span class="keywordflow">return</span> <span class="stringliteral">&#39;two&#39;</span>;
<a name="l06654"></a>06654         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06655"></a>06655           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06656"></a>06656         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06657"></a>06657       },
<a name="l06658"></a>06658       <span class="charliteral">&#39;3&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06659"></a>06659         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06660"></a>06660           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06661"></a>06661         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06662"></a>06662       },
<a name="l06663"></a>06663       <span class="charliteral">&#39;4&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06664"></a>06664         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 0, 1)))
<a name="l06665"></a>06665           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06666"></a>06666         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06667"></a>06667       },
<a name="l06668"></a>06668       <span class="charliteral">&#39;5&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06669"></a>06669         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 0, 2)) &amp;&amp; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> != 2)
<a name="l06670"></a>06670           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06671"></a>06671         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06672"></a>06672       },
<a name="l06673"></a>06673       <span class="charliteral">&#39;6&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06674"></a>06674         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> === 0)
<a name="l06675"></a>06675           <span class="keywordflow">return</span> <span class="stringliteral">&#39;zero&#39;</span>;
<a name="l06676"></a>06676         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) == 1 &amp;&amp; (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100) != 11)
<a name="l06677"></a>06677           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06678"></a>06678         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06679"></a>06679       },
<a name="l06680"></a>06680       <span class="charliteral">&#39;7&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06681"></a>06681         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 2)
<a name="l06682"></a>06682           <span class="keywordflow">return</span> <span class="stringliteral">&#39;two&#39;</span>;
<a name="l06683"></a>06683         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06684"></a>06684           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06685"></a>06685         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06686"></a>06686       },
<a name="l06687"></a>06687       <span class="charliteral">&#39;8&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06688"></a>06688         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 3, 6)))
<a name="l06689"></a>06689           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06690"></a>06690         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 7, 10)))
<a name="l06691"></a>06691           <span class="keywordflow">return</span> <span class="stringliteral">&#39;many&#39;</span>;
<a name="l06692"></a>06692         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 2)
<a name="l06693"></a>06693           <span class="keywordflow">return</span> <span class="stringliteral">&#39;two&#39;</span>;
<a name="l06694"></a>06694         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06695"></a>06695           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06696"></a>06696         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06697"></a>06697       },
<a name="l06698"></a>06698       <span class="charliteral">&#39;9&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06699"></a>06699         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> === 0 || <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> != 1 &amp;&amp; (isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 1, 19)))
<a name="l06700"></a>06700           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06701"></a>06701         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06702"></a>06702           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06703"></a>06703         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06704"></a>06704       },
<a name="l06705"></a>06705       <span class="stringliteral">&#39;10&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06706"></a>06706         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10), 2, 9)) &amp;&amp; !(isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 11, 19)))
<a name="l06707"></a>06707           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06708"></a>06708         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) == 1 &amp;&amp; !(isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 11, 19)))
<a name="l06709"></a>06709           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06710"></a>06710         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06711"></a>06711       },
<a name="l06712"></a>06712       <span class="stringliteral">&#39;11&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06713"></a>06713         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10), 2, 4)) &amp;&amp; !(isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 12, 14)))
<a name="l06714"></a>06714           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06715"></a>06715         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) === 0 ||
<a name="l06716"></a>06716             (isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10), 5, 9)) ||
<a name="l06717"></a>06717             (isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 11, 14)))
<a name="l06718"></a>06718           <span class="keywordflow">return</span> <span class="stringliteral">&#39;many&#39;</span>;
<a name="l06719"></a>06719         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) == 1 &amp;&amp; (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100) != 11)
<a name="l06720"></a>06720           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06721"></a>06721         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06722"></a>06722       },
<a name="l06723"></a>06723       <span class="stringliteral">&#39;12&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06724"></a>06724         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 2, 4)))
<a name="l06725"></a>06725           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06726"></a>06726         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06727"></a>06727           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06728"></a>06728         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06729"></a>06729       },
<a name="l06730"></a>06730       <span class="stringliteral">&#39;13&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06731"></a>06731         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10), 2, 4)) &amp;&amp; !(isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 12, 14)))
<a name="l06732"></a>06732           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06733"></a>06733         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> != 1 &amp;&amp; (isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10), 0, 1)) ||
<a name="l06734"></a>06734             (isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10), 5, 9)) ||
<a name="l06735"></a>06735             (isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 12, 14)))
<a name="l06736"></a>06736           <span class="keywordflow">return</span> <span class="stringliteral">&#39;many&#39;</span>;
<a name="l06737"></a>06737         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06738"></a>06738           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06739"></a>06739         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06740"></a>06740       },
<a name="l06741"></a>06741       <span class="stringliteral">&#39;14&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06742"></a>06742         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 3, 4)))
<a name="l06743"></a>06743           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06744"></a>06744         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100) == 2)
<a name="l06745"></a>06745           <span class="keywordflow">return</span> <span class="stringliteral">&#39;two&#39;</span>;
<a name="l06746"></a>06746         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100) == 1)
<a name="l06747"></a>06747           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06748"></a>06748         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06749"></a>06749       },
<a name="l06750"></a>06750       <span class="stringliteral">&#39;15&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06751"></a>06751         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> === 0 || (isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 2, 10)))
<a name="l06752"></a>06752           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06753"></a>06753         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 11, 19)))
<a name="l06754"></a>06754           <span class="keywordflow">return</span> <span class="stringliteral">&#39;many&#39;</span>;
<a name="l06755"></a>06755         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06756"></a>06756           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06757"></a>06757         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06758"></a>06758       },
<a name="l06759"></a>06759       <span class="stringliteral">&#39;16&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06760"></a>06760         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) == 1 &amp;&amp; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> != 11)
<a name="l06761"></a>06761           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06762"></a>06762         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06763"></a>06763       },
<a name="l06764"></a>06764       <span class="stringliteral">&#39;17&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06765"></a>06765         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 3)
<a name="l06766"></a>06766           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06767"></a>06767         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> === 0)
<a name="l06768"></a>06768           <span class="keywordflow">return</span> <span class="stringliteral">&#39;zero&#39;</span>;
<a name="l06769"></a>06769         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 6)
<a name="l06770"></a>06770           <span class="keywordflow">return</span> <span class="stringliteral">&#39;many&#39;</span>;
<a name="l06771"></a>06771         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 2)
<a name="l06772"></a>06772           <span class="keywordflow">return</span> <span class="stringliteral">&#39;two&#39;</span>;
<a name="l06773"></a>06773         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06774"></a>06774           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06775"></a>06775         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06776"></a>06776       },
<a name="l06777"></a>06777       <span class="stringliteral">&#39;18&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06778"></a>06778         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> === 0)
<a name="l06779"></a>06779           <span class="keywordflow">return</span> <span class="stringliteral">&#39;zero&#39;</span>;
<a name="l06780"></a>06780         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 0, 2)) &amp;&amp; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> !== 0 &amp;&amp; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> != 2)
<a name="l06781"></a>06781           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06782"></a>06782         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06783"></a>06783       },
<a name="l06784"></a>06784       <span class="stringliteral">&#39;19&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06785"></a>06785         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 2, 10)))
<a name="l06786"></a>06786           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06787"></a>06787         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 0, 1)))
<a name="l06788"></a>06788           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06789"></a>06789         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06790"></a>06790       },
<a name="l06791"></a>06791       <span class="stringliteral">&#39;20&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06792"></a>06792         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10), 3, 4) || ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) == 9)) &amp;&amp; !(
<a name="l06793"></a>06793             isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 10, 19) ||
<a name="l06794"></a>06794             isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 70, 79) ||
<a name="l06795"></a>06795             isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), 90, 99)
<a name="l06796"></a>06796             ))
<a name="l06797"></a>06797           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06798"></a>06798         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 1000000) === 0 &amp;&amp; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> !== 0)
<a name="l06799"></a>06799           <span class="keywordflow">return</span> <span class="stringliteral">&#39;many&#39;</span>;
<a name="l06800"></a>06800         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) == 2 &amp;&amp; !isIn((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), [12, 72, 92]))
<a name="l06801"></a>06801           <span class="keywordflow">return</span> <span class="stringliteral">&#39;two&#39;</span>;
<a name="l06802"></a>06802         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10) == 1 &amp;&amp; !isIn((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 100), [11, 71, 91]))
<a name="l06803"></a>06803           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06804"></a>06804         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06805"></a>06805       },
<a name="l06806"></a>06806       <span class="stringliteral">&#39;21&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06807"></a>06807         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> === 0)
<a name="l06808"></a>06808           <span class="keywordflow">return</span> <span class="stringliteral">&#39;zero&#39;</span>;
<a name="l06809"></a>06809         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> == 1)
<a name="l06810"></a>06810           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06811"></a>06811         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06812"></a>06812       },
<a name="l06813"></a>06813       <span class="stringliteral">&#39;22&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06814"></a>06814         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 0, 1)) || (isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 11, 99)))
<a name="l06815"></a>06815           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06816"></a>06816         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06817"></a>06817       },
<a name="l06818"></a>06818       <span class="stringliteral">&#39;23&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06819"></a>06819         <span class="keywordflow">if</span> ((isBetween((<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 10), 1, 2)) || (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> % 20) === 0)
<a name="l06820"></a>06820           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06821"></a>06821         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06822"></a>06822       },
<a name="l06823"></a>06823       <span class="stringliteral">&#39;24&#39;</span>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l06824"></a>06824         <span class="keywordflow">if</span> ((isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 3, 10) || isBetween(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 13, 19)))
<a name="l06825"></a>06825           <span class="keywordflow">return</span> <span class="stringliteral">&#39;few&#39;</span>;
<a name="l06826"></a>06826         <span class="keywordflow">if</span> (isIn(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, [2, 12]))
<a name="l06827"></a>06827           <span class="keywordflow">return</span> <span class="stringliteral">&#39;two&#39;</span>;
<a name="l06828"></a>06828         <span class="keywordflow">if</span> (isIn(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, [1, 11]))
<a name="l06829"></a>06829           <span class="keywordflow">return</span> <span class="stringliteral">&#39;one&#39;</span>;
<a name="l06830"></a>06830         <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>;
<a name="l06831"></a>06831       }
<a name="l06832"></a>06832     };
<a name="l06833"></a>06833 
<a name="l06834"></a>06834     <span class="comment">// return a function that gives the plural form name for a given integer</span>
<a name="l06835"></a>06835     var index = locales2rules[lang.replace(/-.*$/, <span class="stringliteral">&#39;&#39;</span>)];
<a name="l06836"></a>06836     <span class="keywordflow">if</span> (!(index in pluralRules)) {
<a name="l06837"></a>06837       consoleWarn(<span class="stringliteral">&#39;plural form unknown for [&#39;</span> + lang + <span class="charliteral">&#39;]&#39;</span>);
<a name="l06838"></a>06838       <span class="keywordflow">return</span> <span class="keyword">function</span>() { <span class="keywordflow">return</span> <span class="stringliteral">&#39;other&#39;</span>; };
<a name="l06839"></a>06839     }
<a name="l06840"></a>06840     <span class="keywordflow">return</span> pluralRules[<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>];
<a name="l06841"></a>06841   }
<a name="l06842"></a>06842 
<a name="l06843"></a>06843   <span class="comment">// pre-defined &#39;plural&#39; macro</span>
<a name="l06844"></a>06844   gMacros.plural = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>, param, <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, prop) {
<a name="l06845"></a>06845     var <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> = parseFloat(param);
<a name="l06846"></a>06846     <span class="keywordflow">if</span> (isNaN(n)) {
<a name="l06847"></a>06847       <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l06848"></a>06848     }
<a name="l06849"></a>06849 
<a name="l06850"></a>06850     var data = gL10nData[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l06851"></a>06851     <span class="keywordflow">if</span> (!data) {
<a name="l06852"></a>06852       <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l06853"></a>06853     }
<a name="l06854"></a>06854 
<a name="l06855"></a>06855     <span class="comment">// initialize _pluralRules</span>
<a name="l06856"></a>06856     <span class="keywordflow">if</span> (!gMacros._pluralRules) {
<a name="l06857"></a>06857       gMacros._pluralRules = getPluralRules(gLanguage);
<a name="l06858"></a>06858     }
<a name="l06859"></a>06859     var index = <span class="charliteral">&#39;[&#39;</span> + gMacros._pluralRules(n) + <span class="charliteral">&#39;]&#39;</span>;
<a name="l06860"></a>06860 
<a name="l06861"></a>06861     <span class="comment">// try to find a [zero|one|two] form if it&#39;s defined</span>
<a name="l06862"></a>06862     <span class="keywordflow">if</span> (n === 0 &amp;&amp; (prop + <span class="stringliteral">&#39;[zero]&#39;</span>) in data) {
<a name="l06863"></a>06863       <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = data[prop + <span class="stringliteral">&#39;[zero]&#39;</span>];
<a name="l06864"></a>06864     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n == 1 &amp;&amp; (prop + <span class="stringliteral">&#39;[one]&#39;</span>) in data) {
<a name="l06865"></a>06865       <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = data[prop + <span class="stringliteral">&#39;[one]&#39;</span>];
<a name="l06866"></a>06866     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n == 2 &amp;&amp; (prop + <span class="stringliteral">&#39;[two]&#39;</span>) in data) {
<a name="l06867"></a>06867       <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = data[prop + <span class="stringliteral">&#39;[two]&#39;</span>];
<a name="l06868"></a>06868     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((prop + index) in data) {
<a name="l06869"></a>06869       <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = data[prop + <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>];
<a name="l06870"></a>06870     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((prop + <span class="stringliteral">&#39;[other]&#39;</span>) in data) {
<a name="l06871"></a>06871       <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = data[prop + <span class="stringliteral">&#39;[other]&#39;</span>];
<a name="l06872"></a>06872     }
<a name="l06873"></a>06873 
<a name="l06874"></a>06874     <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l06875"></a>06875   };
<a name="l06876"></a>06876 
<a name="l06877"></a>06877 
<a name="l06882"></a>06882   var reArgs = /\{\{\s*(.+?)\<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>*\}\}/;                       <span class="comment">// arguments</span>
<a name="l06883"></a>06883   var reIndex = /\{\[\s*([<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-zA-<a class="code" href="../../da/d7d/sylvester_8js.html#a8ec2f1f4b56b59046ed793f621ded341">Z</a>]+)\(([<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-zA-<a class="code" href="../../da/d7d/sylvester_8js.html#a8ec2f1f4b56b59046ed793f621ded341">Z</a>]+)\)\<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>*\]\}/; <span class="comment">// index macros</span>
<a name="l06884"></a>06884 
<a name="l06885"></a>06885   <span class="comment">// fetch an l10n object, warn if not found, apply `args&#39; if possible</span>
<a name="l06886"></a>06886   <span class="keyword">function</span> getL10nData(key, args) {
<a name="l06887"></a>06887     var data = gL10nData[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l06888"></a>06888     <span class="keywordflow">if</span> (!data) {
<a name="l06889"></a>06889       <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l06890"></a>06890     }
<a name="l06891"></a>06891 
<a name="l06898"></a>06898     var rv = {};
<a name="l06899"></a>06899     <span class="keywordflow">for</span> (var prop in data) {
<a name="l06900"></a>06900       var <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = data[prop];
<a name="l06901"></a>06901       str = substIndexes(str, args, key, prop);
<a name="l06902"></a>06902       str = substArguments(str, args, key);
<a name="l06903"></a>06903       rv[prop] = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l06904"></a>06904     }
<a name="l06905"></a>06905     <span class="keywordflow">return</span> rv;
<a name="l06906"></a>06906   }
<a name="l06907"></a>06907 
<a name="l06908"></a>06908   <span class="comment">// return an array of all {{arguments}} found in a string</span>
<a name="l06909"></a>06909   <span class="keyword">function</span> getL10nArgs(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l06910"></a>06910     var args = [];
<a name="l06911"></a>06911     var match = reArgs.exec(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l06912"></a>06912     <span class="keywordflow">while</span> (match &amp;&amp; match.length &gt;= 2) {
<a name="l06913"></a>06913       args.push({
<a name="l06914"></a>06914         <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: match[1], <span class="comment">// name of the argument</span>
<a name="l06915"></a>06915         subst: match[0] <span class="comment">// substring to replace (including braces and spaces)</span>
<a name="l06916"></a>06916       });
<a name="l06917"></a>06917       <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>.substr(match.index + match[0].length);
<a name="l06918"></a>06918       match = reArgs.exec(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l06919"></a>06919     }
<a name="l06920"></a>06920     <span class="keywordflow">return</span> <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>;
<a name="l06921"></a>06921   }
<a name="l06922"></a>06922 
<a name="l06923"></a>06923   <span class="comment">// return a sub-dictionary sufficient to translate a given fragment</span>
<a name="l06924"></a>06924   <span class="keyword">function</span> getSubDictionary(fragment) {
<a name="l06925"></a>06925     <span class="keywordflow">if</span> (!fragment) { <span class="comment">// by default, return a clone of the whole dictionary</span>
<a name="l06926"></a>06926       <span class="keywordflow">return</span> JSON.parse(JSON.stringify(gL10nData));
<a name="l06927"></a>06927     }
<a name="l06928"></a>06928 
<a name="l06929"></a>06929     var dict = {};
<a name="l06930"></a>06930     var elements = getTranslatableChildren(fragment);
<a name="l06931"></a>06931 
<a name="l06932"></a>06932     <span class="keyword">function</span> checkGlobalArguments(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l06933"></a>06933       var match = getL10nArgs(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l06934"></a>06934       <span class="keywordflow">for</span> (var i = 0; i &lt; match.length; i++) {
<a name="l06935"></a>06935         var <a class="code" href="../../d2/dbe/jsprf_8h.html#ae036856e415526e58e249638733f6752">arg</a> = match[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].name;
<a name="l06936"></a>06936         <span class="keywordflow">if</span> (arg in gL10nData) {
<a name="l06937"></a>06937           dict[<a class="code" href="../../d2/dbe/jsprf_8h.html#ae036856e415526e58e249638733f6752">arg</a>] = gL10nData[<a class="code" href="../../d2/dbe/jsprf_8h.html#ae036856e415526e58e249638733f6752">arg</a>];
<a name="l06938"></a>06938         }
<a name="l06939"></a>06939       }
<a name="l06940"></a>06940     }
<a name="l06941"></a>06941 
<a name="l06942"></a>06942     <span class="keywordflow">for</span> (var i = 0, <a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a> = elements.length; i &lt; <a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a>; i++) {
<a name="l06943"></a>06943       var <span class="keywordtype">id</span> = getL10nAttributes(elements[i]).id;
<a name="l06944"></a>06944       var data = gL10nData[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>];
<a name="l06945"></a>06945       <span class="keywordflow">if</span> (!<span class="keywordtype">id</span> || !data) {
<a name="l06946"></a>06946         <span class="keywordflow">continue</span>;
<a name="l06947"></a>06947       }
<a name="l06948"></a>06948 
<a name="l06949"></a>06949       dict[<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>] = <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>;
<a name="l06950"></a>06950       <span class="keywordflow">for</span> (var prop in data) {
<a name="l06951"></a>06951         var <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> = data[prop];
<a name="l06952"></a>06952         checkGlobalArguments(str);
<a name="l06953"></a>06953 
<a name="l06954"></a>06954         <span class="keywordflow">if</span> (reIndex.test(str)) { <span class="comment">// macro index</span>
<a name="l06955"></a>06955           <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a> &lt; kPluralForms.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>++) {
<a name="l06956"></a>06956             var key = <span class="keywordtype">id</span> + <span class="charliteral">&#39;[&#39;</span> + kPluralForms[<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>] + <span class="charliteral">&#39;]&#39;</span>;
<a name="l06957"></a>06957             <span class="keywordflow">if</span> (key in gL10nData) {
<a name="l06958"></a>06958               dict[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = gL10nData[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l06959"></a>06959               checkGlobalArguments(gL10nData[key]);
<a name="l06960"></a>06960             }
<a name="l06961"></a>06961           }
<a name="l06962"></a>06962         }
<a name="l06963"></a>06963       }
<a name="l06964"></a>06964     }
<a name="l06965"></a>06965 
<a name="l06966"></a>06966     <span class="keywordflow">return</span> dict;
<a name="l06967"></a>06967   }
<a name="l06968"></a>06968 
<a name="l06969"></a>06969   <span class="comment">// replace {[macros]} with their values</span>
<a name="l06970"></a>06970   <span class="keyword">function</span> substIndexes(str, args, key, prop) {
<a name="l06971"></a>06971     var reMatch = reIndex.exec(str);
<a name="l06972"></a>06972     <span class="keywordflow">if</span> (!reMatch || !reMatch.length) {
<a name="l06973"></a>06973       <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l06974"></a>06974     }
<a name="l06975"></a>06975 
<a name="l06976"></a>06976     <span class="comment">// an index/macro has been found</span>
<a name="l06977"></a>06977     <span class="comment">// Note: at the moment, only one parameter is supported</span>
<a name="l06978"></a>06978     var macroName = reMatch[1];
<a name="l06979"></a>06979     var paramName = reMatch[2];
<a name="l06980"></a>06980     var param;
<a name="l06981"></a>06981     <span class="keywordflow">if</span> (args &amp;&amp; paramName in args) {
<a name="l06982"></a>06982       param = args[paramName];
<a name="l06983"></a>06983     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (paramName in gL10nData) {
<a name="l06984"></a>06984       param = gL10nData[paramName];
<a name="l06985"></a>06985     }
<a name="l06986"></a>06986 
<a name="l06987"></a>06987     <span class="comment">// there&#39;s no macro parser yet: it has to be defined in gMacros</span>
<a name="l06988"></a>06988     <span class="keywordflow">if</span> (macroName in gMacros) {
<a name="l06989"></a>06989       var macro = gMacros[macroName];
<a name="l06990"></a>06990       str = macro(str, param, key, prop);
<a name="l06991"></a>06991     }
<a name="l06992"></a>06992     <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l06993"></a>06993   }
<a name="l06994"></a>06994 
<a name="l06995"></a>06995   <span class="comment">// replace {{arguments}} with their values</span>
<a name="l06996"></a>06996   <span class="keyword">function</span> substArguments(str, args, key) {
<a name="l06997"></a>06997     var match = getL10nArgs(str);
<a name="l06998"></a>06998     <span class="keywordflow">for</span> (var i = 0; i &lt; match.length; i++) {
<a name="l06999"></a>06999       var <a class="code" href="../../d3/d91/j3d_8js.html#aaceec2222caaba9acc8a26f948e34afa">sub</a>, <a class="code" href="../../d2/dbe/jsprf_8h.html#ae036856e415526e58e249638733f6752">arg</a> = match[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].name;
<a name="l07000"></a>07000       <span class="keywordflow">if</span> (args &amp;&amp; arg in args) {
<a name="l07001"></a>07001         sub = args[<a class="code" href="../../d2/dbe/jsprf_8h.html#ae036856e415526e58e249638733f6752">arg</a>];
<a name="l07002"></a>07002       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arg in gL10nData) {
<a name="l07003"></a>07003         sub = gL10nData[<a class="code" href="../../d2/dbe/jsprf_8h.html#ae036856e415526e58e249638733f6752">arg</a>][<span class="charliteral">&#39;_&#39;</span>];
<a name="l07004"></a>07004       } <span class="keywordflow">else</span> {
<a name="l07005"></a>07005         consoleLog(<span class="stringliteral">&#39;argument {{&#39;</span> + arg + <span class="stringliteral">&#39;}} for #&#39;</span> + key + <span class="stringliteral">&#39; is undefined.&#39;</span>);
<a name="l07006"></a>07006         <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l07007"></a>07007       }
<a name="l07008"></a>07008       str = str.replace(match[i].subst, sub);
<a name="l07009"></a>07009     }
<a name="l07010"></a>07010     <span class="keywordflow">return</span> <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l07011"></a>07011   }
<a name="l07012"></a>07012 
<a name="l07013"></a>07013   <span class="comment">// translate an HTML element</span>
<a name="l07014"></a>07014   <span class="comment">// -- returns true if the element could be translated, false otherwise</span>
<a name="l07015"></a>07015   <span class="keyword">function</span> translateElement(element) {
<a name="l07016"></a>07016     var l10n = getL10nAttributes(element);
<a name="l07017"></a>07017     <span class="keywordflow">if</span> (!l10n.id) {
<a name="l07018"></a>07018       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07019"></a>07019     }
<a name="l07020"></a>07020 
<a name="l07021"></a>07021     <span class="comment">// get the related l10n object</span>
<a name="l07022"></a>07022     var data = getL10nData(l10n.id, l10n.args);
<a name="l07023"></a>07023     <span class="keywordflow">if</span> (!data) {
<a name="l07024"></a>07024       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l07025"></a>07025     }
<a name="l07026"></a>07026 
<a name="l07027"></a>07027     <span class="comment">// translate element (TODO: security checks?)</span>
<a name="l07028"></a>07028     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a> in data) {
<a name="l07029"></a>07029       <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a> === <span class="charliteral">&#39;_&#39;</span>) {
<a name="l07030"></a>07030         setTextContent(element, data._);
<a name="l07031"></a>07031       } <span class="keywordflow">else</span> {
<a name="l07032"></a>07032         var idx = <a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>.lastIndexOf(<span class="charliteral">&#39;.&#39;</span>);
<a name="l07033"></a>07033         var nestedProp = <a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>.substr(0, idx);
<a name="l07034"></a>07034         <span class="keywordflow">if</span> (gNestedProps.indexOf(nestedProp) &gt; -1) {
<a name="l07035"></a>07035           element[nestedProp][<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>.substr(idx + 1)] = data[<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>];
<a name="l07036"></a>07036         } <span class="keywordflow">else</span> {
<a name="l07037"></a>07037           element[<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>] = data[<a class="code" href="../../da/d7d/sylvester_8js.html#ae8667dd07a5b15efad1c9ed229e131da">k</a>];
<a name="l07038"></a>07038         }
<a name="l07039"></a>07039       }
<a name="l07040"></a>07040     }
<a name="l07041"></a>07041     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l07042"></a>07042   }
<a name="l07043"></a>07043 
<a name="l07044"></a>07044   <span class="comment">// translate an array of HTML elements</span>
<a name="l07045"></a>07045   <span class="comment">// -- returns an array of elements that could not be translated</span>
<a name="l07046"></a>07046   <span class="keyword">function</span> translateElements(elements) {
<a name="l07047"></a>07047     var untranslated = [];
<a name="l07048"></a>07048     <span class="keywordflow">for</span> (var i = 0, <a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a> = elements.length; i &lt; <a class="code" href="../../d9/d6a/ns_color_8h.html#a0ad4b5fc255f59a8dace6aa74c5ca790">l</a>; i++) {
<a name="l07049"></a>07049       <span class="keywordflow">if</span> (!translateElement(elements[i])) {
<a name="l07050"></a>07050         untranslated.push(elements[i]);
<a name="l07051"></a>07051       }
<a name="l07052"></a>07052     }
<a name="l07053"></a>07053     <span class="keywordflow">return</span> untranslated;
<a name="l07054"></a>07054   }
<a name="l07055"></a>07055 
<a name="l07056"></a>07056   <span class="comment">// translate an HTML subtree</span>
<a name="l07057"></a>07057   <span class="comment">// -- returns an array of elements that could not be translated</span>
<a name="l07058"></a>07058   <span class="keyword">function</span> translateFragment(element) {
<a name="l07059"></a>07059     element = element || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.documentElement;
<a name="l07060"></a>07060     var untranslated = translateElements(getTranslatableChildren(element));
<a name="l07061"></a>07061     <span class="keywordflow">if</span> (!translateElement(element)) {
<a name="l07062"></a>07062       untranslated.push(element);
<a name="l07063"></a>07063     }
<a name="l07064"></a>07064     <span class="keywordflow">return</span> untranslated;
<a name="l07065"></a>07065   }
<a name="l07066"></a>07066 
<a name="l07067"></a>07067   <span class="comment">// localize an element as soon as mozL10n is ready</span>
<a name="l07068"></a>07068   <span class="keyword">function</span> localizeElement(element, <span class="keywordtype">id</span>, args) {
<a name="l07069"></a>07069     <span class="keywordflow">if</span> (!element) {
<a name="l07070"></a>07070       <span class="keywordflow">return</span>;
<a name="l07071"></a>07071     }
<a name="l07072"></a>07072 
<a name="l07073"></a>07073     <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>) {
<a name="l07074"></a>07074       element.removeAttribute(<span class="stringliteral">&#39;data-l10n-id&#39;</span>);
<a name="l07075"></a>07075       element.removeAttribute(<span class="stringliteral">&#39;data-l10n-args&#39;</span>);
<a name="l07076"></a>07076       setTextContent(element, <span class="stringliteral">&#39;&#39;</span>);
<a name="l07077"></a>07077       <span class="keywordflow">return</span>;
<a name="l07078"></a>07078     }
<a name="l07079"></a>07079 
<a name="l07080"></a>07080     <span class="comment">// set the data-l10n-[id|args] attributes</span>
<a name="l07081"></a>07081     element.setAttribute(<span class="stringliteral">&#39;data-l10n-id&#39;</span>, <span class="keywordtype">id</span>);
<a name="l07082"></a>07082     <span class="keywordflow">if</span> (args &amp;&amp; <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> args === <span class="stringliteral">&#39;object&#39;</span>) {
<a name="l07083"></a>07083       element.setAttribute(<span class="stringliteral">&#39;data-l10n-args&#39;</span>, JSON.stringify(args));
<a name="l07084"></a>07084     } <span class="keywordflow">else</span> {
<a name="l07085"></a>07085       element.removeAttribute(<span class="stringliteral">&#39;data-l10n-args&#39;</span>);
<a name="l07086"></a>07086     }
<a name="l07087"></a>07087 
<a name="l07088"></a>07088     <span class="comment">// if l10n resources are ready, translate now;</span>
<a name="l07089"></a>07089     <span class="comment">// if not, the element will be translated along with the document anyway.</span>
<a name="l07090"></a>07090     <span class="keywordflow">if</span> (gReadyState === <span class="stringliteral">&#39;complete&#39;</span>) {
<a name="l07091"></a>07091       translateElement(element);
<a name="l07092"></a>07092     }
<a name="l07093"></a>07093   }
<a name="l07094"></a>07094 
<a name="l07095"></a>07095 
<a name="l07103"></a>07103   <span class="comment">// load the default locale on startup</span>
<a name="l07104"></a>07104   <span class="keyword">function</span> l10nStartup() {
<a name="l07105"></a>07105     gDefaultLocale = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.documentElement.lang || gDefaultLocale;
<a name="l07106"></a>07106     gReadyState = <span class="stringliteral">&#39;interactive&#39;</span>;
<a name="l07107"></a>07107     consoleLog(<span class="stringliteral">&#39;loading [&#39;</span> + <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.language + <span class="stringliteral">&#39;] resources, &#39;</span> +
<a name="l07108"></a>07108         (gAsyncResourceLoading ? <span class="stringliteral">&#39;asynchronously.&#39;</span> : <span class="stringliteral">&#39;synchronously.&#39;</span>));
<a name="l07109"></a>07109 
<a name="l07110"></a>07110     <span class="comment">// load the default locale and translate the document if required</span>
<a name="l07111"></a>07111     var translationRequired =
<a name="l07112"></a>07112       (<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.documentElement.lang !== <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.language);
<a name="l07113"></a>07113     loadLocale(<a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.language, translationRequired);
<a name="l07114"></a>07114   }
<a name="l07115"></a>07115 
<a name="l07116"></a>07116   <span class="comment">// the B2G build system doesn&#39;t expose any `document&#39;...</span>
<a name="l07117"></a>07117   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>) !== <span class="stringliteral">&#39;undefined&#39;</span>) {
<a name="l07118"></a>07118     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.readyState === <span class="stringliteral">&#39;complete&#39;</span> ||
<a name="l07119"></a>07119       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.readyState === <span class="stringliteral">&#39;interactive&#39;</span>) {
<a name="l07120"></a>07120       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(l10nStartup);
<a name="l07121"></a>07121     } <span class="keywordflow">else</span> {
<a name="l07122"></a>07122       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.addEventListener(<span class="stringliteral">&#39;DOMContentLoaded&#39;</span>, l10nStartup);
<a name="l07123"></a>07123     }
<a name="l07124"></a>07124   }
<a name="l07125"></a>07125 
<a name="l07126"></a>07126   <span class="comment">// load the appropriate locale if the language setting has changed</span>
<a name="l07127"></a>07127   <span class="keywordflow">if</span> (<span class="stringliteral">&#39;mozSettings&#39;</span> in <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a> &amp;&amp; <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozSettings) {
<a name="l07128"></a>07128     <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozSettings.addObserver(<span class="stringliteral">&#39;language.current&#39;</span>, <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l07129"></a>07129       loadLocale(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.settingValue, <span class="keyword">true</span>);
<a name="l07130"></a>07130     });
<a name="l07131"></a>07131   }
<a name="l07132"></a>07132 
<a name="l07133"></a>07133   <span class="comment">// public API</span>
<a name="l07134"></a>07134   <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n = {
<a name="l07135"></a>07135     <span class="comment">// get a localized string</span>
<a name="l07136"></a>07136     <span class="keyword">get</span>: <span class="keyword">function</span> l10n_get(key, args) {
<a name="l07137"></a>07137       var data = getL10nData(key, args);
<a name="l07138"></a>07138       <span class="keywordflow">if</span> (!data) {
<a name="l07139"></a>07139         consoleWarn(<span class="charliteral">&#39;#&#39;</span> + key + <span class="stringliteral">&#39; is undefined.&#39;</span>);
<a name="l07140"></a>07140         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l07141"></a>07141       } <span class="keywordflow">else</span> {
<a name="l07142"></a>07142         <span class="keywordflow">return</span> data._;
<a name="l07143"></a>07143       }
<a name="l07144"></a>07144     },
<a name="l07145"></a>07145 
<a name="l07146"></a>07146     <span class="comment">// get|set the document language and direction</span>
<a name="l07147"></a>07147     <span class="keyword">get</span> <a class="code" href="../../d6/d45/prerror_8h.html#a5b8860d15e47932f3ec6f41c96dcb857">language</a>() {
<a name="l07148"></a>07148       <span class="keywordflow">return</span> {
<a name="l07149"></a>07149         <span class="comment">// get|set the document language (ISO-639-1)</span>
<a name="l07150"></a>07150         <span class="keyword">get</span> <a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>() { <span class="keywordflow">return</span> gLanguage; },
<a name="l07151"></a>07151         <span class="keyword">set</span> <a class="code" href="../../d3/d4b/lockscreen_8js.html#a3bc1c2f8ec4ed34fc21f9f10eacbfa93">code</a>(lang) { loadLocale(lang, <span class="keyword">true</span>); },
<a name="l07152"></a>07152 
<a name="l07153"></a>07153         <span class="comment">// get the direction (ltr|rtl) of the current language</span>
<a name="l07154"></a>07154         <span class="keyword">get</span> <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>() {
<a name="l07155"></a>07155           <span class="comment">// http://www.w3.org/International/questions/qa-scripts</span>
<a name="l07156"></a>07156           <span class="comment">// Arabic, Hebrew, Farsi, Pashto, Urdu</span>
<a name="l07157"></a>07157           var rtlList = [<span class="stringliteral">&#39;ar&#39;</span>, <span class="stringliteral">&#39;he&#39;</span>, <span class="stringliteral">&#39;fa&#39;</span>, <span class="stringliteral">&#39;ps&#39;</span>, <span class="stringliteral">&#39;ur&#39;</span>];
<a name="l07158"></a>07158           <span class="keywordflow">return</span> (rtlList.indexOf(gLanguage) &gt;= 0) ? <span class="stringliteral">&#39;rtl&#39;</span> : <span class="stringliteral">&#39;ltr&#39;</span>;
<a name="l07159"></a>07159         }
<a name="l07160"></a>07160       };
<a name="l07161"></a>07161     },
<a name="l07162"></a>07162 
<a name="l07163"></a>07163     <span class="comment">// translate an element or document fragment</span>
<a name="l07164"></a>07164     <a class="code" href="../../d3/d91/j3d_8js.html#aa896eca296d874b4719e6210a120ebe5">translate</a>: translateFragment,
<a name="l07165"></a>07165 
<a name="l07166"></a>07166     <span class="comment">// localize an element (= set its data-l10n-* attributes and translate it)</span>
<a name="l07167"></a>07167     <a class="code" href="../../d1/de1/apps_2settings_2js_2utils_8js.html#a32930d17cd0e3a8078d1a8e5207cfc4d">localize</a>: localizeElement,
<a name="l07168"></a>07168 
<a name="l07169"></a>07169     <span class="comment">// get (a part of) the dictionary for the current locale</span>
<a name="l07170"></a>07170     getDictionary: getSubDictionary,
<a name="l07171"></a>07171 
<a name="l07172"></a>07172     <span class="comment">// this can be used to prevent race conditions</span>
<a name="l07173"></a>07173     <span class="keyword">get</span> readyState() { <span class="keywordflow">return</span> gReadyState; },
<a name="l07174"></a>07174     <a class="code" href="../../d5/dd7/apps_2communications_2ftu_2js_2app_8js.html#a7d18142e8b0bc568b1692cd28ba1d8a7">ready</a>: <span class="keyword">function</span> l10n_ready(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l07175"></a>07175       <span class="keywordflow">if</span> (!<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l07176"></a>07176         <span class="keywordflow">return</span>;
<a name="l07177"></a>07177       }
<a name="l07178"></a>07178       <span class="keywordflow">if</span> (gReadyState == <span class="stringliteral">&#39;complete&#39;</span>) {
<a name="l07179"></a>07179         <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l07180"></a>07180       } <span class="keywordflow">else</span> {
<a name="l07181"></a>07181         <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;localized&#39;</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l07182"></a>07182       }
<a name="l07183"></a>07183     }
<a name="l07184"></a>07184   };
<a name="l07185"></a>07185 
<a name="l07186"></a>07186   consoleLog(<span class="stringliteral">&#39;library loaded.&#39;</span>);
<a name="l07187"></a>07187 })(<span class="keyword">this</span>);
<a name="l07188"></a>07188 
<a name="l07189"></a>07189 
<a name="l07190"></a>07190 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&quot;l10nbase&quot;</span>, <span class="keyword">function</span>(){});
<a name="l07191"></a>07191 
<a name="l07192"></a>07192 <span class="comment">/* -*- Mode: js; js-indent-level: 2; indent-tabs-mode: nil -*- */</span>
<a name="l07193"></a>07193 <span class="comment">/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */</span>
<a name="l07194"></a>07194 
<a name="l07195"></a>07195 
<a name="l07196"></a>07196 
<a name="l07215"></a><a class="code" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html#abcbd138ca956bcc812dbabd5df8945f8">07215</a> <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.DateTimeFormat = <span class="keyword">function</span>(locales, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>) {
<a name="l07216"></a>07216   var <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a> = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get;
<a name="l07217"></a>07217 
<a name="l07218"></a>07218   <span class="comment">// https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Date/toLocaleFormat</span>
<a name="l07219"></a>07219   <span class="keyword">function</span> localeFormat(d, <a class="code" href="../../d5/dca/reply__imap__email__test_8js.html#a63214d8f1727e71292b73e09dc39644f">format</a>) {
<a name="l07220"></a>07220     var tokens = <a class="code" href="../../d5/dca/reply__imap__email__test_8js.html#a63214d8f1727e71292b73e09dc39644f">format</a>.match(/(%E.|%O.|%.)/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>);
<a name="l07221"></a>07221 
<a name="l07222"></a>07222     <span class="keywordflow">for</span> (var i = 0; tokens &amp;&amp; i &lt; tokens.length; i++) {
<a name="l07223"></a>07223       var <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l07224"></a>07224 
<a name="l07225"></a>07225       <span class="comment">// http://pubs.opengroup.org/onlinepubs/007908799/xsh/strftime.html</span>
<a name="l07226"></a>07226       <span class="keywordflow">switch</span> (tokens[i]) {
<a name="l07227"></a>07227         <span class="comment">// localized day/month names</span>
<a name="l07228"></a>07228         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%a&#39;</span>:
<a name="l07229"></a>07229           value = <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;weekday-&#39;</span> + d.getDay() + <span class="stringliteral">&#39;-short&#39;</span>);
<a name="l07230"></a>07230           <span class="keywordflow">break</span>;
<a name="l07231"></a>07231         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%A&#39;</span>:
<a name="l07232"></a>07232           value = <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;weekday-&#39;</span> + d.getDay() + <span class="stringliteral">&#39;-long&#39;</span>);
<a name="l07233"></a>07233           <span class="keywordflow">break</span>;
<a name="l07234"></a>07234         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%b&#39;</span>:
<a name="l07235"></a>07235         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%h&#39;</span>:
<a name="l07236"></a>07236           value = <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;month-&#39;</span> + d.getMonth() + <span class="stringliteral">&#39;-short&#39;</span>);
<a name="l07237"></a>07237           <span class="keywordflow">break</span>;
<a name="l07238"></a>07238         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%B&#39;</span>:
<a name="l07239"></a>07239           value = <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;month-&#39;</span> + d.getMonth() + <span class="stringliteral">&#39;-long&#39;</span>);
<a name="l07240"></a>07240           <span class="keywordflow">break</span>;
<a name="l07241"></a>07241         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%Eb&#39;</span>:
<a name="l07242"></a>07242           value = <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;month-&#39;</span> + d.getMonth() + <span class="stringliteral">&#39;-genitive&#39;</span>);
<a name="l07243"></a>07243           <span class="keywordflow">break</span>;
<a name="l07244"></a>07244 
<a name="l07245"></a>07245         <span class="comment">// like %H, but in 12-hour format and without any leading zero</span>
<a name="l07246"></a>07246         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%I&#39;</span>:
<a name="l07247"></a>07247           value = d.getHours() % 12 || 12;
<a name="l07248"></a>07248           <span class="keywordflow">break</span>;
<a name="l07249"></a>07249 
<a name="l07250"></a>07250         <span class="comment">// like %d, without any leading zero</span>
<a name="l07251"></a>07251         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%e&#39;</span>:
<a name="l07252"></a>07252           value = d.getDate();
<a name="l07253"></a>07253           <span class="keywordflow">break</span>;
<a name="l07254"></a>07254 
<a name="l07255"></a>07255         <span class="comment">// like %d, without any leading zero</span>
<a name="l07256"></a>07256         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%p&#39;</span>:
<a name="l07257"></a>07257           value = d.getHours() &lt; 12 ? <span class="stringliteral">&#39;AM&#39;</span> : <span class="stringliteral">&#39;PM&#39;</span>;
<a name="l07258"></a>07258           <span class="keywordflow">break</span>;
<a name="l07259"></a>07259 
<a name="l07260"></a>07260         <span class="comment">// localized date/time strings</span>
<a name="l07261"></a>07261         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%c&#39;</span>:
<a name="l07262"></a>07262         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%x&#39;</span>:
<a name="l07263"></a>07263         <span class="keywordflow">case</span> <span class="stringliteral">&#39;%X&#39;</span>:
<a name="l07264"></a>07264           <span class="comment">// ensure the localized format string doesn&#39;t contain any %c|%x|%X</span>
<a name="l07265"></a>07265           var tmp = <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;dateTimeFormat_&#39;</span> + tokens[i]);
<a name="l07266"></a>07266           <span class="keywordflow">if</span> (tmp &amp;&amp; !(/(%<a class="code" href="../../d2/d7d/jsapi_8h.html#a348d5281ca0f01adebb262bee8baf788">c</a>|%x|%<a class="code" href="../../da/d7d/sylvester_8js.html#af2f144226eef01a80d1ad95fc2c088d8">X</a>)/).<a class="code" href="../../db/db1/namespace_j_s_1_1detail.html#a4fe50fa16c059b33ed172c344bb3fc74">test</a>(tmp)) {
<a name="l07267"></a>07267             value = localeFormat(d, tmp);
<a name="l07268"></a>07268           }
<a name="l07269"></a>07269           <span class="keywordflow">break</span>;
<a name="l07270"></a>07270 
<a name="l07271"></a>07271         <span class="comment">// other tokens don&#39;t require any localization</span>
<a name="l07272"></a>07272       }
<a name="l07273"></a>07273 
<a name="l07274"></a>07274       <a class="code" href="../../d5/dca/reply__imap__email__test_8js.html#a63214d8f1727e71292b73e09dc39644f">format</a> = <a class="code" href="../../d5/dca/reply__imap__email__test_8js.html#a63214d8f1727e71292b73e09dc39644f">format</a>.replace(tokens[i], value || d.toLocaleFormat(tokens[i]));
<a name="l07275"></a>07275     }
<a name="l07276"></a>07276 
<a name="l07277"></a>07277     <span class="keywordflow">return</span> <a class="code" href="../../d5/dca/reply__imap__email__test_8js.html#a63214d8f1727e71292b73e09dc39644f">format</a>;
<a name="l07278"></a>07278   }
<a name="l07279"></a>07279 
<a name="l07283"></a>07283   <span class="keyword">function</span> relativeParts(seconds) {
<a name="l07284"></a>07284     seconds = Math.abs(seconds);
<a name="l07285"></a>07285     var descriptors = {};
<a name="l07286"></a>07286     var <a class="code" href="../../d1/d04/app__install__manager_8js.html#af5370324e4420ac0d4513ad7056e050c">units</a> = [
<a name="l07287"></a>07287       <span class="stringliteral">&#39;years&#39;</span>, 86400 * 365,
<a name="l07288"></a>07288       <span class="stringliteral">&#39;months&#39;</span>, 86400 * 30,
<a name="l07289"></a>07289       <span class="stringliteral">&#39;weeks&#39;</span>, 86400 * 7,
<a name="l07290"></a>07290       <span class="stringliteral">&#39;days&#39;</span>, 86400,
<a name="l07291"></a>07291       <span class="stringliteral">&#39;hours&#39;</span>, 3600,
<a name="l07292"></a>07292       <span class="stringliteral">&#39;minutes&#39;</span>, 60
<a name="l07293"></a>07293     ];
<a name="l07294"></a>07294 
<a name="l07295"></a>07295     <span class="keywordflow">if</span> (seconds &lt; 60) {
<a name="l07296"></a>07296       <span class="keywordflow">return</span> {
<a name="l07297"></a>07297         minutes: Math.round(seconds / 60)
<a name="l07298"></a>07298       };
<a name="l07299"></a>07299     }
<a name="l07300"></a>07300 
<a name="l07301"></a>07301     <span class="keywordflow">for</span> (var i = 0, uLen = units.length; i &lt; uLen; i += 2) {
<a name="l07302"></a>07302       var <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> = units[i + 1];
<a name="l07303"></a>07303       <span class="keywordflow">if</span> (seconds &gt;= value) {
<a name="l07304"></a>07304         descriptors[units[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]] = Math.floor(seconds / value);
<a name="l07305"></a>07305         seconds -= descriptors[units[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]] * <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
<a name="l07306"></a>07306       }
<a name="l07307"></a>07307     }
<a name="l07308"></a>07308     <span class="keywordflow">return</span> descriptors;
<a name="l07309"></a>07309   }
<a name="l07310"></a>07310 
<a name="l07318"></a>07318   <span class="keyword">function</span> prettyDate(<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>, useCompactFormat, maxDiff) {
<a name="l07319"></a>07319     maxDiff = maxDiff || 86400 * 10; <span class="comment">// default = 10 days</span>
<a name="l07320"></a>07320 
<a name="l07321"></a>07321     <span class="keywordflow">switch</span> (<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>.constructor) {
<a name="l07322"></a>07322       <span class="keywordflow">case</span> String: <span class="comment">// timestamp</span>
<a name="l07323"></a>07323         <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a> = parseInt(<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>);
<a name="l07324"></a>07324         <span class="keywordflow">break</span>;
<a name="l07325"></a>07325       <span class="keywordflow">case</span> Date:
<a name="l07326"></a>07326         <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a> = <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>.getTime();
<a name="l07327"></a>07327         <span class="keywordflow">break</span>;
<a name="l07328"></a>07328     }
<a name="l07329"></a>07329 
<a name="l07330"></a>07330     var secDiff = (Date.now() - <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>) / 1000;
<a name="l07331"></a>07331     <span class="keywordflow">if</span> (isNaN(secDiff)) {
<a name="l07332"></a>07332       <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;incorrectDate&#39;</span>);
<a name="l07333"></a>07333     }
<a name="l07334"></a>07334 
<a name="l07335"></a>07335     <span class="keywordflow">if</span> (secDiff &gt; maxDiff) {
<a name="l07336"></a>07336       <span class="keywordflow">return</span> localeFormat(<span class="keyword">new</span> Date(<a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>), <span class="stringliteral">&#39;%x&#39;</span>);
<a name="l07337"></a>07337     }
<a name="l07338"></a>07338 
<a name="l07339"></a>07339     var f = useCompactFormat ? <span class="stringliteral">&#39;-short&#39;</span> : <span class="stringliteral">&#39;-long&#39;</span>;
<a name="l07340"></a>07340     var parts = relativeParts(secDiff);
<a name="l07341"></a>07341 
<a name="l07342"></a>07342     var affix = secDiff &gt;= 0 ? <span class="stringliteral">&#39;-ago&#39;</span> : <span class="stringliteral">&#39;-until&#39;</span>;
<a name="l07343"></a>07343     <span class="keywordflow">for</span> (var i in parts) {
<a name="l07344"></a>07344       <span class="keywordflow">return</span> <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(i + affix + f, { <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>: parts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]});
<a name="l07345"></a>07345     }
<a name="l07346"></a>07346   }
<a name="l07347"></a>07347 
<a name="l07348"></a>07348   <span class="comment">// API</span>
<a name="l07349"></a>07349   <span class="keywordflow">return</span> {
<a name="l07350"></a>07350     localeDateString: <span class="keyword">function</span> localeDateString(d) {
<a name="l07351"></a>07351       <span class="keywordflow">return</span> localeFormat(d, <span class="stringliteral">&#39;%x&#39;</span>);
<a name="l07352"></a>07352     },
<a name="l07353"></a>07353     localeTimeString: <span class="keyword">function</span> localeTimeString(d) {
<a name="l07354"></a>07354       <span class="keywordflow">return</span> localeFormat(d, <span class="stringliteral">&#39;%X&#39;</span>);
<a name="l07355"></a>07355     },
<a name="l07356"></a>07356     localeString: <span class="keyword">function</span> localeString(d) {
<a name="l07357"></a>07357       <span class="keywordflow">return</span> localeFormat(d, <span class="stringliteral">&#39;%c&#39;</span>);
<a name="l07358"></a>07358     },
<a name="l07359"></a>07359     localeFormat: localeFormat,
<a name="l07360"></a>07360     fromNow: prettyDate,
<a name="l07361"></a>07361     relativeParts: relativeParts
<a name="l07362"></a>07362   };
<a name="l07363"></a>07363 };
<a name="l07364"></a>07364 
<a name="l07365"></a>07365 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&quot;l10ndate&quot;</span>, <span class="keyword">function</span>(){});
<a name="l07366"></a>07366 
<a name="l07367"></a>07367 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;text&#39;</span>,{
<a name="l07368"></a>07368   <a class="code" href="../../db/d6b/make__gaia__shared_8js.html#ac5aa547163f784b68be607a47eb170b1">load</a>: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a>, <a class="code" href="../../d8/deb/share_8js.html#ae63fb598d93a4bb590d74a27b9398c71">onload</a>, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>) {
<a name="l07369"></a>07369     var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> = req.toUrl(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>),
<a name="l07370"></a>07370         xhr = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a2619068a621e6b22d7995161b2cea021">XMLHttpRequest</a>();
<a name="l07371"></a>07371 
<a name="l07372"></a>07372     xhr.open(<span class="stringliteral">&#39;GET&#39;</span>, url, <span class="keyword">true</span>);
<a name="l07373"></a>07373     xhr.onreadystatechange = <span class="keyword">function</span>(evt) {
<a name="l07374"></a>07374       var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a>, err;
<a name="l07375"></a>07375       <span class="keywordflow">if</span> (xhr.readyState === 4) {
<a name="l07376"></a>07376         status = xhr.status;
<a name="l07377"></a>07377         <span class="keywordflow">if</span> (status &gt; 399 &amp;&amp; status &lt; 600) {
<a name="l07378"></a>07378           <span class="comment">//An http 4xx or 5xx error. Signal an error.</span>
<a name="l07379"></a>07379           err = <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(url + <span class="stringliteral">&#39; HTTP status: &#39;</span> + status);
<a name="l07380"></a>07380           err.xhr = <a class="code" href="../../da/d84/openvideo_8js.html#a329f2008ea05312f90696aa4401250ed">xhr</a>;
<a name="l07381"></a>07381           onload.error(err);
<a name="l07382"></a>07382         } <span class="keywordflow">else</span> {
<a name="l07383"></a>07383           <a class="code" href="../../d8/deb/share_8js.html#ae63fb598d93a4bb590d74a27b9398c71">onload</a>(xhr.responseText);
<a name="l07384"></a>07384         }
<a name="l07385"></a>07385       }
<a name="l07386"></a>07386     };
<a name="l07387"></a>07387     xhr.responseType = <span class="stringliteral">&#39;text&#39;</span>;
<a name="l07388"></a>07388     xhr.send(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l07389"></a>07389   }
<a name="l07390"></a>07390 });
<a name="l07391"></a>07391 
<a name="l07392"></a>07392 
<a name="l07393"></a>07393 <span class="comment">/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- /</span>
<a name="l07394"></a>07394 <span class="comment">/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */</span>
<a name="l07395"></a>07395 
<a name="l07396"></a>07396 
<a name="l07397"></a>07397 
<a name="l07445"></a>07445 var <a class="code" href="../../d8/df0/frames_8js.html#a050c35bd1ae66a249cd6c3554661e24a">GestureDetector</a> = (<span class="keyword">function</span>() {
<a name="l07446"></a>07446 
<a name="l07447"></a>07447   <span class="comment">//</span>
<a name="l07448"></a>07448   <span class="comment">// Constructor</span>
<a name="l07449"></a>07449   <span class="comment">//</span>
<a name="l07450"></a>07450   <span class="keyword">function</span> GD(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, options) {
<a name="l07451"></a>07451     this.element = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>;
<a name="l07452"></a>07452     this.options = options || {};
<a name="l07453"></a>07453     this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> = initialState;
<a name="l07454"></a>07454     this.timers = {};
<a name="l07455"></a>07455     this.listeningForMouseEvents = <span class="keyword">true</span>;
<a name="l07456"></a>07456   }
<a name="l07457"></a>07457 
<a name="l07458"></a>07458   <span class="comment">//</span>
<a name="l07459"></a>07459   <span class="comment">// Public methods</span>
<a name="l07460"></a>07460   <span class="comment">//</span>
<a name="l07461"></a>07461 
<a name="l07462"></a>07462   GD.prototype.startDetecting = <span class="keyword">function</span>() {
<a name="l07463"></a>07463     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l07464"></a>07464     eventtypes.forEach(<span class="keyword">function</span>(t) {
<a name="l07465"></a>07465       <span class="keyword">self</span>.element.addEventListener(t, <span class="keyword">self</span>);
<a name="l07466"></a>07466     });
<a name="l07467"></a>07467   };
<a name="l07468"></a>07468 
<a name="l07469"></a>07469   GD.prototype.stopDetecting = <span class="keyword">function</span>() {
<a name="l07470"></a>07470     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l07471"></a>07471     eventtypes.forEach(<span class="keyword">function</span>(t) {
<a name="l07472"></a>07472       <span class="keyword">self</span>.element.removeEventListener(t, <span class="keyword">self</span>);
<a name="l07473"></a>07473     });
<a name="l07474"></a>07474   };
<a name="l07475"></a>07475 
<a name="l07476"></a>07476   <span class="comment">//</span>
<a name="l07477"></a>07477   <span class="comment">// Internal methods</span>
<a name="l07478"></a>07478   <span class="comment">//</span>
<a name="l07479"></a>07479 
<a name="l07480"></a>07480   GD.prototype.handleEvent = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l07481"></a>07481     var <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a> = this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>[<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.type];
<a name="l07482"></a>07482     <span class="keywordflow">if</span> (!handler) <span class="keywordflow">return</span>;
<a name="l07483"></a>07483 
<a name="l07484"></a>07484     <span class="comment">// If this is a touch event handle each changed touch separately</span>
<a name="l07485"></a>07485     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.changedTouches) {
<a name="l07486"></a>07486       <span class="comment">// If we ever receive a touch event, then we know we are on a</span>
<a name="l07487"></a>07487       <span class="comment">// touch device and we stop listening for mouse events. If we</span>
<a name="l07488"></a>07488       <span class="comment">// don&#39;t do that, then the touchstart touchend mousedown mouseup</span>
<a name="l07489"></a>07489       <span class="comment">// generated by a single tap gesture will cause us to output</span>
<a name="l07490"></a>07490       <span class="comment">// tap tap dbltap, which is wrong</span>
<a name="l07491"></a>07491       <span class="keywordflow">if</span> (this.listeningForMouseEvents) {
<a name="l07492"></a>07492         this.listeningForMouseEvents = <span class="keyword">false</span>;
<a name="l07493"></a>07493         this.element.removeEventListener(<span class="stringliteral">&#39;mousedown&#39;</span>, <span class="keyword">this</span>);
<a name="l07494"></a>07494       }
<a name="l07495"></a>07495 
<a name="l07496"></a>07496       <span class="comment">// XXX https://bugzilla.mozilla.org/show_bug.cgi?id=785554</span>
<a name="l07497"></a>07497       <span class="comment">// causes touchend events to list all touches as changed, so</span>
<a name="l07498"></a>07498       <span class="comment">// warn if we see that bug</span>
<a name="l07499"></a>07499       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.type === <span class="stringliteral">&#39;touchend&#39;</span> &amp;&amp; <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.changedTouches.length &gt; 1) {
<a name="l07500"></a>07500         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;gesture_detector.js: spurious extra changed touch on &#39;</span> +
<a name="l07501"></a>07501                      <span class="stringliteral">&#39;touchend. See &#39;</span> +
<a name="l07502"></a>07502                      <span class="stringliteral">&#39;https://bugzilla.mozilla.org/show_bug.cgi?id=785554&#39;</span>);
<a name="l07503"></a>07503       }
<a name="l07504"></a>07504 
<a name="l07505"></a>07505       <span class="keywordflow">for</span> (var i = 0; i &lt; <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.changedTouches.length; i++) {
<a name="l07506"></a>07506         <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a>(<span class="keyword">this</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.changedTouches[i]);
<a name="l07507"></a>07507         <span class="comment">// The first changed touch might have changed the state of the</span>
<a name="l07508"></a>07508         <span class="comment">// FSM. We need this line to workaround the bug 785554, but it is</span>
<a name="l07509"></a>07509         <span class="comment">// probably the right thing to have here, even once that bug is fixed.</span>
<a name="l07510"></a>07510         handler = this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>[<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.type];
<a name="l07511"></a>07511       }
<a name="l07512"></a>07512     }
<a name="l07513"></a>07513     <span class="keywordflow">else</span> {    <span class="comment">// Otherwise, just dispatch the event to the handler</span>
<a name="l07514"></a>07514       <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a>(<span class="keyword">this</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
<a name="l07515"></a>07515     }
<a name="l07516"></a>07516   };
<a name="l07517"></a>07517 
<a name="l07518"></a>07518   GD.prototype.startTimer = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>) {
<a name="l07519"></a>07519     this.clearTimer(type);
<a name="l07520"></a>07520     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l07521"></a>07521     this.timers[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(<span class="keyword">function</span>() {
<a name="l07522"></a>07522       <span class="keyword">self</span>.timers[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07523"></a>07523       var handler = <span class="keyword">self</span>.state[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l07524"></a>07524       <span class="keywordflow">if</span> (handler)
<a name="l07525"></a>07525         <a class="code" href="../../de/deb/jsdbgapi_8h.html#a309e0bc04bd5e2de367147b08241aa6b">handler</a>(<span class="keyword">self</span>, type);
<a name="l07526"></a>07526     }, <a class="code" href="../../d6/da5/certt_8h.html#a5e84b1bdd0770310d2a7fd739ab6dbee">time</a>);
<a name="l07527"></a>07527   };
<a name="l07528"></a>07528 
<a name="l07529"></a>07529   GD.prototype.clearTimer = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l07530"></a>07530     <span class="keywordflow">if</span> (this.timers[type]) {
<a name="l07531"></a>07531       <a class="code" href="../../da/da1/timers_8js.html#ab37ff0db33a3bf80b0163adc40a58424">clearTimeout</a>(this.timers[type]);
<a name="l07532"></a>07532       this.timers[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07533"></a>07533     }
<a name="l07534"></a>07534   };
<a name="l07535"></a>07535 
<a name="l07536"></a>07536   <span class="comment">// Switch to a new FSM state, and call the init() function of that</span>
<a name="l07537"></a>07537   <span class="comment">// state, if it has one.  The event and touch arguments are optional</span>
<a name="l07538"></a>07538   <span class="comment">// and are just passed through to the state init function.</span>
<a name="l07539"></a>07539   GD.prototype.switchTo = <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>, touch) {
<a name="l07540"></a>07540     this.<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a> = <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>;
<a name="l07541"></a>07541     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.init)
<a name="l07542"></a>07542       <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>.init(<span class="keyword">this</span>, event, touch);
<a name="l07543"></a>07543   };
<a name="l07544"></a>07544 
<a name="l07545"></a>07545   GD.prototype.emitEvent = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, detail) {
<a name="l07546"></a>07546     <span class="keywordflow">if</span> (!this.<a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a>) {
<a name="l07547"></a>07547       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Attempt to emit event with no target&#39;</span>);
<a name="l07548"></a>07548       <span class="keywordflow">return</span>;
<a name="l07549"></a>07549     }
<a name="l07550"></a>07550 
<a name="l07551"></a>07551     var <span class="keyword">event</span> = this.element.ownerDocument.createEvent(<span class="stringliteral">&#39;CustomEvent&#39;</span>);
<a name="l07552"></a>07552     <span class="keyword">event</span>.initCustomEvent(type, <span class="keyword">true</span>, <span class="keyword">true</span>, detail);
<a name="l07553"></a>07553     this.<a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a>.dispatchEvent(event);
<a name="l07554"></a>07554   };
<a name="l07555"></a>07555 
<a name="l07556"></a>07556   <span class="comment">//</span>
<a name="l07557"></a>07557   <span class="comment">// Tuneable parameters</span>
<a name="l07558"></a>07558   <span class="comment">//</span>
<a name="l07559"></a>07559   GD.HOLD_INTERVAL = 1000;     <span class="comment">// Hold events after 1000 ms</span>
<a name="l07560"></a>07560   GD.PAN_THRESHOLD = 20;       <span class="comment">// 20 pixels movement before touch panning</span>
<a name="l07561"></a>07561   GD.MOUSE_PAN_THRESHOLD = 15; <span class="comment">// Mice are more precise, so smaller threshold</span>
<a name="l07562"></a>07562   GD.DOUBLE_TAP_DISTANCE = 50;
<a name="l07563"></a>07563   GD.DOUBLE_TAP_TIME = 500;
<a name="l07564"></a>07564   GD.VELOCITY_SMOOTHING = .5;
<a name="l07565"></a>07565 
<a name="l07566"></a>07566   <span class="comment">// Don&#39;t start sending transform events until the gesture exceeds a threshold</span>
<a name="l07567"></a>07567   GD.SCALE_THRESHOLD = 20;     <span class="comment">// pixels</span>
<a name="l07568"></a>07568   GD.ROTATE_THRESHOLD = 22.5;  <span class="comment">// degrees</span>
<a name="l07569"></a>07569 
<a name="l07570"></a>07570   <span class="comment">// For pans and zooms, we compute new starting coordinates that are part way</span>
<a name="l07571"></a>07571   <span class="comment">// between the initial event and the event that crossed the threshold so that</span>
<a name="l07572"></a>07572   <span class="comment">// the first event we send doesn&#39;t cause a big lurch. This constant must be</span>
<a name="l07573"></a>07573   <span class="comment">// between 0 and 1 and says how far along the line between the initial value</span>
<a name="l07574"></a>07574   <span class="comment">// and the new value we pick</span>
<a name="l07575"></a>07575   GD.THRESHOLD_SMOOTHING = 0.9;
<a name="l07576"></a>07576 
<a name="l07577"></a>07577   <span class="comment">//</span>
<a name="l07578"></a>07578   <span class="comment">// Helpful shortcuts and utility functions</span>
<a name="l07579"></a>07579   <span class="comment">//</span>
<a name="l07580"></a>07580 
<a name="l07581"></a>07581   var abs = Math.abs, floor = Math.floor, sqrt = Math.sqrt, atan2 = Math.atan2;
<a name="l07582"></a>07582   var PI = Math.PI;
<a name="l07583"></a>07583 
<a name="l07584"></a>07584   <span class="comment">// The names of events that we need to register handlers for</span>
<a name="l07585"></a>07585   var eventtypes = [
<a name="l07586"></a>07586     <span class="stringliteral">&#39;touchstart&#39;</span>,
<a name="l07587"></a>07587     <span class="stringliteral">&#39;touchmove&#39;</span>,
<a name="l07588"></a>07588     <span class="stringliteral">&#39;touchend&#39;</span>,
<a name="l07589"></a>07589     <span class="stringliteral">&#39;mousedown&#39;</span>  <span class="comment">// We register mousemove and mouseup manually</span>
<a name="l07590"></a>07590   ];
<a name="l07591"></a>07591 
<a name="l07592"></a>07592   <span class="comment">// Return the event&#39;s timestamp in ms</span>
<a name="l07593"></a>07593   <span class="keyword">function</span> eventTime(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l07594"></a>07594     <span class="comment">// In gecko, synthetic events seem to be in microseconds rather than ms.</span>
<a name="l07595"></a>07595     <span class="comment">// So if the timestamp is much larger than the current time, assue it is</span>
<a name="l07596"></a>07596     <span class="comment">// in microseconds and divide by 1000</span>
<a name="l07597"></a>07597     var ts = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.timeStamp;
<a name="l07598"></a>07598     <span class="keywordflow">if</span> (ts &gt; 2 * Date.now())
<a name="l07599"></a>07599       <span class="keywordflow">return</span> Math.floor(ts / 1000);
<a name="l07600"></a>07600     <span class="keywordflow">else</span>
<a name="l07601"></a>07601       <span class="keywordflow">return</span> ts;
<a name="l07602"></a>07602   }
<a name="l07603"></a>07603 
<a name="l07604"></a>07604 
<a name="l07605"></a>07605   <span class="comment">// Return an object containg the space and time coordinates of</span>
<a name="l07606"></a>07606   <span class="comment">// and event and touch. We freeze the object to make it immutable so</span>
<a name="l07607"></a>07607   <span class="comment">// we can pass it in events and not worry about values being changed.</span>
<a name="l07608"></a>07608   <span class="keyword">function</span> coordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07609"></a>07609     <span class="keywordflow">return</span> Object.freeze({
<a name="l07610"></a>07610       screenX: t.screenX,
<a name="l07611"></a>07611       screenY: t.screenY,
<a name="l07612"></a>07612       clientX: t.clientX,
<a name="l07613"></a>07613       clientY: t.clientY,
<a name="l07614"></a>07614       timeStamp: eventTime(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>)
<a name="l07615"></a>07615     });
<a name="l07616"></a>07616   }
<a name="l07617"></a>07617 
<a name="l07618"></a>07618   <span class="comment">// Like coordinates(), but return the midpoint between two touches</span>
<a name="l07619"></a>07619   <span class="keyword">function</span> midpoints(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t1, t2) {
<a name="l07620"></a>07620     <span class="keywordflow">return</span> Object.freeze({
<a name="l07621"></a>07621       screenX: floor((t1.screenX + t2.screenX) / 2),
<a name="l07622"></a>07622       screenY: floor((t1.screenY + t2.screenY) / 2),
<a name="l07623"></a>07623       clientX: floor((t1.clientX + t2.clientX) / 2),
<a name="l07624"></a>07624       clientY: floor((t1.clientY + t2.clientY) / 2),
<a name="l07625"></a>07625       timeStamp: eventTime(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>)
<a name="l07626"></a>07626     });
<a name="l07627"></a>07627   }
<a name="l07628"></a>07628 
<a name="l07629"></a>07629   <span class="comment">// Like coordinates(), but for a mouse event</span>
<a name="l07630"></a>07630   <span class="keyword">function</span> mouseCoordinates(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l07631"></a>07631     <span class="keywordflow">return</span> Object.freeze({
<a name="l07632"></a>07632       screenX: <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.screenX,
<a name="l07633"></a>07633       screenY: <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.screenY,
<a name="l07634"></a>07634       clientX: <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.clientX,
<a name="l07635"></a>07635       clientY: <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.clientY,
<a name="l07636"></a>07636       timeStamp: eventTime(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>)
<a name="l07637"></a>07637     });
<a name="l07638"></a>07638   }
<a name="l07639"></a>07639 
<a name="l07640"></a>07640   <span class="comment">// Given coordinates objects c1 and c2, return a new coordinates object</span>
<a name="l07641"></a>07641   <span class="comment">// representing a point and time along the line between those points.</span>
<a name="l07642"></a>07642   <span class="comment">// The position of the point is controlled by the THRESHOLD_SMOOTHING constant</span>
<a name="l07643"></a>07643   <span class="keyword">function</span> between(c1, c2) {
<a name="l07644"></a>07644     var r = GD.THRESHOLD_SMOOTHING;
<a name="l07645"></a>07645     <span class="keywordflow">return</span> Object.freeze({
<a name="l07646"></a>07646       screenX: floor(c1.screenX + r * (c2.screenX - c1.screenX)),
<a name="l07647"></a>07647       screenY: floor(c1.screenY + r * (c2.screenY - c1.screenY)),
<a name="l07648"></a>07648       clientX: floor(c1.clientX + r * (c2.clientX - c1.clientX)),
<a name="l07649"></a>07649       clientY: floor(c1.clientY + r * (c2.clientY - c1.clientY)),
<a name="l07650"></a>07650       timeStamp: floor(c1.timeStamp + r * (c2.timeStamp - c1.timeStamp))
<a name="l07651"></a>07651     });
<a name="l07652"></a>07652   }
<a name="l07653"></a>07653 
<a name="l07654"></a>07654   <span class="comment">// Compute the distance between two touches</span>
<a name="l07655"></a>07655   <span class="keyword">function</span> touchDistance(t1, t2) {
<a name="l07656"></a>07656     var dx = t2.screenX - t1.screenX;
<a name="l07657"></a>07657     var dy = t2.screenY - t1.screenY;
<a name="l07658"></a>07658     <span class="keywordflow">return</span> sqrt(dx * dx + dy * dy);
<a name="l07659"></a>07659   }
<a name="l07660"></a>07660 
<a name="l07661"></a>07661   <span class="comment">// Compute the direction (as an angle) of the line between two touches</span>
<a name="l07662"></a>07662   <span class="comment">// Returns a number d, -180 &lt; d &lt;= 180</span>
<a name="l07663"></a>07663   <span class="keyword">function</span> touchDirection(t1, t2) {
<a name="l07664"></a>07664     <span class="keywordflow">return</span> atan2(t2.screenY - t1.screenY,
<a name="l07665"></a>07665                  t2.screenX - t1.screenX) * 180 / PI;
<a name="l07666"></a>07666   }
<a name="l07667"></a>07667 
<a name="l07668"></a>07668   <span class="comment">// Compute the clockwise angle between direction d1 and direction d2.</span>
<a name="l07669"></a>07669   <span class="comment">// Returns an angle a -180 &lt; a &lt;= 180.</span>
<a name="l07670"></a>07670   <span class="keyword">function</span> touchRotation(d1, d2) {
<a name="l07671"></a>07671     var angle = d2 - d1;
<a name="l07672"></a>07672     <span class="keywordflow">if</span> (angle &gt; 180)
<a name="l07673"></a>07673       angle -= 360;
<a name="l07674"></a>07674     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &lt;= -180)
<a name="l07675"></a>07675       angle += 360;
<a name="l07676"></a>07676     <span class="keywordflow">return</span> angle;
<a name="l07677"></a>07677   }
<a name="l07678"></a>07678 
<a name="l07679"></a>07679   <span class="comment">// Determine if two taps are close enough in time and space to</span>
<a name="l07680"></a>07680   <span class="comment">// trigger a dbltap event. The arguments are objects returned</span>
<a name="l07681"></a>07681   <span class="comment">// by the coordinates() function.</span>
<a name="l07682"></a>07682   <span class="keyword">function</span> isDoubleTap(lastTap, thisTap) {
<a name="l07683"></a>07683     var dx = abs(thisTap.screenX - lastTap.screenX);
<a name="l07684"></a>07684     var dy = abs(thisTap.screenY - lastTap.screenY);
<a name="l07685"></a>07685     var dt = thisTap.timeStamp - lastTap.timeStamp;
<a name="l07686"></a>07686     <span class="keywordflow">return</span> (dx &lt; GD.DOUBLE_TAP_DISTANCE &amp;&amp;
<a name="l07687"></a>07687             dy &lt; GD.DOUBLE_TAP_DISTANCE &amp;&amp;
<a name="l07688"></a>07688             dt &lt; GD.DOUBLE_TAP_TIME);
<a name="l07689"></a>07689   }
<a name="l07690"></a>07690 
<a name="l07691"></a>07691   <span class="comment">//</span>
<a name="l07692"></a>07692   <span class="comment">// The following objects are the states of our Finite State Machine</span>
<a name="l07693"></a>07693   <span class="comment">//</span>
<a name="l07694"></a>07694 
<a name="l07695"></a>07695   <span class="comment">// In this state we&#39;re not processing any gestures, just waiting</span>
<a name="l07696"></a>07696   <span class="comment">// for an event to start a gesture and ignoring others</span>
<a name="l07697"></a>07697   var initialState = {
<a name="l07698"></a>07698     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;initialState&#39;</span>,
<a name="l07699"></a>07699     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d) {
<a name="l07700"></a>07700       <span class="comment">// When we enter or return to the initial state, clear</span>
<a name="l07701"></a>07701       <span class="comment">// the detector properties that were tracking gestures</span>
<a name="l07702"></a>07702       <span class="comment">// Don&#39;t clear d.lastTap here, though. We need it for dbltap events</span>
<a name="l07703"></a>07703       d.target = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07704"></a>07704       d.start = d.last = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07705"></a>07705       d.touch1 = d.touch2 = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07706"></a>07706       d.vx = d.vy = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07707"></a>07707       d.startDistance = d.lastDistance = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07708"></a>07708       d.startDirection = d.lastDirection = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07709"></a>07709       d.lastMidpoint = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07710"></a>07710       d.scaled = d.rotated = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07711"></a>07711     },
<a name="l07712"></a>07712 
<a name="l07713"></a>07713     <span class="comment">// Switch to the touchstarted state and process the touch event there</span>
<a name="l07714"></a>07714     <span class="comment">// Once we&#39;ve started processing a touch gesture we&#39;ll ignore mouse events</span>
<a name="l07715"></a>07715     touchstart: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07716"></a>07716       d.switchTo(touchStartedState, e, t);
<a name="l07717"></a>07717     },
<a name="l07718"></a>07718 
<a name="l07719"></a>07719     <span class="comment">// Or if we see a mouse event first, then start processing a mouse-based</span>
<a name="l07720"></a>07720     <span class="comment">// gesture, and ignore any touch events</span>
<a name="l07721"></a>07721     mousedown: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l07722"></a>07722       d.switchTo(mouseDownState, e);
<a name="l07723"></a>07723     }
<a name="l07724"></a>07724   };
<a name="l07725"></a>07725 
<a name="l07726"></a>07726   <span class="comment">// One finger is down but we haven&#39;t generated any event yet. We&#39;re</span>
<a name="l07727"></a>07727   <span class="comment">// waiting to see...  If the finger goes up soon, its a tap. If the finger</span>
<a name="l07728"></a>07728   <span class="comment">// stays down and still, its a hold. If the finger moves its a pan/swipe.</span>
<a name="l07729"></a>07729   <span class="comment">// And if a second finger goes down, its a transform</span>
<a name="l07730"></a>07730   var touchStartedState = {
<a name="l07731"></a>07731     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;touchStartedState&#39;</span>,
<a name="l07732"></a>07732     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07733"></a>07733       <span class="comment">// Remember the target of the event</span>
<a name="l07734"></a>07734       d.target = e.target;
<a name="l07735"></a>07735       <span class="comment">// Remember the id of the touch that started</span>
<a name="l07736"></a>07736       d.touch1 = t.identifier;
<a name="l07737"></a>07737       <span class="comment">// Get the coordinates of the touch</span>
<a name="l07738"></a>07738       d.start = d.last = coordinates(e, t);
<a name="l07739"></a>07739       <span class="comment">// Start a timer for a hold</span>
<a name="l07740"></a>07740       <span class="comment">// If we&#39;re doing hold events, start a timer for them</span>
<a name="l07741"></a>07741       <span class="keywordflow">if</span> (d.options.holdEvents)
<a name="l07742"></a>07742         d.startTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>, GD.HOLD_INTERVAL);
<a name="l07743"></a>07743     },
<a name="l07744"></a>07744 
<a name="l07745"></a>07745     touchstart: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07746"></a>07746       <span class="comment">// If another finger goes down in this state, then</span>
<a name="l07747"></a>07747       <span class="comment">// go to transform state to start 2-finger gestures.</span>
<a name="l07748"></a>07748       d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l07749"></a>07749       d.switchTo(transformState, e, t);
<a name="l07750"></a>07750     },
<a name="l07751"></a>07751     touchmove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07752"></a>07752       <span class="comment">// Ignore any touches but the initial one</span>
<a name="l07753"></a>07753       <span class="comment">// This could happen if there was still a finger down after</span>
<a name="l07754"></a>07754       <span class="comment">// the end of a previous 2-finger gesture, e.g.</span>
<a name="l07755"></a>07755       <span class="keywordflow">if</span> (t.identifier !== d.touch1)
<a name="l07756"></a>07756         <span class="keywordflow">return</span>;
<a name="l07757"></a>07757 
<a name="l07758"></a>07758       <span class="keywordflow">if</span> (abs(t.screenX - d.start.screenX) &gt; GD.PAN_THRESHOLD ||
<a name="l07759"></a>07759           abs(t.screenY - d.start.screenY) &gt; GD.PAN_THRESHOLD) {
<a name="l07760"></a>07760         d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l07761"></a>07761         d.switchTo(panStartedState, e, t);
<a name="l07762"></a>07762       }
<a name="l07763"></a>07763     },
<a name="l07764"></a>07764     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07765"></a>07765       <span class="comment">// Ignore any touches but the initial one</span>
<a name="l07766"></a>07766       <span class="keywordflow">if</span> (t.identifier !== d.touch1)
<a name="l07767"></a>07767         <span class="keywordflow">return</span>;
<a name="l07768"></a>07768 
<a name="l07769"></a>07769       <span class="comment">// If there was a previous tap that was close enough in time</span>
<a name="l07770"></a>07770       <span class="comment">// and space, then emit a &#39;dbltap&#39; event</span>
<a name="l07771"></a>07771       <span class="keywordflow">if</span> (d.lastTap &amp;&amp; isDoubleTap(d.lastTap, d.start)) {
<a name="l07772"></a>07772         d.emitEvent(<span class="stringliteral">&#39;tap&#39;</span>, d.start);
<a name="l07773"></a>07773         d.emitEvent(<span class="stringliteral">&#39;dbltap&#39;</span>, d.start);
<a name="l07774"></a>07774         <span class="comment">// clear the lastTap property, so we don&#39;t get another one</span>
<a name="l07775"></a>07775         d.lastTap = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l07776"></a>07776       }
<a name="l07777"></a>07777       <span class="keywordflow">else</span> {
<a name="l07778"></a>07778         <span class="comment">// Emit a &#39;tap&#39; event using the starting coordinates</span>
<a name="l07779"></a>07779         <span class="comment">// as the event details</span>
<a name="l07780"></a>07780         d.emitEvent(<span class="stringliteral">&#39;tap&#39;</span>, d.start);
<a name="l07781"></a>07781 
<a name="l07782"></a>07782         <span class="comment">// Remember the coordinates of this tap so we can detect double taps</span>
<a name="l07783"></a>07783         d.lastTap = coordinates(e, t);
<a name="l07784"></a>07784       }
<a name="l07785"></a>07785 
<a name="l07786"></a>07786       <span class="comment">// In either case clear the timer and go back to the initial state</span>
<a name="l07787"></a>07787       d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l07788"></a>07788       d.switchTo(initialState);
<a name="l07789"></a>07789     },
<a name="l07790"></a>07790 
<a name="l07791"></a>07791     holdtimeout: <span class="keyword">function</span>(d) {
<a name="l07792"></a>07792       d.switchTo(holdState);
<a name="l07793"></a>07793     }
<a name="l07794"></a>07794 
<a name="l07795"></a>07795   };
<a name="l07796"></a>07796 
<a name="l07797"></a>07797   <span class="comment">// A single touch has moved enough to exceed the pan threshold and now</span>
<a name="l07798"></a>07798   <span class="comment">// we&#39;re going to generate pan events after each move and a swipe event</span>
<a name="l07799"></a>07799   <span class="comment">// when the touch ends. We ignore any other touches that occur while this</span>
<a name="l07800"></a>07800   <span class="comment">// pan/swipe gesture is in progress.</span>
<a name="l07801"></a>07801   var panStartedState = {
<a name="l07802"></a>07802     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;panStartedState&#39;</span>,
<a name="l07803"></a>07803     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07804"></a>07804       <span class="comment">// Panning doesn&#39;t start until the touch has moved more than a</span>
<a name="l07805"></a>07805       <span class="comment">// certain threshold. But we don&#39;t want the pan to have a jerky</span>
<a name="l07806"></a>07806       <span class="comment">// start where the first event is a big distance. So proceed as</span>
<a name="l07807"></a>07807       <span class="comment">// pan actually started at a point along the path between the</span>
<a name="l07808"></a>07808       <span class="comment">// first touch and this current touch.</span>
<a name="l07809"></a>07809       d.start = d.last = between(d.start, coordinates(e, t));
<a name="l07810"></a>07810 
<a name="l07811"></a>07811       <span class="comment">// If we transition into this state with a touchmove event,</span>
<a name="l07812"></a>07812       <span class="comment">// then process it with that handler. If we don&#39;t do this then</span>
<a name="l07813"></a>07813       <span class="comment">// we can end up with swipe events that don&#39;t know their velocity</span>
<a name="l07814"></a>07814       <span class="keywordflow">if</span> (e.type === <span class="stringliteral">&#39;touchmove&#39;</span>)
<a name="l07815"></a>07815         panStartedState.touchmove(d, e, t);
<a name="l07816"></a>07816     },
<a name="l07817"></a>07817 
<a name="l07818"></a>07818     touchmove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07819"></a>07819       <span class="comment">// Ignore any fingers other than the one we&#39;re tracking</span>
<a name="l07820"></a>07820       <span class="keywordflow">if</span> (t.identifier !== d.touch1)
<a name="l07821"></a>07821         <span class="keywordflow">return</span>;
<a name="l07822"></a>07822 
<a name="l07823"></a>07823       <span class="comment">// Each time the touch moves, emit a pan event but stay in this state</span>
<a name="l07824"></a>07824       var current = coordinates(e, t);
<a name="l07825"></a>07825       d.emitEvent(<span class="stringliteral">&#39;pan&#39;</span>, {
<a name="l07826"></a>07826         <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: {
<a name="l07827"></a>07827           dx: current.screenX - d.start.screenX,
<a name="l07828"></a>07828           dy: current.screenY - d.start.screenY
<a name="l07829"></a>07829         },
<a name="l07830"></a>07830         relative: {
<a name="l07831"></a>07831           dx: current.screenX - d.last.screenX,
<a name="l07832"></a>07832           dy: current.screenY - d.last.screenY
<a name="l07833"></a>07833         },
<a name="l07834"></a>07834         <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>: current
<a name="l07835"></a>07835       });
<a name="l07836"></a>07836 
<a name="l07837"></a>07837       <span class="comment">// Track the pan velocity so we can report this with the swipe</span>
<a name="l07838"></a>07838       <span class="comment">// Use a exponential moving average for a bit of smoothing</span>
<a name="l07839"></a>07839       <span class="comment">// on the velocity</span>
<a name="l07840"></a>07840       var dt = current.timeStamp - d.last.timeStamp;
<a name="l07841"></a>07841       var vx = (current.screenX - d.last.screenX) / dt;
<a name="l07842"></a>07842       var vy = (current.screenY - d.last.screenY) / dt;
<a name="l07843"></a>07843 
<a name="l07844"></a>07844       <span class="keywordflow">if</span> (d.vx == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) { <span class="comment">// first time; no average</span>
<a name="l07845"></a>07845         d.vx = vx;
<a name="l07846"></a>07846         d.vy = vy;
<a name="l07847"></a>07847       }
<a name="l07848"></a>07848       <span class="keywordflow">else</span> {
<a name="l07849"></a>07849         d.vx = d.vx * GD.VELOCITY_SMOOTHING +
<a name="l07850"></a>07850           vx * (1 - GD.VELOCITY_SMOOTHING);
<a name="l07851"></a>07851         d.vy = d.vy * GD.VELOCITY_SMOOTHING +
<a name="l07852"></a>07852           vy * (1 - GD.VELOCITY_SMOOTHING);
<a name="l07853"></a>07853       }
<a name="l07854"></a>07854 
<a name="l07855"></a>07855       d.last = current;
<a name="l07856"></a>07856     },
<a name="l07857"></a>07857     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07858"></a>07858       <span class="comment">// Ignore any fingers other than the one we&#39;re tracking</span>
<a name="l07859"></a>07859       <span class="keywordflow">if</span> (t.identifier !== d.touch1)
<a name="l07860"></a>07860         <span class="keywordflow">return</span>;
<a name="l07861"></a>07861 
<a name="l07862"></a>07862       <span class="comment">// Emit a swipe event when the finger goes up.</span>
<a name="l07863"></a>07863       <span class="comment">// Report start and end point, dx, dy, dt, velocity and direction</span>
<a name="l07864"></a>07864       var current = coordinates(e, t);
<a name="l07865"></a>07865       var dx = current.screenX - d.start.screenX;
<a name="l07866"></a>07866       var dy = current.screenY - d.start.screenY;
<a name="l07867"></a>07867       <span class="comment">// angle is a positive number of degrees, starting at 0 on the</span>
<a name="l07868"></a>07868       <span class="comment">// positive x axis and increasing clockwise.</span>
<a name="l07869"></a>07869       var angle = atan2(dy, dx) * 180 / PI;
<a name="l07870"></a>07870       <span class="keywordflow">if</span> (angle &lt; 0)
<a name="l07871"></a>07871         angle += 360;
<a name="l07872"></a>07872 
<a name="l07873"></a>07873       <span class="comment">// Direction is &#39;right&#39;, &#39;down&#39;, &#39;left&#39; or &#39;up&#39;</span>
<a name="l07874"></a>07874       var <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>;
<a name="l07875"></a>07875       <span class="keywordflow">if</span> (angle &gt;= 315 || angle &lt; 45)
<a name="l07876"></a>07876         direction = <span class="stringliteral">&#39;right&#39;</span>;
<a name="l07877"></a>07877       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 45 &amp;&amp; angle &lt; 135)
<a name="l07878"></a>07878         direction = <span class="stringliteral">&#39;down&#39;</span>;
<a name="l07879"></a>07879       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 135 &amp;&amp; angle &lt; 225)
<a name="l07880"></a>07880         direction = <span class="stringliteral">&#39;left&#39;</span>;
<a name="l07881"></a>07881       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 225 &amp;&amp; angle &lt; 315)
<a name="l07882"></a>07882         direction = <span class="stringliteral">&#39;up&#39;</span>;
<a name="l07883"></a>07883 
<a name="l07884"></a>07884       d.emitEvent(<span class="stringliteral">&#39;swipe&#39;</span>, {
<a name="l07885"></a>07885         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: d.start,
<a name="l07886"></a>07886         <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: current,
<a name="l07887"></a>07887         dx: dx,
<a name="l07888"></a>07888         dy: dy,
<a name="l07889"></a>07889         dt: e.timeStamp - d.start.timeStamp,
<a name="l07890"></a>07890         vx: d.vx,
<a name="l07891"></a>07891         vy: d.vy,
<a name="l07892"></a>07892         direction: <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>,
<a name="l07893"></a>07893         angle: angle
<a name="l07894"></a>07894       });
<a name="l07895"></a>07895 
<a name="l07896"></a>07896       <span class="comment">// Go back to the initial state</span>
<a name="l07897"></a>07897       d.switchTo(initialState);
<a name="l07898"></a>07898     }
<a name="l07899"></a>07899   };
<a name="l07900"></a>07900 
<a name="l07901"></a>07901   <span class="comment">// We enter this state if the user touches and holds for long enough</span>
<a name="l07902"></a>07902   <span class="comment">// without moving much.  When we enter we emit a holdstart event. Motion</span>
<a name="l07903"></a>07903   <span class="comment">// after the holdstart generates holdmove events. And when the touch ends</span>
<a name="l07904"></a>07904   <span class="comment">// we generate a holdend event. holdmove and holdend events can be used</span>
<a name="l07905"></a>07905   <span class="comment">// kind of like drag and drop events in a mouse-based UI. Currently,</span>
<a name="l07906"></a>07906   <span class="comment">// these events just report the coordinates of the touch.  Do we need</span>
<a name="l07907"></a>07907   <span class="comment">// other details?</span>
<a name="l07908"></a>07908   var holdState = {
<a name="l07909"></a>07909     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;holdState&#39;</span>,
<a name="l07910"></a>07910     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d) {
<a name="l07911"></a>07911       d.emitEvent(<span class="stringliteral">&#39;holdstart&#39;</span>, d.start);
<a name="l07912"></a>07912     },
<a name="l07913"></a>07913 
<a name="l07914"></a>07914     touchmove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07915"></a>07915       var current = coordinates(e, t);
<a name="l07916"></a>07916       d.emitEvent(<span class="stringliteral">&#39;holdmove&#39;</span>, {
<a name="l07917"></a>07917         <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: {
<a name="l07918"></a>07918           dx: current.screenX - d.start.screenX,
<a name="l07919"></a>07919           dy: current.screenY - d.start.screenY
<a name="l07920"></a>07920         },
<a name="l07921"></a>07921         relative: {
<a name="l07922"></a>07922           dx: current.screenX - d.last.screenX,
<a name="l07923"></a>07923           dy: current.screenY - d.last.screenY
<a name="l07924"></a>07924         },
<a name="l07925"></a>07925         <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>: current
<a name="l07926"></a>07926       });
<a name="l07927"></a>07927 
<a name="l07928"></a>07928       d.last = current;
<a name="l07929"></a>07929     },
<a name="l07930"></a>07930 
<a name="l07931"></a>07931     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07932"></a>07932       var current = coordinates(e, t);
<a name="l07933"></a>07933       d.emitEvent(<span class="stringliteral">&#39;holdend&#39;</span>, {
<a name="l07934"></a>07934         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: d.start,
<a name="l07935"></a>07935         <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: current,
<a name="l07936"></a>07936         dx: current.screenX - d.start.screenX,
<a name="l07937"></a>07937         dy: current.screenY - d.start.screenY
<a name="l07938"></a>07938       });
<a name="l07939"></a>07939       d.switchTo(initialState);
<a name="l07940"></a>07940     }
<a name="l07941"></a>07941   };
<a name="l07942"></a>07942 
<a name="l07943"></a>07943   <span class="comment">// We enter this state if a second touch starts before we start</span>
<a name="l07944"></a>07944   <span class="comment">// recoginzing any other gesture.  As the touches move we track the</span>
<a name="l07945"></a>07945   <span class="comment">// distance and angle between them to report scale and rotation values</span>
<a name="l07946"></a>07946   <span class="comment">// in transform events.</span>
<a name="l07947"></a>07947   var transformState = {
<a name="l07948"></a>07948     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;transformState&#39;</span>,
<a name="l07949"></a>07949     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07950"></a>07950       <span class="comment">// Remember the id of the second touch</span>
<a name="l07951"></a>07951       d.touch2 = t.identifier;
<a name="l07952"></a>07952 
<a name="l07953"></a>07953       <span class="comment">// Get the two Touch objects</span>
<a name="l07954"></a>07954       var t1 = e.touches.identifiedTouch(d.touch1);
<a name="l07955"></a>07955       var t2 = e.touches.identifiedTouch(d.touch2);
<a name="l07956"></a>07956 
<a name="l07957"></a>07957       <span class="comment">// Compute and remember the initial distance and angle</span>
<a name="l07958"></a>07958       d.startDistance = d.lastDistance = touchDistance(t1, t2);
<a name="l07959"></a>07959       d.startDirection = d.lastDirection = touchDirection(t1, t2);
<a name="l07960"></a>07960 
<a name="l07961"></a>07961       <span class="comment">// Don&#39;t start emitting events until we&#39;re past a threshold</span>
<a name="l07962"></a>07962       d.scaled = d.rotated = <span class="keyword">false</span>;
<a name="l07963"></a>07963     },
<a name="l07964"></a>07964 
<a name="l07965"></a>07965     touchmove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l07966"></a>07966       <span class="comment">// Ignore touches we&#39;re not tracking</span>
<a name="l07967"></a>07967       <span class="keywordflow">if</span> (t.identifier !== d.touch1 &amp;&amp; t.identifier !== d.touch2)
<a name="l07968"></a>07968         <span class="keywordflow">return</span>;
<a name="l07969"></a>07969 
<a name="l07970"></a>07970       <span class="comment">// Get the two Touch objects</span>
<a name="l07971"></a>07971       var t1 = e.touches.identifiedTouch(d.touch1);
<a name="l07972"></a>07972       var t2 = e.touches.identifiedTouch(d.touch2);
<a name="l07973"></a>07973 
<a name="l07974"></a>07974       <span class="comment">// Compute the new midpoints, distance and direction</span>
<a name="l07975"></a>07975       var midpoint = midpoints(e, t1, t2);
<a name="l07976"></a>07976       var distance = touchDistance(t1, t2);
<a name="l07977"></a>07977       var direction = touchDirection(t1, t2);
<a name="l07978"></a>07978       var rotation = touchRotation(d.startDirection, direction);
<a name="l07979"></a>07979 
<a name="l07980"></a>07980       <span class="comment">// Check all of these numbers against the thresholds. Otherwise</span>
<a name="l07981"></a>07981       <span class="comment">// the transforms are too jittery even when you try to hold your</span>
<a name="l07982"></a>07982       <span class="comment">// fingers still.</span>
<a name="l07983"></a>07983       <span class="keywordflow">if</span> (!d.scaled) {
<a name="l07984"></a>07984         <span class="keywordflow">if</span> (abs(distance - d.startDistance) &gt; GD.SCALE_THRESHOLD) {
<a name="l07985"></a>07985           d.scaled = <span class="keyword">true</span>;
<a name="l07986"></a>07986           d.startDistance = d.lastDistance =
<a name="l07987"></a>07987             floor(d.startDistance +
<a name="l07988"></a>07988                   GD.THRESHOLD_SMOOTHING * (distance - d.startDistance));
<a name="l07989"></a>07989         }
<a name="l07990"></a>07990         <span class="keywordflow">else</span>
<a name="l07991"></a>07991           distance = d.startDistance;
<a name="l07992"></a>07992       }
<a name="l07993"></a>07993       <span class="keywordflow">if</span> (!d.rotated) {
<a name="l07994"></a>07994         <span class="keywordflow">if</span> (abs(rotation) &gt; GD.ROTATE_THRESHOLD)
<a name="l07995"></a>07995           d.rotated = <span class="keyword">true</span>;
<a name="l07996"></a>07996         <span class="keywordflow">else</span>
<a name="l07997"></a>07997           direction = d.startDirection;
<a name="l07998"></a>07998       }
<a name="l07999"></a>07999 
<a name="l08000"></a>08000       <span class="comment">// If nothing has exceeded the threshold yet, then we</span>
<a name="l08001"></a>08001       <span class="comment">// don&#39;t even have to fire an event.</span>
<a name="l08002"></a>08002       <span class="keywordflow">if</span> (d.scaled || d.rotated) {
<a name="l08003"></a>08003         <span class="comment">// The detail field for the transform gesture event includes</span>
<a name="l08004"></a>08004         <span class="comment">// &#39;absolute&#39; transformations against the initial values and</span>
<a name="l08005"></a>08005         <span class="comment">// &#39;relative&#39; transformations against the values from the last</span>
<a name="l08006"></a>08006         <span class="comment">// transformgesture event.</span>
<a name="l08007"></a>08007         d.emitEvent(<span class="stringliteral">&#39;transform&#39;</span>, {
<a name="l08008"></a>08008           <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: { <span class="comment">// transform details since gesture start</span>
<a name="l08009"></a>08009             <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>: distance / d.startDistance,
<a name="l08010"></a>08010             <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>: touchRotation(d.startDirection, direction)
<a name="l08011"></a>08011           },
<a name="l08012"></a>08012           relative: { <span class="comment">// transform since last gesture change</span>
<a name="l08013"></a>08013             <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>: distance / d.lastDistance,
<a name="l08014"></a>08014             <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>: touchRotation(d.lastDirection, direction)
<a name="l08015"></a>08015           },
<a name="l08016"></a>08016           midpoint: midpoint
<a name="l08017"></a>08017         });
<a name="l08018"></a>08018 
<a name="l08019"></a>08019         d.lastDistance = distance;
<a name="l08020"></a>08020         d.lastDirection = <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>;
<a name="l08021"></a>08021         d.lastMidpoint = midpoint;
<a name="l08022"></a>08022       }
<a name="l08023"></a>08023     },
<a name="l08024"></a>08024 
<a name="l08025"></a>08025     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l08026"></a>08026       <span class="comment">// If either finger goes up, we&#39;re done with the gesture.</span>
<a name="l08027"></a>08027       <span class="comment">// The user might move that finger and put it right back down</span>
<a name="l08028"></a>08028       <span class="comment">// again to begin another 2-finger gesture, so we can&#39;t go</span>
<a name="l08029"></a>08029       <span class="comment">// back to the initial state while one of the fingers remains up.</span>
<a name="l08030"></a>08030       <span class="comment">// On the other hand, we can&#39;t go back to touchStartedState because</span>
<a name="l08031"></a>08031       <span class="comment">// that would mean that the finger left down could cause a tap or</span>
<a name="l08032"></a>08032       <span class="comment">// pan event. So we need an afterTransform state that waits for</span>
<a name="l08033"></a>08033       <span class="comment">// a finger to come back down or the other finger to go up.</span>
<a name="l08034"></a>08034       <span class="keywordflow">if</span> (t.identifier === d.touch2)
<a name="l08035"></a>08035         d.touch2 = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08036"></a>08036       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t.identifier === d.touch1) {
<a name="l08037"></a>08037         d.touch1 = d.touch2;
<a name="l08038"></a>08038         d.touch2 = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08039"></a>08039       }
<a name="l08040"></a>08040       <span class="keywordflow">else</span>
<a name="l08041"></a>08041         <span class="keywordflow">return</span>; <span class="comment">// It was a touch we weren&#39;t tracking</span>
<a name="l08042"></a>08042 
<a name="l08043"></a>08043       <span class="comment">// If we emitted any transform events, now we need to emit</span>
<a name="l08044"></a>08044       <span class="comment">// a transformend event to end the series.  The details of this</span>
<a name="l08045"></a>08045       <span class="comment">// event use the values from the last touchmove, and the</span>
<a name="l08046"></a>08046       <span class="comment">// relative amounts will 1 and 0, but they are included for</span>
<a name="l08047"></a>08047       <span class="comment">// completeness even though they are not useful.</span>
<a name="l08048"></a>08048       <span class="keywordflow">if</span> (d.scaled || d.rotated) {
<a name="l08049"></a>08049         d.emitEvent(<span class="stringliteral">&#39;transformend&#39;</span>, {
<a name="l08050"></a>08050           <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: { <span class="comment">// transform details since gesture start</span>
<a name="l08051"></a>08051             <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>: d.lastDistance / d.startDistance,
<a name="l08052"></a>08052             <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>: touchRotation(d.startDirection, d.lastDirection)
<a name="l08053"></a>08053           },
<a name="l08054"></a>08054           relative: { <span class="comment">// nothing has changed relative to the last touchmove</span>
<a name="l08055"></a>08055             <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>: 1,
<a name="l08056"></a>08056             <a class="code" href="../../d3/d91/j3d_8js.html#a5041bc85ea6f28e6bcfea5bb0a4facad">rotate</a>: 0
<a name="l08057"></a>08057           },
<a name="l08058"></a>08058           midpoint: d.lastMidpoint
<a name="l08059"></a>08059         });
<a name="l08060"></a>08060       }
<a name="l08061"></a>08061 
<a name="l08062"></a>08062       d.switchTo(afterTransformState);
<a name="l08063"></a>08063     }
<a name="l08064"></a>08064   };
<a name="l08065"></a>08065 
<a name="l08066"></a>08066   <span class="comment">// We did a tranform and one finger went up. Wait for that finger to</span>
<a name="l08067"></a>08067   <span class="comment">// come back down or the other finger to go up too.</span>
<a name="l08068"></a>08068   var afterTransformState = {
<a name="l08069"></a>08069     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;afterTransformState&#39;</span>,
<a name="l08070"></a>08070     touchstart: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l08071"></a>08071       d.switchTo(transformState, e, t);
<a name="l08072"></a>08072     },
<a name="l08073"></a>08073 
<a name="l08074"></a>08074     touchend: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>, t) {
<a name="l08075"></a>08075       <span class="keywordflow">if</span> (t.identifier === d.touch1)
<a name="l08076"></a>08076         d.switchTo(initialState);
<a name="l08077"></a>08077     }
<a name="l08078"></a>08078   };
<a name="l08079"></a>08079 
<a name="l08080"></a>08080   var mouseDownState = {
<a name="l08081"></a>08081     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;mouseDownState&#39;</span>,
<a name="l08082"></a>08082     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l08083"></a>08083       <span class="comment">// Remember the target of the event</span>
<a name="l08084"></a>08084       d.target = e.target;
<a name="l08085"></a>08085 
<a name="l08086"></a>08086       <span class="comment">// Register this detector as a *capturing* handler on the document</span>
<a name="l08087"></a>08087       <span class="comment">// so we get all subsequent mouse events until we remove these handlers</span>
<a name="l08088"></a>08088       var doc = d.element.ownerDocument;
<a name="l08089"></a>08089       doc.addEventListener(<span class="stringliteral">&#39;mousemove&#39;</span>, d, <span class="keyword">true</span>);
<a name="l08090"></a>08090       doc.addEventListener(<span class="stringliteral">&#39;mouseup&#39;</span>, d, <span class="keyword">true</span>);
<a name="l08091"></a>08091 
<a name="l08092"></a>08092       <span class="comment">// Get the coordinates of the mouse event</span>
<a name="l08093"></a>08093       d.start = d.last = mouseCoordinates(e);
<a name="l08094"></a>08094 
<a name="l08095"></a>08095       <span class="comment">// Start a timer for a hold</span>
<a name="l08096"></a>08096       <span class="comment">// If we&#39;re doing hold events, start a timer for them</span>
<a name="l08097"></a>08097       <span class="keywordflow">if</span> (d.options.holdEvents)
<a name="l08098"></a>08098         d.startTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>, GD.HOLD_INTERVAL);
<a name="l08099"></a>08099     },
<a name="l08100"></a>08100 
<a name="l08101"></a>08101     mousemove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l08102"></a>08102       <span class="comment">// If the mouse has moved more than the panning threshold,</span>
<a name="l08103"></a>08103       <span class="comment">// then switch to the mouse panning state. Otherwise remain</span>
<a name="l08104"></a>08104       <span class="comment">// in this state</span>
<a name="l08105"></a>08105 
<a name="l08106"></a>08106       <span class="keywordflow">if</span> (abs(e.screenX - d.start.screenX) &gt; GD.MOUSE_PAN_THRESHOLD ||
<a name="l08107"></a>08107           abs(e.screenY - d.start.screenY) &gt; GD.MOUSE_PAN_THRESHOLD) {
<a name="l08108"></a>08108         d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l08109"></a>08109         d.switchTo(mousePannedState, e);
<a name="l08110"></a>08110       }
<a name="l08111"></a>08111     },
<a name="l08112"></a>08112 
<a name="l08113"></a>08113     mouseup: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l08114"></a>08114       <span class="comment">// Remove the capturing event handlers</span>
<a name="l08115"></a>08115       var doc = d.element.ownerDocument;
<a name="l08116"></a>08116       doc.removeEventListener(<span class="stringliteral">&#39;mousemove&#39;</span>, d, <span class="keyword">true</span>);
<a name="l08117"></a>08117       doc.removeEventListener(<span class="stringliteral">&#39;mouseup&#39;</span>, d, <span class="keyword">true</span>);
<a name="l08118"></a>08118 
<a name="l08119"></a>08119       <span class="comment">// If there was a previous tap that was close enough in time</span>
<a name="l08120"></a>08120       <span class="comment">// and space, then emit a &#39;dbltap&#39; event</span>
<a name="l08121"></a>08121       <span class="keywordflow">if</span> (d.lastTap &amp;&amp; isDoubleTap(d.lastTap, d.start)) {
<a name="l08122"></a>08122         d.emitEvent(<span class="stringliteral">&#39;tap&#39;</span>, d.start);
<a name="l08123"></a>08123         d.emitEvent(<span class="stringliteral">&#39;dbltap&#39;</span>, d.start);
<a name="l08124"></a>08124         d.lastTap = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>; <span class="comment">// so we don&#39;t get another one</span>
<a name="l08125"></a>08125       }
<a name="l08126"></a>08126       <span class="keywordflow">else</span> {
<a name="l08127"></a>08127         <span class="comment">// Emit a &#39;tap&#39; event using the starting coordinates</span>
<a name="l08128"></a>08128         <span class="comment">// as the event details</span>
<a name="l08129"></a>08129         d.emitEvent(<span class="stringliteral">&#39;tap&#39;</span>, d.start);
<a name="l08130"></a>08130 
<a name="l08131"></a>08131         <span class="comment">// Remember the coordinates of this tap so we can detect double taps</span>
<a name="l08132"></a>08132         d.lastTap = mouseCoordinates(e);
<a name="l08133"></a>08133       }
<a name="l08134"></a>08134 
<a name="l08135"></a>08135       <span class="comment">// In either case clear the timer and go back to the initial state</span>
<a name="l08136"></a>08136       d.clearTimer(<span class="stringliteral">&#39;holdtimeout&#39;</span>);
<a name="l08137"></a>08137       d.switchTo(initialState);
<a name="l08138"></a>08138     },
<a name="l08139"></a>08139 
<a name="l08140"></a>08140     holdtimeout: <span class="keyword">function</span>(d) {
<a name="l08141"></a>08141       d.switchTo(mouseHoldState);
<a name="l08142"></a>08142     }
<a name="l08143"></a>08143   };
<a name="l08144"></a>08144 
<a name="l08145"></a>08145   <span class="comment">// Like holdState, but for mouse events instead of touch events</span>
<a name="l08146"></a>08146   var mouseHoldState = {
<a name="l08147"></a>08147     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;mouseHoldState&#39;</span>,
<a name="l08148"></a>08148     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d) {
<a name="l08149"></a>08149       d.emitEvent(<span class="stringliteral">&#39;holdstart&#39;</span>, d.start);
<a name="l08150"></a>08150     },
<a name="l08151"></a>08151 
<a name="l08152"></a>08152     mousemove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l08153"></a>08153       var current = mouseCoordinates(e);
<a name="l08154"></a>08154       d.emitEvent(<span class="stringliteral">&#39;holdmove&#39;</span>, {
<a name="l08155"></a>08155         <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: {
<a name="l08156"></a>08156           dx: current.screenX - d.start.screenX,
<a name="l08157"></a>08157           dy: current.screenY - d.start.screenY
<a name="l08158"></a>08158         },
<a name="l08159"></a>08159         relative: {
<a name="l08160"></a>08160           dx: current.screenX - d.last.screenX,
<a name="l08161"></a>08161           dy: current.screenY - d.last.screenY
<a name="l08162"></a>08162         },
<a name="l08163"></a>08163         <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>: current
<a name="l08164"></a>08164       });
<a name="l08165"></a>08165 
<a name="l08166"></a>08166       d.last = current;
<a name="l08167"></a>08167     },
<a name="l08168"></a>08168 
<a name="l08169"></a>08169     mouseup: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l08170"></a>08170       var current = mouseCoordinates(e);
<a name="l08171"></a>08171       d.emitEvent(<span class="stringliteral">&#39;holdend&#39;</span>, {
<a name="l08172"></a>08172         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: d.start,
<a name="l08173"></a>08173         <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: current,
<a name="l08174"></a>08174         dx: current.screenX - d.start.screenX,
<a name="l08175"></a>08175         dy: current.screenY - d.start.screenY
<a name="l08176"></a>08176       });
<a name="l08177"></a>08177       d.switchTo(initialState);
<a name="l08178"></a>08178     }
<a name="l08179"></a>08179   };
<a name="l08180"></a>08180 
<a name="l08181"></a>08181   var mousePannedState = {
<a name="l08182"></a>08182     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;mousePannedState&#39;</span>,
<a name="l08183"></a>08183     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l08184"></a>08184       <span class="comment">// Panning doesn&#39;t start until the mouse has moved more than</span>
<a name="l08185"></a>08185       <span class="comment">// a certain threshold. But we don&#39;t want the pan to have a jerky</span>
<a name="l08186"></a>08186       <span class="comment">// start where the first event is a big distance. So reset the</span>
<a name="l08187"></a>08187       <span class="comment">// starting point to a point between the start point and this</span>
<a name="l08188"></a>08188       <span class="comment">// current point</span>
<a name="l08189"></a>08189       d.start = d.last = between(d.start, mouseCoordinates(e));
<a name="l08190"></a>08190 
<a name="l08191"></a>08191       <span class="comment">// If we transition into this state with a mousemove event,</span>
<a name="l08192"></a>08192       <span class="comment">// then process it with that handler. If we don&#39;t do this then</span>
<a name="l08193"></a>08193       <span class="comment">// we can end up with swipe events that don&#39;t know their velocity</span>
<a name="l08194"></a>08194       <span class="keywordflow">if</span> (e.type === <span class="stringliteral">&#39;mousemove&#39;</span>)
<a name="l08195"></a>08195         mousePannedState.mousemove(d, e);
<a name="l08196"></a>08196     },
<a name="l08197"></a>08197     mousemove: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l08198"></a>08198       <span class="comment">// Each time the mouse moves, emit a pan event but stay in this state</span>
<a name="l08199"></a>08199       var current = mouseCoordinates(e);
<a name="l08200"></a>08200       d.emitEvent(<span class="stringliteral">&#39;pan&#39;</span>, {
<a name="l08201"></a>08201         <a class="code" href="../../d2/d24/ns_i_d_o_m_device_orientation_event_8idl.html#a222123d2d3c1565be680f5bc7bc92eb7">absolute</a>: {
<a name="l08202"></a>08202           dx: current.screenX - d.start.screenX,
<a name="l08203"></a>08203           dy: current.screenY - d.start.screenY
<a name="l08204"></a>08204         },
<a name="l08205"></a>08205         relative: {
<a name="l08206"></a>08206           dx: current.screenX - d.last.screenX,
<a name="l08207"></a>08207           dy: current.screenY - d.last.screenY
<a name="l08208"></a>08208         },
<a name="l08209"></a>08209         <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#acd1cdae9d6d8493a6f34d308f8259f55">position</a>: current
<a name="l08210"></a>08210       });
<a name="l08211"></a>08211 
<a name="l08212"></a>08212       <span class="comment">// Track the pan velocity so we can report this with the swipe</span>
<a name="l08213"></a>08213       <span class="comment">// Use a exponential moving average for a bit of smoothing</span>
<a name="l08214"></a>08214       <span class="comment">// on the velocity</span>
<a name="l08215"></a>08215       var dt = current.timeStamp - d.last.timeStamp;
<a name="l08216"></a>08216       var vx = (current.screenX - d.last.screenX) / dt;
<a name="l08217"></a>08217       var vy = (current.screenY - d.last.screenY) / dt;
<a name="l08218"></a>08218 
<a name="l08219"></a>08219       <span class="keywordflow">if</span> (d.vx == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) { <span class="comment">// first time; no average</span>
<a name="l08220"></a>08220         d.vx = vx;
<a name="l08221"></a>08221         d.vy = vy;
<a name="l08222"></a>08222       }
<a name="l08223"></a>08223       <span class="keywordflow">else</span> {
<a name="l08224"></a>08224         d.vx = d.vx * GD.VELOCITY_SMOOTHING +
<a name="l08225"></a>08225           vx * (1 - GD.VELOCITY_SMOOTHING);
<a name="l08226"></a>08226         d.vy = d.vy * GD.VELOCITY_SMOOTHING +
<a name="l08227"></a>08227           vy * (1 - GD.VELOCITY_SMOOTHING);
<a name="l08228"></a>08228       }
<a name="l08229"></a>08229 
<a name="l08230"></a>08230       d.last = current;
<a name="l08231"></a>08231     },
<a name="l08232"></a>08232     mouseup: <span class="keyword">function</span>(d, <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l08233"></a>08233       <span class="comment">// Remove the capturing event handlers</span>
<a name="l08234"></a>08234       var doc = d.element.ownerDocument;
<a name="l08235"></a>08235       doc.removeEventListener(<span class="stringliteral">&#39;mousemove&#39;</span>, d, <span class="keyword">true</span>);
<a name="l08236"></a>08236       doc.removeEventListener(<span class="stringliteral">&#39;mouseup&#39;</span>, d, <span class="keyword">true</span>);
<a name="l08237"></a>08237 
<a name="l08238"></a>08238       <span class="comment">// Emit a swipe event when the mouse goes up.</span>
<a name="l08239"></a>08239       <span class="comment">// Report start and end point, dx, dy, dt, velocity and direction</span>
<a name="l08240"></a>08240       var current = mouseCoordinates(e);
<a name="l08241"></a>08241 
<a name="l08242"></a>08242       <span class="comment">// FIXME:</span>
<a name="l08243"></a>08243       <span class="comment">// lots of code duplicated between this state and the corresponding</span>
<a name="l08244"></a>08244       <span class="comment">// touch state, can I combine them somehow?</span>
<a name="l08245"></a>08245       var dx = current.screenX - d.start.screenX;
<a name="l08246"></a>08246       var dy = current.screenY - d.start.screenY;
<a name="l08247"></a>08247       <span class="comment">// angle is a positive number of degrees, starting at 0 on the</span>
<a name="l08248"></a>08248       <span class="comment">// positive x axis and increasing clockwise.</span>
<a name="l08249"></a>08249       var angle = atan2(dy, dx) * 180 / PI;
<a name="l08250"></a>08250       <span class="keywordflow">if</span> (angle &lt; 0)
<a name="l08251"></a>08251         angle += 360;
<a name="l08252"></a>08252 
<a name="l08253"></a>08253       <span class="comment">// Direction is &#39;right&#39;, &#39;down&#39;, &#39;left&#39; or &#39;up&#39;</span>
<a name="l08254"></a>08254       var <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>;
<a name="l08255"></a>08255       <span class="keywordflow">if</span> (angle &gt;= 315 || angle &lt; 45)
<a name="l08256"></a>08256         direction = <span class="stringliteral">&#39;right&#39;</span>;
<a name="l08257"></a>08257       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 45 &amp;&amp; angle &lt; 135)
<a name="l08258"></a>08258         direction = <span class="stringliteral">&#39;down&#39;</span>;
<a name="l08259"></a>08259       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 135 &amp;&amp; angle &lt; 225)
<a name="l08260"></a>08260         direction = <span class="stringliteral">&#39;left&#39;</span>;
<a name="l08261"></a>08261       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt;= 225 &amp;&amp; angle &lt; 315)
<a name="l08262"></a>08262         direction = <span class="stringliteral">&#39;up&#39;</span>;
<a name="l08263"></a>08263 
<a name="l08264"></a>08264       d.emitEvent(<span class="stringliteral">&#39;swipe&#39;</span>, {
<a name="l08265"></a>08265         <a class="code" href="../../d7/dbf/build__stage_2email_2shared_2js_2media_2remote__controls_8js.html#afea9dd5375e7783397a6e3911cc64e28">start</a>: d.start,
<a name="l08266"></a>08266         <a class="code" href="../../d8/d64/ns_u_r_l_helper_8h.html#abe43fe84431eb0cabf3c21ccc94bd756">end</a>: current,
<a name="l08267"></a>08267         dx: dx,
<a name="l08268"></a>08268         dy: dy,
<a name="l08269"></a>08269         dt: current.timeStamp - d.start.timeStamp,
<a name="l08270"></a>08270         vx: d.vx,
<a name="l08271"></a>08271         vy: d.vy,
<a name="l08272"></a>08272         direction: <a class="code" href="../../d3/d91/j3d_8js.html#ad0dea711cdf3eaf35d6e1dfde0f163b3">direction</a>,
<a name="l08273"></a>08273         angle: angle
<a name="l08274"></a>08274       });
<a name="l08275"></a>08275 
<a name="l08276"></a>08276       <span class="comment">// Go back to the initial state</span>
<a name="l08277"></a>08277       d.switchTo(initialState);
<a name="l08278"></a>08278     }
<a name="l08279"></a>08279   };
<a name="l08280"></a>08280 
<a name="l08281"></a>08281   <span class="keywordflow">return</span> GD;
<a name="l08282"></a>08282 }());
<a name="l08283"></a>08283 
<a name="l08284"></a>08284 
<a name="l08285"></a>08285 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&quot;shared/js/gesture_detector&quot;</span>, <span class="keyword">function</span>(){});
<a name="l08286"></a>08286 
<a name="l08287"></a>08287 <span class="comment">/*jshint browser: true */</span>
<a name="l08288"></a>08288 <span class="comment">/*global console, define */</span>
<a name="l08289"></a>08289 
<a name="l08290"></a>08290 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;iframe_shims&#39;</span>,[<span class="stringliteral">&#39;shared/js/gesture_detector&#39;</span>], <span class="keyword">function</span>() {
<a name="l08291"></a>08291 
<a name="l08292"></a>08292 
<a name="l08293"></a>08293 
<a name="l08294"></a>08294 var GestureDetector = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.GestureDetector;
<a name="l08295"></a>08295 
<a name="l08305"></a>08305 var DEFAULT_STYLE_TAG =
<a name="l08306"></a>08306   <span class="stringliteral">&#39;&lt;style type=&quot;text/css&quot;&gt;\n&#39;</span> +
<a name="l08307"></a>08307   <span class="comment">// ## blockquote</span>
<a name="l08308"></a>08308   <span class="comment">// blockquote per html5: before: 1em, after: 1em, start: 4rem, end: 4rem</span>
<a name="l08309"></a>08309   <span class="stringliteral">&#39;blockquote {&#39;</span> +
<a name="l08310"></a>08310   <span class="stringliteral">&#39;margin: 0; &#39;</span> +
<a name="l08311"></a>08311   <span class="comment">// so, this is quoting styling, which makes less sense to have in here.</span>
<a name="l08312"></a>08312   <span class="stringliteral">&#39;border-left: 0.2rem solid gray;&#39;</span> +
<a name="l08313"></a>08313   <span class="comment">// padding-start isn&#39;t a thing yet, somehow.</span>
<a name="l08314"></a>08314   <span class="stringliteral">&#39;padding: 0; -moz-padding-start: 0.5rem; &#39;</span> +
<a name="l08315"></a>08315   <span class="stringliteral">&#39;}\n&#39;</span> +
<a name="l08316"></a>08316   <span class="comment">// Give the layout engine an upper-bound on the width that&#39;s arguably</span>
<a name="l08317"></a>08317   <span class="comment">// much wider than anyone should find reasonable, but might save us from</span>
<a name="l08318"></a>08318   <span class="comment">// super pathological cases.</span>
<a name="l08319"></a>08319   <span class="stringliteral">&#39;html, body { max-width: 120rem; }\n&#39;</span> +
<a name="l08320"></a>08320   <span class="comment">// pre messes up wrapping very badly if left to its own devices</span>
<a name="l08321"></a>08321   <span class="stringliteral">&#39;pre { white-space: pre-wrap; }\n&#39;</span> +
<a name="l08322"></a>08322   <span class="stringliteral">&#39;.moz-external-link { color: blue; cursor: pointer; }\n&#39;</span> +
<a name="l08323"></a>08323   <span class="stringliteral">&#39;&lt;/style&gt;&#39;</span>;
<a name="l08324"></a>08324 
<a name="l08464"></a>08464 <span class="keyword">function</span> createAndInsertIframeForContent(htmlStr, scrollContainer,
<a name="l08465"></a>08465                                          parentNode, beforeNode,
<a name="l08466"></a>08466                                          interactiveMode,
<a name="l08467"></a>08467                                          clickHandler) {
<a name="l08468"></a>08468   <span class="comment">// Add padding to compensate for scroll-bars in environments (Firefox, not</span>
<a name="l08469"></a>08469   <span class="comment">// b2g) where they can show up and cause themselves to exist in perpetuity.</span>
<a name="l08470"></a>08470   var scrollPad = 16;
<a name="l08471"></a>08471 
<a name="l08472"></a>08472   var viewportWidth = parentNode.offsetWidth - scrollPad;
<a name="l08473"></a>08473   var viewport = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createElement(<span class="stringliteral">&#39;div&#39;</span>);
<a name="l08474"></a>08474   var title = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(<span class="stringliteral">&#39;msg-reader-header&#39;</span>)[0];
<a name="l08475"></a>08475   var header = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(<span class="stringliteral">&#39;msg-envelope-bar&#39;</span>)[0];
<a name="l08476"></a>08476   var extraHeight = title.clientHeight + header.clientHeight;
<a name="l08477"></a>08477   viewport.setAttribute(
<a name="l08478"></a>08478     <span class="stringliteral">&#39;style&#39;</span>,
<a name="l08479"></a>08479     <span class="stringliteral">&#39;overflow: hidden; position: relative; &#39;</span> +
<a name="l08480"></a>08480     <span class="stringliteral">&#39;width: 100%;&#39;</span>);
<a name="l08481"></a>08481   var iframe = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createElement(<span class="stringliteral">&#39;iframe&#39;</span>);
<a name="l08482"></a>08482 
<a name="l08483"></a>08483   iframe.setAttribute(<span class="stringliteral">&#39;sandbox&#39;</span>, <span class="stringliteral">&#39;allow-same-origin&#39;</span>);
<a name="l08484"></a>08484   <span class="comment">// Styling!</span>
<a name="l08485"></a>08485   <span class="comment">// - no visible border</span>
<a name="l08486"></a>08486   <span class="comment">// - we want to approximate seamless, so turn off overflow and we&#39;ll resize</span>
<a name="l08487"></a>08487   <span class="comment">//   things below.</span>
<a name="l08488"></a>08488   <span class="comment">// - 60rem wide; this is approximately the standard expected width for HTML</span>
<a name="l08489"></a>08489   <span class="comment">//   emails.</span>
<a name="l08490"></a>08490   iframe.setAttribute(
<a name="l08491"></a>08491     <span class="stringliteral">&#39;style&#39;</span>,
<a name="l08492"></a>08492     <span class="stringliteral">&#39;position: absolute; &#39;</span> +
<a name="l08493"></a>08493     <span class="stringliteral">&#39;border-width: 0;&#39;</span> +
<a name="l08494"></a>08494     <span class="stringliteral">&#39;overflow: hidden;&#39;</span>
<a name="l08495"></a>08495 <span class="comment">//    &#39;pointer-events: none; &#39; +</span>
<a name="l08496"></a>08496 <span class="comment">//    &#39;-moz-user-select: none; &#39; +</span>
<a name="l08497"></a>08497 <span class="comment">//    &#39;width: &#39; + (scrollWidth) + &#39;px; &#39; +</span>
<a name="l08498"></a>08498 <span class="comment">//    &#39;height: &#39; + (viewportHeight) + &#39;px;&#39;</span>
<a name="l08499"></a>08499   );
<a name="l08500"></a>08500   viewport.appendChild(iframe);
<a name="l08501"></a>08501   parentNode.insertBefore(viewport, beforeNode);
<a name="l08502"></a>08502   <span class="comment">//iframe.setAttribute(&#39;srcdoc&#39;, htmlStr);</span>
<a name="l08503"></a>08503 
<a name="l08504"></a>08504   <span class="comment">// we want this fully synchronous so we can know the size of the document</span>
<a name="l08505"></a>08505   iframe.contentDocument.open();
<a name="l08506"></a>08506   iframe.contentDocument.write(<span class="stringliteral">&#39;&lt;!doctype html&gt;&lt;html&gt;&lt;head&gt;&#39;</span>);
<a name="l08507"></a>08507   iframe.contentDocument.write(DEFAULT_STYLE_TAG);
<a name="l08508"></a>08508   iframe.contentDocument.write(<span class="stringliteral">&#39;&lt;/head&gt;&lt;body&gt;&#39;</span>);
<a name="l08509"></a>08509   <span class="comment">// (currently our sanitization only generates a body payload...)</span>
<a name="l08510"></a>08510   iframe.contentDocument.write(htmlStr);
<a name="l08511"></a>08511   iframe.contentDocument.write(<span class="stringliteral">&#39;&lt;/body&gt;&#39;</span>);
<a name="l08512"></a>08512   iframe.contentDocument.close();
<a name="l08513"></a>08513   var iframeBody = iframe.contentDocument.documentElement;
<a name="l08514"></a>08514   var scrollWidth = iframeBody.scrollWidth;
<a name="l08515"></a>08515   var scrollHeight = iframeBody.scrollHeight;
<a name="l08516"></a>08516 
<a name="l08517"></a>08517   var newsletterMode = scrollWidth &gt; viewportWidth,
<a name="l08518"></a>08518       resizeFrame;
<a name="l08519"></a>08519 
<a name="l08520"></a>08520   var <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a> = Math.min(1, viewportWidth / scrollWidth),
<a name="l08521"></a>08521       baseScale = <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>,
<a name="l08522"></a>08522       lastScale = <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>,
<a name="l08523"></a>08523       scaleMode = 0;
<a name="l08524"></a>08524 
<a name="l08525"></a>08525   viewport.setAttribute(
<a name="l08526"></a>08526     <span class="stringliteral">&#39;style&#39;</span>,
<a name="l08527"></a>08527     <span class="stringliteral">&#39;padding: 0; border-width: 0; margin: 0; &#39;</span> +
<a name="l08528"></a>08528     <span class="stringliteral">&#39;position: relative; &#39;</span> +
<a name="l08529"></a>08529     <span class="stringliteral">&#39;overflow: hidden;&#39;</span>);
<a name="l08530"></a>08530   viewport.style.width = (scrollWidth * <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>) + <span class="stringliteral">&#39;px&#39;</span>;
<a name="l08531"></a>08531   viewport.style.height = (scrollHeight * <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>) + <span class="stringliteral">&#39;px&#39;</span>;
<a name="l08532"></a>08532 
<a name="l08533"></a>08533   <span class="comment">// setting iframe.style.height is not sticky, so be heavy-handed.</span>
<a name="l08534"></a>08534   <span class="comment">// Also, do not set overflow: hidden since we are already clipped by our</span>
<a name="l08535"></a>08535   <span class="comment">// viewport or our containing card and Gecko slows down a lot because of the</span>
<a name="l08536"></a>08536   <span class="comment">// extra clipping.</span>
<a name="l08537"></a>08537   iframe.setAttribute(
<a name="l08538"></a>08538     <span class="stringliteral">&#39;style&#39;</span>,
<a name="l08539"></a>08539     <span class="stringliteral">&#39;padding: 0; border-width: 0; margin: 0; &#39;</span> +
<a name="l08540"></a>08540     <span class="stringliteral">&#39;transform-origin: top left; &#39;</span> +
<a name="l08541"></a>08541     <span class="stringliteral">&#39;pointer-events: none;&#39;</span>);
<a name="l08542"></a>08542   iframe.style.width = scrollWidth + <span class="stringliteral">&#39;px&#39;</span>;
<a name="l08543"></a>08543 
<a name="l08544"></a>08544   resizeFrame = <span class="keyword">function</span>(updateHeight) {
<a name="l08545"></a>08545     <span class="keywordflow">if</span> (updateHeight) {
<a name="l08546"></a>08546       iframe.style.height = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08547"></a>08547       scrollHeight = iframeBody.scrollHeight;
<a name="l08548"></a>08548     }
<a name="l08549"></a>08549     <span class="keywordflow">if</span> (scale !== 1)
<a name="l08550"></a>08550       iframe.style.transform = <span class="stringliteral">&#39;scale(&#39;</span> + scale + <span class="charliteral">&#39;)&#39;</span>;
<a name="l08551"></a>08551     <span class="keywordflow">else</span>
<a name="l08552"></a>08552       iframe.style.transform = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08553"></a>08553     iframe.style.height =
<a name="l08554"></a>08554       ((scrollHeight * Math.max(1, scale)) + scrollPad) + <span class="stringliteral">&#39;px&#39;</span>;
<a name="l08555"></a>08555     viewport.style.width = (scrollWidth * <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>) + <span class="stringliteral">&#39;px&#39;</span>;
<a name="l08556"></a>08556     viewport.style.height = ((scrollHeight * <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>) + scrollPad) + <span class="stringliteral">&#39;px&#39;</span>;
<a name="l08557"></a>08557   };
<a name="l08558"></a>08558   resizeFrame(<span class="keyword">true</span>);
<a name="l08559"></a>08559 
<a name="l08560"></a>08560   var zoomFrame = <span class="keyword">function</span>(newScale, centerX, centerY) {
<a name="l08561"></a>08561     <span class="keywordflow">if</span> (newScale === scale)
<a name="l08562"></a>08562       <span class="keywordflow">return</span>;
<a name="l08563"></a>08563 
<a name="l08564"></a>08564     <span class="comment">// Our goal is to figure out how to scroll the window so that the</span>
<a name="l08565"></a>08565     <span class="comment">// location on the iframe corresponding to centerX/centerY maintains</span>
<a name="l08566"></a>08566     <span class="comment">// its position after zooming.</span>
<a name="l08567"></a>08567 
<a name="l08568"></a>08568     <span class="comment">// centerX, centerY  are in screen coordinates.  Offset coordinates of</span>
<a name="l08569"></a>08569     <span class="comment">// the scrollContainer are screen (card) relative, but those of things</span>
<a name="l08570"></a>08570     <span class="comment">// inside the scrollContainer exist within that coordinate space and</span>
<a name="l08571"></a>08571     <span class="comment">// do not change as we scroll.</span>
<a name="l08572"></a>08572     <span class="comment">// console.log(&#39;----ZOOM from&#39;, scale, &#39;to&#39;, newScale);</span>
<a name="l08573"></a>08573     <span class="comment">// console.log(&#39;cx&#39;, centerX, &#39;cy&#39;, centerY,</span>
<a name="l08574"></a>08574     <span class="comment">//             &#39;vl&#39;, viewport.offsetLeft,</span>
<a name="l08575"></a>08575     <span class="comment">//             &#39;vt&#39;, viewport.offsetTop);</span>
<a name="l08576"></a>08576     <span class="comment">// console.log(&#39;sl&#39;, scrollContainer.offsetLeft,</span>
<a name="l08577"></a>08577     <span class="comment">//             &#39;st&#39;, scrollContainer.offsetTop);</span>
<a name="l08578"></a>08578 
<a name="l08579"></a>08579     <span class="comment">// Figure out how much of our iframe is scrolled off the screen.</span>
<a name="l08580"></a>08580     var iframeScrolledTop = scrollContainer.scrollTop - extraHeight,
<a name="l08581"></a>08581         iframeScrolledLeft = scrollContainer.scrollLeft;
<a name="l08582"></a>08582 
<a name="l08583"></a>08583     <span class="comment">// and now convert those into iframe-relative coords</span>
<a name="l08584"></a>08584     var ix = centerX + iframeScrolledLeft,
<a name="l08585"></a>08585         iy = centerY + iframeScrolledTop;
<a name="l08586"></a>08586 
<a name="l08587"></a>08587     var scaleDelta = (newScale / <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>);
<a name="l08588"></a>08588 
<a name="l08589"></a>08589     var vertScrollDelta = iy * scaleDelta,
<a name="l08590"></a>08590         horizScrollDelta = ix * scaleDelta;
<a name="l08591"></a>08591 
<a name="l08592"></a>08592     scale = newScale;
<a name="l08593"></a>08593     resizeFrame();
<a name="l08594"></a>08594     scrollContainer.scrollTop = vertScrollDelta + extraHeight - centerY;
<a name="l08595"></a>08595     scrollContainer.scrollLeft = horizScrollDelta - centerX;
<a name="l08596"></a>08596   };
<a name="l08597"></a>08597 
<a name="l08598"></a>08598   var iframeShims = {
<a name="l08599"></a>08599     iframe: iframe,
<a name="l08600"></a>08600     <a class="code" href="../../db/d0b/_image_editor_8js.html#a949ea6f42ae029faa03eb19facfa08b0">resizeHandler</a>: <span class="keyword">function</span>() {
<a name="l08601"></a>08601       resizeFrame(<span class="keyword">true</span>);
<a name="l08602"></a>08602     }
<a name="l08603"></a>08603   };
<a name="l08604"></a>08604   var detectorTarget = viewport;
<a name="l08605"></a>08605   var detector = <span class="keyword">new</span> <a class="code" href="../../d8/df0/frames_8js.html#a050c35bd1ae66a249cd6c3554661e24a">GestureDetector</a>(detectorTarget);
<a name="l08606"></a>08606   <span class="comment">// We don&#39;t need to ever stopDetecting since the closures that keep it</span>
<a name="l08607"></a>08607   <span class="comment">// alive are just the event listeners on the iframe.</span>
<a name="l08608"></a>08608   detector.startDetecting();
<a name="l08609"></a>08609   <span class="comment">// Using tap gesture event for URL link handling.</span>
<a name="l08610"></a>08610   <span class="keywordflow">if</span> (clickHandler) {
<a name="l08611"></a>08611     viewport.removeEventListener(<span class="stringliteral">&#39;click&#39;</span>, clickHandler);
<a name="l08612"></a>08612     bindSanitizedClickHandler(viewport, clickHandler, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, iframe);
<a name="l08613"></a>08613   }
<a name="l08614"></a>08614   <span class="comment">// If mail is not newsletter mode, ignore zoom/dbtap event handling.</span>
<a name="l08615"></a>08615   <span class="keywordflow">if</span> (!newsletterMode || interactiveMode !== <span class="stringliteral">&#39;interactive&#39;</span>) {
<a name="l08616"></a>08616     <span class="keywordflow">return</span> iframeShims;
<a name="l08617"></a>08617   }
<a name="l08618"></a>08618   detectorTarget.addEventListener(<span class="stringliteral">&#39;dbltap&#39;</span>, <span class="keyword">function</span>(e) {
<a name="l08619"></a>08619     var newScale = <a class="code" href="../../d3/d91/j3d_8js.html#a72467d06af86da2230d0bd24ace66356">scale</a>;
<a name="l08620"></a>08620     <span class="keywordflow">if</span> (lastScale === scale) {
<a name="l08621"></a>08621       scaleMode = (scaleMode + 1) % 3;
<a name="l08622"></a>08622       <span class="keywordflow">switch</span> (scaleMode) {
<a name="l08623"></a>08623         <span class="keywordflow">case</span> 0:
<a name="l08624"></a>08624           newScale = baseScale;
<a name="l08625"></a>08625           <span class="keywordflow">break</span>;
<a name="l08626"></a>08626         <span class="keywordflow">case</span> 1:
<a name="l08627"></a>08627           newScale = 1;
<a name="l08628"></a>08628           <span class="keywordflow">break</span>;
<a name="l08629"></a>08629         <span class="keywordflow">case</span> 2:
<a name="l08630"></a>08630           newScale = 2;
<a name="l08631"></a>08631           <span class="keywordflow">break</span>;
<a name="l08632"></a>08632       }
<a name="l08633"></a>08633     }
<a name="l08634"></a>08634     <span class="keywordflow">else</span> {
<a name="l08635"></a>08635       <span class="comment">// If already zoomed in, zoom out to starting scale</span>
<a name="l08636"></a>08636       <span class="keywordflow">if</span> (scale &gt; 1) {
<a name="l08637"></a>08637         newScale = lastScale;
<a name="l08638"></a>08638         scaleMode = 0;
<a name="l08639"></a>08639       }
<a name="l08640"></a>08640       <span class="comment">// Otherwise zoom in to 2x</span>
<a name="l08641"></a>08641       <span class="keywordflow">else</span> {
<a name="l08642"></a>08642         newScale = 2;
<a name="l08643"></a>08643         scaleMode = 2;
<a name="l08644"></a>08644       }
<a name="l08645"></a>08645     }
<a name="l08646"></a>08646     lastScale = newScale;
<a name="l08647"></a>08647     <span class="keywordflow">try</span> {
<a name="l08648"></a>08648       zoomFrame(newScale, e.detail.clientX, e.detail.clientY);
<a name="l08649"></a>08649     } <span class="keywordflow">catch</span> (ex) {
<a name="l08650"></a>08650       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;zoom bug!&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l08651"></a>08651     }
<a name="l08652"></a>08652   });
<a name="l08653"></a>08653   detectorTarget.addEventListener(<span class="stringliteral">&#39;transform&#39;</span>, <span class="keyword">function</span>(e) {
<a name="l08654"></a>08654     var scaleFactor = e.detail.relative.scale;
<a name="l08655"></a>08655     var newScale = scale * scaleFactor;
<a name="l08656"></a>08656     <span class="comment">// Never zoom in farther than 2x</span>
<a name="l08657"></a>08657     <span class="keywordflow">if</span> (newScale &gt; 2) {
<a name="l08658"></a>08658       newScale = 2;
<a name="l08659"></a>08659     }
<a name="l08660"></a>08660     <span class="comment">// And never zoom out farther than baseScale</span>
<a name="l08661"></a>08661     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (newScale &lt; baseScale) {
<a name="l08662"></a>08662       newScale = baseScale;
<a name="l08663"></a>08663     }
<a name="l08664"></a>08664     zoomFrame(newScale,
<a name="l08665"></a>08665               e.detail.midpoint.clientX, e.detail.midpoint.clientY);
<a name="l08666"></a>08666   });
<a name="l08667"></a>08667 
<a name="l08668"></a>08668   <span class="keywordflow">return</span> iframeShims;
<a name="l08669"></a>08669 }
<a name="l08670"></a>08670 
<a name="l08671"></a>08671 <span class="keyword">function</span> bindSanitizedClickHandler(<a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a>, clickHandler, topNode, iframe) {
<a name="l08672"></a>08672   var eventType, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>;
<a name="l08673"></a>08673   <span class="comment">// Variables that only valid for HTML type mail.</span>
<a name="l08674"></a>08674   var <a class="code" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa5a506cf1e53b91549e35a5d3bc3dc06">title</a>, <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, attachmentsContainer, msgBodyContainer,
<a name="l08675"></a>08675       titleHeight, headerHeight, attachmentsHeight,
<a name="l08676"></a>08676       msgBodyMarginTop, msgBodyMarginLeft, attachmentsMarginTop,
<a name="l08677"></a>08677       iframeDoc, inputStyle;
<a name="l08678"></a>08678   <span class="comment">// Tap gesture event for HTML type mail and click event for plain text mail</span>
<a name="l08679"></a>08679   <span class="keywordflow">if</span> (iframe) {
<a name="l08680"></a>08680     root = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(<span class="stringliteral">&#39;scrollregion-horizontal-too&#39;</span>)[0];
<a name="l08681"></a>08681     title = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(<span class="stringliteral">&#39;msg-reader-header&#39;</span>)[0];
<a name="l08682"></a>08682     header = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(<span class="stringliteral">&#39;msg-envelope-bar&#39;</span>)[0];
<a name="l08683"></a>08683     attachmentsContainer =
<a name="l08684"></a>08684       <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(<span class="stringliteral">&#39;msg-attachments-container&#39;</span>)[0];
<a name="l08685"></a>08685     msgBodyContainer = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementsByClassName(<span class="stringliteral">&#39;msg-body-container&#39;</span>)[0];
<a name="l08686"></a>08686     inputStyle = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.getComputedStyle(msgBodyContainer);
<a name="l08687"></a>08687     msgBodyMarginTop = parseInt(inputStyle.marginTop);
<a name="l08688"></a>08688     msgBodyMarginLeft = parseInt(inputStyle.marginLeft);
<a name="l08689"></a>08689     titleHeight = title.clientHeight;
<a name="l08690"></a>08690     headerHeight = header.clientHeight;
<a name="l08691"></a>08691     eventType = <span class="stringliteral">&#39;tap&#39;</span>;
<a name="l08692"></a>08692     iframeDoc = iframe.contentDocument;
<a name="l08693"></a>08693   } <span class="keywordflow">else</span> {
<a name="l08694"></a>08694     eventType = <span class="stringliteral">&#39;click&#39;</span>;
<a name="l08695"></a>08695   }
<a name="l08696"></a>08696   <a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a>.addEventListener(
<a name="l08697"></a>08697     eventType,
<a name="l08698"></a>08698     <span class="keyword">function</span> clicked(event) {
<a name="l08699"></a>08699       <span class="keywordflow">if</span> (iframe) {
<a name="l08700"></a>08700         <span class="comment">// Because the attachments are updating late,</span>
<a name="l08701"></a>08701         <span class="comment">// get the client height while clicking iframe.</span>
<a name="l08702"></a>08702         attachmentsHeight = attachmentsContainer.clientHeight;
<a name="l08703"></a>08703         inputStyle = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.getComputedStyle(attachmentsContainer);
<a name="l08704"></a>08704         attachmentsMarginTop =
<a name="l08705"></a>08705           (attachmentsHeight) ? parseInt(inputStyle.marginTop) : 0;
<a name="l08706"></a>08706         var dx, dy;
<a name="l08707"></a>08707         var <a class="code" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a16f1a2d59c558394e62fa83237fbd076">transform</a> = iframe.style.transform || <span class="stringliteral">&#39;scale(1)&#39;</span>;
<a name="l08708"></a>08708         var scale = transform.match(/(\d|\.)+/<a class="code" href="../../d8/dad/apps_2email_2js_2ext_2mailapi_2chewlayer_8js.html#a73c18c59a39b18382081ec00bb456d43">g</a>)[0];
<a name="l08709"></a>08709         dx = <span class="keyword">event</span>.detail.clientX + root.scrollLeft - msgBodyMarginLeft;
<a name="l08710"></a>08710         dy = <span class="keyword">event</span>.detail.clientY + root.scrollTop -
<a name="l08711"></a>08711              titleHeight - headerHeight -
<a name="l08712"></a>08712              attachmentsHeight - attachmentsMarginTop - msgBodyMarginTop;
<a name="l08713"></a>08713         node = iframeDoc.elementFromPoint(dx / scale, dy / scale);
<a name="l08714"></a>08714       } <span class="keywordflow">else</span> {
<a name="l08715"></a>08715         node = <span class="keyword">event</span>.originalTarget;
<a name="l08716"></a>08716       }
<a name="l08717"></a>08717       <span class="keywordflow">while</span> (node !== topNode) {
<a name="l08718"></a>08718         <span class="keywordflow">if</span> (node.nodeName === <span class="charliteral">&#39;A&#39;</span>) {
<a name="l08719"></a>08719           <span class="keywordflow">if</span> (node.hasAttribute(<span class="stringliteral">&#39;ext-href&#39;</span>)) {
<a name="l08720"></a>08720             clickHandler(event, node, node.getAttribute(<span class="stringliteral">&#39;ext-href&#39;</span>),
<a name="l08721"></a>08721                          node.textContent);
<a name="l08722"></a>08722             <span class="keyword">event</span>.preventDefault();
<a name="l08723"></a>08723             <span class="keyword">event</span>.stopPropagation();
<a name="l08724"></a>08724             <span class="keywordflow">return</span>;
<a name="l08725"></a>08725           }
<a name="l08726"></a>08726         }
<a name="l08727"></a>08727         node = node.parentNode;
<a name="l08728"></a>08728       }
<a name="l08729"></a>08729     });
<a name="l08730"></a>08730 }
<a name="l08731"></a>08731 
<a name="l08732"></a>08732 <span class="keywordflow">return</span> {
<a name="l08733"></a>08733   createAndInsertIframeForContent: createAndInsertIframeForContent,
<a name="l08734"></a>08734   bindSanitizedClickHandler: bindSanitizedClickHandler
<a name="l08735"></a>08735 };
<a name="l08736"></a>08736 
<a name="l08737"></a>08737 });
<a name="l08738"></a>08738 
<a name="l08739"></a>08739 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;tmpl!cards/folder_picker.html&#39;</span>,[<span class="stringliteral">&#39;tmpl&#39;</span>], <span class="keyword">function</span> (tmpl) { <span class="keywordflow">return</span> tmpl.toDom(<span class="stringliteral">&#39;&lt;div class=&quot;card-folder-picker card&quot;&gt;\n  &lt;section class=&quot;fld-folders-header skin-organic&quot; role=&quot;region&quot;&gt;\n    &lt;header&gt;\n      &lt;a href=&quot;#&quot; class=&quot;fld-accounts-btn&quot;&gt;\n        &lt;span class=&quot;icon icon-back&quot;&gt;&lt;/span&gt;\n      &lt;/a&gt;\n      &lt;h1 class=&quot;fld-folders-header-account-label&quot;&gt;&lt;/h1&gt;\n    &lt;/header&gt;\n  &lt;/section&gt;\n  &lt;div class=&quot;scrollregion-below-header folder-scroller-region&quot;&gt;\n    &lt;div class=&quot;fld-folders-container&quot;&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n  &lt;div class=&quot;fld-nav-toolbar bottom-toolbar&quot;&gt;\n    &lt;button class=&quot;fld-nav-settings-btn bottom-btn&quot;&gt;&lt;/button&gt;\n    &lt;h3 class=&quot;fld-nav-last-synced&quot;&gt;\n      &lt;span class=&quot;fld-nav-last-synced-label&quot;\n            data-l10n-id=&quot;account-last-synced-label&quot;&gt;&lt;/span&gt;\n      &lt;span class=&quot;fld-nav-last-synced-value&quot;&gt;&lt;/span&gt;\n    &lt;/h3&gt;\n    &lt;span class=&quot;fld-nav-account-problem icon collapsed&quot;&gt;!&lt;/span&gt;\n  &lt;/div&gt;\n&lt;/div&gt;&#39;</span>); });
<a name="l08740"></a>08740 
<a name="l08741"></a>08741 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;tmpl!cards/fld/folder_item.html&#39;</span>,[<span class="stringliteral">&#39;tmpl&#39;</span>], <span class="keyword">function</span> (tmpl) { <span class="keywordflow">return</span> tmpl.toDom(<span class="stringliteral">&#39;&lt;a class=&quot;fld-folder-item&quot;&gt;\n  &lt;span class=&quot;fld-folder-name&quot;&gt;&lt;/span&gt;\n  &lt;span class=&quot;fld-folder-unread&quot;&gt;&lt;/span&gt;\n&lt;/a&gt;&#39;</span>); });
<a name="l08742"></a>08742 
<a name="l08743"></a>08743 <span class="comment">/*global define */</span>
<a name="l08744"></a>08744 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;date&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;mail_common&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>) {
<a name="l08745"></a>08745   <span class="comment">// TODO: move common date functions from mail_common into here over time,</span>
<a name="l08746"></a>08746   <span class="comment">// and then remove this dependency.</span>
<a name="l08747"></a>08747   var common = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;mail_common&#39;</span>);
<a name="l08748"></a>08748 
<a name="l08749"></a>08749   var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> = {
<a name="l08756"></a>08756     setPrettyNodeDate: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>, timestamp) {
<a name="l08757"></a>08757       <span class="keywordflow">if</span> (timestamp) {
<a name="l08758"></a>08758         node.dataset.time = timestamp.valueOf();
<a name="l08759"></a>08759         node.dataset.compactFormat = <span class="keyword">true</span>;
<a name="l08760"></a>08760         node.textContent = common.prettyDate(timestamp, <span class="keyword">true</span>);
<a name="l08761"></a>08761       } <span class="keywordflow">else</span> {
<a name="l08762"></a>08762         node.textContent = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08763"></a>08763         node.removeAttribute(<span class="stringliteral">&#39;data-time&#39;</span>);
<a name="l08764"></a>08764       }
<a name="l08765"></a>08765     }
<a name="l08766"></a>08766   };
<a name="l08767"></a>08767 
<a name="l08768"></a>08768   <span class="keywordflow">return</span> <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>;
<a name="l08769"></a>08769 });
<a name="l08770"></a>08770 
<a name="l08771"></a>08771 <span class="comment">// Loader plugin for loading CSS. Does not guarantee loading via onload</span>
<a name="l08772"></a>08772 <span class="comment">// watching, just inserts link tag.</span>
<a name="l08773"></a>08773 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;css&#39;</span>,{
<a name="l08774"></a>08774   <a class="code" href="../../db/d6b/make__gaia__shared_8js.html#ac5aa547163f784b68be607a47eb170b1">load</a>: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>, <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>, <a class="code" href="../../d8/deb/share_8js.html#ae63fb598d93a4bb590d74a27b9398c71">onload</a>, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>) {
<a name="l08775"></a>08775     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.isBuild) {
<a name="l08776"></a>08776         <span class="keywordflow">return</span> <a class="code" href="../../d8/deb/share_8js.html#ae63fb598d93a4bb590d74a27b9398c71">onload</a>();
<a name="l08777"></a>08777     }
<a name="l08778"></a>08778 
<a name="l08779"></a>08779     var style = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createElement(<span class="stringliteral">&#39;link&#39;</span>);
<a name="l08780"></a>08780     style.type = <span class="stringliteral">&#39;text/css&#39;</span>;
<a name="l08781"></a>08781     style.rel = <span class="stringliteral">&#39;stylesheet&#39;</span>;
<a name="l08782"></a>08782     style.href = require.toUrl(<span class="keywordtype">id</span> + <span class="stringliteral">&#39;.css&#39;</span>);
<a name="l08783"></a>08783     style.addEventListener(<span class="stringliteral">&#39;load&#39;</span>, onload, <span class="keyword">false</span>);
<a name="l08784"></a>08784     <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.head.appendChild(style);
<a name="l08785"></a>08785   }
<a name="l08786"></a>08786 });
<a name="l08787"></a>08787 
<a name="l08788"></a>08788 <span class="comment">/*global define */</span>
<a name="l08789"></a>08789 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;cards/folder_picker&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;tmpl!./folder_picker.html&#39;</span>,<span class="stringliteral">&#39;tmpl!./fld/folder_item.html&#39;</span>,<span class="stringliteral">&#39;folder_depth_classes&#39;</span>,<span class="stringliteral">&#39;mail_common&#39;</span>,<span class="stringliteral">&#39;date&#39;</span>,<span class="stringliteral">&#39;model&#39;</span>,<span class="stringliteral">&#39;l10n!&#39;</span>,<span class="stringliteral">&#39;css!style/folder_cards&#39;</span>],<span class="keyword">function</span>(require) {
<a name="l08790"></a>08790 
<a name="l08791"></a>08791 var templateNode = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;tmpl!./folder_picker.html&#39;</span>),
<a name="l08792"></a>08792     fldFolderItemNode = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;tmpl!./fld/folder_item.html&#39;</span>),
<a name="l08793"></a>08793     FOLDER_DEPTH_CLASSES = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;folder_depth_classes&#39;</span>),
<a name="l08794"></a>08794     common = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;mail_common&#39;</span>),
<a name="l08795"></a>08795     date = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;date&#39;</span>),
<a name="l08796"></a>08796     model = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;model&#39;</span>),
<a name="l08797"></a>08797     <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a> = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;l10n!&#39;</span>),
<a name="l08798"></a>08798     Cards = common.Cards,
<a name="l08799"></a>08799     bindContainerHandler = common.bindContainerHandler;
<a name="l08800"></a>08800 
<a name="l08801"></a>08801 <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;css!style/folder_cards&#39;</span>);
<a name="l08802"></a>08802 
<a name="l08803"></a>08803 <span class="keyword">function</span> FolderPickerCard(domNode, mode, args) {
<a name="l08804"></a>08804   this.domNode = domNode;
<a name="l08805"></a>08805 
<a name="l08806"></a>08806   this.foldersContainer =
<a name="l08807"></a>08807     domNode.getElementsByClassName(<span class="stringliteral">&#39;fld-folders-container&#39;</span>)[0];
<a name="l08808"></a>08808   bindContainerHandler(this.foldersContainer, <span class="stringliteral">&#39;click&#39;</span>,
<a name="l08809"></a>08809                        this.onClickFolder.bind(<span class="keyword">this</span>));
<a name="l08810"></a>08810 
<a name="l08811"></a>08811   this.accountButton = domNode.getElementsByClassName(<span class="stringliteral">&#39;fld-accounts-btn&#39;</span>)[0];
<a name="l08812"></a>08812   this.accountButton
<a name="l08813"></a>08813     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onShowAccounts.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l08814"></a>08814   domNode.getElementsByClassName(<span class="stringliteral">&#39;fld-nav-settings-btn&#39;</span>)[0]
<a name="l08815"></a>08815     .addEventListener(<span class="stringliteral">&#39;click&#39;</span>, this.onShowSettings.bind(<span class="keyword">this</span>), <span class="keyword">false</span>);
<a name="l08816"></a>08816 
<a name="l08817"></a>08817   this.toolbarAccountProblemNode =
<a name="l08818"></a>08818     domNode.getElementsByClassName(<span class="stringliteral">&#39;fld-nav-account-problem&#39;</span>)[0];
<a name="l08819"></a>08819   this.lastSyncedAtNode =
<a name="l08820"></a>08820     domNode.getElementsByClassName(<span class="stringliteral">&#39;fld-nav-last-synced-value&#39;</span>)[0];
<a name="l08821"></a>08821 
<a name="l08822"></a>08822   this._boundUpdateAccount = this.updateAccount.bind(<span class="keyword">this</span>);
<a name="l08823"></a>08823   model.latest(<span class="stringliteral">&#39;account&#39;</span>, this._boundUpdateAccount);
<a name="l08824"></a>08824 }
<a name="l08825"></a>08825 FolderPickerCard.prototype = {
<a name="l08826"></a>08826   nextCards: [<span class="stringliteral">&#39;settings_main&#39;</span>, <span class="stringliteral">&#39;account_picker&#39;</span>],
<a name="l08827"></a>08827 
<a name="l08828"></a>08828   onShowSettings: <span class="keyword">function</span>() {
<a name="l08829"></a>08829     Cards.pushCard(
<a name="l08830"></a>08830       <span class="stringliteral">&#39;settings_main&#39;</span>, <span class="stringliteral">&#39;default&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>, {}, <span class="stringliteral">&#39;left&#39;</span>);
<a name="l08831"></a>08831   },
<a name="l08832"></a>08832 
<a name="l08838"></a>08838   updateAccount: <span class="keyword">function</span>(account) {
<a name="l08839"></a>08839     var oldAccount = this.curAccount;
<a name="l08840"></a>08840 
<a name="l08841"></a>08841     this.mostRecentSyncTimestamp = 0;
<a name="l08842"></a>08842 
<a name="l08843"></a>08843     <span class="keywordflow">if</span> (oldAccount !== account) {
<a name="l08844"></a>08844       this.foldersContainer.innerHTML = <span class="stringliteral">&#39;&#39;</span>;
<a name="l08845"></a>08845       date.setPrettyNodeDate(this.lastSyncedAtNode);
<a name="l08846"></a>08846 
<a name="l08847"></a>08847       model.latestOnce(<span class="stringliteral">&#39;folder&#39;</span>, <span class="keyword">function</span>(folder) {
<a name="l08848"></a>08848         this.curAccount = account;
<a name="l08849"></a>08849 
<a name="l08850"></a>08850         <span class="comment">// - DOM!</span>
<a name="l08851"></a>08851         this.updateSelfDom();
<a name="l08852"></a>08852 
<a name="l08853"></a>08853         <span class="comment">// update header</span>
<a name="l08854"></a>08854         this.domNode
<a name="l08855"></a>08855             .getElementsByClassName(<span class="stringliteral">&#39;fld-folders-header-account-label&#39;</span>)[0]
<a name="l08856"></a>08856             .textContent = account.name;
<a name="l08857"></a>08857 
<a name="l08858"></a>08858         <span class="comment">// If no current folder, means this is the first startup, do some</span>
<a name="l08859"></a>08859         <span class="comment">// work to populate the</span>
<a name="l08860"></a>08860         <span class="keywordflow">if</span> (!this.curFolder) {
<a name="l08861"></a>08861           this.curFolder = folder;
<a name="l08862"></a>08862         }
<a name="l08863"></a>08863 
<a name="l08864"></a>08864         <span class="comment">// Clean up any old bindings.</span>
<a name="l08865"></a>08865         <span class="keywordflow">if</span> (this.foldersSlice) {
<a name="l08866"></a>08866           this.foldersSlice.onsplice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08867"></a>08867           this.foldersSlice.onchange = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l08868"></a>08868         }
<a name="l08869"></a>08869 
<a name="l08870"></a>08870         this.foldersSlice = model.foldersSlice;
<a name="l08871"></a>08871 
<a name="l08872"></a>08872         <span class="comment">// since the slice is already populated, generate a fake notification</span>
<a name="l08873"></a>08873         this.onFoldersSplice(0, 0, this.foldersSlice.items, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l08874"></a>08874 
<a name="l08875"></a>08875         <span class="comment">// Listen for changes in the foldersSlice.</span>
<a name="l08876"></a>08876         <span class="comment">// TODO: perhaps slices should implement an event listener</span>
<a name="l08877"></a>08877         <span class="comment">// interface vs. only allowing one handler. This is slightly</span>
<a name="l08878"></a>08878         <span class="comment">// dangerous in that other cards may access model.foldersSlice</span>
<a name="l08879"></a>08879         <span class="comment">// and could decide to set these handlers, wiping these ones</span>
<a name="l08880"></a>08880         <span class="comment">// out. However, so far folder_picker is the only one that cares</span>
<a name="l08881"></a>08881         <span class="comment">// about these dynamic updates.</span>
<a name="l08882"></a>08882         this.foldersSlice.onsplice = this.onFoldersSplice.bind(<span class="keyword">this</span>);
<a name="l08883"></a>08883         this.foldersSlice.onchange = this.onFoldersChange.bind(<span class="keyword">this</span>);
<a name="l08884"></a>08884       }.bind(<span class="keyword">this</span>));
<a name="l08885"></a>08885     }
<a name="l08886"></a>08886   },
<a name="l08887"></a>08887   onShowAccounts: <span class="keyword">function</span>() {
<a name="l08888"></a>08888     <span class="keywordflow">if</span> (!this.curAccount)
<a name="l08889"></a>08889       <span class="keywordflow">return</span>;
<a name="l08890"></a>08890 
<a name="l08891"></a>08891     <span class="comment">// Add account picker before this folder list.</span>
<a name="l08892"></a>08892     Cards.pushCard(
<a name="l08893"></a>08893       <span class="stringliteral">&#39;account_picker&#39;</span>, <span class="stringliteral">&#39;navigation&#39;</span>, <span class="stringliteral">&#39;animate&#39;</span>,
<a name="l08894"></a>08894       {
<a name="l08895"></a>08895         curAccountId: this.curAccount.id
<a name="l08896"></a>08896       },
<a name="l08897"></a>08897       <span class="comment">// Place to left of message list</span>
<a name="l08898"></a>08898       <span class="stringliteral">&#39;left&#39;</span>);
<a name="l08899"></a>08899   },
<a name="l08900"></a>08900 
<a name="l08901"></a>08901   onFoldersSplice: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>, howMany, addedItems,
<a name="l08902"></a>08902                              requested, moreExpected) {
<a name="l08903"></a>08903     var foldersContainer = this.foldersContainer;
<a name="l08904"></a>08904 
<a name="l08905"></a>08905     var folder;
<a name="l08906"></a>08906     <span class="keywordflow">if</span> (howMany) {
<a name="l08907"></a>08907       <span class="keywordflow">for</span> (var i = index + howMany - 1; i &gt;= <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>; i--) {
<a name="l08908"></a>08908         folder = this.foldersSlice.items[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l08909"></a>08909         foldersContainer.removeChild(folder.element);
<a name="l08910"></a>08910       }
<a name="l08911"></a>08911     }
<a name="l08912"></a>08912 
<a name="l08913"></a>08913     var dirtySyncTime = <span class="keyword">false</span>;
<a name="l08914"></a>08914     var insertBuddy = (index &gt;= foldersContainer.childElementCount) ?
<a name="l08915"></a>08915                         <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> : foldersContainer.children[index],
<a name="l08916"></a>08916         <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l08917"></a>08917     addedItems.forEach(<span class="keyword">function</span>(folder) {
<a name="l08918"></a>08918       var folderNode = folder.element = fldFolderItemNode.cloneNode(<span class="keyword">true</span>);
<a name="l08919"></a>08919       folderNode.folder = folder;
<a name="l08920"></a>08920       <span class="keyword">self</span>.updateFolderDom(folder, <span class="keyword">true</span>);
<a name="l08921"></a>08921       foldersContainer.insertBefore(folderNode, insertBuddy);
<a name="l08922"></a>08922 
<a name="l08923"></a>08923       <span class="keywordflow">if</span> (<span class="keyword">self</span>.mostRecentSyncTimestamp &lt; folder.lastSyncedAt) {
<a name="l08924"></a>08924         <span class="keyword">self</span>.mostRecentSyncTimestamp = folder.lastSyncedAt;
<a name="l08925"></a>08925         dirtySyncTime = <span class="keyword">true</span>;
<a name="l08926"></a>08926       }
<a name="l08927"></a>08927     });
<a name="l08928"></a>08928     <span class="keywordflow">if</span> (dirtySyncTime)
<a name="l08929"></a>08929       this.updateLastSyncedUI();
<a name="l08930"></a>08930   },
<a name="l08931"></a>08931 
<a name="l08932"></a>08932   onFoldersChange: <span class="keyword">function</span>(folder) {
<a name="l08933"></a>08933     <span class="keywordflow">if</span> (this.mostRecentSyncTimestamp &lt; folder.lastSyncedAt) {
<a name="l08934"></a>08934       this.mostRecentSyncTimestamp = folder.lastSyncedAt;
<a name="l08935"></a>08935       this.updateLastSyncedUI();
<a name="l08936"></a>08936     }
<a name="l08937"></a>08937   },
<a name="l08938"></a>08938 
<a name="l08939"></a>08939   updateLastSyncedUI: <span class="keyword">function</span>() {
<a name="l08940"></a>08940     <span class="keywordflow">if</span> (this.mostRecentSyncTimestamp) {
<a name="l08941"></a>08941       date.setPrettyNodeDate(this.lastSyncedAtNode,
<a name="l08942"></a>08942                              this.mostRecentSyncTimestamp);
<a name="l08943"></a>08943     } <span class="keywordflow">else</span> {
<a name="l08944"></a>08944       this.lastSyncedAtNode.textContent = <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;account-never-synced&#39;</span>);
<a name="l08945"></a>08945     }
<a name="l08946"></a>08946   },
<a name="l08947"></a>08947 
<a name="l08948"></a>08948   updateSelfDom: <span class="keyword">function</span>(isAccount) {
<a name="l08949"></a>08949     var str = isAccount ? <a class="code" href="../../da/dce/details__test_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">mozL10n</a>.get(<span class="stringliteral">&#39;settings-account-section&#39;</span>) :
<a name="l08950"></a>08950       this.curAccount.name;
<a name="l08951"></a>08951     this.domNode.getElementsByClassName(<span class="stringliteral">&#39;fld-folders-header-account-label&#39;</span>)[0]
<a name="l08952"></a>08952       .textContent = <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>;
<a name="l08953"></a>08953 
<a name="l08954"></a>08954     <span class="comment">// Update account problem status</span>
<a name="l08955"></a>08955     <span class="keywordflow">if</span> (this.curAccount.problems.length)
<a name="l08956"></a>08956       this.toolbarAccountProblemNode.classList.remove(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l08957"></a>08957     <span class="keywordflow">else</span>
<a name="l08958"></a>08958       this.toolbarAccountProblemNode.classList.add(<span class="stringliteral">&#39;collapsed&#39;</span>);
<a name="l08959"></a>08959   },
<a name="l08960"></a>08960 
<a name="l08961"></a>08961   updateFolderDom: <span class="keyword">function</span>(folder, firstTime) {
<a name="l08962"></a>08962     var folderNode = folder.element;
<a name="l08963"></a>08963 
<a name="l08964"></a>08964     <span class="keywordflow">if</span> (firstTime) {
<a name="l08965"></a>08965       <span class="keywordflow">if</span> (!folder.selectable)
<a name="l08966"></a>08966         folderNode.classList.add(<span class="stringliteral">&#39;fld-folder-unselectable&#39;</span>);
<a name="l08967"></a>08967 
<a name="l08968"></a>08968       var depthIdx = Math.min(FOLDER_DEPTH_CLASSES.length - 1, folder.depth);
<a name="l08969"></a>08969       folderNode.classList.add(FOLDER_DEPTH_CLASSES[depthIdx]);
<a name="l08970"></a>08970 
<a name="l08971"></a>08971       folderNode.getElementsByClassName(<span class="stringliteral">&#39;fld-folder-name&#39;</span>)[0]
<a name="l08972"></a>08972         .textContent = folder.name;
<a name="l08973"></a>08973     }
<a name="l08974"></a>08974 
<a name="l08975"></a>08975     <span class="keywordflow">if</span> (folder === this.curFolder)
<a name="l08976"></a>08976       folderNode.classList.add(<span class="stringliteral">&#39;fld-folder-selected&#39;</span>);
<a name="l08977"></a>08977     <span class="keywordflow">else</span>
<a name="l08978"></a>08978       folderNode.classList.remove(<span class="stringliteral">&#39;fld-folder-selected&#39;</span>);
<a name="l08979"></a>08979 
<a name="l08980"></a>08980     <span class="comment">// XXX do the unread count stuff once we have that info</span>
<a name="l08981"></a>08981   },
<a name="l08982"></a>08982 
<a name="l08983"></a>08983   onClickFolder: <span class="keyword">function</span>(folderNode, <a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l08984"></a>08984     var folder = folderNode.folder;
<a name="l08985"></a>08985     <span class="keywordflow">if</span> (!folder.selectable)
<a name="l08986"></a>08986       <span class="keywordflow">return</span>;
<a name="l08987"></a>08987 
<a name="l08988"></a>08988     var oldFolder = this.curFolder;
<a name="l08989"></a>08989     this.curFolder = folder;
<a name="l08990"></a>08990     this.updateFolderDom(oldFolder);
<a name="l08991"></a>08991     this.updateFolderDom(folder);
<a name="l08992"></a>08992 
<a name="l08993"></a>08993     this._showFolder(folder);
<a name="l08994"></a>08994     Cards.moveToCard([<span class="stringliteral">&#39;message_list&#39;</span>, <span class="stringliteral">&#39;nonsearch&#39;</span>]);
<a name="l08995"></a>08995   },
<a name="l08996"></a>08996 
<a name="l09000"></a>09000   _showFolder: <span class="keyword">function</span>(folder) {
<a name="l09001"></a>09001     model.changeFolder(folder);
<a name="l09002"></a>09002   },
<a name="l09003"></a>09003 
<a name="l09009"></a>09009   <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span>() {
<a name="l09010"></a>09010     model.removeListener(<span class="stringliteral">&#39;account&#39;</span>, this._boundUpdateAccount);
<a name="l09011"></a>09011   }
<a name="l09012"></a>09012 };
<a name="l09013"></a>09013 Cards.defineCard({
<a name="l09014"></a>09014   <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;folder_picker&#39;</span>,
<a name="l09015"></a>09015   <a class="code" href="../../df/d12/latin__test_8js.html#ad2cf4a40f77d475a65733c0477e3fba8">modes</a>: {
<a name="l09016"></a>09016     <span class="comment">// Navigation mode acts like a tray</span>
<a name="l09017"></a>09017     navigation: {
<a name="l09018"></a>09018       tray: <span class="keyword">true</span>
<a name="l09019"></a>09019     },
<a name="l09020"></a>09020     movetarget: {
<a name="l09021"></a>09021       tray: <span class="keyword">false</span>
<a name="l09022"></a>09022     }
<a name="l09023"></a>09023   },
<a name="l09024"></a>09024   <a class="code" href="../../d8/d14/_cloud_apps_8js.html#af72715521e98346fe28d30efb7887846">constructor</a>: FolderPickerCard,
<a name="l09025"></a>09025   templateNode: templateNode
<a name="l09026"></a>09026 });
<a name="l09027"></a>09027 
<a name="l09028"></a>09028 <span class="keywordflow">return</span> FolderPickerCard;
<a name="l09029"></a>09029 });
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d0/dfe/build__stage_2email_2js_2mail__app_8js.html">mail_app.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:52:43に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
