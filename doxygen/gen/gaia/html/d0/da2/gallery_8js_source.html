<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: gallery.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d0/da2/gallery_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">gallery.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d0/da2/gallery_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- Mode: js; js-indent-level: 2; indent-tabs-mode: nil -*- */</span>
<a name="l00002"></a>00002 <span class="comment">/* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab: */</span>
<a name="l00003"></a>00003 
<a name="l00004"></a><a class="code" href="../../d0/da2/gallery_8js.html#ae2475e10618961c050dcba04e8c42331">00004</a> <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="comment">/*</span>
<a name="l00007"></a>00007 <span class="comment"> * This app displays photos and videos that are stored on the phone.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * Its starts with a thumbnail view in which small versions of all photos</span>
<a name="l00010"></a>00010 <span class="comment"> * and videos are displayed.  Tapping on a thumbnail shows the image</span>
<a name="l00011"></a>00011 <span class="comment"> * or video at the full size of the screen and swiping left or right moves to</span>
<a name="l00012"></a>00012 <span class="comment"> * the next or previous image or video.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * The app supports two-finger &quot;pinch&quot; gestures to zoom in and out on an</span>
<a name="l00015"></a>00015 <span class="comment"> * image.  When zoomed, a one finger swipe gesture pans within the zoomed</span>
<a name="l00016"></a>00016 <span class="comment"> * image, and only moves to the next or previous image once you reach the</span>
<a name="l00017"></a>00017 <span class="comment"> * edge of the currently displayed image.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * To make transitions between photos smooth, the app preloads the next</span>
<a name="l00020"></a>00020 <span class="comment"> * and previous image or video and positions them off-screen to the right and</span>
<a name="l00021"></a>00021 <span class="comment"> * left of the currently displayed image.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Image and videos are displayed in &quot;frames&quot; which are managed by</span>
<a name="l00024"></a>00024 <span class="comment"> * the Frame.js abstraction. A Frame object includes a video player UI</span>
<a name="l00025"></a>00025 <span class="comment"> * (from VideoPlayer.js) and also includes the code that manage zooming</span>
<a name="l00026"></a>00026 <span class="comment"> * and panning within an image.</span>
<a name="l00027"></a>00027 <span class="comment"> */</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">//</span>
<a name="l00030"></a>00030 <span class="comment">// Tuneable parameters</span>
<a name="l00031"></a>00031 <span class="comment">//</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">// Pan this % of width to transition from one item to the next</span>
<a name="l00034"></a><a class="code" href="../../d0/da2/gallery_8js.html#a473a610b53b4a3ebf03fb3ffc7dd43b4">00034</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a473a610b53b4a3ebf03fb3ffc7dd43b4">TRANSITION_FRACTION</a> = 0.25;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">// This is the speed of our default transitions in pixels/ms.</span>
<a name="l00037"></a>00037 <span class="comment">// Swipe faster than this to transition faster. But we&#39;ll</span>
<a name="l00038"></a>00038 <span class="comment">// never go slower (except slide show transitions).</span>
<a name="l00039"></a><a class="code" href="../../d0/da2/gallery_8js.html#ad8d2e967e68a60d54c588d6823984541">00039</a> var <a class="code" href="../../d0/da2/gallery_8js.html#ad8d2e967e68a60d54c588d6823984541">TRANSITION_SPEED</a> = 0.75;
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">// How many thumbnails are visible on a page.</span>
<a name="l00042"></a>00042 <span class="comment">// Batch sizes are based on this.</span>
<a name="l00043"></a><a class="code" href="../../d0/da2/gallery_8js.html#a998ff3d0b5e9250e5debd83bae7fc2dd">00043</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a998ff3d0b5e9250e5debd83bae7fc2dd">PAGE_SIZE</a> = 15;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="keyword">function</span> $(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>) { <span class="keywordflow">return</span> <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementById(<span class="keywordtype">id</span>); }
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">// UI elements</span>
<a name="l00048"></a>00048 var thumbnails = $(<span class="stringliteral">&#39;thumbnails&#39;</span>);
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">// Only one of these three elements will be visible at a time</span>
<a name="l00051"></a><a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">00051</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a> = $(<span class="stringliteral">&#39;thumbnail-list-view&#39;</span>);
<a name="l00052"></a><a class="code" href="../../d0/da2/gallery_8js.html#a98ed4b68cffd3f7a6fe97c3ab40865d5">00052</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a98ed4b68cffd3f7a6fe97c3ab40865d5">thumbnailSelectView</a> = $(<span class="stringliteral">&#39;thumbnail-select-view&#39;</span>);
<a name="l00053"></a><a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">00053</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a> = $(<span class="stringliteral">&#39;fullscreen-view&#39;</span>);
<a name="l00054"></a><a class="code" href="../../d0/da2/gallery_8js.html#ada4ad1d94e1064761aeda200dbcddd02">00054</a> var <a class="code" href="../../d0/da2/gallery_8js.html#ada4ad1d94e1064761aeda200dbcddd02">editView</a> = $(<span class="stringliteral">&#39;edit-view&#39;</span>);
<a name="l00055"></a><a class="code" href="../../d0/da2/gallery_8js.html#a4020be717e9ac1015b4319904afa2dd6">00055</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a4020be717e9ac1015b4319904afa2dd6">pickView</a> = $(<span class="stringliteral">&#39;pick-view&#39;</span>);
<a name="l00056"></a><a class="code" href="../../d0/da2/gallery_8js.html#ad4442b6faaf0dee1d52cfe6c9deec24d">00056</a> var <a class="code" href="../../d0/da2/gallery_8js.html#ad4442b6faaf0dee1d52cfe6c9deec24d">cropView</a> = $(<span class="stringliteral">&#39;crop-view&#39;</span>);
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="comment">// These are the top-level view objects.</span>
<a name="l00059"></a>00059 <span class="comment">// This array is used by setView()</span>
<a name="l00060"></a><a class="code" href="../../d0/da2/gallery_8js.html#a3ec184b947133eb14151f80d3ff05797">00060</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a3ec184b947133eb14151f80d3ff05797">views</a> = [
<a name="l00061"></a>00061   <a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>, <a class="code" href="../../d0/da2/gallery_8js.html#a98ed4b68cffd3f7a6fe97c3ab40865d5">thumbnailSelectView</a>, <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>, <a class="code" href="../../d0/da2/gallery_8js.html#ada4ad1d94e1064761aeda200dbcddd02">editView</a>,
<a name="l00062"></a>00062   <a class="code" href="../../d0/da2/gallery_8js.html#a4020be717e9ac1015b4319904afa2dd6">pickView</a>, <a class="code" href="../../d0/da2/gallery_8js.html#ad4442b6faaf0dee1d52cfe6c9deec24d">cropView</a>
<a name="l00063"></a>00063 ];
<a name="l00064"></a><a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">00064</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a>;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">// This will be set to &quot;ltr&quot; or &quot;rtl&quot; when we get our localized event</span>
<a name="l00067"></a><a class="code" href="../../d0/da2/gallery_8js.html#a82bac0ea52a4192fdf6f4ad005ef687d">00067</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a82bac0ea52a4192fdf6f4ad005ef687d">languageDirection</a>;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">// This array holds information about all the image and video files we</span>
<a name="l00070"></a>00070 <span class="comment">// know about. Each array element is an object that includes a</span>
<a name="l00071"></a>00071 <span class="comment">// filename and metadata. The array is initially filled when we enumerate</span>
<a name="l00072"></a>00072 <span class="comment">// the photo and video databases, and has elements added and removed when</span>
<a name="l00073"></a>00073 <span class="comment">// we receive create and delete events from the media databases.</span>
<a name="l00074"></a><a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">00074</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a> = [];
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">00076</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a> = 0;       <span class="comment">// What file is currently displayed</span>
<a name="l00077"></a><a class="code" href="../../d0/da2/gallery_8js.html#abfe5eb1833402ced30625fd6582536d8">00077</a> var <a class="code" href="../../d0/da2/gallery_8js.html#abfe5eb1833402ced30625fd6582536d8">editedPhotoIndex</a>;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="comment">// In thumbnailSelectView, we allow the user to select thumbnails.</span>
<a name="l00080"></a>00080 <span class="comment">// These variables hold the names of the selected files, and map those</span>
<a name="l00081"></a>00081 <span class="comment">// names to the corresponding File objects</span>
<a name="l00082"></a><a class="code" href="../../d0/da2/gallery_8js.html#af0fd4e3510447825b3d4ef3034f756d9">00082</a> var <a class="code" href="../../d0/da2/gallery_8js.html#af0fd4e3510447825b3d4ef3034f756d9">selectedFileNames</a> = [];
<a name="l00083"></a><a class="code" href="../../d0/da2/gallery_8js.html#a687cffebc743e15f61c94b32f18a7ea5">00083</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a687cffebc743e15f61c94b32f18a7ea5">selectedFileNamesToBlobs</a> = {};
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">// The MediaDB object that manages the filesystem and the database of metadata</span>
<a name="l00086"></a><a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">00086</a> var <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="comment">// We manage videos through their poster images, which are photos and so get</span>
<a name="l00089"></a>00089 <span class="comment">// listed in the photodb above. But when we need to access the actual video</span>
<a name="l00090"></a>00090 <span class="comment">// file, we have to get that from a device storage object for videos.</span>
<a name="l00091"></a><a class="code" href="../../d0/da2/gallery_8js.html#ace84f873229174800558862ac30942fd">00091</a> var <a class="code" href="../../d0/da2/gallery_8js.html#ace84f873229174800558862ac30942fd">videostorage</a>;
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="../../d0/da2/gallery_8js.html#ace19037638e4d77c15d6f659d94f5ce7">00093</a> var <a class="code" href="../../d0/da2/gallery_8js.html#ace19037638e4d77c15d6f659d94f5ce7">visibilityMonitor</a>;
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="../../d0/da2/gallery_8js.html#a78601e1f2fe929d6470d82a205ad2382">00095</a> var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a78601e1f2fe929d6470d82a205ad2382">loader</a> = <a class="code" href="../../d3/db5/build__stage_2email_2shared_2js_2lazy__loader_8js.html#aaf5eec8afd0243eeb2166f74e472c877">LazyLoader</a>;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="comment">// The localized event is the main entry point for the app.</span>
<a name="l00098"></a>00098 <span class="comment">// We don&#39;t do anything until we receive it.</span>
<a name="l00099"></a>00099 <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.ready(<span class="keyword">function</span> showBody() {
<a name="l00100"></a>00100   <span class="comment">// Set the &#39;lang&#39; and &#39;dir&#39; attributes to &lt;html&gt; when the page is translated</span>
<a name="l00101"></a>00101   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.documentElement.lang = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.language.code;
<a name="l00102"></a>00102   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.documentElement.dir = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.language.direction;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104   <span class="comment">// &lt;body&gt; children are hidden until the UI is translated</span>
<a name="l00105"></a>00105   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.body.classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107   <span class="comment">// Now initialize the rest of the app. But don&#39;t re-initialize if the user</span>
<a name="l00108"></a>00108   <span class="comment">// switches languages when the app is already running</span>
<a name="l00109"></a>00109   <span class="keywordflow">if</span> (!<a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>)
<a name="l00110"></a>00110     <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>();
<a name="l00111"></a>00111 });
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="../../d0/da2/gallery_8js.html#af8dc73726eb0578fe44fb98cd2319445">00113</a> <span class="keyword">function</span> <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>() {
<a name="l00114"></a>00114   <span class="comment">// Clicking on the select button goes to thumbnail select mode</span>
<a name="l00115"></a>00115   $(<span class="stringliteral">&#39;thumbnails-select-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> =
<a name="l00116"></a>00116     <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d0/da2/gallery_8js.html#a98ed4b68cffd3f7a6fe97c3ab40865d5">thumbnailSelectView</a>);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <span class="comment">// Clicking on the cancel button goes from thumbnail select mode</span>
<a name="l00119"></a>00119   <span class="comment">// back to thumbnail list mode</span>
<a name="l00120"></a>00120   $(<span class="stringliteral">&#39;thumbnails-cancel-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122   <span class="comment">// Clicking on the pick back button cancels the pick activity.</span>
<a name="l00123"></a>00123   $(<span class="stringliteral">&#39;pick-back-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = cancelPick;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125   <span class="comment">// In crop view, the back button goes back to pick view</span>
<a name="l00126"></a>00126   $(<span class="stringliteral">&#39;crop-back-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <span class="keyword">function</span>() {
<a name="l00127"></a>00127     <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a4020be717e9ac1015b4319904afa2dd6">pickView</a>);
<a name="l00128"></a>00128     cleanupCrop();
<a name="l00129"></a>00129   };
<a name="l00130"></a>00130 
<a name="l00131"></a>00131   <span class="comment">// In crop view, the done button finishes the pick</span>
<a name="l00132"></a>00132   $(<span class="stringliteral">&#39;crop-done-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../d0/da2/gallery_8js.html#a7e9da90af1c46280e00745b86da7ff0f">cropAndEndPick</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="comment">// The camera buttons should launch the camera app</span>
<a name="l00135"></a>00135   $(<span class="stringliteral">&#39;fullscreen-camera-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../dd/d85/video_8js.html#af2e261a1ef7f340a5c693d2b6a1b92ed">launchCameraApp</a>;
<a name="l00136"></a>00136   $(<span class="stringliteral">&#39;thumbnails-camera-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../dd/d85/video_8js.html#af2e261a1ef7f340a5c693d2b6a1b92ed">launchCameraApp</a>;
<a name="l00137"></a>00137   $(<span class="stringliteral">&#39;overlay-camera-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../dd/d85/video_8js.html#af2e261a1ef7f340a5c693d2b6a1b92ed">launchCameraApp</a>;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139   <span class="comment">// Clicking on the delete button in thumbnail select mode deletes all</span>
<a name="l00140"></a>00140   <span class="comment">// selected items</span>
<a name="l00141"></a>00141   $(<span class="stringliteral">&#39;thumbnails-delete-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../dd/d85/video_8js.html#aebc1dbd30434352ff024a083c75b5b4f">deleteSelectedItems</a>;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="comment">// Clicking on the share button in select mode shares all selected images</span>
<a name="l00144"></a>00144   $(<span class="stringliteral">&#39;thumbnails-share-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <a class="code" href="../../dd/d85/video_8js.html#aa4d606e25464d76378eb75550ec7663c">shareSelectedItems</a>;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   <span class="comment">// Click to open the media storage panel when the default storage</span>
<a name="l00147"></a>00147   <span class="comment">// is unavailable.</span>
<a name="l00148"></a>00148   $(<span class="stringliteral">&#39;storage-setting-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <span class="keyword">function</span>() {
<a name="l00149"></a>00149     var <a class="code" href="../../de/dc7/share-receiver_8js.html#add7056b1c8a53d2db94122b6cd76b964">activity</a> = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28ab7e07971d28f2ebf8ff15ee0f268f2e1">MozActivity</a>({
<a name="l00150"></a>00150       <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;configure&#39;</span>,
<a name="l00151"></a>00151       <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: {
<a name="l00152"></a>00152         <a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a>: <span class="stringliteral">&#39;device&#39;</span>,
<a name="l00153"></a>00153         <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a1df8504e63545f2e6c93c0cde966c060">section</a>: <span class="stringliteral">&#39;mediaStorage&#39;</span>
<a name="l00154"></a>00154       }
<a name="l00155"></a>00155     });
<a name="l00156"></a>00156   };
<a name="l00157"></a>00157   $(<span class="stringliteral">&#39;overlay-cancel-button&#39;</span>).<a class="code" href="../../d8/df0/frames_8js.html#a2581b031a10db324ce49c6a804c5f20a">onclick</a> = <span class="keyword">function</span>() {
<a name="l00158"></a>00158     cancelPick();
<a name="l00159"></a>00159   };
<a name="l00160"></a>00160   <span class="comment">// Handle resize events</span>
<a name="l00161"></a>00161   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.onresize = <a class="code" href="../../db/d0b/_image_editor_8js.html#a949ea6f42ae029faa03eb19facfa08b0">resizeHandler</a>;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163   <span class="comment">// If we were not invoked by an activity, then start off in thumbnail</span>
<a name="l00164"></a>00164   <span class="comment">// list mode, and fire up the MediaDB object.</span>
<a name="l00165"></a>00165   <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozHasPendingMessage(<span class="stringliteral">&#39;activity&#39;</span>)) {
<a name="l00166"></a>00166     <a class="code" href="../../d0/da2/gallery_8js.html#aa3ad0f72d51416a18a4336efa0b2b3cf">initDB</a>();
<a name="l00167"></a>00167     <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l00168"></a>00168   }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170   <span class="comment">// Register a handler for activities. This will take care of the rest</span>
<a name="l00171"></a>00171   <span class="comment">// of the initialization process.</span>
<a name="l00172"></a>00172   <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozSetMessageHandler(<span class="stringliteral">&#39;activity&#39;</span>, <span class="keyword">function</span> activityHandler(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>) {
<a name="l00173"></a>00173     var activityName = <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.source.name;
<a name="l00174"></a>00174     <span class="keywordflow">switch</span> (activityName) {
<a name="l00175"></a>00175     <span class="keywordflow">case</span> <span class="stringliteral">&#39;browse&#39;</span>:
<a name="l00176"></a>00176       <span class="comment">// The &#39;browse&#39; activity is the way we launch Gallery from Camera.</span>
<a name="l00177"></a>00177       <span class="comment">// If this was a cold start, then the db needs to be initialized.</span>
<a name="l00178"></a>00178       <span class="keywordflow">if</span> (!<a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>) {
<a name="l00179"></a>00179         <a class="code" href="../../d0/da2/gallery_8js.html#aa3ad0f72d51416a18a4336efa0b2b3cf">initDB</a>();  <span class="comment">// Initialize the media database</span>
<a name="l00180"></a>00180         <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l00181"></a>00181       }
<a name="l00182"></a>00182       <span class="keywordflow">else</span> {
<a name="l00183"></a>00183         <span class="comment">// If the gallery was already running we we arrived here via a</span>
<a name="l00184"></a>00184         <span class="comment">// browse activity, then the user is probably coming to us from the</span>
<a name="l00185"></a>00185         <span class="comment">// camera, and she probably wants to see the list of thumbnails.</span>
<a name="l00186"></a>00186         <span class="comment">// If we&#39;re currently displaying a single image, switch to the</span>
<a name="l00187"></a>00187         <span class="comment">// thumbnails. But if the user left the gallery in the middle of</span>
<a name="l00188"></a>00188         <span class="comment">// an edit or in the middle of making a selection, then returning</span>
<a name="l00189"></a>00189         <span class="comment">// to the thumbnail list would cause her to lose work, so in those</span>
<a name="l00190"></a>00190         <span class="comment">// cases we don&#39;t change anything and let the gallery resume where</span>
<a name="l00191"></a>00191         <span class="comment">// the user left it.  See Bug 846220.</span>
<a name="l00192"></a>00192         <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>)
<a name="l00193"></a>00193           <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l00194"></a>00194       }
<a name="l00195"></a>00195       <span class="keywordflow">break</span>;
<a name="l00196"></a>00196     <span class="keywordflow">case</span> <span class="stringliteral">&#39;pick&#39;</span>:
<a name="l00197"></a>00197       <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>) <span class="comment">// I don&#39;t think this can really happen anymore</span>
<a name="l00198"></a>00198         cancelPick();
<a name="l00199"></a>00199       <a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a> = <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>; <span class="comment">// We need pendingPick set before calling initDB()</span>
<a name="l00200"></a>00200       <span class="keywordflow">if</span> (!<a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>)
<a name="l00201"></a>00201         <a class="code" href="../../d0/da2/gallery_8js.html#aa3ad0f72d51416a18a4336efa0b2b3cf">initDB</a>();
<a name="l00202"></a>00202       <a class="code" href="../../d0/da2/gallery_8js.html#af1ea14645dcd3a1078e952cbde544991">startPick</a>();
<a name="l00203"></a>00203       <span class="keywordflow">break</span>;
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205   });
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="comment">// Initialize MediaDB objects for photos and videos, and set up their</span>
<a name="l00209"></a>00209 <span class="comment">// event handlers.</span>
<a name="l00210"></a><a class="code" href="../../d0/da2/gallery_8js.html#aa3ad0f72d51416a18a4336efa0b2b3cf">00210</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#aa3ad0f72d51416a18a4336efa0b2b3cf">initDB</a>() {
<a name="l00211"></a>00211   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a> = <span class="keyword">new</span> <a class="code" href="../../d7/de7/build__stage_2email_2shared_2js_2mediadb_8js.html#a1c7c277e7990f7e2da74163427e0f830">MediaDB</a>(<span class="stringliteral">&#39;pictures&#39;</span>, metadataParserWrapper, {
<a name="l00212"></a>00212     <a class="code" href="../../d9/d04/expat_8h.html#aa323a7729fa99ab75ae910c7267ac071">version</a>: 2,
<a name="l00213"></a>00213     autoscan: <span class="keyword">false</span>,     <span class="comment">// We&#39;re going to call scan() explicitly</span>
<a name="l00214"></a>00214     batchHoldTime: 150,  <span class="comment">// Batch files during scanning</span>
<a name="l00215"></a>00215     batchSize: <a class="code" href="../../d0/da2/gallery_8js.html#a998ff3d0b5e9250e5debd83bae7fc2dd">PAGE_SIZE</a> <span class="comment">// Max batch size: one screenful</span>
<a name="l00216"></a>00216   });
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   <span class="comment">// This is where we find videos once the photodb notifies us that a</span>
<a name="l00219"></a>00219   <span class="comment">// new video poster image has been detected. Note that we need this</span>
<a name="l00220"></a>00220   <span class="comment">// even during a pick activity when we&#39;re not displaying videos</span>
<a name="l00221"></a>00221   <span class="comment">// because we might still might find and parse metadata for new</span>
<a name="l00222"></a>00222   <span class="comment">// videos during the scanning process.</span>
<a name="l00223"></a>00223   <a class="code" href="../../d0/da2/gallery_8js.html#ace84f873229174800558862ac30942fd">videostorage</a> = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.getDeviceStorage(<span class="stringliteral">&#39;videos&#39;</span>);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225   var <a class="code" href="../../da/ddf/ns_i_d_o_m_progress_event_8idl.html#a683cd33cf7f2552e240f57d453a4717d">loaded</a> = <span class="keyword">false</span>;
<a name="l00226"></a>00226   <span class="keyword">function</span> metadataParserWrapper(<a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>, bigFile) {
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (loaded) {
<a name="l00228"></a>00228       <a class="code" href="../../df/dcd/apps_2gallery_2js_2metadata__scripts_8js.html#a1663d790c01d578b4d59cfe354e836ef">metadataParser</a>(<a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>, bigFile);
<a name="l00229"></a>00229       <span class="keywordflow">return</span>;
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a78601e1f2fe929d6470d82a205ad2382">loader</a>.load(<span class="stringliteral">&#39;js/metadata_scripts.js&#39;</span>, <span class="keyword">function</span>() {
<a name="l00233"></a>00233       loaded = <span class="keyword">true</span>;
<a name="l00234"></a>00234       <a class="code" href="../../df/dcd/apps_2gallery_2js_2metadata__scripts_8js.html#a1663d790c01d578b4d59cfe354e836ef">metadataParser</a>(<a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>, <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a9c95fb48715b0deb285f7bfd8f10df50">onerror</a>, bigFile);
<a name="l00235"></a>00235     });
<a name="l00236"></a>00236   }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   <span class="comment">// show dialog in upgradestart, when it finished, it will turned to ready.</span>
<a name="l00239"></a>00239   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.onupgrading = <span class="keyword">function</span>(evt) {
<a name="l00240"></a>00240     <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<span class="stringliteral">&#39;upgrade&#39;</span>);
<a name="l00241"></a>00241   };
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   <span class="comment">// This is called when DeviceStorage becomes unavailable because the</span>
<a name="l00244"></a>00244   <span class="comment">// sd card is removed or because it is mounted for USB mass storage</span>
<a name="l00245"></a>00245   <span class="comment">// This may be called before onready if it is unavailable to begin with</span>
<a name="l00246"></a>00246   <span class="comment">// We don&#39;t need one of these handlers for the video db, since both</span>
<a name="l00247"></a>00247   <span class="comment">// will get the same event at more or less the same time.</span>
<a name="l00248"></a>00248   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.onunavailable = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00249"></a>00249     <span class="comment">// Switch back to the thumbnail view. If we were viewing or editing an image</span>
<a name="l00250"></a>00250     <span class="comment">// it might not be there anymore when the MediaDB becomes available again.</span>
<a name="l00251"></a>00251     <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">// If storage becomes unavailble (e.g. the user starts a USB Mass Storage</span>
<a name="l00254"></a>00254     <span class="comment">// Lock the user out of the app, and tell them why</span>
<a name="l00255"></a>00255     var why = <span class="keyword">event</span>.detail;
<a name="l00256"></a>00256     <span class="keywordflow">if</span> (why === <a class="code" href="../../d7/de7/build__stage_2email_2shared_2js_2mediadb_8js.html#a1c7c277e7990f7e2da74163427e0f830">MediaDB</a>.NOCARD)
<a name="l00257"></a>00257       <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<span class="stringliteral">&#39;nocard&#39;</span>);
<a name="l00258"></a>00258     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (why === <a class="code" href="../../d7/de7/build__stage_2email_2shared_2js_2mediadb_8js.html#a1c7c277e7990f7e2da74163427e0f830">MediaDB</a>.UNMOUNTED)
<a name="l00259"></a>00259       <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<span class="stringliteral">&#39;pluggedin&#39;</span>);
<a name="l00260"></a>00260   };
<a name="l00261"></a>00261 
<a name="l00262"></a>00262   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.onready = <span class="keyword">function</span>() {
<a name="l00263"></a>00263     <span class="comment">// Hide the nocard or pluggedin overlay if it is displayed</span>
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (<a class="code" href="../../de/db0/music_8js.html#a113233cca2b0b908dba1be75b9c1f841">currentOverlay</a> === <span class="stringliteral">&#39;nocard&#39;</span> || <a class="code" href="../../de/db0/music_8js.html#a113233cca2b0b908dba1be75b9c1f841">currentOverlay</a> === <span class="stringliteral">&#39;pluggedin&#39;</span> ||
<a name="l00265"></a>00265         <a class="code" href="../../de/db0/music_8js.html#a113233cca2b0b908dba1be75b9c1f841">currentOverlay</a> === <span class="stringliteral">&#39;upgrade&#39;</span>)
<a name="l00266"></a>00266       <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <a class="code" href="../../d0/da2/gallery_8js.html#a6d772599ba184f90212d966f0036bd7f">initThumbnails</a>();
<a name="l00269"></a>00269   };
<a name="l00270"></a>00270 
<a name="l00271"></a>00271   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.onscanstart = <span class="keyword">function</span> onscanstart() {
<a name="l00272"></a>00272     <span class="comment">// Show the scanning indicator</span>
<a name="l00273"></a>00273     $(<span class="stringliteral">&#39;progress&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l00274"></a>00274     $(<span class="stringliteral">&#39;throbber&#39;</span>).classList.add(<span class="stringliteral">&#39;throb&#39;</span>);
<a name="l00275"></a>00275   };
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.onscanend = <span class="keyword">function</span> onscanend() {
<a name="l00278"></a>00278     <span class="comment">// if we&#39;re still having the scanning overlay there are no photo&#39;s</span>
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (<a class="code" href="../../de/db0/music_8js.html#a113233cca2b0b908dba1be75b9c1f841">currentOverlay</a> === <span class="stringliteral">&#39;scanning&#39;</span>)
<a name="l00280"></a>00280       <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<span class="stringliteral">&#39;emptygallery&#39;</span>);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">// Hide the scanning indicator</span>
<a name="l00283"></a>00283     $(<span class="stringliteral">&#39;progress&#39;</span>).classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l00284"></a>00284     $(<span class="stringliteral">&#39;throbber&#39;</span>).classList.remove(<span class="stringliteral">&#39;throb&#39;</span>);
<a name="l00285"></a>00285   };
<a name="l00286"></a>00286 
<a name="l00287"></a>00287   <span class="comment">// On devices with internal and external device storage, this handler is</span>
<a name="l00288"></a>00288   <span class="comment">// triggered when the user removes the sdcard. MediaDB remains usable</span>
<a name="l00289"></a>00289   <span class="comment">// and we&#39;ll get a bunch of deleted events for the files that are no longer</span>
<a name="l00290"></a>00290   <span class="comment">// available. But we need to listen to this event so we can switch back</span>
<a name="l00291"></a>00291   <span class="comment">// to the list of thumbnails. We don&#39;t want to be left viewing or editing</span>
<a name="l00292"></a>00292   <span class="comment">// a photo that is no longer available.</span>
<a name="l00293"></a>00293   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.oncardremoved = <span class="keyword">function</span> oncardremoved() {
<a name="l00294"></a>00294     <span class="comment">// If the user pulls the sdcard while trying to pick an image, give up</span>
<a name="l00295"></a>00295     <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>) {
<a name="l00296"></a>00296       cancelPick();
<a name="l00297"></a>00297       <span class="keywordflow">return</span>;
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l00301"></a>00301   };
<a name="l00302"></a>00302 
<a name="l00303"></a>00303   <span class="comment">// One or more files was created (or was just discovered by a scan)</span>
<a name="l00304"></a>00304   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.oncreated = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00305"></a>00305     <span class="keyword">event</span>.detail.forEach(<a class="code" href="../../d0/da2/gallery_8js.html#a99873e3fc1be38a0caf0999e2a5b6e65">fileCreated</a>);
<a name="l00306"></a>00306   };
<a name="l00307"></a>00307 
<a name="l00308"></a>00308   <span class="comment">// One or more files were deleted (or were just discovered missing by a scan)</span>
<a name="l00309"></a>00309   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.ondeleted = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00310"></a>00310     <span class="keyword">event</span>.detail.forEach(<a class="code" href="../../d0/da2/gallery_8js.html#a39586a47f4ee455f04350f3c8248e124">fileDeleted</a>);
<a name="l00311"></a>00311   };
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 <span class="comment">// Pass the filename of the poster image and get the video file back</span>
<a name="l00315"></a><a class="code" href="../../d0/da2/gallery_8js.html#a377c40257a942d42736eccd490acfec4">00315</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a377c40257a942d42736eccd490acfec4">getVideoFile</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00316"></a>00316   <span class="comment">// We get videos directly through the video device storage</span>
<a name="l00317"></a>00317   var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a> = <a class="code" href="../../d0/da2/gallery_8js.html#ace84f873229174800558862ac30942fd">videostorage</a>.get(<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>);
<a name="l00318"></a>00318   req.onsuccess = <span class="keyword">function</span>() {
<a name="l00319"></a>00319     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(req.result);
<a name="l00320"></a>00320   };
<a name="l00321"></a>00321   req.onerror = <span class="keyword">function</span>() {
<a name="l00322"></a>00322     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Failed to get video file&#39;</span>, <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>);
<a name="l00323"></a>00323   };
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="comment">// This comparison function is used for sorting arrays and doing binary</span>
<a name="l00327"></a>00327 <span class="comment">// search on the resulting sorted arrays.</span>
<a name="l00328"></a><a class="code" href="../../d0/da2/gallery_8js.html#af0bf2f6ad5f7519cef00440ab733686b">00328</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#af0bf2f6ad5f7519cef00440ab733686b">compareFilesByDate</a>(<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>, <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>) {
<a name="l00329"></a>00329   <span class="keywordflow">if</span> (<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.date &lt; <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.date)
<a name="l00330"></a>00330     <span class="keywordflow">return</span> 1;  <span class="comment">// larger (newer) dates come first</span>
<a name="l00331"></a>00331   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>.date &gt; <a class="code" href="../../da/ded/jpegint_8h.html#af320905358fa78701e4cc60b6135601f">b</a>.date)
<a name="l00332"></a>00332     <span class="keywordflow">return</span> -1;
<a name="l00333"></a>00333   <span class="keywordflow">return</span> 0;
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 <span class="comment">//</span>
<a name="l00337"></a>00337 <span class="comment">// Enumerate existing entries in the media database in reverse</span>
<a name="l00338"></a>00338 <span class="comment">// chronological order (most recent first) and display thumbnails for them all.</span>
<a name="l00339"></a>00339 <span class="comment">// After the thumbnails are displayed, scan for new files.</span>
<a name="l00340"></a>00340 <span class="comment">//</span>
<a name="l00341"></a>00341 <span class="comment">// This function gets called when the app first starts up, and also</span>
<a name="l00342"></a>00342 <span class="comment">// when the sdcard becomes available again after a USB mass storage</span>
<a name="l00343"></a>00343 <span class="comment">// session or an sdcard replacement.</span>
<a name="l00344"></a>00344 <span class="comment">//</span>
<a name="l00345"></a><a class="code" href="../../d0/da2/gallery_8js.html#a6d772599ba184f90212d966f0036bd7f">00345</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a6d772599ba184f90212d966f0036bd7f">initThumbnails</a>() {
<a name="l00346"></a>00346   <span class="comment">// If we&#39;ve already been called once, then we&#39;ve already got thumbnails</span>
<a name="l00347"></a>00347   <span class="comment">// displayed. There is no need to re-enumerate them, so we just go</span>
<a name="l00348"></a>00348   <span class="comment">// straight to scanning for new files</span>
<a name="l00349"></a>00349   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ace19037638e4d77c15d6f659d94f5ce7">visibilityMonitor</a>) {
<a name="l00350"></a>00350     <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.scan();
<a name="l00351"></a>00351     <span class="keywordflow">return</span>;
<a name="l00352"></a>00352   }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354   <span class="comment">// Keep track of when thumbnails are onscreen and offscreen</span>
<a name="l00355"></a>00355 <span class="comment">/*</span>
<a name="l00356"></a>00356 <span class="comment">  // Tune for low memory usage and small batch jobes to fetch new</span>
<a name="l00357"></a>00357 <span class="comment">  // images.  Lower fps / frequent but smaller jank.</span>
<a name="l00358"></a>00358 <span class="comment">  var visibilityMargin = 360;</span>
<a name="l00359"></a>00359 <span class="comment">  var minimumScrollDelta = 1;</span>
<a name="l00360"></a>00360 <span class="comment">*/</span>
<a name="l00361"></a>00361 
<a name="l00362"></a>00362   <span class="comment">// Tune for fast panning for long distances, which requires larger</span>
<a name="l00363"></a>00363   <span class="comment">// batch jobs.  Higher fps / infrequent but larger jank.</span>
<a name="l00364"></a>00364   <span class="comment">//</span>
<a name="l00365"></a>00365   <span class="comment">// These magic constants were determined as follows</span>
<a name="l00366"></a>00366   <span class="comment">//  - keep &quot;a lot&quot; of images loaded:</span>
<a name="l00367"></a>00367   <span class="comment">//      max 300 images = 100 rows</span>
<a name="l00368"></a>00368   <span class="comment">//       = 10600px on HVGA = (10600 - 480) / 2 margins = 5060</span>
<a name="l00369"></a>00369   <span class="comment">//</span>
<a name="l00370"></a>00370   <span class="comment">//  - batch up as much work as possible while showing unpainted</span>
<a name="l00371"></a>00371   <span class="comment">//    thumbnails as little as possible.  4000px determined by</span>
<a name="l00372"></a>00372   <span class="comment">//    experimentation.  (Provides 10 rows&#39; worth loading zone.)</span>
<a name="l00373"></a>00373   var visibilityMargin = 5060;
<a name="l00374"></a>00374   var minimumScrollDelta = 4000;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376   <a class="code" href="../../d0/da2/gallery_8js.html#ace19037638e4d77c15d6f659d94f5ce7">visibilityMonitor</a> =
<a name="l00377"></a>00377     <a class="code" href="../../d7/d7e/build__stage_2email_2shared_2js_2visibility__monitor_8js.html#ab0efb05f081609be5307fea87d23e624">monitorChildVisibility</a>(thumbnails,
<a name="l00378"></a>00378                            visibilityMargin,    <span class="comment">// extra space top and bottom</span>
<a name="l00379"></a>00379                            minimumScrollDelta,  <span class="comment">// min scroll before we do work</span>
<a name="l00380"></a>00380                            <a class="code" href="../../d0/da2/gallery_8js.html#a20faf3ee1393446ec53a3fff0f1d8a0e">thumbnailOnscreen</a>,   <span class="comment">// set background image</span>
<a name="l00381"></a>00381                            <a class="code" href="../../d0/da2/gallery_8js.html#aa4068f2bdc717b6caa7bdd1260cc6ad4">thumbnailOffscreen</a>); <span class="comment">// remove background image</span>
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="comment">// Handle clicks on the thumbnails we&#39;re about to create</span>
<a name="l00385"></a>00385   thumbnails.addEventListener(<span class="stringliteral">&#39;click&#39;</span>, <a class="code" href="../../dd/d85/video_8js.html#a7e53b2a5efd2d199bb7a70417e3d9b75">thumbnailClickHandler</a>);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   <span class="comment">// We need to enumerate both the photo and video dbs and interleave</span>
<a name="l00388"></a>00388   <span class="comment">// the files they return so that everything is in chronological order</span>
<a name="l00389"></a>00389   <span class="comment">// from most recent to least recent.</span>
<a name="l00390"></a>00390 
<a name="l00391"></a>00391   <span class="comment">// Temporary arrays to hold enumerated files</span>
<a name="l00392"></a>00392   var batch = [];
<a name="l00393"></a>00393   var batchsize = <a class="code" href="../../d0/da2/gallery_8js.html#a998ff3d0b5e9250e5debd83bae7fc2dd">PAGE_SIZE</a>;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.enumerate(<span class="stringliteral">&#39;date&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <span class="stringliteral">&#39;prev&#39;</span>, <span class="keyword">function</span>(fileinfo) {
<a name="l00396"></a>00396     <span class="keywordflow">if</span> (fileinfo) {
<a name="l00397"></a>00397       <span class="comment">// For a pick activity, don&#39;t display videos</span>
<a name="l00398"></a>00398       <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a> &amp;&amp; fileinfo.metadata.video)
<a name="l00399"></a>00399         <span class="keywordflow">return</span>;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401       batch.push(fileinfo);
<a name="l00402"></a>00402       <span class="keywordflow">if</span> (batch.length &gt;= batchsize) {
<a name="l00403"></a>00403         flush();
<a name="l00404"></a>00404         batchsize *= 2;
<a name="l00405"></a>00405       }
<a name="l00406"></a>00406     }
<a name="l00407"></a>00407     <span class="keywordflow">else</span> {
<a name="l00408"></a>00408       <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410   });
<a name="l00411"></a>00411 
<a name="l00412"></a>00412   <span class="keyword">function</span> flush() {
<a name="l00413"></a>00413     batch.forEach(thumb);
<a name="l00414"></a>00414     batch.length = 0;
<a name="l00415"></a>00415   }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417   <span class="keyword">function</span> thumb(fileinfo) {
<a name="l00418"></a>00418     <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.push(fileinfo);              <span class="comment">// remember the file</span>
<a name="l00419"></a>00419     var thumbnail = <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a246682eea904b777ca4d4707f24232f2">createThumbnail</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length - 1); <span class="comment">// create its thumbnail</span>
<a name="l00420"></a>00420     thumbnails.appendChild(thumbnail); <span class="comment">// display the thumbnail</span>
<a name="l00421"></a>00421   }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423   <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>() {
<a name="l00424"></a>00424     flush();
<a name="l00425"></a>00425     <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length === 0) { <span class="comment">// If we didn&#39;t find anything</span>
<a name="l00426"></a>00426       <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<span class="stringliteral">&#39;scanning&#39;</span>);
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     <span class="comment">// Now that we&#39;ve enumerated all the photos and videos we already know</span>
<a name="l00429"></a>00429     <span class="comment">// about go start looking for new photos and videos.</span>
<a name="l00430"></a>00430     <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.scan();
<a name="l00431"></a>00431   }
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a><a class="code" href="../../d0/da2/gallery_8js.html#a39586a47f4ee455f04350f3c8248e124">00434</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a39586a47f4ee455f04350f3c8248e124">fileDeleted</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>) {
<a name="l00435"></a>00435   <span class="comment">// Find the deleted file in our files array</span>
<a name="l00436"></a>00436   <span class="keywordflow">for</span> (var <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> = 0; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> &lt; <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length; <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>++) {
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>].<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> === <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>)
<a name="l00438"></a>00438       <span class="keywordflow">break</span>;
<a name="l00439"></a>00439   }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> &gt;= <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length)  <span class="comment">// It was a file we didn&#39;t know about</span>
<a name="l00442"></a>00442     <span class="keywordflow">return</span>;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444   <span class="comment">// Remove the image from the array</span>
<a name="l00445"></a>00445   var deletedImageData = <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.splice(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>, 1)[0];
<a name="l00446"></a>00446 
<a name="l00447"></a>00447   <span class="comment">// Remove the corresponding thumbnail</span>
<a name="l00448"></a>00448   var thumbnailElts = thumbnails.querySelectorAll(<span class="stringliteral">&#39;.thumbnail&#39;</span>);
<a name="l00449"></a>00449   <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.revokeObjectURL(thumbnailElts[<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>].dataset.backgroundImage.slice(5, -2));
<a name="l00450"></a>00450   thumbnails.removeChild(thumbnailElts[<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>]);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   <span class="comment">// Change the index associated with all the thumbnails after the deleted one</span>
<a name="l00453"></a>00453   <span class="comment">// This keeps the data-index attribute of each thumbnail element in sync</span>
<a name="l00454"></a>00454   <span class="comment">// with the files[] array.</span>
<a name="l00455"></a>00455   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = n + 1; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; thumbnailElts.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00456"></a>00456     thumbnailElts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].dataset.index = <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> - 1;
<a name="l00457"></a>00457   }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459   <span class="comment">// Adjust currentFileIndex, too, if we have to.</span>
<a name="l00460"></a>00460   <span class="keywordflow">if</span> (n &lt; <a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a>)
<a name="l00461"></a>00461     <a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a>--;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463   <span class="comment">// If we remove the last item in files[],</span>
<a name="l00464"></a>00464   <span class="comment">// we need to show the previous image, not the next image.</span>
<a name="l00465"></a>00465   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a> &gt;= <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length)
<a name="l00466"></a>00466     <a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a> = <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length - 1;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   <span class="keywordflow">if</span> (n &lt; <a class="code" href="../../d0/da2/gallery_8js.html#abfe5eb1833402ced30625fd6582536d8">editedPhotoIndex</a>)
<a name="l00469"></a>00469     <a class="code" href="../../d0/da2/gallery_8js.html#abfe5eb1833402ced30625fd6582536d8">editedPhotoIndex</a>--;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471   <span class="comment">// If we&#39;re in fullscreen mode, then the only way this function</span>
<a name="l00472"></a>00472   <span class="comment">// gets called is when we delete the currently displayed photo. This means</span>
<a name="l00473"></a>00473   <span class="comment">// that we need to redisplay.</span>
<a name="l00474"></a>00474   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a> &amp;&amp; <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length &gt; 0) {
<a name="l00475"></a>00475     <a class="code" href="../../d8/df0/frames_8js.html#acca2cb5dc9247f573a21f61583c8d81d">showFile</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a>);
<a name="l00476"></a>00476   }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   <span class="comment">// If there are no more photos show the &quot;no pix&quot; overlay</span>
<a name="l00479"></a>00479   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length === 0) {
<a name="l00480"></a>00480     <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> !== <a class="code" href="../../d0/da2/gallery_8js.html#a4020be717e9ac1015b4319904afa2dd6">pickView</a>)
<a name="l00481"></a>00481       <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l00482"></a>00482     <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<span class="stringliteral">&#39;emptygallery&#39;</span>);
<a name="l00483"></a>00483   }
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 
<a name="l00486"></a><a class="code" href="../../d0/da2/gallery_8js.html#a1d34740c9f45587facea86c15f99a2c6">00486</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a1d34740c9f45587facea86c15f99a2c6">deleteFile</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l00487"></a>00487   <span class="keywordflow">if</span> (n &lt; 0 || n &gt;= <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length)
<a name="l00488"></a>00488     <span class="keywordflow">return</span>;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490   <span class="comment">// Delete the file from the MediaDB. This removes the db entry and</span>
<a name="l00491"></a>00491   <span class="comment">// deletes the file in device storage. This will generate an change</span>
<a name="l00492"></a>00492   <span class="comment">// event which will call imageDeleted()</span>
<a name="l00493"></a>00493   var fileinfo = <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>];
<a name="l00494"></a>00494   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.deleteFile(<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>].<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   <span class="comment">// If it is a video, however, we can&#39;t just delete the poster image, but</span>
<a name="l00497"></a>00497   <span class="comment">// must also delete the video file.</span>
<a name="l00498"></a>00498   <span class="keywordflow">if</span> (fileinfo.metadata.video) {
<a name="l00499"></a>00499     <a class="code" href="../../d0/da2/gallery_8js.html#ace84f873229174800558862ac30942fd">videostorage</a>.delete(fileinfo.metadata.video);
<a name="l00500"></a>00500   }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502   <span class="comment">// If the metdata parser saved a preview image for this photo,</span>
<a name="l00503"></a>00503   <span class="comment">// delete that, too.</span>
<a name="l00504"></a>00504   <span class="keywordflow">if</span> (fileinfo.metadata.preview &amp;&amp; fileinfo.metadata.preview.filename) {
<a name="l00505"></a>00505     <span class="comment">// We use raw device storage here instead of MediaDB because that is</span>
<a name="l00506"></a>00506     <span class="comment">// what MetadataParser.js uses for saving the preview.</span>
<a name="l00507"></a>00507     var pictures = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.getDeviceStorage(<span class="stringliteral">&#39;pictures&#39;</span>);
<a name="l00508"></a>00508     pictures.delete(fileinfo.metadata.preview.filename);
<a name="l00509"></a>00509   }
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00512"></a><a class="code" href="../../d0/da2/gallery_8js.html#a99873e3fc1be38a0caf0999e2a5b6e65">00512</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a99873e3fc1be38a0caf0999e2a5b6e65">fileCreated</a>(fileinfo) {
<a name="l00513"></a>00513   var insertPosition;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515   <span class="comment">// If the new file is a video and we&#39;re handling an image pick activity</span>
<a name="l00516"></a>00516   <span class="comment">// then we won&#39;t display the new file.</span>
<a name="l00517"></a>00517   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a> &amp;&amp; fileinfo.metadata.video)
<a name="l00518"></a>00518     <span class="keywordflow">return</span>;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520   <span class="comment">// If we were showing the &#39;no pictures&#39; overlay, hide it</span>
<a name="l00521"></a>00521   <span class="keywordflow">if</span> (<a class="code" href="../../de/db0/music_8js.html#a113233cca2b0b908dba1be75b9c1f841">currentOverlay</a> === <span class="stringliteral">&#39;emptygallery&#39;</span> || <a class="code" href="../../de/db0/music_8js.html#a113233cca2b0b908dba1be75b9c1f841">currentOverlay</a> === <span class="stringliteral">&#39;scanning&#39;</span>)
<a name="l00522"></a>00522     <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524   <span class="comment">// If this new image is newer than the first one, it goes first</span>
<a name="l00525"></a>00525   <span class="comment">// This is the most common case for photos, screenshots, and edits</span>
<a name="l00526"></a>00526   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.length === 0 || fileinfo.date &gt; <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[0].date) {
<a name="l00527"></a>00527     insertPosition = 0;
<a name="l00528"></a>00528   }
<a name="l00529"></a>00529   <span class="keywordflow">else</span> {
<a name="l00530"></a>00530     <span class="comment">// Otherwise we have to search for the right insertion spot</span>
<a name="l00531"></a>00531     insertPosition = <a class="code" href="../../de/d44/build__stage_2email_2shared_2js_2media_2media__utils_8js.html#a383bbbc6e44855b8bed806ab1ded4c63">MediaUtils</a>.binarySearch(<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>, fileinfo,
<a name="l00532"></a>00532                                              <a class="code" href="../../d0/da2/gallery_8js.html#af0bf2f6ad5f7519cef00440ab733686b">compareFilesByDate</a>);
<a name="l00533"></a>00533   }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535   <span class="comment">// Insert the image info into the array</span>
<a name="l00536"></a>00536   <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>.splice(insertPosition, 0, fileinfo);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538   <span class="comment">// Create a thumbnail for this image and insert it at the right spot</span>
<a name="l00539"></a>00539   var thumbnail = <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a246682eea904b777ca4d4707f24232f2">createThumbnail</a>(insertPosition);
<a name="l00540"></a>00540   var thumbnailElts = thumbnails.querySelectorAll(<span class="stringliteral">&#39;.thumbnail&#39;</span>);
<a name="l00541"></a>00541   <span class="keywordflow">if</span> (thumbnailElts.length === 0)
<a name="l00542"></a>00542     thumbnails.appendChild(thumbnail);
<a name="l00543"></a>00543   <span class="keywordflow">else</span>
<a name="l00544"></a>00544     thumbnails.insertBefore(thumbnail, thumbnailElts[insertPosition]);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   <span class="comment">// increment the index of each of the thumbnails after the new one</span>
<a name="l00547"></a>00547   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = insertPosition; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; thumbnailElts.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00548"></a>00548     thumbnailElts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].dataset.index = <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> + 1;
<a name="l00549"></a>00549   }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a> &gt;= insertPosition)
<a name="l00552"></a>00552     <a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a>++;
<a name="l00553"></a>00553   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#abfe5eb1833402ced30625fd6582536d8">editedPhotoIndex</a> &gt;= insertPosition)
<a name="l00554"></a>00554     <a class="code" href="../../d0/da2/gallery_8js.html#abfe5eb1833402ced30625fd6582536d8">editedPhotoIndex</a>++;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   <span class="comment">// Redisplay the current photo if we&#39;re in photo view. The current</span>
<a name="l00557"></a>00557   <span class="comment">// photo should not change, but the content of the next or previous frame</span>
<a name="l00558"></a>00558   <span class="comment">// might. This call will only make changes if the filename to display</span>
<a name="l00559"></a>00559   <span class="comment">// in a frame has actually changed.</span>
<a name="l00560"></a>00560   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>) {
<a name="l00561"></a>00561     <a class="code" href="../../d8/df0/frames_8js.html#acca2cb5dc9247f573a21f61583c8d81d">showFile</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a>);
<a name="l00562"></a>00562   }
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 <span class="comment">// Make the thumbnail for image n visible</span>
<a name="l00566"></a><a class="code" href="../../d0/da2/gallery_8js.html#a28338bd953bdf52348c88293ad0c30d1">00566</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a28338bd953bdf52348c88293ad0c30d1">scrollToShowThumbnail</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>) {
<a name="l00567"></a>00567   var selector = <span class="stringliteral">&#39;li[data-index=&quot;&#39;</span> + <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a> + <span class="stringliteral">&#39;&quot;]&#39;</span>;
<a name="l00568"></a>00568   var thumbnail = thumbnails.querySelector(selector);
<a name="l00569"></a>00569   <span class="keywordflow">if</span> (thumbnail) {
<a name="l00570"></a>00570     var screenTop = thumbnails.scrollTop;
<a name="l00571"></a>00571     var screenBottom = screenTop + thumbnails.clientHeight;
<a name="l00572"></a>00572     var thumbnailTop = thumbnail.offsetTop;
<a name="l00573"></a>00573     var thumbnailBottom = thumbnailTop + thumbnail.offsetHeight;
<a name="l00574"></a>00574     var toolbarHeight = 40; <span class="comment">// compute this dynamically?</span>
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     <span class="comment">// Adjust the screen bottom up to be above the overlaid footer</span>
<a name="l00577"></a>00577     screenBottom -= toolbarHeight;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (thumbnailTop &lt; screenTop) {            <span class="comment">// If thumbnail is above screen</span>
<a name="l00580"></a>00580       thumbnails.scrollTop = thumbnailTop;     <span class="comment">// scroll up to show it.</span>
<a name="l00581"></a>00581     }
<a name="l00582"></a>00582     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (thumbnailBottom &gt; screenBottom) { <span class="comment">// If thumbnail is below screen</span>
<a name="l00583"></a>00583       thumbnails.scrollTop =                   <span class="comment">// scroll  down to show it</span>
<a name="l00584"></a>00584         thumbnailBottom - thumbnails.clientHeight + toolbarHeight;
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586   }
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a><a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">00589</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../db/d80/download_8js.html#acc4e419f5bedc9e697af56e25c615638">view</a>) {
<a name="l00590"></a>00590   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../db/d80/download_8js.html#acc4e419f5bedc9e697af56e25c615638">view</a>)
<a name="l00591"></a>00591     <span class="keywordflow">return</span>;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593   <span class="comment">// Do any necessary cleanup of the view we&#39;re exiting</span>
<a name="l00594"></a>00594   <span class="keywordflow">switch</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a>) {
<a name="l00595"></a>00595   <span class="keywordflow">case</span> <a class="code" href="../../d0/da2/gallery_8js.html#a98ed4b68cffd3f7a6fe97c3ab40865d5">thumbnailSelectView</a>:
<a name="l00596"></a>00596     <span class="comment">// Clear the selection, if there is one</span>
<a name="l00597"></a>00597     Array.forEach(thumbnails.querySelectorAll(<span class="stringliteral">&#39;.selected.thumbnail&#39;</span>),
<a name="l00598"></a>00598                   <span class="keyword">function</span>(elt) { elt.classList.remove(<span class="stringliteral">&#39;selected&#39;</span>); });
<a name="l00599"></a>00599     <span class="keywordflow">break</span>;
<a name="l00600"></a>00600   <span class="keywordflow">case</span> <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>:
<a name="l00601"></a>00601     <span class="comment">// Clear the frames to release the memory they&#39;re holding and</span>
<a name="l00602"></a>00602     <span class="comment">// so that we don&#39;t see a flash of the old image when we return</span>
<a name="l00603"></a>00603     <span class="comment">// to fullscreen view</span>
<a name="l00604"></a>00604     <a class="code" href="../../d8/df0/frames_8js.html#a5d60985775a23d0a9fc6afa50e245ddc">previousFrame</a>.clear();
<a name="l00605"></a>00605     <a class="code" href="../../d8/df0/frames_8js.html#a35a1d5b2c11c745f050a319c2940c383">currentFrame</a>.clear();
<a name="l00606"></a>00606     <a class="code" href="../../d8/df0/frames_8js.html#a007e837054378566ec403efc4d177e58">nextFrame</a>.clear();
<a name="l00607"></a>00607     <span class="keyword">delete</span> <a class="code" href="../../d8/df0/frames_8js.html#a5d60985775a23d0a9fc6afa50e245ddc">previousFrame</a>.filename;
<a name="l00608"></a>00608     <span class="keyword">delete</span> <a class="code" href="../../d8/df0/frames_8js.html#a35a1d5b2c11c745f050a319c2940c383">currentFrame</a>.filename;
<a name="l00609"></a>00609     <span class="keyword">delete</span> <a class="code" href="../../d8/df0/frames_8js.html#a007e837054378566ec403efc4d177e58">nextFrame</a>.filename;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     <span class="comment">// If we&#39;re leaving fullscreen, then we were just viewing a photo</span>
<a name="l00612"></a>00612     <span class="comment">// or video, so make sure its thumbnail is fully on the screen.</span>
<a name="l00613"></a>00613     <span class="comment">// XXX: do we need to defer this?</span>
<a name="l00614"></a>00614     <a class="code" href="../../d0/da2/gallery_8js.html#a28338bd953bdf52348c88293ad0c30d1">scrollToShowThumbnail</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a4c3a1c4e1efc6022bf003bb077daca89">currentFileIndex</a>);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="keywordflow">break</span>;
<a name="l00617"></a>00617   }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619   <span class="comment">// Show the specified view, and hide the others</span>
<a name="l00620"></a>00620   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; <a class="code" href="../../d0/da2/gallery_8js.html#a3ec184b947133eb14151f80d3ff05797">views</a>.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00621"></a>00621     <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a3ec184b947133eb14151f80d3ff05797">views</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>] === <a class="code" href="../../db/d80/download_8js.html#acc4e419f5bedc9e697af56e25c615638">view</a>)
<a name="l00622"></a>00622       <a class="code" href="../../d0/da2/gallery_8js.html#a3ec184b947133eb14151f80d3ff05797">views</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l00623"></a>00623     <span class="keywordflow">else</span>
<a name="l00624"></a>00624       <a class="code" href="../../d0/da2/gallery_8js.html#a3ec184b947133eb14151f80d3ff05797">views</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l00625"></a>00625   }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627   <span class="comment">// Now do setup for the view we&#39;re entering</span>
<a name="l00628"></a>00628   <span class="comment">// In particular, we&#39;ve got to set the thumbnail class appropriately</span>
<a name="l00629"></a>00629   <span class="comment">// for each view</span>
<a name="l00630"></a>00630   <span class="keywordflow">switch</span> (<a class="code" href="../../db/d80/download_8js.html#acc4e419f5bedc9e697af56e25c615638">view</a>) {
<a name="l00631"></a>00631   <span class="keywordflow">case</span> <a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>:
<a name="l00632"></a>00632     thumbnails.className = <span class="stringliteral">&#39;list&#39;</span>;
<a name="l00633"></a>00633     <span class="keywordflow">break</span>;
<a name="l00634"></a>00634   <span class="keywordflow">case</span> <a class="code" href="../../d0/da2/gallery_8js.html#a98ed4b68cffd3f7a6fe97c3ab40865d5">thumbnailSelectView</a>:
<a name="l00635"></a>00635     thumbnails.className = <span class="stringliteral">&#39;select&#39;</span>;
<a name="l00636"></a>00636     <span class="comment">// Set the view header to a localized string</span>
<a name="l00637"></a>00637     <a class="code" href="../../dd/d85/video_8js.html#a8504dd9a3990da74a9aa029b26e6fb1c">clearSelection</a>();
<a name="l00638"></a>00638     <span class="keywordflow">break</span>;
<a name="l00639"></a>00639   <span class="keywordflow">case</span> <a class="code" href="../../d0/da2/gallery_8js.html#a4020be717e9ac1015b4319904afa2dd6">pickView</a>:
<a name="l00640"></a>00640     thumbnails.className = <span class="stringliteral">&#39;pick&#39;</span>;
<a name="l00641"></a>00641     <span class="keywordflow">break</span>;
<a name="l00642"></a>00642   <span class="keywordflow">case</span> <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>:
<a name="l00643"></a>00643     thumbnails.className = <span class="stringliteral">&#39;offscreen&#39;</span>;
<a name="l00644"></a>00644     <span class="comment">// Show the toolbar</span>
<a name="l00645"></a>00645     <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>.classList.remove(<span class="stringliteral">&#39;toolbarhidden&#39;</span>);
<a name="l00646"></a>00646     <span class="keywordflow">break</span>;
<a name="l00647"></a>00647   <span class="keywordflow">default</span>:
<a name="l00648"></a>00648     thumbnails.className = <span class="stringliteral">&#39;offscreen&#39;</span>;
<a name="l00649"></a>00649     <span class="keywordflow">break</span>;
<a name="l00650"></a>00650   }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   <span class="comment">// Remember the current view</span>
<a name="l00653"></a>00653   <a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> = <a class="code" href="../../db/d80/download_8js.html#acc4e419f5bedc9e697af56e25c615638">view</a>;
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="comment">//</span>
<a name="l00657"></a>00657 <span class="comment">// Create a thumbnail element</span>
<a name="l00658"></a>00658 <span class="comment">//</span>
<a name="l00659"></a><a class="code" href="../../d0/da2/gallery_8js.html#a62192667594f8e388f74b81b6fff3f14">00659</a> <span class="keyword">function</span> <a class="code" href="../../d4/d76/camera_2js_2filmstrip_8js.html#a246682eea904b777ca4d4707f24232f2">createThumbnail</a>(imagenum) {
<a name="l00660"></a>00660   var li = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.createElement(<span class="stringliteral">&#39;li&#39;</span>);
<a name="l00661"></a>00661   li.dataset.index = imagenum;
<a name="l00662"></a>00662   li.classList.add(<span class="stringliteral">&#39;thumbnail&#39;</span>);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664   var fileinfo = <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[imagenum];
<a name="l00665"></a>00665   <span class="comment">// We revoke this url in imageDeleted</span>
<a name="l00666"></a>00666   var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> = <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.createObjectURL(fileinfo.metadata.thumbnail);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668   <span class="comment">// We set the url on a data attribute and let the onscreen</span>
<a name="l00669"></a>00669   <span class="comment">// and offscreen callbacks below set and unset the actual</span>
<a name="l00670"></a>00670   <span class="comment">// background image style. This means that we don&#39;t keep</span>
<a name="l00671"></a>00671   <span class="comment">// images decoded if we don&#39;t need them.</span>
<a name="l00672"></a>00672   li.dataset.backgroundImage = <span class="stringliteral">&#39;url(&quot;&#39;</span> + url + <span class="stringliteral">&#39;&quot;)&#39;</span>;
<a name="l00673"></a>00673   <span class="keywordflow">return</span> li;
<a name="l00674"></a>00674 }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="comment">// monitorChildVisibility() calls this when a thumbnail comes onscreen</span>
<a name="l00677"></a><a class="code" href="../../d0/da2/gallery_8js.html#a20faf3ee1393446ec53a3fff0f1d8a0e">00677</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a20faf3ee1393446ec53a3fff0f1d8a0e">thumbnailOnscreen</a>(thumbnail) {
<a name="l00678"></a>00678   <span class="keywordflow">if</span> (thumbnail.dataset.backgroundImage)
<a name="l00679"></a>00679     thumbnail.style.backgroundImage = thumbnail.dataset.backgroundImage;
<a name="l00680"></a>00680 }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682 <span class="comment">// monitorChildVisibility() calls this when a thumbnail goes offscreen</span>
<a name="l00683"></a><a class="code" href="../../d0/da2/gallery_8js.html#aa4068f2bdc717b6caa7bdd1260cc6ad4">00683</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#aa4068f2bdc717b6caa7bdd1260cc6ad4">thumbnailOffscreen</a>(thumbnail) {
<a name="l00684"></a>00684   <span class="keywordflow">if</span> (thumbnail.dataset.backgroundImage)
<a name="l00685"></a>00685     thumbnail.style.backgroundImage = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 <span class="comment">//</span>
<a name="l00689"></a>00689 <span class="comment">// Pick activity</span>
<a name="l00690"></a>00690 <span class="comment">//</span>
<a name="l00691"></a>00691 
<a name="l00692"></a><a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">00692</a> var <a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>;
<a name="l00693"></a><a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">00693</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a>;
<a name="l00694"></a><a class="code" href="../../d0/da2/gallery_8js.html#af563e56bf0e3a23b3c8c105348c40856">00694</a> var <a class="code" href="../../d0/da2/gallery_8js.html#af563e56bf0e3a23b3c8c105348c40856">pickWidth</a>, <a class="code" href="../../d0/da2/gallery_8js.html#a7f0c497bd222f05f8f5903f30df8847c">pickHeight</a>;
<a name="l00695"></a><a class="code" href="../../d0/da2/gallery_8js.html#a8dd2e31a3993ba9ad1d6f5731bd40bc8">00695</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a8dd2e31a3993ba9ad1d6f5731bd40bc8">pickedFile</a>;
<a name="l00696"></a><a class="code" href="../../d0/da2/gallery_8js.html#a26b64dc45471a983faeb5717e6b77ec8">00696</a> var <a class="code" href="../../d0/da2/gallery_8js.html#a26b64dc45471a983faeb5717e6b77ec8">cropURL</a>;
<a name="l00697"></a><a class="code" href="../../d0/da2/gallery_8js.html#aaddfccf9e6aee5cd9a61a1b35e0f38f5">00697</a> var <a class="code" href="../../d0/da2/gallery_8js.html#aaddfccf9e6aee5cd9a61a1b35e0f38f5">cropEditor</a>;
<a name="l00698"></a>00698 
<a name="l00699"></a><a class="code" href="../../d0/da2/gallery_8js.html#af1ea14645dcd3a1078e952cbde544991">00699</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#af1ea14645dcd3a1078e952cbde544991">startPick</a>() {
<a name="l00700"></a>00700   pickType = pendingPick.source.data.type;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702   <span class="keywordflow">if</span> (pendingPick.source.data.width &amp;&amp; pendingPick.source.data.height) {
<a name="l00703"></a>00703     pickWidth = pendingPick.source.data.width;
<a name="l00704"></a>00704     pickHeight = pendingPick.source.data.height;
<a name="l00705"></a>00705   }
<a name="l00706"></a>00706   <span class="keywordflow">else</span> {
<a name="l00707"></a>00707     pickWidth = pickHeight = 0;
<a name="l00708"></a>00708   }
<a name="l00709"></a>00709   <span class="comment">// We need frame_scripts and ImageEditor for cropping the photo</span>
<a name="l00710"></a>00710   <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a78601e1f2fe929d6470d82a205ad2382">loader</a>.load([<span class="stringliteral">&#39;js/frame_scripts.js&#39;</span>, <span class="stringliteral">&#39;js/ImageEditor.js&#39;</span>], <span class="keyword">function</span>() {
<a name="l00711"></a>00711     <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a4020be717e9ac1015b4319904afa2dd6">pickView</a>);
<a name="l00712"></a>00712   });
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 <span class="comment">// Called when the user clicks on a thumbnail in pick mode</span>
<a name="l00716"></a><a class="code" href="../../d0/da2/gallery_8js.html#a3076caeb3485095859089546849fda05">00716</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a3076caeb3485095859089546849fda05">cropPickedImage</a>(fileinfo) {
<a name="l00717"></a>00717   pickedFile = fileinfo;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719   <span class="comment">// Do we actually want to allow the user to crop the image?</span>
<a name="l00720"></a>00720   var nocrop = pendingPick.source.data.nocrop;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722   <span class="keywordflow">if</span> (nocrop) {
<a name="l00723"></a>00723     <span class="comment">// If we&#39;re not cropping we don&#39;t want the word &quot;Crop&quot; in the title bar</span>
<a name="l00724"></a>00724     <span class="comment">// XXX: UX will probably get rid of this title bar soon, anyway.</span>
<a name="l00725"></a>00725     $(<span class="stringliteral">&#39;crop-header&#39;</span>).<a class="code" href="../../d1/d04/app__install__manager_8js.html#a231b448a4b70e9035748897db2fa1c2a">textContent</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00726"></a>00726   }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#ad4442b6faaf0dee1d52cfe6c9deec24d">cropView</a>);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730   <span class="comment">// Before the picked image is loaded, the done button is disabled</span>
<a name="l00731"></a>00731   <span class="comment">// to avoid users picking a black/empty image.</span>
<a name="l00732"></a>00732   $(<span class="stringliteral">&#39;crop-done-button&#39;</span>).disabled = <span class="keyword">true</span>;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734   <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.getFile(pickedFile.name, <span class="keyword">function</span>(<a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>) {
<a name="l00735"></a>00735     cropURL = <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.createObjectURL(<a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>);
<a name="l00736"></a>00736     cropEditor = <span class="keyword">new</span> <a class="code" href="../../db/d0b/_image_editor_8js.html#a58ae4117f7725ecea1a99e4049fbc503">ImageEditor</a>(cropURL, $(<span class="stringliteral">&#39;crop-frame&#39;</span>), {}, <span class="keyword">function</span>() {
<a name="l00737"></a>00737       <span class="comment">// Enable the done button so that users are able to finish picking image.</span>
<a name="l00738"></a>00738       $(<span class="stringliteral">&#39;crop-done-button&#39;</span>).disabled = <span class="keyword">false</span>;
<a name="l00739"></a>00739       <span class="comment">// If the initiating app doesn&#39;t want to allow the user to crop</span>
<a name="l00740"></a>00740       <span class="comment">// the image, we don&#39;t display the crop overlay. But we still use</span>
<a name="l00741"></a>00741       <span class="comment">// this image editor to preview the image.</span>
<a name="l00742"></a>00742       <span class="keywordflow">if</span> (nocrop) {
<a name="l00743"></a>00743         <span class="comment">// Set a fake crop region even though we won&#39;t display it</span>
<a name="l00744"></a>00744         <span class="comment">// so that getCroppedRegionBlob() works.</span>
<a name="l00745"></a>00745         cropEditor.cropRegion.left = cropEditor.cropRegion.top = 0;
<a name="l00746"></a>00746         cropEditor.cropRegion.right = cropEditor.dest.w;
<a name="l00747"></a>00747         cropEditor.cropRegion.bottom = cropEditor.dest.h;
<a name="l00748"></a>00748         <span class="keywordflow">return</span>;
<a name="l00749"></a>00749       }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751       cropEditor.showCropOverlay();
<a name="l00752"></a>00752       <span class="keywordflow">if</span> (pickWidth)
<a name="l00753"></a>00753         cropEditor.setCropAspectRatio(pickWidth, pickHeight);
<a name="l00754"></a>00754       <span class="keywordflow">else</span>
<a name="l00755"></a>00755         cropEditor.setCropAspectRatio(); <span class="comment">// free form cropping</span>
<a name="l00756"></a>00756     });
<a name="l00757"></a>00757   });
<a name="l00758"></a>00758 }
<a name="l00759"></a>00759 
<a name="l00760"></a><a class="code" href="../../d0/da2/gallery_8js.html#a7e9da90af1c46280e00745b86da7ff0f">00760</a> <span class="keyword">function</span> <a class="code" href="../../d0/da2/gallery_8js.html#a7e9da90af1c46280e00745b86da7ff0f">cropAndEndPick</a>() {
<a name="l00761"></a>00761   <span class="keywordflow">if</span> (Array.isArray(<a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a>)) {
<a name="l00762"></a>00762     <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a>.length === 0 ||
<a name="l00763"></a>00763         <a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a>.indexOf(<a class="code" href="../../d0/da2/gallery_8js.html#a8dd2e31a3993ba9ad1d6f5731bd40bc8">pickedFile</a>.type) !== -1 ||
<a name="l00764"></a>00764         <a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a>.indexOf(<span class="stringliteral">&#39;image/*&#39;</span>) !== -1) {
<a name="l00765"></a>00765       <a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a> = <a class="code" href="../../d0/da2/gallery_8js.html#a8dd2e31a3993ba9ad1d6f5731bd40bc8">pickedFile</a>.type;
<a name="l00766"></a>00766     }
<a name="l00767"></a>00767     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a>.indexOf(<span class="stringliteral">&#39;image/png&#39;</span>) !== -1) {
<a name="l00768"></a>00768       <a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a> = <span class="stringliteral">&#39;image/png&#39;</span>;
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770     <span class="keywordflow">else</span> {
<a name="l00771"></a>00771       <a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a> = <span class="stringliteral">&#39;image/jpeg&#39;</span>;
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773   }
<a name="l00774"></a>00774   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a> === <span class="stringliteral">&#39;image/*&#39;</span>) {
<a name="l00775"></a>00775     <a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a> = <a class="code" href="../../d0/da2/gallery_8js.html#a8dd2e31a3993ba9ad1d6f5731bd40bc8">pickedFile</a>.type;
<a name="l00776"></a>00776   }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778   <span class="comment">// If we&#39;re not changing the file type or resizing the image and if</span>
<a name="l00779"></a>00779   <span class="comment">// we&#39;re not cropping, or if the user did not crop, then we can just</span>
<a name="l00780"></a>00780   <span class="comment">// use the file as it is.</span>
<a name="l00781"></a>00781   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a8dd2e31a3993ba9ad1d6f5731bd40bc8">pickedFile</a>.type &amp;&amp;
<a name="l00782"></a>00782       !<a class="code" href="../../d0/da2/gallery_8js.html#af563e56bf0e3a23b3c8c105348c40856">pickWidth</a> &amp;&amp; !<a class="code" href="../../d0/da2/gallery_8js.html#a7f0c497bd222f05f8f5903f30df8847c">pickHeight</a> &amp;&amp;
<a name="l00783"></a>00783       (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>.source.data.nocrop || !<a class="code" href="../../d0/da2/gallery_8js.html#aaddfccf9e6aee5cd9a61a1b35e0f38f5">cropEditor</a>.hasBeenCropped())) {
<a name="l00784"></a>00784     <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.getFile(<a class="code" href="../../d0/da2/gallery_8js.html#a8dd2e31a3993ba9ad1d6f5731bd40bc8">pickedFile</a>.name, endPick);
<a name="l00785"></a>00785   }
<a name="l00786"></a>00786   <span class="keywordflow">else</span> {
<a name="l00787"></a>00787     <a class="code" href="../../d0/da2/gallery_8js.html#aaddfccf9e6aee5cd9a61a1b35e0f38f5">cropEditor</a>.getCroppedRegionBlob(<a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a>, <a class="code" href="../../d0/da2/gallery_8js.html#af563e56bf0e3a23b3c8c105348c40856">pickWidth</a>, <a class="code" href="../../d0/da2/gallery_8js.html#a7f0c497bd222f05f8f5903f30df8847c">pickHeight</a>, endPick);
<a name="l00788"></a>00788   }
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 <span class="keyword">function</span> endPick(blob) {
<a name="l00792"></a>00792   <a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>.postResult({
<a name="l00793"></a>00793     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <a class="code" href="../../d0/da2/gallery_8js.html#a9239ddf9f374c69f3e76ad664f18170a">pickType</a>,
<a name="l00794"></a>00794     blob: blob
<a name="l00795"></a>00795   });
<a name="l00796"></a>00796   <a class="code" href="../../dd/d85/video_8js.html#a03df2043699e7f5e33046f6dfc4c1b53">cleanupPick</a>();
<a name="l00797"></a>00797 }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799 <span class="keyword">function</span> cancelPick() {
<a name="l00800"></a>00800   <a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>.postError(<span class="stringliteral">&#39;pick cancelled&#39;</span>);
<a name="l00801"></a>00801   <a class="code" href="../../dd/d85/video_8js.html#a03df2043699e7f5e33046f6dfc4c1b53">cleanupPick</a>();
<a name="l00802"></a>00802 }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804 <span class="keyword">function</span> cleanupCrop() {
<a name="l00805"></a>00805   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a26b64dc45471a983faeb5717e6b77ec8">cropURL</a>) {
<a name="l00806"></a>00806     <a class="code" href="../../d6/dfe/class_u_r_l.html">URL</a>.revokeObjectURL(<a class="code" href="../../d0/da2/gallery_8js.html#a26b64dc45471a983faeb5717e6b77ec8">cropURL</a>);
<a name="l00807"></a>00807     <a class="code" href="../../d0/da2/gallery_8js.html#a26b64dc45471a983faeb5717e6b77ec8">cropURL</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00808"></a>00808   }
<a name="l00809"></a>00809   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#aaddfccf9e6aee5cd9a61a1b35e0f38f5">cropEditor</a>) {
<a name="l00810"></a>00810     <a class="code" href="../../d0/da2/gallery_8js.html#aaddfccf9e6aee5cd9a61a1b35e0f38f5">cropEditor</a>.destroy();
<a name="l00811"></a>00811     <a class="code" href="../../d0/da2/gallery_8js.html#aaddfccf9e6aee5cd9a61a1b35e0f38f5">cropEditor</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00812"></a>00812   }
<a name="l00813"></a>00813 }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#a03df2043699e7f5e33046f6dfc4c1b53">cleanupPick</a>() {
<a name="l00816"></a>00816   cleanupCrop();
<a name="l00817"></a>00817   <a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00818"></a>00818   <a class="code" href="../../d0/da2/gallery_8js.html#a8dd2e31a3993ba9ad1d6f5731bd40bc8">pickedFile</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00819"></a>00819   <a class="code" href="../../d0/da2/gallery_8js.html#a87c564c1396bcdba1067fd5afa2a9815">setView</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a>);
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 <span class="comment">// XXX If the user goes to the homescreen or switches to another app</span>
<a name="l00823"></a>00823 <span class="comment">// the pick request is implicitly cancelled</span>
<a name="l00824"></a>00824 <span class="comment">// Remove this code when https://github.com/mozilla-b2g/gaia/issues/2916</span>
<a name="l00825"></a>00825 <span class="comment">// is fixed and replace it with an onerror handler on the activity to</span>
<a name="l00826"></a>00826 <span class="comment">// switch out of pickView.</span>
<a name="l00827"></a>00827 <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;visibilitychange&#39;</span>, <span class="keyword">function</span>() {
<a name="l00828"></a>00828   <span class="keywordflow">if</span> (<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.hidden &amp;&amp; <a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>)
<a name="l00829"></a>00829     cancelPick();
<a name="l00830"></a>00830 });
<a name="l00831"></a>00831 
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 <span class="comment">//</span>
<a name="l00834"></a>00834 <span class="comment">// Event handlers</span>
<a name="l00835"></a>00835 <span class="comment">//</span>
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 <span class="comment">// Clicking on a thumbnail does different things depending on the view.</span>
<a name="l00838"></a>00838 <span class="comment">// In thumbnail list mode, it displays the image. In thumbanilSelect mode</span>
<a name="l00839"></a>00839 <span class="comment">// it selects the image. In pick mode, it finishes the pick activity</span>
<a name="l00840"></a>00840 <span class="comment">// with the image filename</span>
<a name="l00841"></a>00841 <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#a7e53b2a5efd2d199bb7a70417e3d9b75">thumbnailClickHandler</a>(evt) {
<a name="l00842"></a>00842   var <a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a> = evt.target;
<a name="l00843"></a>00843   <span class="keywordflow">if</span> (!target || !target.classList.contains(<span class="stringliteral">&#39;thumbnail&#39;</span>))
<a name="l00844"></a>00844     <span class="keywordflow">return</span>;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a3698d255731771347d7f847313d8aa7f">thumbnailListView</a> || <a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>) {
<a name="l00847"></a>00847     <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a78601e1f2fe929d6470d82a205ad2382">loader</a>.load(<span class="stringliteral">&#39;js/frame_scripts.js&#39;</span>, <span class="keyword">function</span>() {
<a name="l00848"></a>00848       <a class="code" href="../../d8/df0/frames_8js.html#acca2cb5dc9247f573a21f61583c8d81d">showFile</a>(parseInt(target.dataset.index));
<a name="l00849"></a>00849     });
<a name="l00850"></a>00850   }
<a name="l00851"></a>00851   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a98ed4b68cffd3f7a6fe97c3ab40865d5">thumbnailSelectView</a>) {
<a name="l00852"></a>00852     <a class="code" href="../../dd/d85/video_8js.html#abf93aff80867b9e72335f08461dcf3d8">updateSelection</a>(target);
<a name="l00853"></a>00853   }
<a name="l00854"></a>00854   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a4020be717e9ac1015b4319904afa2dd6">pickView</a>) {
<a name="l00855"></a>00855     <a class="code" href="../../d0/da2/gallery_8js.html#a3076caeb3485095859089546849fda05">cropPickedImage</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[parseInt(target.dataset.index)]);
<a name="l00856"></a>00856   }
<a name="l00857"></a>00857 }
<a name="l00858"></a>00858 
<a name="l00859"></a>00859 <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#a8504dd9a3990da74a9aa029b26e6fb1c">clearSelection</a>() {
<a name="l00860"></a>00860   <a class="code" href="../../d0/da2/gallery_8js.html#af0fd4e3510447825b3d4ef3034f756d9">selectedFileNames</a> = [];
<a name="l00861"></a>00861   <a class="code" href="../../d0/da2/gallery_8js.html#a687cffebc743e15f61c94b32f18a7ea5">selectedFileNamesToBlobs</a> = {};
<a name="l00862"></a>00862   $(<span class="stringliteral">&#39;thumbnails-delete-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l00863"></a>00863   $(<span class="stringliteral">&#39;thumbnails-share-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l00864"></a>00864   $(<span class="stringliteral">&#39;thumbnails-number-selected&#39;</span>).<a class="code" href="../../d1/d04/app__install__manager_8js.html#a231b448a4b70e9035748897db2fa1c2a">textContent</a> =
<a name="l00865"></a>00865     <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;number-selected2&#39;</span>, { <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>: 0 });
<a name="l00866"></a>00866 }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 <span class="comment">// When we enter thumbnail selection mode, or when the selection changes</span>
<a name="l00869"></a>00869 <span class="comment">// we call this function to update the message the top of the screen and to</span>
<a name="l00870"></a>00870 <span class="comment">// enable or disable the Delete and Share buttons</span>
<a name="l00871"></a>00871 <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#abf93aff80867b9e72335f08461dcf3d8">updateSelection</a>(thumbnail) {
<a name="l00872"></a>00872   <span class="comment">// First, update the visual appearance of the element</span>
<a name="l00873"></a>00873   thumbnail.classList.toggle(<span class="stringliteral">&#39;selected&#39;</span>);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875   <span class="comment">// Now update the list of selected filenames and filename-&gt;blob map</span>
<a name="l00876"></a>00876   <span class="comment">// based on whether we selected or deselected the thumbnail</span>
<a name="l00877"></a>00877   var selected = thumbnail.classList.contains(<span class="stringliteral">&#39;selected&#39;</span>);
<a name="l00878"></a>00878   var <a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a> = parseInt(thumbnail.dataset.index);
<a name="l00879"></a>00879   var <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a> = <a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#aafd95f8c7a99b9189ede7cdf0871ebe8">index</a>].name;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881   <span class="keywordflow">if</span> (selected) {
<a name="l00882"></a>00882     <a class="code" href="../../d0/da2/gallery_8js.html#af0fd4e3510447825b3d4ef3034f756d9">selectedFileNames</a>.push(filename);
<a name="l00883"></a>00883     <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[index].metadata.video) {
<a name="l00884"></a>00884       <a class="code" href="../../d0/da2/gallery_8js.html#a377c40257a942d42736eccd490acfec4">getVideoFile</a>(<a class="code" href="../../d0/da2/gallery_8js.html#a0742cac2750bccc2d88ac080fb9daa22">files</a>[index].metadata.video, <span class="keyword">function</span>(<a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>) {
<a name="l00885"></a>00885         <a class="code" href="../../d0/da2/gallery_8js.html#a687cffebc743e15f61c94b32f18a7ea5">selectedFileNamesToBlobs</a>[filename] = <a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>;
<a name="l00886"></a>00886       });
<a name="l00887"></a>00887     }
<a name="l00888"></a>00888     <span class="keywordflow">else</span> {
<a name="l00889"></a>00889       <span class="comment">// We get photos through the photo db</span>
<a name="l00890"></a>00890       <a class="code" href="../../d0/da2/gallery_8js.html#ae763c70dbeeb5adce20b1e06f0cd1a9a">photodb</a>.getFile(filename, <span class="keyword">function</span>(<a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>) {
<a name="l00891"></a>00891         <a class="code" href="../../d0/da2/gallery_8js.html#a687cffebc743e15f61c94b32f18a7ea5">selectedFileNamesToBlobs</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>] = <a class="code" href="../../db/d2a/_utility_8h.html#a5f21914f6755df23fc8ddbf42503beca">file</a>;
<a name="l00892"></a>00892       });
<a name="l00893"></a>00893     }
<a name="l00894"></a>00894   }
<a name="l00895"></a>00895   <span class="keywordflow">else</span> {
<a name="l00896"></a>00896     <span class="keyword">delete</span> <a class="code" href="../../d0/da2/gallery_8js.html#a687cffebc743e15f61c94b32f18a7ea5">selectedFileNamesToBlobs</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>];
<a name="l00897"></a>00897     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = <a class="code" href="../../d0/da2/gallery_8js.html#af0fd4e3510447825b3d4ef3034f756d9">selectedFileNames</a>.indexOf(filename);
<a name="l00898"></a>00898     <span class="keywordflow">if</span> (i !== -1)
<a name="l00899"></a>00899       <a class="code" href="../../d0/da2/gallery_8js.html#af0fd4e3510447825b3d4ef3034f756d9">selectedFileNames</a>.splice(i, 1);
<a name="l00900"></a>00900   }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902   <span class="comment">// Now update the UI based on the number of selected thumbnails</span>
<a name="l00903"></a>00903   var numSelected = <a class="code" href="../../d0/da2/gallery_8js.html#af0fd4e3510447825b3d4ef3034f756d9">selectedFileNames</a>.length;
<a name="l00904"></a>00904   var <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a> = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;number-selected2&#39;</span>, { <a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>: numSelected });
<a name="l00905"></a>00905   $(<span class="stringliteral">&#39;thumbnails-number-selected&#39;</span>).<a class="code" href="../../d1/d04/app__install__manager_8js.html#a231b448a4b70e9035748897db2fa1c2a">textContent</a> = msg;
<a name="l00906"></a>00906 
<a name="l00907"></a>00907   <span class="keywordflow">if</span> (numSelected === 0) {
<a name="l00908"></a>00908     $(<span class="stringliteral">&#39;thumbnails-delete-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l00909"></a>00909     $(<span class="stringliteral">&#39;thumbnails-share-button&#39;</span>).classList.add(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l00910"></a>00910   }
<a name="l00911"></a>00911   <span class="keywordflow">else</span> {
<a name="l00912"></a>00912     $(<span class="stringliteral">&#39;thumbnails-delete-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l00913"></a>00913     $(<span class="stringliteral">&#39;thumbnails-share-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;disabled&#39;</span>);
<a name="l00914"></a>00914   }
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917 <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#af2e261a1ef7f340a5c693d2b6a1b92ed">launchCameraApp</a>() {
<a name="l00918"></a>00918   var <a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a> = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28ab7e07971d28f2ebf8ff15ee0f268f2e1">MozActivity</a>({
<a name="l00919"></a>00919     <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>: <span class="stringliteral">&#39;record&#39;</span>,
<a name="l00920"></a>00920     <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: {
<a name="l00921"></a>00921       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;photos&#39;</span>
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923   });
<a name="l00924"></a>00924 }
<a name="l00925"></a>00925 
<a name="l00926"></a>00926 <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#aebc1dbd30434352ff024a083c75b5b4f">deleteSelectedItems</a>() {
<a name="l00927"></a>00927   var selected = thumbnails.querySelectorAll(<span class="stringliteral">&#39;.selected.thumbnail&#39;</span>);
<a name="l00928"></a>00928   <span class="keywordflow">if</span> (selected.length === 0)
<a name="l00929"></a>00929     <span class="keywordflow">return</span>;
<a name="l00930"></a>00930 
<a name="l00931"></a>00931   showConfirmDialog({
<a name="l00932"></a>00932     <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>: <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;delete-n-items?&#39;</span>, {<a class="code" href="../../d2/d7d/jsapi_8h.html#aa5a8b9a2d5edc8e2e7ba67d7e2ee4e69">n</a>: selected.length}),
<a name="l00933"></a>00933     cancelText: <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;cancel&#39;</span>),
<a name="l00934"></a>00934     confirmText: <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;delete&#39;</span>),
<a name="l00935"></a>00935     <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#aa9a1d7695902481fc7a46c0d1822bb41">danger</a>: <span class="keyword">true</span>
<a name="l00936"></a>00936   }, <span class="keyword">function</span>() { <span class="comment">// onSuccess</span>
<a name="l00937"></a>00937     <span class="comment">// deleteFile is O(n), so this loop is O(n*n). If used with really large</span>
<a name="l00938"></a>00938     <span class="comment">// selections, it might have noticably bad performance.  If so, we</span>
<a name="l00939"></a>00939     <span class="comment">// can write a more efficient deleteFiles() function.</span>
<a name="l00940"></a>00940     <span class="keywordflow">for</span> (var i = 0; i &lt; selected.length; i++) {
<a name="l00941"></a>00941       selected[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].classList.toggle(<span class="stringliteral">&#39;selected&#39;</span>);
<a name="l00942"></a>00942       <a class="code" href="../../d0/da2/gallery_8js.html#a1d34740c9f45587facea86c15f99a2c6">deleteFile</a>(parseInt(selected[i].dataset.index, 10));
<a name="l00943"></a>00943     }
<a name="l00944"></a>00944     <a class="code" href="../../dd/d85/video_8js.html#a8504dd9a3990da74a9aa029b26e6fb1c">clearSelection</a>();
<a name="l00945"></a>00945   });
<a name="l00946"></a>00946 }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948 <span class="comment">// show a confirm dialog</span>
<a name="l00949"></a>00949 <span class="keyword">function</span> showConfirmDialog(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, onConfirm, onCancel) {
<a name="l00950"></a>00950   <a class="code" href="../../d3/db5/build__stage_2email_2shared_2js_2lazy__loader_8js.html#aaf5eec8afd0243eeb2166f74e472c877">LazyLoader</a>.load(<span class="stringliteral">&#39;shared/style/confirm.css&#39;</span>, <span class="keyword">function</span>() {
<a name="l00951"></a>00951     var <a class="code" href="../../d1/d04/app__install__manager_8js.html#a888e6068bf00699dfddf2b6ee25e6c7a">dialog</a> = $(<span class="stringliteral">&#39;confirm-dialog&#39;</span>);
<a name="l00952"></a>00952     var msgEle = $(<span class="stringliteral">&#39;confirm-msg&#39;</span>);
<a name="l00953"></a>00953     var cancelButton = $(<span class="stringliteral">&#39;confirm-cancel&#39;</span>);
<a name="l00954"></a>00954     var confirmButton = $(<span class="stringliteral">&#39;confirm-ok&#39;</span>);
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     <span class="comment">// set up the dialog based on the options</span>
<a name="l00957"></a>00957     msgEle.textContent = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.message;
<a name="l00958"></a>00958     cancelButton.textContent = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.cancelText ||
<a name="l00959"></a>00959       <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;cancel&#39;</span>);
<a name="l00960"></a>00960     confirmButton.textContent = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.confirmText ||
<a name="l00961"></a>00961       <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;ok&#39;</span>);
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>.danger) {
<a name="l00964"></a>00964       confirmButton.classList.add(<span class="stringliteral">&#39;danger&#39;</span>);
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966     <span class="keywordflow">else</span> {
<a name="l00967"></a>00967       confirmButton.classList.remove(<span class="stringliteral">&#39;danger&#39;</span>);
<a name="l00968"></a>00968     }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     <span class="comment">// show the confirm dialog</span>
<a name="l00971"></a>00971     dialog.classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973     <span class="comment">// attach event handlers</span>
<a name="l00974"></a>00974     var onCancelClick = <span class="keyword">function</span>(ev) {
<a name="l00975"></a>00975       <a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a>(ev);
<a name="l00976"></a>00976       <span class="keywordflow">if</span> (onCancel) {
<a name="l00977"></a>00977         onCancel();
<a name="l00978"></a>00978       }
<a name="l00979"></a>00979       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00980"></a>00980     };
<a name="l00981"></a>00981     var onConfirmClick = <span class="keyword">function</span>(ev) {
<a name="l00982"></a>00982       <a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a>(ev);
<a name="l00983"></a>00983       <span class="keywordflow">if</span> (onConfirm) {
<a name="l00984"></a>00984         onConfirm();
<a name="l00985"></a>00985       }
<a name="l00986"></a>00986       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00987"></a>00987     };
<a name="l00988"></a>00988     cancelButton.addEventListener(<span class="stringliteral">&#39;click&#39;</span>, onCancelClick);
<a name="l00989"></a>00989     confirmButton.addEventListener(<span class="stringliteral">&#39;click&#39;</span>, onConfirmClick);
<a name="l00990"></a>00990 
<a name="l00991"></a>00991     <span class="keyword">function</span> <a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a>(ev) {
<a name="l00992"></a>00992       dialog.classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l00993"></a>00993       cancelButton.removeEventListener(<span class="stringliteral">&#39;click&#39;</span>, onCancelClick);
<a name="l00994"></a>00994       confirmButton.removeEventListener(<span class="stringliteral">&#39;click&#39;</span>, onConfirmClick);
<a name="l00995"></a>00995       ev.preventDefault();
<a name="l00996"></a>00996       ev.stopPropagation();
<a name="l00997"></a>00997       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999   });
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 <span class="comment">// Clicking on the share button in select mode shares all selected images</span>
<a name="l01004"></a>01004 <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#aa4d606e25464d76378eb75550ec7663c">shareSelectedItems</a>() {
<a name="l01005"></a>01005   var blobs = <a class="code" href="../../d0/da2/gallery_8js.html#af0fd4e3510447825b3d4ef3034f756d9">selectedFileNames</a>.map(<span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>) {
<a name="l01006"></a>01006     <span class="keywordflow">return</span> <a class="code" href="../../d0/da2/gallery_8js.html#a687cffebc743e15f61c94b32f18a7ea5">selectedFileNamesToBlobs</a>[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>];
<a name="l01007"></a>01007   });
<a name="l01008"></a>01008   <a class="code" href="../../dd/d85/video_8js.html#a1adf7471b1bc968b8517bf786fffa94d">share</a>(blobs);
<a name="l01009"></a>01009 }
<a name="l01010"></a>01010 
<a name="l01011"></a>01011 <span class="keyword">function</span> <a class="code" href="../../dd/d85/video_8js.html#a1adf7471b1bc968b8517bf786fffa94d">share</a>(blobs) {
<a name="l01012"></a>01012   <span class="keywordflow">if</span> (blobs.length === 0)
<a name="l01013"></a>01013     <span class="keywordflow">return</span>;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015   var <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#ae76808cc87130a0f45031b8fdc26ea2b">names</a> = [], <a class="code" href="../../df/d12/latin__test_8js.html#a9b2ffd3686cfee1e001186fb61e302a4">types</a> = [], fullpaths = [];
<a name="l01016"></a>01016 
<a name="l01017"></a>01017   <span class="comment">// Get the file name (minus path) and type of each blob</span>
<a name="l01018"></a>01018   blobs.forEach(<span class="keyword">function</span>(blob) {
<a name="l01019"></a>01019     <span class="comment">// Discard the path, we just want the base name</span>
<a name="l01020"></a>01020     var <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> = blob.name;
<a name="l01021"></a>01021     <span class="comment">// We try to fix Bug 814323 by using</span>
<a name="l01022"></a>01022     <span class="comment">// current workaround of bluetooth transfer</span>
<a name="l01023"></a>01023     <span class="comment">// so we will pass both filenames and fullpaths</span>
<a name="l01024"></a>01024     <span class="comment">// The fullpaths can be removed after Bug 811615 is fixed</span>
<a name="l01025"></a>01025     fullpaths.push(name);
<a name="l01026"></a>01026     name = name.substring(name.lastIndexOf(<span class="charliteral">&#39;/&#39;</span>) + 1);
<a name="l01027"></a>01027     names.push(name);
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     <span class="comment">// And we just want the first component of the type &quot;image&quot; or &quot;video&quot;</span>
<a name="l01030"></a>01030     var <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = blob.type;
<a name="l01031"></a>01031     <span class="keywordflow">if</span> (type)
<a name="l01032"></a>01032       type = type.substring(0, type.indexOf(<span class="charliteral">&#39;/&#39;</span>));
<a name="l01033"></a>01033     <a class="code" href="../../df/d12/latin__test_8js.html#a9b2ffd3686cfee1e001186fb61e302a4">types</a>.push(type);
<a name="l01034"></a>01034   });
<a name="l01035"></a>01035 
<a name="l01036"></a>01036   <span class="comment">// If there is just one type, or if all types are the same, then use</span>
<a name="l01037"></a>01037   <span class="comment">// that type plus &#39;/*&#39;. Otherwise, use &#39;multipart/mixed&#39;</span>
<a name="l01038"></a>01038   <span class="comment">// If all the blobs are image we use &#39;image/*&#39;. If all are videos</span>
<a name="l01039"></a>01039   <span class="comment">// we use &#39;video/*&#39;. Otherwise, &#39;multipart/mixed&#39;.</span>
<a name="l01040"></a>01040   var <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>;
<a name="l01041"></a>01041   <span class="keywordflow">if</span> (<a class="code" href="../../df/d12/latin__test_8js.html#a9b2ffd3686cfee1e001186fb61e302a4">types</a>.length === 1 || <a class="code" href="../../df/d12/latin__test_8js.html#a9b2ffd3686cfee1e001186fb61e302a4">types</a>.every(<span class="keyword">function</span>(t) { <span class="keywordflow">return</span> t === <a class="code" href="../../df/d12/latin__test_8js.html#a9b2ffd3686cfee1e001186fb61e302a4">types</a>[0]; }))
<a name="l01042"></a>01042     type = <a class="code" href="../../df/d12/latin__test_8js.html#a9b2ffd3686cfee1e001186fb61e302a4">types</a>[0] + <span class="stringliteral">&#39;/*&#39;</span>;
<a name="l01043"></a>01043   <span class="keywordflow">else</span>
<a name="l01044"></a>01044     type = <span class="stringliteral">&#39;multipart/mixed&#39;</span>;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046   var a = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28ab7e07971d28f2ebf8ff15ee0f268f2e1">MozActivity</a>({
<a name="l01047"></a>01047     name: <span class="stringliteral">&#39;share&#39;</span>,
<a name="l01048"></a>01048     <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: {
<a name="l01049"></a>01049       type: <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>,
<a name="l01050"></a>01050       number: blobs.length,
<a name="l01051"></a>01051       blobs: blobs,
<a name="l01052"></a>01052       filenames: <a class="code" href="../../d4/d00/tools_2xpcwindow_2lib_2modules_2debug_8js.html#ae76808cc87130a0f45031b8fdc26ea2b">names</a>,
<a name="l01053"></a>01053       filepaths: fullpaths
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055   });
<a name="l01056"></a>01056 
<a name="l01057"></a>01057   a.onerror = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l01058"></a>01058     <span class="keywordflow">if</span> (a.error.name === <span class="stringliteral">&#39;NO_PROVIDER&#39;</span>) {
<a name="l01059"></a>01059       var msg = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;share-noprovider&#39;</span>);
<a name="l01060"></a>01060       <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a91dfa6843538cd55b524a76b1afc329c">alert</a>(msg);
<a name="l01061"></a>01061     }
<a name="l01062"></a>01062     <span class="keywordflow">else</span> {
<a name="l01063"></a>01063       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;share activity error:&#39;</span>, a.error.name);
<a name="l01064"></a>01064     }
<a name="l01065"></a>01065   };
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068 <span class="comment">// This happens when the user rotates the phone.</span>
<a name="l01069"></a>01069 <span class="comment">// When we used mozRequestFullscreen, it would also happen</span>
<a name="l01070"></a>01070 <span class="comment">// when we entered or left fullscreen mode.</span>
<a name="l01071"></a>01071 <span class="keyword">function</span> <a class="code" href="../../db/d0b/_image_editor_8js.html#a949ea6f42ae029faa03eb19facfa08b0">resizeHandler</a>() {
<a name="l01072"></a>01072   <span class="comment">//</span>
<a name="l01073"></a>01073   <span class="comment">// When we enter or leave fullscreen mode, we get two resize events.</span>
<a name="l01074"></a>01074   <span class="comment">// When we get the first one, we don&#39;t know what our new size is, so</span>
<a name="l01075"></a>01075   <span class="comment">// we just ignore it. XXX: we&#39;re not using fullscreen mode anymore,</span>
<a name="l01076"></a>01076   <span class="comment">// but it seems safer to leave this code in.</span>
<a name="l01077"></a>01077   <span class="comment">//</span>
<a name="l01078"></a>01078   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>.offsetWidth === 0 &amp;&amp; <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>.offsetHeight === 0)
<a name="l01079"></a>01079     <span class="keywordflow">return</span>;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081   <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#a08af05bd40494df0acb6c7ecf8fb25f7">currentView</a> === <a class="code" href="../../d0/da2/gallery_8js.html#a495a99b2d5539eb2ef1cebea1d91710c">fullscreenView</a>) {
<a name="l01082"></a>01082     <a class="code" href="../../d8/df0/frames_8js.html#a35a1d5b2c11c745f050a319c2940c383">currentFrame</a>.resize();
<a name="l01083"></a>01083     <a class="code" href="../../d8/df0/frames_8js.html#a5d60985775a23d0a9fc6afa50e245ddc">previousFrame</a>.reset();
<a name="l01084"></a>01084     <a class="code" href="../../d8/df0/frames_8js.html#a007e837054378566ec403efc4d177e58">nextFrame</a>.reset();
<a name="l01085"></a>01085 
<a name="l01086"></a>01086     <span class="comment">// We also have to reposition the frames to get the next and previous</span>
<a name="l01087"></a>01087     <span class="comment">// frames the correct distance away from the current frame</span>
<a name="l01088"></a>01088     <a class="code" href="../../d8/df0/frames_8js.html#a1e990ee9315d596bcab04e06af23ceea">setFramesPosition</a>();
<a name="l01089"></a>01089   }
<a name="l01090"></a>01090 }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092 <span class="comment">//</span>
<a name="l01093"></a>01093 <span class="comment">// Overlay messages</span>
<a name="l01094"></a>01094 <span class="comment">//</span>
<a name="l01095"></a>01095 var <a class="code" href="../../de/db0/music_8js.html#a113233cca2b0b908dba1be75b9c1f841">currentOverlay</a>;  <span class="comment">// The id of the current overlay or null if none.</span>
<a name="l01096"></a>01096 
<a name="l01097"></a>01097 <span class="comment">//</span>
<a name="l01098"></a>01098 <span class="comment">// If id is null then hide the overlay. Otherwise, look up the localized</span>
<a name="l01099"></a>01099 <span class="comment">// text for the specified id and display the overlay with that text.</span>
<a name="l01100"></a>01100 <span class="comment">// Supported ids include:</span>
<a name="l01101"></a>01101 <span class="comment">//</span>
<a name="l01102"></a>01102 <span class="comment">//   nocard: no sdcard is installed in the phone</span>
<a name="l01103"></a>01103 <span class="comment">//   pluggedin: the sdcard is being used by USB mass storage</span>
<a name="l01104"></a>01104 <span class="comment">//   emptygallery: no pictures found</span>
<a name="l01105"></a>01105 <span class="comment">//   scanning: scanning the sdcard for photo&#39;s, but none found yet</span>
<a name="l01106"></a>01106 <span class="comment">//</span>
<a name="l01107"></a>01107 <span class="comment">// Localization is done using the specified id with &quot;-title&quot; and &quot;-text&quot;</span>
<a name="l01108"></a>01108 <span class="comment">// suffixes.</span>
<a name="l01109"></a>01109 <span class="comment">//</span>
<a name="l01110"></a>01110 <span class="keyword">function</span> <a class="code" href="../../de/db0/music_8js.html#a06b9f891a17c6f5559d8709267729496">showOverlay</a>(<span class="keywordtype">id</span>) {
<a name="l01111"></a>01111   <a class="code" href="../../d3/db5/build__stage_2email_2shared_2js_2lazy__loader_8js.html#aaf5eec8afd0243eeb2166f74e472c877">LazyLoader</a>.load(<span class="stringliteral">&#39;shared/style/confirm.css&#39;</span>, <span class="keyword">function</span>() {
<a name="l01112"></a>01112     currentOverlay = <a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114     <span class="comment">// hide any special elements</span>
<a name="l01115"></a>01115     $(<span class="stringliteral">&#39;storage-setting-button&#39;</span>).classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01116"></a>01116     $(<span class="stringliteral">&#39;overlay-camera-button&#39;</span>).classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01117"></a>01117     $(<span class="stringliteral">&#39;overlay-cancel-button&#39;</span>).classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01118"></a>01118     $(<span class="stringliteral">&#39;overlay-menu&#39;</span>).classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01119"></a>01119     var <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa5a506cf1e53b91549e35a5d3bc3dc06">title</a>, <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>;
<a name="l01120"></a>01120     <span class="keywordflow">switch</span> (currentOverlay) {
<a name="l01121"></a>01121       <span class="keywordflow">case</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>:
<a name="l01122"></a>01122         $(<span class="stringliteral">&#39;overlay&#39;</span>).classList.add(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01123"></a>01123         <span class="keywordflow">return</span>;
<a name="l01124"></a>01124       <span class="keywordflow">case</span> <span class="stringliteral">&#39;nocard&#39;</span>:
<a name="l01125"></a>01125         title = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;nocard3-title&#39;</span>);
<a name="l01126"></a>01126         text = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;nocard3-text&#39;</span>);
<a name="l01127"></a>01127         $(<span class="stringliteral">&#39;overlay-menu&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01128"></a>01128         <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>) {
<a name="l01129"></a>01129           $(<span class="stringliteral">&#39;overlay-cancel-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01130"></a>01130         } <span class="keywordflow">else</span> {
<a name="l01131"></a>01131           $(<span class="stringliteral">&#39;storage-setting-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01132"></a>01132         }
<a name="l01133"></a>01133         <span class="keywordflow">break</span>;
<a name="l01134"></a>01134       <span class="keywordflow">case</span> <span class="stringliteral">&#39;pluggedin&#39;</span>:
<a name="l01135"></a>01135         title = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;pluggedin2-title&#39;</span>);
<a name="l01136"></a>01136         text = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;pluggedin2-text&#39;</span>);
<a name="l01137"></a>01137         <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>) {
<a name="l01138"></a>01138           $(<span class="stringliteral">&#39;overlay-cancel-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01139"></a>01139           $(<span class="stringliteral">&#39;overlay-menu&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01140"></a>01140         }
<a name="l01141"></a>01141         <span class="keywordflow">break</span>;
<a name="l01142"></a>01142       <span class="keywordflow">case</span> <span class="stringliteral">&#39;scanning&#39;</span>:
<a name="l01143"></a>01143         title = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;scanning-title&#39;</span>);
<a name="l01144"></a>01144         text = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;scanning-text&#39;</span>);
<a name="l01145"></a>01145         <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>) {
<a name="l01146"></a>01146           $(<span class="stringliteral">&#39;overlay-cancel-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01147"></a>01147           $(<span class="stringliteral">&#39;overlay-menu&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01148"></a>01148         }
<a name="l01149"></a>01149         <span class="keywordflow">break</span>;
<a name="l01150"></a>01150       <span class="keywordflow">case</span> <span class="stringliteral">&#39;emptygallery&#39;</span>:
<a name="l01151"></a>01151         title = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;emptygallery2-title&#39;</span>);
<a name="l01152"></a>01152         text = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;emptygallery2-text&#39;</span>);
<a name="l01153"></a>01153         $(<span class="stringliteral">&#39;overlay-menu&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01154"></a>01154         <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>) {
<a name="l01155"></a>01155           $(<span class="stringliteral">&#39;overlay-cancel-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01156"></a>01156         } <span class="keywordflow">else</span> {
<a name="l01157"></a>01157           $(<span class="stringliteral">&#39;overlay-camera-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01158"></a>01158         }
<a name="l01159"></a>01159         <span class="keywordflow">break</span>;
<a name="l01160"></a>01160       <span class="keywordflow">case</span> <span class="stringliteral">&#39;upgrade&#39;</span>:
<a name="l01161"></a>01161         title = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;upgrade-title&#39;</span>);
<a name="l01162"></a>01162         text = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get(<span class="stringliteral">&#39;upgrade-text&#39;</span>);
<a name="l01163"></a>01163         <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>) {
<a name="l01164"></a>01164           $(<span class="stringliteral">&#39;overlay-cancel-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01165"></a>01165           $(<span class="stringliteral">&#39;overlay-menu&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01166"></a>01166         }
<a name="l01167"></a>01167         <span class="keywordflow">break</span>;
<a name="l01168"></a>01168       <span class="keywordflow">default</span>:
<a name="l01169"></a>01169         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;Reference to undefined overlay&#39;</span>, currentOverlay);
<a name="l01170"></a>01170         <span class="keywordflow">if</span> (<a class="code" href="../../d0/da2/gallery_8js.html#ab78d90ed7204a602090082e9126dd0d2">pendingPick</a>) {
<a name="l01171"></a>01171           $(<span class="stringliteral">&#39;overlay-cancel-button&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01172"></a>01172           $(<span class="stringliteral">&#39;overlay-menu&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01173"></a>01173         }
<a name="l01174"></a>01174         <span class="keywordflow">return</span>;
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176 
<a name="l01177"></a>01177     $(<span class="stringliteral">&#39;overlay-title&#39;</span>).<a class="code" href="../../d1/d04/app__install__manager_8js.html#a231b448a4b70e9035748897db2fa1c2a">textContent</a> = title;
<a name="l01178"></a>01178     $(<span class="stringliteral">&#39;overlay-text&#39;</span>).<a class="code" href="../../d1/d04/app__install__manager_8js.html#a231b448a4b70e9035748897db2fa1c2a">textContent</a> = text;
<a name="l01179"></a>01179     $(<span class="stringliteral">&#39;overlay&#39;</span>).classList.remove(<span class="stringliteral">&#39;hidden&#39;</span>);
<a name="l01180"></a>01180   });
<a name="l01181"></a>01181 }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183 <span class="comment">// XXX</span>
<a name="l01184"></a>01184 <span class="comment">// Until https://bugzilla.mozilla.org/show_bug.cgi?id=795399 is fixed,</span>
<a name="l01185"></a>01185 <span class="comment">// we have to add a dummy click event handler on the overlay in order to</span>
<a name="l01186"></a>01186 <span class="comment">// make it opaque to touch events. Without this, it does not prevent</span>
<a name="l01187"></a>01187 <span class="comment">// the user from interacting with the UI.</span>
<a name="l01188"></a>01188 $(<span class="stringliteral">&#39;overlay&#39;</span>).<a class="code" href="../../d8/d0d/transfer_8js.html#abd169909fbdd66534e2d19bf20938d8b">addEventListener</a>(<span class="stringliteral">&#39;click&#39;</span>, <span class="keyword">function</span> dummyHandler() {});
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d0/da2/gallery_8js.html">gallery.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:52:02に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
