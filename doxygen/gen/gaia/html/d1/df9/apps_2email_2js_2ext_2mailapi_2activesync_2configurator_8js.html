<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: configurator.js</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">関数</a> &#124;
<a href="#var-members">変数</a>  </div>
  <div class="headertitle">
<div class="title">configurator.js</div>  </div>
</div><!--header-->
<div class="contents">

<p><a href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js_source.html">ソースコードを見る。</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
関数</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a63522b5590f25d59b4f6a3c87f45e361">define</a> ('mailapi/activesync/folder',[ 'rdcommon/<a class="el" href="../../d9/d43/membuster_8js.html#aad81d14d4c8eea114056d7dc1f18f9b7">log</a>', '../<a class="el" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>', '../syncbase', '../<a class="el" href="../../d1/d67/system_2test_2marionette_2notification__test_8js.html#a8f5b2e09d5197e9d28f6032dff542d44">util</a>', 'activesync/codepages/AirSync', 'activesync/codepages/AirSyncBase', 'activesync/codepages/ItemEstimate', 'activesync/codepages/<a class="el" href="../../df/df0/email_8js.html#ae7131e89e79ee32b55977dc43687620e">Email</a>', 'activesync/codepages/ItemOperations', '<a class="el" href="../../df/db4/_h_i_s_t_o_r_y_8md.html#a2bfec5e283e84efb4ef0459e17cbd8c2">module</a>', '<a class="el" href="../../d6/d71/tests_2performance_2startup__test_8js.html#a84ca4076b522d641b7a0c061671f6924">require</a>', '<a class="el" href="../../d4/dfa/tty_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>'], <a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>($<a class="el" href="../../d9/d43/membuster_8js.html#aad81d14d4c8eea114056d7dc1f18f9b7">log</a>, $<a class="el" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>, $<a class="el" href="../../db/d6d/mkdirp_8js.html#a303bde7c6fd15c62884d1439cdf55b10">sync</a>, $<a class="el" href="../../d1/d67/system_2test_2marionette_2notification__test_8js.html#a8f5b2e09d5197e9d28f6032dff542d44">util</a>, $AirSync, $AirSyncBase, $ItemEstimate, $<a class="el" href="../../df/df0/email_8js.html#ae7131e89e79ee32b55977dc43687620e">Email</a>, $ItemOperations, $<a class="el" href="../../df/db4/_h_i_s_t_o_r_y_8md.html#a2bfec5e283e84efb4ef0459e17cbd8c2">module</a>, <a class="el" href="../../d6/d71/tests_2performance_2startup__test_8js.html#a84ca4076b522d641b7a0c061671f6924">require</a>, <a class="el" href="../../d4/dfa/tty_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>){ '<a class="el" href="../../d7/d1b/test-agent-server_8js.html#aab71dcc804ca4aa3ed2bf7ba887635db">use</a> <a class="el" href="../../de/dc5/jsfriendapi_8h.html#a8cddd7ed2617ebace48da2e8e44f267c">strict</a>';var DESIRED_TEXT_SNIPPET_BYTES=512;var DESIRED_MESSAGE_COUNT=50;var FILTER_TYPE, SYNC_RANGE_TO_FILTER_TYPE, FILTER_TYPE_TO_STRING;<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> initFilterTypes(){FILTER_TYPE=$AirSync.Enums.FilterType;SYNC_RANGE_TO_FILTER_TYPE={ 'auto':<a class="el" href="../../d3/d52/blanket_8js.html#a24d794dfc756320ffadb905d526299bc">null</a>, '1d':FILTER_TYPE.OneDayBack, '3d':FILTER_TYPE.ThreeDaysBack, '1w':FILTER_TYPE.OneWeekBack, '2w':FILTER_TYPE.TwoWeeksBack, '1m':FILTER_TYPE.OneMonthBack, 'all':FILTER_TYPE.NoFilter,};FILTER_TYPE_TO_STRING={0: 'all messages', 1: 'one day', 2: 'three days', 3: 'one week', 4: 'two weeks', 5: 'one month',};}var $wbxml, $mimelib, $mailchew;function lazyConnection(cbIndex, fn, failString){return function lazyRun(){var args=Array.slice(arguments), errback=args[cbIndex], self=this;require(['wbxml', 'mimelib', '../mailchew'], function(wbxml, mimelib, mailchew){if(!$wbxml){$wbxml=wbxml;$mimelib=mimelib;$mailchew=mailchew;initFilterTypes();}self._account.withConnection(errback, function(){fn.apply(self, args);}, failString);});};}function ActiveSyncFolderConn(account, storage, _parentLog){this._account=account;this._storage=storage;this._LOG=LOGFAB.ActiveSyncFolderConn(this, _parentLog, storage.folderId);this.folderMeta=storage.folderMeta;if(!this.syncKey) this.syncKey= '0';}ActiveSyncFolderConn.prototype={get syncKey(){return this.folderMeta.syncKey;}, set syncKey(value){return this.folderMeta.syncKey=value;}, get serverId(){return this.folderMeta.serverId;}, get filterType(){var syncRange=this._account.accountDef.syncRange;if(SYNC_RANGE_TO_FILTER_TYPE.hasOwnProperty(syncRange)){var accountFilterType=SYNC_RANGE_TO_FILTER_TYPE[syncRange];if(accountFilterType) return accountFilterType;else return this.folderMeta.filterType;}else{console.warn('Got an invalid syncRange('+syncRange+ ') using three days back instead');return $AirSync.Enums.FilterType.ThreeDaysBack;}}, _getSyncKey:lazyConnection(1, function asfc__getSyncKey(filterType, callback){var folderConn=this;var account=this._account;var as=$AirSync.Tags;var w=new $wbxml.Writer('1.3', 1, 'UTF-8');w.stag(as.Sync).stag(as.Collections).stag(as.Collection) if(account.conn.currentVersion.lt('12.1')) w.tag(as.Class, 'Email');w.tag(as.SyncKey, '0').tag(as.CollectionId, this.serverId).stag(as.Options).tag(as.FilterType, filterType).etag().etag().etag().etag();account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error(aError);account._reportErrorIfNecessary(aError);callback('unknown');return;}folderConn.syncKey= '0';var e=new $wbxml.EventParser();e.addEventListener([as.Sync, as.Collections, as.Collection, as.SyncKey], function(node){folderConn.syncKey=node.children[0].textContent;});e.onerror=function(){};e.run(aResponse);if(folderConn.syncKey=== '0'){console.error('Unable to get sync key for folder');callback('unknown');}else{callback();}});}), _getItemEstimate:lazyConnection(1, function asfc__getItemEstimate(filterType, callback){var ie=$ItemEstimate.Tags;var as=$AirSync.Tags;var account=this._account;var w=new $wbxml.Writer('1.3', 1, 'UTF-8');w.stag(ie.GetItemEstimate).stag(ie.Collections).stag(ie.Collection);if(this._account.conn.currentVersion.gte('14.0')){w.tag(as.SyncKey, this.syncKey).tag(ie.CollectionId, this.serverId).stag(as.Options).tag(as.FilterType, filterType).etag();}else if(this._account.conn.currentVersion.gte('12.0')){w.tag(ie.CollectionId, this.serverId).tag(as.FilterType, filterType).tag(as.SyncKey, this.syncKey);}else{w.tag(ie.Class, 'Email').tag(as.SyncKey, this.syncKey).tag(ie.CollectionId, this.serverId).tag(as.FilterType, filterType);}w.etag(ie.Collection).etag(ie.Collections).etag(ie.GetItemEstimate);account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error(aError);account._reportErrorIfNecessary(aError);callback('unknown');return;}var e=new $wbxml.EventParser();var base=[ie.GetItemEstimate, ie.Response];var status, estimate;e.addEventListener(base.concat(ie.Status), function(node){status=node.children[0].textContent;});e.addEventListener(base.concat(ie.Collection, ie.Estimate), function(node){estimate=parseInt(node.children[0].textContent, 10);});try{e.run(aResponse);}catch(ex){console.error('Error parsing GetItemEstimate response', ex, '\n', ex.stack);callback('unknown');return;}if(status!==$ItemEstimate.Enums.Status.Success){console.error('Error getting item estimate:', status);callback('unknown');}else{callback(null, estimate);}});}), _inferFilterType:lazyConnection(0, function asfc__inferFilterType(callback){var folderConn=this;var Type=$AirSync.Enums.FilterType;var getEstimate=function(filterType, onSuccess){folderConn._getSyncKey(filterType, function(error){if(error){callback('unknown');return;}folderConn._getItemEstimate(filterType, function(error, estimate){if(error){callback(null, Type.ThreeDaysBack);return;}onSuccess(estimate);});});};getEstimate(Type.TwoWeeksBack, function(estimate){var messagesPerDay=estimate/14;var filterType;if(estimate&lt; 0) filterType=Type.ThreeDaysBack;else if(messagesPerDay &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.OneDayBack;else if(messagesPerDay *3 &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.ThreeDaysBack;else if(messagesPerDay *7 &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.OneWeekBack;else if(messagesPerDay *14 &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.TwoWeeksBack;else if(messagesPerDay *30 &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.OneMonthBack;else{getEstimate(Type.NoFilter, function(estimate){var filterType;if(estimate &gt; DESIRED_MESSAGE_COUNT){filterType=Type.OneMonthBack;folderConn.syncKey= '0';}else{filterType=Type.NoFilter;}folderConn._LOG.inferFilterType(filterType);callback(null, filterType);});return;}if(filterType!==Type.TwoWeeksBack){folderConn.syncKey= '0';}folderConn._LOG.inferFilterType(filterType);callback(null, filterType);});}), _enumerateFolderChanges:lazyConnection(0, function asfc__enumerateFolderChanges(callback, progress){var folderConn=this, storage=this._storage;if(!this.filterType){this._inferFilterType(function(error, filterType){if(error){callback('unknown');return;}console.log('We want a filter of', FILTER_TYPE_TO_STRING[filterType]);folderConn.folderMeta.filterType=filterType;folderConn._enumerateFolderChanges(callback, progress);});return;}if(this.syncKey=== '0'){this._getSyncKey(this.filterType, function(error){if(error){callback('aborted');return;}folderConn._enumerateFolderChanges(callback, progress);});return;}var as=$AirSync.Tags;var asEnum=$AirSync.Enums;var asb=$AirSyncBase.Tags;var asbEnum=$AirSyncBase.Enums;var w;if(this._account._syncsInProgress++===0 &amp;&amp;this._account._lastSyncKey===this.syncKey &amp;&amp;this._account._lastSyncFilterType===this.filterType &amp;&amp;this._account._lastSyncResponseWasEmpty){w=as.Sync;}else{w=new $wbxml.Writer('1.3', 1, 'UTF-8');w.stag(as.Sync).stag(as.Collections).stag(as.Collection);if(this._account.conn.currentVersion.lt('12.1')) w.tag(as.Class, 'Email');w.tag(as.SyncKey, this.syncKey).tag(as.CollectionId, this.serverId).tag(as.GetChanges).stag(as.Options).tag(as.FilterType, this.filterType) if(this._account.conn.currentVersion.lte('12.0')){w.tag(as.MIMESupport, asEnum.MIMESupport.Never).tag(as.Truncation, asEnum.MIMETruncation.TruncateAll);}w.etag().etag().etag().etag();}this._account.conn.postCommand(w, function(aError, aResponse){var added=[];var changed=[];var deleted=[];var status;var moreAvailable=false;folderConn._account._syncsInProgress--;if(aError){console.error('Error syncing folder:', aError);folderConn._account._reportErrorIfNecessary(aError);callback('aborted');return;}folderConn._account._lastSyncKey=folderConn.syncKey;folderConn._account._lastSyncFilterType=folderConn.filterType;if(!aResponse){console.log('Sync completed with empty response');folderConn._account._lastSyncResponseWasEmpty=true;callback(null, added, changed, deleted);return;}folderConn._account._lastSyncResponseWasEmpty=false;var e=new $wbxml.EventParser();var base=[as.Sync, as.Collections, as.Collection];e.addEventListener(base.concat(as.SyncKey), function(node){folderConn.syncKey=node.children[0].textContent;});e.addEventListener(base.concat(as.Status), function(node){status=node.children[0].textContent;});e.addEventListener(base.concat(as.MoreAvailable), function(node){moreAvailable=true;});e.addEventListener(base.concat(as.Commands,[[as.Add, as.Change]]), function(node){var id, guid, msg;for(var iter in Iterator(node.children)){var child=iter[1];switch(child.tag){case as.ServerId:guid=child.children[0].textContent;break;case as.ApplicationData:try{msg=folderConn._parseMessage(child, node.tag===as.Add);}catch(ex){console.error('Failed to parse a message:', ex, '\n', ex.stack);return;}break;}}if(node.tag===as.Add){msg.header.id=id=storage._issueNewHeaderId();msg.header.suid=folderConn._storage.folderId+ '/'+id;msg.header.guid= '';}msg.header.srvid=guid;var collection=node.tag===as.Add?added:changed;collection.push(msg);});e.addEventListener(base.concat(as.Commands,[[as.Delete, as.SoftDelete]]), function(node){var guid;for(var iter in Iterator(node.children)){var child=iter[1];switch(child.tag){case as.ServerId:guid=child.children[0].textContent;break;}}deleted.push(guid);});try{e.run(aResponse);}catch(ex){console.error('Error parsing Sync response:', ex, '\n', ex.stack);callback('unknown');return;}if(status===asEnum.Status.Success){console.log('Sync completed:added '+added.length+ ', changed '+changed.length+ ', deleted '+deleted.length);callback(null, added, changed, deleted, moreAvailable);if(moreAvailable) folderConn._enumerateFolderChanges(callback, progress);}else if(status===asEnum.Status.InvalidSyncKey){console.warn('ActiveSync had a bad sync key');callback('badkey');}else{console.error('Something went wrong during ActiveSync syncing and we '+ 'got a status of '+status);callback('unknown');}}, null, null, function progressData(bytesSoFar, totalBytes){if(!totalBytes) totalBytes=Math.max(1000000, bytesSoFar);progress(0.1+0.7 *bytesSoFar/totalBytes);});}, 'aborted'), _parseMessage:function asfc__parseMessage(node, isAdded){var em=$Email.Tags;var asb=$AirSyncBase.Tags;var asbEnum=$AirSyncBase.Enums;var header, body, flagHeader;if(isAdded){header={id:null, srvid:null, suid:null, guid:null, author:null, to:null, cc:null, bcc:null, replyTo:null, date:null, flags:[], hasAttachments:false, subject:null, snippet:null};body={date:null, size:0, attachments:[], relatedParts:[], references:null, bodyReps:null};flagHeader=function(flag, state){if(state) header.flags.push(flag);}}else{header={flags:[], mergeInto:function(o){for(var iter in Iterator(this.flags)){var flagstate=iter[1];if(flagstate[1]){o.flags.push(flagstate[0]);}else{var index=o.flags.indexOf(flagstate[0]);if(index!==-1) o.flags.splice(index, 1);}}var skip=['mergeInto', 'suid', 'srvid', 'guid', 'id', 'flags'];for(var iter in Iterator(this)){var key=iter[0], value=iter[1];if(skip.indexOf(key)!==-1) continue;o[key]=value;}},};body={mergeInto:function(o){for(var iter in Iterator(this)){var key=iter[0], value=iter[1];if(key=== 'mergeInto') continue;o[key]=value;}},};flagHeader=function(flag, state){header.flags.push([flag, state]);}}var bodyType, bodySize;for(var iter in Iterator(node.children)){var child=iter[1];var childText=child.children.length?child.children[0].textContent:null;switch(child.tag){case em.Subject:header.subject=childText;break;case em.From:header.author=$mimelib.parseAddresses(childText)[0]||null;break;case em.To:header.to=$mimelib.parseAddresses(childText);break;case em.Cc:header.cc=$mimelib.parseAddresses(childText);break;case em.ReplyTo:header.replyTo=$mimelib.parseAddresses(childText);break;case em.DateReceived:body.date=header.date=new Date(childText).valueOf();break;case em.Read:flagHeader('\\Seen', childText=== '1');break;case em.Flag:for(var iter2 in Iterator(child.children)){var grandchild=iter2[1];if(grandchild.tag===em.Status) flagHeader('\\Flagged', grandchild.children[0].textContent!== '0');}break;case asb.Body:for(var iter2 in Iterator(child.children)){var grandchild=iter2[1];switch(grandchild.tag){case asb.Type:var type=grandchild.children[0].textContent;if(type===asbEnum.Type.HTML) bodyType= 'html';else{if(type!==asbEnum.Type.PlainText) console.warn('A message had a strange body type:', type) bodyType= 'plain';}break;case asb.EstimatedDataSize:bodySize=grandchild.children[0].textContent;break;}}break;case em.BodySize:bodyType= 'plain';bodySize=childText;break;case asb.Attachments:case em.Attachments:for(var iter2 in Iterator(child.children)){var attachmentNode=iter2[1];if(attachmentNode.tag!==asb.Attachment &amp;&amp;attachmentNode.tag!==em.Attachment) continue;var attachment={name:null, contentId:null, type:null, part:null, encoding:null, sizeEstimate:null, file:null,};var isInline=false;for(var iter3 in Iterator(attachmentNode.children)){var attachData=iter3[1];var dot, ext;var attachDataText=attachData.children.length?attachData.children[0].textContent:null;switch(attachData.tag){case asb.DisplayName:case em.DisplayName:attachment.name=attachDataText;dot=attachment.name.lastIndexOf('.');ext=dot &gt; 0?attachment.name.substring(dot+1).toLowerCase(): '';attachment.type=$mimelib.contentTypes[ext]|| 'application/octet-stream';break;case asb.FileReference:case em.AttName:attachment.part=attachDataText;break;case asb.EstimatedDataSize:case em.AttSize:attachment.sizeEstimate=parseInt(attachDataText, 10);break;case asb.ContentId:attachment.contentId=attachDataText;break;case asb.IsInline:isInline=(attachDataText=== '1');break;case asb.FileReference:case em.Att0Id:attachment.part=attachData.children[0].textContent;break;}}if(isInline) body.relatedParts.push(attachment);else body.attachments.push(attachment);}header.hasAttachments=body.attachments.length &gt; 0;break;}}body.bodyReps=[{type:bodyType, sizeEstimate:bodySize, amountDownloaded:0, isDownloaded:false}];return{header:header, body:body};}, downloadBodies:function(headers, options, callback){if(this._account.conn.currentVersion.lt('12.0')) return this._syncBodies(headers, callback);var anyErr, pending=1, downloadsNeeded=0, folderConn=this;function next(err){if(err &amp;&amp;!anyErr) anyErr=err;if(!--pending){folderConn._storage.runAfterDeferredCalls(function(){callback(anyErr, downloadsNeeded-pending);});}}for(var i=0;i&lt; headers.length;i++){if(!headers[i]||headers[i].snippet!==null){continue;}pending++;downloadsNeeded++;this.downloadBodyReps(headers[i], options, next);}window.setZeroTimeout(next);}, downloadBodyReps:lazyConnection(1, function(header, options, callback){var folderConn=this;var account=this._account;if(account.conn.currentVersion.lt('12.0')) return this._syncBodies([header], callback);if(typeof(options)=== 'function'){callback=options;options=null;}options=options||{};var io=$ItemOperations.Tags;var ioEnum=$ItemOperations.Enums;var as=$AirSync.Tags;var asEnum=$AirSync.Enums;var asb=$AirSyncBase.Tags;var Type=$AirSyncBase.Enums.Type;var gotBody=function gotBody(bodyInfo){var bodyRep=bodyInfo.bodyReps[0];var bodyType=bodyRep.type=== 'html'?Type.HTML:Type.PlainText;var truncationSize;if(options.maximumBytesToFetch&lt; bodyRep.sizeEstimate){bodyType=Type.PlainText;truncationSize=DESIRED_TEXT_SNIPPET_BYTES;}var w=new $wbxml.Writer('1.3', 1, 'UTF-8');w.stag(io.ItemOperations).stag(io.Fetch).tag(io.Store, 'Mailbox').tag(as.CollectionId, folderConn.serverId).tag(as.ServerId, header.srvid).stag(io.Options).stag(io.Schema).tag(asb.Body).etag().stag(asb.BodyPreference).tag(asb.Type, bodyType);if(truncationSize) w.tag(asb.TruncationSize, truncationSize);w.etag().etag().etag().etag();account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error(aError);account._reportErrorIfNecessary(aError);callback('unknown');return;}var status, bodyContent, e=new $wbxml.EventParser();e.addEventListener([io.ItemOperations, io.Status], function(node){status=node.children[0].textContent;});e.addEventListener([io.ItemOperations, io.Response, io.Fetch, io.Properties, asb.Body, asb.Data], function(node){bodyContent=node.children[0].textContent;});e.run(aResponse);if(status!==ioEnum.Status.Success) return callback('unknown');folderConn._updateBody(header, bodyInfo, bodyContent,!!truncationSize, callback);});};this._storage.getMessageBody(header.suid, header.date, gotBody);}), _syncBodies:function(headers, callback){var as=$AirSync.Tags;var asEnum=$AirSync.Enums;var em=$Email.Tags;var folderConn=this;var account=this._account;var w=new $wbxml.Writer('1.3', 1, 'UTF-8');w.stag(as.Sync).stag(as.Collections).stag(as.Collection).tag(as.Class, 'Email').tag(as.SyncKey, this.syncKey).tag(as.CollectionId, this.serverId).stag(as.Options).tag(as.MIMESupport, asEnum.MIMESupport.Never).etag().stag(as.Commands);for(var i=0;i&lt; headers.length;i++){w.stag(as.Fetch).tag(as.ServerId, headers[i].srvid).etag();}w.etag().etag().etag().etag();account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error(aError);account._reportErrorIfNecessary(aError);callback('unknown');return;}var status, anyErr, i=0, pending=1;function next(err){if(err &amp;&amp;!anyErr) anyErr=err;if(!--pending){folderConn._storage.runAfterDeferredCalls(function(){callback(anyErr);});}}var e=new $wbxml.EventParser();var base=[as.Sync, as.Collections, as.Collection];e.addEventListener(base.concat(as.SyncKey), function(node){folderConn.syncKey=node.children[0].textContent;});e.addEventListener(base.concat(as.Status), function(node){status=node.children[0].textContent;});e.addEventListener(base.concat(as.Responses, as.Fetch, as.ApplicationData, em.Body), function(node){var header=headers[i++];var bodyContent=node.children[0].textContent;pending++;folderConn._storage.getMessageBody(header.suid, header.date, function(body){folderConn._updateBody(header, body, bodyContent, false, next);});});e.run(aResponse);if(status!==asEnum.Status.Success) return next('unknown');next(null);});}, _updateBody:function(header, bodyInfo, bodyContent, snippetOnly, callback){var bodyRep=bodyInfo.bodyReps[0];if(bodyContent.length &amp;&amp;bodyContent[bodyContent.length-1]=== '\n') bodyContent=bodyContent.slice(0,-1);bodyContent=bodyContent.replace(/\r/g, '');var type=snippetOnly? 'plain':bodyRep.type;var data=$mailchew.processMessageContent(bodyContent, type,!snippetOnly, true, this._LOG);header.snippet=data.snippet;bodyRep.isDownloaded=!snippetOnly;bodyRep.amountDownloaded=bodyContent.length;if(!snippetOnly) bodyRep.content=data.content;var event={changeType: 'bodyReps', indexes:[0]};this._storage.updateMessageHeader(header.date, header.id, false, header);this._storage.updateMessageBody(header, bodyInfo, event);this._storage.runAfterDeferredCalls(callback.bind(null, null, bodyInfo));}, sync:lazyConnection(1, function asfc_sync(accuracyStamp, doneCallback, progressCallback){var folderConn=this, addedMessages=0, changedMessages=0, deletedMessages=0;this._LOG.sync_begin(null, null, null);this._enumerateFolderChanges(function(error, added, changed, deleted, moreAvailable){var storage=folderConn._storage;if(error=== 'badkey'){folderConn._account._recreateFolder(storage.folderId, function(s){folderConn._storage=null;folderConn._LOG.sync_end(null, null, null);});return;}else if(error){folderConn._LOG.sync_end(null, null, null);doneCallback(error);return;}for(var iter in Iterator(added)){var message=iter[1];if(storage.hasMessageWithServerId(message.header.srvid)) continue;storage.addMessageHeader(message.header);storage.addMessageBody(message.header, message.body);addedMessages++;}for(var iter in Iterator(changed)){var message=iter[1];if(!storage.hasMessageWithServerId(message.header.srvid)) continue;storage.updateMessageHeaderByServerId(message.header.srvid, true, function(oldHeader){message.header.mergeInto(oldHeader);return true;});changedMessages++;}for(var iter in Iterator(deleted)){var messageGuid=iter[1];if(!storage.hasMessageWithServerId(messageGuid)) continue;storage.deleteMessageByServerId(messageGuid);deletedMessages++;}if(!moreAvailable){var messagesSeen=addedMessages+changedMessages+deletedMessages;storage.runAfterDeferredCalls(function(){folderConn._LOG.sync_end(addedMessages, changedMessages, deletedMessages);storage.markSyncRange($sync.OLDEST_SYNC_DATE, accuracyStamp, 'XXX', accuracyStamp);doneCallback(null, null, messagesSeen);});}}, progressCallback);}), performMutation:lazyConnection(1, function(invokeWithWriter, callWhenDone){var folderConn=this;var as=$AirSync.Tags;var account=this._account;var w=new $wbxml.Writer('1.3', 1, 'UTF-8');w.stag(as.Sync).stag(as.Collections).stag(as.Collection);if(account.conn.currentVersion.lt('12.1')) w.tag(as.Class, 'Email');w.tag(as.SyncKey, this.syncKey).tag(as.CollectionId, this.serverId).tag(as.DeletesAsMoves, this.folderMeta.type=== 'trash'? '0': '1').tag(as.GetChanges, '0').stag(as.Commands);try{invokeWithWriter(w);}catch(ex){console.error('Exception in performMutation callee:', ex, '\n', ex.stack);callWhenDone('unknown');return;}w.etag(as.Commands).etag(as.Collection).etag(as.Collections).etag(as.Sync);account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error('postCommand error:', aError);account._reportErrorIfNecessary(aError);callWhenDone('unknown');return;}var e=new $wbxml.EventParser();var syncKey, status;var base=[as.Sync, as.Collections, as.Collection];e.addEventListener(base.concat(as.SyncKey), function(node){syncKey=node.children[0].textContent;});e.addEventListener(base.concat(as.Status), function(node){status=node.children[0].textContent;});try{e.run(aResponse);}catch(ex){console.error('Error parsing Sync response:', ex, '\n', ex.stack);callWhenDone('unknown');return;}if(status===$AirSync.Enums.Status.Success){folderConn.syncKey=syncKey;if(callWhenDone) callWhenDone(null);}else{console.error('Something went wrong during ActiveSync syncing and we '+ 'got a status of '+status);callWhenDone('status:'+status);}});}), downloadMessageAttachments:lazyConnection(2, function(uid, partInfos, callback, progress){var folderConn=this;var io=$ItemOperations.Tags;var ioStatus=$ItemOperations.Enums.Status;var asb=$AirSyncBase.Tags;var w=new $wbxml.Writer('1.3', 1, 'UTF-8');w.stag(io.ItemOperations);for(var iter in Iterator(partInfos)){var part=iter[1];w.stag(io.Fetch).tag(io.Store, 'Mailbox').tag(asb.FileReference, part.part).etag();}w.etag();this._account.conn.postCommand(w, function(aError, aResult){if(aError){console.error('postCommand error:', aError);folderConn._account._reportErrorIfNecessary(aError);callback('unknown');return;}var globalStatus;var attachments={};var e=new $wbxml.EventParser();e.addEventListener([io.ItemOperations, io.Status], function(node){globalStatus=node.children[0].textContent;});e.addEventListener([io.ItemOperations, io.Response, io.Fetch], function(node){var part=null, attachment={};for(var iter in Iterator(node.children)){var child=iter[1];switch(child.tag){case io.Status:attachment.status=child.children[0].textContent;break;case asb.FileReference:part=child.children[0].textContent;break;case io.Properties:var contentType=null, data=null;for(var iter2 in Iterator(child.children)){var grandchild=iter2[1];var textContent=grandchild.children[0].textContent;switch(grandchild.tag){case asb.ContentType:contentType=textContent;break;case io.Data:data=new Buffer(textContent, 'base64');break;}}if(contentType &amp;&amp;data) attachment.data=new Blob([data],{type:contentType});break;}if(part) attachments[part]=attachment;}});e.run(aResult);var error=globalStatus!==ioStatus.Success? 'unknown':null;var bodies=[];for(var iter in Iterator(partInfos)){var part=iter[1];if(attachments.hasOwnProperty(part.part)&amp;&amp;attachments[part.part].status===ioStatus.Success){bodies.push(attachments[part.part].data);}else{error= 'unknown';bodies.push(null);}}callback(error, bodies);});}),};function ActiveSyncFolderSyncer(account, folderStorage, _parentLog){this._account=account;this.folderStorage=folderStorage;this._LOG=LOGFAB.ActiveSyncFolderSyncer(this, _parentLog, folderStorage.folderId);this.folderConn=new ActiveSyncFolderConn(account, folderStorage, this._LOG);}exports.ActiveSyncFolderSyncer=ActiveSyncFolderSyncer;ActiveSyncFolderSyncer.prototype={get syncable(){return this.folderConn.serverId!==null;}, get canGrowSync(){return false;}, initialSync:function(slice, initialDays, syncCallback, doneCallback, progressCallback){syncCallback('sync', false, true);this.folderConn.sync($date.NOW(), this.onSyncCompleted.bind(this, doneCallback, true), progressCallback);}, refreshSync:function(slice, dir, startTS, endTS, origStartTS, doneCallback, progressCallback){this.folderConn.sync($date.NOW(), this.onSyncCompleted.bind(this, doneCallback, false), progressCallback);}, growSync:function(slice, growthDirection, anchorTS, syncStepDays, doneCallback, progressCallback){return false;}, onSyncCompleted:function ifs_onSyncCompleted(doneCallback, initialSync, err, bisectInfo, messagesSeen){var storage=this.folderStorage;console.log(&quot;Sync Completed!&quot;, messagesSeen,&quot;messages synced&quot;);if(!err) storage.markSyncedToDawnOfTime();this._account.__checkpointSyncCompleted();if(err){doneCallback(err);return;}if(initialSync){storage._curSyncSlice.ignoreHeaders=false;storage._curSyncSlice.waitingOnData= 'db';storage.getMessagesInImapDateRange(0, null, $sync.INITIAL_FILL_SIZE, $sync.INITIAL_FILL_SIZE, storage.onFetchDBHeaders.bind(storage, storage._curSyncSlice, false, doneCallback, null));}else{doneCallback(err);}}, allConsumersDead:function(){}, shutdown:function(){this.folderConn.shutdown();this._LOG.__die();},};var LOGFAB=exports.LOGFAB=$log.register($module,{ActiveSyncFolderConn:{type:$log.CONNECTION, subtype:$log.CLIENT, events:{inferFilterType:{filterType:false},}, asyncJobs:{sync:{newMessages:true, changedMessages:true, deletedMessages:true,},}, errors:{htmlParseError:{ex:$log.EXCEPTION}, htmlSnippetError:{ex:$log.EXCEPTION}, textChewError:{ex:$log.EXCEPTION}, textSnippetError:{ex:$log.EXCEPTION},},}, ActiveSyncFolderSyncer:{type:$log.DATABASE, events:{}},});})</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
変数</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html#a11a10a6834f3c54a5380f4ff04d002a9">root</a></td></tr>
</table>
<hr/><h2>関数</h2>
<a class="anchor" id="a63522b5590f25d59b4f6a3c87f45e361"></a><!-- doxytag: member="apps/email/js/ext/mailapi/activesync/configurator.js::define" ref="a63522b5590f25d59b4f6a3c87f45e361" args="('mailapi/activesync/folder',[ 'rdcommon/log', '../date', '../syncbase', '../util', 'activesync/codepages/AirSync', 'activesync/codepages/AirSyncBase', 'activesync/codepages/ItemEstimate', 'activesync/codepages/Email', 'activesync/codepages/ItemOperations', 'module', 'require', 'exports'], function($log, $date, $sync, $util, $AirSync, $AirSyncBase, $ItemEstimate, $Email, $ItemOperations, $module, require, exports){ 'use strict';var DESIRED_TEXT_SNIPPET_BYTES=512;var DESIRED_MESSAGE_COUNT=50;var FILTER_TYPE, SYNC_RANGE_TO_FILTER_TYPE, FILTER_TYPE_TO_STRING;function initFilterTypes(){FILTER_TYPE=$AirSync.Enums.FilterType;SYNC_RANGE_TO_FILTER_TYPE={ 'auto':null, '1d':FILTER_TYPE.OneDayBack, '3d':FILTER_TYPE.ThreeDaysBack, '1w':FILTER_TYPE.OneWeekBack, '2w':FILTER_TYPE.TwoWeeksBack, '1m':FILTER_TYPE.OneMonthBack, 'all':FILTER_TYPE.NoFilter,};FILTER_TYPE_TO_STRING={0: 'all messages', 1: 'one day', 2: 'three days', 3: 'one week', 4: 'two weeks', 5: 'one month',};}var $wbxml, $mimelib, $mailchew;function lazyConnection(cbIndex, fn, failString){return function lazyRun(){var args=Array.slice(arguments), errback=args[cbIndex], self=this;require(['wbxml', 'mimelib', '../mailchew'], function(wbxml, mimelib, mailchew){if(!$wbxml){$wbxml=wbxml;$mimelib=mimelib;$mailchew=mailchew;initFilterTypes();}self._account.withConnection(errback, function(){fn.apply(self, args);}, failString);});};}function ActiveSyncFolderConn(account, storage, _parentLog){this._account=account;this._storage=storage;this._LOG=LOGFAB.ActiveSyncFolderConn(this, _parentLog, storage.folderId);this.folderMeta=storage.folderMeta;if(!this.syncKey) this.syncKey= '0';}ActiveSyncFolderConn.prototype={get syncKey(){return this.folderMeta.syncKey;}, set syncKey(value){return this.folderMeta.syncKey=value;}, get serverId(){return this.folderMeta.serverId;}, get filterType(){var syncRange=this._account.accountDef.syncRange;if(SYNC_RANGE_TO_FILTER_TYPE.hasOwnProperty(syncRange)){var accountFilterType=SYNC_RANGE_TO_FILTER_TYPE[syncRange];if(accountFilterType) return accountFilterType;else return this.folderMeta.filterType;}else{console.warn('Got an invalid syncRange('+syncRange+ ') using three days back instead');return $AirSync.Enums.FilterType.ThreeDaysBack;}}, _getSyncKey:lazyConnection(1, function asfc__getSyncKey(filterType, callback){var folderConn=this;var account=this._account;var as=$AirSync.Tags;var w=new $wbxml.Writer('1.3', 1, 'UTF&#45;8');w.stag(as.Sync).stag(as.Collections).stag(as.Collection) if(account.conn.currentVersion.lt('12.1')) w.tag(as.Class, 'Email');w.tag(as.SyncKey, '0').tag(as.CollectionId, this.serverId).stag(as.Options).tag(as.FilterType, filterType).etag().etag().etag().etag();account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error(aError);account._reportErrorIfNecessary(aError);callback('unknown');return;}folderConn.syncKey= '0';var e=new $wbxml.EventParser();e.addEventListener([as.Sync, as.Collections, as.Collection, as.SyncKey], function(node){folderConn.syncKey=node.children[0].textContent;});e.onerror=function(){};e.run(aResponse);if(folderConn.syncKey=== '0'){console.error('Unable to get sync key for folder');callback('unknown');}else{callback();}});}), _getItemEstimate:lazyConnection(1, function asfc__getItemEstimate(filterType, callback){var ie=$ItemEstimate.Tags;var as=$AirSync.Tags;var account=this._account;var w=new $wbxml.Writer('1.3', 1, 'UTF&#45;8');w.stag(ie.GetItemEstimate).stag(ie.Collections).stag(ie.Collection);if(this._account.conn.currentVersion.gte('14.0')){w.tag(as.SyncKey, this.syncKey).tag(ie.CollectionId, this.serverId).stag(as.Options).tag(as.FilterType, filterType).etag();}else if(this._account.conn.currentVersion.gte('12.0')){w.tag(ie.CollectionId, this.serverId).tag(as.FilterType, filterType).tag(as.SyncKey, this.syncKey);}else{w.tag(ie.Class, 'Email').tag(as.SyncKey, this.syncKey).tag(ie.CollectionId, this.serverId).tag(as.FilterType, filterType);}w.etag(ie.Collection).etag(ie.Collections).etag(ie.GetItemEstimate);account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error(aError);account._reportErrorIfNecessary(aError);callback('unknown');return;}var e=new $wbxml.EventParser();var base=[ie.GetItemEstimate, ie.Response];var status, estimate;e.addEventListener(base.concat(ie.Status), function(node){status=node.children[0].textContent;});e.addEventListener(base.concat(ie.Collection, ie.Estimate), function(node){estimate=parseInt(node.children[0].textContent, 10);});try{e.run(aResponse);}catch(ex){console.error('Error parsing GetItemEstimate response', ex, '\n', ex.stack);callback('unknown');return;}if(status!==$ItemEstimate.Enums.Status.Success){console.error('Error getting item estimate:', status);callback('unknown');}else{callback(null, estimate);}});}), _inferFilterType:lazyConnection(0, function asfc__inferFilterType(callback){var folderConn=this;var Type=$AirSync.Enums.FilterType;var getEstimate=function(filterType, onSuccess){folderConn._getSyncKey(filterType, function(error){if(error){callback('unknown');return;}folderConn._getItemEstimate(filterType, function(error, estimate){if(error){callback(null, Type.ThreeDaysBack);return;}onSuccess(estimate);});});};getEstimate(Type.TwoWeeksBack, function(estimate){var messagesPerDay=estimate/14;var filterType;if(estimate&lt; 0) filterType=Type.ThreeDaysBack;else if(messagesPerDay &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.OneDayBack;else if(messagesPerDay *3 &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.ThreeDaysBack;else if(messagesPerDay *7 &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.OneWeekBack;else if(messagesPerDay *14 &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.TwoWeeksBack;else if(messagesPerDay *30 &gt;=DESIRED_MESSAGE_COUNT) filterType=Type.OneMonthBack;else{getEstimate(Type.NoFilter, function(estimate){var filterType;if(estimate &gt; DESIRED_MESSAGE_COUNT){filterType=Type.OneMonthBack;folderConn.syncKey= '0';}else{filterType=Type.NoFilter;}folderConn._LOG.inferFilterType(filterType);callback(null, filterType);});return;}if(filterType!==Type.TwoWeeksBack){folderConn.syncKey= '0';}folderConn._LOG.inferFilterType(filterType);callback(null, filterType);});}), _enumerateFolderChanges:lazyConnection(0, function asfc__enumerateFolderChanges(callback, progress){var folderConn=this, storage=this._storage;if(!this.filterType){this._inferFilterType(function(error, filterType){if(error){callback('unknown');return;}console.log('We want a filter of', FILTER_TYPE_TO_STRING[filterType]);folderConn.folderMeta.filterType=filterType;folderConn._enumerateFolderChanges(callback, progress);});return;}if(this.syncKey=== '0'){this._getSyncKey(this.filterType, function(error){if(error){callback('aborted');return;}folderConn._enumerateFolderChanges(callback, progress);});return;}var as=$AirSync.Tags;var asEnum=$AirSync.Enums;var asb=$AirSyncBase.Tags;var asbEnum=$AirSyncBase.Enums;var w;if(this._account._syncsInProgress++===0 &amp;&amp;this._account._lastSyncKey===this.syncKey &amp;&amp;this._account._lastSyncFilterType===this.filterType &amp;&amp;this._account._lastSyncResponseWasEmpty){w=as.Sync;}else{w=new $wbxml.Writer('1.3', 1, 'UTF&#45;8');w.stag(as.Sync).stag(as.Collections).stag(as.Collection);if(this._account.conn.currentVersion.lt('12.1')) w.tag(as.Class, 'Email');w.tag(as.SyncKey, this.syncKey).tag(as.CollectionId, this.serverId).tag(as.GetChanges).stag(as.Options).tag(as.FilterType, this.filterType) if(this._account.conn.currentVersion.lte('12.0')){w.tag(as.MIMESupport, asEnum.MIMESupport.Never).tag(as.Truncation, asEnum.MIMETruncation.TruncateAll);}w.etag().etag().etag().etag();}this._account.conn.postCommand(w, function(aError, aResponse){var added=[];var changed=[];var deleted=[];var status;var moreAvailable=false;folderConn._account._syncsInProgress&#45;&#45;;if(aError){console.error('Error syncing folder:', aError);folderConn._account._reportErrorIfNecessary(aError);callback('aborted');return;}folderConn._account._lastSyncKey=folderConn.syncKey;folderConn._account._lastSyncFilterType=folderConn.filterType;if(!aResponse){console.log('Sync completed with empty response');folderConn._account._lastSyncResponseWasEmpty=true;callback(null, added, changed, deleted);return;}folderConn._account._lastSyncResponseWasEmpty=false;var e=new $wbxml.EventParser();var base=[as.Sync, as.Collections, as.Collection];e.addEventListener(base.concat(as.SyncKey), function(node){folderConn.syncKey=node.children[0].textContent;});e.addEventListener(base.concat(as.Status), function(node){status=node.children[0].textContent;});e.addEventListener(base.concat(as.MoreAvailable), function(node){moreAvailable=true;});e.addEventListener(base.concat(as.Commands,[[as.Add, as.Change]]), function(node){var id, guid, msg;for(var iter in Iterator(node.children)){var child=iter[1];switch(child.tag){case as.ServerId:guid=child.children[0].textContent;break;case as.ApplicationData:try{msg=folderConn._parseMessage(child, node.tag===as.Add);}catch(ex){console.error('Failed to parse a message:', ex, '\n', ex.stack);return;}break;}}if(node.tag===as.Add){msg.header.id=id=storage._issueNewHeaderId();msg.header.suid=folderConn._storage.folderId+ '/'+id;msg.header.guid= '';}msg.header.srvid=guid;var collection=node.tag===as.Add?added:changed;collection.push(msg);});e.addEventListener(base.concat(as.Commands,[[as.Delete, as.SoftDelete]]), function(node){var guid;for(var iter in Iterator(node.children)){var child=iter[1];switch(child.tag){case as.ServerId:guid=child.children[0].textContent;break;}}deleted.push(guid);});try{e.run(aResponse);}catch(ex){console.error('Error parsing Sync response:', ex, '\n', ex.stack);callback('unknown');return;}if(status===asEnum.Status.Success){console.log('Sync completed:added '+added.length+ ', changed '+changed.length+ ', deleted '+deleted.length);callback(null, added, changed, deleted, moreAvailable);if(moreAvailable) folderConn._enumerateFolderChanges(callback, progress);}else if(status===asEnum.Status.InvalidSyncKey){console.warn('ActiveSync had a bad sync key');callback('badkey');}else{console.error('Something went wrong during ActiveSync syncing and we '+ 'got a status of '+status);callback('unknown');}}, null, null, function progressData(bytesSoFar, totalBytes){if(!totalBytes) totalBytes=Math.max(1000000, bytesSoFar);progress(0.1+0.7 *bytesSoFar/totalBytes);});}, 'aborted'), _parseMessage:function asfc__parseMessage(node, isAdded){var em=$Email.Tags;var asb=$AirSyncBase.Tags;var asbEnum=$AirSyncBase.Enums;var header, body, flagHeader;if(isAdded){header={id:null, srvid:null, suid:null, guid:null, author:null, to:null, cc:null, bcc:null, replyTo:null, date:null, flags:[], hasAttachments:false, subject:null, snippet:null};body={date:null, size:0, attachments:[], relatedParts:[], references:null, bodyReps:null};flagHeader=function(flag, state){if(state) header.flags.push(flag);}}else{header={flags:[], mergeInto:function(o){for(var iter in Iterator(this.flags)){var flagstate=iter[1];if(flagstate[1]){o.flags.push(flagstate[0]);}else{var index=o.flags.indexOf(flagstate[0]);if(index!==&#45;1) o.flags.splice(index, 1);}}var skip=['mergeInto', 'suid', 'srvid', 'guid', 'id', 'flags'];for(var iter in Iterator(this)){var key=iter[0], value=iter[1];if(skip.indexOf(key)!==&#45;1) continue;o[key]=value;}},};body={mergeInto:function(o){for(var iter in Iterator(this)){var key=iter[0], value=iter[1];if(key=== 'mergeInto') continue;o[key]=value;}},};flagHeader=function(flag, state){header.flags.push([flag, state]);}}var bodyType, bodySize;for(var iter in Iterator(node.children)){var child=iter[1];var childText=child.children.length?child.children[0].textContent:null;switch(child.tag){case em.Subject:header.subject=childText;break;case em.From:header.author=$mimelib.parseAddresses(childText)[0]||null;break;case em.To:header.to=$mimelib.parseAddresses(childText);break;case em.Cc:header.cc=$mimelib.parseAddresses(childText);break;case em.ReplyTo:header.replyTo=$mimelib.parseAddresses(childText);break;case em.DateReceived:body.date=header.date=new Date(childText).valueOf();break;case em.Read:flagHeader('\\Seen', childText=== '1');break;case em.Flag:for(var iter2 in Iterator(child.children)){var grandchild=iter2[1];if(grandchild.tag===em.Status) flagHeader('\\Flagged', grandchild.children[0].textContent!== '0');}break;case asb.Body:for(var iter2 in Iterator(child.children)){var grandchild=iter2[1];switch(grandchild.tag){case asb.Type:var type=grandchild.children[0].textContent;if(type===asbEnum.Type.HTML) bodyType= 'html';else{if(type!==asbEnum.Type.PlainText) console.warn('A message had a strange body type:', type) bodyType= 'plain';}break;case asb.EstimatedDataSize:bodySize=grandchild.children[0].textContent;break;}}break;case em.BodySize:bodyType= 'plain';bodySize=childText;break;case asb.Attachments:case em.Attachments:for(var iter2 in Iterator(child.children)){var attachmentNode=iter2[1];if(attachmentNode.tag!==asb.Attachment &amp;&amp;attachmentNode.tag!==em.Attachment) continue;var attachment={name:null, contentId:null, type:null, part:null, encoding:null, sizeEstimate:null, file:null,};var isInline=false;for(var iter3 in Iterator(attachmentNode.children)){var attachData=iter3[1];var dot, ext;var attachDataText=attachData.children.length?attachData.children[0].textContent:null;switch(attachData.tag){case asb.DisplayName:case em.DisplayName:attachment.name=attachDataText;dot=attachment.name.lastIndexOf('.');ext=dot &gt; 0?attachment.name.substring(dot+1).toLowerCase(): '';attachment.type=$mimelib.contentTypes[ext]|| 'application/octet&#45;stream';break;case asb.FileReference:case em.AttName:attachment.part=attachDataText;break;case asb.EstimatedDataSize:case em.AttSize:attachment.sizeEstimate=parseInt(attachDataText, 10);break;case asb.ContentId:attachment.contentId=attachDataText;break;case asb.IsInline:isInline=(attachDataText=== '1');break;case asb.FileReference:case em.Att0Id:attachment.part=attachData.children[0].textContent;break;}}if(isInline) body.relatedParts.push(attachment);else body.attachments.push(attachment);}header.hasAttachments=body.attachments.length &gt; 0;break;}}body.bodyReps=[{type:bodyType, sizeEstimate:bodySize, amountDownloaded:0, isDownloaded:false}];return{header:header, body:body};}, downloadBodies:function(headers, options, callback){if(this._account.conn.currentVersion.lt('12.0')) return this._syncBodies(headers, callback);var anyErr, pending=1, downloadsNeeded=0, folderConn=this;function next(err){if(err &amp;&amp;!anyErr) anyErr=err;if(!&#45;&#45;pending){folderConn._storage.runAfterDeferredCalls(function(){callback(anyErr, downloadsNeeded&#45;pending);});}}for(var i=0;i&lt; headers.length;i++){if(!headers[i]||headers[i].snippet!==null){continue;}pending++;downloadsNeeded++;this.downloadBodyReps(headers[i], options, next);}window.setZeroTimeout(next);}, downloadBodyReps:lazyConnection(1, function(header, options, callback){var folderConn=this;var account=this._account;if(account.conn.currentVersion.lt('12.0')) return this._syncBodies([header], callback);if(typeof(options)=== 'function'){callback=options;options=null;}options=options||{};var io=$ItemOperations.Tags;var ioEnum=$ItemOperations.Enums;var as=$AirSync.Tags;var asEnum=$AirSync.Enums;var asb=$AirSyncBase.Tags;var Type=$AirSyncBase.Enums.Type;var gotBody=function gotBody(bodyInfo){var bodyRep=bodyInfo.bodyReps[0];var bodyType=bodyRep.type=== 'html'?Type.HTML:Type.PlainText;var truncationSize;if(options.maximumBytesToFetch&lt; bodyRep.sizeEstimate){bodyType=Type.PlainText;truncationSize=DESIRED_TEXT_SNIPPET_BYTES;}var w=new $wbxml.Writer('1.3', 1, 'UTF&#45;8');w.stag(io.ItemOperations).stag(io.Fetch).tag(io.Store, 'Mailbox').tag(as.CollectionId, folderConn.serverId).tag(as.ServerId, header.srvid).stag(io.Options).stag(io.Schema).tag(asb.Body).etag().stag(asb.BodyPreference).tag(asb.Type, bodyType);if(truncationSize) w.tag(asb.TruncationSize, truncationSize);w.etag().etag().etag().etag();account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error(aError);account._reportErrorIfNecessary(aError);callback('unknown');return;}var status, bodyContent, e=new $wbxml.EventParser();e.addEventListener([io.ItemOperations, io.Status], function(node){status=node.children[0].textContent;});e.addEventListener([io.ItemOperations, io.Response, io.Fetch, io.Properties, asb.Body, asb.Data], function(node){bodyContent=node.children[0].textContent;});e.run(aResponse);if(status!==ioEnum.Status.Success) return callback('unknown');folderConn._updateBody(header, bodyInfo, bodyContent,!!truncationSize, callback);});};this._storage.getMessageBody(header.suid, header.date, gotBody);}), _syncBodies:function(headers, callback){var as=$AirSync.Tags;var asEnum=$AirSync.Enums;var em=$Email.Tags;var folderConn=this;var account=this._account;var w=new $wbxml.Writer('1.3', 1, 'UTF&#45;8');w.stag(as.Sync).stag(as.Collections).stag(as.Collection).tag(as.Class, 'Email').tag(as.SyncKey, this.syncKey).tag(as.CollectionId, this.serverId).stag(as.Options).tag(as.MIMESupport, asEnum.MIMESupport.Never).etag().stag(as.Commands);for(var i=0;i&lt; headers.length;i++){w.stag(as.Fetch).tag(as.ServerId, headers[i].srvid).etag();}w.etag().etag().etag().etag();account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error(aError);account._reportErrorIfNecessary(aError);callback('unknown');return;}var status, anyErr, i=0, pending=1;function next(err){if(err &amp;&amp;!anyErr) anyErr=err;if(!&#45;&#45;pending){folderConn._storage.runAfterDeferredCalls(function(){callback(anyErr);});}}var e=new $wbxml.EventParser();var base=[as.Sync, as.Collections, as.Collection];e.addEventListener(base.concat(as.SyncKey), function(node){folderConn.syncKey=node.children[0].textContent;});e.addEventListener(base.concat(as.Status), function(node){status=node.children[0].textContent;});e.addEventListener(base.concat(as.Responses, as.Fetch, as.ApplicationData, em.Body), function(node){var header=headers[i++];var bodyContent=node.children[0].textContent;pending++;folderConn._storage.getMessageBody(header.suid, header.date, function(body){folderConn._updateBody(header, body, bodyContent, false, next);});});e.run(aResponse);if(status!==asEnum.Status.Success) return next('unknown');next(null);});}, _updateBody:function(header, bodyInfo, bodyContent, snippetOnly, callback){var bodyRep=bodyInfo.bodyReps[0];if(bodyContent.length &amp;&amp;bodyContent[bodyContent.length&#45;1]=== '\n') bodyContent=bodyContent.slice(0,&#45;1);bodyContent=bodyContent.replace(/\r/g, '');var type=snippetOnly? 'plain':bodyRep.type;var data=$mailchew.processMessageContent(bodyContent, type,!snippetOnly, true, this._LOG);header.snippet=data.snippet;bodyRep.isDownloaded=!snippetOnly;bodyRep.amountDownloaded=bodyContent.length;if(!snippetOnly) bodyRep.content=data.content;var event={changeType: 'bodyReps', indexes:[0]};this._storage.updateMessageHeader(header.date, header.id, false, header);this._storage.updateMessageBody(header, bodyInfo, event);this._storage.runAfterDeferredCalls(callback.bind(null, null, bodyInfo));}, sync:lazyConnection(1, function asfc_sync(accuracyStamp, doneCallback, progressCallback){var folderConn=this, addedMessages=0, changedMessages=0, deletedMessages=0;this._LOG.sync_begin(null, null, null);this._enumerateFolderChanges(function(error, added, changed, deleted, moreAvailable){var storage=folderConn._storage;if(error=== 'badkey'){folderConn._account._recreateFolder(storage.folderId, function(s){folderConn._storage=null;folderConn._LOG.sync_end(null, null, null);});return;}else if(error){folderConn._LOG.sync_end(null, null, null);doneCallback(error);return;}for(var iter in Iterator(added)){var message=iter[1];if(storage.hasMessageWithServerId(message.header.srvid)) continue;storage.addMessageHeader(message.header);storage.addMessageBody(message.header, message.body);addedMessages++;}for(var iter in Iterator(changed)){var message=iter[1];if(!storage.hasMessageWithServerId(message.header.srvid)) continue;storage.updateMessageHeaderByServerId(message.header.srvid, true, function(oldHeader){message.header.mergeInto(oldHeader);return true;});changedMessages++;}for(var iter in Iterator(deleted)){var messageGuid=iter[1];if(!storage.hasMessageWithServerId(messageGuid)) continue;storage.deleteMessageByServerId(messageGuid);deletedMessages++;}if(!moreAvailable){var messagesSeen=addedMessages+changedMessages+deletedMessages;storage.runAfterDeferredCalls(function(){folderConn._LOG.sync_end(addedMessages, changedMessages, deletedMessages);storage.markSyncRange($sync.OLDEST_SYNC_DATE, accuracyStamp, 'XXX', accuracyStamp);doneCallback(null, null, messagesSeen);});}}, progressCallback);}), performMutation:lazyConnection(1, function(invokeWithWriter, callWhenDone){var folderConn=this;var as=$AirSync.Tags;var account=this._account;var w=new $wbxml.Writer('1.3', 1, 'UTF&#45;8');w.stag(as.Sync).stag(as.Collections).stag(as.Collection);if(account.conn.currentVersion.lt('12.1')) w.tag(as.Class, 'Email');w.tag(as.SyncKey, this.syncKey).tag(as.CollectionId, this.serverId).tag(as.DeletesAsMoves, this.folderMeta.type=== 'trash'? '0': '1').tag(as.GetChanges, '0').stag(as.Commands);try{invokeWithWriter(w);}catch(ex){console.error('Exception in performMutation callee:', ex, '\n', ex.stack);callWhenDone('unknown');return;}w.etag(as.Commands).etag(as.Collection).etag(as.Collections).etag(as.Sync);account.conn.postCommand(w, function(aError, aResponse){if(aError){console.error('postCommand error:', aError);account._reportErrorIfNecessary(aError);callWhenDone('unknown');return;}var e=new $wbxml.EventParser();var syncKey, status;var base=[as.Sync, as.Collections, as.Collection];e.addEventListener(base.concat(as.SyncKey), function(node){syncKey=node.children[0].textContent;});e.addEventListener(base.concat(as.Status), function(node){status=node.children[0].textContent;});try{e.run(aResponse);}catch(ex){console.error('Error parsing Sync response:', ex, '\n', ex.stack);callWhenDone('unknown');return;}if(status===$AirSync.Enums.Status.Success){folderConn.syncKey=syncKey;if(callWhenDone) callWhenDone(null);}else{console.error('Something went wrong during ActiveSync syncing and we '+ 'got a status of '+status);callWhenDone('status:'+status);}});}), downloadMessageAttachments:lazyConnection(2, function(uid, partInfos, callback, progress){var folderConn=this;var io=$ItemOperations.Tags;var ioStatus=$ItemOperations.Enums.Status;var asb=$AirSyncBase.Tags;var w=new $wbxml.Writer('1.3', 1, 'UTF&#45;8');w.stag(io.ItemOperations);for(var iter in Iterator(partInfos)){var part=iter[1];w.stag(io.Fetch).tag(io.Store, 'Mailbox').tag(asb.FileReference, part.part).etag();}w.etag();this._account.conn.postCommand(w, function(aError, aResult){if(aError){console.error('postCommand error:', aError);folderConn._account._reportErrorIfNecessary(aError);callback('unknown');return;}var globalStatus;var attachments={};var e=new $wbxml.EventParser();e.addEventListener([io.ItemOperations, io.Status], function(node){globalStatus=node.children[0].textContent;});e.addEventListener([io.ItemOperations, io.Response, io.Fetch], function(node){var part=null, attachment={};for(var iter in Iterator(node.children)){var child=iter[1];switch(child.tag){case io.Status:attachment.status=child.children[0].textContent;break;case asb.FileReference:part=child.children[0].textContent;break;case io.Properties:var contentType=null, data=null;for(var iter2 in Iterator(child.children)){var grandchild=iter2[1];var textContent=grandchild.children[0].textContent;switch(grandchild.tag){case asb.ContentType:contentType=textContent;break;case io.Data:data=new Buffer(textContent, 'base64');break;}}if(contentType &amp;&amp;data) attachment.data=new Blob([data],{type:contentType});break;}if(part) attachments[part]=attachment;}});e.run(aResult);var error=globalStatus!==ioStatus.Success? 'unknown':null;var bodies=[];for(var iter in Iterator(partInfos)){var part=iter[1];if(attachments.hasOwnProperty(part.part)&amp;&amp;attachments[part.part].status===ioStatus.Success){bodies.push(attachments[part.part].data);}else{error= 'unknown';bodies.push(null);}}callback(error, bodies);});}),};function ActiveSyncFolderSyncer(account, folderStorage, _parentLog){this._account=account;this.folderStorage=folderStorage;this._LOG=LOGFAB.ActiveSyncFolderSyncer(this, _parentLog, folderStorage.folderId);this.folderConn=new ActiveSyncFolderConn(account, folderStorage, this._LOG);}exports.ActiveSyncFolderSyncer=ActiveSyncFolderSyncer;ActiveSyncFolderSyncer.prototype={get syncable(){return this.folderConn.serverId!==null;}, get canGrowSync(){return false;}, initialSync:function(slice, initialDays, syncCallback, doneCallback, progressCallback){syncCallback('sync', false, true);this.folderConn.sync($date.NOW(), this.onSyncCompleted.bind(this, doneCallback, true), progressCallback);}, refreshSync:function(slice, dir, startTS, endTS, origStartTS, doneCallback, progressCallback){this.folderConn.sync($date.NOW(), this.onSyncCompleted.bind(this, doneCallback, false), progressCallback);}, growSync:function(slice, growthDirection, anchorTS, syncStepDays, doneCallback, progressCallback){return false;}, onSyncCompleted:function ifs_onSyncCompleted(doneCallback, initialSync, err, bisectInfo, messagesSeen){var storage=this.folderStorage;console.log(&quot;Sync Completed!&quot;, messagesSeen,&quot;messages synced&quot;);if(!err) storage.markSyncedToDawnOfTime();this._account.__checkpointSyncCompleted();if(err){doneCallback(err);return;}if(initialSync){storage._curSyncSlice.ignoreHeaders=false;storage._curSyncSlice.waitingOnData= 'db';storage.getMessagesInImapDateRange(0, null, $sync.INITIAL_FILL_SIZE, $sync.INITIAL_FILL_SIZE, storage.onFetchDBHeaders.bind(storage, storage._curSyncSlice, false, doneCallback, null));}else{doneCallback(err);}}, allConsumersDead:function(){}, shutdown:function(){this.folderConn.shutdown();this._LOG.__die();},};var LOGFAB=exports.LOGFAB=$log.register($module,{ActiveSyncFolderConn:{type:$log.CONNECTION, subtype:$log.CLIENT, events:{inferFilterType:{filterType:false},}, asyncJobs:{sync:{newMessages:true, changedMessages:true, deletedMessages:true,},}, errors:{htmlParseError:{ex:$log.EXCEPTION}, htmlSnippetError:{ex:$log.EXCEPTION}, textChewError:{ex:$log.EXCEPTION}, textSnippetError:{ex:$log.EXCEPTION},},}, ActiveSyncFolderSyncer:{type:$log.DATABASE, events:{}},});})" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/d14/build__stage_2email_2js_2mix_8js.html#ae57540f837ee76af1c71776a8f46ae53">define</a> </td>
          <td>(</td>
          <td class="paramtype">'mailapi/activesync/account'&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Implements the ActiveSync protocol for Hotmail and Exchange.</p>
<p>Configurator for activesync </p>

</div>
</div>
<hr/><h2>変数</h2>
<a class="anchor" id="a11a10a6834f3c54a5380f4ff04d002a9"></a><!-- doxytag: member="apps/email/js/ext/mailapi/activesync/configurator.js::root" ref="a11a10a6834f3c54a5380f4ff04d002a9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> <a class="el" href="../../d2/dd7/crystalskull_8js.html#a33796d6d1aed1fe6b4c866bfd3867459">root</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p> <a class="el" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js_source.html">apps/email/js/ext/mailapi/activesync/configurator.js</a> の <a class="el" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js_source.html#l00017">17</a> 行で定義されています。</p>

<p>参照元 <a class="el" href="../../d5/d87/import-scripts_8js_source.html#l00003">importScripts()</a>, と <a class="el" href="../../d2/d7d/jsapi_8h_source.html#l01531">JS::ToNumber()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d1/df9/apps_2email_2js_2ext_2mailapi_2activesync_2configurator_8js.html">configurator.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:55:51に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
