<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: importer_ui.js</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d5/dc5/importer__ui_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">関数</a> &#124;
<a href="#var-members">変数</a>  </div>
  <div class="headertitle">
<div class="title">importer_ui.js</div>  </div>
</div><!--header-->
<div class="contents">

<p><a href="../../d5/dc5/importer__ui_8js_source.html">ソースコードを見る。</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
関数</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/dc5/importer__ui_8js.html#a98dcc506f33c3ed40141a5ba86222b34">if</a> (<a class="el" href="../../d7/d9f/thread_8js.html#aa8dea74882346c7746113d234836bb3a">typeof</a> window.importer=== 'undefined')</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
変数</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d7/d1b/test-agent-server_8js.html#aab71dcc804ca4aa3ed2bf7ba887635db">use</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/dc5/importer__ui_8js.html#ae2475e10618961c050dcba04e8c42331">strict</a></td></tr>
</table>
<hr/><h2>関数</h2>
<a class="anchor" id="a98dcc506f33c3ed40141a5ba86222b34"></a><!-- doxytag: member="importer_ui.js::if" ref="a98dcc506f33c3ed40141a5ba86222b34" args="(typeof window.importer=== 'undefined')" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../de/dfc/events_8js.html#aa27c1f7f883859f374ef91e69db597bd">if</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="../../d7/d9f/thread_8js.html#aa8dea74882346c7746113d234836bb3a">typeof</a> window.&#160;</td>
          <td class="paramname"><em>importer</em> = <code>==&#160;'undefined'</code></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function is invoked when a token is ready to be used</p>
<p>Invoked when the existing service contacts on the Address Book are ready</p>
<p>Invoked when friends are ready</p>
<p>Existing contacts are disabled</p>
<p>Gets the friends by invoking Graph API</p>
<p>Callback invoked when friends are ready to be used</p>
<p>This function is invoked when importing and updating operations finished</p>
<p>This function is invoked when an import or update is launched</p>
<p>Invoked when the user selects all his friends</p>
<p>Invoked when the user unselects all her contacts</p>
<p>Clears the list of contacts</p>
<p>Makes a bulk selection of the contacts</p>
<p>Invoked when an element in the friend list is selected</p>
<p>Imports all the selected contacts on the address book</p>

<p> <a class="el" href="../../d5/dc5/importer__ui_8js_source.html">importer_ui.js</a> の <a class="el" href="../../d5/dc5/importer__ui_8js_source.html#l00003">3</a> 行で定義されています。</p>

<p>参照先 <a class="el" href="../../d6/d52/js_2browser_8js_source.html#l00004">_</a>, <a class="el" href="../../df/d44/permission__manager_8js_source.html#l00186">callback</a>, <a class="el" href="../../d2/d7d/jsapi_8h_source.html#l02249">callbacks</a>, <a class="el" href="../../d2/d7d/jsapi_8h_source.html#l02650">cb</a>, <a class="el" href="../../d3/d91/j3d_8js_source.html#l00076">clone</a>, <a class="el" href="../../d3/d42/camera_2js_2confirm_8js_source.html#l00011">ConfirmDialog</a>, <a class="el" href="../../d7/d91/contacts__matcher__test_8js_source.html#l00005">contact</a>, <a class="el" href="../../db/d4e/contacts__matcher_8js_source.html#l00003">contacts</a>, <a class="el" href="../../d7/d68/apps_2communications_2contacts_2js_2contacts_8js_source.html#l00012">Contacts</a>, <a class="el" href="../../d1/d20/curtain_8js_source.html#l00003">Curtain</a>, <a class="el" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js_source.html#l01348">document</a>, <a class="el" href="../../d1/d04/app__install__manager_8js_source.html#l00508">e</a>, <a class="el" href="../../db/df4/geoloc_8js_source.html#l00041">error()</a>, <a class="el" href="../../d2/d7d/jsapi_8h_source.html#l01216">id</a>, <a class="el" href="../../d2/d7d/jsapi_8h_source.html#l02148">key</a>, <a class="el" href="../../d1/d04/app__install__manager_8js_source.html#l00214">msg</a>, <a class="el" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js_source.html#l00043">navigator</a>, <a class="el" href="../../d1/d04/app__install__manager_8js_source.html#l00456">node</a>, <a class="el" href="../../d1/d04/app__install__manager_8js_source.html#l00420">null</a>, <a class="el" href="../../d6/d54/parameters_8js_source.html#l00001">oauthflow</a>, <a class="el" href="../../d2/d7d/jsapi_8h_source.html#l02125">obj</a>, <a class="el" href="../../d2/d7d/jsapi_8h_source.html#l01599">js::out</a>, <a class="el" href="../../d3/d4b/lockscreen_8js_source.html#l01188">overlay</a>, <a class="el" href="../../d6/d54/parameters_8js_source.html#l00001">params</a>, <a class="el" href="../../d2/d7d/jsapi_8h_source.html#l03150">parent</a>, <a class="el" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md_source.html#l00032">recommend</a>, <a class="el" href="../../da/d7d/cook_8js_source.html#l00001">result</a>, <a class="el" href="../../db/df4/geoloc_8js_source.html#l00010">success()</a>, <a class="el" href="../../d1/d04/app__install__manager_8js_source.html#l00540">title</a>, <a class="el" href="../../df/d44/permission__manager_8js_source.html#l00145">type</a>, <a class="el" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof()</a>, <a class="el" href="../../d3/d4b/lockscreen_8js_source.html#l01155">url</a>, <a class="el" href="../../d0/df4/contacts__shortcuts_8js_source.html#l00004">utils</a>, と <a class="el" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js_source.html#l01331">window</a>.</p>
<div class="fragment"><pre class="fragment">                                            {
  (<span class="keyword">function</span>(<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>) {

    var Importer = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.importer = {};
    var UI = Importer.ui = {};

    var TOKEN_EXPIRED_STR = <span class="stringliteral">&#39;request_token_expired&#39;</span>;
    var TOKEN_EXPIRED_CODE = 190;

    <span class="comment">// Connector to the external service</span>
    var serviceConnector;
    <span class="comment">// target app which will receive all messages from the importer</span>
    var targetApp;

    var access_token;

    var startCallback;

    <span class="comment">// External service contacts (aka friends) selected to be sync</span>
    <span class="comment">// to the address book</span>
    var selectedContacts = {};

    <span class="comment">// Device contacts to be unselected (will be removed from the Addr Book)</span>
    var unSelectedContacts = {};

    <span class="comment">// Contacts that are suitable to be selected</span>
    var selectableFriends = {};

    <span class="comment">// The whole list of friends as an array</span>
    var myFriends, myFriendsByUid;

    <span class="comment">// Counter for checked list items</span>
    var checked = 0;
    var checkNodeList;

    <span class="comment">// Existing service contacts</span>
    var existingContacts = [];
    var existingContactsByUid = {};

    var contactsLoaded = <span class="keyword">false</span>, friendsLoaded = <span class="keyword">false</span>;

    var currentRequest;
    <span class="comment">// Current network request to enable canceling</span>
    var currentNetworkRequest = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;

    var cancelled = <span class="keyword">false</span>;

    var <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a> = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozL10n.get;

    <span class="comment">// Indicates whether some friends have been imported or not</span>
    var friendsImported;

    <span class="comment">// For synchronization</span>
    var syncOngoing = <span class="keyword">false</span>;

    var updateButton,
        selectAllButton,
        deSelectAllButton,
        contactList,
        headerElement,
        friendsMsgElement,
        scrollableElement;

    var <a class="code" href="../../d3/dd3/classimg_loader.html">imgLoader</a>;

    <span class="comment">// More than this number will not trigger sync when clicking</span>
    <span class="comment">// on &quot;Update Facebook Friends&quot;</span>
    var HARD_LIMIT_SYNC = 300;

    var tokenKey;

    var isOnLine = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.onLine;
    var ongoingImport = <span class="keyword">false</span>;
    var ongoingClean = <span class="keyword">false</span>;
    var theImporter, theCleaner;

    <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;online&#39;</span>, onLineChanged);
    <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;offline&#39;</span>, onLineChanged);

    <span class="keyword">function</span> showOfflineDialog(yesCb, noCb) {
      var <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a5e1306e0121e86783349a0aabb192b8b">recommend</a> = serviceConnector.name === <span class="stringliteral">&#39;facebook&#39;</span>;
      <a class="code" href="../../d7/d68/apps_2communications_2contacts_2js_2contacts_8js.html#a55257a4a6c5aab93045fd427504a1c95">Contacts</a>.confirmDialog(<a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;connectionLost&#39;</span>), <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;connectionLostMsg&#39;</span>),
        {
          <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa5a506cf1e53b91549e35a5d3bc3dc06">title</a>: <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;noOption&#39;</span>),
          isRecommend: !<a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a5e1306e0121e86783349a0aabb192b8b">recommend</a>,
          <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>: <span class="keyword">function</span>() {
            <a class="code" href="../../d3/d42/camera_2js_2confirm_8js.html#a62ff52c410e9de0d9973e5297755e83c">ConfirmDialog</a>.hide();
            noCb();
          }
        },
        {
          <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa5a506cf1e53b91549e35a5d3bc3dc06">title</a>: <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;yesOption&#39;</span>),
          <span class="comment">// FB friends can later resync data</span>
          isRecommend: <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a5e1306e0121e86783349a0aabb192b8b">recommend</a>,
          <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>: <span class="keyword">function</span>() {
            <a class="code" href="../../d3/d42/camera_2js_2confirm_8js.html#a62ff52c410e9de0d9973e5297755e83c">ConfirmDialog</a>.hide();
            yesCb();
          }
      }, {
        zIndex: <span class="stringliteral">&#39;10000&#39;</span>
    });
    }

    <span class="keyword">function</span> onLineChanged() {
      isOnLine = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.onLine;
      <span class="keywordflow">if</span> (isOnLine === <span class="keyword">false</span> &amp;&amp; ongoingImport) {
        theImporter.hold();

        showOfflineDialog(<span class="keyword">function</span>() {
          theImporter.resume();
        }, <span class="keyword">function</span>() {
            <span class="comment">// Finish the import process consistently</span>
            theImporter.finish();
        });
      }
    }

    <span class="keyword">function</span> getTokenKey() {
      var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> = <span class="stringliteral">&#39;tokenData&#39;</span>;
      var serviceName = serviceConnector.name;

      <span class="keywordflow">if</span> (serviceName !== <span class="stringliteral">&#39;facebook&#39;</span>) {
        key += (<span class="charliteral">&#39;_&#39;</span> + serviceName);
      }

      <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>;
    }

    <span class="comment">// Define a source adapter object to pass to contacts.Search.</span>
    <span class="comment">//</span>
    <span class="comment">// Since multiple, separate apps use contacts.Search its important for</span>
    <span class="comment">// the search code to function independently.  This adapter object allows</span>
    <span class="comment">// the search module to access the app&#39;s contacts without knowing anything</span>
    <span class="comment">// about our DOM structure.</span>
    var searchSource = {
      getNodes: <span class="keyword">function</span>() {
        <span class="keywordflow">return</span> contactList.querySelectorAll(<span class="stringliteral">&#39;section &gt; ol &gt; li&#39;</span>);
      },
      getFirstNode: <span class="keyword">function</span>() {
        <span class="keywordflow">return</span> contactList.querySelector(<span class="stringliteral">&#39;section &gt; ol &gt; li&#39;</span>);
      },
      getNextNode: <span class="keyword">function</span>(<a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>) {
        var <a class="code" href="../../db/da2/namespacejs.html#ae38c69c83e560d6765bddb6b3d53cc46">out</a> = <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>.nextElementSibling;
        var nextParent = <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>.parentNode.parentNode.nextElementSibling;
        <span class="keywordflow">while</span> (!out &amp;&amp; nextParent) {
          out = nextParent.querySelector(<span class="stringliteral">&#39;ol &gt; li:first-child&#39;</span>);
          nextParent = nextParent.nextElementSibling;
        }
        <span class="keywordflow">return</span> <a class="code" href="../../db/da2/namespacejs.html#ae38c69c83e560d6765bddb6b3d53cc46">out</a>;
      },
      expectMoreNodes: <span class="keyword">function</span>() {
        <span class="comment">// This app does not lazy load contacts into search via the</span>
        <span class="comment">// appendNodes() function, so always return false.</span>
        <span class="keywordflow">return</span> <span class="keyword">false</span>;
      },
      <a class="code" href="../../d3/d91/j3d_8js.html#a069c41f2a736def4f0798a9765e2e332">clone</a>: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
        <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.cloneNode();
      },
      getNodeById: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>) {
        <span class="keywordflow">return</span> contactsList.querySelector(<span class="stringliteral">&#39;[data-uuid=&quot;&#39;</span> + <span class="keywordtype">id</span> + <span class="stringliteral">&#39;&quot;]&#39;</span>);
      },
      getSearchText: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>) {
        <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a>.dataset.search;
      },
      click: onSearchResultCb
    }; <span class="comment">// searchSource</span>

    UI.init = <span class="keyword">function</span>() {
      var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a071ea38270614fdc4968e0f755fc8b79">overlay</a> = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;nav[data-type=&quot;scrollbar&quot;] p&#39;</span>);
      var jumper = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;nav[data-type=&quot;scrollbar&quot;] ol&#39;</span>);

      updateButton = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementById(<span class="stringliteral">&#39;import-action&#39;</span>);
      selectAllButton = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;#select-all&#39;</span>);
      deSelectAllButton = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;#deselect-all&#39;</span>);
      contactList = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;#groups-list&#39;</span>);

      headerElement = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;header&#39;</span>);
      friendsMsgElement = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;#friends-msg&#39;</span>);
      scrollableElement = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;#mainContent&#39;</span>);

      var <a class="code" href="../../d6/d54/parameters_8js.html#a4ad646d0ee2fc69a53b50783ca7465dc">params</a> = {
        overlay: <a class="code" href="../../d3/d4b/lockscreen_8js.html#a071ea38270614fdc4968e0f755fc8b79">overlay</a>,
        jumper: jumper,
        groupSelector: <span class="stringliteral">&#39;#group-&#39;</span>,
        scrollToCb: scrollToCb
      };

      <a class="code" href="../../d0/df4/contacts__shortcuts_8js.html#a7b58b8887c6d26e09f79fbacfbda7f53">utils</a>.alphaScroll.init(params);
      <a class="code" href="../../db/d4e/contacts__matcher_8js.html#a9c02ff135182792b8b5b9cf246a368e8">contacts</a>.Search.init(searchSource, <span class="keyword">true</span>);
    };

    <span class="keyword">function</span> notifyLogout() {
       <span class="comment">// Simulating logout finished to enable seamless closing of the iframe</span>
      var <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a> = {
        <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;logout_finished&#39;</span>,
        <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <span class="stringliteral">&#39;&#39;</span>
      };
      <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage(msg, targetApp);
    }

    UI.end = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
      var msg = {
        <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;window_close&#39;</span>,
        <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <span class="stringliteral">&#39;&#39;</span>
      };

      <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage(msg, targetApp);
      <span class="comment">// uncomment this to make it work on B2G-Desktop</span>
      <span class="comment">// parent.postMessage(msg, &#39;*&#39;);</span>

      notifyLogout();
    };

    <span class="keyword">function</span> removeToken(<a class="code" href="../../d2/d7d/jsapi_8h.html#a9c0cec265243907d0da86b92bda26eca">cb</a>) {
      var theCb = (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../d2/d7d/jsapi_8h.html#a9c0cec265243907d0da86b92bda26eca">cb</a> === <span class="stringliteral">&#39;function&#39;</span>) ? cb : <span class="keyword">function</span>() {};
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.asyncStorage.removeItem(tokenKey, theCb, theCb);
    }

    <span class="keyword">function</span> markPendingLogout(<a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>, service, cb) {
      var PENDING_LOGOUT_KEY = <span class="stringliteral">&#39;pendingLogout&#39;</span>;
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.asyncStorage.getItem(PENDING_LOGOUT_KEY,
          <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>) {
            var <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a> = <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> || {};
            obj[service] = <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>;
            var theCb = (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> cb === <span class="stringliteral">&#39;function&#39;</span>) ? cb : <span class="keyword">function</span>() {};
            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.asyncStorage.setItem(PENDING_LOGOUT_KEY, obj, theCb, theCb);
          });
    }

    <span class="keyword">function</span> serviceLogout(cb) {
      <span class="keywordflow">if</span> (serviceConnector.automaticLogout) {
        var serviceName = serviceConnector.name;
        var logoutUrl = <a class="code" href="../../d6/d54/parameters_8js.html#a25dd01d9d523f4c431d5c32dd8277682">oauthflow</a>.params[serviceName].logoutUrl;

        var <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a> = {
          <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>: <span class="keyword">function</span>() {
            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console.warn(<span class="stringliteral">&#39;Error while logging out user &#39;</span>, logoutUrl);
            removeToken();
            markPendingLogout(logoutUrl, serviceName, cb);
          },
          <a class="code" href="../../da/d32/prio_8h.html#a0f2163507f01dc9bb68ca5c72cacaa34">timeout</a>: <span class="keyword">function</span>() {
            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console.warn(<span class="stringliteral">&#39;Timeout while logging out user &#39;</span>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a>);
            removeToken();
            markPendingLogout(logoutUrl, serviceName, cb);
          },
          <a class="code" href="../../db/df4/geoloc_8js.html#a15b4f92b0ef49ac05f43437f3d85ae46">success</a>: <span class="keyword">function</span>() {
            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console.log(<span class="stringliteral">&#39;Successfully logged out&#39;</span>);
            removeToken(cb);
          }
        };

        <span class="comment">// Prevent false logout positives</span>
        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.onLine === <span class="keyword">true</span>) {
          Rest.get(logoutUrl, callbacks);
        }
        <span class="keywordflow">else</span> {
          removeToken();
          markPendingLogout(logoutUrl, serviceName, cb);
        }
      }
      <span class="keywordflow">else</span> {
        <a class="code" href="../../d2/d7d/jsapi_8h.html#a9c0cec265243907d0da86b92bda26eca">cb</a>();
      }
    }

    <span class="keyword">function</span> tokenExpired(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>) {
      <span class="keywordflow">return</span> (<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>.code === TOKEN_EXPIRED_CODE || <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a> === TOKEN_EXPIRED_STR);
    }

    <span class="keyword">function</span> scrollToCb(groupContainer) {
      scrollableElement.scrollTop = groupContainer.offsetTop;
    }

    <span class="keyword">function</span> onSearchResultCb(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
      var <a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.target;
      var uid = target.dataset.uuid;
      var checkbox = target.querySelector(<span class="stringliteral">&#39;input[type=&quot;checkbox&quot;]&#39;</span>);
      checkbox.checked = !checkbox.checked;

      var realNode = contactList.querySelector(
                          <span class="stringliteral">&#39;[data-uuid=&#39;</span> + <span class="charliteral">&#39;&quot;&#39;</span> + uid + <span class="charliteral">&#39;&quot;&#39;</span> + <span class="charliteral">&#39;]&#39;</span>);

      UI.selection({
        target: realNode
      });
    }

    <span class="comment">// Function used by unit tests to reset the state of the module</span>
    Importer.reset = <span class="keyword">function</span>() {
      selectedContacts = {};
      unSelectedContacts = {};
      selectableFriends = {};

      myFriends = []; myFriendsByUid = {};

      checked = 0;

      <span class="comment">// Existing service contacts</span>
      existingContacts = [];
      existingContactsByUid = {};

      contactsLoaded = <span class="keyword">false</span>;
      friendsLoaded = <span class="keyword">false</span>;

      currentRequest = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
      currentNetworkRequest = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;

      friendsImported = <span class="keyword">false</span>;
      syncOngoing = <span class="keyword">false</span>;

      ongoingImport = ongoingClean = <span class="keyword">false</span>;

      selectAllButton = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementById(<span class="stringliteral">&#39;select-all&#39;</span>);
      deSelectAllButton = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.getElementById(<span class="stringliteral">&#39;deselect-all&#39;</span>);
    };

    Importer.start = <span class="keyword">function</span>(acc_tk, connector, ptargetApp, startCb) {
      startCallback = startCb;

      var serviceName = connector.name;

      <span class="comment">// Setting UI title</span>
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;#content h1&#39;</span>).textContent =
                                          <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(serviceName + <span class="stringliteral">&#39;-serviceName&#39;</span>);
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.body.classList.add(serviceName);

      serviceConnector = connector;
      targetApp = ptargetApp;
      tokenKey = getTokenKey();

      setCurtainHandlers();

      <span class="keywordflow">if</span> (acc_tk) {
        access_token = acc_tk;
        Importer.getFriends(acc_tk);
      }
      <span class="keywordflow">else</span> {
        oauth2.getAccessToken(<span class="keyword">function</span>(new_acc_tk) {
          access_token = new_acc_tk;
          Importer.getFriends(new_acc_tk);
        }, <span class="stringliteral">&#39;friends&#39;</span>, serviceConnector.name);
      }
    };

    <span class="keyword">function</span> contactsReady(<a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>) {
      existingContacts = <a class="code" href="../../da/d7d/cook_8js.html#a65ab37df1aa3fe0eb3d8e51a835fb617">result</a>;
      contactsLoaded = <span class="keyword">true</span>;

      <span class="keywordflow">if</span> (friendsLoaded) {
        markExisting(existingContacts);
      }
    }

     <span class="comment">// Callback executed when a synchronization has finished successfully</span>
    <span class="keyword">function</span> syncSuccess(numChanged) {
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console.log(<span class="stringliteral">&#39;Synchronization ended!!!&#39;</span>);
      syncOngoing = <span class="keyword">false</span>;

      serviceConnector.scheduleNextSync();
      var msg = {
        <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;sync_finished&#39;</span>,
        <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: numChanged || <span class="stringliteral">&#39;&#39;</span>
      };
      <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage(msg, targetApp);
    }

    <span class="comment">// Starts a synchronization</span>
    <span class="keyword">function</span> startSync() {
      var totalExisting = existingContacts.length;
      <span class="keywordflow">if</span> (totalExisting &gt; 0 &amp;&amp; totalExisting &lt; HARD_LIMIT_SYNC &amp;&amp;
          !syncOngoing) {
        syncOngoing = <span class="keyword">true</span>;

        serviceConnector.startSync(existingContacts, myFriendsByUid,
                                   syncSuccess);
      }
      <span class="keywordflow">else</span> {
        <span class="comment">// Automatically notify sync finished</span>
        var msg = {
          <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;sync_finished&#39;</span>,
          <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: 0
        };
        <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage(msg, targetApp);
      }
    }


    <span class="keyword">function</span> friendsAvailable() {
      FixedHeader.init(<span class="stringliteral">&#39;#mainContent&#39;</span>, <span class="stringliteral">&#39;#fixed-container&#39;</span>,
                     <span class="stringliteral">&#39;.import-list header, .fb-import-list header&#39;</span>);

      imgLoader = <span class="keyword">new</span> ImageLoader(<span class="stringliteral">&#39;#mainContent&#39;</span>,
                                <span class="stringliteral">&quot;.block-item:not([data-uuid=&#39;#uid#&#39;])&quot;</span>);

      var <a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a> = <span class="stringliteral">&#39;.block-item:not([data-uuid=&quot;#uid#&quot;]) input[type=&quot;checkbox&quot;]&#39;</span>;
      checkNodeList = contactList.querySelectorAll(s);
      Array.prototype.slice.call(checkNodeList, 0, checkNodeList.length);

      friendsLoaded = <span class="keyword">true</span>;

      <span class="keywordflow">if</span> (contactsLoaded) {
        <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;message&#39;</span>, <span class="keyword">function</span> importOnViewPort(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
          <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.origin !== targetApp) {
            <span class="keywordflow">return</span>;
          }
          var <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.data;
          <span class="keywordflow">if</span> (data &amp;&amp; data.type === <span class="stringliteral">&#39;dom_transition_end&#39;</span>) {
            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.removeEventListener(<span class="stringliteral">&#39;message&#39;</span>, importOnViewPort);
            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(startSync, 0);
          }
        });
        markExisting(existingContacts);
      }

      <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.hide(sendReadyEvent);

      <span class="comment">// Only for unit testing purposes</span>
      <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> startCallback === <span class="stringliteral">&#39;function&#39;</span>) {
        <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(startCallback, 0);
      }
    }

    <span class="keyword">function</span> sendReadyEvent() {
      <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage({
        <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;ready&#39;</span>, <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <span class="stringliteral">&#39;&#39;</span>
      }, targetApp);
    }

    <span class="keyword">function</span> markExisting(deviceFriends) {
      updateButton.textContent = deviceFriends.length === 0 ? <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;import&#39;</span>) :
                                                              _(<span class="stringliteral">&#39;update&#39;</span>);

      deviceFriends.forEach(<span class="keyword">function</span>(fbContact) {
        var uid = serviceConnector.getContactUid(fbContact);
        <span class="comment">// We are updating those friends that are potentially selectable</span>
        <span class="keyword">delete</span> selectableFriends[uid];
        var ele = <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;[data-uuid=&quot;&#39;</span> + uid + <span class="stringliteral">&#39;&quot;]&#39;</span>);
        <span class="comment">// This check is needed as there might be existing FB Contacts that</span>
        <span class="comment">// are no longer friends</span>
        <span class="keywordflow">if</span> (ele) {
          setChecked(ele.querySelector(<span class="stringliteral">&#39;input[type=&quot;checkbox&quot;]&#39;</span>), <span class="keyword">true</span>);
        }
        <span class="keywordflow">if</span> (existingContactsByUid[uid]) {
          existingContactsByUid[uid].push(fbContact);
        } <span class="keywordflow">else</span> {
          existingContactsByUid[uid] = [fbContact];
        }
      });

      var <a class="code" href="../../dd/dfa/ns_i_d_o_m_storage_event_8idl.html#ae2d3f872ef6de235e7800c00038a4a55">newValue</a> = myFriends.length -
                        Object.keys(existingContactsByUid).length;
      friendsMsgElement.textContent = <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;fbFriendsFound&#39;</span>, {
        numFriends: newValue
      });

      checkDisabledButtons();
    }

    <span class="comment">// Only needed for testing purposes</span>
    Importer.setSelected = <span class="keyword">function</span>(friends) {
      selectedContacts = friends;
    };

    <span class="keyword">function</span> setCurtainHandlers() {
      <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.oncancel = cancelCb;
    }

    Importer.getFriends = <span class="keyword">function</span>(acc_tk) {
      currentNetworkRequest = serviceConnector.listAllContacts(acc_tk, {
        <a class="code" href="../../db/df4/geoloc_8js.html#a15b4f92b0ef49ac05f43437f3d85ae46">success</a>: importer.friendsReady,
        <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>: importer.errorHandler,
        <a class="code" href="../../da/d32/prio_8h.html#a0f2163507f01dc9bb68ca5c72cacaa34">timeout</a>: importer.timeoutHandler
      });

      <span class="comment">// In the meantime we obtain the Service Contacts</span>
      <span class="comment">// already on the Address Book</span>
      <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozContacts) {
        <span class="keywordflow">return</span>;
      }

      var callbacks = {
        <a class="code" href="../../db/df4/geoloc_8js.html#a15b4f92b0ef49ac05f43437f3d85ae46">success</a>: contactsReady,
        <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab4b2a299eb3988169558a8cf1da08232">errorName</a>) {
          <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console.error(<span class="stringliteral">&#39;Error while retrieving existing dev contacts: &#39;</span>,
                               <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab4b2a299eb3988169558a8cf1da08232">errorName</a>);
        }
      };

      serviceConnector.listDeviceContacts(callbacks);

    };

    <span class="keyword">function</span> friendImportTimeout() {
      <span class="keywordflow">if</span> (currentRequest) {
        <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(currentRequest.ontimeout, 0);
      }
    }

    <span class="keyword">function</span> friendImportError(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
      currentRequest.failed(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>);
    }


    Importer.friendsReady = <span class="keyword">function</span>(response) {
      <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> response.error === <span class="stringliteral">&#39;undefined&#39;</span>) {
        var lmyFriends = response.data;
        <span class="comment">// Notifying the connector</span>
        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> serviceConnector.oncontactsloaded === <span class="stringliteral">&#39;function&#39;</span>) {
          serviceConnector.oncontactsloaded(lmyFriends);
        }

        myFriendsByUid = {};
        myFriends = [];

        var totalMyFriends = lmyFriends.length;
        <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; totalMyFriends; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
          var aFriend = lmyFriends[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
          aFriend._idxFriendsArray = <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
          myFriends.push(serviceConnector.adaptDataForShowing(aFriend));

          myFriendsByUid[aFriend.uid] = aFriend;
          selectableFriends[aFriend.uid] = aFriend;
        }

        <a class="code" href="../../d1/de6/build__stage_2email_2shared_2js_2async__storage_8js.html#a4107f01ea365b45d43bc83776b837ffa">asyncStorage</a>.getItem(<span class="stringliteral">&#39;order.lastname&#39;</span>, <span class="keyword">function</span> orderValue(lastName) {
          var <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = {
            <a class="code" href="../../da/dce/details__test_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>: <span class="stringliteral">&#39;#groups-list&#39;</span>,
            orderBy: lastName ? <span class="stringliteral">&#39;lastName&#39;</span> : <span class="stringliteral">&#39;firstName&#39;</span>
          };

          <a class="code" href="../../d7/d47/friends__list_8js.html#a1f5ecfa9285038140abde673655ff713">FriendListRenderer</a>.render(myFriends, friendsAvailable, options);
        });
      }
      <span class="keywordflow">else</span> {
        <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console.error(<span class="stringliteral">&#39;Error, while retrieving friends&#39;</span>,
                                                    response.error.message);
        <span class="keywordflow">if</span> (!tokenExpired(response.error)) {
          setCurtainHandlersErrorFriends();
          <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.show(<span class="stringliteral">&#39;error&#39;</span>, <span class="stringliteral">&#39;friends&#39;</span>);
        }
        <span class="keywordflow">else</span> {
          <span class="comment">// There was a problem with the access token</span>
          <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console.warn(<span class="stringliteral">&#39;Access Token expired or revoked&#39;</span>);
          <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.hide();
          <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.asyncStorage.removeItem(tokenKey,
            <span class="keyword">function</span> token_removed() {
              oauth2.getAccessToken(<span class="keyword">function</span>(new_acc_tk) {
                access_token = new_acc_tk;
                Importer.getFriends(new_acc_tk);
              }, <span class="stringliteral">&#39;friends&#39;</span>, serviceConnector.name);
              <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage({
                <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;token_error&#39;</span>,
                <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <span class="stringliteral">&#39;&#39;</span>
              },targetApp);
          });
        } <span class="comment">// else</span>
      } <span class="comment">// else</span>
    };

    <span class="keyword">function</span> cancelImport() {
      cancelled = <span class="keyword">true</span>;

      var cancelFunc = onUpdate;
      <span class="keywordflow">if</span> (ongoingImport) {
        cancelFunc = theImporter.finish;
      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ongoingClean) {
        cancelFunc = theCleaner.finish;
      }

      cancelFunc();
      <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.show(<span class="stringliteral">&#39;message&#39;</span>, <span class="stringliteral">&#39;canceling&#39;</span>);
    }

    <span class="keyword">function</span> cancelCb() {
      <span class="keywordflow">if</span> (currentNetworkRequest) {
         currentNetworkRequest.cancel();
         currentNetworkRequest = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
      }

      <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.hide();

      <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage({
            <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;abort&#39;</span>,
            <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <span class="stringliteral">&#39;&#39;</span>
      }, targetApp);
    }

    <span class="keyword">function</span> setCurtainHandlersErrorFriends() {
      <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.oncancel = <span class="keyword">function</span> friends_cancel() {
          <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.hide();

          <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage({
            <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;abort&#39;</span>,
            <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <span class="stringliteral">&#39;&#39;</span>
          }, targetApp);
        };

      <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.onretry = <span class="keyword">function</span> get_friends() {
        <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.oncancel = cancelCb;
        <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.show(<span class="stringliteral">&#39;wait&#39;</span>, <span class="stringliteral">&#39;friends&#39;</span>);

        Importer.getFriends(access_token);
      };
    }

    <span class="keyword">function</span> checkUpdateButton() {
      <span class="comment">// Update button</span>
      <span class="keywordflow">if</span> (Object.keys(selectedContacts).length &gt; 0 ||
          Object.keys(unSelectedContacts).length &gt; 0) {
        updateButton.disabled = <span class="keyword">false</span>;
      } <span class="keywordflow">else</span> {
        <span class="comment">// Empty arrays implies to disable update button</span>
        updateButton.disabled = <span class="keyword">true</span>;
      }
    }

    <span class="keyword">function</span> checkDisabledButtons() {
      checkUpdateButton();

      <span class="keywordflow">switch</span> (checked) {
        <span class="keywordflow">case</span> 0:
          <span class="comment">// No checked contacts -&gt; De-select all disabled</span>
          deSelectAllButton.disabled = <span class="keyword">true</span>;
          selectAllButton.disabled = <span class="keyword">false</span>;
          <span class="keywordflow">break</span>;

        <span class="keywordflow">case</span> myFriends.length:
          <span class="comment">// All checked contacts -&gt; Select all disabled</span>
          selectAllButton.disabled = <span class="keyword">true</span>;
          deSelectAllButton.disabled = <span class="keyword">false</span>;
          <span class="keywordflow">break</span>;

        <span class="keywordflow">default</span>:
          deSelectAllButton.disabled = <span class="keyword">false</span>;
          selectAllButton.disabled = <span class="keyword">false</span>;
          <span class="keywordflow">break</span>;
      }
    }

    <span class="keyword">function</span> setChecked(element, <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>) {
      <span class="keywordflow">if</span> (element.checked !== <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>) {
        <span class="comment">// We have to take into account the action whether the value changes</span>
        <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a> ? ++checked : --checked;
      }
      element.checked = <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>;
    }

    <span class="comment">// Error / timeout handler</span>
    Importer.baseHandler = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
      setCurtainHandlersErrorFriends();
      <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.show(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, <span class="stringliteral">&#39;friends&#39;</span>);
    };

    Importer.timeoutHandler = <span class="keyword">function</span>() {
      Importer.baseHandler(<span class="stringliteral">&#39;timeout&#39;</span>);
    };

    Importer.errorHandler = <span class="keyword">function</span>() {
      Importer.baseHandler(<span class="stringliteral">&#39;error&#39;</span>);
    };

    <span class="keyword">function</span> onUpdate(numFriends) {
      <span class="keyword">function</span> notifyParent(numFriends) {
        <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage({
          <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;window_close&#39;</span>,
          <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <span class="stringliteral">&#39;&#39;</span>,
          <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>: cancelled ? <span class="stringliteral">&#39;&#39;</span> : <a class="code" href="../../d6/d52/js_2browser_8js.html#a6e69a5af94d7d53886e51f89fb3bd6b4">_</a>(<span class="stringliteral">&#39;friendsUpdated&#39;</span>, {
            numFriends: numFriends
          })
        }, targetApp);
      }

      <span class="comment">// If the service requires to do the logout it is done</span>
      serviceLogout(notifyLogout);

      <span class="keywordflow">if</span> (Importer.getContext() === <span class="stringliteral">&#39;ftu&#39;</span>) {
        <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.hide(<span class="keyword">function</span> onhide() {
          notifyParent(numFriends);
        });
      } <span class="keywordflow">else</span> {
        <a class="code" href="../../d2/d7d/jsapi_8h.html#a8a4058d98ae1bca3d5fa2d01726cf734">parent</a>.postMessage({
          <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;import_updated&#39;</span>,
          <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a>: <span class="stringliteral">&#39;&#39;</span>
        }, targetApp);

        <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.addEventListener(<span class="stringliteral">&#39;message&#39;</span>, <span class="keyword">function</span> finished(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
          <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.origin !== targetApp) {
            <span class="keywordflow">return</span>;
          }
          <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.data.type === <span class="stringliteral">&#39;contacts_loaded&#39;</span>) {
            <span class="comment">// When the list of contacts is loaded and it&#39;s the current view</span>
            <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.hide(<span class="keyword">function</span> onhide() {
              <span class="comment">// Please close me and display the number of friends updated</span>
              notifyParent(numFriends);
            });
            <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.removeEventListener(<span class="stringliteral">&#39;message&#39;</span>, finished);
          }
        });
      }
    }

    <span class="keyword">function</span> cleanContacts(<a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>, progress) {
      <span class="keywordflow">if</span> (cancelled) {
        <span class="keywordflow">return</span>;
      }

      var <a class="code" href="../../db/d4e/contacts__matcher_8js.html#a9c02ff135182792b8b5b9cf246a368e8">contacts</a> = [];
      var unSelectedKeys = Object.keys(unSelectedContacts);
      <span class="comment">// ContactsCleaner expects an Array object</span>
      unSelectedKeys.forEach(<span class="keyword">function</span> iterator(uid) {
        var deviceContacts = unSelectedContacts[uid];
        <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; deviceContacts.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
          contacts.push(deviceContacts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]);
        }
      });

      <span class="comment">// To optimize if the user wishes to unselect all</span>
      var <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a> = <span class="stringliteral">&#39;update&#39;</span>;
      <span class="keywordflow">if</span> (unSelectedKeys.length === existingContacts.length &amp;&amp;
          Object.keys(selectedContacts).length === 0) {
        mode = <span class="stringliteral">&#39;clear&#39;</span>;
        <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.hideMenu(); <span class="comment">// User cannot cancel cleaning all the friends</span>
      }

      serviceConnector.cleanContacts(contacts, mode,
          <span class="keyword">function</span> gotCleaner(cleaner) {
            <span class="keywordflow">if</span> (cleaner) {
              theCleaner = cleaner;
              ongoingClean = <span class="keyword">true</span>;
              cleaner.oncleaned = progress.update;
              cleaner.onsuccess = <span class="keyword">function</span>() {
                ongoingClean = <span class="keyword">false</span>;
                theCleaner = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
                <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a845d7a743d9d72d08f80a15338dd1099">onsuccess</a>();
              };
            }
            <span class="keywordflow">else</span> {
              Importer.errorHandler();
            }
      });
    } <span class="comment">// clean</span>

    <span class="keyword">function</span> getTotalUnselected() {
      var <a class="code" href="../../da/ddf/ns_i_d_o_m_progress_event_8idl.html#ac3db248c35e11a75b4e99f0087d77c90">total</a> = 0;

      Object.keys(unSelectedContacts).forEach(<span class="keyword">function</span> surfing(uid) {
        total = total + unSelectedContacts[uid].length;
      });

      <span class="keywordflow">return</span> <a class="code" href="../../da/ddf/ns_i_d_o_m_progress_event_8idl.html#ac3db248c35e11a75b4e99f0087d77c90">total</a>;
    }

    UI.importAll = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
      var selected = Object.keys(selectedContacts).length;
      var unSelected = getTotalUnselected();
      var total = selected + unSelected;

      cancelled = <span class="keyword">false</span>;
      <span class="keywordflow">if</span> (selected &gt; 0) {
        var progress = <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.show(<span class="stringliteral">&#39;progress&#39;</span>, <span class="stringliteral">&#39;import&#39;</span>);
        progress.setTotal(total);

        <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.oncancel = cancelImport;
        Importer.importAll(<span class="keyword">function</span> on_all_imported(totalImported) {
          <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> serviceConnector.oncontactsimported === <span class="stringliteral">&#39;function&#39;</span>) {
            <span class="comment">// Check whether we need to set the last update and schedule next</span>
            <span class="comment">// sync. Only in that case otherwise that will be done by the sync</span>
            <span class="comment">// process</span>
            serviceConnector.oncontactsimported(existingContacts,
                                                friendsImported, <span class="keyword">function</span>() {
              friendsImported = <span class="keyword">true</span>;
            });
          }
          <span class="keywordflow">if</span> (!cancelled &amp;&amp; unSelected &gt; 0) {
            progress.setFrom(<span class="stringliteral">&#39;update&#39;</span>);
            cleanContacts(<span class="keyword">function</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>() {
              onUpdate(progress.getValue());
            }, progress);
          } <span class="keywordflow">else</span> {
            onUpdate(progress.getValue());
          }
        }, progress);
      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (unSelected &gt; 0) {
        var progress = <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.show(<span class="stringliteral">&#39;progress&#39;</span>, <span class="stringliteral">&#39;update&#39;</span>);
        progress.setTotal(total);
        <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.oncancel = cancelImport;
        cleanContacts(<span class="keyword">function</span> <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>() {
          onUpdate(progress.getValue());
        }, progress);
      }
    };

    UI.selectAll = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
      deSelectAllButton.disabled = <span class="keyword">false</span>;
      selectAllButton.disabled = <span class="keyword">true</span>;

      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(<span class="keyword">function</span> doSelectAll() {
        bulkSelection(<span class="keyword">true</span>);

        unSelectedContacts = {};
        selectedContacts = {};

        <span class="keywordflow">for</span> (var uid in selectableFriends) {
          selectedContacts[uid] = selectableFriends[uid];
        }

        checkUpdateButton();
      }, 0);

      <span class="keywordflow">return</span> <span class="keyword">false</span>;
    };

    UI.unSelectAll = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>)  {
      deSelectAllButton.disabled = <span class="keyword">true</span>;
      selectAllButton.disabled = <span class="keyword">false</span>;

      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(<span class="keyword">function</span> doUnSelectAll() {
        bulkSelection(<span class="keyword">false</span>);

        selectedContacts = {};
        unSelectedContacts = {};
        <span class="keywordflow">for</span> (var uid in existingContactsByUid) {
          unSelectedContacts[uid] = existingContactsByUid[uid];
        }

        checkUpdateButton();
      }, 0);

      <span class="keywordflow">return</span> <span class="keyword">false</span>;
    };

    <span class="keyword">function</span> clearList() {
      var <span class="keyword">template</span> = contactList.querySelector(<span class="stringliteral">&#39;[data-template]&#39;</span>);

      <a class="code" href="../../d0/df4/contacts__shortcuts_8js.html#a7b58b8887c6d26e09f79fbacfbda7f53">utils</a>.dom.removeChildNodes(contactList);
      contactList.appendChild(<span class="keyword">template</span>);
    }

    <span class="keyword">function</span> bulkSelection(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>) {
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(<span class="keyword">function</span>() {
        doSelect(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>, checkNodeList, 0, 10);
      }, 0);
    }

    <span class="keyword">function</span> doSelect(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>, <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, from, chunkSize) {
      var total = <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>.length;

      <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a> = from; <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a> &lt; from + chunkSize &amp;&amp; <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a> &lt; <a class="code" href="../../da/ddf/ns_i_d_o_m_progress_event_8idl.html#ac3db248c35e11a75b4e99f0087d77c90">total</a>; <a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>++) {
        setChecked(<a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a8a080bd96df5681d77f59f96dc5da089">j</a>], <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>);
      }

      var leftInterval = from + chunkSize;
      var rightInterval = leftInterval + chunkSize &lt; total ?
                                              leftInterval + chunkSize : <a class="code" href="../../da/ddf/ns_i_d_o_m_progress_event_8idl.html#ac3db248c35e11a75b4e99f0087d77c90">total</a>;

      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(<span class="keyword">function</span>() {
        doSelect(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>, <a class="code" href="../../d3/d87/mock__contact_8js.html#ad08d759db77b6861afcb4729fc620b95">list</a>, leftInterval, rightInterval);
      }, 0);
    }

    UI.selection = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
      var out = <span class="keyword">false</span>;
      var target = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.target;

      <span class="keywordflow">if</span> (target &amp;&amp; target.dataset.uuid) {
        var <a class="code" href="../../d1/d9a/local__test_8js.html#a80846c081aa1e744a86338db64eaa889">uuid</a> = target.dataset.uuid;

        var checkbox = target.querySelector(<span class="stringliteral">&#39;input[type=&quot;checkbox&quot;]&#39;</span>);
        setChecked(checkbox, !checkbox.checked);

        <span class="keywordflow">if</span> (checkbox.checked === <span class="keyword">true</span>) {
          <span class="keywordflow">if</span> (unSelectedContacts[uuid]) {
            <span class="keyword">delete</span> unSelectedContacts[<a class="code" href="../../d1/d9a/local__test_8js.html#a80846c081aa1e744a86338db64eaa889">uuid</a>];
          } <span class="keywordflow">else</span> {
            selectedContacts[<a class="code" href="../../d1/d9a/local__test_8js.html#a80846c081aa1e744a86338db64eaa889">uuid</a>] = myFriendsByUid[<a class="code" href="../../d1/d9a/local__test_8js.html#a80846c081aa1e744a86338db64eaa889">uuid</a>];
          }
        } <span class="keywordflow">else</span> {
          <span class="keyword">delete</span> selectedContacts[<a class="code" href="../../d1/d9a/local__test_8js.html#a80846c081aa1e744a86338db64eaa889">uuid</a>];
          <span class="comment">// If this was an already imported friend it is added to unselect</span>
          <span class="keywordflow">if</span> (existingContactsByUid[uuid]) {
            unSelectedContacts[<a class="code" href="../../d1/d9a/local__test_8js.html#a80846c081aa1e744a86338db64eaa889">uuid</a>] = existingContactsByUid[<a class="code" href="../../d1/d9a/local__test_8js.html#a80846c081aa1e744a86338db64eaa889">uuid</a>];
          }
        }

        checkDisabledButtons();

        out = <span class="keyword">true</span>;
      }

      <span class="keywordflow">return</span> <a class="code" href="../../db/da2/namespacejs.html#ae38c69c83e560d6765bddb6b3d53cc46">out</a>;
    };

    Importer.getContext = <span class="keyword">function</span>() {
      var out = <span class="stringliteral">&#39;contacts&#39;</span>;

      <span class="keywordflow">if</span> (<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.location.search.indexOf(<span class="stringliteral">&#39;ftu&#39;</span>) !== -1) {
        out = <span class="stringliteral">&#39;ftu&#39;</span>;
      }

      <span class="keywordflow">return</span> <a class="code" href="../../db/da2/namespacejs.html#ae38c69c83e560d6765bddb6b3d53cc46">out</a>;
    };

    <span class="comment">// Release objects for improving memory management</span>
    <span class="keyword">function</span> releaseObjs(cfdata) {
      <span class="keywordflow">if</span> (!cfdata) {
        <span class="keywordflow">return</span>;
      }

      <span class="comment">// Once a Friend has been persisted the data is no longer needed</span>
      selectedContacts[cfdata.uid] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
      myFriendsByUid[cfdata.uid] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
      selectableFriends[cfdata.uid] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
      myFriends[cfdata._idxFriendsArray] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
      <span class="keywordflow">if</span> (cfdata.fbInfo &amp;&amp; Array.isArray(cfdata.fbInfo.photo)) {
        cfdata.fbInfo.photo = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
      }
    }

    <span class="keyword">function</span> doImportAll(importedCB, progress) {
      <span class="keywordflow">if</span> (cancelled) {
        <span class="keywordflow">return</span>;
      }

      checkNodeList = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
      var toBeImported = Object.keys(selectedContacts);
      var numFriends = toBeImported.length;

      theImporter = serviceConnector.getImporter(selectedContacts,
                                                   access_token);
      var cpuLock, <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a326e14cd5b2b5f6ed9147be47c83e7bb">screenLock</a>;

      theImporter.oncontactimported = <span class="keyword">function</span>(cfdata) {
        releaseObjs(cfdata);
        progress.update();
      };

      theImporter.onsuccess = <span class="keyword">function</span>(totalImported) {
        ongoingImport = <span class="keyword">false</span>;
        <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setTimeout(<span class="keyword">function</span> imported() {
          <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.importUtils.setTimestamp(serviceConnector.name);
          importedCB(totalImported);
        }, 0);

        <span class="keywordflow">if</span> (cpuLock) {
          cpuLock.unlock();
        }

        <span class="keywordflow">if</span> (screenLock) {
          screenLock.unlock();
        }
      };

      cpuLock = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.requestWakeLock(<span class="stringliteral">&#39;cpu&#39;</span>);
      screenLock = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.requestWakeLock(<span class="stringliteral">&#39;screen&#39;</span>);
      <span class="comment">// Release the DOM these objects will no longer be needed</span>
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>.querySelector(<span class="stringliteral">&#39;#groups-list&#39;</span>).innerHTML = <span class="stringliteral">&#39;&#39;</span>;

      ongoingImport = <span class="keyword">true</span>;
      theImporter.start();
    }

    Importer.importAll = <span class="keyword">function</span>(importedCB, progress) {
      <span class="keywordflow">if</span> (isOnLine === <span class="keyword">true</span>) {
        doImportAll(importedCB, progress);
      }
      <span class="keywordflow">else</span> {
        <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.console.warn(<span class="stringliteral">&#39;User is not online!!&#39;</span>);
        showOfflineDialog(<span class="keyword">function</span>() {
          doImportAll(importedCB, progress);
        }, <span class="keyword">function</span>() {
          <a class="code" href="../../d1/d20/curtain_8js.html#aef52eeb3e521f64e99c0321d21640d81">Curtain</a>.hide();
          UI.end();
        });
      }
    };

  })(<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#af61dbe660d8213297c7fed5b5c99d223">document</a>);
}
</pre></div>
<p><div class="dynheader">
関数の呼び出しグラフ:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d5/dc5/importer__ui_8js_a98dcc506f33c3ed40141a5ba86222b34_cgraph.svg" width="278" height="144"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<hr/><h2>変数</h2>
<a class="anchor" id="ae2475e10618961c050dcba04e8c42331"></a><!-- doxytag: member="importer_ui.js::strict" ref="ae2475e10618961c050dcba04e8c42331" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d7/d1b/test-agent-server_8js.html#aab71dcc804ca4aa3ed2bf7ba887635db">use</a> <a class="el" href="../../de/dc5/jsfriendapi_8h.html#a8cddd7ed2617ebace48da2e8e44f267c">strict</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p> <a class="el" href="../../d5/dc5/importer__ui_8js_source.html">importer_ui.js</a> の <a class="el" href="../../d5/dc5/importer__ui_8js_source.html#l00001">1</a> 行で定義されています。</p>

</div>
</div>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d5/dc5/importer__ui_8js.html">importer_ui.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:56:08に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
