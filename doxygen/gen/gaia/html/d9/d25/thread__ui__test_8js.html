<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: thread_ui_test.js</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d9/d25/thread__ui__test_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">関数</a> &#124;
<a href="#var-members">変数</a>  </div>
  <div class="headertitle">
<div class="title">thread_ui_test.js</div>  </div>
</div><!--header-->
<div class="contents">

<p><a href="../../d9/d25/thread__ui__test_8js_source.html">ソースコードを見る。</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
関数</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">mocha&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#ab7e7367b81ab63a354718673d5d5cc70">setup</a> ({globals:['<a class="el" href="../../df/d49/system_2camera_2js_2camera_8js.html#a91dfa6843538cd55b524a76b1afc329c">alert</a>']})</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#a65606686b3891822d17e1e523983fe07">if</a> (!navigator.mozContacts)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#a5c541e3fe82db794e8961f36db25f466">requireApp</a> ('sms/js/compose.js')</td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#aebcc27c0d7c71338b1ecc8fcf07e85c7">mocksHelperForThreadUI</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#abc9cc966c63f6f16f23498d36a91bc4f">init</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#af01bd6be3c63f2716a185f195d101f34">suite</a> ('thread_ui.js &gt;', <a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(){var <a class="el" href="../../d2/d7d/jsapi_8h.html#a8908b6d42ac95ee6387e73b7ac543dae">input</a>;var <a class="el" href="../../d3/d4b/lockscreen_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>;var sendButton;var composeForm;var recipient;var <a class="el" href="../../d9/dac/apps_2costcontrol_2test_2unit_2startup__test_8js.html#abdff2ecb3bab4f68645e0a4bada3ea4a">realMozL10n</a>;var realMozMobileMessage;var <a class="el" href="../../d9/d7f/compose__test_8js.html#a0febeec624e264448191b704321c7df1">mocksHelper</a>=<a class="el" href="../../d9/d25/thread__ui__test_8js.html#aebcc27c0d7c71338b1ecc8fcf07e85c7">mocksHelperForThreadUI</a>;var testImageBlob;var oversizedImageBlob;var testAudioBlob;var testVideoBlob;<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> mockAttachment(<a class="el" href="../../d0/da8/prrng_8h.html#a5c72e4e1ff78177bac89e7f0ddadda92">size</a>){<a class="el" href="../../d5/dff/tests_2python_2gaia-ui-tests_2gaiatest_2atoms_2screenshot_8js.html#a6bc243e0e988691de46b9baa46ec6413">return</a> new <a class="el" href="../../d2/d81/mock__attachment_8js.html#a2d551682f84186338b0fc2212832f508">MockAttachment</a>({type: 'video/ogg', size:size}, 'video.ogv');}<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> mockImgAttachment(isOversized){var attachment=isOversized?new <a class="el" href="../../d2/d81/mock__attachment_8js.html#a2d551682f84186338b0fc2212832f508">MockAttachment</a>(oversizedImageBlob, 'testOversized.jpg'):new <a class="el" href="../../d2/d81/mock__attachment_8js.html#a2d551682f84186338b0fc2212832f508">MockAttachment</a>(testImageBlob, 'test.jpg');<a class="el" href="../../d5/dff/tests_2python_2gaia-ui-tests_2gaiatest_2atoms_2screenshot_8js.html#a6bc243e0e988691de46b9baa46ec6413">return</a> attachment;}suiteSetup(<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(<a class="el" href="../../de/dc7/share-receiver_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>){<a class="el" href="../../df/d6d/prpdce_8h.html#a244bf4809fa769d3064852f1f46df24f">this.timeout</a>(5000);mocksHelper.suiteSetup();<a class="el" href="../../d9/dac/apps_2costcontrol_2test_2unit_2startup__test_8js.html#abdff2ecb3bab4f68645e0a4bada3ea4a">realMozL10n</a>=<a class="el" href="../../df/dc7/viewer_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">navigator.mozL10n</a>;<a class="el" href="../../df/dc7/viewer_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">navigator.mozL10n</a>=<a class="el" href="../../dd/daf/system_2test_2unit_2mock__l10n_8js.html#af9a9d6d42b9a7f8153f63783711f14c3">MockL10n</a>;var assetsNeeded=0;<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> getAsset(<a class="el" href="../../de/d8f/jsdebug_8h.html#abc8430424b9e64b65bfdb1fbeeccc2d3">filename</a>, loadCallback){assetsNeeded++;var <a class="el" href="../../df/d49/system_2camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a>=new <a class="el" href="../../d9/d0a/class_x_m_l_http_request.html">XMLHttpRequest</a>();<a class="el" href="../../da/d84/openvideo_8js.html#a2a6896c38bfcbba014743ee706623b5d">req.open</a>('GET', <a class="el" href="../../de/d8f/jsdebug_8h.html#abc8430424b9e64b65bfdb1fbeeccc2d3">filename</a>, <a class="el" href="../../df/d49/system_2camera_2js_2camera_8js.html#a930920b2bc42824a5c03be681830f4b2">true</a>);<a class="el" href="../../da/d84/openvideo_8js.html#a8b7a06aa82f250a1a94bc34147a67087">req.responseType</a>= 'blob';<a class="el" href="../../de/dea/uitest_8js.html#a43397fd3516cd230995b3edbbadff48b">req.onload</a>=<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(){loadCallback(req.response);<a class="el" href="../../de/dfc/events_8js.html#aa27c1f7f883859f374ef91e69db597bd">if</a>(--assetsNeeded===0){<a class="el" href="../../de/dc7/share-receiver_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();}};<a class="el" href="../../da/d84/openvideo_8js.html#a169d077acddcf947878a89b1702afaae">req.send</a>();}getAsset('/<a class="el" href="../../d2/dc5/homescreen__launcher__test_8js.html#ae39af8ac48077b957ecb9fe16f678936">test</a>/unit/<a class="el" href="../../df/d49/system_2camera_2js_2camera_8js.html#a82e064dd4291d3ea98e766c27a3b80f0">media</a>/kitten-450.jpg', <a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(blob){testImageBlob=blob;});getAsset('/<a class="el" href="../../d2/dc5/homescreen__launcher__test_8js.html#ae39af8ac48077b957ecb9fe16f678936">test</a>/unit/<a class="el" href="../../df/d49/system_2camera_2js_2camera_8js.html#a82e064dd4291d3ea98e766c27a3b80f0">media</a>/IMG_0554.jpg', <a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(blob){oversizedImageBlob=blob;});getAsset('/<a class="el" href="../../d2/dc5/homescreen__launcher__test_8js.html#ae39af8ac48077b957ecb9fe16f678936">test</a>/unit/<a class="el" href="../../df/d49/system_2camera_2js_2camera_8js.html#a82e064dd4291d3ea98e766c27a3b80f0">media</a>/audio.oga', <a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(blob){testAudioBlob=blob;});getAsset('/<a class="el" href="../../d2/dc5/homescreen__launcher__test_8js.html#ae39af8ac48077b957ecb9fe16f678936">test</a>/unit/<a class="el" href="../../df/d49/system_2camera_2js_2camera_8js.html#a82e064dd4291d3ea98e766c27a3b80f0">media</a>/video.ogv', <a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(blob){testVideoBlob=blob;});});suiteTeardown(<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(){<a class="el" href="../../df/dc7/viewer_8js.html#abf8c988c23b2b2f5ec3f1149b44bd820">navigator.mozL10n</a>=<a class="el" href="../../d9/dac/apps_2costcontrol_2test_2unit_2startup__test_8js.html#abdff2ecb3bab4f68645e0a4bada3ea4a">realMozL10n</a>;mocksHelper.suiteTeardown();});<a class="el" href="../../da/db6/ime__test_8js.html#a499aeb7e1826da3a383e443025bfc846">setup</a>(<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(){<a class="el" href="../../da/db6/ime__test_8js.html#a499aeb7e1826da3a383e443025bfc846">mocksHelper.setup</a>();loadBodyHTML('/index.html');<a class="el" href="../../d2/d7d/jsapi_8h.html#a8908b6d42ac95ee6387e73b7ac543dae">input</a>=<a class="el" href="../../d4/d8c/viewphoto_8js.html#a6d08c5d82e2ca7c6042afb9f8ae078c1">document.getElementById</a>('messages-<a class="el" href="../../d2/d7d/jsapi_8h.html#a8908b6d42ac95ee6387e73b7ac543dae">input</a>');<a class="el" href="../../d3/d4b/lockscreen_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>=<a class="el" href="../../d4/d8c/viewphoto_8js.html#a6d08c5d82e2ca7c6042afb9f8ae078c1">document.getElementById</a>('messages-<a class="el" href="../../d3/d4b/lockscreen_8js.html#a88e6efb757b9907baa46a5755484f2bd">container</a>');sendButton=<a class="el" href="../../d4/d8c/viewphoto_8js.html#a6d08c5d82e2ca7c6042afb9f8ae078c1">document.getElementById</a>('messages-<a class="el" href="../../da/d84/openvideo_8js.html#a169d077acddcf947878a89b1702afaae">send</a>-<a class="el" href="../../d3/d4b/lockscreen_8js.html#a56a6742e738e925221d41ea45da5851d">button</a>');composeForm=<a class="el" href="../../d4/d8c/viewphoto_8js.html#a6d08c5d82e2ca7c6042afb9f8ae078c1">document.getElementById</a>('messages-compose-form');this.sinon.useFakeTimers();ThreadUI.recipients=<a class="el" href="../../d3/d52/blanket_8js.html#a24d794dfc756320ffadb905d526299bc">null</a>;<a class="el" href="../../d5/d0d/pay_8js.html#af619d0ad365b66772212901ccd40466c">ThreadUI.init</a>();realMozMobileMessage=ThreadUI._mozMobileMessage;ThreadUI._mozMobileMessage=<a class="el" href="../../dc/d25/mock__navigatormoz__sms_8js.html#a9a87647c2d70008b5633cfef1aaaa25e">MockNavigatormozMobileMessage</a>;});teardown(<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(){<a class="el" href="../../d1/d04/app__install__manager_8js.html#acd145aedb51101ac15a526f73673b0b9">document.body.innerHTML</a>= '';<a class="el" href="../../d7/d13/mock__updatable_8js.html#a3d0fcb481c5d651d1f7a83fa7896504d">MockNavigatormozMobileMessage.mTeardown</a>();mocksHelper.teardown();ThreadUI._mozMobileMessage=realMozMobileMessage;});<a class="el" href="../../d8/d0f/startup__events__test_8js.html#adac6c636af235a329cc774937d75601b">suite</a>('scrolling', <a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(){teardown(<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(){<a class="el" href="../../d1/d04/app__install__manager_8js.html#acd145aedb51101ac15a526f73673b0b9">container.innerHTML</a>= '';});<a class="el" href="../../da/db6/ime__test_8js.html#a499aeb7e1826da3a383e443025bfc846">setup</a>(<a class="el" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a>(){container.style.overflow= 'scroll';<a class="el" href="../../d8/dd4/ns_c_s_s_prop_list_8h.html#a99ef05b40c29af68ac3026a597233269">container.style.height</a>= '50px';var innerHTML= '';for(var i=0;i&lt; 99;i++){innerHTML+=ThreadUI.tmpl.message.interpolate({id:String(i), bodyHTML: 'test#'+i});}container.innerHTML=innerHTML;container.lastElementChild.style.paddingBottom= '16px';});test('scroll 100px, should be detected as a manual scroll', function(done){container.addEventListener('scroll', function onscroll(){container.removeEventListener('scroll', onscroll);assert.ok(ThreadUI.isScrolledManually);done();});container.scrollTop=100;});test('scroll to bottom, should be detected as an automatic scroll', function(done){container.addEventListener('scroll', function onscroll(){container.removeEventListener('scroll', onscroll);assert.isFalse(ThreadUI.isScrolledManually);assert.ok((container.scrollTop+container.clientHeight)==container.scrollHeight);done();});ThreadUI.isScrolledManually=false;ThreadUI.scrollViewToBottom();});});suite('Search', function(){test('search results cleared', function(){Compose.clear();Compose.append('foo');ThreadUI.cleanFields(true);assert.equal(Compose.getContent(), '');});});suite('enableSend() &gt;', function(){setup(function(){Compose.clear();ThreadUI.updateCounter();window.location.hash= '#thread-1';});teardown(function(){Compose.clear();window.location.hash= '';});suite('Thread View', function(){setup(function(){window.location.hash= '#thread-1';});teardown(function(){window.location.hash= '';});test('button should be disabled at the beginning', function(){Compose.clear();assert.isTrue(sendButton.disabled);});test('button should be enabled when there is some text', function(){Compose.append('Hola');assert.isFalse(sendButton.disabled);});test('button should not be disabled if there is some text '+ 'but too many segments', function(){Compose.append('Hola');this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);var segmentInfo={segments:11, charsAvailableInLastSegment:10};MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(sendButton.disabled);});});suite('#new mode &gt;', function(){setup(function(){window.location.hash= '#new';Compose.clear();ThreadUI.recipients.length=0;ThreadUI.recipients.inputValue= '';});teardown(function(){window.location.hash= '';Compose.clear();ThreadUI.recipients.length=0;ThreadUI.recipients.inputValue= '';});test('button should be disabled when there is neither contact or input', function(){assert.isTrue(sendButton.disabled);});test('button should be disabled when there is no contact', function(){Compose.append('Hola');assert.isTrue(sendButton.disabled);});test('button should be enabled with recipient input', function(){Compose.append('Hola');ThreadUI.recipients.inputValue= '999';ThreadUI.enableSend();assert.isFalse(sendButton.disabled);});test('button should be enabled after adding a recipient when text exists', function(){Compose.append('Hola');ThreadUI.recipients.add({number: '999'});assert.isFalse(sendButton.disabled);});test('button should be enabled after adding text when recipient exists', function(){ThreadUI.recipients.add({number: '999'});Compose.append('Hola');assert.isFalse(sendButton.disabled);});test('button should be disabled when there is both contact and '+ 'input, but too much data to send as mms', function(){ThreadUI.recipients.add({number: '999'});Compose.append(mockAttachment(300 *1024));assert.isFalse(sendButton.disabled);Compose.append('Hola');assert.isTrue(sendButton.disabled);});test('When adding an image that is under the limitation, button '+ 'should be enabled right after appended', function(){ThreadUI.recipients.add({number: '999'});Compose.append(mockImgAttachment());assert.isFalse(sendButton.disabled);});test('When adding an oversized image, button should be disabled while '+ 'resizing and enabled when resize complete', function(done){ThreadUI.recipients.add({number: '999'});function onInput(){if(!Compose.isResizing){Compose.off('input', onInput);assert.isFalse(sendButton.disabled);done();}};Compose.on('input', onInput);Compose.append(mockImgAttachment(true));assert.isTrue(sendButton.disabled);});});});suite('updateCounter() &gt;', function(){var banner, convertBanner, shouldEnableSend, form, localize;setup(function(){banner=document.getElementById('messages-max-length-notice');convertBanner=document.getElementById('messages-convert-notice');form=document.getElementById('messages-compose-form');localize=this.sinon.spy(navigator.mozL10n, 'localize');this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);MockNavigatormozMobileMessage.mTeardown();});function updateCounter(segmentInfo){banner.classList.remove('hide');Compose.lock=true;shouldEnableSend=ThreadUI.updateCounter();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);}var initialText= 'some text';var followingText= 'some other text';test('do not call getSegmentInfoForText twice in a row', function(){var spy=this.sinon.spy(MockNavigatormozMobileMessage, 'getSegmentInfoForText');Compose.append(initialText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY/2);Compose.append(followingText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);assert.equal(spy.callCount, 1);assert.ok(spy.calledWith(initialText+followingText));});test('getSegmentInfoForText error hides the counter', function(){sendButton.classList.add('has-counter');Compose.append(initialText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);MockNavigatormozMobileMessage.mTriggerSegmentInfoError();assert.isFalse(sendButton.classList.contains('has-counter'));});suite('asynchronous tricky tests &gt;', function(){var spy;var segmentInfo1={segments:1, charsAvailableInLastSegment:50};var segmentInfo2={segments:1, charsAvailableInLastSegment:40};setup(function(){spy=this.sinon.spy(MockNavigatormozMobileMessage, 'getSegmentInfoForText');Compose.append(initialText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);Compose.append(followingText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);});teardown(function(){Compose.clear();});test('getSegmentInfoForText got called twice', function(){assert.equal(spy.callCount, 2);assert.ok(spy.getCall(0).calledWith(initialText));assert.ok(spy.getCall(1).calledWith(initialText+followingText));});test('segment info requests return ordered', function(){MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo1, 0);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo2, 0);var subject=sendButton.dataset.counter;var expected=segmentInfo2.charsAvailableInLastSegment+ '/'+segmentInfo2.segments;assert.equal(subject, expected);});test('2 segment info requests return unordered', function(){MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo2, 1);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo1, 0);var subject=sendButton.dataset.counter;var expected=segmentInfo1.charsAvailableInLastSegment+ '/'+segmentInfo1.segments;assert.equal(subject, expected);});});suite('type changed after the first segment info request &gt;', function(){setup(function(){Compose.type= 'sms';ThreadUI.updateCounter();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);Compose.type= 'mms';var segmentInfo={segments:0, charsAvailableInLastSegment:0};MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);});teardown(function(){Compose.type= 'sms';});test('should not change the segment info', function(){assert.ok(sendButton.classList.contains('has-counter'));});});suite('no characters entered &gt;', function(){setup(function(){var segmentInfo={segments:0, charsAvailableInLastSegment:0};updateCounter.call(this, segmentInfo);});test('no counter is displayed', function(){assert.isFalse(sendButton.classList.contains('has-counter'));});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in first segment &gt;', function(){setup(function(){var segmentInfo={segments:1, charsAvailableInLastSegment:20};updateCounter.call(this, segmentInfo);});test('no counter is displayed', function(){assert.isFalse(sendButton.classList.contains('has-counter'));});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in first segment, less than 10 chars left &gt;', function(){var segment=1, availableChars=10;setup(function(){var segmentInfo={segments:segment, charsAvailableInLastSegment:availableChars};updateCounter.call(this, segmentInfo);});test('a counter is displayed', function(){var expected=availableChars+ '/'+segment;assert.equal(sendButton.dataset.counter, expected);});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in second segment &gt;', function(){var segment=2, availableChars=20;setup(function(){var segmentInfo={segments:segment, charsAvailableInLastSegment:availableChars};updateCounter.call(this, segmentInfo);});test('a counter is displayed', function(){var expected=availableChars+ '/'+segment;assert.equal(sendButton.dataset.counter, expected);});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in last segment &gt;', function(){var segment=10, availableChars=20;setup(function(){var segmentInfo={segments:segment, charsAvailableInLastSegment:availableChars};updateCounter.call(this, segmentInfo);});test('a counter is displayed', function(){var expected=availableChars+ '/'+segment;assert.equal(sendButton.dataset.counter, expected);});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in last segment, no characters left &gt;', function(){var segment=10, availableChars=0;setup(function(){var segmentInfo={segments:segment, charsAvailableInLastSegment:availableChars};updateCounter.call(this, segmentInfo);});test('a counter is displayed', function(){var expected=availableChars+ '/'+segment;assert.equal(sendButton.dataset.counter, expected);});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('message type is sms', function(){assert.equal(form.dataset.messageType, 'sms');});test('lock is disabled', function(){assert.isFalse(Compose.lock);});});suite('too many segments &gt;', function(){var segmentInfo={segments:11, charsAvailableInLastSegment:25};setup(function(){updateCounter.call(this, segmentInfo);});test('message type is mms', function(){assert.equal(form.dataset.messageType, 'mms');});test('lock is disabled', function(){assert.isFalse(Compose.lock);});suite('trying to move back to sms &gt;', function(){setup(function(){this.sinon.clock.tick(5000);this.sinon.spy(MockNavigatormozMobileMessage, 'getSegmentInfoForText');Compose.type= 'sms';MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);});test('getSegmentInfoForText was called', function(){assert.ok(MockNavigatormozMobileMessage.getSegmentInfoForText.called);});test('message type is still mms', function(){assert.equal(Compose.type, 'mms');assert.equal(form.dataset.messageType, 'mms');});test('the convertion notice is not displayed', function(){assert.ok(convertBanner.classList.contains('hide'));});});});suite('at size limit in mms &gt;', function(){setup(function(){Settings.mmsSizeLimitation=1024;Compose.append(mockAttachment(512));Compose.append(mockAttachment(512));shouldEnableSend=ThreadUI.updateCounter();});teardown(function(){Compose.clear();});test('shouldEnableSend', function(){assert.isTrue(shouldEnableSend);});test('banner is displayed', function(){assert.isFalse(banner.classList.contains('hide'));});test('banner localized', function(){assert.ok(localize.calledWith(banner.querySelector('p'), 'messages-max-length-text'));});test('message type is mms', function(){assert.equal(form.dataset.messageType, 'mms');});test('lock is enabled', function(){assert.isTrue(Compose.lock);});});suite('over size limit in mms &gt;', function(){setup(function(){Settings.mmsSizeLimitation=1024;Compose.append(mockAttachment(512));Compose.append('sigh');Compose.append(mockAttachment(512));shouldEnableSend=ThreadUI.updateCounter();});teardown(function(){Compose.clear();});test('shouldEnableSend is false', function(){assert.isFalse(shouldEnableSend);});test('banner is displayed', function(){assert.isFalse(banner.classList.contains('hide'));});test('banner localized', function(){assert.ok(localize.calledWith(banner.querySelector('p'), 'messages-exceeded-length-text'));});test('message type is mms', function(){assert.equal(form.dataset.messageType, 'mms');});test('lock is enabled', function(){assert.isTrue(Compose.lock);});});});suite('message type conversion &gt;', function(){var convertBanner, convertBannerText, form, localize;setup(function(){convertBanner=document.getElementById('messages-convert-notice');convertBannerText=convertBanner.querySelector('p');form=document.getElementById('messages-compose-form');localize=this.sinon.spy(navigator.mozL10n, 'localize');});test('sms to mms and back displays banner', function(){Compose.type= 'mms';assert.isTrue(sendButton.classList.contains('has-counter'));assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for mms');assert.equal(composeForm.dataset.messageType, 'mms', 'the composer has type mms');assert.ok(localize.calledWith(convertBannerText, 'converted-to-mms'), 'conversion banner has mms message');localize.reset();this.sinon.clock.tick(2999);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for just shy of 3 seconds');this.sinon.clock.tick(1);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');Compose.type= 'sms';this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess();assert.isFalse(sendButton.classList.contains('has-counter'));assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for sms');assert.equal(composeForm.dataset.messageType, 'sms', 'the composer has type sms');assert.ok(localize.calledWith(convertBannerText, 'converted-to-sms'), 'conversion banner has sms message');this.sinon.clock.tick(2999);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for just shy of 3 seconds');this.sinon.clock.tick(1);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');});test('character limit from sms to mms and back displays banner', function(){ThreadUI.updateCounter();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);var segmentInfo={segments:11, charsAvailableInLastSegment:0};MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for mms');assert.equal(composeForm.dataset.messageType, 'mms', 'the composer has type mms');assert.ok(localize.calledWith(convertBannerText, 'converted-to-mms'), 'conversion banner has mms message');localize.reset();this.sinon.clock.tick(2999);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for just shy of 3 seconds');this.sinon.clock.tick(1);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');Compose.clear();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);segmentInfo.segments=0;MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for sms');assert.equal(composeForm.dataset.messageType, 'sms', 'the composer has type sms');assert.ok(localize.calledWith(convertBannerText, 'converted-to-sms'), 'conversion banner has sms message');localize.reset();this.sinon.clock.tick(2999);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for just shy of 3 seconds');this.sinon.clock.tick(1);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');});test('converting from sms to mms and back quickly', function(){ThreadUI.updateCounter();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);var segmentInfo={segments:11, charsAvailableInLastSegment:0};MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for mms');assert.ok(localize.calledWith(convertBannerText, 'converted-to-mms'), 'conversion banner has mms message');localize.reset();this.sinon.clock.tick(1500);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is still shown');Compose.clear();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);segmentInfo.segments=0;MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for sms');assert.ok(localize.calledWith(convertBannerText, 'converted-to-sms'), 'conversion banner has sms message');localize.reset();this.sinon.clock.tick(2000);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is still shown');this.sinon.clock.tick(1000);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');});test('we dont display the banner when cleaning fields', function(){Compose.type= 'mms';this.sinon.clock.tick(ThreadUI.CONVERTED_MESSAGE_DURATION);this.sinon.spy(Compose, 'clear');ThreadUI.cleanFields();MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess({segments:0, charsAvailableInLastSegment:0});assert.isTrue(Compose.clear.called);assert.isTrue(convertBanner.classList.contains('hide'));});});suite('Recipient Assimiliation', function(){setup(function(){this.sinon.spy(ThreadUI.recipients, 'visible');this.sinon.spy(ThreadUI.recipients, 'add');Threads.set(1,{participants:['999']});});teardown(function(){Threads.delete(1);window.location.hash= '';});suite('New Conversation', function(){var node;setup(function(){window.location.hash= '#new';node=document.createElement('span');node.isPlaceholder=true;node.textContent= '999';ThreadUI.recipientsList.appendChild(node);});teardown(function(){ThreadUI.recipientsList.removeChild(node);});test('Will assimilate recipients', function(){var visible, add;ThreadUI.assimilateRecipients();visible=ThreadUI.recipients.visible;add=ThreadUI.recipients.add;assert.ok(visible.called);assert.equal(visible.args[0][0], 'singleline');assert.ok(add.called);assert.deepEqual(add.args[0][0],{name: '999', number: '999', source: 'manual'});});});suite('Existing Conversation', function(){setup(function(){window.location.hash= '#thread=1';});test('Will not assimilate recipients ', function(){var visible, add;ThreadUI.assimilateRecipients();visible=ThreadUI.recipients.visible;add=ThreadUI.recipients.add;assert.isFalse(visible.called);assert.isFalse(add.called);});});});suite('message status update handlers &gt;', function(){suiteSetup(function(){this.fakeMessage={id:24601};});teardown(function(){document.body.removeChild(this.container);});setup(function(){this.container=document.createElement('div');this.container.id= 'message-'+this.fakeMessage.id;this.container.className= 'sending';this.container.innerHTML=ThreadUI.tmpl.message.interpolate({});document.body.appendChild(this.container);});suite('onMessageSent &gt;', function(){test('removes the&quot;sending&quot;class from the message element', function(){ThreadUI.onMessageSent(this.fakeMessage);assert.isFalse(this.container.classList.contains('sending'));});test('adds the&quot;sent&quot;class to the message element', function(){ThreadUI.onMessageSent(this.fakeMessage);assert.isTrue(this.container.classList.contains('sent'));});});suite('onMessageFailed &gt;', function(){suite('messages that were *not *previously in the&quot;error&quot;state &gt;', function(){test('removes the&quot;sending&quot;class from the message element', function(){ThreadUI.onMessageFailed(this.fakeMessage);assert.isFalse(this.container.classList.contains('sending'));});test('adds the&quot;error&quot;class to the message element', function(){ThreadUI.onMessageFailed(this.fakeMessage);assert.isTrue(this.container.classList.contains('error'));});});suite('messages that were previously in the&quot;error&quot;state &gt;', function(){setup(function(){this.container.classList.add('error');});test('does not remove the&quot;sending&quot;class to the message element', function(){ThreadUI.onMessageFailed(this.fakeMessage);assert.isTrue(this.container.classList.contains('sending'));});});suite('show error message when send message unsuccessfully', function(){setup(function(){MockDialog.mSetup();});teardown(function(){MockDialog.mTeardown();});test('show general error for no signal error', function(){ThreadUI.showSendMessageError('NoSignalError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show general error for not found error', function(){ThreadUI.showSendMessageError('NotFoundError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show general error for unknown error', function(){ThreadUI.showSendMessageError('UnknownError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show general error for internal error', function(){ThreadUI.showSendMessageError('InternalError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show general error for invalid address error', function(){ThreadUI.showSendMessageError('InvalidAddressError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show no SIM card', function(){ThreadUI.showSendMessageError('NoSimCardError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendNoSimCardTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendNoSimCardBody');});test('show air plane mode', function(){ThreadUI.showSendMessageError('RadioDisabledError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendAirplaneModeTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendAirplaneModeBody');});test('show FDN blockage error', function(){ThreadUI.showSendMessageError( 'FdnCheckError',['123', '456', '789']);assert.equal(MockDialog.calls[0].title.l10nId, 'fdnBlockedTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'fdnBlockedBody');});});});suite('onDeliverySuccess &gt;', function(){teardown(function(){this.fakeMessage.deliveryStatus=null;});test('sms delivery success', function(){this.fakeMessage.deliveryStatus= 'success';ThreadUI.onDeliverySuccess(this.fakeMessage);assert.isTrue(this.container.classList.contains('delivered'));});test('mms delivery success', function(){this.fakeMessage.deliveryStatus=['success'];ThreadUI.onDeliverySuccess(this.fakeMessage);assert.isTrue(this.container.classList.contains('delivered'));});test('multiple recipients mms delivery success', function(){this.fakeMessage.deliveryStatus=['success', 'success'];ThreadUI.onDeliverySuccess(this.fakeMessage);assert.isTrue(this.container.classList.contains('delivered'));});test('not all recipients return mms delivery success', function(){this.fakeMessage.deliveryStatus=['success', 'pending'];ThreadUI.onDeliverySuccess(this.fakeMessage);assert.isFalse(this.container.classList.contains('delivered'));});});});suite('removeMessageDOM', function(){setup(function(){ThreadUI.container.innerHTML= '&lt; h2 &gt;&lt;/h2 &gt;&lt; ul &gt;&lt; li &gt;&lt;/li &gt;&lt; li &gt;&lt;/li &gt;&lt;/ul &gt;';});teardown(function(){ThreadUI.container.innerHTML= '';});test('removeMessageDOM removes a child', function(){ThreadUI.removeMessageDOM(ThreadUI.container.querySelector('li'));assert.equal(ThreadUI.container.querySelectorAll('li').length, 1);});test('removeMessageDOM removes headers and ul', function(){ThreadUI.removeMessageDOM(ThreadUI.container.querySelector('li'));ThreadUI.removeMessageDOM(ThreadUI.container.querySelector('li'));assert.equal(ThreadUI.container.querySelectorAll('h2').length, 0);assert.equal(ThreadUI.container.querySelectorAll('ul').length, 0);});});suite('getMessageContainer &gt;', function(){var lastYear, yesterday, today;var fiveMinAgo, elevenMinAgo, oneHourAgo, oneHourFiveMinAgo;setup(function(){today=new Date(2013, 11, 31, 23, 59);this.sinon.clock.restore();this.sinon.useFakeTimers(+today);lastYear=new Date(2012, 11, 31);yesterday=new Date(2013, 11, 30, 12, 0);fiveMinAgo=new Date(2013, 11, 31, 23, 54);elevenMinAgo=new Date(2013, 11, 31, 23, 48);oneHourAgo=new Date(2013, 11, 31, 22, 59);oneHourFiveMinAgo=new Date(2013, 11, 31, 22, 54);});suite('last message block alone today &gt;', function(){var subject;setup(function(){subject=ThreadUI.getMessageContainer(+fiveMinAgo);});test('has both the date and the time', function(){var header=subject.previousElementSibling;assert.notEqual(header.dataset.timeOnly, 'true');});});suite('last message block with another block today &gt;', function(){var subject;setup(function(){ThreadUI.getMessageContainer(+elevenMinAgo);subject=ThreadUI.getMessageContainer(+fiveMinAgo);});test('has only the time', function(){assert.equal(subject.previousElementSibling.dataset.timeOnly, 'true');});});suite('2 recent messages, different days &gt;', function(){var firstContainer, secondContainer;setup(function(){firstContainer=ThreadUI.getMessageContainer(Date.now());this.sinon.clock.tick(5 *60 *1000);secondContainer=ThreadUI.getMessageContainer(Date.now());});test('different containers', function(){assert.notEqual(secondContainer, firstContainer);});test('second container has both the date and the time', function(){var secondHeader=secondContainer.previousElementSibling;assert.notEqual(secondHeader.dataset.timeOnly, 'true');});});suite('2 recent messages, same day, 15 minutes interval &gt;', function(){var firstContainer, secondContainer, firstTimestamp;setup(function(){this.sinon.clock.tick(15 *60 *1000);firstContainer=ThreadUI.getMessageContainer(Date.now());firstTimestamp=firstContainer.dataset.timestamp;this.sinon.clock.tick(15 *60 *1000);secondContainer=ThreadUI.getMessageContainer(Date.now());});test('different containers', function(){assert.notEqual(secondContainer, firstContainer);});test('has only the time', function(){var secondHeader=secondContainer.previousElementSibling;assert.equal(secondHeader.dataset.timeOnly, 'true');});test('first container has now a start-of-the-day timestamp', function(){assert.notEqual(firstContainer.dataset.timestamp, firstTimestamp);});});suite('insert one non-last-message block at the end &gt;', function(){var lastYearContainer, yesterdayContainer;setup(function(){lastYearContainer=ThreadUI.getMessageContainer(+lastYear);yesterdayContainer=ThreadUI.getMessageContainer(+yesterday);});test('should have 2 blocks', function(){assert.equal(ThreadUI.container.querySelectorAll('header').length, 2);assert.equal(ThreadUI.container.querySelectorAll('ul').length, 2);});test('should be in the correct order', function(){var containers=ThreadUI.container.querySelectorAll('ul');var expectedContainers=[lastYearContainer, yesterdayContainer];expectedContainers.forEach(function(container, index){assert.equal(container, containers[index]);});});});suite('insert one non-last-message block at the end of a 2-item list &gt;', function(){var lastYearContainer, yesterdayContainer, twoDaysAgoContainer;setup(function(){lastYearContainer=ThreadUI.getMessageContainer(+lastYear);var twoDaysAgo=new Date(2013, 11, 29);twoDaysAgoContainer=ThreadUI.getMessageContainer(+twoDaysAgo);yesterdayContainer=ThreadUI.getMessageContainer(+yesterday);});test('should have 3 blocks', function(){assert.equal(ThreadUI.container.querySelectorAll('header').length, 3);assert.equal(ThreadUI.container.querySelectorAll('ul').length, 3);});test('should be in the correct order', function(){var containers=ThreadUI.container.querySelectorAll('ul');var expectedContainers=[lastYearContainer, twoDaysAgoContainer, yesterdayContainer];expectedContainers.forEach(function(container, index){assert.equal(container, containers[index]);});});});suite('4 blocks suite &gt;', function(){var lastYearContainer, yesterdayContainer;var elevenMinContainer, fiveMinContainer;var oneHourContainer, oneHourFiveContainer;setup(function(){yesterdayContainer=ThreadUI.getMessageContainer(+yesterday);fiveMinContainer=ThreadUI.getMessageContainer(+fiveMinAgo);elevenMinContainer=ThreadUI.getMessageContainer(+elevenMinAgo);oneHourContainer=ThreadUI.getMessageContainer(+oneHourAgo);oneHourFiveContainer=ThreadUI.getMessageContainer(+oneHourFiveMinAgo);lastYearContainer=ThreadUI.getMessageContainer(+lastYear);});test('should have 4 blocks', function(){assert.equal(ThreadUI.container.querySelectorAll('header').length, 4);assert.equal(ThreadUI.container.querySelectorAll('ul').length, 4);});test('should be in the correct order', function(){var containers=ThreadUI.container.querySelectorAll('ul');var expectedContainers=[lastYearContainer, yesterdayContainer, elevenMinContainer, fiveMinContainer];expectedContainers.forEach(function(container, index){assert.equal(container, containers[index]);});});test('some containers are the same', function(){assert.equal(oneHourContainer, elevenMinContainer);assert.equal(oneHourFiveContainer, elevenMinContainer);});test('last message block should not show the date', function(){var header=fiveMinContainer.previousElementSibling;assert.equal(header.dataset.timeOnly, 'true');});test('adding a new message in the last message block', function(){var twoMinAgo=new Date(2013, 11, 31, 23, 57);var twoMinContainer=ThreadUI.getMessageContainer(+twoMinAgo);assert.equal(twoMinContainer, fiveMinContainer);});suite('adding a new message for yesterday &gt;', function(){var container;var oldHeaderTimestamp;setup(function(){var header=yesterdayContainer.previousElementSibling;oldHeaderTimestamp=header.dataset.time;var yesterdayEarlier=new Date(+yesterday);yesterdayEarlier.setHours(5, 5);container=ThreadUI.getMessageContainer(+yesterdayEarlier);});test('still 4 blocks', function(){assert.equal(ThreadUI.container.querySelectorAll('header').length, 4);});test('same container as the existing yesterday container', function(){assert.equal(container, yesterdayContainer);});test('the time header was updated', function(){var header=container.previousElementSibling;var headerTimestamp=header.dataset.time;assert.notEqual(headerTimestamp, oldHeaderTimestamp);});});});});suite('appendMessage removes old message', function(){setup(function(){this.targetMsg={id:23, type: 'sms', receivers:this.receivers, body: 'This is a test', delivery: 'error', timestamp:new Date()};ThreadUI.appendMessage(this.targetMsg);this.original=ThreadUI.container.querySelector( '[data-message-id=&quot;' + this.targetMsg.id + '&quot;]');ThreadUI.appendMessage(this.targetMsg);});test('original message removed when rendered a second time', function(){var message=ThreadUI.container.querySelector( '[data-message-id=&quot;' + this.targetMsg.id + '&quot;]');assert.notEqual(message, this.original);});});suite('buildMessageDOM &gt;', function(){setup(function(){this.sinon.spy(Template, 'escape');this.sinon.stub(MockSMIL, 'parse');});function buildSMS(payload){return MockMessages.sms({body:payload});}function buildMMS(payload){return MockMessages.mms({attachments:[new Blob([payload],{type: 'text/plain'})]});}test('escapes the body for SMS', function(){var payload= 'hello&lt; a href=&quot;world&quot;&gt;world&lt;/a &gt;';ThreadUI.buildMessageDOM(buildSMS(payload));assert.ok(Template.escape.calledWith(payload));});test('escapes all text for MMS', function(){var payload= 'hello&lt; a href=&quot;world&quot;&gt;world&lt;/a &gt;';MockSMIL.parse.yields([{text:payload}]);ThreadUI.buildMessageDOM(buildMMS(payload));assert.ok(Template.escape.calledWith(payload));});});suite('renderMessages()', function(){setup(function(){this.sinon.stub(MessageManager, 'getMessages');this.sinon.stub(MessageManager, 'markThreadRead');ThreadUI.renderMessages(1);});test('we mark messages as read', function(){MessageManager.getMessages.yieldTo('done');this.sinon.clock.tick();assert.ok(MessageManager.markThreadRead.calledWith(1));});});suite('not-downloaded', function(){var localize;var ONE_DAY_TIME=24 *60 *60 *1000;function getTestMessage(index){var testMessages=[{id:1, threadId:8, sender: '123456', type: 'mms', delivery: 'not-downloaded', deliveryStatus:['pending'], subject: 'Pending download', timestamp:new Date(Date.now()-150000), expiryDate:new Date(Date.now()+ONE_DAY_TIME)},{id:2, threadId:8, sender: '123456', type: 'mms', delivery: 'not-downloaded', deliveryStatus:['manual'], subject: 'manual download', timestamp:new Date(Date.now()-150000), expiryDate:new Date(Date.now()+ONE_DAY_TIME *2)},{id:3, threadId:8, sender: '123456', type: 'mms', delivery: 'not-downloaded', deliveryStatus:['error'], subject: 'error download', timestamp:new Date(Date.now()-150000), expiryDate:new Date(Date.now()+ONE_DAY_TIME *2)},{id:4, threadId:8, sender: '123456', type: 'mms', delivery: 'not-downloaded', deliveryStatus:['error'], subject: 'Error download', timestamp:new Date(Date.now()-150000), expiryDate:new Date(Date.now()-ONE_DAY_TIME)}];return testMessages[index];}setup(function(){this.sinon.stub(Utils.date.format, 'localeFormat', function(){return 'date_stub';});this.sinon.stub(MessageManager, 'retrieveMMS', function(){return{};});localize=this.sinon.spy(navigator.mozL10n, 'localize');});suite('pending message', function(){var message;var element;var notDownloadedMessage;var button;setup(function(){message=getTestMessage(0);ThreadUI.appendMessage(message);element=document.getElementById('message-'+message.id);notDownloadedMessage=element.querySelector('.not-downloaded-message');button=element.querySelector('button');});test('element has correct data-message-id', function(){assert.equal(element.dataset.messageId, message.id);});test('not-downloaded class present', function(){assert.isTrue(element.classList.contains('not-downloaded'));});test('error class absent', function(){assert.isFalse(element.classList.contains('error'));});test('expired class absent', function(){assert.isFalse(element.classList.contains('expired'));});test('pending class present', function(){assert.isTrue(element.classList.contains('pending'));});test('message is correct', function(){assert.equal(notDownloadedMessage.dataset.l10nId, 'not-downloaded-mms', 'localization id set correctly');assert.equal(notDownloadedMessage.dataset.l10nArgs, '{&quot;date&quot;:&quot;date_stub&quot;}', 'localization arguments set correctly');});test('date is correctly determined', function(){assert.equal(Utils.date.format.localeFormat.args[0][0], message.expiryDate);assert.equal(Utils.date.format.localeFormat.args[0][1], 'dateTimeFormat_%x');});test('button text is correct', function(){assert.equal(button.dataset.l10nId, 'downloading');});suite('clicking', function(){setup(function(){ThreadUI.handleMessageClick({target:button});});test('does not call retrieveMMS', function(){assert.equal(MessageManager.retrieveMMS.args.length, 0);});});});suite('manual message', function(){var message;var element;var notDownloadedMessage;var button;setup(function(){message=getTestMessage(1);ThreadUI.appendMessage(message);element=document.getElementById('message-'+message.id);notDownloadedMessage=element.querySelector('.not-downloaded-message');button=element.querySelector('button');});test('element has correct data-message-id', function(){assert.equal(element.dataset.messageId, message.id);});test('not-downloaded class present', function(){assert.isTrue(element.classList.contains('not-downloaded'));});test('error class absent', function(){assert.isFalse(element.classList.contains('error'));});test('expired class absent', function(){assert.isFalse(element.classList.contains('expired'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.equal(notDownloadedMessage.dataset.l10nId, 'not-downloaded-mms', 'localization id set correctly');assert.equal(notDownloadedMessage.dataset.l10nArgs, '{&quot;date&quot;:&quot;date_stub&quot;}', 'localization arguments set correctly');});test('date is correctly determined', function(){assert.equal(Utils.date.format.localeFormat.args[0][0], message.expiryDate);assert.equal(Utils.date.format.localeFormat.args[0][1], 'dateTimeFormat_%x');});test('button text is correct', function(){assert.equal(button.dataset.l10nId, 'download');});suite('clicking', function(){setup(function(){localize.reset();ThreadUI.handleMessageClick({target:button});});test('changes download text', function(){assert.ok(localize.calledWith(button, 'downloading'));});test('error class absent', function(){assert.isFalse(element.classList.contains('error'));});test('pending class present', function(){assert.isTrue(element.classList.contains('pending'));});test('click calls retrieveMMS', function(){assert.isTrue(MessageManager.retrieveMMS.calledWith(message.id));});suite('response error', function(){setup(function(){localize.reset();MessageManager.retrieveMMS.returnValues[0].onerror();});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('changes download text', function(){assert.ok(localize.calledWith(button, 'download'));});});suite('response success', function(){setup(function(){MessageManager.retrieveMMS.returnValues[0].onsuccess();});test('removes message', function(){assert.equal(element.parentNode, null);});});});});suite('error message', function(){var message;var element;var notDownloadedMessage;var button;setup(function(){message=getTestMessage(2);ThreadUI.appendMessage(message);element=document.getElementById('message-'+message.id);notDownloadedMessage=element.querySelector('.not-downloaded-message');button=element.querySelector('button');});test('element has correct data-message-id', function(){assert.equal(element.dataset.messageId, message.id);});test('not-downloaded class present', function(){assert.isTrue(element.classList.contains('not-downloaded'));});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('expired class absent', function(){assert.isFalse(element.classList.contains('expired'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.equal(notDownloadedMessage.dataset.l10nId, 'not-downloaded-mms', 'localization id set correctly');assert.equal(notDownloadedMessage.dataset.l10nArgs, '{&quot;date&quot;:&quot;date_stub&quot;}', 'localization arguments set correctly');});test('date is correctly determined', function(){assert.equal(Utils.date.format.localeFormat.args[0][0], message.expiryDate);assert.equal(Utils.date.format.localeFormat.args[0][1], 'dateTimeFormat_%x');});test('button text is correct', function(){assert.equal(button.dataset.l10nId, 'download');});suite('clicking', function(){setup(function(){localize.reset();ThreadUI.handleMessageClick({target:button});});test('changes download text', function(){assert.ok(localize.calledWith(button, 'downloading'));});test('error class absent', function(){assert.isFalse(element.classList.contains('error'));});test('pending class present', function(){assert.isTrue(element.classList.contains('pending'));});test('click calls retrieveMMS', function(){assert.isTrue(MessageManager.retrieveMMS.calledWith(message.id));});suite('response error', function(){setup(function(){localize.reset();MessageManager.retrieveMMS.returnValues[0].onerror();});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('changes download text', function(){assert.ok(localize.calledWith(button, 'download'));});});suite('response success', function(){setup(function(){MessageManager.retrieveMMS.returnValues[0].onsuccess();});test('removes message', function(){assert.equal(element.parentNode, null);});});});});suite('expired message', function(){var message;var element;var notDownloadedMessage;var button;setup(function(){message=getTestMessage(3);ThreadUI.appendMessage(message);element=document.getElementById('message-'+message.id);notDownloadedMessage=element.querySelector('.not-downloaded-message');button=element.querySelector('button');});test('element has correct data-message-id', function(){assert.equal(element.dataset.messageId, message.id);});test('not-downloaded class present', function(){assert.isTrue(element.classList.contains('not-downloaded'));});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('expired class present', function(){assert.isTrue(element.classList.contains('expired'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.equal(notDownloadedMessage.dataset.l10nId, 'expired-mms', 'localization id set correctly');assert.equal(notDownloadedMessage.dataset.l10nArgs, '{&quot;date&quot;:&quot;date_stub&quot;}', 'localization arguments set correctly');});test('date is correctly determined', function(){assert.equal(Utils.date.format.localeFormat.args[0][0], message.expiryDate);assert.equal(Utils.date.format.localeFormat.args[0][1], 'dateTimeFormat_%x');});suite('clicking', function(){setup(function(){ThreadUI.handleMessageClick({target:button});});test('does not call retrieveMMS', function(){assert.equal(MessageManager.retrieveMMS.args.length, 0);});});});});suite('No attachment error handling', function(){function getTestMessage(index){var testMessages=[{id:1, threadId:8, sender: '123456', type: 'mms', delivery: 'received', deliveryStatus:['success'], subject: 'No attachment testing', smil: '&lt; smil &gt;&lt; body &gt;&lt; par &gt;&lt; text src=&quot;cid:1&quot;/&gt;'+ '&lt;/par &gt;&lt;/body &gt;&lt;/smil &gt;', attachments:null, timestamp:new Date(Date.now()-150000), expiryDate:new Date(Date.now())},{id:2, threadId:8, sender: '123456', type: 'mms', delivery: 'received', deliveryStatus:['success'], subject: 'Empty attachment testing', smil: '&lt; smil &gt;&lt; body &gt;&lt; par &gt;&lt; text src=&quot;cid:1&quot;/&gt;'+ '&lt;/par &gt;&lt;/body &gt;&lt;/smil &gt;', attachments:[], timestamp:new Date(Date.now()-100000), expiryDate:new Date(Date.now())}];return testMessages[index];}var localize;setup(function(){this.sinon.stub(Utils.date.format, 'localeFormat', function(){return 'date_stub';});this.sinon.stub(MessageManager, 'retrieveMMS', function(){return{};});localize=this.sinon.spy(navigator.mozL10n, 'localize');});suite('no attachment message', function(){var message;var element;var noAttachmentMessage;setup(function(){message=getTestMessage(0);ThreadUI.appendMessage(message);element=document.getElementById('message-'+message.id);noAttachmentMessage=element.querySelector('p');});test('element has correct data-message-id', function(){assert.equal(element.dataset.messageId, message.id);});test('no-attachment class present', function(){assert.isTrue(element.classList.contains('no-attachment'));});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.ok(localize.calledWith(noAttachmentMessage, 'no-attachment-text'));});suite('clicking', function(){setup(function(){ThreadUI.handleMessageClick({target:element});});test('Should not call retrieveMMS', function(){assert.isFalse(MessageManager.retrieveMMS.called);});});});suite('Empty attachment message', function(){var message;var element;var noAttachmentMessage;setup(function(){message=getTestMessage(1);ThreadUI.appendMessage(message);element=document.getElementById('message-'+message.id);noAttachmentMessage=element.querySelector('p');});test('element has correct data-message-id', function(){assert.equal(element.dataset.messageId, message.id);});test('no-attachment class present', function(){assert.isTrue(element.classList.contains('no-attachment'));});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.ok(localize.calledWith(noAttachmentMessage, 'no-attachment-text'));});suite('clicking', function(){setup(function(){ThreadUI.handleMessageClick({target:element});});test('Should not call retrieveMMS', function(){assert.isFalse(MessageManager.retrieveMMS.called);});});});});suite('resendMessage', function(){setup(function(){this.receivers=['1234'];this.targetMsg={id:23, type: 'sms', receivers:this.receivers, body: 'This is a test', delivery: 'error', timestamp:new Date()};this.otherMsg={id:45, type: 'sms', receivers:this.receivers, body: 'this test', delivery: 'error', timestamp:new Date()};ThreadUI.appendMessage(this.targetMsg);ThreadUI.appendMessage(this.otherMsg);assert.length(ThreadUI.container.querySelectorAll('[data-message-id=&quot;23&quot;]'), 1);assert.length(ThreadUI.container.querySelectorAll('[data-message-id=&quot;45&quot;]'), 1);this.getMessageReq={};this.sinon.stub(MessageManager, 'getMessage').returns(this.getMessageReq);this.sinon.stub(MessageManager, 'deleteMessage').callsArgWith(1, true);this.sinon.stub(MessageManager, 'resendMessage');});test('removes the markup of only the specified message from the DOM', function(){ThreadUI.resendMessage(23);this.getMessageReq.result=this.targetMsg;this.getMessageReq.onsuccess();assert.length(ThreadUI.container.querySelectorAll('[data-message-id=&quot;23&quot;]'), 0);assert.length(ThreadUI.container.querySelectorAll('[data-message-id=&quot;45&quot;]'), 1);});test('invokes MessageManager.resendMessage', function(){ThreadUI.resendMessage(23);this.getMessageReq.result=this.targetMsg;this.getMessageReq.onsuccess();var args=MessageManager.resendMessage.args[0];assert.deepEqual(args[0], this.targetMsg);});});suite('Message error resent in thread with 1 message', function(){var message, request;setup(function(){message={id:23, type: 'sms', body: 'This is a error sms', delivery: 'error', timestamp:new Date()};ThreadUI.appendMessage(message);this.sinon.stub(window, 'confirm');request={};this.sinon.stub(MessageManager, 'getMessage').returns(request);this.sinon.stub(MessageManager, 'resendMessage');this.errorMsg=ThreadUI.container.querySelector('.error');});test('clicking on an error message bubble in a thread with 1 message '+ 'should try to resend and remove the errored message', function(){window.confirm.returns(true);this.errorMsg.querySelector('.pack-end').click();request.result=message;request.onsuccess &amp;&amp;request.onsuccess.call(request);assert.isNull(ThreadUI.container.querySelector('li'));assert.ok(MessageManager.resendMessage.calledWith(message));});});suite('Actions on the links &gt;', function(){var messageId=23, link, phone= '123123123';setup(function(){this.sinon.spy(LinkActionHandler, 'onClick');this.sinon.spy(LinkActionHandler, 'onContextMenu');this.sinon.stub(LinkHelper, 'searchAndLinkClickableData', function(){return '&lt; a data-dial=&quot;' + phone +
        '&quot;data-action=&quot;dial-link&quot;&gt;'+phone+ '&lt;/a &gt;';});ThreadUI.appendMessage({id:messageId, type: 'sms', body: 'This is a test with 123123123', delivery: 'error', timestamp:new Date()});var messageDOM=document.getElementById('message-'+messageId);link=messageDOM.querySelector('a');});teardown(function(){ThreadUI.container.innerHTML= '';link=null;});test('&quot;click&quot;', function(){link.click();assert.ok(LinkActionHandler.onClick.called);assert.isFalse(LinkActionHandler.onContextMenu.called);});test('&quot;contextmenu&quot;', function(){var contextMenuEvent=new CustomEvent('contextmenu',{ 'bubbles':true, 'cancelable':true});link.dispatchEvent(contextMenuEvent);assert.isFalse(LinkActionHandler.onClick.called);assert.ok(LinkActionHandler.onContextMenu.called);});test('&quot;contextmenu&quot;after&quot;click&quot;', function(){var contextMenuEvent=new CustomEvent('contextmenu',{ 'bubbles':true, 'cancelable':true});link.click();link.dispatchEvent(contextMenuEvent);assert.ok(LinkActionHandler.onClick.called);assert.ok(LinkActionHandler.onContextMenu.called);});});suite('Message resending UI', function(){setup(function(){ThreadUI.appendMessage({id:23, type: 'sms', body: 'This is a test', delivery: 'error', timestamp:new Date()});ThreadUI.appendMessage({id:45, type: 'sms', body: 'This is another test', delivery: 'sent', timestamp:new Date()});this.sinon.stub(window, 'confirm');this.sinon.stub(ThreadUI, 'resendMessage');this.elems={errorMsg:ThreadUI.container.querySelector('.error'), sentMsg:ThreadUI.container.querySelector('.sent')};});test('clicking on&quot;pack-end&quot;aside in an error message'+ 'triggers a confirmation dialog', function(){this.elems.errorMsg.querySelector('.pack-end').click();assert.equal(window.confirm.callCount, 1);});test('clicking on p element in an error message'+ 'does not triggers a confirmationdialog', function(){this.elems.errorMsg.querySelector('.bubble p').click();assert.equal(window.confirm.callCount, 0);});test('clicking on an error message does not trigger a confirmation dialog', function(){this.elems.errorMsg.click();assert.equal(window.confirm.callCount, 0);});test('clicking on&quot;pack-end&quot;aside in an error message and accepting the '+ 'confirmation dialog triggers a message re-send operation', function(){window.confirm.returns(true);this.elems.errorMsg.querySelector('.pack-end').click();assert.equal(ThreadUI.resendMessage.callCount, 1);});test('clicking on an error message bubble and rejecting the '+ 'confirmation dialog does not trigger a message re-send operation', function(){window.confirm.returns(false);this.elems.errorMsg.querySelector('.bubble').click();assert.equal(ThreadUI.resendMessage.callCount, 0);});test('clicking on a sent message does not trigger a confirmation dialog '+ 'nor a message re-send operation', function(){this.elems.sentMsg.click();assert.equal(window.confirm.callCount, 0);assert.equal(ThreadUI.resendMessage.callCount, 0);});});suite('createMmsContent', function(){suite('generated html', function(){test('text content', function(){var inputArray=[{text: 'part 1'},{text: 'part 2'}];var output=ThreadUI.createMmsContent(inputArray);assert.equal(output.childNodes.length, 2);assert.equal(output.childNodes[0].innerHTML, 'part 1');assert.equal(output.childNodes[1].innerHTML, 'part 2');});test('blob content', function(){var inputArray=[{name: 'imageTest.jpg', blob:testImageBlob},{name: 'imageTest.jpg', blob:testImageBlob}];var output=ThreadUI.createMmsContent(inputArray);assert.equal(output.childNodes.length, 2);assert.match(output.childNodes[0].nodeName,/iframe/i);assert.match(output.childNodes[1].nodeName,/iframe/i);});test('mixed content', function(){var inputArray=[{text: 'text', name: 'imageTest.jpg', blob:testImageBlob}];var output=ThreadUI.createMmsContent(inputArray);assert.equal(output.childNodes.length, 2);assert.match(output.childNodes[0].nodeName,/iframe/i);assert.equal(output.childNodes[1].innerHTML, 'text');});});test('Clicking on an attachment triggers its`view`method', function(){var messageContainer;var inputArray=[{name: 'imageTest.jpg', blob:testImageBlob}];var viewSpy=this.sinon.spy(Attachment.prototype, 'view');var output=ThreadUI.createMmsContent(inputArray);var attachmentDOM=output.childNodes[0];messageContainer=ThreadUI.getMessageContainer(Date.now(), false);messageContainer.appendChild(output);this.sinon.stub(ThreadUI, 'handleMessageClick');attachmentDOM.click();assert.equal(viewSpy.callCount, 1);assert.ok(viewSpy.calledWith,{allowSave:true});});});suite('Render Contact', function(){test('Rendered Contact&quot;givenName familyName&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.include(html, 'Pepito O\'Hare');});test('Rendered Contact highlighted&quot;givenName familyName&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: 'Pepito O\'Hare', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.include(html, '&lt; span class=&quot;highlight&quot;&gt;Pepito&lt;/span &gt;');assert.include(html, '&lt; span class=&quot;highlight&quot;&gt;O\'Hare&lt;/span &gt;');});test('Rendered Contact&quot;number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.tel[0].carrier=null;contact.tel[0].type=null;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('+346578888888'));});test('Rendered Contact highlighted&quot;number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.tel[0].carrier=null;contact.tel[0].type=null;ThreadUI.renderContact({contact:contact, input: '346578888888', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('+&lt; span class=&quot;highlight&quot;&gt;346578888888&lt;/span &gt;'));});test('Rendered Contact&quot;type | number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.tel[0].carrier=null;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('&lt; span data-l10n-id=&quot;Mobile&quot;&gt;Mobile&lt;/span &gt;| '+ '+346578888888'));});test('Rendered Contact highlighted&quot;type | number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.tel[0].carrier=null;ThreadUI.renderContact({contact:contact, input: '346578888888', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains( '&lt; span data-l10n-id=&quot;Mobile&quot;&gt;Mobile&lt;/span &gt;| '+ '+&lt; span class=&quot;highlight&quot;&gt;346578888888&lt;/span &gt;'));});test('Rendered Contact&quot;type | carrier, number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains( '&lt; span data-l10n-id=&quot;Mobile&quot;&gt;Mobile&lt;/span &gt;| '+ 'TEF,+346578888888'));});test('Rendered Contact highlighted&quot;type | carrier, number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: '346578888888', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains( '&lt; span data-l10n-id=&quot;Mobile&quot;&gt;Mobile&lt;/span &gt;| '+ 'TEF,+&lt; span class=&quot;highlight&quot;&gt;346578888888&lt;/span &gt;'));});test('Rendered Contact w/multiple:one', function(){var target=document.createElement('ul');ThreadUI.renderContact({contact:MockContact(), input: '+12125559999', target:target, isContact:true, isSuggestion:false});assert.equal(target.children.length, 1);});test('Rendered Contact w/multiple:one w/minimal match', function(){var target=document.createElement('ul');ThreadUI.renderContact({contact:MockContact(), input: '5559999', target:target, isContact:true, isSuggestion:false});assert.equal(target.children.length, 1);});test('Rendered Contact w/multiple:all(isSuggestion)', function(){var target=document.createElement('ul');ThreadUI.renderContact({contact:MockContact(), input: '+12125559999', target:target, isContact:true, isSuggestion:true});assert.equal(target.children.length, 2);});test('Rendered Contact omit numbers already in recipient list', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.recipients.add({number: '+346578888888'});ThreadUI.renderContact({contact:contact, input: '+346578888888', target:ul, isContact:true, isSuggestion:true});html=ul.innerHTML;assert.ok(!html.contains('346578888888'));assert.equal(ul.children.length, 1);});test('Render contact does not include photo by default', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true, renderPhoto:false});html=ul.firstElementChild.innerHTML;assert.isFalse(html.contains('img'));});test('Render contact without photo keeps avatar invisible', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.photo=testImageBlob;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true, renderPhoto:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('img'));assert.equal(ul.querySelector('img').style.opacity, 0);});test('Render contact with photo shows the image', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.photo=testImageBlob;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true, renderPhoto:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('img'));assert.equal(ul.querySelector('img').style.opacity, '');});});suite('Header Actions/Display', function(){setup(function(){Threads.delete(1);window.location.hash= '';MockActivityPicker.dial.mSetup();MockOptionMenu.mSetup();});teardown(function(){Threads.delete(1);window.location.hash= '';MockActivityPicker.dial.mTeardown();MockOptionMenu.mTeardown();});suite('OptionMenu', function(){suite('prompt', function(){test('Single known', function(){Threads.set(1,{participants:['999']});window.location.hash= '#thread=1';ThreadUI.prompt({number: '999', isContact:true});assert.equal(MockOptionMenu.calls.length, 0);assert.ok(MockActivityPicker.dial.called);assert.equal(MockActivityPicker.dial.calledWith, '999');});test('Single unknown(phone)', function(){Threads.set(1,{participants:['999']});window.location.hash= '#thread=1';ThreadUI.prompt({number: '999', isContact:false});assert.equal(MockOptionMenu.calls.length, 1);var call=MockOptionMenu.calls[0];var items=call.items;assert.equal(call.header, '999');assert.equal(call.section, '');assert.equal(items.length, 4);assert.equal(items[0].l10nId, 'call');assert.equal(items[1].l10nId, 'createNewContact');assert.equal(items[2].l10nId, 'addToExistingContact');assert.equal(items[3].l10nId, 'cancel');});test('Single unknown(email)', function(){Threads.set(1,{participants:['999']});window.location.hash= '#thread=1';ThreadUI.prompt({email: 'a @b.com', isContact:false});assert.equal(MockOptionMenu.calls.length, 1);var call=MockOptionMenu.calls[0];var items=call.items;assert.equal(call.header, 'a @b.com');assert.equal(call.section, '');assert.equal(items.length, 4);assert.equal(items[0].l10nId, 'sendEmail');assert.equal(items[1].l10nId, 'createNewContact');assert.equal(items[2].l10nId, 'addToExistingContact');assert.equal(items[3].l10nId, 'cancel');});test('Multiple known', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.prompt({number: '999', isContact:true});assert.equal(MockOptionMenu.calls.length, 1);var call=MockOptionMenu.calls[0];var items=call.items;assert.equal(call.header, '999');assert.equal(items.length, 3);assert.equal(items[0].l10nId, 'call');assert.equal(items[1].l10nId, 'sendMessage');assert.equal(items[2].l10nId, 'cancel');});test('Multiple unknown', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.prompt({number: '999', isContact:false});assert.equal(MockOptionMenu.calls.length, 1);var call=MockOptionMenu.calls[0];var items=call.items;assert.equal(call.header, '999');assert.equal(items.length, 5);assert.equal(items[0].l10nId, 'call');assert.equal(items[1].l10nId, 'sendMessage');assert.equal(items[2].l10nId, 'createNewContact');assert.equal(items[3].l10nId, 'addToExistingContact');assert.equal(items[4].l10nId, 'cancel');});});suite('onHeaderActivation', function(){test('Single known', function(){Threads.set(1,{participants:['+12125559999']});window.location.hash= '#thread=1';ThreadUI.headerText.dataset.isContact=true;ThreadUI.headerText.dataset.number= '+12125559999';ThreadUI.onHeaderActivation();assert.equal(MockOptionMenu.calls.length, 0);assert.equal(MockActivityPicker.dial.called, 1);});test('Single unknown', function(){Threads.set(1,{participants:['777']});window.location.hash= '#thread=1';ThreadUI.headerText.dataset.isContact=false;ThreadUI.headerText.dataset.number= '777';ThreadUI.onHeaderActivation();var calls=MockOptionMenu.calls;assert.equal(calls.length, 1);assert.equal(calls[0].header, '777');assert.equal(calls[0].items.length, 4);assert.equal(typeof calls[0].complete, 'function');});});});suite('Single participant', function(){suite('Carrier Tag', function(){test('Carrier Tag(non empty string)', function(done){Threads.set(1,{participants:['+12125559999']});window.location.hash= '#thread=1';this.sinon.stub(MockUtils, 'getCarrierTag', function(){return 'non empty string';});this.sinon.stub(MockContacts, 'findByPhoneNumber', function(phone, fn){fn([new MockContact()]);var threadMessages=document.getElementById('thread-messages');assert.isTrue(threadMessages.classList.contains('has-carrier'));done();});ThreadUI.updateHeaderData();});test('Carrier Tag(empty string)', function(done){Threads.set(1,{participants:['+12125559999']});window.location.hash= '#thread=1';this.sinon.stub(MockUtils, 'getCarrierTag', function(){return '';});this.sinon.stub(MockContacts, 'findByPhoneNumber', function(phone, fn){fn([new MockContact()]);var threadMessages=document.getElementById('thread-messages');assert.isFalse(threadMessages.classList.contains('has-carrier'));done();});ThreadUI.updateHeaderData();});});});suite('Multi participant', function(){var localize;setup(function(){window.location.hash= '';MockActivityPicker.dial.mSetup();MockOptionMenu.mSetup();localize=this.sinon.spy(navigator.mozL10n, 'localize');});teardown(function(){Threads.delete(1);window.location.hash= '';MockActivityPicker.dial.mTeardown();MockOptionMenu.mTeardown();});suite('Options', function(){test('DOES NOT Invoke Activities', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.headerText.dataset.isContact=true;ThreadUI.headerText.dataset.number= '999';ThreadUI.onHeaderActivation();assert.equal(MockActivityPicker.dial.called, false);assert.equal(MockActivityPicker.dial.calledWith, null);});test('DOES NOT Invoke Options', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.headerText.dataset.isContact=true;ThreadUI.headerText.dataset.number= '999';ThreadUI.onHeaderActivation();assert.equal(MockOptionMenu.calls.length, 0);});test('Moves to Group View', function(done){Threads.set(1,{participants:['999', '888']});window.onhashchange=function(){window.onhashchange=function(){assert.equal(window.location.hash, '#group-view');assert.deepEqual(localize.args[0],[ThreadUI.headerText, 'participant',{n:2}]);ThreadUI.onHeaderActivation();assert.equal(window.location.hash, '#group-view');window.onhashchange=null;done();};ThreadUI.onHeaderActivation();ThreadUI.groupView();};window.location.hash= '#thread=1';});test('Correctly Displayed', function(){var contacts={a:new MockContact(), b:new MockContact()};contacts.a.tel.length=1;contacts.b.tel.length=1;contacts.a.tel[0].value= '999';contacts.b.tel[0].value= '888';ThreadUI.renderContact({contact:contacts.a, input: '999', target:ThreadUI.participantsList, isContact:true, isSuggestion:false});ThreadUI.renderContact({contact:contacts.b, input: '888', target:ThreadUI.participantsList, isContact:true, isSuggestion:false});assert.equal(ThreadUI.participantsList.children.length, 2);});test('Reset Group View', function(){var list=ThreadUI.participants.firstElementChild;assert.equal(list.children.length, 0);list.innerHTML= '&lt; li &gt;&lt;/li &gt;&lt; li &gt;&lt;/li &gt;&lt; li &gt;&lt;/li &gt;';assert.equal(list.children.length, 3);ThreadUI.groupView.reset();assert.equal(list.children.length, 0);});});suite('Carrier Tag', function(){test('Carrier Tag(empty string)', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.updateHeaderData();var threadMessages=document.getElementById('thread-messages');assert.isFalse(threadMessages.classList.contains('has-carrier'));});});});});suite('Sending Behavior(onSendClick)', function(){var realComposeisEmpty;var realMessageManager;var realEnableSend;suiteSetup(function(){realEnableSend=ThreadUI.enableSend;realComposeisEmpty=Compose.isEmpty;realMessageManager=MessageManager;ThreadUI.enableSend=function(){ThreadUI.sendButton.disabled=false;};Compose.isEmpty=function(){return false;};MessageManager={activity:{recipients:[]}};['sendMMS', 'sendSMS'].forEach(function(prop){MessageManager[prop]=function(){MessageManager[prop].called=true;MessageManager[prop].calledWith=[].slice.call(arguments);};MessageManager[prop].mSetup=function(){MessageManager[prop].called=false;MessageManager[prop].calledWith=null;};MessageManager[prop].mTeardown=function(){delete MessageManager[prop].called;delete MessageManager[prop].calledWith;};});MessageManager=MessageManager;});suiteTeardown(function(){ThreadUI.enableSend=realEnableSend;Compose.isEmpty=realComposeisEmpty;MessageManager=realMessageManager;});setup(function(){window.location.hash= '#new';MessageManager.sendMMS.mSetup();MessageManager.sendSMS.mSetup();});teardown(function(){MessageManager.sendMMS.mTeardown();MessageManager.sendSMS.mTeardown();});test('SMS, 1 Recipient, stays in view', function(){ThreadUI.recipients.add({number: '999'});Compose.append('foo');ThreadUI.onSendClick();var calledWith=MessageManager.sendSMS.calledWith;assert.ok(MessageManager.sendSMS.called);assert.deepEqual(calledWith[0],['999']);assert.deepEqual(calledWith[1], 'foo');assert.equal(window.location.hash, '#new');});test('MMS, 1 Recipient, stays in view', function(){ThreadUI.recipients.add({number: '999'});Compose.append(mockAttachment(512));ThreadUI.onSendClick();assert.ok(MessageManager.sendMMS.called);assert.deepEqual(MessageManager.sendMMS.calledWith[0],['999']);assert.equal(window.location.hash, '#new');});test('SMS, &gt;1 Recipient, moves to thread list', function(done){ThreadUI.recipients.add({number: '999'});ThreadUI.recipients.add({number: '888'});Compose.append('foo');window.onhashchange=function(){assert.equal(window.location.hash, '#thread-list');window.onhashchange=null;done();};ThreadUI.onSendClick();var calledWith=MessageManager.sendSMS.calledWith;assert.ok(MessageManager.sendSMS.called);assert.deepEqual(calledWith[0],['999', '888']);assert.deepEqual(calledWith[1], 'foo');});test('MMS, &gt;1 Recipient, stays in view', function(){ThreadUI.recipients.add({number: '999'});ThreadUI.recipients.add({number: '888'});Compose.append(mockAttachment(512));ThreadUI.onSendClick();assert.ok(MessageManager.sendMMS.called);assert.deepEqual(MessageManager.sendMMS.calledWith[0],['999', '888']);assert.equal(window.location.hash, '#new');});});suite('Contact Picker Behavior(contactPickButton)', function(){setup(function(){this.sinon.spy(ThreadUI, 'assimilateRecipients');});test('assimilate called after mousedown on picker button', function(){ThreadUI.contactPickButton.dispatchEvent(new CustomEvent('mousedown'));assert.ok(ThreadUI.assimilateRecipients.called);});});suite('setMessageBody', function(){setup(function(){this.sinon.stub(Compose, 'clear');this.sinon.stub(Compose, 'append');this.sinon.stub(Compose, 'focus');});suite('with data', function(){var testText= 'testing';setup(function(){ThreadUI.setMessageBody(testText);});test('calls clear', function(){assert.ok(Compose.clear.called);});test('calls append with correct data', function(){assert.ok(Compose.append.calledWith(testText));});test('calls focus', function(){assert.ok(Compose.focus.called);});});suite('without data', function(){var testText= '';setup(function(){ThreadUI.setMessageBody(testText);});test('calls clear', function(){assert.ok(Compose.clear.called);});test('does not call append with empty data', function(){assert.isFalse(Compose.append.called);});test('calls focus', function(){assert.ok(Compose.focus.called);});});});suite('recipient handling &gt;', function(){var localize;setup(function(){location.hash= '#new';localize=this.sinon.spy(navigator.mozL10n, 'localize');});teardown(function(){location.hash= '';});function testPickButtonEnabled(){test('pick button is enabled', function(){var pickButton=ThreadUI.contactPickButton;assert.isFalse(pickButton.classList.contains('disabled'));});}suite('no recipients', function(){setup(function(){ThreadUI.updateComposerHeader();});test('header is correct', function(){assert.deepEqual(localize.args[0],[ThreadUI.headerText, 'newMessage']);});testPickButtonEnabled();});suite('add one recipient', function(){setup(function(){ThreadUI.recipients.add({number: '999'});});test('header is correct', function(){assert.deepEqual(localize.args[0],[ThreadUI.headerText, 'recipient',{n:1}]);});testPickButtonEnabled();});suite('add two recipients', function(){setup(function(){ThreadUI.recipients.add({number: '999'});ThreadUI.recipients.add({number: '888'});});test('header is correct', function(){assert.ok(localize.calledTwice);assert.deepEqual(localize.args[1],[ThreadUI.headerText, 'recipient',{n:2}]);});testPickButtonEnabled();});});suite('initSentAudio', function(){test('calling function does not throw uncaught exception ', function(){assert.doesNotThrow(ThreadUI.initSentAudio);});});})</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
変数</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../d7/d1b/test-agent-server_8js.html#aab71dcc804ca4aa3ed2bf7ba887635db">use</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#ae2475e10618961c050dcba04e8c42331">strict</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">var&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#aebcc27c0d7c71338b1ecc8fcf07e85c7">mocksHelperForThreadUI</a></td></tr>
</table>
<hr/><h2>関数</h2>
<a class="anchor" id="a65606686b3891822d17e1e523983fe07"></a><!-- doxytag: member="thread_ui_test.js::if" ref="a65606686b3891822d17e1e523983fe07" args="(!navigator.mozContacts)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../de/dfc/events_8js.html#aa27c1f7f883859f374ef91e69db597bd">if</a> </td>
          <td>(</td>
          <td class="paramtype">!navigator.&#160;</td>
          <td class="paramname"><em>mozContacts</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p> <a class="el" href="../../d9/d25/thread__ui__test_8js_source.html">thread_ui_test.js</a> の <a class="el" href="../../d9/d25/thread__ui__test_8js_source.html#l00006">6</a> 行で定義されています。</p>

<p>参照先 <a class="el" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js_source.html#l00043">navigator</a>, <a class="el" href="../../d1/d04/app__install__manager_8js_source.html#l00420">null</a>, と <a class="el" href="../../d9/d87/browser__db__test_8js.html#ad548b08f6e63e350af60da8702015c5d">requireApp()</a>.</p>
<div class="fragment"><pre class="fragment">                            {
  <a class="code" href="../../d9/d87/browser__db__test_8js.html#ad548b08f6e63e350af60da8702015c5d">requireApp</a>(<span class="stringliteral">&#39;sms/js/desktop_contact_mock.js&#39;</span>);
}
</pre></div>
<p><div class="dynheader">
関数の呼び出しグラフ:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d9/d25/thread__ui__test_8js_a65606686b3891822d17e1e523983fe07_cgraph.svg" width="184" height="40"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</p>

</div>
</div>
<a class="anchor" id="abc9cc966c63f6f16f23498d36a91bc4f"></a><!-- doxytag: member="thread_ui_test.js::init" ref="abc9cc966c63f6f16f23498d36a91bc4f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d9/d25/thread__ui__test_8js.html#aebcc27c0d7c71338b1ecc8fcf07e85c7">mocksHelperForThreadUI</a> <a class="el" href="../../d5/d0d/pay_8js.html#af619d0ad365b66772212901ccd40466c">init</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p> <a class="el" href="../../dc/da7/fm_8js_source.html">fm.js</a> の <a class="el" href="../../dc/da7/fm_8js_source.html#l00690">690</a> 行で定義されています。</p>
<div class="fragment"><pre class="fragment">                {
  <a class="code" href="../../dc/da7/fm_8js.html#a60e4f46ea1c84167188f3df600a7a79b">frequencyDialer</a>.init();

  var seeking = <span class="keyword">false</span>;
  <span class="keyword">function</span> onclick_seekbutton(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
    var seekButton = <span class="keyword">this</span>;
    var powerSwitch = $(<span class="stringliteral">&#39;power-switch&#39;</span>);
    var seeking = !!powerSwitch.getAttribute(<span class="stringliteral">&#39;data-seeking&#39;</span>);
    var <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a841de671beddc9eb985cf068237fbff7">up</a> = seekButton.id == <span class="stringliteral">&#39;frequency-op-seekup&#39;</span>;

    <span class="keyword">function</span> seek() {
      powerSwitch.dataset.seeking = <span class="keyword">true</span>;

      var <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a> = up ? mozFMRadio.seekUp() : mozFMRadio.seekDown();

      request.onsuccess = <span class="keyword">function</span> seek_onsuccess() {
        powerSwitch.removeAttribute(<span class="stringliteral">&#39;data-seeking&#39;</span>);
      };

      request.onerror = <span class="keyword">function</span> seek_onerror() {
        powerSwitch.removeAttribute(<span class="stringliteral">&#39;data-seeking&#39;</span>);
      };
    }

    <span class="comment">// If the FM radio is seeking channel currently, cancel it and seek again.</span>
    <span class="keywordflow">if</span> (seeking) {
      var request = mozFMRadio.cancelSeek();
      request.onsuccess = seek;
      request.onerror = seek;
    } <span class="keywordflow">else</span> {
      seek();
    }
  }

  $(<span class="stringliteral">&#39;frequency-op-seekdown&#39;</span>).<a class="code" href="../../d8/d0d/transfer_8js.html#abd169909fbdd66534e2d19bf20938d8b">addEventListener</a>(<span class="stringliteral">&#39;click&#39;</span>,
                                   onclick_seekbutton, <span class="keyword">false</span>);
  $(<span class="stringliteral">&#39;frequency-op-seekup&#39;</span>).<a class="code" href="../../d8/d0d/transfer_8js.html#abd169909fbdd66534e2d19bf20938d8b">addEventListener</a>(<span class="stringliteral">&#39;click&#39;</span>,
                                   onclick_seekbutton, <span class="keyword">false</span>);

  $(<span class="stringliteral">&#39;power-switch&#39;</span>).<a class="code" href="../../d8/d0d/transfer_8js.html#abd169909fbdd66534e2d19bf20938d8b">addEventListener</a>(<span class="stringliteral">&#39;click&#39;</span>, <span class="keyword">function</span> toggle_fm() {
    <span class="keywordflow">if</span> (mozFMRadio.enabled) {
      mozFMRadio.disable();
    } <span class="keywordflow">else</span> {
      <a class="code" href="../../dc/da7/fm_8js.html#aaea60f6ff93b242ef2e1bcb693f60b46">enableFMRadio</a>(<a class="code" href="../../dc/da7/fm_8js.html#a60e4f46ea1c84167188f3df600a7a79b">frequencyDialer</a>.getFrequency());
    }
  }, <span class="keyword">false</span>);

  $(<span class="stringliteral">&#39;bookmark-button&#39;</span>).<a class="code" href="../../d8/d0d/transfer_8js.html#abd169909fbdd66534e2d19bf20938d8b">addEventListener</a>(<span class="stringliteral">&#39;click&#39;</span>, <span class="keyword">function</span> toggle_bookmark() {
    var frequency = <a class="code" href="../../dc/da7/fm_8js.html#a60e4f46ea1c84167188f3df600a7a79b">frequencyDialer</a>.getFrequency();
    <span class="keywordflow">if</span> (<a class="code" href="../../dc/da7/fm_8js.html#a7ce5ddc42ed7c10be56a3d710cef37da">favoritesList</a>.contains(frequency)) {
      <a class="code" href="../../dc/da7/fm_8js.html#a7ce5ddc42ed7c10be56a3d710cef37da">favoritesList</a>.remove(frequency);
    } <span class="keywordflow">else</span> {
      <a class="code" href="../../dc/da7/fm_8js.html#a7ce5ddc42ed7c10be56a3d710cef37da">favoritesList</a>.add(frequency);
    }
    <a class="code" href="../../dc/da7/fm_8js.html#a3114033e9d3da48efda5f8ad2bbf16cb">updateFreqUI</a>();
  }, <span class="keyword">false</span>);

  mozFMRadio.onfrequencychange = <a class="code" href="../../dc/da7/fm_8js.html#a3114033e9d3da48efda5f8ad2bbf16cb">updateFreqUI</a>;
  mozFMRadio.onenabled = <span class="keyword">function</span>() {
    <a class="code" href="../../dc/da7/fm_8js.html#a6129e1ab3f60334c7125678489fe6081">updateEnablingState</a>(<span class="keyword">false</span>);
  };
  mozFMRadio.ondisabled = <span class="keyword">function</span>() {
    <a class="code" href="../../dc/da7/fm_8js.html#a6129e1ab3f60334c7125678489fe6081">updateEnablingState</a>(<span class="keyword">false</span>);
  };

  mozFMRadio.onantennaavailablechange = <span class="keyword">function</span> onAntennaChange() {
    <a class="code" href="../../dc/da7/fm_8js.html#a39ce8abc435fa64a09de68bb0d02fe81">updateAntennaUI</a>();
    <span class="keywordflow">if</span> (mozFMRadio.antennaAvailable) {
      <span class="comment">// If the FM radio is enabled or enabling when the antenna is unplugged,</span>
      <span class="comment">// turn the FM radio on again.</span>
      <span class="keywordflow">if</span> (!!<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>._previousFMRadioState || !!<a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>._previousEnablingState) {
        <a class="code" href="../../dc/da7/fm_8js.html#aaea60f6ff93b242ef2e1bcb693f60b46">enableFMRadio</a>(<a class="code" href="../../dc/da7/fm_8js.html#a60e4f46ea1c84167188f3df600a7a79b">frequencyDialer</a>.getFrequency());
      }
    } <span class="keywordflow">else</span> {
      <span class="comment">// Remember the current state of the FM radio</span>
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>._previousFMRadioState = mozFMRadio.enabled;
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>._previousEnablingState = <a class="code" href="../../dc/da7/fm_8js.html#a8e06555c6c04c92164d95983e52b4ebb">enabling</a>;
      mozFMRadio.disable();
    }
  };

  <span class="comment">// Disable the power button and the fav list when the airplane mode is on.</span>
  <a class="code" href="../../dc/da7/fm_8js.html#a6f29f687e5ab929b6edbb6a1863a95cc">updateAirplaneModeUI</a>();
  <a class="code" href="../../dc/da7/fm_8js.html#a46efbc9e28313d5603af4022d6352293">mozSettings</a>.addObserver(<span class="stringliteral">&#39;ril.radio.disabled&#39;</span>, <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
    <a class="code" href="../../dc/da7/fm_8js.html#add986777b62020d3900e280a0e1744e0">rilDisabled</a> = <span class="keyword">event</span>.settingValue;
    <a class="code" href="../../dc/da7/fm_8js.html#a6f29f687e5ab929b6edbb6a1863a95cc">updateAirplaneModeUI</a>();
  });

  <a class="code" href="../../dc/da7/fm_8js.html#adabc57e23d23bd862b1db39761c35328">historyList</a>.init(<span class="keyword">function</span> hl_ready() {
    <span class="keywordflow">if</span> (mozFMRadio.antennaAvailable) {
      <span class="comment">// Enable FM immediately</span>
      <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (<a class="code" href="../../dc/da7/fm_8js.html#adabc57e23d23bd862b1db39761c35328">historyList</a>.last() &amp;&amp; <a class="code" href="../../dc/da7/fm_8js.html#adabc57e23d23bd862b1db39761c35328">historyList</a>.last().frequency)
        <a class="code" href="../../dc/da7/fm_8js.html#aaea60f6ff93b242ef2e1bcb693f60b46">enableFMRadio</a>(<a class="code" href="../../dc/da7/fm_8js.html#adabc57e23d23bd862b1db39761c35328">historyList</a>.last().frequency);
      <span class="keywordflow">else</span>
        <a class="code" href="../../dc/da7/fm_8js.html#aaea60f6ff93b242ef2e1bcb693f60b46">enableFMRadio</a>(mozFMRadio.frequencyLowerBound);

      <a class="code" href="../../dc/da7/fm_8js.html#a7ce5ddc42ed7c10be56a3d710cef37da">favoritesList</a>.init(<a class="code" href="../../dc/da7/fm_8js.html#a3114033e9d3da48efda5f8ad2bbf16cb">updateFreqUI</a>);
    } <span class="keywordflow">else</span> {
      <span class="comment">// Mark the previous state as True,</span>
      <span class="comment">// so the FM radio be enabled automatically</span>
      <span class="comment">// when the headset is plugged.</span>
      <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>._previousFMRadioState = <span class="keyword">true</span>;
      <a class="code" href="../../dc/da7/fm_8js.html#a39ce8abc435fa64a09de68bb0d02fe81">updateAntennaUI</a>();
      <a class="code" href="../../dc/da7/fm_8js.html#a7ce5ddc42ed7c10be56a3d710cef37da">favoritesList</a>.init();
    }
    <a class="code" href="../../dc/da7/fm_8js.html#a8a385995e6ff4caf76e4938d5721a5be">updatePowerUI</a>();
  });
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5c541e3fe82db794e8961f36db25f466"></a><!-- doxytag: member="thread_ui_test.js::requireApp" ref="a5c541e3fe82db794e8961f36db25f466" args="('sms/js/compose.js')" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../da/d16/shared_2test_2unit_2mocks_2mock__settings__listener_8js.html#ada5f8f0f77028802cd46c92cb1ce8fce">requireApp</a> </td>
          <td>(</td>
          <td class="paramtype">'sms/js/compose.js'&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="ab7e7367b81ab63a354718673d5d5cc70"></a><!-- doxytag: member="thread_ui_test.js::setup" ref="ab7e7367b81ab63a354718673d5d5cc70" args="({globals:['alert']})" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">mocha <a class="el" href="../../da/db6/ime__test_8js.html#a499aeb7e1826da3a383e443025bfc846">setup</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="af01bd6be3c63f2716a185f195d101f34"></a><!-- doxytag: member="thread_ui_test.js::suite" ref="af01bd6be3c63f2716a185f195d101f34" args="('thread_ui.js &gt;', function(){var input;var container;var sendButton;var composeForm;var recipient;var realMozL10n;var realMozMobileMessage;var mocksHelper=mocksHelperForThreadUI;var testImageBlob;var oversizedImageBlob;var testAudioBlob;var testVideoBlob;function mockAttachment(size){return new MockAttachment({type: 'video/ogg', size:size}, 'video.ogv');}function mockImgAttachment(isOversized){var attachment=isOversized?new MockAttachment(oversizedImageBlob, 'testOversized.jpg'):new MockAttachment(testImageBlob, 'test.jpg');return attachment;}suiteSetup(function(done){this.timeout(5000);mocksHelper.suiteSetup();realMozL10n=navigator.mozL10n;navigator.mozL10n=MockL10n;var assetsNeeded=0;function getAsset(filename, loadCallback){assetsNeeded++;var req=new XMLHttpRequest();req.open('GET', filename, true);req.responseType= 'blob';req.onload=function(){loadCallback(req.response);if(&#45;&#45;assetsNeeded===0){done();}};req.send();}getAsset('/test/unit/media/kitten&#45;450.jpg', function(blob){testImageBlob=blob;});getAsset('/test/unit/media/IMG_0554.jpg', function(blob){oversizedImageBlob=blob;});getAsset('/test/unit/media/audio.oga', function(blob){testAudioBlob=blob;});getAsset('/test/unit/media/video.ogv', function(blob){testVideoBlob=blob;});});suiteTeardown(function(){navigator.mozL10n=realMozL10n;mocksHelper.suiteTeardown();});setup(function(){mocksHelper.setup();loadBodyHTML('/index.html');input=document.getElementById('messages&#45;input');container=document.getElementById('messages&#45;container');sendButton=document.getElementById('messages&#45;send&#45;button');composeForm=document.getElementById('messages&#45;compose&#45;form');this.sinon.useFakeTimers();ThreadUI.recipients=null;ThreadUI.init();realMozMobileMessage=ThreadUI._mozMobileMessage;ThreadUI._mozMobileMessage=MockNavigatormozMobileMessage;});teardown(function(){document.body.innerHTML= '';MockNavigatormozMobileMessage.mTeardown();mocksHelper.teardown();ThreadUI._mozMobileMessage=realMozMobileMessage;});suite('scrolling', function(){teardown(function(){container.innerHTML= '';});setup(function(){container.style.overflow= 'scroll';container.style.height= '50px';var innerHTML= '';for(var i=0;i&lt; 99;i++){innerHTML+=ThreadUI.tmpl.message.interpolate({id:String(i), bodyHTML: 'test#'+i});}container.innerHTML=innerHTML;container.lastElementChild.style.paddingBottom= '16px';});test('scroll 100px, should be detected as a manual scroll', function(done){container.addEventListener('scroll', function onscroll(){container.removeEventListener('scroll', onscroll);assert.ok(ThreadUI.isScrolledManually);done();});container.scrollTop=100;});test('scroll to bottom, should be detected as an automatic scroll', function(done){container.addEventListener('scroll', function onscroll(){container.removeEventListener('scroll', onscroll);assert.isFalse(ThreadUI.isScrolledManually);assert.ok((container.scrollTop+container.clientHeight)==container.scrollHeight);done();});ThreadUI.isScrolledManually=false;ThreadUI.scrollViewToBottom();});});suite('Search', function(){test('search results cleared', function(){Compose.clear();Compose.append('foo');ThreadUI.cleanFields(true);assert.equal(Compose.getContent(), '');});});suite('enableSend() &gt;', function(){setup(function(){Compose.clear();ThreadUI.updateCounter();window.location.hash= '#thread&#45;1';});teardown(function(){Compose.clear();window.location.hash= '';});suite('Thread View', function(){setup(function(){window.location.hash= '#thread&#45;1';});teardown(function(){window.location.hash= '';});test('button should be disabled at the beginning', function(){Compose.clear();assert.isTrue(sendButton.disabled);});test('button should be enabled when there is some text', function(){Compose.append('Hola');assert.isFalse(sendButton.disabled);});test('button should not be disabled if there is some text '+ 'but too many segments', function(){Compose.append('Hola');this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);var segmentInfo={segments:11, charsAvailableInLastSegment:10};MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(sendButton.disabled);});});suite('#new mode &gt;', function(){setup(function(){window.location.hash= '#new';Compose.clear();ThreadUI.recipients.length=0;ThreadUI.recipients.inputValue= '';});teardown(function(){window.location.hash= '';Compose.clear();ThreadUI.recipients.length=0;ThreadUI.recipients.inputValue= '';});test('button should be disabled when there is neither contact or input', function(){assert.isTrue(sendButton.disabled);});test('button should be disabled when there is no contact', function(){Compose.append('Hola');assert.isTrue(sendButton.disabled);});test('button should be enabled with recipient input', function(){Compose.append('Hola');ThreadUI.recipients.inputValue= '999';ThreadUI.enableSend();assert.isFalse(sendButton.disabled);});test('button should be enabled after adding a recipient when text exists', function(){Compose.append('Hola');ThreadUI.recipients.add({number: '999'});assert.isFalse(sendButton.disabled);});test('button should be enabled after adding text when recipient exists', function(){ThreadUI.recipients.add({number: '999'});Compose.append('Hola');assert.isFalse(sendButton.disabled);});test('button should be disabled when there is both contact and '+ 'input, but too much data to send as mms', function(){ThreadUI.recipients.add({number: '999'});Compose.append(mockAttachment(300 *1024));assert.isFalse(sendButton.disabled);Compose.append('Hola');assert.isTrue(sendButton.disabled);});test('When adding an image that is under the limitation, button '+ 'should be enabled right after appended', function(){ThreadUI.recipients.add({number: '999'});Compose.append(mockImgAttachment());assert.isFalse(sendButton.disabled);});test('When adding an oversized image, button should be disabled while '+ 'resizing and enabled when resize complete', function(done){ThreadUI.recipients.add({number: '999'});function onInput(){if(!Compose.isResizing){Compose.off('input', onInput);assert.isFalse(sendButton.disabled);done();}};Compose.on('input', onInput);Compose.append(mockImgAttachment(true));assert.isTrue(sendButton.disabled);});});});suite('updateCounter() &gt;', function(){var banner, convertBanner, shouldEnableSend, form, localize;setup(function(){banner=document.getElementById('messages&#45;max&#45;length&#45;notice');convertBanner=document.getElementById('messages&#45;convert&#45;notice');form=document.getElementById('messages&#45;compose&#45;form');localize=this.sinon.spy(navigator.mozL10n, 'localize');this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);MockNavigatormozMobileMessage.mTeardown();});function updateCounter(segmentInfo){banner.classList.remove('hide');Compose.lock=true;shouldEnableSend=ThreadUI.updateCounter();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);}var initialText= 'some text';var followingText= 'some other text';test('do not call getSegmentInfoForText twice in a row', function(){var spy=this.sinon.spy(MockNavigatormozMobileMessage, 'getSegmentInfoForText');Compose.append(initialText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY/2);Compose.append(followingText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);assert.equal(spy.callCount, 1);assert.ok(spy.calledWith(initialText+followingText));});test('getSegmentInfoForText error hides the counter', function(){sendButton.classList.add('has&#45;counter');Compose.append(initialText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);MockNavigatormozMobileMessage.mTriggerSegmentInfoError();assert.isFalse(sendButton.classList.contains('has&#45;counter'));});suite('asynchronous tricky tests &gt;', function(){var spy;var segmentInfo1={segments:1, charsAvailableInLastSegment:50};var segmentInfo2={segments:1, charsAvailableInLastSegment:40};setup(function(){spy=this.sinon.spy(MockNavigatormozMobileMessage, 'getSegmentInfoForText');Compose.append(initialText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);Compose.append(followingText);this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);});teardown(function(){Compose.clear();});test('getSegmentInfoForText got called twice', function(){assert.equal(spy.callCount, 2);assert.ok(spy.getCall(0).calledWith(initialText));assert.ok(spy.getCall(1).calledWith(initialText+followingText));});test('segment info requests return ordered', function(){MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo1, 0);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo2, 0);var subject=sendButton.dataset.counter;var expected=segmentInfo2.charsAvailableInLastSegment+ '/'+segmentInfo2.segments;assert.equal(subject, expected);});test('2 segment info requests return unordered', function(){MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo2, 1);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo1, 0);var subject=sendButton.dataset.counter;var expected=segmentInfo1.charsAvailableInLastSegment+ '/'+segmentInfo1.segments;assert.equal(subject, expected);});});suite('type changed after the first segment info request &gt;', function(){setup(function(){Compose.type= 'sms';ThreadUI.updateCounter();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);Compose.type= 'mms';var segmentInfo={segments:0, charsAvailableInLastSegment:0};MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);});teardown(function(){Compose.type= 'sms';});test('should not change the segment info', function(){assert.ok(sendButton.classList.contains('has&#45;counter'));});});suite('no characters entered &gt;', function(){setup(function(){var segmentInfo={segments:0, charsAvailableInLastSegment:0};updateCounter.call(this, segmentInfo);});test('no counter is displayed', function(){assert.isFalse(sendButton.classList.contains('has&#45;counter'));});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in first segment &gt;', function(){setup(function(){var segmentInfo={segments:1, charsAvailableInLastSegment:20};updateCounter.call(this, segmentInfo);});test('no counter is displayed', function(){assert.isFalse(sendButton.classList.contains('has&#45;counter'));});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in first segment, less than 10 chars left &gt;', function(){var segment=1, availableChars=10;setup(function(){var segmentInfo={segments:segment, charsAvailableInLastSegment:availableChars};updateCounter.call(this, segmentInfo);});test('a counter is displayed', function(){var expected=availableChars+ '/'+segment;assert.equal(sendButton.dataset.counter, expected);});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in second segment &gt;', function(){var segment=2, availableChars=20;setup(function(){var segmentInfo={segments:segment, charsAvailableInLastSegment:availableChars};updateCounter.call(this, segmentInfo);});test('a counter is displayed', function(){var expected=availableChars+ '/'+segment;assert.equal(sendButton.dataset.counter, expected);});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in last segment &gt;', function(){var segment=10, availableChars=20;setup(function(){var segmentInfo={segments:segment, charsAvailableInLastSegment:availableChars};updateCounter.call(this, segmentInfo);});test('a counter is displayed', function(){var expected=availableChars+ '/'+segment;assert.equal(sendButton.dataset.counter, expected);});test('no banner is displayed', function(){assert.ok(banner.classList.contains('hide'));});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('lock is unset', function(){assert.isFalse(Compose.lock);});});suite('in last segment, no characters left &gt;', function(){var segment=10, availableChars=0;setup(function(){var segmentInfo={segments:segment, charsAvailableInLastSegment:availableChars};updateCounter.call(this, segmentInfo);});test('a counter is displayed', function(){var expected=availableChars+ '/'+segment;assert.equal(sendButton.dataset.counter, expected);});test('the send button should be enabled', function(){assert.isTrue(shouldEnableSend);});test('message type is sms', function(){assert.equal(form.dataset.messageType, 'sms');});test('lock is disabled', function(){assert.isFalse(Compose.lock);});});suite('too many segments &gt;', function(){var segmentInfo={segments:11, charsAvailableInLastSegment:25};setup(function(){updateCounter.call(this, segmentInfo);});test('message type is mms', function(){assert.equal(form.dataset.messageType, 'mms');});test('lock is disabled', function(){assert.isFalse(Compose.lock);});suite('trying to move back to sms &gt;', function(){setup(function(){this.sinon.clock.tick(5000);this.sinon.spy(MockNavigatormozMobileMessage, 'getSegmentInfoForText');Compose.type= 'sms';MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);});test('getSegmentInfoForText was called', function(){assert.ok(MockNavigatormozMobileMessage.getSegmentInfoForText.called);});test('message type is still mms', function(){assert.equal(Compose.type, 'mms');assert.equal(form.dataset.messageType, 'mms');});test('the convertion notice is not displayed', function(){assert.ok(convertBanner.classList.contains('hide'));});});});suite('at size limit in mms &gt;', function(){setup(function(){Settings.mmsSizeLimitation=1024;Compose.append(mockAttachment(512));Compose.append(mockAttachment(512));shouldEnableSend=ThreadUI.updateCounter();});teardown(function(){Compose.clear();});test('shouldEnableSend', function(){assert.isTrue(shouldEnableSend);});test('banner is displayed', function(){assert.isFalse(banner.classList.contains('hide'));});test('banner localized', function(){assert.ok(localize.calledWith(banner.querySelector('p'), 'messages&#45;max&#45;length&#45;text'));});test('message type is mms', function(){assert.equal(form.dataset.messageType, 'mms');});test('lock is enabled', function(){assert.isTrue(Compose.lock);});});suite('over size limit in mms &gt;', function(){setup(function(){Settings.mmsSizeLimitation=1024;Compose.append(mockAttachment(512));Compose.append('sigh');Compose.append(mockAttachment(512));shouldEnableSend=ThreadUI.updateCounter();});teardown(function(){Compose.clear();});test('shouldEnableSend is false', function(){assert.isFalse(shouldEnableSend);});test('banner is displayed', function(){assert.isFalse(banner.classList.contains('hide'));});test('banner localized', function(){assert.ok(localize.calledWith(banner.querySelector('p'), 'messages&#45;exceeded&#45;length&#45;text'));});test('message type is mms', function(){assert.equal(form.dataset.messageType, 'mms');});test('lock is enabled', function(){assert.isTrue(Compose.lock);});});});suite('message type conversion &gt;', function(){var convertBanner, convertBannerText, form, localize;setup(function(){convertBanner=document.getElementById('messages&#45;convert&#45;notice');convertBannerText=convertBanner.querySelector('p');form=document.getElementById('messages&#45;compose&#45;form');localize=this.sinon.spy(navigator.mozL10n, 'localize');});test('sms to mms and back displays banner', function(){Compose.type= 'mms';assert.isTrue(sendButton.classList.contains('has&#45;counter'));assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for mms');assert.equal(composeForm.dataset.messageType, 'mms', 'the composer has type mms');assert.ok(localize.calledWith(convertBannerText, 'converted&#45;to&#45;mms'), 'conversion banner has mms message');localize.reset();this.sinon.clock.tick(2999);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for just shy of 3 seconds');this.sinon.clock.tick(1);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');Compose.type= 'sms';this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess();assert.isFalse(sendButton.classList.contains('has&#45;counter'));assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for sms');assert.equal(composeForm.dataset.messageType, 'sms', 'the composer has type sms');assert.ok(localize.calledWith(convertBannerText, 'converted&#45;to&#45;sms'), 'conversion banner has sms message');this.sinon.clock.tick(2999);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for just shy of 3 seconds');this.sinon.clock.tick(1);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');});test('character limit from sms to mms and back displays banner', function(){ThreadUI.updateCounter();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);var segmentInfo={segments:11, charsAvailableInLastSegment:0};MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for mms');assert.equal(composeForm.dataset.messageType, 'mms', 'the composer has type mms');assert.ok(localize.calledWith(convertBannerText, 'converted&#45;to&#45;mms'), 'conversion banner has mms message');localize.reset();this.sinon.clock.tick(2999);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for just shy of 3 seconds');this.sinon.clock.tick(1);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');Compose.clear();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);segmentInfo.segments=0;MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for sms');assert.equal(composeForm.dataset.messageType, 'sms', 'the composer has type sms');assert.ok(localize.calledWith(convertBannerText, 'converted&#45;to&#45;sms'), 'conversion banner has sms message');localize.reset();this.sinon.clock.tick(2999);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for just shy of 3 seconds');this.sinon.clock.tick(1);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');});test('converting from sms to mms and back quickly', function(){ThreadUI.updateCounter();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);var segmentInfo={segments:11, charsAvailableInLastSegment:0};MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for mms');assert.ok(localize.calledWith(convertBannerText, 'converted&#45;to&#45;mms'), 'conversion banner has mms message');localize.reset();this.sinon.clock.tick(1500);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is still shown');Compose.clear();this.sinon.clock.tick(ThreadUI.UPDATE_DELAY);segmentInfo.segments=0;MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess(segmentInfo);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is shown for sms');assert.ok(localize.calledWith(convertBannerText, 'converted&#45;to&#45;sms'), 'conversion banner has sms message');localize.reset();this.sinon.clock.tick(2000);assert.isFalse(convertBanner.classList.contains('hide'), 'conversion banner is still shown');this.sinon.clock.tick(1000);assert.isTrue(convertBanner.classList.contains('hide'), 'conversion banner is hidden at 3 seconds');});test('we dont display the banner when cleaning fields', function(){Compose.type= 'mms';this.sinon.clock.tick(ThreadUI.CONVERTED_MESSAGE_DURATION);this.sinon.spy(Compose, 'clear');ThreadUI.cleanFields();MockNavigatormozMobileMessage.mTriggerSegmentInfoSuccess({segments:0, charsAvailableInLastSegment:0});assert.isTrue(Compose.clear.called);assert.isTrue(convertBanner.classList.contains('hide'));});});suite('Recipient Assimiliation', function(){setup(function(){this.sinon.spy(ThreadUI.recipients, 'visible');this.sinon.spy(ThreadUI.recipients, 'add');Threads.set(1,{participants:['999']});});teardown(function(){Threads.delete(1);window.location.hash= '';});suite('New Conversation', function(){var node;setup(function(){window.location.hash= '#new';node=document.createElement('span');node.isPlaceholder=true;node.textContent= '999';ThreadUI.recipientsList.appendChild(node);});teardown(function(){ThreadUI.recipientsList.removeChild(node);});test('Will assimilate recipients', function(){var visible, add;ThreadUI.assimilateRecipients();visible=ThreadUI.recipients.visible;add=ThreadUI.recipients.add;assert.ok(visible.called);assert.equal(visible.args[0][0], 'singleline');assert.ok(add.called);assert.deepEqual(add.args[0][0],{name: '999', number: '999', source: 'manual'});});});suite('Existing Conversation', function(){setup(function(){window.location.hash= '#thread=1';});test('Will not assimilate recipients ', function(){var visible, add;ThreadUI.assimilateRecipients();visible=ThreadUI.recipients.visible;add=ThreadUI.recipients.add;assert.isFalse(visible.called);assert.isFalse(add.called);});});});suite('message status update handlers &gt;', function(){suiteSetup(function(){this.fakeMessage={id:24601};});teardown(function(){document.body.removeChild(this.container);});setup(function(){this.container=document.createElement('div');this.container.id= 'message&#45;'+this.fakeMessage.id;this.container.className= 'sending';this.container.innerHTML=ThreadUI.tmpl.message.interpolate({});document.body.appendChild(this.container);});suite('onMessageSent &gt;', function(){test('removes the&quot;sending&quot;class from the message element', function(){ThreadUI.onMessageSent(this.fakeMessage);assert.isFalse(this.container.classList.contains('sending'));});test('adds the&quot;sent&quot;class to the message element', function(){ThreadUI.onMessageSent(this.fakeMessage);assert.isTrue(this.container.classList.contains('sent'));});});suite('onMessageFailed &gt;', function(){suite('messages that were *not *previously in the&quot;error&quot;state &gt;', function(){test('removes the&quot;sending&quot;class from the message element', function(){ThreadUI.onMessageFailed(this.fakeMessage);assert.isFalse(this.container.classList.contains('sending'));});test('adds the&quot;error&quot;class to the message element', function(){ThreadUI.onMessageFailed(this.fakeMessage);assert.isTrue(this.container.classList.contains('error'));});});suite('messages that were previously in the&quot;error&quot;state &gt;', function(){setup(function(){this.container.classList.add('error');});test('does not remove the&quot;sending&quot;class to the message element', function(){ThreadUI.onMessageFailed(this.fakeMessage);assert.isTrue(this.container.classList.contains('sending'));});});suite('show error message when send message unsuccessfully', function(){setup(function(){MockDialog.mSetup();});teardown(function(){MockDialog.mTeardown();});test('show general error for no signal error', function(){ThreadUI.showSendMessageError('NoSignalError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show general error for not found error', function(){ThreadUI.showSendMessageError('NotFoundError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show general error for unknown error', function(){ThreadUI.showSendMessageError('UnknownError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show general error for internal error', function(){ThreadUI.showSendMessageError('InternalError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show general error for invalid address error', function(){ThreadUI.showSendMessageError('InvalidAddressError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendGeneralErrorTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendGeneralErrorBody');});test('show no SIM card', function(){ThreadUI.showSendMessageError('NoSimCardError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendNoSimCardTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendNoSimCardBody');});test('show air plane mode', function(){ThreadUI.showSendMessageError('RadioDisabledError');assert.isTrue(MockDialog.instances[0].show.called);assert.equal(MockDialog.calls[0].title.l10nId, 'sendAirplaneModeTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'sendAirplaneModeBody');});test('show FDN blockage error', function(){ThreadUI.showSendMessageError( 'FdnCheckError',['123', '456', '789']);assert.equal(MockDialog.calls[0].title.l10nId, 'fdnBlockedTitle');assert.equal(MockDialog.calls[0].body.l10nId, 'fdnBlockedBody');});});});suite('onDeliverySuccess &gt;', function(){teardown(function(){this.fakeMessage.deliveryStatus=null;});test('sms delivery success', function(){this.fakeMessage.deliveryStatus= 'success';ThreadUI.onDeliverySuccess(this.fakeMessage);assert.isTrue(this.container.classList.contains('delivered'));});test('mms delivery success', function(){this.fakeMessage.deliveryStatus=['success'];ThreadUI.onDeliverySuccess(this.fakeMessage);assert.isTrue(this.container.classList.contains('delivered'));});test('multiple recipients mms delivery success', function(){this.fakeMessage.deliveryStatus=['success', 'success'];ThreadUI.onDeliverySuccess(this.fakeMessage);assert.isTrue(this.container.classList.contains('delivered'));});test('not all recipients return mms delivery success', function(){this.fakeMessage.deliveryStatus=['success', 'pending'];ThreadUI.onDeliverySuccess(this.fakeMessage);assert.isFalse(this.container.classList.contains('delivered'));});});});suite('removeMessageDOM', function(){setup(function(){ThreadUI.container.innerHTML= '&lt; h2 &gt;&lt;/h2 &gt;&lt; ul &gt;&lt; li &gt;&lt;/li &gt;&lt; li &gt;&lt;/li &gt;&lt;/ul &gt;';});teardown(function(){ThreadUI.container.innerHTML= '';});test('removeMessageDOM removes a child', function(){ThreadUI.removeMessageDOM(ThreadUI.container.querySelector('li'));assert.equal(ThreadUI.container.querySelectorAll('li').length, 1);});test('removeMessageDOM removes headers and ul', function(){ThreadUI.removeMessageDOM(ThreadUI.container.querySelector('li'));ThreadUI.removeMessageDOM(ThreadUI.container.querySelector('li'));assert.equal(ThreadUI.container.querySelectorAll('h2').length, 0);assert.equal(ThreadUI.container.querySelectorAll('ul').length, 0);});});suite('getMessageContainer &gt;', function(){var lastYear, yesterday, today;var fiveMinAgo, elevenMinAgo, oneHourAgo, oneHourFiveMinAgo;setup(function(){today=new Date(2013, 11, 31, 23, 59);this.sinon.clock.restore();this.sinon.useFakeTimers(+today);lastYear=new Date(2012, 11, 31);yesterday=new Date(2013, 11, 30, 12, 0);fiveMinAgo=new Date(2013, 11, 31, 23, 54);elevenMinAgo=new Date(2013, 11, 31, 23, 48);oneHourAgo=new Date(2013, 11, 31, 22, 59);oneHourFiveMinAgo=new Date(2013, 11, 31, 22, 54);});suite('last message block alone today &gt;', function(){var subject;setup(function(){subject=ThreadUI.getMessageContainer(+fiveMinAgo);});test('has both the date and the time', function(){var header=subject.previousElementSibling;assert.notEqual(header.dataset.timeOnly, 'true');});});suite('last message block with another block today &gt;', function(){var subject;setup(function(){ThreadUI.getMessageContainer(+elevenMinAgo);subject=ThreadUI.getMessageContainer(+fiveMinAgo);});test('has only the time', function(){assert.equal(subject.previousElementSibling.dataset.timeOnly, 'true');});});suite('2 recent messages, different days &gt;', function(){var firstContainer, secondContainer;setup(function(){firstContainer=ThreadUI.getMessageContainer(Date.now());this.sinon.clock.tick(5 *60 *1000);secondContainer=ThreadUI.getMessageContainer(Date.now());});test('different containers', function(){assert.notEqual(secondContainer, firstContainer);});test('second container has both the date and the time', function(){var secondHeader=secondContainer.previousElementSibling;assert.notEqual(secondHeader.dataset.timeOnly, 'true');});});suite('2 recent messages, same day, 15 minutes interval &gt;', function(){var firstContainer, secondContainer, firstTimestamp;setup(function(){this.sinon.clock.tick(15 *60 *1000);firstContainer=ThreadUI.getMessageContainer(Date.now());firstTimestamp=firstContainer.dataset.timestamp;this.sinon.clock.tick(15 *60 *1000);secondContainer=ThreadUI.getMessageContainer(Date.now());});test('different containers', function(){assert.notEqual(secondContainer, firstContainer);});test('has only the time', function(){var secondHeader=secondContainer.previousElementSibling;assert.equal(secondHeader.dataset.timeOnly, 'true');});test('first container has now a start&#45;of&#45;the&#45;day timestamp', function(){assert.notEqual(firstContainer.dataset.timestamp, firstTimestamp);});});suite('insert one non&#45;last&#45;message block at the end &gt;', function(){var lastYearContainer, yesterdayContainer;setup(function(){lastYearContainer=ThreadUI.getMessageContainer(+lastYear);yesterdayContainer=ThreadUI.getMessageContainer(+yesterday);});test('should have 2 blocks', function(){assert.equal(ThreadUI.container.querySelectorAll('header').length, 2);assert.equal(ThreadUI.container.querySelectorAll('ul').length, 2);});test('should be in the correct order', function(){var containers=ThreadUI.container.querySelectorAll('ul');var expectedContainers=[lastYearContainer, yesterdayContainer];expectedContainers.forEach(function(container, index){assert.equal(container, containers[index]);});});});suite('insert one non&#45;last&#45;message block at the end of a 2&#45;item list &gt;', function(){var lastYearContainer, yesterdayContainer, twoDaysAgoContainer;setup(function(){lastYearContainer=ThreadUI.getMessageContainer(+lastYear);var twoDaysAgo=new Date(2013, 11, 29);twoDaysAgoContainer=ThreadUI.getMessageContainer(+twoDaysAgo);yesterdayContainer=ThreadUI.getMessageContainer(+yesterday);});test('should have 3 blocks', function(){assert.equal(ThreadUI.container.querySelectorAll('header').length, 3);assert.equal(ThreadUI.container.querySelectorAll('ul').length, 3);});test('should be in the correct order', function(){var containers=ThreadUI.container.querySelectorAll('ul');var expectedContainers=[lastYearContainer, twoDaysAgoContainer, yesterdayContainer];expectedContainers.forEach(function(container, index){assert.equal(container, containers[index]);});});});suite('4 blocks suite &gt;', function(){var lastYearContainer, yesterdayContainer;var elevenMinContainer, fiveMinContainer;var oneHourContainer, oneHourFiveContainer;setup(function(){yesterdayContainer=ThreadUI.getMessageContainer(+yesterday);fiveMinContainer=ThreadUI.getMessageContainer(+fiveMinAgo);elevenMinContainer=ThreadUI.getMessageContainer(+elevenMinAgo);oneHourContainer=ThreadUI.getMessageContainer(+oneHourAgo);oneHourFiveContainer=ThreadUI.getMessageContainer(+oneHourFiveMinAgo);lastYearContainer=ThreadUI.getMessageContainer(+lastYear);});test('should have 4 blocks', function(){assert.equal(ThreadUI.container.querySelectorAll('header').length, 4);assert.equal(ThreadUI.container.querySelectorAll('ul').length, 4);});test('should be in the correct order', function(){var containers=ThreadUI.container.querySelectorAll('ul');var expectedContainers=[lastYearContainer, yesterdayContainer, elevenMinContainer, fiveMinContainer];expectedContainers.forEach(function(container, index){assert.equal(container, containers[index]);});});test('some containers are the same', function(){assert.equal(oneHourContainer, elevenMinContainer);assert.equal(oneHourFiveContainer, elevenMinContainer);});test('last message block should not show the date', function(){var header=fiveMinContainer.previousElementSibling;assert.equal(header.dataset.timeOnly, 'true');});test('adding a new message in the last message block', function(){var twoMinAgo=new Date(2013, 11, 31, 23, 57);var twoMinContainer=ThreadUI.getMessageContainer(+twoMinAgo);assert.equal(twoMinContainer, fiveMinContainer);});suite('adding a new message for yesterday &gt;', function(){var container;var oldHeaderTimestamp;setup(function(){var header=yesterdayContainer.previousElementSibling;oldHeaderTimestamp=header.dataset.time;var yesterdayEarlier=new Date(+yesterday);yesterdayEarlier.setHours(5, 5);container=ThreadUI.getMessageContainer(+yesterdayEarlier);});test('still 4 blocks', function(){assert.equal(ThreadUI.container.querySelectorAll('header').length, 4);});test('same container as the existing yesterday container', function(){assert.equal(container, yesterdayContainer);});test('the time header was updated', function(){var header=container.previousElementSibling;var headerTimestamp=header.dataset.time;assert.notEqual(headerTimestamp, oldHeaderTimestamp);});});});});suite('appendMessage removes old message', function(){setup(function(){this.targetMsg={id:23, type: 'sms', receivers:this.receivers, body: 'This is a test', delivery: 'error', timestamp:new Date()};ThreadUI.appendMessage(this.targetMsg);this.original=ThreadUI.container.querySelector( '[data&#45;message&#45;id=&quot;' + this.targetMsg.id + '&quot;]');ThreadUI.appendMessage(this.targetMsg);});test('original message removed when rendered a second time', function(){var message=ThreadUI.container.querySelector( '[data&#45;message&#45;id=&quot;' + this.targetMsg.id + '&quot;]');assert.notEqual(message, this.original);});});suite('buildMessageDOM &gt;', function(){setup(function(){this.sinon.spy(Template, 'escape');this.sinon.stub(MockSMIL, 'parse');});function buildSMS(payload){return MockMessages.sms({body:payload});}function buildMMS(payload){return MockMessages.mms({attachments:[new Blob([payload],{type: 'text/plain'})]});}test('escapes the body for SMS', function(){var payload= 'hello&lt; a href=&quot;world&quot;&gt;world&lt;/a &gt;';ThreadUI.buildMessageDOM(buildSMS(payload));assert.ok(Template.escape.calledWith(payload));});test('escapes all text for MMS', function(){var payload= 'hello&lt; a href=&quot;world&quot;&gt;world&lt;/a &gt;';MockSMIL.parse.yields([{text:payload}]);ThreadUI.buildMessageDOM(buildMMS(payload));assert.ok(Template.escape.calledWith(payload));});});suite('renderMessages()', function(){setup(function(){this.sinon.stub(MessageManager, 'getMessages');this.sinon.stub(MessageManager, 'markThreadRead');ThreadUI.renderMessages(1);});test('we mark messages as read', function(){MessageManager.getMessages.yieldTo('done');this.sinon.clock.tick();assert.ok(MessageManager.markThreadRead.calledWith(1));});});suite('not&#45;downloaded', function(){var localize;var ONE_DAY_TIME=24 *60 *60 *1000;function getTestMessage(index){var testMessages=[{id:1, threadId:8, sender: '123456', type: 'mms', delivery: 'not&#45;downloaded', deliveryStatus:['pending'], subject: 'Pending download', timestamp:new Date(Date.now()&#45;150000), expiryDate:new Date(Date.now()+ONE_DAY_TIME)},{id:2, threadId:8, sender: '123456', type: 'mms', delivery: 'not&#45;downloaded', deliveryStatus:['manual'], subject: 'manual download', timestamp:new Date(Date.now()&#45;150000), expiryDate:new Date(Date.now()+ONE_DAY_TIME *2)},{id:3, threadId:8, sender: '123456', type: 'mms', delivery: 'not&#45;downloaded', deliveryStatus:['error'], subject: 'error download', timestamp:new Date(Date.now()&#45;150000), expiryDate:new Date(Date.now()+ONE_DAY_TIME *2)},{id:4, threadId:8, sender: '123456', type: 'mms', delivery: 'not&#45;downloaded', deliveryStatus:['error'], subject: 'Error download', timestamp:new Date(Date.now()&#45;150000), expiryDate:new Date(Date.now()&#45;ONE_DAY_TIME)}];return testMessages[index];}setup(function(){this.sinon.stub(Utils.date.format, 'localeFormat', function(){return 'date_stub';});this.sinon.stub(MessageManager, 'retrieveMMS', function(){return{};});localize=this.sinon.spy(navigator.mozL10n, 'localize');});suite('pending message', function(){var message;var element;var notDownloadedMessage;var button;setup(function(){message=getTestMessage(0);ThreadUI.appendMessage(message);element=document.getElementById('message&#45;'+message.id);notDownloadedMessage=element.querySelector('.not&#45;downloaded&#45;message');button=element.querySelector('button');});test('element has correct data&#45;message&#45;id', function(){assert.equal(element.dataset.messageId, message.id);});test('not&#45;downloaded class present', function(){assert.isTrue(element.classList.contains('not&#45;downloaded'));});test('error class absent', function(){assert.isFalse(element.classList.contains('error'));});test('expired class absent', function(){assert.isFalse(element.classList.contains('expired'));});test('pending class present', function(){assert.isTrue(element.classList.contains('pending'));});test('message is correct', function(){assert.equal(notDownloadedMessage.dataset.l10nId, 'not&#45;downloaded&#45;mms', 'localization id set correctly');assert.equal(notDownloadedMessage.dataset.l10nArgs, '{&quot;date&quot;:&quot;date_stub&quot;}', 'localization arguments set correctly');});test('date is correctly determined', function(){assert.equal(Utils.date.format.localeFormat.args[0][0], message.expiryDate);assert.equal(Utils.date.format.localeFormat.args[0][1], 'dateTimeFormat_%x');});test('button text is correct', function(){assert.equal(button.dataset.l10nId, 'downloading');});suite('clicking', function(){setup(function(){ThreadUI.handleMessageClick({target:button});});test('does not call retrieveMMS', function(){assert.equal(MessageManager.retrieveMMS.args.length, 0);});});});suite('manual message', function(){var message;var element;var notDownloadedMessage;var button;setup(function(){message=getTestMessage(1);ThreadUI.appendMessage(message);element=document.getElementById('message&#45;'+message.id);notDownloadedMessage=element.querySelector('.not&#45;downloaded&#45;message');button=element.querySelector('button');});test('element has correct data&#45;message&#45;id', function(){assert.equal(element.dataset.messageId, message.id);});test('not&#45;downloaded class present', function(){assert.isTrue(element.classList.contains('not&#45;downloaded'));});test('error class absent', function(){assert.isFalse(element.classList.contains('error'));});test('expired class absent', function(){assert.isFalse(element.classList.contains('expired'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.equal(notDownloadedMessage.dataset.l10nId, 'not&#45;downloaded&#45;mms', 'localization id set correctly');assert.equal(notDownloadedMessage.dataset.l10nArgs, '{&quot;date&quot;:&quot;date_stub&quot;}', 'localization arguments set correctly');});test('date is correctly determined', function(){assert.equal(Utils.date.format.localeFormat.args[0][0], message.expiryDate);assert.equal(Utils.date.format.localeFormat.args[0][1], 'dateTimeFormat_%x');});test('button text is correct', function(){assert.equal(button.dataset.l10nId, 'download');});suite('clicking', function(){setup(function(){localize.reset();ThreadUI.handleMessageClick({target:button});});test('changes download text', function(){assert.ok(localize.calledWith(button, 'downloading'));});test('error class absent', function(){assert.isFalse(element.classList.contains('error'));});test('pending class present', function(){assert.isTrue(element.classList.contains('pending'));});test('click calls retrieveMMS', function(){assert.isTrue(MessageManager.retrieveMMS.calledWith(message.id));});suite('response error', function(){setup(function(){localize.reset();MessageManager.retrieveMMS.returnValues[0].onerror();});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('changes download text', function(){assert.ok(localize.calledWith(button, 'download'));});});suite('response success', function(){setup(function(){MessageManager.retrieveMMS.returnValues[0].onsuccess();});test('removes message', function(){assert.equal(element.parentNode, null);});});});});suite('error message', function(){var message;var element;var notDownloadedMessage;var button;setup(function(){message=getTestMessage(2);ThreadUI.appendMessage(message);element=document.getElementById('message&#45;'+message.id);notDownloadedMessage=element.querySelector('.not&#45;downloaded&#45;message');button=element.querySelector('button');});test('element has correct data&#45;message&#45;id', function(){assert.equal(element.dataset.messageId, message.id);});test('not&#45;downloaded class present', function(){assert.isTrue(element.classList.contains('not&#45;downloaded'));});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('expired class absent', function(){assert.isFalse(element.classList.contains('expired'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.equal(notDownloadedMessage.dataset.l10nId, 'not&#45;downloaded&#45;mms', 'localization id set correctly');assert.equal(notDownloadedMessage.dataset.l10nArgs, '{&quot;date&quot;:&quot;date_stub&quot;}', 'localization arguments set correctly');});test('date is correctly determined', function(){assert.equal(Utils.date.format.localeFormat.args[0][0], message.expiryDate);assert.equal(Utils.date.format.localeFormat.args[0][1], 'dateTimeFormat_%x');});test('button text is correct', function(){assert.equal(button.dataset.l10nId, 'download');});suite('clicking', function(){setup(function(){localize.reset();ThreadUI.handleMessageClick({target:button});});test('changes download text', function(){assert.ok(localize.calledWith(button, 'downloading'));});test('error class absent', function(){assert.isFalse(element.classList.contains('error'));});test('pending class present', function(){assert.isTrue(element.classList.contains('pending'));});test('click calls retrieveMMS', function(){assert.isTrue(MessageManager.retrieveMMS.calledWith(message.id));});suite('response error', function(){setup(function(){localize.reset();MessageManager.retrieveMMS.returnValues[0].onerror();});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('changes download text', function(){assert.ok(localize.calledWith(button, 'download'));});});suite('response success', function(){setup(function(){MessageManager.retrieveMMS.returnValues[0].onsuccess();});test('removes message', function(){assert.equal(element.parentNode, null);});});});});suite('expired message', function(){var message;var element;var notDownloadedMessage;var button;setup(function(){message=getTestMessage(3);ThreadUI.appendMessage(message);element=document.getElementById('message&#45;'+message.id);notDownloadedMessage=element.querySelector('.not&#45;downloaded&#45;message');button=element.querySelector('button');});test('element has correct data&#45;message&#45;id', function(){assert.equal(element.dataset.messageId, message.id);});test('not&#45;downloaded class present', function(){assert.isTrue(element.classList.contains('not&#45;downloaded'));});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('expired class present', function(){assert.isTrue(element.classList.contains('expired'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.equal(notDownloadedMessage.dataset.l10nId, 'expired&#45;mms', 'localization id set correctly');assert.equal(notDownloadedMessage.dataset.l10nArgs, '{&quot;date&quot;:&quot;date_stub&quot;}', 'localization arguments set correctly');});test('date is correctly determined', function(){assert.equal(Utils.date.format.localeFormat.args[0][0], message.expiryDate);assert.equal(Utils.date.format.localeFormat.args[0][1], 'dateTimeFormat_%x');});suite('clicking', function(){setup(function(){ThreadUI.handleMessageClick({target:button});});test('does not call retrieveMMS', function(){assert.equal(MessageManager.retrieveMMS.args.length, 0);});});});});suite('No attachment error handling', function(){function getTestMessage(index){var testMessages=[{id:1, threadId:8, sender: '123456', type: 'mms', delivery: 'received', deliveryStatus:['success'], subject: 'No attachment testing', smil: '&lt; smil &gt;&lt; body &gt;&lt; par &gt;&lt; text src=&quot;cid:1&quot;/&gt;'+ '&lt;/par &gt;&lt;/body &gt;&lt;/smil &gt;', attachments:null, timestamp:new Date(Date.now()&#45;150000), expiryDate:new Date(Date.now())},{id:2, threadId:8, sender: '123456', type: 'mms', delivery: 'received', deliveryStatus:['success'], subject: 'Empty attachment testing', smil: '&lt; smil &gt;&lt; body &gt;&lt; par &gt;&lt; text src=&quot;cid:1&quot;/&gt;'+ '&lt;/par &gt;&lt;/body &gt;&lt;/smil &gt;', attachments:[], timestamp:new Date(Date.now()&#45;100000), expiryDate:new Date(Date.now())}];return testMessages[index];}var localize;setup(function(){this.sinon.stub(Utils.date.format, 'localeFormat', function(){return 'date_stub';});this.sinon.stub(MessageManager, 'retrieveMMS', function(){return{};});localize=this.sinon.spy(navigator.mozL10n, 'localize');});suite('no attachment message', function(){var message;var element;var noAttachmentMessage;setup(function(){message=getTestMessage(0);ThreadUI.appendMessage(message);element=document.getElementById('message&#45;'+message.id);noAttachmentMessage=element.querySelector('p');});test('element has correct data&#45;message&#45;id', function(){assert.equal(element.dataset.messageId, message.id);});test('no&#45;attachment class present', function(){assert.isTrue(element.classList.contains('no&#45;attachment'));});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.ok(localize.calledWith(noAttachmentMessage, 'no&#45;attachment&#45;text'));});suite('clicking', function(){setup(function(){ThreadUI.handleMessageClick({target:element});});test('Should not call retrieveMMS', function(){assert.isFalse(MessageManager.retrieveMMS.called);});});});suite('Empty attachment message', function(){var message;var element;var noAttachmentMessage;setup(function(){message=getTestMessage(1);ThreadUI.appendMessage(message);element=document.getElementById('message&#45;'+message.id);noAttachmentMessage=element.querySelector('p');});test('element has correct data&#45;message&#45;id', function(){assert.equal(element.dataset.messageId, message.id);});test('no&#45;attachment class present', function(){assert.isTrue(element.classList.contains('no&#45;attachment'));});test('error class present', function(){assert.isTrue(element.classList.contains('error'));});test('pending class absent', function(){assert.isFalse(element.classList.contains('pending'));});test('message is correct', function(){assert.ok(localize.calledWith(noAttachmentMessage, 'no&#45;attachment&#45;text'));});suite('clicking', function(){setup(function(){ThreadUI.handleMessageClick({target:element});});test('Should not call retrieveMMS', function(){assert.isFalse(MessageManager.retrieveMMS.called);});});});});suite('resendMessage', function(){setup(function(){this.receivers=['1234'];this.targetMsg={id:23, type: 'sms', receivers:this.receivers, body: 'This is a test', delivery: 'error', timestamp:new Date()};this.otherMsg={id:45, type: 'sms', receivers:this.receivers, body: 'this test', delivery: 'error', timestamp:new Date()};ThreadUI.appendMessage(this.targetMsg);ThreadUI.appendMessage(this.otherMsg);assert.length(ThreadUI.container.querySelectorAll('[data&#45;message&#45;id=&quot;23&quot;]'), 1);assert.length(ThreadUI.container.querySelectorAll('[data&#45;message&#45;id=&quot;45&quot;]'), 1);this.getMessageReq={};this.sinon.stub(MessageManager, 'getMessage').returns(this.getMessageReq);this.sinon.stub(MessageManager, 'deleteMessage').callsArgWith(1, true);this.sinon.stub(MessageManager, 'resendMessage');});test('removes the markup of only the specified message from the DOM', function(){ThreadUI.resendMessage(23);this.getMessageReq.result=this.targetMsg;this.getMessageReq.onsuccess();assert.length(ThreadUI.container.querySelectorAll('[data&#45;message&#45;id=&quot;23&quot;]'), 0);assert.length(ThreadUI.container.querySelectorAll('[data&#45;message&#45;id=&quot;45&quot;]'), 1);});test('invokes MessageManager.resendMessage', function(){ThreadUI.resendMessage(23);this.getMessageReq.result=this.targetMsg;this.getMessageReq.onsuccess();var args=MessageManager.resendMessage.args[0];assert.deepEqual(args[0], this.targetMsg);});});suite('Message error resent in thread with 1 message', function(){var message, request;setup(function(){message={id:23, type: 'sms', body: 'This is a error sms', delivery: 'error', timestamp:new Date()};ThreadUI.appendMessage(message);this.sinon.stub(window, 'confirm');request={};this.sinon.stub(MessageManager, 'getMessage').returns(request);this.sinon.stub(MessageManager, 'resendMessage');this.errorMsg=ThreadUI.container.querySelector('.error');});test('clicking on an error message bubble in a thread with 1 message '+ 'should try to resend and remove the errored message', function(){window.confirm.returns(true);this.errorMsg.querySelector('.pack&#45;end').click();request.result=message;request.onsuccess &amp;&amp;request.onsuccess.call(request);assert.isNull(ThreadUI.container.querySelector('li'));assert.ok(MessageManager.resendMessage.calledWith(message));});});suite('Actions on the links &gt;', function(){var messageId=23, link, phone= '123123123';setup(function(){this.sinon.spy(LinkActionHandler, 'onClick');this.sinon.spy(LinkActionHandler, 'onContextMenu');this.sinon.stub(LinkHelper, 'searchAndLinkClickableData', function(){return '&lt; a data&#45;dial=&quot;' + phone +
        '&quot;data&#45;action=&quot;dial&#45;link&quot;&gt;'+phone+ '&lt;/a &gt;';});ThreadUI.appendMessage({id:messageId, type: 'sms', body: 'This is a test with 123123123', delivery: 'error', timestamp:new Date()});var messageDOM=document.getElementById('message&#45;'+messageId);link=messageDOM.querySelector('a');});teardown(function(){ThreadUI.container.innerHTML= '';link=null;});test('&quot;click&quot;', function(){link.click();assert.ok(LinkActionHandler.onClick.called);assert.isFalse(LinkActionHandler.onContextMenu.called);});test('&quot;contextmenu&quot;', function(){var contextMenuEvent=new CustomEvent('contextmenu',{ 'bubbles':true, 'cancelable':true});link.dispatchEvent(contextMenuEvent);assert.isFalse(LinkActionHandler.onClick.called);assert.ok(LinkActionHandler.onContextMenu.called);});test('&quot;contextmenu&quot;after&quot;click&quot;', function(){var contextMenuEvent=new CustomEvent('contextmenu',{ 'bubbles':true, 'cancelable':true});link.click();link.dispatchEvent(contextMenuEvent);assert.ok(LinkActionHandler.onClick.called);assert.ok(LinkActionHandler.onContextMenu.called);});});suite('Message resending UI', function(){setup(function(){ThreadUI.appendMessage({id:23, type: 'sms', body: 'This is a test', delivery: 'error', timestamp:new Date()});ThreadUI.appendMessage({id:45, type: 'sms', body: 'This is another test', delivery: 'sent', timestamp:new Date()});this.sinon.stub(window, 'confirm');this.sinon.stub(ThreadUI, 'resendMessage');this.elems={errorMsg:ThreadUI.container.querySelector('.error'), sentMsg:ThreadUI.container.querySelector('.sent')};});test('clicking on&quot;pack&#45;end&quot;aside in an error message'+ 'triggers a confirmation dialog', function(){this.elems.errorMsg.querySelector('.pack&#45;end').click();assert.equal(window.confirm.callCount, 1);});test('clicking on p element in an error message'+ 'does not triggers a confirmationdialog', function(){this.elems.errorMsg.querySelector('.bubble p').click();assert.equal(window.confirm.callCount, 0);});test('clicking on an error message does not trigger a confirmation dialog', function(){this.elems.errorMsg.click();assert.equal(window.confirm.callCount, 0);});test('clicking on&quot;pack&#45;end&quot;aside in an error message and accepting the '+ 'confirmation dialog triggers a message re&#45;send operation', function(){window.confirm.returns(true);this.elems.errorMsg.querySelector('.pack&#45;end').click();assert.equal(ThreadUI.resendMessage.callCount, 1);});test('clicking on an error message bubble and rejecting the '+ 'confirmation dialog does not trigger a message re&#45;send operation', function(){window.confirm.returns(false);this.elems.errorMsg.querySelector('.bubble').click();assert.equal(ThreadUI.resendMessage.callCount, 0);});test('clicking on a sent message does not trigger a confirmation dialog '+ 'nor a message re&#45;send operation', function(){this.elems.sentMsg.click();assert.equal(window.confirm.callCount, 0);assert.equal(ThreadUI.resendMessage.callCount, 0);});});suite('createMmsContent', function(){suite('generated html', function(){test('text content', function(){var inputArray=[{text: 'part 1'},{text: 'part 2'}];var output=ThreadUI.createMmsContent(inputArray);assert.equal(output.childNodes.length, 2);assert.equal(output.childNodes[0].innerHTML, 'part 1');assert.equal(output.childNodes[1].innerHTML, 'part 2');});test('blob content', function(){var inputArray=[{name: 'imageTest.jpg', blob:testImageBlob},{name: 'imageTest.jpg', blob:testImageBlob}];var output=ThreadUI.createMmsContent(inputArray);assert.equal(output.childNodes.length, 2);assert.match(output.childNodes[0].nodeName,/iframe/i);assert.match(output.childNodes[1].nodeName,/iframe/i);});test('mixed content', function(){var inputArray=[{text: 'text', name: 'imageTest.jpg', blob:testImageBlob}];var output=ThreadUI.createMmsContent(inputArray);assert.equal(output.childNodes.length, 2);assert.match(output.childNodes[0].nodeName,/iframe/i);assert.equal(output.childNodes[1].innerHTML, 'text');});});test('Clicking on an attachment triggers its`view`method', function(){var messageContainer;var inputArray=[{name: 'imageTest.jpg', blob:testImageBlob}];var viewSpy=this.sinon.spy(Attachment.prototype, 'view');var output=ThreadUI.createMmsContent(inputArray);var attachmentDOM=output.childNodes[0];messageContainer=ThreadUI.getMessageContainer(Date.now(), false);messageContainer.appendChild(output);this.sinon.stub(ThreadUI, 'handleMessageClick');attachmentDOM.click();assert.equal(viewSpy.callCount, 1);assert.ok(viewSpy.calledWith,{allowSave:true});});});suite('Render Contact', function(){test('Rendered Contact&quot;givenName familyName&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.include(html, 'Pepito O\'Hare');});test('Rendered Contact highlighted&quot;givenName familyName&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: 'Pepito O\'Hare', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.include(html, '&lt; span class=&quot;highlight&quot;&gt;Pepito&lt;/span &gt;');assert.include(html, '&lt; span class=&quot;highlight&quot;&gt;O\'Hare&lt;/span &gt;');});test('Rendered Contact&quot;number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.tel[0].carrier=null;contact.tel[0].type=null;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('+346578888888'));});test('Rendered Contact highlighted&quot;number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.tel[0].carrier=null;contact.tel[0].type=null;ThreadUI.renderContact({contact:contact, input: '346578888888', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('+&lt; span class=&quot;highlight&quot;&gt;346578888888&lt;/span &gt;'));});test('Rendered Contact&quot;type | number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.tel[0].carrier=null;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('&lt; span data&#45;l10n&#45;id=&quot;Mobile&quot;&gt;Mobile&lt;/span &gt;| '+ '+346578888888'));});test('Rendered Contact highlighted&quot;type | number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.tel[0].carrier=null;ThreadUI.renderContact({contact:contact, input: '346578888888', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains( '&lt; span data&#45;l10n&#45;id=&quot;Mobile&quot;&gt;Mobile&lt;/span &gt;| '+ '+&lt; span class=&quot;highlight&quot;&gt;346578888888&lt;/span &gt;'));});test('Rendered Contact&quot;type | carrier, number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains( '&lt; span data&#45;l10n&#45;id=&quot;Mobile&quot;&gt;Mobile&lt;/span &gt;| '+ 'TEF,+346578888888'));});test('Rendered Contact highlighted&quot;type | carrier, number&quot;', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: '346578888888', target:ul, isContact:true, isSuggestion:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains( '&lt; span data&#45;l10n&#45;id=&quot;Mobile&quot;&gt;Mobile&lt;/span &gt;| '+ 'TEF,+&lt; span class=&quot;highlight&quot;&gt;346578888888&lt;/span &gt;'));});test('Rendered Contact w/multiple:one', function(){var target=document.createElement('ul');ThreadUI.renderContact({contact:MockContact(), input: '+12125559999', target:target, isContact:true, isSuggestion:false});assert.equal(target.children.length, 1);});test('Rendered Contact w/multiple:one w/minimal match', function(){var target=document.createElement('ul');ThreadUI.renderContact({contact:MockContact(), input: '5559999', target:target, isContact:true, isSuggestion:false});assert.equal(target.children.length, 1);});test('Rendered Contact w/multiple:all(isSuggestion)', function(){var target=document.createElement('ul');ThreadUI.renderContact({contact:MockContact(), input: '+12125559999', target:target, isContact:true, isSuggestion:true});assert.equal(target.children.length, 2);});test('Rendered Contact omit numbers already in recipient list', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.recipients.add({number: '+346578888888'});ThreadUI.renderContact({contact:contact, input: '+346578888888', target:ul, isContact:true, isSuggestion:true});html=ul.innerHTML;assert.ok(!html.contains('346578888888'));assert.equal(ul.children.length, 1);});test('Render contact does not include photo by default', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true, renderPhoto:false});html=ul.firstElementChild.innerHTML;assert.isFalse(html.contains('img'));});test('Render contact without photo keeps avatar invisible', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.photo=testImageBlob;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true, renderPhoto:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('img'));assert.equal(ul.querySelector('img').style.opacity, 0);});test('Render contact with photo shows the image', function(){var ul=document.createElement('ul');var contact=new MockContact();var html;contact.photo=testImageBlob;ThreadUI.renderContact({contact:contact, input: 'foo', target:ul, isContact:true, isSuggestion:true, renderPhoto:true});html=ul.firstElementChild.innerHTML;assert.ok(html.contains('img'));assert.equal(ul.querySelector('img').style.opacity, '');});});suite('Header Actions/Display', function(){setup(function(){Threads.delete(1);window.location.hash= '';MockActivityPicker.dial.mSetup();MockOptionMenu.mSetup();});teardown(function(){Threads.delete(1);window.location.hash= '';MockActivityPicker.dial.mTeardown();MockOptionMenu.mTeardown();});suite('OptionMenu', function(){suite('prompt', function(){test('Single known', function(){Threads.set(1,{participants:['999']});window.location.hash= '#thread=1';ThreadUI.prompt({number: '999', isContact:true});assert.equal(MockOptionMenu.calls.length, 0);assert.ok(MockActivityPicker.dial.called);assert.equal(MockActivityPicker.dial.calledWith, '999');});test('Single unknown(phone)', function(){Threads.set(1,{participants:['999']});window.location.hash= '#thread=1';ThreadUI.prompt({number: '999', isContact:false});assert.equal(MockOptionMenu.calls.length, 1);var call=MockOptionMenu.calls[0];var items=call.items;assert.equal(call.header, '999');assert.equal(call.section, '');assert.equal(items.length, 4);assert.equal(items[0].l10nId, 'call');assert.equal(items[1].l10nId, 'createNewContact');assert.equal(items[2].l10nId, 'addToExistingContact');assert.equal(items[3].l10nId, 'cancel');});test('Single unknown(email)', function(){Threads.set(1,{participants:['999']});window.location.hash= '#thread=1';ThreadUI.prompt({email: 'a @b.com', isContact:false});assert.equal(MockOptionMenu.calls.length, 1);var call=MockOptionMenu.calls[0];var items=call.items;assert.equal(call.header, 'a @b.com');assert.equal(call.section, '');assert.equal(items.length, 4);assert.equal(items[0].l10nId, 'sendEmail');assert.equal(items[1].l10nId, 'createNewContact');assert.equal(items[2].l10nId, 'addToExistingContact');assert.equal(items[3].l10nId, 'cancel');});test('Multiple known', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.prompt({number: '999', isContact:true});assert.equal(MockOptionMenu.calls.length, 1);var call=MockOptionMenu.calls[0];var items=call.items;assert.equal(call.header, '999');assert.equal(items.length, 3);assert.equal(items[0].l10nId, 'call');assert.equal(items[1].l10nId, 'sendMessage');assert.equal(items[2].l10nId, 'cancel');});test('Multiple unknown', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.prompt({number: '999', isContact:false});assert.equal(MockOptionMenu.calls.length, 1);var call=MockOptionMenu.calls[0];var items=call.items;assert.equal(call.header, '999');assert.equal(items.length, 5);assert.equal(items[0].l10nId, 'call');assert.equal(items[1].l10nId, 'sendMessage');assert.equal(items[2].l10nId, 'createNewContact');assert.equal(items[3].l10nId, 'addToExistingContact');assert.equal(items[4].l10nId, 'cancel');});});suite('onHeaderActivation', function(){test('Single known', function(){Threads.set(1,{participants:['+12125559999']});window.location.hash= '#thread=1';ThreadUI.headerText.dataset.isContact=true;ThreadUI.headerText.dataset.number= '+12125559999';ThreadUI.onHeaderActivation();assert.equal(MockOptionMenu.calls.length, 0);assert.equal(MockActivityPicker.dial.called, 1);});test('Single unknown', function(){Threads.set(1,{participants:['777']});window.location.hash= '#thread=1';ThreadUI.headerText.dataset.isContact=false;ThreadUI.headerText.dataset.number= '777';ThreadUI.onHeaderActivation();var calls=MockOptionMenu.calls;assert.equal(calls.length, 1);assert.equal(calls[0].header, '777');assert.equal(calls[0].items.length, 4);assert.equal(typeof calls[0].complete, 'function');});});});suite('Single participant', function(){suite('Carrier Tag', function(){test('Carrier Tag(non empty string)', function(done){Threads.set(1,{participants:['+12125559999']});window.location.hash= '#thread=1';this.sinon.stub(MockUtils, 'getCarrierTag', function(){return 'non empty string';});this.sinon.stub(MockContacts, 'findByPhoneNumber', function(phone, fn){fn([new MockContact()]);var threadMessages=document.getElementById('thread&#45;messages');assert.isTrue(threadMessages.classList.contains('has&#45;carrier'));done();});ThreadUI.updateHeaderData();});test('Carrier Tag(empty string)', function(done){Threads.set(1,{participants:['+12125559999']});window.location.hash= '#thread=1';this.sinon.stub(MockUtils, 'getCarrierTag', function(){return '';});this.sinon.stub(MockContacts, 'findByPhoneNumber', function(phone, fn){fn([new MockContact()]);var threadMessages=document.getElementById('thread&#45;messages');assert.isFalse(threadMessages.classList.contains('has&#45;carrier'));done();});ThreadUI.updateHeaderData();});});});suite('Multi participant', function(){var localize;setup(function(){window.location.hash= '';MockActivityPicker.dial.mSetup();MockOptionMenu.mSetup();localize=this.sinon.spy(navigator.mozL10n, 'localize');});teardown(function(){Threads.delete(1);window.location.hash= '';MockActivityPicker.dial.mTeardown();MockOptionMenu.mTeardown();});suite('Options', function(){test('DOES NOT Invoke Activities', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.headerText.dataset.isContact=true;ThreadUI.headerText.dataset.number= '999';ThreadUI.onHeaderActivation();assert.equal(MockActivityPicker.dial.called, false);assert.equal(MockActivityPicker.dial.calledWith, null);});test('DOES NOT Invoke Options', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.headerText.dataset.isContact=true;ThreadUI.headerText.dataset.number= '999';ThreadUI.onHeaderActivation();assert.equal(MockOptionMenu.calls.length, 0);});test('Moves to Group View', function(done){Threads.set(1,{participants:['999', '888']});window.onhashchange=function(){window.onhashchange=function(){assert.equal(window.location.hash, '#group&#45;view');assert.deepEqual(localize.args[0],[ThreadUI.headerText, 'participant',{n:2}]);ThreadUI.onHeaderActivation();assert.equal(window.location.hash, '#group&#45;view');window.onhashchange=null;done();};ThreadUI.onHeaderActivation();ThreadUI.groupView();};window.location.hash= '#thread=1';});test('Correctly Displayed', function(){var contacts={a:new MockContact(), b:new MockContact()};contacts.a.tel.length=1;contacts.b.tel.length=1;contacts.a.tel[0].value= '999';contacts.b.tel[0].value= '888';ThreadUI.renderContact({contact:contacts.a, input: '999', target:ThreadUI.participantsList, isContact:true, isSuggestion:false});ThreadUI.renderContact({contact:contacts.b, input: '888', target:ThreadUI.participantsList, isContact:true, isSuggestion:false});assert.equal(ThreadUI.participantsList.children.length, 2);});test('Reset Group View', function(){var list=ThreadUI.participants.firstElementChild;assert.equal(list.children.length, 0);list.innerHTML= '&lt; li &gt;&lt;/li &gt;&lt; li &gt;&lt;/li &gt;&lt; li &gt;&lt;/li &gt;';assert.equal(list.children.length, 3);ThreadUI.groupView.reset();assert.equal(list.children.length, 0);});});suite('Carrier Tag', function(){test('Carrier Tag(empty string)', function(){Threads.set(1,{participants:['999', '888']});window.location.hash= '#thread=1';ThreadUI.updateHeaderData();var threadMessages=document.getElementById('thread&#45;messages');assert.isFalse(threadMessages.classList.contains('has&#45;carrier'));});});});});suite('Sending Behavior(onSendClick)', function(){var realComposeisEmpty;var realMessageManager;var realEnableSend;suiteSetup(function(){realEnableSend=ThreadUI.enableSend;realComposeisEmpty=Compose.isEmpty;realMessageManager=MessageManager;ThreadUI.enableSend=function(){ThreadUI.sendButton.disabled=false;};Compose.isEmpty=function(){return false;};MessageManager={activity:{recipients:[]}};['sendMMS', 'sendSMS'].forEach(function(prop){MessageManager[prop]=function(){MessageManager[prop].called=true;MessageManager[prop].calledWith=[].slice.call(arguments);};MessageManager[prop].mSetup=function(){MessageManager[prop].called=false;MessageManager[prop].calledWith=null;};MessageManager[prop].mTeardown=function(){delete MessageManager[prop].called;delete MessageManager[prop].calledWith;};});MessageManager=MessageManager;});suiteTeardown(function(){ThreadUI.enableSend=realEnableSend;Compose.isEmpty=realComposeisEmpty;MessageManager=realMessageManager;});setup(function(){window.location.hash= '#new';MessageManager.sendMMS.mSetup();MessageManager.sendSMS.mSetup();});teardown(function(){MessageManager.sendMMS.mTeardown();MessageManager.sendSMS.mTeardown();});test('SMS, 1 Recipient, stays in view', function(){ThreadUI.recipients.add({number: '999'});Compose.append('foo');ThreadUI.onSendClick();var calledWith=MessageManager.sendSMS.calledWith;assert.ok(MessageManager.sendSMS.called);assert.deepEqual(calledWith[0],['999']);assert.deepEqual(calledWith[1], 'foo');assert.equal(window.location.hash, '#new');});test('MMS, 1 Recipient, stays in view', function(){ThreadUI.recipients.add({number: '999'});Compose.append(mockAttachment(512));ThreadUI.onSendClick();assert.ok(MessageManager.sendMMS.called);assert.deepEqual(MessageManager.sendMMS.calledWith[0],['999']);assert.equal(window.location.hash, '#new');});test('SMS, &gt;1 Recipient, moves to thread list', function(done){ThreadUI.recipients.add({number: '999'});ThreadUI.recipients.add({number: '888'});Compose.append('foo');window.onhashchange=function(){assert.equal(window.location.hash, '#thread&#45;list');window.onhashchange=null;done();};ThreadUI.onSendClick();var calledWith=MessageManager.sendSMS.calledWith;assert.ok(MessageManager.sendSMS.called);assert.deepEqual(calledWith[0],['999', '888']);assert.deepEqual(calledWith[1], 'foo');});test('MMS, &gt;1 Recipient, stays in view', function(){ThreadUI.recipients.add({number: '999'});ThreadUI.recipients.add({number: '888'});Compose.append(mockAttachment(512));ThreadUI.onSendClick();assert.ok(MessageManager.sendMMS.called);assert.deepEqual(MessageManager.sendMMS.calledWith[0],['999', '888']);assert.equal(window.location.hash, '#new');});});suite('Contact Picker Behavior(contactPickButton)', function(){setup(function(){this.sinon.spy(ThreadUI, 'assimilateRecipients');});test('assimilate called after mousedown on picker button', function(){ThreadUI.contactPickButton.dispatchEvent(new CustomEvent('mousedown'));assert.ok(ThreadUI.assimilateRecipients.called);});});suite('setMessageBody', function(){setup(function(){this.sinon.stub(Compose, 'clear');this.sinon.stub(Compose, 'append');this.sinon.stub(Compose, 'focus');});suite('with data', function(){var testText= 'testing';setup(function(){ThreadUI.setMessageBody(testText);});test('calls clear', function(){assert.ok(Compose.clear.called);});test('calls append with correct data', function(){assert.ok(Compose.append.calledWith(testText));});test('calls focus', function(){assert.ok(Compose.focus.called);});});suite('without data', function(){var testText= '';setup(function(){ThreadUI.setMessageBody(testText);});test('calls clear', function(){assert.ok(Compose.clear.called);});test('does not call append with empty data', function(){assert.isFalse(Compose.append.called);});test('calls focus', function(){assert.ok(Compose.focus.called);});});});suite('recipient handling &gt;', function(){var localize;setup(function(){location.hash= '#new';localize=this.sinon.spy(navigator.mozL10n, 'localize');});teardown(function(){location.hash= '';});function testPickButtonEnabled(){test('pick button is enabled', function(){var pickButton=ThreadUI.contactPickButton;assert.isFalse(pickButton.classList.contains('disabled'));});}suite('no recipients', function(){setup(function(){ThreadUI.updateComposerHeader();});test('header is correct', function(){assert.deepEqual(localize.args[0],[ThreadUI.headerText, 'newMessage']);});testPickButtonEnabled();});suite('add one recipient', function(){setup(function(){ThreadUI.recipients.add({number: '999'});});test('header is correct', function(){assert.deepEqual(localize.args[0],[ThreadUI.headerText, 'recipient',{n:1}]);});testPickButtonEnabled();});suite('add two recipients', function(){setup(function(){ThreadUI.recipients.add({number: '999'});ThreadUI.recipients.add({number: '888'});});test('header is correct', function(){assert.ok(localize.calledTwice);assert.deepEqual(localize.args[1],[ThreadUI.headerText, 'recipient',{n:2}]);});testPickButtonEnabled();});});suite('initSentAudio', function(){test('calling function does not throw uncaught exception ', function(){assert.doesNotThrow(ThreadUI.initSentAudio);});});})" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d8/d0f/startup__events__test_8js.html#adac6c636af235a329cc774937d75601b">suite</a> </td>
          <td>(</td>
          <td class="paramtype">'thread_ui.&#160;</td>
          <td class="paramname"><em>js</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">'&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>変数</h2>
<a class="anchor" id="aebcc27c0d7c71338b1ecc8fcf07e85c7"></a><!-- doxytag: member="thread_ui_test.js::mocksHelperForThreadUI" ref="aebcc27c0d7c71338b1ecc8fcf07e85c7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">var <a class="el" href="../../d9/d25/thread__ui__test_8js.html#aebcc27c0d7c71338b1ecc8fcf07e85c7">mocksHelperForThreadUI</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>初期値:</b><div class="fragment"><pre class="fragment"> <span class="keyword">new</span> <a class="code" href="../../d1/d67/apps_2communications_2test_2unit_2mocks__helper_8js.html#ac677357b5a0ce4a59a54e9a0a861f480">MocksHelper</a>([
  <span class="stringliteral">&#39;Attachment&#39;</span>,
  <span class="stringliteral">&#39;AttachmentMenu&#39;</span>,
  <span class="stringliteral">&#39;Utils&#39;</span>,
  <span class="stringliteral">&#39;Settings&#39;</span>,
  <span class="stringliteral">&#39;Recipients&#39;</span>,
  <span class="stringliteral">&#39;LinkActionHandler&#39;</span>,
  <span class="stringliteral">&#39;LinkHelper&#39;</span>,
  <span class="stringliteral">&#39;MozActivity&#39;</span>,
  <span class="stringliteral">&#39;MozSmsFilter&#39;</span>,
  <span class="stringliteral">&#39;ActivityPicker&#39;</span>,
  <span class="stringliteral">&#39;OptionMenu&#39;</span>,
  <span class="stringliteral">&#39;Dialog&#39;</span>,
  <span class="stringliteral">&#39;Contacts&#39;</span>,
  <span class="stringliteral">&#39;SMIL&#39;</span>
])
</pre></div>
<p> <a class="el" href="../../d9/d25/thread__ui__test_8js_source.html">thread_ui_test.js</a> の <a class="el" href="../../d9/d25/thread__ui__test_8js_source.html#l00040">40</a> 行で定義されています。</p>

</div>
</div>
<a class="anchor" id="ae2475e10618961c050dcba04e8c42331"></a><!-- doxytag: member="thread_ui_test.js::strict" ref="ae2475e10618961c050dcba04e8c42331" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d7/d1b/test-agent-server_8js.html#aab71dcc804ca4aa3ed2bf7ba887635db">use</a> <a class="el" href="../../de/dc5/jsfriendapi_8h.html#a8cddd7ed2617ebace48da2e8e44f267c">strict</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p> <a class="el" href="../../d9/d25/thread__ui__test_8js_source.html">thread_ui_test.js</a> の <a class="el" href="../../d9/d25/thread__ui__test_8js_source.html#l00001">1</a> 行で定義されています。</p>

</div>
</div>
</div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d9/d25/thread__ui__test_8js.html">thread_ui_test.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:58:05に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
