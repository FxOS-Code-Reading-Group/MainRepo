<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>FxOS Code Reading: main-frame-setup.js ソースファイル</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FxOS Code Reading
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- 作成： Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>メインページ</span></a></li>
      <li><a href="../../pages.html"><span>関連ページ</span></a></li>
      <li><a href="../../modules.html"><span>モジュール</span></a></li>
      <li><a href="../../namespaces.html"><span>パッケージ</span></a></li>
      <li><a href="../../annotated.html"><span>データ構造</span></a></li>
      <li class="current"><a href="../../files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>ファイル一覧</span></a></li>
      <li><a href="../../globals.html"><span>グローバル</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('d3/da0/apps_2email_2js_2ext_2mailapi_2main-frame-setup_8js.html','../../');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">main-frame-setup.js</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d3/da0/apps_2email_2js_2ext_2mailapi_2main-frame-setup_8js.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 (<span class="keyword">function</span> () {
<a name="l00003"></a>00003   <span class="comment">// Like setTimeout, but only takes a function argument.  There&#39;s</span>
<a name="l00004"></a>00004   <span class="comment">// no time argument (always zero) and no arguments (you have to</span>
<a name="l00005"></a>00005   <span class="comment">// use a closure).</span>
<a name="l00006"></a>00006   <span class="keyword">function</span> setZeroTimeout(fn) {
<a name="l00007"></a>00007     <a class="code" href="../../da/da1/timers_8js.html#a619d004395c481cc1032f1c3747a04b9">setTimeout</a>(fn);
<a name="l00008"></a>00008   }
<a name="l00009"></a>00009 
<a name="l00010"></a>00010   <span class="comment">// Add the one thing we want added to the window object.</span>
<a name="l00011"></a>00011   <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setZeroTimeout = setZeroTimeout;
<a name="l00012"></a>00012 }());
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&quot;mailapi/worker-support/shim-sham&quot;</span>, <span class="keyword">function</span>(){});
<a name="l00015"></a>00015 
<a name="l00020"></a>00020 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/mailapi&#39;</span>,
<a name="l00021"></a>00021   [
<a name="l00022"></a>00022     <span class="stringliteral">&#39;exports&#39;</span>
<a name="l00023"></a>00023   ],
<a name="l00024"></a>00024   <span class="keyword">function</span>(
<a name="l00025"></a>00025     <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>
<a name="l00026"></a>00026   ) {
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="keyword">function</span> objCopy(<a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>) {
<a name="l00029"></a>00029   var <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a262add591dbf3cb720cb49ac89edcf02">copy</a> = {};
<a name="l00030"></a>00030   Object.keys(<a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>).forEach(<span class="keyword">function</span> (<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>) {
<a name="l00031"></a>00031     copy[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>] = <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>[<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>];
<a name="l00032"></a>00032   });
<a name="l00033"></a>00033   <span class="keywordflow">return</span> <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a262add591dbf3cb720cb49ac89edcf02">copy</a>;
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 
<a name="l00039"></a>00039 var HEADER_CACHE_LIMIT = 8;
<a name="l00040"></a>00040 
<a name="l00044"></a>00044 <span class="keyword">function</span> MailAccount(api, wireRep, acctsSlice) {
<a name="l00045"></a>00045   this._api = api;
<a name="l00046"></a>00046   this.<span class="keywordtype">id</span> = wireRep.id;
<a name="l00047"></a>00047 
<a name="l00048"></a>00048   <span class="comment">// Hold on to wireRep for caching</span>
<a name="l00049"></a>00049   this._wireRep = wireRep;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   <span class="comment">// Hold on to acctsSlice for use in determining default account.</span>
<a name="l00052"></a>00052   this.acctsSlice = acctsSlice;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054   this.<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = wireRep.type;
<a name="l00055"></a>00055   this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> = wireRep.name;
<a name="l00056"></a>00056   this.syncRange = wireRep.syncRange;
<a name="l00057"></a>00057   this.syncInterval = wireRep.syncInterval;
<a name="l00058"></a>00058   this.notifyOnNew = wireRep.notifyOnNew;
<a name="l00059"></a>00059 
<a name="l00069"></a>00069   this.<a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a> = wireRep.enabled;
<a name="l00086"></a>00086   this.problems = wireRep.problems;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   this.identities = [];
<a name="l00089"></a>00089   <span class="keywordflow">for</span> (var iIdent = 0; iIdent &lt; wireRep.identities.length; iIdent++) {
<a name="l00090"></a>00090     this.identities.push(<span class="keyword">new</span> MailSenderIdentity(this._api,
<a name="l00091"></a>00091                                                 wireRep.identities[iIdent]));
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   this.username = wireRep.credentials.username;
<a name="l00095"></a>00095   this.servers = wireRep.servers;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097   <span class="comment">// build a place for the DOM element and arbitrary data into our shape</span>
<a name="l00098"></a>00098   this.element = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00099"></a>00099   this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 MailAccount.prototype = {
<a name="l00102"></a>00102   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l00103"></a>00103     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailAccount: &#39;</span> + this.<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> + <span class="charliteral">&#39; &#39;</span> + this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l00104"></a>00104   },
<a name="l00105"></a>00105   toJSON: <span class="keyword">function</span>() {
<a name="l00106"></a>00106     <span class="keywordflow">return</span> {
<a name="l00107"></a>00107       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MailAccount&#39;</span>,
<a name="l00108"></a>00108       accountType: this.<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>,
<a name="l00109"></a>00109       <span class="keywordtype">id</span>: this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>,
<a name="l00110"></a>00110     };
<a name="l00111"></a>00111   },
<a name="l00112"></a>00112 
<a name="l00113"></a>00113   __update: <span class="keyword">function</span>(wireRep) {
<a name="l00114"></a>00114     this.<a class="code" href="../../d2/d7d/jsapi_8h.html#ad40d8437f6cf8675f077c4117119c8c0">enabled</a> = wireRep.enabled;
<a name="l00115"></a>00115     this.problems = wireRep.problems;
<a name="l00116"></a>00116     this.syncInterval = wireRep.syncInterval;
<a name="l00117"></a>00117     this.notifyOnNew = wireRep.notifyOnNew;
<a name="l00118"></a>00118     this._wireRep.defaultPriority = wireRep.defaultPriority;
<a name="l00119"></a>00119   },
<a name="l00120"></a>00120 
<a name="l00121"></a>00121   __die: <span class="keyword">function</span>() {
<a name="l00122"></a>00122     <span class="comment">// currently, nothing to clean up</span>
<a name="l00123"></a>00123   },
<a name="l00124"></a>00124 
<a name="l00129"></a>00129   clearProblems: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00130"></a>00130     this._api._clearAccountProblems(<span class="keyword">this</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00131"></a>00131   },
<a name="l00132"></a>00132 
<a name="l00144"></a>00144   modifyAccount: <span class="keyword">function</span>(mods) {
<a name="l00145"></a>00145     this._api._modifyAccount(<span class="keyword">this</span>, mods);
<a name="l00146"></a>00146   },
<a name="l00147"></a>00147 
<a name="l00153"></a>00153   deleteAccount: <span class="keyword">function</span>() {
<a name="l00154"></a>00154     this._api._deleteAccount(<span class="keyword">this</span>);
<a name="l00155"></a>00155   },
<a name="l00156"></a>00156 
<a name="l00161"></a>00161   <span class="keyword">get</span> isDefault() {
<a name="l00162"></a>00162     <span class="keywordflow">if</span> (!this.acctsSlice)
<a name="l00163"></a>00163       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;No account slice available&#39;</span>);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="keywordflow">return</span> this.acctsSlice.defaultAccount === <span class="keyword">this</span>;
<a name="l00166"></a>00166   },
<a name="l00167"></a>00167 };
<a name="l00168"></a>00168 
<a name="l00179"></a>00179 <span class="keyword">function</span> MailSenderIdentity(api, wireRep) {
<a name="l00180"></a>00180   <span class="comment">// We store the API so that we can create identities for the composer without</span>
<a name="l00181"></a>00181   <span class="comment">// needing to create an account too.</span>
<a name="l00182"></a>00182   this._api = api;
<a name="l00183"></a>00183   this.<span class="keywordtype">id</span> = wireRep.id;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185   this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> = wireRep.name;
<a name="l00186"></a>00186   this.<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a> = wireRep.address;
<a name="l00187"></a>00187   this.replyTo = wireRep.replyTo;
<a name="l00188"></a>00188   this.signature = wireRep.signature;
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 MailSenderIdentity.prototype = {
<a name="l00191"></a>00191   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l00192"></a>00192     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailSenderIdentity: &#39;</span> + this.<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> + <span class="charliteral">&#39; &#39;</span> + this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l00193"></a>00193   },
<a name="l00194"></a>00194   toJSON: <span class="keyword">function</span>() {
<a name="l00195"></a>00195     <span class="keywordflow">return</span> { <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MailSenderIdentity&#39;</span> };
<a name="l00196"></a>00196   },
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   __die: <span class="keyword">function</span>() {
<a name="l00199"></a>00199     <span class="comment">// nothing to clean up currently</span>
<a name="l00200"></a>00200   },
<a name="l00201"></a>00201 };
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="keyword">function</span> MailFolder(api, wireRep) {
<a name="l00204"></a>00204   this._api = api;
<a name="l00205"></a>00205   this.<span class="keywordtype">id</span> = wireRep.id;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="comment">// Hold on to wireRep for caching</span>
<a name="l00208"></a>00208   this._wireRep = wireRep;
<a name="l00209"></a>00209 
<a name="l00214"></a>00214   this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> = wireRep.name;
<a name="l00218"></a>00218   this.<a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a> = wireRep.path;
<a name="l00222"></a>00222   this.depth = wireRep.depth;
<a name="l00253"></a>00253   this.<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = wireRep.type;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   <span class="comment">// Exchange folder name with the localized version if available</span>
<a name="l00256"></a>00256   this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> = this._api.l10n_folder_name(this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, this.<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258   this.__update(wireRep);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260   this.selectable = (wireRep.type !== <span class="stringliteral">&#39;account&#39;</span>) &amp;&amp; (wireRep.type !== <span class="stringliteral">&#39;nomail&#39;</span>);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262   this.<a class="code" href="../../db/d0b/_image_editor_8js.html#a7f35c89c0669debd60f931b98aeffd06">onchange</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00263"></a>00263   this.onremove = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265   <span class="comment">// build a place for the DOM element and arbitrary data into our shape</span>
<a name="l00266"></a>00266   this.element = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00267"></a>00267   this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 MailFolder.prototype = {
<a name="l00270"></a>00270   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l00271"></a>00271     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailFolder: &#39;</span> + this.<a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l00272"></a>00272   },
<a name="l00273"></a>00273   toJSON: <span class="keyword">function</span>() {
<a name="l00274"></a>00274     <span class="keywordflow">return</span> {
<a name="l00275"></a>00275       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MailFolder&#39;</span>,
<a name="l00276"></a>00276       <a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>: this.<a class="code" href="../../db/d6d/mkdirp_8js.html#aa72e0c8a20e6bcc571d3a1c51846e627">path</a>
<a name="l00277"></a>00277     };
<a name="l00278"></a>00278   },
<a name="l00279"></a>00279 
<a name="l00280"></a>00280   __update: <span class="keyword">function</span>(wireRep) {
<a name="l00281"></a>00281     this.lastSyncedAt = wireRep.lastSyncedAt ? <span class="keyword">new</span> Date(wireRep.lastSyncedAt)
<a name="l00282"></a>00282                                              : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00283"></a>00283   },
<a name="l00284"></a>00284 
<a name="l00285"></a>00285   __die: <span class="keyword">function</span>() {
<a name="l00286"></a>00286     <span class="comment">// currently nothing to clean up</span>
<a name="l00287"></a>00287   }
<a name="l00288"></a>00288 };
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="keyword">function</span> filterOutBuiltinFlags(<a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>) {
<a name="l00291"></a>00291   <span class="comment">// so, we could mutate in-place if we were sure the wire rep actually came</span>
<a name="l00292"></a>00292   <span class="comment">// over the wire.  Right now there is de facto rep sharing, so let&#39;s not</span>
<a name="l00293"></a>00293   <span class="comment">// mutate and screw ourselves over.</span>
<a name="l00294"></a>00294   var outFlags = [];
<a name="l00295"></a>00295   <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = <a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>.length - 1; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &gt;= 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>--) {
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (<a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>][0] !== <span class="charliteral">&#39;\\&#39;</span>)
<a name="l00297"></a>00297       outFlags.push(<a class="code" href="../../da/d32/prio_8h.html#aa2585d779da0ab21273a8d92de9a0ebe">flags</a>[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]);
<a name="l00298"></a>00298   }
<a name="l00299"></a>00299   <span class="keywordflow">return</span> outFlags;
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00305"></a>00305 <span class="keyword">function</span> serializeMessageName(x) {
<a name="l00306"></a>00306   <span class="keywordflow">return</span> {
<a name="l00307"></a>00307     <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: x.date.valueOf(),
<a name="l00308"></a>00308     suid: x.id,
<a name="l00309"></a>00309     <span class="comment">// NB: strictly speaking, this is redundant information.  However, it is</span>
<a name="l00310"></a>00310     <span class="comment">// also fairly handy to pass around for IMAP since otherwise we might need</span>
<a name="l00311"></a>00311     <span class="comment">// to perform header lookups later on.  It will likely also be useful for</span>
<a name="l00312"></a>00312     <span class="comment">// debugging.  But ideally we would not include this.</span>
<a name="l00313"></a>00313     guid: x.guid
<a name="l00314"></a>00314   };
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00339"></a>00339 var ContactCache = <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.ContactCache = {
<a name="l00350"></a>00350   _contactCache: Object.create(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>),
<a name="l00352"></a>00352   _cacheHitEntries: 0,
<a name="l00354"></a>00354   _cacheEmptyEntries: 0,
<a name="l00355"></a>00355 
<a name="l00360"></a>00360   MAX_CACHE_HITS: 256,
<a name="l00362"></a>00362   MAX_CACHE_EMPTY: 1024,
<a name="l00363"></a>00363 
<a name="l00365"></a>00365   _livePeepsById: Object.create(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>),
<a name="l00367"></a>00367   _livePeepsByEmail: Object.create(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>),
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   pendingLookupCount: 0,
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   <a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a>: [],
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <a class="code" href="../../db/dc0/mock__fb_8js.html#ae9b28e7b58edd8f38cd717eed7b3deb4">init</a>: <span class="keyword">function</span>() {
<a name="l00374"></a>00374     var contactsAPI = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozContacts;
<a name="l00375"></a>00375     <span class="keywordflow">if</span> (!contactsAPI)
<a name="l00376"></a>00376       <span class="keywordflow">return</span>;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     contactsAPI.oncontactchange = this._onContactChange.bind(<span class="keyword">this</span>);
<a name="l00379"></a>00379   },
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   _resetCache: <span class="keyword">function</span>() {
<a name="l00382"></a>00382     this._contactCache = Object.create(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00383"></a>00383     this._cacheHitEntries = 0;
<a name="l00384"></a>00384     this._cacheEmptyEntries = 0;
<a name="l00385"></a>00385   },
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <span class="keyword">function</span>() {
<a name="l00388"></a>00388     var contactsAPI = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozContacts;
<a name="l00389"></a>00389     <span class="keywordflow">if</span> (!contactsAPI)
<a name="l00390"></a>00390       <span class="keywordflow">return</span>;
<a name="l00391"></a>00391     contactsAPI.oncontactchange = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00392"></a>00392   },
<a name="l00393"></a>00393 
<a name="l00409"></a>00409   _onContactChange: <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l00410"></a>00410     var contactsAPI = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozContacts;
<a name="l00411"></a>00411     var livePeepsById = this._livePeepsById,
<a name="l00412"></a>00412         livePeepsByEmail = this._livePeepsByEmail;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="comment">// clear the cache if it has anything in it (per the above doc block)</span>
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (this._cacheHitEntries || this._cacheEmptyEntries)
<a name="l00416"></a>00416       this._resetCache();
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="comment">// -- Contact removed OR all contacts removed!</span>
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.reason === <span class="stringliteral">&#39;remove&#39;</span>) {
<a name="l00420"></a>00420       <span class="keyword">function</span> cleanOutPeeps(livePeeps) {
<a name="l00421"></a>00421         <span class="keywordflow">for</span> (var iPeep = 0; iPeep &lt; livePeeps.length; iPeep++) {
<a name="l00422"></a>00422           var peep = livePeeps[iPeep];
<a name="l00423"></a>00423           peep.contactId = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00424"></a>00424           <span class="keywordflow">if</span> (peep.onchange) {
<a name="l00425"></a>00425             <span class="keywordflow">try</span> {
<a name="l00426"></a>00426               peep.onchange(peep);
<a name="l00427"></a>00427             }
<a name="l00428"></a>00428             <span class="keywordflow">catch</span> (ex) {
<a name="l00429"></a>00429               reportClientCodeError(<span class="stringliteral">&#39;peep.onchange error&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l00430"></a>00430                                     ex.stack);
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432           }
<a name="l00433"></a>00433         }
<a name="l00434"></a>00434       }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436       <span class="comment">// - all contacts removed! (clear() called)</span>
<a name="l00437"></a>00437       var livePeeps;
<a name="l00438"></a>00438       <span class="keywordflow">if</span> (!<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.contactID) {
<a name="l00439"></a>00439         <span class="keywordflow">for</span> (var contactId in livePeepsById) {
<a name="l00440"></a>00440           livePeeps = livePeepsById[contactId];
<a name="l00441"></a>00441           cleanOutPeeps(livePeeps);
<a name="l00442"></a>00442           this._livePeepsById = Object.create(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444       }
<a name="l00445"></a>00445       <span class="comment">// - just one contact removed</span>
<a name="l00446"></a>00446       <span class="keywordflow">else</span> {
<a name="l00447"></a>00447         livePeeps = livePeepsById[<span class="keyword">event</span>.contactID];
<a name="l00448"></a>00448         <span class="keywordflow">if</span> (livePeeps) {
<a name="l00449"></a>00449           cleanOutPeeps(livePeeps);
<a name="l00450"></a>00450           <span class="keyword">delete</span> livePeepsById[<span class="keyword">event</span>.contactID];
<a name="l00451"></a>00451         }
<a name="l00452"></a>00452       }
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454     <span class="comment">// -- Created or updated; we need to fetch the contact to investigate</span>
<a name="l00455"></a>00455     <span class="keywordflow">else</span> {
<a name="l00456"></a>00456       var <a class="code" href="../../d5/dbd/camera_2js_2camera_8js.html#a42c43c76081a7df8ae2954f16ee9338b">req</a> = contactsAPI.find({
<a name="l00457"></a>00457         filterBy: [<span class="stringliteral">&#39;id&#39;</span>],
<a name="l00458"></a>00458         filterOp: <span class="stringliteral">&#39;equals&#39;</span>,
<a name="l00459"></a>00459         filterValue: <span class="keyword">event</span>.contactID
<a name="l00460"></a>00460       });
<a name="l00461"></a>00461       req.onsuccess = <span class="keyword">function</span>() {
<a name="l00462"></a>00462         <span class="comment">// If the contact disappeared we will hear a &#39;remove&#39; event and so don&#39;t</span>
<a name="l00463"></a>00463         <span class="comment">// need to process this.</span>
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (!req.result.length)
<a name="l00465"></a>00465           <span class="keywordflow">return</span>;
<a name="l00466"></a>00466         var <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a> = req.result[0], livePeeps, iPeep, peep;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         <span class="comment">// - process update with apparent e-mail address removal</span>
<a name="l00469"></a>00469         <span class="keywordflow">if</span> (<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.reason === <span class="stringliteral">&#39;update&#39;</span>) {
<a name="l00470"></a>00470           livePeeps = livePeepsById[contact.id];
<a name="l00471"></a>00471           <span class="keywordflow">if</span> (livePeeps) {
<a name="l00472"></a>00472             var contactEmails = contact.email ?
<a name="l00473"></a>00473                   contact.email.map(<span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) { <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.value; }) :
<a name="l00474"></a>00474                 [];
<a name="l00475"></a>00475             <span class="keywordflow">for</span> (iPeep = 0; iPeep &lt; livePeeps.length; iPeep++) {
<a name="l00476"></a>00476               peep = livePeeps[iPeep];
<a name="l00477"></a>00477               <span class="keywordflow">if</span> (contactEmails.indexOf(peep.address) === -1) {
<a name="l00478"></a>00478                 <span class="comment">// Need to fix-up iPeep because of the splice; reverse iteration</span>
<a name="l00479"></a>00479                 <span class="comment">// reorders our notifications and we don&#39;t want that, hence</span>
<a name="l00480"></a>00480                 <span class="comment">// this.</span>
<a name="l00481"></a>00481                 livePeeps.splice(iPeep--, 1);
<a name="l00482"></a>00482                 peep.contactId = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00483"></a>00483                 <span class="keywordflow">if</span> (peep.onchange) {
<a name="l00484"></a>00484                   <span class="keywordflow">try</span> {
<a name="l00485"></a>00485                     peep.onchange(peep);
<a name="l00486"></a>00486                   }
<a name="l00487"></a>00487                   <span class="keywordflow">catch</span> (ex) {
<a name="l00488"></a>00488                     reportClientCodeError(<span class="stringliteral">&#39;peep.onchange error&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l00489"></a>00489                                           ex.stack);
<a name="l00490"></a>00490                   }
<a name="l00491"></a>00491                 }
<a name="l00492"></a>00492               }
<a name="l00493"></a>00493             }
<a name="l00494"></a>00494             <span class="keywordflow">if</span> (livePeeps.length === 0)
<a name="l00495"></a>00495               <span class="keyword">delete</span> livePeepsById[contact.id];
<a name="l00496"></a>00496           }
<a name="l00497"></a>00497         }
<a name="l00498"></a>00498         <span class="comment">// - process create/update causing new coverage</span>
<a name="l00499"></a>00499         <span class="keywordflow">if</span> (!contact.email)
<a name="l00500"></a>00500           <span class="keywordflow">return</span>;
<a name="l00501"></a>00501         <span class="keywordflow">for</span> (var iEmail = 0; iEmail &lt; contact.email.length; iEmail++) {
<a name="l00502"></a>00502           var email = contact.email[iEmail].value;
<a name="l00503"></a>00503           livePeeps = livePeepsByEmail[email];
<a name="l00504"></a>00504           <span class="comment">// nothing to do if there are no peeps that use that email address</span>
<a name="l00505"></a>00505           <span class="keywordflow">if</span> (!livePeeps)
<a name="l00506"></a>00506             <span class="keywordflow">continue</span>;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508           <span class="keywordflow">for</span> (iPeep = 0; iPeep &lt; livePeeps.length; iPeep++) {
<a name="l00509"></a>00509             peep = livePeeps[iPeep];
<a name="l00510"></a>00510             <span class="comment">// If the peep is not yet associated with this contact or any other</span>
<a name="l00511"></a>00511             <span class="comment">// contact, then associate it.</span>
<a name="l00512"></a>00512             <span class="keywordflow">if</span> (!peep.contactId) {
<a name="l00513"></a>00513               peep.contactId = contact.id;
<a name="l00514"></a>00514               var idLivePeeps = livePeepsById[peep.contactId];
<a name="l00515"></a>00515               <span class="keywordflow">if</span> (idLivePeeps === undefined)
<a name="l00516"></a>00516                 idLivePeeps = livePeepsById[peep.contactId] = [];
<a name="l00517"></a>00517               idLivePeeps.push(peep);
<a name="l00518"></a>00518             }
<a name="l00519"></a>00519             <span class="comment">// However, if it&#39;s associated with a different contact, then just</span>
<a name="l00520"></a>00520             <span class="comment">// skip the peep.</span>
<a name="l00521"></a>00521             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (peep.contactId !== contact.id) {
<a name="l00522"></a>00522               <span class="keywordflow">continue</span>;
<a name="l00523"></a>00523             }
<a name="l00524"></a>00524             <span class="comment">// (The peep must be associated with this contact, so update and</span>
<a name="l00525"></a>00525             <span class="comment">// fire)</span>
<a name="l00526"></a>00526 
<a name="l00527"></a>00527             <span class="keywordflow">if</span> (contact.name &amp;&amp; contact.name.length)
<a name="l00528"></a>00528               peep.name = contact.name[0];
<a name="l00529"></a>00529             <span class="keywordflow">if</span> (peep.onchange) {
<a name="l00530"></a>00530               <span class="keywordflow">try</span> {
<a name="l00531"></a>00531                 peep.onchange(peep);
<a name="l00532"></a>00532               }
<a name="l00533"></a>00533               <span class="keywordflow">catch</span> (ex) {
<a name="l00534"></a>00534                 reportClientCodeError(<span class="stringliteral">&#39;peep.onchange error&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l00535"></a>00535                                       ex.stack);
<a name="l00536"></a>00536               }
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538           }
<a name="l00539"></a>00539         }
<a name="l00540"></a>00540       };
<a name="l00541"></a>00541       <span class="comment">// We don&#39;t need to do anything about onerror; the &#39;remove&#39; event will</span>
<a name="l00542"></a>00542       <span class="comment">// probably have fired in this case, making us correct.</span>
<a name="l00543"></a>00543     }
<a name="l00544"></a>00544   },
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   resolvePeeps: <span class="keyword">function</span>(addressPairs) {
<a name="l00547"></a>00547     <span class="keywordflow">if</span> (addressPairs == <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l00548"></a>00548       <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00549"></a>00549     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a56cccbaafc97c9162274032216ba8c39">resolved</a> = [];
<a name="l00550"></a>00550     <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; addressPairs.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00551"></a>00551       resolved.push(this.resolvePeep(addressPairs[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]));
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553     <span class="keywordflow">return</span> <a class="code" href="../../d2/d7d/jsapi_8h.html#a56cccbaafc97c9162274032216ba8c39">resolved</a>;
<a name="l00554"></a>00554   },
<a name="l00570"></a>00570   resolvePeep: <span class="keyword">function</span>(addressPair) {
<a name="l00571"></a>00571     var emailAddress = addressPair.<a class="code" href="../../df/dfb/class_j_s_1_1_handle.html#ad2b2ee4b6f81b3fb6b13cca84718d810">address</a>;
<a name="l00572"></a>00572     var entry = this._contactCache[emailAddress], <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>, peep;
<a name="l00573"></a>00573     var contactsAPI = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozContacts;
<a name="l00574"></a>00574     <span class="comment">// known miss; create miss peep</span>
<a name="l00575"></a>00575     <span class="comment">// no contacts API, always a miss, skip out before extra logic happens</span>
<a name="l00576"></a>00576     <span class="keywordflow">if</span> (entry === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> || !contactsAPI) {
<a name="l00577"></a>00577       peep = <span class="keyword">new</span> MailPeep(addressPair.name || <span class="stringliteral">&#39;&#39;</span>, emailAddress, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00578"></a>00578       <span class="keywordflow">if</span> (!contactsAPI)
<a name="l00579"></a>00579         <span class="keywordflow">return</span> peep;
<a name="l00580"></a>00580     }
<a name="l00581"></a>00581     <span class="comment">// known contact; unpack contact info</span>
<a name="l00582"></a>00582     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (entry !== undefined) {
<a name="l00583"></a>00583       var <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a> = addressPair.name || <span class="stringliteral">&#39;&#39;</span>;
<a name="l00584"></a>00584       <span class="keywordflow">if</span> (entry.name &amp;&amp; entry.name.length)
<a name="l00585"></a>00585         name = entry.name[0];
<a name="l00586"></a>00586       peep = <span class="keyword">new</span> MailPeep(
<a name="l00587"></a>00587         name,
<a name="l00588"></a>00588         emailAddress,
<a name="l00589"></a>00589         entry.id,
<a name="l00590"></a>00590         (entry.photo &amp;&amp; entry.photo.length) ? entry.photo[0] : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592     <span class="comment">// not yet looked-up; assume it&#39;s a miss and we&#39;ll fix-up if it&#39;s a hit</span>
<a name="l00593"></a>00593     <span class="keywordflow">else</span> {
<a name="l00594"></a>00594       peep = <span class="keyword">new</span> MailPeep(addressPair.name || <span class="stringliteral">&#39;&#39;</span>,
<a name="l00595"></a>00595                           emailAddress, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597       <span class="comment">// Place a speculative miss in the contact cache so that additional</span>
<a name="l00598"></a>00598       <span class="comment">// requests take that path.  They will get fixed up when our lookup</span>
<a name="l00599"></a>00599       <span class="comment">// returns (or if a change event happens to come in before our lookup</span>
<a name="l00600"></a>00600       <span class="comment">// returns.)  Note that we do not do any hit/miss counting right now; we</span>
<a name="l00601"></a>00601       <span class="comment">// wait for the result to come back.</span>
<a name="l00602"></a>00602       this._contactCache[emailAddress] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00603"></a>00603 
<a name="l00604"></a>00604       this.pendingLookupCount++;
<a name="l00605"></a>00605       var req = contactsAPI.find({
<a name="l00606"></a>00606                   filterBy: [<span class="stringliteral">&#39;email&#39;</span>],
<a name="l00607"></a>00607                   filterOp: <span class="stringliteral">&#39;equals&#39;</span>,
<a name="l00608"></a>00608                   filterValue: emailAddress
<a name="l00609"></a>00609                 });
<a name="l00610"></a>00610       var <span class="keyword">self</span> = <span class="keyword">this</span>, handleResult = <span class="keyword">function</span>() {
<a name="l00611"></a>00611         <span class="keywordflow">if</span> (req.result &amp;&amp; req.result.length) {
<a name="l00612"></a>00612           var contact = req.result[0];
<a name="l00613"></a>00613 
<a name="l00614"></a>00614           ContactCache._contactCache[emailAddress] = <a class="code" href="../../d7/d91/contacts__matcher__test_8js.html#abbe82a925239cd8211cf7e835d3d20e1">contact</a>;
<a name="l00615"></a>00615           <span class="keywordflow">if</span> (++ContactCache._cacheHitEntries &gt; ContactCache.MAX_CACHE_HITS)
<a name="l00616"></a>00616             <span class="keyword">self</span>._resetCache();
<a name="l00617"></a>00617 
<a name="l00618"></a>00618           var peepsToFixup = <span class="keyword">self</span>._livePeepsByEmail[emailAddress];
<a name="l00619"></a>00619           <span class="comment">// there might no longer be any MailPeeps alive to care; leave</span>
<a name="l00620"></a>00620           <span class="keywordflow">if</span> (!peepsToFixup)
<a name="l00621"></a>00621             <span class="keywordflow">return</span>;
<a name="l00622"></a>00622           <span class="keywordflow">for</span> (var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; peepsToFixup.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00623"></a>00623             var peep = peepsToFixup[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l00624"></a>00624             <span class="keywordflow">if</span> (!peep.contactId) {
<a name="l00625"></a>00625               peep.contactId = contact.id;
<a name="l00626"></a>00626               var livePeeps = <span class="keyword">self</span>._livePeepsById[peep.contactId];
<a name="l00627"></a>00627               <span class="keywordflow">if</span> (livePeeps === undefined)
<a name="l00628"></a>00628                 livePeeps = <span class="keyword">self</span>._livePeepsById[peep.contactId] = [];
<a name="l00629"></a>00629               livePeeps.push(peep);
<a name="l00630"></a>00630             }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632             <span class="keywordflow">if</span> (contact.name &amp;&amp; contact.name.length)
<a name="l00633"></a>00633               peep.name = contact.name[0];
<a name="l00634"></a>00634             <span class="keywordflow">if</span> (contact.photo &amp;&amp; contact.photo.length)
<a name="l00635"></a>00635               peep._thumbnailBlob = contact.photo[0];
<a name="l00636"></a>00636 
<a name="l00637"></a>00637             <span class="comment">// If no one is waiting for our/any request to complete, generate an</span>
<a name="l00638"></a>00638             <span class="comment">// onchange notification.</span>
<a name="l00639"></a>00639             <span class="keywordflow">if</span> (!<span class="keyword">self</span>.<a class="code" href="../../d2/d7d/jsapi_8h.html#a25a0884792aa259d1818e7f66ffa3937">callbacks</a>.length) {
<a name="l00640"></a>00640               <span class="keywordflow">if</span> (peep.onchange) {
<a name="l00641"></a>00641                 <span class="keywordflow">try</span> {
<a name="l00642"></a>00642                   peep.onchange(peep);
<a name="l00643"></a>00643                 }
<a name="l00644"></a>00644                 <span class="keywordflow">catch</span> (ex) {
<a name="l00645"></a>00645                   reportClientCodeError(<span class="stringliteral">&#39;peep.onchange error&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l00646"></a>00646                                         ex.stack);
<a name="l00647"></a>00647                 }
<a name="l00648"></a>00648               }
<a name="l00649"></a>00649             }
<a name="l00650"></a>00650           }
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652         <span class="keywordflow">else</span> {
<a name="l00653"></a>00653           ContactCache._contactCache[emailAddress] = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00654"></a>00654           <span class="keywordflow">if</span> (++ContactCache._cacheEmptyEntries &gt; ContactCache.MAX_CACHE_EMPTY)
<a name="l00655"></a>00655             <span class="keyword">self</span>._resetCache();
<a name="l00656"></a>00656         }
<a name="l00657"></a>00657         <span class="comment">// Only notify callbacks if all outstanding lookups have completed</span>
<a name="l00658"></a>00658         <span class="keywordflow">if</span> (--<span class="keyword">self</span>.pendingLookupCount === 0) {
<a name="l00659"></a>00659           <span class="keywordflow">for</span> (<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> &lt; ContactCache.callbacks.length; <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>++) {
<a name="l00660"></a>00660             ContactCache.callbacks[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>]();
<a name="l00661"></a>00661           }
<a name="l00662"></a>00662           ContactCache.callbacks.splice(0, ContactCache.callbacks.length);
<a name="l00663"></a>00663         }
<a name="l00664"></a>00664       };
<a name="l00665"></a>00665       req.onsuccess = handleResult;
<a name="l00666"></a>00666       req.onerror = handleResult;
<a name="l00667"></a>00667     }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="comment">// - track the peep in our lists of live peeps</span>
<a name="l00670"></a>00670     var livePeeps;
<a name="l00671"></a>00671     livePeeps = this._livePeepsByEmail[emailAddress];
<a name="l00672"></a>00672     <span class="keywordflow">if</span> (livePeeps === undefined)
<a name="l00673"></a>00673       livePeeps = this._livePeepsByEmail[emailAddress] = [];
<a name="l00674"></a>00674     livePeeps.push(peep);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keywordflow">if</span> (peep.contactId) {
<a name="l00677"></a>00677       livePeeps = this._livePeepsById[peep.contactId];
<a name="l00678"></a>00678       <span class="keywordflow">if</span> (livePeeps === undefined)
<a name="l00679"></a>00679         livePeeps = this._livePeepsById[peep.contactId] = [];
<a name="l00680"></a>00680       livePeeps.push(peep);
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <span class="keywordflow">return</span> peep;
<a name="l00684"></a>00684   },
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   forgetPeepInstances: <span class="keyword">function</span>() {
<a name="l00687"></a>00687     var livePeepsById = this._livePeepsById,
<a name="l00688"></a>00688         livePeepsByEmail = this._livePeepsByEmail;
<a name="l00689"></a>00689     <span class="keywordflow">for</span> (var iArg = 0; iArg &lt; arguments.length; iArg++) {
<a name="l00690"></a>00690       var peeps = arguments[iArg];
<a name="l00691"></a>00691       <span class="keywordflow">if</span> (!peeps)
<a name="l00692"></a>00692         <span class="keywordflow">continue</span>;
<a name="l00693"></a>00693       <span class="keywordflow">for</span> (var iPeep = 0; iPeep &lt; peeps.length; iPeep++) {
<a name="l00694"></a>00694         var peep = peeps[iPeep], livePeeps, idx;
<a name="l00695"></a>00695         <span class="keywordflow">if</span> (peep.contactId) {
<a name="l00696"></a>00696           livePeeps = livePeepsById[peep.contactId];
<a name="l00697"></a>00697           <span class="keywordflow">if</span> (livePeeps) {
<a name="l00698"></a>00698             idx = livePeeps.indexOf(peep);
<a name="l00699"></a>00699             <span class="keywordflow">if</span> (idx !== -1) {
<a name="l00700"></a>00700               livePeeps.splice(idx, 1);
<a name="l00701"></a>00701               <span class="keywordflow">if</span> (livePeeps.length === 0)
<a name="l00702"></a>00702                 <span class="keyword">delete</span> livePeepsById[peep.contactId];
<a name="l00703"></a>00703             }
<a name="l00704"></a>00704           }
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706         livePeeps = livePeepsByEmail[peep.address];
<a name="l00707"></a>00707         <span class="keywordflow">if</span> (livePeeps) {
<a name="l00708"></a>00708           idx = livePeeps.indexOf(peep);
<a name="l00709"></a>00709           <span class="keywordflow">if</span> (idx !== -1) {
<a name="l00710"></a>00710             livePeeps.splice(idx, 1);
<a name="l00711"></a>00711             <span class="keywordflow">if</span> (livePeeps.length === 0)
<a name="l00712"></a>00712               <span class="keyword">delete</span> livePeepsByEmail[peep.address];
<a name="l00713"></a>00713           }
<a name="l00714"></a>00714         }
<a name="l00715"></a>00715       }
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717   },
<a name="l00718"></a>00718 };
<a name="l00719"></a>00719 
<a name="l00720"></a>00720 <span class="keyword">function</span> revokeImageSrc() {
<a name="l00721"></a>00721   <span class="comment">// see showBlobInImg below for the rationale for useWin.</span>
<a name="l00722"></a>00722   var useWin = this.ownerDocument.defaultView || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>;
<a name="l00723"></a>00723   useWin.URL.revokeObjectURL(this.src);
<a name="l00724"></a>00724 }
<a name="l00725"></a>00725 <span class="keyword">function</span> showBlobInImg(imgNode, blob) {
<a name="l00726"></a>00726   <span class="comment">// We need to look at the image node because object URLs are scoped per</span>
<a name="l00727"></a>00727   <span class="comment">// document, and for HTML e-mails, we use an iframe that lives in a different</span>
<a name="l00728"></a>00728   <span class="comment">// document than us.</span>
<a name="l00729"></a>00729   <span class="comment">//</span>
<a name="l00730"></a>00730   <span class="comment">// the &quot;|| window&quot; is for our shimmed testing environment and should not</span>
<a name="l00731"></a>00731   <span class="comment">// happen in production.</span>
<a name="l00732"></a>00732   var useWin = imgNode.ownerDocument.defaultView || <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>;
<a name="l00733"></a>00733   imgNode.src = useWin.URL.createObjectURL(blob);
<a name="l00734"></a>00734   <span class="comment">// We can revoke the URL after we are 100% sure the image has resolved the URL</span>
<a name="l00735"></a>00735   <span class="comment">// to get at the underlying blob.  Once autorevoke URLs are supported, we can</span>
<a name="l00736"></a>00736   <span class="comment">// stop doing this.</span>
<a name="l00737"></a>00737   imgNode.addEventListener(<span class="stringliteral">&#39;load&#39;</span>, revokeImageSrc);
<a name="l00738"></a>00738 }
<a name="l00739"></a>00739 
<a name="l00740"></a>00740 <span class="keyword">function</span> MailPeep(name, <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>, contactId, thumbnailBlob) {
<a name="l00741"></a>00741   this.name = <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l00742"></a>00742   this.<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a> = <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>;
<a name="l00743"></a>00743   this.contactId = contactId;
<a name="l00744"></a>00744   this._thumbnailBlob = thumbnailBlob;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746   this.element = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00747"></a>00747   this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00748"></a>00748   <span class="comment">// peeps are usually one of: from, to, cc, bcc</span>
<a name="l00749"></a>00749   this.<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751   this.<a class="code" href="../../db/d0b/_image_editor_8js.html#a7f35c89c0669debd60f931b98aeffd06">onchange</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 MailPeep.prototype = {
<a name="l00754"></a>00754   <span class="keyword">get</span> isContact() {
<a name="l00755"></a>00755     <span class="keywordflow">return</span> this.contactId !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00756"></a>00756   },
<a name="l00757"></a>00757 
<a name="l00758"></a>00758   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l00759"></a>00759     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailPeep: &#39;</span> + this.<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l00760"></a>00760   },
<a name="l00761"></a>00761   toJSON: <span class="keyword">function</span>() {
<a name="l00762"></a>00762     <span class="keywordflow">return</span> {
<a name="l00763"></a>00763       name: this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>,
<a name="l00764"></a>00764       <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: this.<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>,
<a name="l00765"></a>00765       contactId: this.contactId
<a name="l00766"></a>00766     };
<a name="l00767"></a>00767   },
<a name="l00768"></a>00768   toWireRep: <span class="keyword">function</span>() {
<a name="l00769"></a>00769     <span class="keywordflow">return</span> {
<a name="l00770"></a>00770       name: this.<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>,
<a name="l00771"></a>00771       <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: this.<a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>
<a name="l00772"></a>00772     };
<a name="l00773"></a>00773   },
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   <span class="keyword">get</span> hasPicture() {
<a name="l00776"></a>00776     <span class="keywordflow">return</span> this._thumbnailBlob !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00777"></a>00777   },
<a name="l00782"></a>00782   displayPictureInImageTag: <span class="keyword">function</span>(imgNode) {
<a name="l00783"></a>00783     <span class="keywordflow">if</span> (this._thumbnailBlob)
<a name="l00784"></a>00784       showBlobInImg(imgNode, this._thumbnailBlob);
<a name="l00785"></a>00785   },
<a name="l00786"></a>00786 };
<a name="l00787"></a>00787 
<a name="l00798"></a>00798 <span class="keyword">function</span> MailHeader(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, wireRep) {
<a name="l00799"></a>00799   this._slice = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801   <span class="comment">// Store the wireRep so it can be used for caching.</span>
<a name="l00802"></a>00802   this._wireRep = wireRep;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804   this.<span class="keywordtype">id</span> = wireRep.suid;
<a name="l00805"></a>00805   this.guid = wireRep.guid;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807   this.<a class="code" href="../../dd/dc4/namespacesetup.html#a7b92894168460f935bc49467954c4a92">author</a> = ContactCache.resolvePeep(wireRep.author);
<a name="l00808"></a>00808   this.<a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> = ContactCache.resolvePeeps(wireRep.to);
<a name="l00809"></a>00809   this.<a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a> = ContactCache.resolvePeeps(wireRep.cc);
<a name="l00810"></a>00810   this.bcc = ContactCache.resolvePeeps(wireRep.bcc);
<a name="l00811"></a>00811   this.replyTo = wireRep.replyTo;
<a name="l00812"></a>00812 
<a name="l00813"></a>00813   this.<a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> = <span class="keyword">new</span> Date(wireRep.date);
<a name="l00814"></a>00814 
<a name="l00815"></a>00815   this.__update(wireRep);
<a name="l00816"></a>00816   this.hasAttachments = wireRep.hasAttachments;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818   this.<a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a> = wireRep.subject;
<a name="l00819"></a>00819   this.snippet = wireRep.snippet;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821   this.<a class="code" href="../../db/d0b/_image_editor_8js.html#a7f35c89c0669debd60f931b98aeffd06">onchange</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00822"></a>00822   this.onremove = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00823"></a>00823 
<a name="l00824"></a>00824   <span class="comment">// build a place for the DOM element and arbitrary data into our shape</span>
<a name="l00825"></a>00825   this.element = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00826"></a>00826   this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00827"></a>00827 }
<a name="l00828"></a>00828 MailHeader.prototype = {
<a name="l00829"></a>00829   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l00830"></a>00830     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailHeader: &#39;</span> + this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l00831"></a>00831   },
<a name="l00832"></a>00832   toJSON: <span class="keyword">function</span>() {
<a name="l00833"></a>00833     <span class="keywordflow">return</span> {
<a name="l00834"></a>00834       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MailHeader&#39;</span>,
<a name="l00835"></a>00835       <span class="keywordtype">id</span>: this.<span class="keywordtype">id</span>
<a name="l00836"></a>00836     };
<a name="l00837"></a>00837   },
<a name="l00838"></a>00838 
<a name="l00856"></a>00856   makeCopy: <span class="keyword">function</span>() {
<a name="l00857"></a>00857     <span class="keywordflow">return</span> <span class="keyword">new</span> MailHeader(this._slice, this._wireRep);
<a name="l00858"></a>00858   },
<a name="l00859"></a>00859 
<a name="l00860"></a>00860   __update: <span class="keyword">function</span>(wireRep) {
<a name="l00861"></a>00861     <span class="keywordflow">if</span> (wireRep.snippet !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l00862"></a>00862       this.snippet = wireRep.snippet;
<a name="l00863"></a>00863 
<a name="l00864"></a>00864     this.isRead = wireRep.flags.indexOf(<span class="stringliteral">&#39;\\Seen&#39;</span>) !== -1;
<a name="l00865"></a>00865     this.isStarred = wireRep.flags.indexOf(<span class="stringliteral">&#39;\\Flagged&#39;</span>) !== -1;
<a name="l00866"></a>00866     this.isRepliedTo = wireRep.flags.indexOf(<span class="stringliteral">&#39;\\Answered&#39;</span>) !== -1;
<a name="l00867"></a>00867     this.isForwarded = wireRep.flags.indexOf(<span class="stringliteral">&#39;$Forwarded&#39;</span>) !== -1;
<a name="l00868"></a>00868     this.isJunk = wireRep.flags.indexOf(<span class="stringliteral">&#39;$Junk&#39;</span>) !== -1;
<a name="l00869"></a>00869     this.tags = filterOutBuiltinFlags(wireRep.flags);
<a name="l00870"></a>00870   },
<a name="l00871"></a>00871 
<a name="l00876"></a>00876   __die: <span class="keyword">function</span>() {
<a name="l00877"></a>00877     ContactCache.forgetPeepInstances([this.<a class="code" href="../../dd/dc4/namespacesetup.html#a7b92894168460f935bc49467954c4a92">author</a>], this.<a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>, this.<a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>, this.bcc);
<a name="l00878"></a>00878   },
<a name="l00879"></a>00879 
<a name="l00883"></a>00883   deleteMessage: <span class="keyword">function</span>() {
<a name="l00884"></a>00884     <span class="keywordflow">return</span> this._slice._api.deleteMessages([<span class="keyword">this</span>]);
<a name="l00885"></a>00885   },
<a name="l00886"></a>00886 
<a name="l00887"></a>00887   <span class="comment">/*</span>
<a name="l00888"></a>00888 <span class="comment">   * Copy this message to another folder.</span>
<a name="l00889"></a>00889 <span class="comment">   */</span>
<a name="l00890"></a>00890   <span class="comment">/*</span>
<a name="l00891"></a>00891 <span class="comment">  copyMessage: function(targetFolder) {</span>
<a name="l00892"></a>00892 <span class="comment">    return this._slice._api.copyMessages([this], targetFolder);</span>
<a name="l00893"></a>00893 <span class="comment">  },</span>
<a name="l00894"></a>00894 <span class="comment">  */</span>
<a name="l00895"></a>00895 
<a name="l00899"></a>00899   moveMessage: <span class="keyword">function</span>(targetFolder) {
<a name="l00900"></a>00900     <span class="keywordflow">return</span> this._slice._api.moveMessages([<span class="keyword">this</span>], targetFolder);
<a name="l00901"></a>00901   },
<a name="l00902"></a>00902 
<a name="l00906"></a>00906   setRead: <span class="keyword">function</span>(beRead) {
<a name="l00907"></a>00907     <span class="keywordflow">return</span> this._slice._api.markMessagesRead([<span class="keyword">this</span>], beRead);
<a name="l00908"></a>00908   },
<a name="l00909"></a>00909 
<a name="l00913"></a>00913   setStarred: <span class="keyword">function</span>(beStarred) {
<a name="l00914"></a>00914     <span class="keywordflow">return</span> this._slice._api.markMessagesStarred([<span class="keyword">this</span>], beStarred);
<a name="l00915"></a>00915   },
<a name="l00916"></a>00916 
<a name="l00920"></a>00920   modifyTags: <span class="keyword">function</span>(addTags, removeTags) {
<a name="l00921"></a>00921     <span class="keywordflow">return</span> this._slice._api.modifyMessageTags([<span class="keyword">this</span>], addTags, removeTags);
<a name="l00922"></a>00922   },
<a name="l00923"></a>00923 
<a name="l00942"></a>00942   getBody: <span class="keyword">function</span>(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00943"></a>00943     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(<a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>) === <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l00944"></a>00944       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>;
<a name="l00945"></a>00945       <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l00946"></a>00946     }
<a name="l00947"></a>00947     this._slice._api._getBodyForMessage(<span class="keyword">this</span>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00948"></a>00948   },
<a name="l00949"></a>00949 
<a name="l00959"></a>00959   editAsDraft: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00960"></a>00960     <span class="keywordflow">return</span> this._slice._api.resumeMessageComposition(<span class="keyword">this</span>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00961"></a>00961   },
<a name="l00962"></a>00962 
<a name="l00988"></a>00988   replyToMessage: <span class="keyword">function</span>(replyMode, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l00989"></a>00989     <span class="keywordflow">return</span> this._slice._api.beginMessageComposition(
<a name="l00990"></a>00990       <span class="keyword">this</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { replyTo: <span class="keyword">this</span>, replyMode: replyMode }, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l00991"></a>00991   },
<a name="l00992"></a>00992 
<a name="l01005"></a>01005   forwardMessage: <span class="keyword">function</span>(forwardMode, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01006"></a>01006     <span class="keywordflow">return</span> this._slice._api.beginMessageComposition(
<a name="l01007"></a>01007       <span class="keyword">this</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, { forwardOf: <span class="keyword">this</span>, forwardMode: forwardMode }, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>);
<a name="l01008"></a>01008   },
<a name="l01009"></a>01009 };
<a name="l01010"></a>01010 
<a name="l01015"></a>01015 <span class="keyword">function</span> MailMatchedHeader(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, wireRep) {
<a name="l01016"></a>01016   this.<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a> = <span class="keyword">new</span> MailHeader(<a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>, wireRep.header);
<a name="l01017"></a>01017   this.matches = wireRep.matches;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019   this.element = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01020"></a>01020   this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01021"></a>01021 }
<a name="l01022"></a>01022 MailMatchedHeader.prototype = {
<a name="l01023"></a>01023   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l01024"></a>01024     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailMatchedHeader: &#39;</span> + this.<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>.id + <span class="charliteral">&#39;]&#39;</span>;
<a name="l01025"></a>01025   },
<a name="l01026"></a>01026   toJSON: <span class="keyword">function</span>() {
<a name="l01027"></a>01027     <span class="keywordflow">return</span> {
<a name="l01028"></a>01028       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MailMatchedHeader&#39;</span>,
<a name="l01029"></a>01029       <span class="keywordtype">id</span>: this.<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>.id
<a name="l01030"></a>01030     };
<a name="l01031"></a>01031   },
<a name="l01032"></a>01032 
<a name="l01033"></a>01033   __die: <span class="keyword">function</span>() {
<a name="l01034"></a>01034     this.<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>.__die();
<a name="l01035"></a>01035   },
<a name="l01036"></a>01036 };
<a name="l01037"></a>01037 
<a name="l01046"></a>01046 <span class="keyword">function</span> MailBody(api, suid, wireRep, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>) {
<a name="l01047"></a>01047   this._api = api;
<a name="l01048"></a>01048   this.<span class="keywordtype">id</span> = suid;
<a name="l01049"></a>01049   this._date = wireRep.date;
<a name="l01050"></a>01050   this._handle = <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>;
<a name="l01051"></a>01051 
<a name="l01052"></a>01052   this.attachments = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01053"></a>01053   <span class="keywordflow">if</span> (wireRep.attachments) {
<a name="l01054"></a>01054     this.attachments = [];
<a name="l01055"></a>01055     <span class="keywordflow">for</span> (var iAtt = 0; iAtt &lt; wireRep.attachments.length; iAtt++) {
<a name="l01056"></a>01056       this.attachments.push(
<a name="l01057"></a>01057         <span class="keyword">new</span> MailAttachment(<span class="keyword">this</span>, wireRep.attachments[iAtt]));
<a name="l01058"></a>01058     }
<a name="l01059"></a>01059   }
<a name="l01060"></a>01060   this._relatedParts = wireRep.relatedParts;
<a name="l01061"></a>01061   this.bodyReps = wireRep.bodyReps;
<a name="l01062"></a>01062   <span class="comment">// references is included for debug/unit testing purposes, hence is private</span>
<a name="l01063"></a>01063   this._references = wireRep.references;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065   this.<a class="code" href="../../db/d0b/_image_editor_8js.html#a7f35c89c0669debd60f931b98aeffd06">onchange</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01066"></a>01066   this.ondead = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01067"></a>01067 }
<a name="l01068"></a>01068 MailBody.prototype = {
<a name="l01069"></a>01069   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l01070"></a>01070     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailBody: &#39;</span> + this.<span class="keywordtype">id</span> + <span class="charliteral">&#39;]&#39;</span>;
<a name="l01071"></a>01071   },
<a name="l01072"></a>01072   toJSON: <span class="keyword">function</span>() {
<a name="l01073"></a>01073     <span class="keywordflow">return</span> {
<a name="l01074"></a>01074       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MailBody&#39;</span>,
<a name="l01075"></a>01075       <span class="keywordtype">id</span>: this.<span class="keywordtype">id</span>
<a name="l01076"></a>01076     };
<a name="l01077"></a>01077   },
<a name="l01078"></a>01078 
<a name="l01083"></a>01083   <span class="keyword">get</span> embeddedImageCount() {
<a name="l01084"></a>01084     <span class="keywordflow">if</span> (!this._relatedParts)
<a name="l01085"></a>01085       <span class="keywordflow">return</span> 0;
<a name="l01086"></a>01086     <span class="keywordflow">return</span> this._relatedParts.length;
<a name="l01087"></a>01087   },
<a name="l01088"></a>01088 
<a name="l01092"></a>01092   <span class="keyword">get</span> bodyRepsDownloaded() {
<a name="l01093"></a>01093     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a> = 0;
<a name="l01094"></a>01094     var <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a> = this.bodyReps.length;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="keywordflow">for</span> (; i &lt; <a class="code" href="../../d9/d04/expat_8h.html#a5df20ff5bc70fb664abe3912796e90df">len</a>; i++) {
<a name="l01097"></a>01097       <span class="keywordflow">if</span> (!this.bodyReps[i].isDownloaded) {
<a name="l01098"></a>01098         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01099"></a>01099       }
<a name="l01100"></a>01100     }
<a name="l01101"></a>01101     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01102"></a>01102   },
<a name="l01103"></a>01103 
<a name="l01107"></a>01107   <span class="keyword">get</span> embeddedImagesDownloaded() {
<a name="l01108"></a>01108     <span class="keywordflow">for</span> (var i = 0; i &lt; this._relatedParts.length; i++) {
<a name="l01109"></a>01109       var relatedPart = this._relatedParts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01110"></a>01110       <span class="keywordflow">if</span> (!relatedPart.file)
<a name="l01111"></a>01111         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01114"></a>01114   },
<a name="l01115"></a>01115 
<a name="l01120"></a>01120   downloadEmbeddedImages: <span class="keyword">function</span>(callWhenDone, callOnProgress) {
<a name="l01121"></a>01121     var relPartIndices = [];
<a name="l01122"></a>01122     <span class="keywordflow">for</span> (var i = 0; i &lt; this._relatedParts.length; i++) {
<a name="l01123"></a>01123       var relatedPart = this._relatedParts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01124"></a>01124       <span class="keywordflow">if</span> (relatedPart.file)
<a name="l01125"></a>01125         <span class="keywordflow">continue</span>;
<a name="l01126"></a>01126       relPartIndices.push(i);
<a name="l01127"></a>01127     }
<a name="l01128"></a>01128     <span class="keywordflow">if</span> (!relPartIndices.length) {
<a name="l01129"></a>01129       <span class="keywordflow">if</span> (callWhenDone)
<a name="l01130"></a>01130         callWhenDone();
<a name="l01131"></a>01131       <span class="keywordflow">return</span>;
<a name="l01132"></a>01132     }
<a name="l01133"></a>01133     this._api._downloadAttachments(<span class="keyword">this</span>, relPartIndices, [],
<a name="l01134"></a>01134                                    callWhenDone, callOnProgress);
<a name="l01135"></a>01135   },
<a name="l01136"></a>01136 
<a name="l01143"></a>01143   showEmbeddedImages: <span class="keyword">function</span>(htmlNode, loadCallback) {
<a name="l01144"></a>01144     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, cidToBlob = {};
<a name="l01145"></a>01145     <span class="comment">// - Generate object URLs for the attachments</span>
<a name="l01146"></a>01146     <span class="keywordflow">for</span> (i = 0; i &lt; this._relatedParts.length; i++) {
<a name="l01147"></a>01147       var relPart = this._relatedParts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01148"></a>01148       <span class="comment">// Related parts should all be stored as Blobs-in-IndexedDB</span>
<a name="l01149"></a>01149       <span class="keywordflow">if</span> (relPart.file &amp;&amp; !Array.isArray(relPart.file))
<a name="l01150"></a>01150         cidToBlob[relPart.contentId] = relPart.file;
<a name="l01151"></a>01151     }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     <span class="comment">// - Transform the links</span>
<a name="l01154"></a>01154     var <a class="code" href="../../da/df2/namespacexml2dict.html#aaabd7336a42f36f8a79edd9e5fc821cf">nodes</a> = htmlNode.querySelectorAll(<span class="stringliteral">&#39;.moz-embedded-image&#39;</span>);
<a name="l01155"></a>01155     <span class="keywordflow">for</span> (i = 0; i &lt; nodes.length; i++) {
<a name="l01156"></a>01156       var <a class="code" href="../../d1/d04/app__install__manager_8js.html#a9ed71aaefba3c241c5255080e6a99884">node</a> = nodes[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l01157"></a>01157           cid = node.getAttribute(<span class="stringliteral">&#39;cid-src&#39;</span>);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159       <span class="keywordflow">if</span> (!cidToBlob.hasOwnProperty(cid))
<a name="l01160"></a>01160         <span class="keywordflow">continue</span>;
<a name="l01161"></a>01161       showBlobInImg(node, cidToBlob[cid]);
<a name="l01162"></a>01162       <span class="keywordflow">if</span> (loadCallback)
<a name="l01163"></a>01163         node.addEventListener(<span class="stringliteral">&#39;load&#39;</span>, loadCallback, <span class="keyword">false</span>);
<a name="l01164"></a>01164 
<a name="l01165"></a>01165       node.removeAttribute(<span class="stringliteral">&#39;cid-src&#39;</span>);
<a name="l01166"></a>01166       node.classList.remove(<span class="stringliteral">&#39;moz-embedded-image&#39;</span>);
<a name="l01167"></a>01167     }
<a name="l01168"></a>01168   },
<a name="l01169"></a>01169 
<a name="l01178"></a>01178   checkForExternalImages: <span class="keyword">function</span>(htmlNode) {
<a name="l01179"></a>01179     var someNode = htmlNode.querySelector(<span class="stringliteral">&#39;.moz-external-image&#39;</span>);
<a name="l01180"></a>01180     <span class="keywordflow">return</span> someNode !== <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01181"></a>01181   },
<a name="l01182"></a>01182 
<a name="l01189"></a>01189   showExternalImages: <span class="keyword">function</span>(htmlNode, loadCallback) {
<a name="l01190"></a>01190     <span class="comment">// querySelectorAll is not live, whereas getElementsByClassName is; we</span>
<a name="l01191"></a>01191     <span class="comment">// don&#39;t need/want live, especially with our manipulations.</span>
<a name="l01192"></a>01192     var nodes = htmlNode.querySelectorAll(<span class="stringliteral">&#39;.moz-external-image&#39;</span>);
<a name="l01193"></a>01193     <span class="keywordflow">for</span> (var i = 0; i &lt; nodes.length; i++) {
<a name="l01194"></a>01194       var node = nodes[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01195"></a>01195       <span class="keywordflow">if</span> (loadCallback) {
<a name="l01196"></a>01196         node.addEventListener(<span class="stringliteral">&#39;load&#39;</span>, loadCallback, <span class="keyword">false</span>);
<a name="l01197"></a>01197       }
<a name="l01198"></a>01198       node.setAttribute(<span class="stringliteral">&#39;src&#39;</span>, node.getAttribute(<span class="stringliteral">&#39;ext-src&#39;</span>));
<a name="l01199"></a>01199       node.removeAttribute(<span class="stringliteral">&#39;ext-src&#39;</span>);
<a name="l01200"></a>01200       node.classList.remove(<span class="stringliteral">&#39;moz-external-image&#39;</span>);
<a name="l01201"></a>01201     }
<a name="l01202"></a>01202   },
<a name="l01206"></a>01206   <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span>() {
<a name="l01207"></a>01207     <span class="comment">// Remember to cleanup event listeners except ondead!</span>
<a name="l01208"></a>01208     this.<a class="code" href="../../db/d0b/_image_editor_8js.html#a7f35c89c0669debd60f931b98aeffd06">onchange</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01209"></a>01209 
<a name="l01210"></a>01210     this._api.__bridgeSend({
<a name="l01211"></a>01211       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;killBody&#39;</span>,
<a name="l01212"></a>01212       <span class="keywordtype">id</span>: this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a5a0801283c5c25416c0888dc53f332d0">id</a>,
<a name="l01213"></a>01213       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle
<a name="l01214"></a>01214     });
<a name="l01215"></a>01215   }
<a name="l01216"></a>01216 };
<a name="l01217"></a>01217 
<a name="l01223"></a>01223 <span class="keyword">function</span> MailAttachment(_body, wireRep) {
<a name="l01224"></a>01224   this._body = _body;
<a name="l01225"></a>01225   this.partId = wireRep.part;
<a name="l01226"></a>01226   this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a> = wireRep.name;
<a name="l01227"></a>01227   this.mimetype = wireRep.type;
<a name="l01228"></a>01228   this.sizeEstimateInBytes = wireRep.sizeEstimate;
<a name="l01229"></a>01229   this._file = wireRep.file;
<a name="l01230"></a>01230 
<a name="l01231"></a>01231   <span class="comment">// build a place for the DOM element and arbitrary data into our shape</span>
<a name="l01232"></a>01232   this.element = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01233"></a>01233   this.<a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01234"></a>01234 }
<a name="l01235"></a>01235 MailAttachment.prototype = {
<a name="l01236"></a>01236   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l01237"></a>01237     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailAttachment: &quot;&#39;</span> + this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a> + <span class="stringliteral">&#39;&quot;]&#39;</span>;
<a name="l01238"></a>01238   },
<a name="l01239"></a>01239   toJSON: <span class="keyword">function</span>() {
<a name="l01240"></a>01240     <span class="keywordflow">return</span> {
<a name="l01241"></a>01241       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MailAttachment&#39;</span>,
<a name="l01242"></a>01242       <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>: this.<a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>
<a name="l01243"></a>01243     };
<a name="l01244"></a>01244   },
<a name="l01245"></a>01245 
<a name="l01246"></a>01246   <span class="keyword">get</span> isDownloaded() {
<a name="l01247"></a>01247     <span class="keywordflow">return</span> !!this._file;
<a name="l01248"></a>01248   },
<a name="l01249"></a>01249 
<a name="l01250"></a>01250   <a class="code" href="../../d5/de2/homescreen_2test_2unit_2mock__app_8js.html#ab9b84e146e6d762e377175efdca01924">download</a>: <span class="keyword">function</span>(callWhenDone, callOnProgress) {
<a name="l01251"></a>01251     this._body._api._downloadAttachments(
<a name="l01252"></a>01252       this._body, [], [this._body.attachments.indexOf(<span class="keyword">this</span>)],
<a name="l01253"></a>01253       callWhenDone, callOnProgress);
<a name="l01254"></a>01254   },
<a name="l01255"></a>01255 };
<a name="l01256"></a>01256 
<a name="l01264"></a>01264 <span class="keyword">function</span> UndoableOperation(_api, operation, affectedCount,
<a name="l01265"></a>01265                            _tempHandle, _longtermIds) {
<a name="l01266"></a>01266   this._api = _api;
<a name="l01298"></a>01298   this.operation = operation;
<a name="l01302"></a>01302   this.affectedCount = affectedCount;
<a name="l01303"></a>01303 
<a name="l01309"></a>01309   this._tempHandle = _tempHandle;
<a name="l01314"></a>01314   this._longtermIds = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01315"></a>01315 
<a name="l01316"></a>01316   this._undoRequested = <span class="keyword">false</span>;
<a name="l01317"></a>01317 }
<a name="l01318"></a>01318 UndoableOperation.prototype = {
<a name="l01319"></a>01319   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l01320"></a>01320     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[UndoableOperation]&#39;</span>;
<a name="l01321"></a>01321   },
<a name="l01322"></a>01322   toJSON: <span class="keyword">function</span>() {
<a name="l01323"></a>01323     <span class="keywordflow">return</span> {
<a name="l01324"></a>01324       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;UndoableOperation&#39;</span>,
<a name="l01325"></a>01325       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._tempHandle,
<a name="l01326"></a>01326       longtermIds: this._longtermIds,
<a name="l01327"></a>01327     };
<a name="l01328"></a>01328   },
<a name="l01329"></a>01329 
<a name="l01330"></a>01330   undo: <span class="keyword">function</span>() {
<a name="l01331"></a>01331     <span class="comment">// We can&#39;t issue the undo until we&#39;ve heard the longterm id, so just flag</span>
<a name="l01332"></a>01332     <span class="comment">// it to be processed when we do.</span>
<a name="l01333"></a>01333     <span class="keywordflow">if</span> (!this._longtermIds) {
<a name="l01334"></a>01334       this._undoRequested = <span class="keyword">true</span>;
<a name="l01335"></a>01335       <span class="keywordflow">return</span>;
<a name="l01336"></a>01336     }
<a name="l01337"></a>01337     this._api.__undo(<span class="keyword">this</span>);
<a name="l01338"></a>01338   },
<a name="l01339"></a>01339 };
<a name="l01340"></a>01340 
<a name="l01347"></a>01347 <span class="keyword">function</span> BridgedViewSlice(api, <a class="code" href="../../d4/d21/calendar_2js_2controllers_2alarm_8js.html#a0416fc4d5e8ec4fd436369a406438e44">ns</a>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>) {
<a name="l01348"></a>01348   this._api = api;
<a name="l01349"></a>01349   this._ns = <a class="code" href="../../d4/d21/calendar_2js_2controllers_2alarm_8js.html#a0416fc4d5e8ec4fd436369a406438e44">ns</a>;
<a name="l01350"></a>01350   this._handle = <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>;
<a name="l01351"></a>01351 
<a name="l01352"></a>01352   this.items = [];
<a name="l01353"></a>01353 
<a name="l01377"></a>01377   this.<a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a> = <span class="stringliteral">&#39;new&#39;</span>;
<a name="l01378"></a>01378 
<a name="l01382"></a>01382   this.syncProgress = 0.0;
<a name="l01383"></a>01383 
<a name="l01388"></a>01388   this.atTop = <span class="keyword">false</span>;
<a name="l01393"></a>01393   this.atBottom = <span class="keyword">false</span>;
<a name="l01394"></a>01394 
<a name="l01403"></a>01403   this.userCanGrowUpwards = <span class="keyword">false</span>;
<a name="l01404"></a>01404 
<a name="l01413"></a>01413   this.userCanGrowDownwards = <span class="keyword">false</span>;
<a name="l01414"></a>01414 
<a name="l01421"></a>01421   this.pendingRequestCount = 0;
<a name="l01425"></a>01425   this._growing = 0;
<a name="l01426"></a>01426 
<a name="l01427"></a>01427   this.onadd = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01428"></a>01428   this.<a class="code" href="../../db/d0b/_image_editor_8js.html#a7f35c89c0669debd60f931b98aeffd06">onchange</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01429"></a>01429   this.onsplice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01430"></a>01430   this.onremove = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01431"></a>01431   this.onstatus = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01432"></a>01432   this.oncomplete = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01433"></a>01433   this.ondead = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01434"></a>01434 }
<a name="l01435"></a>01435 BridgedViewSlice.prototype = {
<a name="l01436"></a>01436   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l01437"></a>01437     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[BridgedViewSlice: &#39;</span> + this._ns + <span class="charliteral">&#39; &#39;</span> + this._handle + <span class="charliteral">&#39;]&#39;</span>;
<a name="l01438"></a>01438   },
<a name="l01439"></a>01439   toJSON: <span class="keyword">function</span>() {
<a name="l01440"></a>01440     <span class="keywordflow">return</span> {
<a name="l01441"></a>01441       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;BridgedViewSlice&#39;</span>,
<a name="l01442"></a>01442       <span class="keyword">namespace</span>: this._ns,
<a name="l01443"></a>01443       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle
<a name="l01444"></a>01444     };
<a name="l01445"></a>01445   },
<a name="l01446"></a>01446 
<a name="l01452"></a>01452   requestShrinkage: <span class="keyword">function</span>(firstUsedIndex, lastUsedIndex) {
<a name="l01453"></a>01453     this.pendingRequestCount++;
<a name="l01454"></a>01454     <span class="keywordflow">if</span> (lastUsedIndex &gt;= this.items.length)
<a name="l01455"></a>01455       lastUsedIndex = this.items.length - 1;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457     <span class="comment">// We send indices and suid&#39;s.  The indices are used for fast-pathing;</span>
<a name="l01458"></a>01458     <span class="comment">// if the suid&#39;s don&#39;t match, a linear search is undertaken.</span>
<a name="l01459"></a>01459     this._api.__bridgeSend({
<a name="l01460"></a>01460         <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;shrinkSlice&#39;</span>,
<a name="l01461"></a>01461         <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle,
<a name="l01462"></a>01462         firstIndex: firstUsedIndex,
<a name="l01463"></a>01463         firstSuid: this.items[firstUsedIndex].id,
<a name="l01464"></a>01464         lastIndex: lastUsedIndex,
<a name="l01465"></a>01465         lastSuid: this.items[lastUsedIndex].id
<a name="l01466"></a>01466       });
<a name="l01467"></a>01467   },
<a name="l01468"></a>01468 
<a name="l01473"></a>01473   requestGrowth: <span class="keyword">function</span>(dirMagnitude, userRequestsGrowth) {
<a name="l01474"></a>01474     <span class="keywordflow">if</span> (this._growing)
<a name="l01475"></a>01475       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Already growing in &#39;</span> + this._growing + <span class="stringliteral">&#39; dir.&#39;</span>);
<a name="l01476"></a>01476     this._growing = dirMagnitude;
<a name="l01477"></a>01477     this.pendingRequestCount++;
<a name="l01478"></a>01478 
<a name="l01479"></a>01479     this._api.__bridgeSend({
<a name="l01480"></a>01480         <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;growSlice&#39;</span>,
<a name="l01481"></a>01481         dirMagnitude: dirMagnitude,
<a name="l01482"></a>01482         userRequestsGrowth: userRequestsGrowth,
<a name="l01483"></a>01483         <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle
<a name="l01484"></a>01484       });
<a name="l01485"></a>01485   },
<a name="l01486"></a>01486 
<a name="l01487"></a>01487   <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span>() {
<a name="l01488"></a>01488     <span class="comment">// Null out all listeners except for the ondead listener.  This avoids</span>
<a name="l01489"></a>01489     <span class="comment">// the callbacks from having to filter out messages from dead slices.</span>
<a name="l01490"></a>01490     this.onadd = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01491"></a>01491     this.<a class="code" href="../../db/d0b/_image_editor_8js.html#a7f35c89c0669debd60f931b98aeffd06">onchange</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01492"></a>01492     this.onsplice = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01493"></a>01493     this.onremove = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01494"></a>01494     this.onstatus = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01495"></a>01495     this.oncomplete = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01496"></a>01496     this._api.__bridgeSend({
<a name="l01497"></a>01497         <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;killSlice&#39;</span>,
<a name="l01498"></a>01498         <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle
<a name="l01499"></a>01499       });
<a name="l01500"></a>01500 
<a name="l01501"></a>01501     <span class="keywordflow">for</span> (var i = 0; i &lt; this.items.length; i++) {
<a name="l01502"></a>01502       var item = this.items[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01503"></a>01503       item.__die();
<a name="l01504"></a>01504     }
<a name="l01505"></a>01505   },
<a name="l01506"></a>01506 };
<a name="l01507"></a>01507 
<a name="l01508"></a>01508 <span class="keyword">function</span> AccountsViewSlice(api, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>) {
<a name="l01509"></a>01509   BridgedViewSlice.call(<span class="keyword">this</span>, api, <span class="stringliteral">&#39;accounts&#39;</span>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>);
<a name="l01510"></a>01510 }
<a name="l01511"></a>01511 AccountsViewSlice.prototype = Object.create(BridgedViewSlice.prototype);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513 Object.defineProperty(AccountsViewSlice.prototype, <span class="stringliteral">&#39;defaultAccount&#39;</span>, {
<a name="l01514"></a>01514   <span class="keyword">get</span>: <a class="code" href="../../d9/dc4/pralarm_8h.html#a7b570f1c425a05af1046d4e6f37d5a0f">function</a> () {
<a name="l01515"></a>01515     var defaultAccount = this.items[0];
<a name="l01516"></a>01516     <span class="keywordflow">for</span> (var i = 1; i &lt; this.items.length; i++) {
<a name="l01517"></a>01517       <span class="comment">// For UI upgrades, the defaultPriority may not be set, so default to</span>
<a name="l01518"></a>01518       <span class="comment">// zero for comparisons</span>
<a name="l01519"></a>01519       <span class="keywordflow">if</span> ((this.items[i]._wireRep.defaultPriority || 0) &gt;
<a name="l01520"></a>01520           (defaultAccount._wireRep.defaultPriority || 0))
<a name="l01521"></a>01521         defaultAccount = <span class="keyword">this</span>.items[i];
<a name="l01522"></a>01522     }
<a name="l01523"></a>01523 
<a name="l01524"></a>01524     <span class="keywordflow">return</span> defaultAccount;
<a name="l01525"></a>01525   }
<a name="l01526"></a>01526 });
<a name="l01527"></a>01527 
<a name="l01528"></a>01528 <span class="keyword">function</span> FoldersViewSlice(api, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>) {
<a name="l01529"></a>01529   BridgedViewSlice.call(<span class="keyword">this</span>, api, <span class="stringliteral">&#39;folders&#39;</span>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>);
<a name="l01530"></a>01530 }
<a name="l01531"></a>01531 FoldersViewSlice.prototype = Object.create(BridgedViewSlice.prototype);
<a name="l01532"></a>01532 
<a name="l01533"></a>01533 FoldersViewSlice.prototype.getFirstFolderWithType = <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, items) {
<a name="l01534"></a>01534   <span class="comment">// allow an explicit list of items to be provided, specifically for use in</span>
<a name="l01535"></a>01535   <span class="comment">// onsplice handlers where the items have not yet been spliced in.</span>
<a name="l01536"></a>01536   <span class="keywordflow">if</span> (!items)
<a name="l01537"></a>01537     items = this.items;
<a name="l01538"></a>01538   <span class="keywordflow">for</span> (var i = 0; i &lt; items.length; i++) {
<a name="l01539"></a>01539     var folder = items[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01540"></a>01540     <span class="keywordflow">if</span> (folder.type === <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>)
<a name="l01541"></a>01541       <span class="keywordflow">return</span> folder;
<a name="l01542"></a>01542   }
<a name="l01543"></a>01543   <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01544"></a>01544 };
<a name="l01545"></a>01545 
<a name="l01546"></a>01546 FoldersViewSlice.prototype.getFirstFolderWithName = <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, items) {
<a name="l01547"></a>01547   <span class="keywordflow">if</span> (!items)
<a name="l01548"></a>01548     items = this.items;
<a name="l01549"></a>01549   <span class="keywordflow">for</span> (var i = 0; i &lt; items.length; i++) {
<a name="l01550"></a>01550     var folder = items[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01551"></a>01551     <span class="keywordflow">if</span> (folder.name === name)
<a name="l01552"></a>01552       <span class="keywordflow">return</span> folder;
<a name="l01553"></a>01553   }
<a name="l01554"></a>01554   <span class="keywordflow">return</span> <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01555"></a>01555 };
<a name="l01556"></a>01556 
<a name="l01557"></a>01557 <span class="keyword">function</span> HeadersViewSlice(api, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>, <a class="code" href="../../d4/d21/calendar_2js_2controllers_2alarm_8js.html#a0416fc4d5e8ec4fd436369a406438e44">ns</a>) {
<a name="l01558"></a>01558   BridgedViewSlice.call(<span class="keyword">this</span>, api, <a class="code" href="../../d4/d21/calendar_2js_2controllers_2alarm_8js.html#a0416fc4d5e8ec4fd436369a406438e44">ns</a> || <span class="stringliteral">&#39;headers&#39;</span>, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>);
<a name="l01559"></a>01559 
<a name="l01560"></a>01560   this._bodiesRequestId = 1;
<a name="l01561"></a>01561   this._bodiesRequest = {};
<a name="l01562"></a>01562 }
<a name="l01563"></a>01563 HeadersViewSlice.prototype = Object.create(BridgedViewSlice.prototype);
<a name="l01564"></a>01564 
<a name="l01573"></a>01573 HeadersViewSlice.prototype.refresh = <span class="keyword">function</span>() {
<a name="l01574"></a>01574   this._api.__bridgeSend({
<a name="l01575"></a>01575       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;refreshHeaders&#39;</span>,
<a name="l01576"></a>01576       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle
<a name="l01577"></a>01577     });
<a name="l01578"></a>01578 };
<a name="l01579"></a>01579 
<a name="l01580"></a>01580 HeadersViewSlice.prototype._notifyRequestBodiesComplete = <span class="keyword">function</span>(reqId) {
<a name="l01581"></a>01581   var <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a> = this._bodiesRequest[reqId];
<a name="l01582"></a>01582   <span class="keywordflow">if</span> (reqId &amp;&amp; callback) {
<a name="l01583"></a>01583     <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(<span class="keyword">true</span>);
<a name="l01584"></a>01584     <span class="keyword">delete</span> this._bodiesRequest[reqId];
<a name="l01585"></a>01585   }
<a name="l01586"></a>01586 };
<a name="l01587"></a>01587 
<a name="l01596"></a>01596 HeadersViewSlice.prototype.maybeRequestBodies =
<a name="l01597"></a>01597   <span class="keyword">function</span>(idxStart, idxEnd, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01598"></a>01598 
<a name="l01599"></a>01599   <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(options) === <span class="stringliteral">&#39;function&#39;</span>) {
<a name="l01600"></a>01600     callback = <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>;
<a name="l01601"></a>01601     options = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01602"></a>01602   }
<a name="l01603"></a>01603 
<a name="l01604"></a>01604   var messages = [];
<a name="l01605"></a>01605 
<a name="l01606"></a>01606   idxEnd = Math.min(idxEnd, this.items.length - 1);
<a name="l01607"></a>01607 
<a name="l01608"></a>01608   <span class="keywordflow">for</span> (; idxStart &lt;= idxEnd; idxStart++) {
<a name="l01609"></a>01609     var item = this.items[idxStart];
<a name="l01610"></a>01610     <span class="comment">// ns of &#39;headers&#39; has the id/date on the item, where &#39;matchedHeaders&#39;</span>
<a name="l01611"></a>01611     <span class="comment">// has it on header.date</span>
<a name="l01612"></a>01612     <span class="keywordflow">if</span> (this._ns === <span class="stringliteral">&#39;matchedHeaders&#39;</span>) {
<a name="l01613"></a>01613       item = item.header;
<a name="l01614"></a>01614     }
<a name="l01615"></a>01615 
<a name="l01616"></a>01616     <span class="keywordflow">if</span> (item &amp;&amp; item.snippet === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>) {
<a name="l01617"></a>01617       messages.push({
<a name="l01618"></a>01618         suid: item.id,
<a name="l01619"></a>01619         <span class="comment">// backend does not care about Date objects</span>
<a name="l01620"></a>01620         <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: item.date.valueOf()
<a name="l01621"></a>01621       });
<a name="l01622"></a>01622     }
<a name="l01623"></a>01623   }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625   <span class="keywordflow">if</span> (!messages.length)
<a name="l01626"></a>01626     <span class="keywordflow">return</span> callback &amp;&amp; <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.setZeroTimeout(callback, <span class="keyword">false</span>);
<a name="l01627"></a>01627 
<a name="l01628"></a>01628   var reqId = this._bodiesRequestId++;
<a name="l01629"></a>01629   this._bodiesRequest[reqId] = <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631   this._api.__bridgeSend({
<a name="l01632"></a>01632     <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;requestBodies&#39;</span>,
<a name="l01633"></a>01633     <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle,
<a name="l01634"></a>01634     requestId: reqId,
<a name="l01635"></a>01635     messages: messages,
<a name="l01636"></a>01636     options: options
<a name="l01637"></a>01637   });
<a name="l01638"></a>01638 };
<a name="l01639"></a>01639 
<a name="l01640"></a>01640 
<a name="l01651"></a>01651 <span class="keyword">function</span> MessageComposition(api, <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>) {
<a name="l01652"></a>01652   this._api = api;
<a name="l01653"></a>01653   this._handle = <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>;
<a name="l01654"></a>01654 
<a name="l01655"></a>01655   this.senderIdentity = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01656"></a>01656 
<a name="l01657"></a>01657   this.<a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01658"></a>01658   this.<a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01659"></a>01659   this.bcc = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01660"></a>01660 
<a name="l01661"></a>01661   this.<a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01662"></a>01662 
<a name="l01663"></a>01663   this.body = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01664"></a>01664 
<a name="l01665"></a>01665   this._references = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01666"></a>01666   this._customHeaders = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01667"></a>01667   this.attachments = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01668"></a>01668 }
<a name="l01669"></a>01669 MessageComposition.prototype = {
<a name="l01670"></a>01670   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l01671"></a>01671     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MessageComposition: &#39;</span> + this._handle + <span class="charliteral">&#39;]&#39;</span>;
<a name="l01672"></a>01672   },
<a name="l01673"></a>01673   toJSON: <span class="keyword">function</span>() {
<a name="l01674"></a>01674     <span class="keywordflow">return</span> {
<a name="l01675"></a>01675       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MessageComposition&#39;</span>,
<a name="l01676"></a>01676       <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>: this._handle
<a name="l01677"></a>01677     };
<a name="l01678"></a>01678   },
<a name="l01679"></a>01679 
<a name="l01680"></a>01680   <a class="code" href="../../dc/d5e/apps_2email_2js_2ext_2mailapi_2imap_2probe_8js.html#a10a06623d857e96b7da92aac74d62d34">die</a>: <span class="keyword">function</span>() {
<a name="l01681"></a>01681     <span class="keywordflow">if</span> (this._handle) {
<a name="l01682"></a>01682       this._api._composeDone(this._handle, <span class="stringliteral">&#39;die&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l01683"></a>01683       this._handle = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01684"></a>01684     }
<a name="l01685"></a>01685   },
<a name="l01686"></a>01686 
<a name="l01690"></a>01690   addHeader: <span class="keyword">function</span>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>, <a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>) {
<a name="l01691"></a>01691     <span class="keywordflow">if</span> (!this._customHeaders)
<a name="l01692"></a>01692       this._customHeaders = [];
<a name="l01693"></a>01693     this._customHeaders.push(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>);
<a name="l01694"></a>01694     this._customHeaders.push(<a class="code" href="../../d9/d04/expat_8h.html#aebafa8f4412854cf6c37456c71ff5ee7">value</a>);
<a name="l01695"></a>01695   },
<a name="l01696"></a>01696 
<a name="l01705"></a>01705   addAttachment: <span class="keyword">function</span>(attachmentDef) {
<a name="l01706"></a>01706     this.attachments.push(attachmentDef);
<a name="l01707"></a>01707   },
<a name="l01708"></a>01708 
<a name="l01709"></a>01709   removeAttachment: <span class="keyword">function</span>(attachmentDef) {
<a name="l01710"></a>01710     var idx = this.attachments.indexOf(attachmentDef);
<a name="l01711"></a>01711     <span class="keywordflow">if</span> (idx !== -1)
<a name="l01712"></a>01712       this.attachments.splice(idx, 1);
<a name="l01713"></a>01713   },
<a name="l01714"></a>01714 
<a name="l01718"></a>01718   _buildWireRep: <span class="keyword">function</span>() {
<a name="l01719"></a>01719     <span class="keywordflow">return</span> {
<a name="l01720"></a>01720       senderId: this.senderIdentity.id,
<a name="l01721"></a>01721       <a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>: this.<a class="code" href="../../da/d32/prio_8h.html#a5d467a63df9ff99d33d6749038f6f421">to</a>,
<a name="l01722"></a>01722       <a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>: this.<a class="code" href="../../db/de5/namespacedefault__timezones.html#a7e2d0d21e7dfe0cc89424b8d53027372">cc</a>,
<a name="l01723"></a>01723       bcc: this.bcc,
<a name="l01724"></a>01724       <a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a>: this.<a class="code" href="../../da/dce/details__test_8js.html#ab17dfde70922e77b2bbcbd0192a12531">subject</a>,
<a name="l01725"></a>01725       body: this.body,
<a name="l01726"></a>01726       referencesStr: this._references,
<a name="l01727"></a>01727       customHeaders: this._customHeaders,
<a name="l01728"></a>01728       attachments: this.attachments,
<a name="l01729"></a>01729     };
<a name="l01730"></a>01730   },
<a name="l01731"></a>01731 
<a name="l01764"></a>01764   finishCompositionSendMessage: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01765"></a>01765     this._api._composeDone(this._handle, <span class="stringliteral">&#39;send&#39;</span>, this._buildWireRep(),
<a name="l01766"></a>01766                            callback);
<a name="l01767"></a>01767   },
<a name="l01768"></a>01768 
<a name="l01772"></a>01772   saveDraft: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01773"></a>01773     this._api._composeDone(this._handle, <span class="stringliteral">&#39;save&#39;</span>, this._buildWireRep(),
<a name="l01774"></a>01774                            callback);
<a name="l01775"></a>01775   },
<a name="l01776"></a>01776 
<a name="l01785"></a>01785   abortCompositionDeleteDraft: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l01786"></a>01786     this._api._composeDone(this._handle, <span class="stringliteral">&#39;delete&#39;</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, callback);
<a name="l01787"></a>01787   },
<a name="l01788"></a>01788 
<a name="l01789"></a>01789 };
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 var LEGAL_CONFIG_KEYS = [];
<a name="l01792"></a>01792 
<a name="l01799"></a>01799 <span class="keyword">function</span> reportError() {
<a name="l01800"></a>01800   <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error.apply(<a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>, arguments);
<a name="l01801"></a>01801   var <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l01802"></a>01802   <span class="keywordflow">for</span> (var i = 0; i &lt; arguments.length; i++) {
<a name="l01803"></a>01803     <span class="keywordflow">if</span> (msg)
<a name="l01804"></a>01804       msg += <span class="stringliteral">&quot; &quot;</span> + arguments[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01805"></a>01805     <span class="keywordflow">else</span>
<a name="l01806"></a>01806       msg = <span class="stringliteral">&quot;&quot;</span> + arguments[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01807"></a>01807   }
<a name="l01808"></a>01808   <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(msg);
<a name="l01809"></a>01809 }
<a name="l01810"></a>01810 var unexpectedBridgeDataError = reportError,
<a name="l01811"></a>01811     internalError = reportError,
<a name="l01812"></a>01812     reportClientCodeError = reportError;
<a name="l01813"></a>01813 
<a name="l01814"></a>01814 
<a name="l01815"></a>01815 <span class="comment">// Common idioms:</span>
<a name="l01816"></a>01816 <span class="comment">//</span>
<a name="l01817"></a>01817 <span class="comment">// Lead-in (URL and email):</span>
<a name="l01818"></a>01818 <span class="comment">// (                     Capture because we need to know if there was a lead-in</span>
<a name="l01819"></a>01819 <span class="comment">//                       character so we can include it as part of the text</span>
<a name="l01820"></a>01820 <span class="comment">//                       preceding the match.  We lack look-behind matching.</span>
<a name="l01821"></a>01821 <span class="comment">//  ^|                   The URL/email can start at the beginninf of the string.</span>
<a name="l01822"></a>01822 <span class="comment">//  [\s(,;]              Or whitespace or some punctuation that does not imply</span>
<a name="l01823"></a>01823 <span class="comment">//                       a context which would preclude a URL.</span>
<a name="l01824"></a>01824 <span class="comment">// )</span>
<a name="l01825"></a>01825 <span class="comment">//</span>
<a name="l01826"></a>01826 <span class="comment">// We do not need a trailing look-ahead because our regex&#39;s will terminate</span>
<a name="l01827"></a>01827 <span class="comment">// because they run out of characters they can eat.</span>
<a name="l01828"></a>01828 
<a name="l01829"></a>01829 <span class="comment">// What we do not attempt to have the regexp do:</span>
<a name="l01830"></a>01830 <span class="comment">// - Avoid trailing &#39;.&#39; and &#39;)&#39; characters.  We let our greedy match absorb</span>
<a name="l01831"></a>01831 <span class="comment">//   these, but have a separate regex for extra characters to leave off at the</span>
<a name="l01832"></a>01832 <span class="comment">//   end.</span>
<a name="l01833"></a>01833 <span class="comment">//</span>
<a name="l01834"></a>01834 <span class="comment">// The Regex (apart from lead-in/lead-out):</span>
<a name="l01835"></a>01835 <span class="comment">// (                     Begin capture of the URL</span>
<a name="l01836"></a>01836 <span class="comment">//  (?:                  (potential detect beginnings)</span>
<a name="l01837"></a>01837 <span class="comment">//   https?:\/\/|        Start with &quot;http&quot; or &quot;https&quot;</span>
<a name="l01838"></a>01838 <span class="comment">//   www\d{0,3}[.][a-z0-9.\-]{2,249}|</span>
<a name="l01839"></a>01839 <span class="comment">//                      Start with &quot;www&quot;, up to 3 numbers, then &quot;.&quot; then</span>
<a name="l01840"></a>01840 <span class="comment">//                       something that looks domain-namey.  We differ from the</span>
<a name="l01841"></a>01841 <span class="comment">//                       next case in that we do not constrain the top-level</span>
<a name="l01842"></a>01842 <span class="comment">//                       domain as tightly and do not require a trailing path</span>
<a name="l01843"></a>01843 <span class="comment">//                       indicator of &quot;/&quot;.  This is IDN root compatible.</span>
<a name="l01844"></a>01844 <span class="comment">//   [a-z0-9.\-]{2,250}[.][a-z]{2,4}\/</span>
<a name="l01845"></a>01845 <span class="comment">//                       Detect a non-www domain, but requiring a trailing &quot;/&quot;</span>
<a name="l01846"></a>01846 <span class="comment">//                       to indicate a path.  This only detects IDN domains</span>
<a name="l01847"></a>01847 <span class="comment">//                       with a non-IDN root.  This is reasonable in cases where</span>
<a name="l01848"></a>01848 <span class="comment">//                       there is no explicit http/https start us out, but</span>
<a name="l01849"></a>01849 <span class="comment">//                       unreasonable where there is.  Our real fix is the bug</span>
<a name="l01850"></a>01850 <span class="comment">//                       to port the Thunderbird/gecko linkification logic.</span>
<a name="l01851"></a>01851 <span class="comment">//</span>
<a name="l01852"></a>01852 <span class="comment">//                       Domain names can be up to 253 characters long, and are</span>
<a name="l01853"></a>01853 <span class="comment">//                       limited to a-zA-Z0-9 and &#39;-&#39;.  The roots don&#39;t have</span>
<a name="l01854"></a>01854 <span class="comment">//                       hyphens unless they are IDN roots.  Root zones can be</span>
<a name="l01855"></a>01855 <span class="comment">//                       found here: http://www.iana.org/domains/root/db</span>
<a name="l01856"></a>01856 <span class="comment">//  )</span>
<a name="l01857"></a>01857 <span class="comment">//  [-\w.!~*&#39;();,/?:@&amp;=+$#%]*</span>
<a name="l01858"></a>01858 <span class="comment">//                       path onwards. We allow the set of characters that</span>
<a name="l01859"></a>01859 <span class="comment">//                       encodeURI does not escape plus the result of escaping</span>
<a name="l01860"></a>01860 <span class="comment">//                       (so also &#39;%&#39;)</span>
<a name="l01861"></a>01861 <span class="comment">// )</span>
<a name="l01862"></a>01862 var RE_URL =
<a name="l01863"></a>01863   /(^|[\s(,;])((?:<a class="code" href="../../da/d88/mock__configurator_8js.html#a143d22e446a0feb4cbd35b8b5e3c8d94">https</a>?:\/\/|www\d{0,3}[.][<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-z0-9.\-]{2,249}|[<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-z0-9.\-]{2,250}[.][<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-z]{2,4}\/)[-\w.!~*<span class="stringliteral">&#39;();,/?:@&amp;=+$#%]*)/im;</span>
<a name="l01864"></a>01864 <span class="stringliteral">// Set of terminators that are likely to have been part of the context rather</span>
<a name="l01865"></a>01865 <span class="stringliteral">// than part of the URL and so should be uneaten.  This is the same as our</span>
<a name="l01866"></a>01866 <span class="stringliteral">// mirror lead-in set (so &#39;</span>(<span class="stringliteral">&#39;, &#39;</span>,<span class="stringliteral">&#39;, &#39;</span>;<span class="stringliteral">&#39;) plus question end-ing punctuation and</span>
<a name="l01867"></a>01867 <span class="stringliteral">// the potential permutations with parentheses (english-specific)</span>
<a name="l01868"></a>01868 <span class="stringliteral">var RE_UNEAT_LAST_URL_CHARS = /(?:[),;.!?]|[.!?]\)|\)[.!?])$/;</span>
<a name="l01869"></a>01869 <span class="stringliteral">// Don&#39;</span>t <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a> the trailing slashes <a class="code" href="../../d9/dd6/_r_e_a_d_m_e_8md.html#a9d450900d743316d6a8272b17a524ae2">here</a> <span class="keywordflow">for</span> pre-pending purposes, although
<a name="l01870"></a>01870 <span class="comment">// our above regex currently requires them.</span>
<a name="l01871"></a><a class="code" href="../../d3/da0/apps_2email_2js_2ext_2mailapi_2main-frame-setup_8js.html#abfed7239b433557739b59dacb32b1ac3">01871</a> var <a class="code" href="../../d3/da0/apps_2email_2js_2ext_2mailapi_2main-frame-setup_8js.html#abfed7239b433557739b59dacb32b1ac3">RE_HTTP</a> = /^<a class="code" href="../../da/d88/mock__configurator_8js.html#a143d22e446a0feb4cbd35b8b5e3c8d94">https</a>?:/i;
<a name="l01872"></a>01872 <span class="comment">// Note: the [^\s] is fairly international friendly, but might be too friendly.</span>
<a name="l01873"></a>01873 <span class="comment">//</span>
<a name="l01874"></a>01874 <span class="comment">// Note: We&#39;ve added support for IDN domains in the e-mail regexp.  We would</span>
<a name="l01875"></a>01875 <span class="comment">// expect optimal presentation of IDN-based e-mail addresses to be using HTML</span>
<a name="l01876"></a>01876 <span class="comment">// mails with an &#39;a&#39; tag so that the human-readable address is present/visible,</span>
<a name="l01877"></a>01877 <span class="comment">// but we can&#39;t be sure of that.</span>
<a name="l01878"></a>01878 <span class="comment">//</span>
<a name="l01879"></a>01879 <span class="comment">// Brief analysis:</span>
<a name="l01880"></a>01880 <span class="comment">//   [a-z0-9.\-]{2,250}[.][a-z0-9\-]{2,32}</span>
<a name="l01881"></a>01881 <span class="comment">//                       Domain portion.  We have looser constraints on the</span>
<a name="l01882"></a>01882 <span class="comment">//                       root in terms of size since we already have the &#39;@&#39;</span>
<a name="l01883"></a>01883 <span class="comment">//                       giving us a high probability of an e-mail address.</span>
<a name="l01884"></a>01884 <span class="comment">//                       Otherwise we use the same base regexp from our URL</span>
<a name="l01885"></a>01885 <span class="comment">//                       logic.</span>
<a name="l01886"></a>01886 var RE_MAIL =
<a name="l01887"></a>01887   /(^|[\<a class="code" href="../../d9/d04/expat_8h.html#afa4d928795b38748c167cba7f7b9f04c">s</a>(,;])([^(,;@\s]+@[<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-z0-9.\-]{2,250}[.][<a class="code" href="../../d5/de7/jquery_8js.html#aa4d4888597588a84fd5b1184d00c91f3">a</a>-z0-9\-]{2,32})/<a class="code" href="../../df/d12/latin__test_8js.html#ab75af50057ff58634a935d87db33ebc7">im</a>;
<a name="l01888"></a>01888 var RE_MAILTO = /^mailto:/<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l01889"></a>01889 
<a name="l01890"></a>01890 var MailUtils = {
<a name="l01891"></a>01891 
<a name="l01895"></a>01895   linkifyPlain: <span class="keyword">function</span>(body, doc) {
<a name="l01896"></a>01896     var nodes = [];
<a name="l01897"></a>01897     var <a class="code" href="../../d2/d7d/jsapi_8h.html#a99e36b20cb6cf83fe7c1f4bff6902ab6">match</a> = <span class="keyword">true</span>, contentStart;
<a name="l01898"></a>01898     <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l01899"></a>01899       var <a class="code" href="../../d3/d4b/lockscreen_8js.html#a85c9a955e7da65bfd5fc9b87158c3570">url</a> = RE_URL.exec(body);
<a name="l01900"></a>01900       var email = RE_MAIL.exec(body);
<a name="l01901"></a>01901       <span class="comment">// Pick the regexp with the earlier content; index will always be zero.</span>
<a name="l01902"></a>01902       <span class="keywordflow">if</span> (url &amp;&amp;
<a name="l01903"></a>01903           (!email || url.index &lt; email.index)) {
<a name="l01904"></a>01904         contentStart = url.index + url[1].length;
<a name="l01905"></a>01905         <span class="keywordflow">if</span> (contentStart &gt; 0)
<a name="l01906"></a>01906           nodes.push(doc.createTextNode(body.substring(0, contentStart)));
<a name="l01907"></a>01907 
<a name="l01908"></a>01908         <span class="comment">// There are some final characters for a URL that are much more likely</span>
<a name="l01909"></a>01909         <span class="comment">// to have been part of the enclosing text rather than the end of the</span>
<a name="l01910"></a>01910         <span class="comment">// URL.</span>
<a name="l01911"></a>01911         var useUrl = url[2];
<a name="l01912"></a>01912         var uneat = RE_UNEAT_LAST_URL_CHARS.exec(useUrl);
<a name="l01913"></a>01913         <span class="keywordflow">if</span> (uneat) {
<a name="l01914"></a>01914           useUrl = useUrl.substring(0, uneat.index);
<a name="l01915"></a>01915         }
<a name="l01916"></a>01916 
<a name="l01917"></a>01917         var link = doc.createElement(<span class="charliteral">&#39;a&#39;</span>);
<a name="l01918"></a>01918         link.className = <span class="stringliteral">&#39;moz-external-link&#39;</span>;
<a name="l01919"></a>01919         <span class="comment">// the browser app needs us to put a protocol on the front</span>
<a name="l01920"></a>01920         <span class="keywordflow">if</span> (<a class="code" href="../../d3/da0/apps_2email_2js_2ext_2mailapi_2main-frame-setup_8js.html#abfed7239b433557739b59dacb32b1ac3">RE_HTTP</a>.test(url[2]))
<a name="l01921"></a>01921           link.setAttribute(<span class="stringliteral">&#39;ext-href&#39;</span>, useUrl);
<a name="l01922"></a>01922         <span class="keywordflow">else</span>
<a name="l01923"></a>01923           link.setAttribute(<span class="stringliteral">&#39;ext-href&#39;</span>, <span class="stringliteral">&#39;http://&#39;</span> + useUrl);
<a name="l01924"></a>01924         var <a class="code" href="../../dd/dfa/classtext.html">text</a> = doc.createTextNode(useUrl);
<a name="l01925"></a>01925         link.appendChild(text);
<a name="l01926"></a>01926         nodes.push(link);
<a name="l01927"></a>01927 
<a name="l01928"></a>01928         body = body.substring(url.index + url[1].length + useUrl.length);
<a name="l01929"></a>01929       }
<a name="l01930"></a>01930       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (email) {
<a name="l01931"></a>01931         contentStart = email.index + email[1].length;
<a name="l01932"></a>01932         <span class="keywordflow">if</span> (contentStart &gt; 0)
<a name="l01933"></a>01933           nodes.push(doc.createTextNode(body.substring(0, contentStart)));
<a name="l01934"></a>01934 
<a name="l01935"></a>01935         link = doc.createElement(<span class="charliteral">&#39;a&#39;</span>);
<a name="l01936"></a>01936         link.className = <span class="stringliteral">&#39;moz-external-link&#39;</span>;
<a name="l01937"></a>01937         <span class="keywordflow">if</span> (RE_MAILTO.test(email[2]))
<a name="l01938"></a>01938           link.setAttribute(<span class="stringliteral">&#39;ext-href&#39;</span>, email[2]);
<a name="l01939"></a>01939         <span class="keywordflow">else</span>
<a name="l01940"></a>01940           link.setAttribute(<span class="stringliteral">&#39;ext-href&#39;</span>, <span class="stringliteral">&#39;mailto:&#39;</span> + email[2]);
<a name="l01941"></a>01941         text = doc.createTextNode(email[2]);
<a name="l01942"></a>01942         link.appendChild(text);
<a name="l01943"></a>01943         nodes.push(link);
<a name="l01944"></a>01944 
<a name="l01945"></a>01945         body = body.substring(email.index + email[0].length);
<a name="l01946"></a>01946       }
<a name="l01947"></a>01947       <span class="keywordflow">else</span> {
<a name="l01948"></a>01948         <span class="keywordflow">break</span>;
<a name="l01949"></a>01949       }
<a name="l01950"></a>01950     }
<a name="l01951"></a>01951 
<a name="l01952"></a>01952     <span class="keywordflow">if</span> (body.length &gt; 0)
<a name="l01953"></a>01953       nodes.push(doc.createTextNode(body));
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     <span class="keywordflow">return</span> <a class="code" href="../../da/df2/namespacexml2dict.html#aaabd7336a42f36f8a79edd9e5fc821cf">nodes</a>;
<a name="l01956"></a>01956   },
<a name="l01957"></a>01957 
<a name="l01963"></a>01963   linkifyHTML: <span class="keyword">function</span>(doc) {
<a name="l01964"></a>01964     <span class="keyword">function</span> linkElem(elem) {
<a name="l01965"></a>01965       var children = elem.childNodes;
<a name="l01966"></a>01966       <span class="keywordflow">for</span> (var i in children) {
<a name="l01967"></a>01967         var <a class="code" href="../../d3/d91/j3d_8js.html#aaceec2222caaba9acc8a26f948e34afa">sub</a> = children[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l01968"></a>01968         <span class="keywordflow">if</span> (sub.nodeName == <span class="stringliteral">&#39;#text&#39;</span>) {
<a name="l01969"></a>01969           var nodes = MailUtils.linkifyPlain(sub.nodeValue, doc);
<a name="l01970"></a>01970 
<a name="l01971"></a>01971           elem.replaceChild(nodes[nodes.length-1], sub);
<a name="l01972"></a>01972           <span class="keywordflow">for</span> (var iNode = nodes.length-2; iNode &gt;= 0; --iNode) {
<a name="l01973"></a>01973             elem.insertBefore(nodes[iNode], nodes[iNode+1]);
<a name="l01974"></a>01974           }
<a name="l01975"></a>01975         }
<a name="l01976"></a>01976         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sub.nodeName != <span class="charliteral">&#39;A&#39;</span>) {
<a name="l01977"></a>01977           linkElem(sub);
<a name="l01978"></a>01978         }
<a name="l01979"></a>01979       }
<a name="l01980"></a>01980     }
<a name="l01981"></a>01981 
<a name="l01982"></a>01982     linkElem(doc.body);
<a name="l01983"></a>01983   },
<a name="l01984"></a>01984 };
<a name="l01985"></a>01985 
<a name="l01989"></a>01989 <span class="keyword">function</span> MailAPI() {
<a name="l01990"></a>01990   this._nextHandle = 1;
<a name="l01991"></a>01991 
<a name="l01992"></a>01992   this._slices = {};
<a name="l01993"></a>01993   this._pendingRequests = {};
<a name="l01994"></a>01994   this._liveBodies = {};
<a name="l01995"></a>01995 
<a name="l01996"></a>01996   <span class="comment">// Store bridgeSend messages received before back end spawns.</span>
<a name="l01997"></a>01997   this._storedSends = [];
<a name="l01998"></a>01998 
<a name="l01999"></a>01999   this._processingMessage = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02005"></a>02005   this._deferredMessages = [];
<a name="l02006"></a>02006 
<a name="l02020"></a>02020   this.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a> = {};
<a name="l02021"></a>02021 
<a name="l02036"></a>02036   this.onbadlogin = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02037"></a>02037 
<a name="l02038"></a>02038   ContactCache.init();
<a name="l02039"></a>02039 }
<a name="l02040"></a>02040 <a class="code" href="../../d8/deb/test_2marionette_2lib_2browser_8js.html#aa4072ba4b6b56b0fb6f4801f17ab2b34">exports</a>.MailAPI = MailAPI;
<a name="l02041"></a>02041 MailAPI.prototype = {
<a name="l02042"></a>02042   <a class="code" href="../../d4/d23/binary__string__view_8js.html#a64379212b203168995cd87810b47adbe">toString</a>: <span class="keyword">function</span>() {
<a name="l02043"></a>02043     <span class="keywordflow">return</span> <span class="stringliteral">&#39;[MailAPI]&#39;</span>;
<a name="l02044"></a>02044   },
<a name="l02045"></a>02045   toJSON: <span class="keyword">function</span>() {
<a name="l02046"></a>02046     <span class="keywordflow">return</span> { <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;MailAPI&#39;</span> };
<a name="l02047"></a>02047   },
<a name="l02048"></a>02048 
<a name="l02049"></a>02049   <a class="code" href="../../d0/df4/contacts__shortcuts_8js.html#a7b58b8887c6d26e09f79fbacfbda7f53">utils</a>: MailUtils,
<a name="l02050"></a>02050 
<a name="l02055"></a>02055   __bridgeSend: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02056"></a>02056     <span class="comment">// This method gets clobbered eventually once back end worker is ready.</span>
<a name="l02057"></a>02057     <span class="comment">// Until then, it will store calls to send to the back end.</span>
<a name="l02058"></a>02058 
<a name="l02059"></a>02059     this._storedSends.push(msg);
<a name="l02060"></a>02060   },
<a name="l02061"></a>02061 
<a name="l02065"></a>02065   __bridgeReceive: <span class="keyword">function</span> ma___bridgeReceive(msg) {
<a name="l02066"></a>02066     <span class="keywordflow">if</span> (this._processingMessage) {
<a name="l02067"></a>02067       this._deferredMessages.push(msg);
<a name="l02068"></a>02068     }
<a name="l02069"></a>02069     <span class="keywordflow">else</span> {
<a name="l02070"></a>02070       this._processMessage(msg);
<a name="l02071"></a>02071     }
<a name="l02072"></a>02072   },
<a name="l02073"></a>02073 
<a name="l02074"></a>02074   _processMessage: <span class="keyword">function</span> ma__processMessage(msg) {
<a name="l02075"></a>02075     var methodName = <span class="stringliteral">&#39;_recv_&#39;</span> + msg.type;
<a name="l02076"></a>02076     <span class="keywordflow">if</span> (!(methodName in <span class="keyword">this</span>)) {
<a name="l02077"></a>02077       unexpectedBridgeDataError(<span class="stringliteral">&#39;Unsupported message type:&#39;</span>, msg.type);
<a name="l02078"></a>02078       <span class="keywordflow">return</span>;
<a name="l02079"></a>02079     }
<a name="l02080"></a>02080     <span class="keywordflow">try</span> {
<a name="l02081"></a>02081       var <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a> = <span class="keyword">this</span>[methodName](<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>);
<a name="l02082"></a>02082       <span class="keywordflow">if</span> (!done)
<a name="l02083"></a>02083         this._processingMessage = <a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>;
<a name="l02084"></a>02084     }
<a name="l02085"></a>02085     <span class="keywordflow">catch</span> (ex) {
<a name="l02086"></a>02086       internalError(<span class="stringliteral">&#39;Problem handling message type:&#39;</span>, msg.type, ex,
<a name="l02087"></a>02087                     <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l02088"></a>02088       <span class="keywordflow">return</span>;
<a name="l02089"></a>02089     }
<a name="l02090"></a>02090   },
<a name="l02091"></a>02091 
<a name="l02092"></a>02092   _doneProcessingMessage: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02093"></a>02093     <span class="keywordflow">if</span> (this._processingMessage &amp;&amp; this._processingMessage !== msg)
<a name="l02094"></a>02094       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;Mismatched message completion!&#39;</span>);
<a name="l02095"></a>02095 
<a name="l02096"></a>02096     this._processingMessage = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02097"></a>02097     <span class="keywordflow">while</span> (this._processingMessage === <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a> &amp;&amp; this._deferredMessages.length) {
<a name="l02098"></a>02098       this._processMessage(this._deferredMessages.shift());
<a name="l02099"></a>02099     }
<a name="l02100"></a>02100   },
<a name="l02101"></a>02101 
<a name="l02102"></a>02102   _recv_badLogin: <span class="keyword">function</span> ma__recv_badLogin(msg) {
<a name="l02103"></a>02103     <span class="keywordflow">if</span> (this.onbadlogin)
<a name="l02104"></a>02104       this.onbadlogin(<span class="keyword">new</span> MailAccount(<span class="keyword">this</span>, msg.account, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>), msg.problem);
<a name="l02105"></a>02105     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02106"></a>02106   },
<a name="l02107"></a>02107 
<a name="l02108"></a>02108   _recv_sliceSplice: <span class="keyword">function</span> ma__recv_sliceSplice(msg, fake) {
<a name="l02109"></a>02109     var <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a> = this._slices[msg.handle];
<a name="l02110"></a>02110     <span class="keywordflow">if</span> (!slice) {
<a name="l02111"></a>02111       unexpectedBridgeDataError(<span class="stringliteral">&#39;Received message about a nonexistent slice:&#39;</span>,
<a name="l02112"></a>02112                                 msg.handle);
<a name="l02113"></a>02113       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02114"></a>02114     }
<a name="l02115"></a>02115 
<a name="l02116"></a>02116     var transformedItems = this._transform_sliceSplice(msg, slice);
<a name="l02117"></a>02117     <span class="comment">// It&#39;s possible that a transformed representation is depending on an async</span>
<a name="l02118"></a>02118     <span class="comment">// call to mozContacts.  In this case, we don&#39;t want to surface the data to</span>
<a name="l02119"></a>02119     <span class="comment">// the UI until the contacts are fully resolved in order to avoid the UI</span>
<a name="l02120"></a>02120     <span class="comment">// flickering or just triggering reflows that could otherwise be avoided.</span>
<a name="l02121"></a>02121     <span class="keywordflow">if</span> (ContactCache.pendingLookupCount) {
<a name="l02122"></a>02122       ContactCache.callbacks.push(<span class="keyword">function</span> contactsResolved() {
<a name="l02123"></a>02123         this._fire_sliceSplice(msg, slice, transformedItems, fake);
<a name="l02124"></a>02124         this._doneProcessingMessage(msg);
<a name="l02125"></a>02125       }.bind(<span class="keyword">this</span>));
<a name="l02126"></a>02126       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02127"></a>02127     }
<a name="l02128"></a>02128     <span class="keywordflow">else</span> {
<a name="l02129"></a>02129       this._fire_sliceSplice(msg, slice, transformedItems, fake);
<a name="l02130"></a>02130       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02131"></a>02131     }
<a name="l02132"></a>02132   },
<a name="l02133"></a>02133 
<a name="l02134"></a>02134   _transform_sliceSplice: <span class="keyword">function</span> ma__transform_sliceSplice(msg, slice) {
<a name="l02135"></a>02135     var addItems = msg.addItems, transformedItems = [], <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l02136"></a>02136     <span class="keywordflow">switch</span> (slice._ns) {
<a name="l02137"></a>02137       <span class="keywordflow">case</span> <span class="stringliteral">&#39;accounts&#39;</span>:
<a name="l02138"></a>02138         <span class="keywordflow">for</span> (i = 0; i &lt; addItems.length; i++) {
<a name="l02139"></a>02139           transformedItems.push(<span class="keyword">new</span> MailAccount(<span class="keyword">this</span>, addItems[i], slice));
<a name="l02140"></a>02140         }
<a name="l02141"></a>02141         <span class="keywordflow">break</span>;
<a name="l02142"></a>02142 
<a name="l02143"></a>02143       <span class="keywordflow">case</span> <span class="stringliteral">&#39;identities&#39;</span>:
<a name="l02144"></a>02144         <span class="keywordflow">for</span> (i = 0; i &lt; addItems.length; i++) {
<a name="l02145"></a>02145           transformedItems.push(<span class="keyword">new</span> MailSenderIdentity(<span class="keyword">this</span>, addItems[i]));
<a name="l02146"></a>02146         }
<a name="l02147"></a>02147         <span class="keywordflow">break</span>;
<a name="l02148"></a>02148 
<a name="l02149"></a>02149       <span class="keywordflow">case</span> <span class="stringliteral">&#39;folders&#39;</span>:
<a name="l02150"></a>02150         <span class="keywordflow">for</span> (i = 0; i &lt; addItems.length; i++) {
<a name="l02151"></a>02151           transformedItems.push(<span class="keyword">new</span> MailFolder(<span class="keyword">this</span>, addItems[i]));
<a name="l02152"></a>02152         }
<a name="l02153"></a>02153         <span class="keywordflow">break</span>;
<a name="l02154"></a>02154 
<a name="l02155"></a>02155       <span class="keywordflow">case</span> <span class="stringliteral">&#39;headers&#39;</span>:
<a name="l02156"></a>02156         <span class="keywordflow">for</span> (i = 0; i &lt; addItems.length; i++) {
<a name="l02157"></a>02157           transformedItems.push(<span class="keyword">new</span> MailHeader(slice, addItems[i]));
<a name="l02158"></a>02158         }
<a name="l02159"></a>02159         <span class="keywordflow">break</span>;
<a name="l02160"></a>02160 
<a name="l02161"></a>02161       <span class="keywordflow">case</span> <span class="stringliteral">&#39;matchedHeaders&#39;</span>:
<a name="l02162"></a>02162         <span class="keywordflow">for</span> (i = 0; i &lt; addItems.length; i++) {
<a name="l02163"></a>02163           transformedItems.push(<span class="keyword">new</span> MailMatchedHeader(slice, addItems[i]));
<a name="l02164"></a>02164         }
<a name="l02165"></a>02165         <span class="keywordflow">break</span>;
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 
<a name="l02168"></a>02168       <span class="keywordflow">default</span>:
<a name="l02169"></a>02169         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Slice notification for unknown type:&#39;</span>, slice._ns);
<a name="l02170"></a>02170         <span class="keywordflow">break</span>;
<a name="l02171"></a>02171     }
<a name="l02172"></a>02172 
<a name="l02173"></a>02173     <span class="keywordflow">return</span> transformedItems;
<a name="l02174"></a>02174   },
<a name="l02175"></a>02175 
<a name="l02176"></a>02176   _fire_sliceSplice: <span class="keyword">function</span> ma__fire_sliceSplice(msg, slice,
<a name="l02177"></a>02177                                                    transformedItems, fake) {
<a name="l02178"></a>02178     var <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, stopIndex, items, tempMsg;
<a name="l02179"></a>02179 
<a name="l02180"></a>02180     <span class="comment">// - generate namespace-specific notifications</span>
<a name="l02181"></a>02181     slice.atTop = msg.atTop;
<a name="l02182"></a>02182     slice.atBottom = msg.atBottom;
<a name="l02183"></a>02183     slice.userCanGrowUpwards = msg.userCanGrowUpwards;
<a name="l02184"></a>02184     slice.userCanGrowDownwards = msg.userCanGrowDownwards;
<a name="l02185"></a>02185     <span class="keywordflow">if</span> (msg.status &amp;&amp;
<a name="l02186"></a>02186         (slice.status !== msg.status ||
<a name="l02187"></a>02187          slice.syncProgress !== msg.progress)) {
<a name="l02188"></a>02188       slice.status = msg.status;
<a name="l02189"></a>02189       slice.syncProgress = msg.progress;
<a name="l02190"></a>02190       <span class="keywordflow">if</span> (slice.onstatus)
<a name="l02191"></a>02191         slice.onstatus(slice.status);
<a name="l02192"></a>02192     }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194     <span class="comment">// - generate slice &#39;onsplice&#39; notification</span>
<a name="l02195"></a>02195     <span class="keywordflow">if</span> (slice.onsplice) {
<a name="l02196"></a>02196       <span class="keywordflow">try</span> {
<a name="l02197"></a>02197         slice.onsplice(msg.index, msg.howMany, transformedItems,
<a name="l02198"></a>02198                        msg.requested, msg.moreExpected, fake);
<a name="l02199"></a>02199       }
<a name="l02200"></a>02200       <span class="keywordflow">catch</span> (ex) {
<a name="l02201"></a>02201         reportClientCodeError(<span class="stringliteral">&#39;onsplice notification error&#39;</span>, ex,
<a name="l02202"></a>02202                               <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l02203"></a>02203       }
<a name="l02204"></a>02204     }
<a name="l02205"></a>02205     <span class="comment">// - generate item &#39;onremove&#39; notifications</span>
<a name="l02206"></a>02206     <span class="keywordflow">if</span> (msg.howMany) {
<a name="l02207"></a>02207       <span class="keywordflow">try</span> {
<a name="l02208"></a>02208         stopIndex = msg.index + msg.howMany;
<a name="l02209"></a>02209         <span class="keywordflow">for</span> (i = msg.index; i &lt; stopIndex; i++) {
<a name="l02210"></a>02210           var item = slice.items[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l02211"></a>02211           <span class="keywordflow">if</span> (slice.onremove)
<a name="l02212"></a>02212             slice.onremove(item, i);
<a name="l02213"></a>02213           <span class="keywordflow">if</span> (item.onremove)
<a name="l02214"></a>02214             item.onremove(item, i);
<a name="l02215"></a>02215           <span class="comment">// the item needs a chance to clean up after itself.</span>
<a name="l02216"></a>02216           item.__die();
<a name="l02217"></a>02217         }
<a name="l02218"></a>02218       }
<a name="l02219"></a>02219       <span class="keywordflow">catch</span> (ex) {
<a name="l02220"></a>02220         reportClientCodeError(<span class="stringliteral">&#39;onremove notification error&#39;</span>, ex,
<a name="l02221"></a>02221                               <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l02222"></a>02222       }
<a name="l02223"></a>02223     }
<a name="l02224"></a>02224     <span class="comment">// - perform actual splice</span>
<a name="l02225"></a>02225     slice.items.splice.apply(slice.items,
<a name="l02226"></a>02226                              [msg.index, msg.howMany].concat(transformedItems));
<a name="l02227"></a>02227     <span class="comment">// - generate item &#39;onadd&#39; notifications</span>
<a name="l02228"></a>02228     <span class="keywordflow">if</span> (slice.onadd) {
<a name="l02229"></a>02229       <span class="keywordflow">try</span> {
<a name="l02230"></a>02230         stopIndex = msg.index + transformedItems.length;
<a name="l02231"></a>02231         <span class="keywordflow">for</span> (i = msg.index; i &lt; stopIndex; i++) {
<a name="l02232"></a>02232           slice.onadd(slice.items[i], i);
<a name="l02233"></a>02233         }
<a name="l02234"></a>02234       }
<a name="l02235"></a>02235       <span class="keywordflow">catch</span> (ex) {
<a name="l02236"></a>02236         reportClientCodeError(<span class="stringliteral">&#39;onadd notification error&#39;</span>, ex,
<a name="l02237"></a>02237                               <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l02238"></a>02238       }
<a name="l02239"></a>02239     }
<a name="l02240"></a>02240 
<a name="l02241"></a>02241     <span class="comment">// - generate &#39;oncomplete&#39; notification</span>
<a name="l02242"></a>02242     <span class="keywordflow">if</span> (msg.requested &amp;&amp; !msg.moreExpected) {
<a name="l02243"></a>02243       slice._growing = 0;
<a name="l02244"></a>02244       <span class="keywordflow">if</span> (slice.pendingRequestCount)
<a name="l02245"></a>02245         slice.pendingRequestCount--;
<a name="l02246"></a>02246 
<a name="l02247"></a>02247       <span class="keywordflow">if</span> (slice.oncomplete) {
<a name="l02248"></a>02248         var completeFunc = slice.oncomplete;
<a name="l02249"></a>02249         <span class="comment">// reset before calling in case it wants to chain.</span>
<a name="l02250"></a>02250         slice.oncomplete = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02251"></a>02251         <span class="keywordflow">try</span> {
<a name="l02252"></a>02252           completeFunc(msg.newEmailCount);
<a name="l02253"></a>02253         }
<a name="l02254"></a>02254         <span class="keywordflow">catch</span> (ex) {
<a name="l02255"></a>02255           reportClientCodeError(<span class="stringliteral">&#39;oncomplete notification error&#39;</span>, ex,
<a name="l02256"></a>02256                                 <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l02257"></a>02257         }
<a name="l02258"></a>02258       }
<a name="l02259"></a>02259     }
<a name="l02260"></a>02260   },
<a name="l02261"></a>02261 
<a name="l02262"></a>02262   _recv_sliceUpdate: <span class="keyword">function</span> ma__recv_sliceUpdate(msg) {
<a name="l02263"></a>02263     var slice = this._slices[msg.handle];
<a name="l02264"></a>02264     <span class="keywordflow">if</span> (!slice) {
<a name="l02265"></a>02265       unexpectedBridgeDataError(<span class="stringliteral">&#39;Received message about a nonexistent slice:&#39;</span>,
<a name="l02266"></a>02266                                 msg.handle);
<a name="l02267"></a>02267       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02268"></a>02268     }
<a name="l02269"></a>02269 
<a name="l02270"></a>02270     var updates = msg.updates;
<a name="l02271"></a>02271     <span class="keywordflow">try</span> {
<a name="l02272"></a>02272       <span class="keywordflow">for</span> (var i = 0; i &lt; updates.length; i += 2) {
<a name="l02273"></a>02273         var idx = updates[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>], wireRep = updates[i + 1],
<a name="l02274"></a>02274             itemObj = slice.items[idx];
<a name="l02275"></a>02275         itemObj.__update(wireRep);
<a name="l02276"></a>02276         <span class="keywordflow">if</span> (slice.onchange)
<a name="l02277"></a>02277           slice.onchange(itemObj, idx);
<a name="l02278"></a>02278         <span class="keywordflow">if</span> (itemObj.onchange)
<a name="l02279"></a>02279           itemObj.onchange(itemObj, idx);
<a name="l02280"></a>02280       }
<a name="l02281"></a>02281     }
<a name="l02282"></a>02282     <span class="keywordflow">catch</span> (ex) {
<a name="l02283"></a>02283       reportClientCodeError(<span class="stringliteral">&#39;onchange notification error&#39;</span>, ex,
<a name="l02284"></a>02284                             <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l02285"></a>02285     }
<a name="l02286"></a>02286     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02287"></a>02287   },
<a name="l02288"></a>02288 
<a name="l02289"></a>02289   _recv_sliceDead: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02290"></a>02290     var slice = this._slices[msg.handle];
<a name="l02291"></a>02291     <span class="keyword">delete</span> this._slices[msg.handle];
<a name="l02292"></a>02292     <span class="keywordflow">if</span> (slice.ondead)
<a name="l02293"></a>02293       slice.ondead(slice);
<a name="l02294"></a>02294     slice.ondead = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02295"></a>02295 
<a name="l02296"></a>02296     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02297"></a>02297   },
<a name="l02298"></a>02298 
<a name="l02299"></a>02299   _getBodyForMessage: <span class="keyword">function</span>(<a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02300"></a>02300 
<a name="l02301"></a>02301     var downloadBodyReps = <span class="keyword">false</span>, withBodyReps = <span class="keyword">false</span>;
<a name="l02302"></a>02302 
<a name="l02303"></a>02303     <span class="keywordflow">if</span> (options &amp;&amp; options.downloadBodyReps) {
<a name="l02304"></a>02304       downloadBodyReps = options.downloadBodyReps;
<a name="l02305"></a>02305     }
<a name="l02306"></a>02306     <span class="keywordflow">if</span> (options &amp;&amp; options.withBodyReps) {
<a name="l02307"></a>02307       withBodyReps = options.withBodyReps;
<a name="l02308"></a>02308     }
<a name="l02309"></a>02309 
<a name="l02310"></a>02310     var <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a> = this._nextHandle++;
<a name="l02311"></a>02311     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l02312"></a>02312       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;getBody&#39;</span>,
<a name="l02313"></a>02313       suid: <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>.id,
<a name="l02314"></a>02314       callback: callback
<a name="l02315"></a>02315     };
<a name="l02316"></a>02316     this.__bridgeSend({
<a name="l02317"></a>02317       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;getBody&#39;</span>,
<a name="l02318"></a>02318       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02319"></a>02319       suid: <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>.id,
<a name="l02320"></a>02320       <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: <a class="code" href="../../d8/dbd/namespaceheader.html#aa5b53e6fddfb0e2e76fa4f5cf837317b">header</a>.date.valueOf(),
<a name="l02321"></a>02321       downloadBodyReps: downloadBodyReps,
<a name="l02322"></a>02322       withBodyReps: withBodyReps
<a name="l02323"></a>02323     });
<a name="l02324"></a>02324   },
<a name="l02325"></a>02325 
<a name="l02326"></a>02326   _recv_gotBody: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02327"></a>02327     var req = this._pendingRequests[msg.handle];
<a name="l02328"></a>02328     <span class="keywordflow">if</span> (!req) {
<a name="l02329"></a>02329       unexpectedBridgeDataError(<span class="stringliteral">&#39;Bad handle for got body:&#39;</span>, msg.handle);
<a name="l02330"></a>02330       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02331"></a>02331     }
<a name="l02332"></a>02332     <span class="keyword">delete</span> this._pendingRequests[msg.handle];
<a name="l02333"></a>02333 
<a name="l02334"></a>02334     var body = msg.bodyInfo ?
<a name="l02335"></a>02335       <span class="keyword">new</span> MailBody(<span class="keyword">this</span>, req.suid, msg.bodyInfo, msg.handle) :
<a name="l02336"></a>02336       <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02337"></a>02337 
<a name="l02338"></a>02338     <span class="keywordflow">if</span> (body) {
<a name="l02339"></a>02339       this._liveBodies[msg.handle] = body;
<a name="l02340"></a>02340     }
<a name="l02341"></a>02341 
<a name="l02342"></a>02342     req.callback.call(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, body);
<a name="l02343"></a>02343 
<a name="l02344"></a>02344     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02345"></a>02345   },
<a name="l02346"></a>02346 
<a name="l02347"></a>02347   _recv_requestBodiesComplete: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02348"></a>02348     var slice = this._slices[msg.handle];
<a name="l02349"></a>02349     <span class="comment">// The slice may be dead now!</span>
<a name="l02350"></a>02350     <span class="keywordflow">if</span> (slice)
<a name="l02351"></a>02351       slice._notifyRequestBodiesComplete(msg.requestId);
<a name="l02352"></a>02352 
<a name="l02353"></a>02353     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02354"></a>02354   },
<a name="l02355"></a>02355 
<a name="l02356"></a>02356   _recv_bodyModified: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02357"></a>02357     var body = this._liveBodies[msg.handle];
<a name="l02358"></a>02358 
<a name="l02359"></a>02359     <span class="keywordflow">if</span> (!body) {
<a name="l02360"></a>02360       unexpectedBridgeDataError(<span class="stringliteral">&#39;body modified for dead handle&#39;</span>, msg.handle);
<a name="l02361"></a>02361       <span class="comment">// possible but very unlikely race condition where body is modified while</span>
<a name="l02362"></a>02362       <span class="comment">// we are removing the reference to the observer...</span>
<a name="l02363"></a>02363       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02364"></a>02364     }
<a name="l02365"></a>02365 
<a name="l02366"></a>02366     <span class="keywordflow">if</span> (body.onchange) {
<a name="l02367"></a>02367       <span class="comment">// there may be many kinds of updates we want to support but we only</span>
<a name="l02368"></a>02368       <span class="comment">// support updating the bodyReps reference currently.</span>
<a name="l02369"></a>02369       <span class="keywordflow">switch</span> (msg.detail.changeType) {
<a name="l02370"></a>02370         <span class="keywordflow">case</span> <span class="stringliteral">&#39;bodyReps&#39;</span>:
<a name="l02371"></a>02371           body.bodyReps = msg.bodyInfo.bodyReps;
<a name="l02372"></a>02372           <span class="keywordflow">break</span>;
<a name="l02373"></a>02373       }
<a name="l02374"></a>02374 
<a name="l02375"></a>02375       body.onchange(
<a name="l02376"></a>02376         msg.detail,
<a name="l02377"></a>02377         msg.bodyInfo
<a name="l02378"></a>02378       );
<a name="l02379"></a>02379     }
<a name="l02380"></a>02380 
<a name="l02381"></a>02381     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02382"></a>02382   },
<a name="l02383"></a>02383 
<a name="l02384"></a>02384   _recv_bodyDead: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02385"></a>02385     var body = this._liveBodies[msg.handle];
<a name="l02386"></a>02386 
<a name="l02387"></a>02387     <span class="keywordflow">if</span> (body &amp;&amp; body.ondead) {
<a name="l02388"></a>02388       body.ondead();
<a name="l02389"></a>02389     }
<a name="l02390"></a>02390 
<a name="l02391"></a>02391     <span class="keyword">delete</span> this._liveBodies[msg.handle];
<a name="l02392"></a>02392     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02393"></a>02393   },
<a name="l02394"></a>02394 
<a name="l02395"></a>02395   _downloadAttachments: <span class="keyword">function</span>(body, relPartIndices, attachmentIndices,
<a name="l02396"></a>02396                                  callWhenDone, callOnProgress) {
<a name="l02397"></a>02397     var handle = this._nextHandle++;
<a name="l02398"></a>02398     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l02399"></a>02399       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;downloadAttachments&#39;</span>,
<a name="l02400"></a>02400       body: body,
<a name="l02401"></a>02401       relParts: relPartIndices.length &gt; 0,
<a name="l02402"></a>02402       attachments: attachmentIndices.length &gt; 0,
<a name="l02403"></a>02403       callback: callWhenDone,
<a name="l02404"></a>02404       progress: callOnProgress
<a name="l02405"></a>02405     };
<a name="l02406"></a>02406     this.__bridgeSend({
<a name="l02407"></a>02407       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;downloadAttachments&#39;</span>,
<a name="l02408"></a>02408       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02409"></a>02409       suid: body.id,
<a name="l02410"></a>02410       <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>: body._date,
<a name="l02411"></a>02411       relPartIndices: relPartIndices,
<a name="l02412"></a>02412       attachmentIndices: attachmentIndices
<a name="l02413"></a>02413     });
<a name="l02414"></a>02414   },
<a name="l02415"></a>02415 
<a name="l02416"></a>02416   _recv_downloadedAttachments: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02417"></a>02417     var req = this._pendingRequests[msg.handle];
<a name="l02418"></a>02418     <span class="keywordflow">if</span> (!req) {
<a name="l02419"></a>02419       unexpectedBridgeDataError(<span class="stringliteral">&#39;Bad handle for got body:&#39;</span>, msg.handle);
<a name="l02420"></a>02420       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02421"></a>02421     }
<a name="l02422"></a>02422     <span class="keyword">delete</span> this._pendingRequests[msg.handle];
<a name="l02423"></a>02423 
<a name="l02424"></a>02424     <span class="comment">// What will have changed are the attachment lists, so update them.</span>
<a name="l02425"></a>02425     <span class="keywordflow">if</span> (msg.bodyInfo) {
<a name="l02426"></a>02426       <span class="keywordflow">if</span> (req.relParts)
<a name="l02427"></a>02427         req.body._relatedParts = msg.bodyInfo.relatedParts;
<a name="l02428"></a>02428       <span class="keywordflow">if</span> (req.attachments) {
<a name="l02429"></a>02429         var wireAtts = msg.bodyInfo.attachments;
<a name="l02430"></a>02430         <span class="keywordflow">for</span> (var i = 0; i &lt; wireAtts.length; i++) {
<a name="l02431"></a>02431           var wireAtt = wireAtts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>], bodyAtt = req.body.attachments[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l02432"></a>02432           bodyAtt.sizeEstimateInBytes = wireAtt.sizeEstimate;
<a name="l02433"></a>02433           bodyAtt._file = wireAtt.file;
<a name="l02434"></a>02434         }
<a name="l02435"></a>02435       }
<a name="l02436"></a>02436     }
<a name="l02437"></a>02437     <span class="keywordflow">if</span> (req.callback)
<a name="l02438"></a>02438       req.callback.call(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, req.body);
<a name="l02439"></a>02439     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02440"></a>02440   },
<a name="l02441"></a>02441 
<a name="l02544"></a>02544   tryToCreateAccount: <span class="keyword">function</span> ma_tryToCreateAccount(details, domainInfo,
<a name="l02545"></a>02545                                                      callback) {
<a name="l02546"></a>02546     var handle = this._nextHandle++;
<a name="l02547"></a>02547     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l02548"></a>02548       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;tryToCreateAccount&#39;</span>,
<a name="l02549"></a>02549       details: details,
<a name="l02550"></a>02550       domainInfo: domainInfo,
<a name="l02551"></a>02551       callback: callback
<a name="l02552"></a>02552     };
<a name="l02553"></a>02553     this.__bridgeSend({
<a name="l02554"></a>02554       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;tryToCreateAccount&#39;</span>,
<a name="l02555"></a>02555       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02556"></a>02556       details: details,
<a name="l02557"></a>02557       domainInfo: domainInfo
<a name="l02558"></a>02558     });
<a name="l02559"></a>02559   },
<a name="l02560"></a>02560 
<a name="l02561"></a>02561   _recv_tryToCreateAccountResults:
<a name="l02562"></a>02562       <span class="keyword">function</span> ma__recv_tryToCreateAccountResults(msg) {
<a name="l02563"></a>02563     var req = this._pendingRequests[msg.handle];
<a name="l02564"></a>02564     <span class="keywordflow">if</span> (!req) {
<a name="l02565"></a>02565       unexpectedBridgeDataError(<span class="stringliteral">&#39;Bad handle for create account:&#39;</span>, msg.handle);
<a name="l02566"></a>02566       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02567"></a>02567     }
<a name="l02568"></a>02568     <span class="keyword">delete</span> this._pendingRequests[msg.handle];
<a name="l02569"></a>02569 
<a name="l02570"></a>02570     <span class="comment">// The account info here is currently for unit testing only; it&#39;s our wire</span>
<a name="l02571"></a>02571     <span class="comment">// protocol instead of a full MailAccount.</span>
<a name="l02572"></a>02572     req.callback.call(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, msg.error, msg.errorDetails, msg.account);
<a name="l02573"></a>02573     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02574"></a>02574   },
<a name="l02575"></a>02575 
<a name="l02576"></a>02576   _clearAccountProblems: <span class="keyword">function</span> ma__clearAccountProblems(account, callback) {
<a name="l02577"></a>02577     var handle = this._nextHandle++;
<a name="l02578"></a>02578     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l02579"></a>02579       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;clearAccountProblems&#39;</span>,
<a name="l02580"></a>02580       callback: <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>,
<a name="l02581"></a>02581     };
<a name="l02582"></a>02582     this.__bridgeSend({
<a name="l02583"></a>02583       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;clearAccountProblems&#39;</span>,
<a name="l02584"></a>02584       accountId: account.id,
<a name="l02585"></a>02585       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02586"></a>02586     });
<a name="l02587"></a>02587   },
<a name="l02588"></a>02588 
<a name="l02589"></a>02589   _recv_clearAccountProblems: <span class="keyword">function</span> ma__recv_clearAccountProblems(msg) {
<a name="l02590"></a>02590     var req = this._pendingRequests[msg.handle];
<a name="l02591"></a>02591     <span class="keyword">delete</span> this._pendingRequests[msg.handle];
<a name="l02592"></a>02592     req.callback &amp;&amp; req.callback();
<a name="l02593"></a>02593     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02594"></a>02594   },
<a name="l02595"></a>02595 
<a name="l02596"></a>02596   _modifyAccount: <span class="keyword">function</span> ma__modifyAccount(account, mods) {
<a name="l02597"></a>02597     this.__bridgeSend({
<a name="l02598"></a>02598       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;modifyAccount&#39;</span>,
<a name="l02599"></a>02599       accountId: account.id,
<a name="l02600"></a>02600       mods: mods,
<a name="l02601"></a>02601     });
<a name="l02602"></a>02602   },
<a name="l02603"></a>02603 
<a name="l02604"></a>02604   _deleteAccount: <span class="keyword">function</span> ma__deleteAccount(account) {
<a name="l02605"></a>02605     this.__bridgeSend({
<a name="l02606"></a>02606       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;deleteAccount&#39;</span>,
<a name="l02607"></a>02607       accountId: account.id,
<a name="l02608"></a>02608     });
<a name="l02609"></a>02609   },
<a name="l02610"></a>02610 
<a name="l02624"></a>02624   viewAccounts: <span class="keyword">function</span> ma_viewAccounts(realAccountsOnly) {
<a name="l02625"></a>02625     var handle = this._nextHandle++,
<a name="l02626"></a>02626         slice = <span class="keyword">new</span> AccountsViewSlice(<span class="keyword">this</span>, handle);
<a name="l02627"></a>02627     this._slices[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02628"></a>02628 
<a name="l02629"></a>02629     this.__bridgeSend({
<a name="l02630"></a>02630       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;viewAccounts&#39;</span>,
<a name="l02631"></a>02631       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02632"></a>02632     });
<a name="l02633"></a>02633     <span class="keywordflow">return</span> <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02634"></a>02634   },
<a name="l02635"></a>02635 
<a name="l02640"></a>02640   viewSenderIdentities: <span class="keyword">function</span> ma_viewSenderIdentities() {
<a name="l02641"></a>02641     var handle = this._nextHandle++,
<a name="l02642"></a>02642         slice = <span class="keyword">new</span> BridgedViewSlice(<span class="keyword">this</span>, <span class="stringliteral">&#39;identities&#39;</span>, handle);
<a name="l02643"></a>02643     this._slices[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02644"></a>02644 
<a name="l02645"></a>02645     this.__bridgeSend({
<a name="l02646"></a>02646       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;viewSenderIdentities&#39;</span>,
<a name="l02647"></a>02647       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02648"></a>02648     });
<a name="l02649"></a>02649     <span class="keywordflow">return</span> <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02650"></a>02650   },
<a name="l02651"></a>02651 
<a name="l02671"></a>02671   viewFolders: <span class="keyword">function</span> ma_viewFolders(<a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>, argument) {
<a name="l02672"></a>02672     var handle = this._nextHandle++,
<a name="l02673"></a>02673         slice = <span class="keyword">new</span> FoldersViewSlice(<span class="keyword">this</span>, handle);
<a name="l02674"></a>02674 
<a name="l02675"></a>02675     this._slices[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02676"></a>02676 
<a name="l02677"></a>02677     this.__bridgeSend({
<a name="l02678"></a>02678       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;viewFolders&#39;</span>,
<a name="l02679"></a>02679       <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>: <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>,
<a name="l02680"></a>02680       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02681"></a>02681       argument: argument ? argument.id : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02682"></a>02682     });
<a name="l02683"></a>02683 
<a name="l02684"></a>02684     <span class="keywordflow">return</span> <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02685"></a>02685   },
<a name="l02686"></a>02686 
<a name="l02691"></a>02691   viewFolderMessages: <span class="keyword">function</span> ma_viewFolderMessages(folder) {
<a name="l02692"></a>02692     var handle = this._nextHandle++,
<a name="l02693"></a>02693         slice = <span class="keyword">new</span> HeadersViewSlice(<span class="keyword">this</span>, handle);
<a name="l02694"></a>02694     slice.folderId = folder.id;
<a name="l02695"></a>02695     <span class="comment">// the initial population counts as a request.</span>
<a name="l02696"></a>02696     slice.pendingRequestCount++;
<a name="l02697"></a>02697     this._slices[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02698"></a>02698 
<a name="l02699"></a>02699     this.__bridgeSend({
<a name="l02700"></a>02700       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;viewFolderMessages&#39;</span>,
<a name="l02701"></a>02701       folderId: folder.id,
<a name="l02702"></a>02702       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02703"></a>02703     });
<a name="l02704"></a>02704 
<a name="l02705"></a>02705     <span class="keywordflow">return</span> <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02706"></a>02706   },
<a name="l02707"></a>02707 
<a name="l02729"></a>02729   searchFolderMessages:
<a name="l02730"></a>02730       <span class="keyword">function</span> ma_searchFolderMessages(folder, text, whatToSearch) {
<a name="l02731"></a>02731     var handle = this._nextHandle++,
<a name="l02732"></a>02732         slice = <span class="keyword">new</span> HeadersViewSlice(<span class="keyword">this</span>, handle, <span class="stringliteral">&#39;matchedHeaders&#39;</span>);
<a name="l02733"></a>02733     <span class="comment">// the initial population counts as a request.</span>
<a name="l02734"></a>02734     slice.pendingRequestCount++;
<a name="l02735"></a>02735     this._slices[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02736"></a>02736 
<a name="l02737"></a>02737     this.__bridgeSend({
<a name="l02738"></a>02738       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;searchFolderMessages&#39;</span>,
<a name="l02739"></a>02739       folderId: folder.id,
<a name="l02740"></a>02740       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02741"></a>02741       phrase: <a class="code" href="../../db/de5/namespacedefault__timezones.html#ae7928ec4a8ba39a389a278ef371587b8">text</a>,
<a name="l02742"></a>02742       whatToSearch: whatToSearch,
<a name="l02743"></a>02743     });
<a name="l02744"></a>02744 
<a name="l02745"></a>02745     <span class="keywordflow">return</span> <a class="code" href="../../d4/d23/binary__string__view_8js.html#a611282d0b962f2d73c40c656cbe37aa5">slice</a>;
<a name="l02746"></a>02746   },
<a name="l02747"></a>02747 
<a name="l02749"></a>02749   <span class="comment">// Batch Message Mutation</span>
<a name="l02750"></a>02750   <span class="comment">//</span>
<a name="l02751"></a>02751   <span class="comment">// If you want to modify a single message, you can use the methods on it</span>
<a name="l02752"></a>02752   <span class="comment">// directly.</span>
<a name="l02753"></a>02753   <span class="comment">//</span>
<a name="l02754"></a>02754   <span class="comment">// All actions are undoable and return an `UndoableOperation`.</span>
<a name="l02755"></a>02755 
<a name="l02756"></a>02756   deleteMessages: <span class="keyword">function</span> ma_deleteMessages(messages) {
<a name="l02757"></a>02757     <span class="comment">// We allocate a handle that provides a temporary name for our undoable</span>
<a name="l02758"></a>02758     <span class="comment">// operation until we hear back from the other side about it.</span>
<a name="l02759"></a>02759     var handle = this._nextHandle++;
<a name="l02760"></a>02760 
<a name="l02761"></a>02761     var undoableOp = <span class="keyword">new</span> UndoableOperation(<span class="keyword">this</span>, <span class="stringliteral">&#39;delete&#39;</span>, messages.length,
<a name="l02762"></a>02762                                            handle),
<a name="l02763"></a>02763         msgSuids = messages.map(serializeMessageName);
<a name="l02764"></a>02764 
<a name="l02765"></a>02765     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l02766"></a>02766       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;mutation&#39;</span>,
<a name="l02767"></a>02767       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02768"></a>02768       undoableOp: undoableOp
<a name="l02769"></a>02769     };
<a name="l02770"></a>02770     this.__bridgeSend({
<a name="l02771"></a>02771       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;deleteMessages&#39;</span>,
<a name="l02772"></a>02772       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02773"></a>02773       messages: msgSuids,
<a name="l02774"></a>02774     });
<a name="l02775"></a>02775 
<a name="l02776"></a>02776     <span class="keywordflow">return</span> undoableOp;
<a name="l02777"></a>02777   },
<a name="l02778"></a>02778 
<a name="l02779"></a>02779   <span class="comment">// Copying messages is not required yet.</span>
<a name="l02780"></a>02780   <span class="comment">/*</span>
<a name="l02781"></a>02781 <span class="comment">  copyMessages: function ma_copyMessages(messages, targetFolder) {</span>
<a name="l02782"></a>02782 <span class="comment">  },</span>
<a name="l02783"></a>02783 <span class="comment">  */</span>
<a name="l02784"></a>02784 
<a name="l02785"></a>02785   moveMessages: <span class="keyword">function</span> ma_moveMessages(messages, targetFolder) {
<a name="l02786"></a>02786     <span class="comment">// We allocate a handle that provides a temporary name for our undoable</span>
<a name="l02787"></a>02787     <span class="comment">// operation until we hear back from the other side about it.</span>
<a name="l02788"></a>02788     var handle = this._nextHandle++;
<a name="l02789"></a>02789 
<a name="l02790"></a>02790     var undoableOp = <span class="keyword">new</span> UndoableOperation(<span class="keyword">this</span>, <span class="stringliteral">&#39;move&#39;</span>, messages.length,
<a name="l02791"></a>02791                                            handle),
<a name="l02792"></a>02792         msgSuids = messages.map(serializeMessageName);
<a name="l02793"></a>02793 
<a name="l02794"></a>02794     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l02795"></a>02795       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;mutation&#39;</span>,
<a name="l02796"></a>02796       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02797"></a>02797       undoableOp: undoableOp
<a name="l02798"></a>02798     };
<a name="l02799"></a>02799     this.__bridgeSend({
<a name="l02800"></a>02800       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;moveMessages&#39;</span>,
<a name="l02801"></a>02801       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02802"></a>02802       messages: msgSuids,
<a name="l02803"></a>02803       targetFolder: targetFolder.id
<a name="l02804"></a>02804     });
<a name="l02805"></a>02805 
<a name="l02806"></a>02806     <span class="keywordflow">return</span> undoableOp;
<a name="l02807"></a>02807   },
<a name="l02808"></a>02808 
<a name="l02809"></a>02809   markMessagesRead: <span class="keyword">function</span> ma_markMessagesRead(messages, beRead) {
<a name="l02810"></a>02810     <span class="keywordflow">return</span> this.modifyMessageTags(messages,
<a name="l02811"></a>02811                                   beRead ? [<span class="stringliteral">&#39;\\Seen&#39;</span>] : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02812"></a>02812                                   beRead ? null : [<span class="stringliteral">&#39;\\Seen&#39;</span>],
<a name="l02813"></a>02813                                   beRead ? <span class="stringliteral">&#39;read&#39;</span> : <span class="stringliteral">&#39;unread&#39;</span>);
<a name="l02814"></a>02814   },
<a name="l02815"></a>02815 
<a name="l02816"></a>02816   markMessagesStarred: <span class="keyword">function</span> ma_markMessagesStarred(messages, beStarred) {
<a name="l02817"></a>02817     <span class="keywordflow">return</span> this.modifyMessageTags(messages,
<a name="l02818"></a>02818                                   beStarred ? [<span class="stringliteral">&#39;\\Flagged&#39;</span>] : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02819"></a>02819                                   beStarred ? null : [<span class="stringliteral">&#39;\\Flagged&#39;</span>],
<a name="l02820"></a>02820                                   beStarred ? <span class="stringliteral">&#39;star&#39;</span> : <span class="stringliteral">&#39;unstar&#39;</span>);
<a name="l02821"></a>02821   },
<a name="l02822"></a>02822 
<a name="l02823"></a>02823   modifyMessageTags: <span class="keyword">function</span> ma_modifyMessageTags(messages, addTags,
<a name="l02824"></a>02824                                                    removeTags, _opcode) {
<a name="l02825"></a>02825     <span class="comment">// We allocate a handle that provides a temporary name for our undoable</span>
<a name="l02826"></a>02826     <span class="comment">// operation until we hear back from the other side about it.</span>
<a name="l02827"></a>02827     var handle = this._nextHandle++;
<a name="l02828"></a>02828 
<a name="l02829"></a>02829     <span class="keywordflow">if</span> (!_opcode) {
<a name="l02830"></a>02830       <span class="keywordflow">if</span> (addTags &amp;&amp; addTags.length)
<a name="l02831"></a>02831         _opcode = <span class="stringliteral">&#39;addtag&#39;</span>;
<a name="l02832"></a>02832       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (removeTags &amp;&amp; removeTags.length)
<a name="l02833"></a>02833         _opcode = <span class="stringliteral">&#39;removetag&#39;</span>;
<a name="l02834"></a>02834     }
<a name="l02835"></a>02835     var undoableOp = <span class="keyword">new</span> UndoableOperation(<span class="keyword">this</span>, _opcode, messages.length,
<a name="l02836"></a>02836                                            handle),
<a name="l02837"></a>02837         msgSuids = messages.map(serializeMessageName);
<a name="l02838"></a>02838 
<a name="l02839"></a>02839     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l02840"></a>02840       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;mutation&#39;</span>,
<a name="l02841"></a>02841       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02842"></a>02842       undoableOp: undoableOp
<a name="l02843"></a>02843     };
<a name="l02844"></a>02844     this.__bridgeSend({
<a name="l02845"></a>02845       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;modifyMessageTags&#39;</span>,
<a name="l02846"></a>02846       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02847"></a>02847       opcode: _opcode,
<a name="l02848"></a>02848       addTags: addTags,
<a name="l02849"></a>02849       removeTags: removeTags,
<a name="l02850"></a>02850       messages: msgSuids,
<a name="l02851"></a>02851     });
<a name="l02852"></a>02852 
<a name="l02853"></a>02853     <span class="keywordflow">return</span> undoableOp;
<a name="l02854"></a>02854   },
<a name="l02855"></a>02855 
<a name="l02856"></a>02856   createFolder: <span class="keyword">function</span>(account, parentFolder, containOnlyOtherFolders) {
<a name="l02857"></a>02857     this.__bridgeSend({
<a name="l02858"></a>02858       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;createFolder&#39;</span>,
<a name="l02859"></a>02859       accountId: account.id,
<a name="l02860"></a>02860       parentFolderId: parentFolder ? parentFolder.id : <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02861"></a>02861       containOnlyOtherFolders: containOnlyOtherFolders
<a name="l02862"></a>02862     });
<a name="l02863"></a>02863   },
<a name="l02864"></a>02864 
<a name="l02865"></a>02865   _recv_mutationConfirmed: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l02866"></a>02866     var req = this._pendingRequests[msg.handle];
<a name="l02867"></a>02867     <span class="keywordflow">if</span> (!req) {
<a name="l02868"></a>02868       unexpectedBridgeDataError(<span class="stringliteral">&#39;Bad handle for mutation:&#39;</span>, msg.handle);
<a name="l02869"></a>02869       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02870"></a>02870     }
<a name="l02871"></a>02871 
<a name="l02872"></a>02872     req.undoableOp._tempHandle = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l02873"></a>02873     req.undoableOp._longtermIds = msg.longtermIds;
<a name="l02874"></a>02874     <span class="keywordflow">if</span> (req.undoableOp._undoRequested)
<a name="l02875"></a>02875       req.undoableOp.undo();
<a name="l02876"></a>02876     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02877"></a>02877   },
<a name="l02878"></a>02878 
<a name="l02879"></a>02879   __undo: <span class="keyword">function</span> undo(undoableOp) {
<a name="l02880"></a>02880     this.__bridgeSend({
<a name="l02881"></a>02881       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;undo&#39;</span>,
<a name="l02882"></a>02882       longtermIds: undoableOp._longtermIds,
<a name="l02883"></a>02883     });
<a name="l02884"></a>02884   },
<a name="l02885"></a>02885 
<a name="l02887"></a>02887   <span class="comment">// Contact Support</span>
<a name="l02888"></a>02888 
<a name="l02889"></a>02889   resolveEmailAddressToPeep: <span class="keyword">function</span>(emailAddress, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02890"></a>02890     var peep = ContactCache.resolvePeep({ name: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../df/d9e/prnetdb_8h.html#a906995422a64396276c50a754ed3d21e">address</a>: emailAddress });
<a name="l02891"></a>02891     <span class="keywordflow">if</span> (ContactCache.pendingLookupCount)
<a name="l02892"></a>02892       ContactCache.callbacks.push(callback.bind(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, peep));
<a name="l02893"></a>02893     <span class="keywordflow">else</span>
<a name="l02894"></a>02894       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(peep);
<a name="l02895"></a>02895   },
<a name="l02896"></a>02896 
<a name="l02898"></a>02898   <span class="comment">// Message Composition</span>
<a name="l02899"></a>02899 
<a name="l02932"></a>02932   beginMessageComposition: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>, folder, <a class="code" href="../../d6/d46/system_2js_2icc_8js.html#a77e4041f4236c111378c64001ea99114">options</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l02933"></a>02933     <span class="keywordflow">if</span> (!callback)
<a name="l02934"></a>02934       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;A callback must be provided; you are using the API &#39;</span> +
<a name="l02935"></a>02935                       <span class="stringliteral">&#39;wrong if you do not.&#39;</span>);
<a name="l02936"></a>02936     <span class="keywordflow">if</span> (!options)
<a name="l02937"></a>02937       options = {};
<a name="l02938"></a>02938 
<a name="l02939"></a>02939     var handle = this._nextHandle++,
<a name="l02940"></a>02940         composer = <span class="keyword">new</span> MessageComposition(<span class="keyword">this</span>, handle);
<a name="l02941"></a>02941 
<a name="l02942"></a>02942     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l02943"></a>02943       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;compose&#39;</span>,
<a name="l02944"></a>02944       composer: composer,
<a name="l02945"></a>02945       callback: <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>,
<a name="l02946"></a>02946     };
<a name="l02947"></a>02947     var msg = {
<a name="l02948"></a>02948       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;beginCompose&#39;</span>,
<a name="l02949"></a>02949       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l02950"></a>02950       <a class="code" href="../../d2/d7d/jsapi_8h.html#a5e94be9423b9de6b3ab4057aca59293f">mode</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02951"></a>02951       submode: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02952"></a>02952       refSuid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02953"></a>02953       refDate: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02954"></a>02954       refGuid: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02955"></a>02955       refAuthor: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02956"></a>02956       refSubject: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l02957"></a>02957     };
<a name="l02958"></a>02958     <span class="keywordflow">if</span> (options.hasOwnProperty(<span class="stringliteral">&#39;replyTo&#39;</span>) &amp;&amp; options.replyTo) {
<a name="l02959"></a>02959       msg.mode = <span class="stringliteral">&#39;reply&#39;</span>;
<a name="l02960"></a>02960       msg.submode = options.replyMode;
<a name="l02961"></a>02961       msg.refSuid = options.replyTo.id;
<a name="l02962"></a>02962       msg.refDate = options.replyTo.date.valueOf();
<a name="l02963"></a>02963       msg.refGuid = options.replyTo.guid;
<a name="l02964"></a>02964       msg.refAuthor = options.replyTo.author.toWireRep();
<a name="l02965"></a>02965       msg.refSubject = options.replyTo.subject;
<a name="l02966"></a>02966     }
<a name="l02967"></a>02967     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (options.hasOwnProperty(<span class="stringliteral">&#39;forwardOf&#39;</span>) &amp;&amp; options.forwardOf) {
<a name="l02968"></a>02968       msg.mode = <span class="stringliteral">&#39;forward&#39;</span>;
<a name="l02969"></a>02969       msg.submode = options.forwardMode;
<a name="l02970"></a>02970       msg.refSuid = options.forwardOf.id;
<a name="l02971"></a>02971       msg.refDate = options.forwardOf.date.valueOf();
<a name="l02972"></a>02972       msg.refGuid = options.forwardOf.guid;
<a name="l02973"></a>02973       msg.refAuthor = options.forwardOf.author.toWireRep();
<a name="l02974"></a>02974       msg.refSubject = options.forwardOf.subject;
<a name="l02975"></a>02975     }
<a name="l02976"></a>02976     <span class="keywordflow">else</span> {
<a name="l02977"></a>02977       msg.mode = <span class="stringliteral">&#39;new&#39;</span>;
<a name="l02978"></a>02978       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>) {
<a name="l02979"></a>02979         msg.submode = <span class="stringliteral">&#39;message&#39;</span>;
<a name="l02980"></a>02980         msg.refSuid = <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>.id;
<a name="l02981"></a>02981       }
<a name="l02982"></a>02982       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (folder) {
<a name="l02983"></a>02983         msg.submode = <span class="stringliteral">&#39;folder&#39;</span>;
<a name="l02984"></a>02984         msg.refSuid = folder.id;
<a name="l02985"></a>02985       }
<a name="l02986"></a>02986     }
<a name="l02987"></a>02987     this.__bridgeSend(msg);
<a name="l02988"></a>02988     <span class="keywordflow">return</span> composer;
<a name="l02989"></a>02989   },
<a name="l02990"></a>02990 
<a name="l03001"></a>03001   resumeMessageComposition: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03002"></a>03002     <span class="keywordflow">if</span> (!callback)
<a name="l03003"></a>03003       <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&#39;A callback must be provided; you are using the API &#39;</span> +
<a name="l03004"></a>03004                       <span class="stringliteral">&#39;wrong if you do not.&#39;</span>);
<a name="l03005"></a>03005 
<a name="l03006"></a>03006     var handle = this._nextHandle++,
<a name="l03007"></a>03007         composer = <span class="keyword">new</span> MessageComposition(<span class="keyword">this</span>, handle);
<a name="l03008"></a>03008 
<a name="l03009"></a>03009     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l03010"></a>03010       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;compose&#39;</span>,
<a name="l03011"></a>03011       composer: composer,
<a name="l03012"></a>03012       callback: <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>,
<a name="l03013"></a>03013     };
<a name="l03014"></a>03014 
<a name="l03015"></a>03015     this.__bridgeSend({
<a name="l03016"></a>03016       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;resumeCompose&#39;</span>,
<a name="l03017"></a>03017       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l03018"></a>03018       messageNamer: serializeMessageName(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>)
<a name="l03019"></a>03019     });
<a name="l03020"></a>03020 
<a name="l03021"></a>03021     <span class="keywordflow">return</span> composer;
<a name="l03022"></a>03022   },
<a name="l03023"></a>03023 
<a name="l03024"></a>03024   _recv_composeBegun: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l03025"></a>03025     var req = this._pendingRequests[msg.handle];
<a name="l03026"></a>03026     <span class="keywordflow">if</span> (!req) {
<a name="l03027"></a>03027       unexpectedBridgeDataError(<span class="stringliteral">&#39;Bad handle for compose begun:&#39;</span>, msg.handle);
<a name="l03028"></a>03028       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03029"></a>03029     }
<a name="l03030"></a>03030 
<a name="l03031"></a>03031     req.composer.senderIdentity = <span class="keyword">new</span> MailSenderIdentity(<span class="keyword">this</span>, msg.identity);
<a name="l03032"></a>03032     req.composer.subject = msg.subject;
<a name="l03033"></a>03033     req.composer.body = msg.body; <span class="comment">// rich obj of {text, html}</span>
<a name="l03034"></a>03034     req.composer.to = msg.to;
<a name="l03035"></a>03035     req.composer.cc = msg.cc;
<a name="l03036"></a>03036     req.composer.bcc = msg.bcc;
<a name="l03037"></a>03037     req.composer._references = msg.referencesStr;
<a name="l03038"></a>03038     req.composer.attachments = msg.attachments;
<a name="l03039"></a>03039 
<a name="l03040"></a>03040     <span class="keywordflow">if</span> (req.callback) {
<a name="l03041"></a>03041       var callback = req.callback;
<a name="l03042"></a>03042       req.callback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03043"></a>03043       callback.call(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, req.composer);
<a name="l03044"></a>03044     }
<a name="l03045"></a>03045     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03046"></a>03046   },
<a name="l03047"></a>03047 
<a name="l03048"></a>03048   _composeDone: <span class="keyword">function</span>(<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>, command, <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03049"></a>03049     <span class="keywordflow">if</span> (!handle)
<a name="l03050"></a>03050       <span class="keywordflow">return</span>;
<a name="l03051"></a>03051     var req = this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>];
<a name="l03052"></a>03052     <span class="keywordflow">if</span> (!req) {
<a name="l03053"></a>03053       <span class="keywordflow">return</span>;
<a name="l03054"></a>03054     }
<a name="l03055"></a>03055     req.type = command;
<a name="l03056"></a>03056     <span class="keywordflow">if</span> (callback)
<a name="l03057"></a>03057       req.callback = <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>;
<a name="l03058"></a>03058     this.__bridgeSend({
<a name="l03059"></a>03059       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;doneCompose&#39;</span>,
<a name="l03060"></a>03060       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l03061"></a>03061       command: command,
<a name="l03062"></a>03062       state: <a class="code" href="../../d2/d7d/jsapi_8h.html#afa45f986123242ddd418c959eb87e242">state</a>,
<a name="l03063"></a>03063     });
<a name="l03064"></a>03064   },
<a name="l03065"></a>03065 
<a name="l03066"></a>03066   _recv_doneCompose: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l03067"></a>03067     var req = this._pendingRequests[msg.handle];
<a name="l03068"></a>03068     <span class="keywordflow">if</span> (!req) {
<a name="l03069"></a>03069       unexpectedBridgeDataError(<span class="stringliteral">&#39;Bad handle for doneCompose:&#39;</span>, msg.handle);
<a name="l03070"></a>03070       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03071"></a>03071     }
<a name="l03072"></a>03072     req.active = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03073"></a>03073     <span class="comment">// Do not cleanup on saves. Do cleanup on successful send, delete, die.</span>
<a name="l03074"></a>03074     <span class="keywordflow">if</span> (req.type === <span class="stringliteral">&#39;die&#39;</span> || (!msg.err &amp;&amp; (req.type !== <span class="stringliteral">&#39;save&#39;</span>)))
<a name="l03075"></a>03075       <span class="keyword">delete</span> this._pendingRequests[msg.handle];
<a name="l03076"></a>03076     <span class="keywordflow">if</span> (req.callback) {
<a name="l03077"></a>03077       req.callback.call(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, msg.err, msg.badAddresses,
<a name="l03078"></a>03078                         { sentDate: msg.sentDate, messageId: msg.messageId });
<a name="l03079"></a>03079       req.callback = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03080"></a>03080     }
<a name="l03081"></a>03081     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03082"></a>03082   },
<a name="l03083"></a>03083 
<a name="l03085"></a>03085   <span class="comment">// mode setting for back end universe. Set interactive</span>
<a name="l03086"></a>03086   <span class="comment">// if the user has been exposed to the UI and it is a</span>
<a name="l03087"></a>03087   <span class="comment">// longer lived application, not just a cron sync.</span>
<a name="l03088"></a>03088   setInteractive: <span class="keyword">function</span>() {
<a name="l03089"></a>03089     this.__bridgeSend({
<a name="l03090"></a>03090       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;setInteractive&#39;</span>
<a name="l03091"></a>03091     });
<a name="l03092"></a>03092   },
<a name="l03093"></a>03093 
<a name="l03095"></a>03095   <span class="comment">// cron syncing</span>
<a name="l03096"></a>03096 
<a name="l03100"></a>03100   _recv_cronSyncStart: <span class="keyword">function</span> ma__recv_cronSyncStart(msg) {
<a name="l03101"></a>03101     <span class="keywordflow">if</span> (this.oncronsyncstart)
<a name="l03102"></a>03102       this.oncronsyncstart(msg.accountIds);
<a name="l03103"></a>03103     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03104"></a>03104   },
<a name="l03105"></a>03105 
<a name="l03106"></a>03106   _recv_cronSyncStop: <span class="keyword">function</span> ma__recv_cronSyncStop(msg) {
<a name="l03107"></a>03107     <span class="keywordflow">if</span> (this.oncronsyncstop)
<a name="l03108"></a>03108       this.oncronsyncstop(msg.accountsResults);
<a name="l03109"></a>03109     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03110"></a>03110   },
<a name="l03111"></a>03111 
<a name="l03112"></a>03112 
<a name="l03114"></a>03114   <span class="comment">// Localization</span>
<a name="l03115"></a>03115 
<a name="l03133"></a>03133   useLocalizedStrings: <span class="keyword">function</span>(<a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>) {
<a name="l03134"></a>03134     this.__bridgeSend({
<a name="l03135"></a>03135       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;localizedStrings&#39;</span>,
<a name="l03136"></a>03136       <a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>: <a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>
<a name="l03137"></a>03137     });
<a name="l03138"></a>03138     <span class="keywordflow">if</span> (<a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>.folderNames)
<a name="l03139"></a>03139       this.l10n_folder_names = <a class="code" href="../../d5/dfb/namespacemozilla_1_1dom_1_1_channel_count_mode_values.html#a2591196973060300413900992420acfb">strings</a>.folderNames;
<a name="l03140"></a>03140   },
<a name="l03141"></a>03141 
<a name="l03148"></a>03148   l10n_folder_names: {},
<a name="l03149"></a>03149 
<a name="l03150"></a>03150   l10n_folder_name: <span class="keyword">function</span>(<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>) {
<a name="l03151"></a>03151     <span class="keywordflow">if</span> (this.l10n_folder_names.hasOwnProperty(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>)) {
<a name="l03152"></a>03152       var lowerName = name.toLowerCase();
<a name="l03153"></a>03153       <span class="comment">// Many of the names are the same as the type, but not all.</span>
<a name="l03154"></a>03154       <span class="keywordflow">if</span> ((<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === lowerName) ||
<a name="l03155"></a>03155           (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;drafts&#39;</span> &amp;&amp; lowerName === <span class="stringliteral">&#39;draft&#39;</span>) ||
<a name="l03156"></a>03156           <span class="comment">// yahoo.fr uses &#39;bulk mail&#39; as its unlocalized name</span>
<a name="l03157"></a>03157           (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;junk&#39;</span> &amp;&amp; lowerName === <span class="stringliteral">&#39;bulk mail&#39;</span>) ||
<a name="l03158"></a>03158           (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;junk&#39;</span> &amp;&amp; lowerName === <span class="stringliteral">&#39;spam&#39;</span>) ||
<a name="l03159"></a>03159           <span class="comment">// this is for consistency with Thunderbird</span>
<a name="l03160"></a>03160           (<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> === <span class="stringliteral">&#39;queue&#39;</span> &amp;&amp; lowerName === <span class="stringliteral">&#39;unsent messages&#39;</span>))
<a name="l03161"></a>03161         <span class="keywordflow">return</span> this.l10n_folder_names[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>];
<a name="l03162"></a>03162     }
<a name="l03163"></a>03163     <span class="keywordflow">return</span> <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>;
<a name="l03164"></a>03164   },
<a name="l03165"></a>03165 
<a name="l03166"></a>03166 
<a name="l03168"></a>03168   <span class="comment">// Configuration</span>
<a name="l03169"></a>03169 
<a name="l03174"></a>03174   modifyConfig: <span class="keyword">function</span>(mods) {
<a name="l03175"></a>03175     <span class="keywordflow">for</span> (var <a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> in mods) {
<a name="l03176"></a>03176       <span class="keywordflow">if</span> (LEGAL_CONFIG_KEYS.indexOf(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a>) === -1)
<a name="l03177"></a>03177         <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<a class="code" href="../../d2/d7d/jsapi_8h.html#a02d8cbd1392e102198d5bb521715f608">key</a> + <span class="stringliteral">&#39; is not a legal config key!&#39;</span>);
<a name="l03178"></a>03178     }
<a name="l03179"></a>03179     this.__bridgeSend({
<a name="l03180"></a>03180       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;modifyConfig&#39;</span>,
<a name="l03181"></a>03181       mods: mods
<a name="l03182"></a>03182     });
<a name="l03183"></a>03183   },
<a name="l03184"></a>03184 
<a name="l03185"></a>03185   _recv_config: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l03186"></a>03186     this.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a> = msg.config;
<a name="l03187"></a>03187     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03188"></a>03188   },
<a name="l03189"></a>03189 
<a name="l03191"></a>03191   <span class="comment">// Diagnostics / Test Hacks</span>
<a name="l03192"></a>03192 
<a name="l03199"></a>03199   ping: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l03200"></a>03200     var handle = this._nextHandle++;
<a name="l03201"></a>03201     this._pendingRequests[<a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>] = {
<a name="l03202"></a>03202       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;ping&#39;</span>,
<a name="l03203"></a>03203       callback: <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>,
<a name="l03204"></a>03204     };
<a name="l03205"></a>03205     this.__bridgeSend({
<a name="l03206"></a>03206       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;ping&#39;</span>,
<a name="l03207"></a>03207       handle: <a class="code" href="../../d3/d4b/lockscreen_8js.html#af91fa9dd7bcc99f1ac5d9727c6cdc8cc">handle</a>,
<a name="l03208"></a>03208     });
<a name="l03209"></a>03209   },
<a name="l03210"></a>03210 
<a name="l03211"></a>03211   _recv_pong: <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l03212"></a>03212     var req = this._pendingRequests[msg.handle];
<a name="l03213"></a>03213     <span class="keyword">delete</span> this._pendingRequests[msg.handle];
<a name="l03214"></a>03214     req.callback();
<a name="l03215"></a>03215     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03216"></a>03216   },
<a name="l03217"></a>03217 
<a name="l03218"></a>03218   debugSupport: <span class="keyword">function</span>(command, argument) {
<a name="l03219"></a>03219     <span class="keywordflow">if</span> (command === <span class="stringliteral">&#39;setLogging&#39;</span>)
<a name="l03220"></a>03220       this.<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>.debugLogging = argument;
<a name="l03221"></a>03221     this.__bridgeSend({
<a name="l03222"></a>03222       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;debugSupport&#39;</span>,
<a name="l03223"></a>03223       cmd: command,
<a name="l03224"></a>03224       <a class="code" href="../../d2/dbe/jsprf_8h.html#ae036856e415526e58e249638733f6752">arg</a>: argument
<a name="l03225"></a>03225     });
<a name="l03226"></a>03226   }
<a name="l03227"></a>03227 
<a name="l03229"></a>03229 };
<a name="l03230"></a>03230 
<a name="l03231"></a>03231 }); <span class="comment">// end define</span>
<a name="l03232"></a>03232 ;
<a name="l03233"></a>03233 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/worker-support/main-router&#39;</span>,[],<span class="keyword">function</span>() {
<a name="l03234"></a>03234   <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l03235"></a>03235 
<a name="l03236"></a>03236   var <a class="code" href="../../de/dfc/events_8js.html#aefbed4536fb9e73c5a626949dcbffbf4">listeners</a> = {};
<a name="l03237"></a>03237   var modules = [];
<a name="l03238"></a>03238   var worker = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03239"></a>03239 
<a name="l03240"></a>03240   <span class="keyword">function</span> <span class="keyword">register</span>(<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l03241"></a>03241     var <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a4ef488940623c6d0eab866a64228de55">action</a>,
<a name="l03242"></a>03242         name = <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.name;
<a name="l03243"></a>03243 
<a name="l03244"></a>03244     modules.push(<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>);
<a name="l03245"></a>03245 
<a name="l03246"></a>03246     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.process) {
<a name="l03247"></a>03247       action = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l03248"></a>03248         <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.process(msg.uid, msg.cmd, msg.args);
<a name="l03249"></a>03249       };
<a name="l03250"></a>03250     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.dispatch) {
<a name="l03251"></a>03251       action = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l03252"></a>03252         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.dispatch[msg.cmd]) {
<a name="l03253"></a>03253           <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.dispatch[msg.cmd].apply(<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.dispatch, msg.args);
<a name="l03254"></a>03254         }
<a name="l03255"></a>03255       };
<a name="l03256"></a>03256     }
<a name="l03257"></a>03257 
<a name="l03258"></a>03258     listeners[<a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>] = <a class="code" href="../../d5/d62/build__stage_2email_2shared_2style_2_r_e_a_d_m_e_8md.html#a4ef488940623c6d0eab866a64228de55">action</a>;
<a name="l03259"></a>03259 
<a name="l03260"></a>03260     <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.sendMessage = <span class="keyword">function</span>(uid, cmd, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>, transferArgs) {
<a name="l03261"></a>03261     <span class="comment">//dump(&#39;\x1b[34mM =&gt; w: send: &#39; + name + &#39; &#39; + uid + &#39; &#39; + cmd + &#39;\x1b[0m\n&#39;);</span>
<a name="l03262"></a>03262       <span class="comment">//debug(&#39;onmessage: &#39; + name + &quot;: &quot; + uid + &quot; - &quot; + cmd);</span>
<a name="l03263"></a>03263       worker.postMessage({
<a name="l03264"></a>03264         <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <a class="code" href="../../d9/d04/expat_8h.html#a4a7cccd86625791f7f2ce3fb477aa9c1">name</a>,
<a name="l03265"></a>03265         uid: uid,
<a name="l03266"></a>03266         cmd: cmd,
<a name="l03267"></a>03267         args: args
<a name="l03268"></a>03268       }, transferArgs);
<a name="l03269"></a>03269     };
<a name="l03270"></a>03270   }
<a name="l03271"></a>03271 
<a name="l03272"></a>03272   <span class="keyword">function</span> unregister(<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l03273"></a>03273     <span class="keyword">delete</span> listeners[<span class="stringliteral">&#39;on&#39;</span> + <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.name];
<a name="l03274"></a>03274   }
<a name="l03275"></a>03275 
<a name="l03276"></a>03276   <span class="keyword">function</span> <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>() {
<a name="l03277"></a>03277     modules.forEach(<span class="keyword">function</span>(<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>) {
<a name="l03278"></a>03278       <span class="keywordflow">if</span> (<a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.shutdown)
<a name="l03279"></a>03279         <a class="code" href="../../dc/dd7/ext_2caldav_8js.html#a84770557f73663cbea2a9e12e7d45257">module</a>.shutdown();
<a name="l03280"></a>03280     });
<a name="l03281"></a>03281   }
<a name="l03282"></a>03282 
<a name="l03283"></a>03283   <span class="keyword">function</span> useWorker(_worker) {
<a name="l03284"></a>03284     worker = _worker;
<a name="l03285"></a>03285     worker.onmessage = <span class="keyword">function</span> dispatchToListener(evt) {
<a name="l03286"></a>03286       var <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = evt.data;
<a name="l03287"></a>03287 <span class="comment">//dump(&#39;\x1b[37mM &lt;= w: recv: &#39;+data.type+&#39; &#39;+data.uid+&#39; &#39;+data.cmd+&#39;\x1b[0m\n&#39;);</span>
<a name="l03288"></a>03288       var listener = listeners[data.type];
<a name="l03289"></a>03289       <span class="keywordflow">if</span> (listener)
<a name="l03290"></a>03290         listener(data);
<a name="l03291"></a>03291     };
<a name="l03292"></a>03292   }
<a name="l03293"></a>03293 
<a name="l03294"></a>03294   <span class="keywordflow">return</span> {
<a name="l03295"></a>03295     <span class="keyword">register</span>: <span class="keyword">register</span>,
<a name="l03296"></a>03296     unregister: unregister,
<a name="l03297"></a>03297     useWorker: useWorker,
<a name="l03298"></a>03298     <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>: <a class="code" href="../../d0/dda/tools_2extensions_2httpd_2bootstrap_8js.html#a3f2023cbe585058674584a2feb08aec0">shutdown</a>
<a name="l03299"></a>03299   };
<a name="l03300"></a>03300 }); <span class="comment">// end define</span>
<a name="l03301"></a>03301 ;
<a name="l03302"></a>03302 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/worker-support/configparser-main&#39;</span>,[],<span class="keyword">function</span>() {
<a name="l03303"></a>03303   <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l03304"></a>03304 
<a name="l03305"></a>03305   <span class="keyword">function</span> <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l03306"></a>03306     <span class="comment">//dump(&#39;ConfigParser: &#39; + str + &#39;\n&#39;);</span>
<a name="l03307"></a>03307   }
<a name="l03308"></a>03308 
<a name="l03309"></a>03309   <span class="keyword">function</span> nsResolver(<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>) {
<a name="l03310"></a>03310     var baseUrl = <span class="stringliteral">&#39;http://schemas.microsoft.com/exchange/autodiscover/&#39;</span>;
<a name="l03311"></a>03311     var <a class="code" href="../../d4/d21/calendar_2js_2controllers_2alarm_8js.html#a0416fc4d5e8ec4fd436369a406438e44">ns</a> = {
<a name="l03312"></a>03312       rq: baseUrl + <span class="stringliteral">&#39;mobilesync/requestschema/2006&#39;</span>,
<a name="l03313"></a>03313       ad: baseUrl + <span class="stringliteral">&#39;responseschema/2006&#39;</span>,
<a name="l03314"></a>03314       ms: baseUrl + <span class="stringliteral">&#39;mobilesync/responseschema/2006&#39;</span>,
<a name="l03315"></a>03315     };
<a name="l03316"></a>03316     <span class="keywordflow">return</span> ns[<a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a>] || <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03317"></a>03317   }
<a name="l03318"></a>03318 
<a name="l03319"></a>03319   <span class="keyword">function</span> parseAccountCommon(uid, cmd, text) {
<a name="l03320"></a>03320     var doc = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a3046dffa90b2766d053c821c5e99ed4e">DOMParser</a>().parseFromString(text, <span class="stringliteral">&#39;text/xml&#39;</span>);
<a name="l03321"></a>03321     var getNode = <span class="keyword">function</span>(xpath, rel) {
<a name="l03322"></a>03322       <span class="keywordflow">return</span> doc.evaluate(xpath, rel || doc, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03323"></a>03323                           XPathResult.FIRST_ORDERED_NODE_TYPE, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l03324"></a>03324                             .singleNodeValue;
<a name="l03325"></a>03325     };
<a name="l03326"></a>03326 
<a name="l03327"></a>03327     var provider = getNode(<span class="stringliteral">&#39;/clientConfig/emailProvider&#39;</span>);
<a name="l03328"></a>03328     <span class="comment">// Get the first incomingServer we can use (we assume first == best).</span>
<a name="l03329"></a>03329     var incoming = getNode(<span class="stringliteral">&#39;incomingServer[@type=&quot;imap&quot;] | &#39;</span> +
<a name="l03330"></a>03330                            <span class="stringliteral">&#39;incomingServer[@type=&quot;activesync&quot;]&#39;</span>, provider);
<a name="l03331"></a>03331     var outgoing = getNode(<span class="stringliteral">&#39;outgoingServer[@type=&quot;smtp&quot;]&#39;</span>, provider);
<a name="l03332"></a>03332 
<a name="l03333"></a>03333     var <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03334"></a>03334     var <a class="code" href="../../da/da1/communications_2contacts_2js_2utilities_2status_8js.html#a0818854fd36b9ae0fdfe5872464dae94">status</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03335"></a>03335     <span class="keywordflow">if</span> (incoming) {
<a name="l03336"></a>03336       config = { <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, incoming: {}, outgoing: {} };
<a name="l03337"></a>03337       <span class="keywordflow">for</span> (var iter in Iterator(incoming.children)) {
<a name="l03338"></a>03338         var child = iter[1];
<a name="l03339"></a>03339         config.incoming[child.tagName] = child.textContent;
<a name="l03340"></a>03340       }
<a name="l03341"></a>03341 
<a name="l03342"></a>03342       <span class="keywordflow">if</span> (incoming.getAttribute(<span class="stringliteral">&#39;type&#39;</span>) === <span class="stringliteral">&#39;activesync&#39;</span>) {
<a name="l03343"></a>03343         config.type = <span class="stringliteral">&#39;activesync&#39;</span>;
<a name="l03344"></a>03344       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (outgoing) {
<a name="l03345"></a>03345         config.type = <span class="stringliteral">&#39;imap+smtp&#39;</span>;
<a name="l03346"></a>03346         <span class="keywordflow">for</span> (var iter in Iterator(outgoing.children)) {
<a name="l03347"></a>03347           var child = iter[1];
<a name="l03348"></a>03348           config.outgoing[child.tagName] = child.textContent;
<a name="l03349"></a>03349         }
<a name="l03350"></a>03350 
<a name="l03351"></a>03351         var ALLOWED_SOCKET_TYPES = [<span class="stringliteral">&#39;SSL&#39;</span>, <span class="stringliteral">&#39;STARTTLS&#39;</span>];
<a name="l03352"></a>03352 
<a name="l03353"></a>03353         <span class="comment">// We do not support unencrypted connections outside of unit tests.</span>
<a name="l03354"></a>03354         <span class="keywordflow">if</span> (ALLOWED_SOCKET_TYPES.indexOf(config.incoming.socketType) === -1 ||
<a name="l03355"></a>03355             ALLOWED_SOCKET_TYPES.indexOf(config.outgoing.socketType) === -1) {
<a name="l03356"></a>03356           config = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03357"></a>03357           status = <span class="stringliteral">&#39;unsafe&#39;</span>;
<a name="l03358"></a>03358         }
<a name="l03359"></a>03359       } <span class="keywordflow">else</span> {
<a name="l03360"></a>03360         config = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03361"></a>03361         status = <span class="stringliteral">&#39;no-outgoing&#39;</span>;
<a name="l03362"></a>03362       }
<a name="l03363"></a>03363     } <span class="keywordflow">else</span> {
<a name="l03364"></a>03364       status = <span class="stringliteral">&#39;no-incoming&#39;</span>;
<a name="l03365"></a>03365     }
<a name="l03366"></a>03366 
<a name="l03367"></a>03367     <span class="keyword">self</span>.sendMessage(uid, cmd, [config, status]);
<a name="l03368"></a>03368   }
<a name="l03369"></a>03369 
<a name="l03370"></a>03370   <span class="keyword">function</span> parseActiveSyncAccount(uid, cmd, text) {
<a name="l03371"></a>03371     var doc = <span class="keyword">new</span> <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a3046dffa90b2766d053c821c5e99ed4e">DOMParser</a>().parseFromString(text, <span class="stringliteral">&#39;text/xml&#39;</span>);
<a name="l03372"></a>03372 
<a name="l03373"></a>03373     var getNode = <span class="keyword">function</span>(xpath, rel) {
<a name="l03374"></a>03374       <span class="keywordflow">return</span> doc.evaluate(xpath, rel, nsResolver,
<a name="l03375"></a>03375                           XPathResult.FIRST_ORDERED_NODE_TYPE, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>)
<a name="l03376"></a>03376                   .singleNodeValue;
<a name="l03377"></a>03377     };
<a name="l03378"></a>03378     var getNodes = <span class="keyword">function</span>(xpath, rel) {
<a name="l03379"></a>03379       <span class="keywordflow">return</span> doc.evaluate(xpath, rel, nsResolver,
<a name="l03380"></a>03380                           XPathResult.ORDERED_NODE_ITERATOR_TYPE, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>);
<a name="l03381"></a>03381     };
<a name="l03382"></a>03382     var getString = <span class="keyword">function</span>(xpath, rel) {
<a name="l03383"></a>03383       <span class="keywordflow">return</span> doc.evaluate(xpath, rel, nsResolver, XPathResult.STRING_TYPE,
<a name="l03384"></a>03384                           <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>).stringValue;
<a name="l03385"></a>03385     };
<a name="l03386"></a>03386 
<a name="l03387"></a>03387     var postResponse = <span class="keyword">function</span>(<a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, <a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, redirectedEmail) {
<a name="l03388"></a>03388       <span class="keyword">self</span>.sendMessage(uid, cmd, [config, <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a>, redirectedEmail]);
<a name="l03389"></a>03389     };
<a name="l03390"></a>03390 
<a name="l03391"></a>03391     var <a class="code" href="../../d0/de6/fake-oncall-desktop_8js.html#a6efd5e1eedff09b640ec574dc6dd2879">error</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03392"></a>03392     <span class="keywordflow">if</span> (doc.documentElement.tagName === <span class="stringliteral">&#39;parsererror&#39;</span>) {
<a name="l03393"></a>03393       error = <span class="stringliteral">&#39;Error parsing autodiscover response&#39;</span>;
<a name="l03394"></a>03394       <span class="keywordflow">return</span> postResponse(error);
<a name="l03395"></a>03395     }
<a name="l03396"></a>03396 
<a name="l03397"></a>03397     var responseNode = getNode(<span class="stringliteral">&#39;/ad:Autodiscover/ms:Response&#39;</span>, doc);
<a name="l03398"></a>03398     <span class="keywordflow">if</span> (!responseNode) {
<a name="l03399"></a>03399       error = <span class="stringliteral">&#39;Missing Autodiscover Response node&#39;</span>;
<a name="l03400"></a>03400       <span class="keywordflow">return</span> postResponse(error);
<a name="l03401"></a>03401     }
<a name="l03402"></a>03402 
<a name="l03403"></a>03403     var error = getNode(<span class="stringliteral">&#39;ms:Error&#39;</span>, responseNode) ||
<a name="l03404"></a>03404                 getNode(<span class="stringliteral">&#39;ms:Action/ms:Error&#39;</span>, responseNode);
<a name="l03405"></a>03405     <span class="keywordflow">if</span> (error) {
<a name="l03406"></a>03406       error = getString(<span class="stringliteral">&#39;ms:Message/text()&#39;</span>, error);
<a name="l03407"></a>03407       <span class="keywordflow">return</span> postResponse(error);
<a name="l03408"></a>03408     }
<a name="l03409"></a>03409 
<a name="l03410"></a>03410     var redirect = getNode(<span class="stringliteral">&#39;ms:Action/ms:Redirect&#39;</span>, responseNode);
<a name="l03411"></a>03411     <span class="keywordflow">if</span> (redirect) {
<a name="l03412"></a>03412       <span class="keywordflow">if</span> (aNoRedirect) {
<a name="l03413"></a>03413         error = <span class="stringliteral">&#39;Multiple redirects occurred during autodiscovery&#39;</span>;
<a name="l03414"></a>03414         <span class="keywordflow">return</span> postResponse(error);
<a name="l03415"></a>03415       }
<a name="l03416"></a>03416 
<a name="l03417"></a>03417       var redirectedEmail = getString(<span class="stringliteral">&#39;text()&#39;</span>, redirect);
<a name="l03418"></a>03418       <span class="keywordflow">return</span> postResponse(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, redirectedEmail);
<a name="l03419"></a>03419     }
<a name="l03420"></a>03420 
<a name="l03421"></a>03421     var <a class="code" href="../../de/d8f/jsdebug_8h.html#ad8babe1ecde8f9f6d224a06ea1a99480">user</a> = getNode(<span class="stringliteral">&#39;ms:User&#39;</span>, responseNode);
<a name="l03422"></a>03422     var config = {
<a name="l03423"></a>03423       culture: getString(<span class="stringliteral">&#39;ms:Culture/text()&#39;</span>, responseNode),
<a name="l03424"></a>03424       user: {
<a name="l03425"></a>03425         name:  getString(<span class="stringliteral">&#39;ms:DisplayName/text()&#39;</span>,  user),
<a name="l03426"></a>03426         email: getString(<span class="stringliteral">&#39;ms:EMailAddress/text()&#39;</span>, user),
<a name="l03427"></a>03427       },
<a name="l03428"></a>03428       servers: [],
<a name="l03429"></a>03429     };
<a name="l03430"></a>03430 
<a name="l03431"></a>03431     var servers = getNodes(<span class="stringliteral">&#39;ms:Action/ms:Settings/ms:Server&#39;</span>, responseNode);
<a name="l03432"></a>03432     var <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a>;
<a name="l03433"></a>03433     <span class="keywordflow">while</span> ((server = servers.iterateNext())) {
<a name="l03434"></a>03434       config.servers.push({
<a name="l03435"></a>03435         <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>:       getString(<span class="stringliteral">&#39;ms:Type/text()&#39;</span>,       server),
<a name="l03436"></a>03436         url:        getString(<span class="stringliteral">&#39;ms:Url/text()&#39;</span>,        server),
<a name="l03437"></a>03437         name:       getString(<span class="stringliteral">&#39;ms:Name/text()&#39;</span>,       server),
<a name="l03438"></a>03438         serverData: getString(<span class="stringliteral">&#39;ms:ServerData/text()&#39;</span>, server),
<a name="l03439"></a>03439       });
<a name="l03440"></a>03440     }
<a name="l03441"></a>03441 
<a name="l03442"></a>03442     <span class="comment">// Try to find a MobileSync server from Autodiscovery.</span>
<a name="l03443"></a>03443     <span class="keywordflow">for</span> (var iter in Iterator(config.servers)) {
<a name="l03444"></a>03444       var server = iter[1];
<a name="l03445"></a>03445       <span class="keywordflow">if</span> (server.type === <span class="stringliteral">&#39;MobileSync&#39;</span>) {
<a name="l03446"></a>03446         config.mobileSyncServer = <a class="code" href="../../df/d25/fakeimap_8js.html#a207259f7e3cfd9800ed8f7d7224c7a68">server</a>;
<a name="l03447"></a>03447         <span class="keywordflow">break</span>;
<a name="l03448"></a>03448       }
<a name="l03449"></a>03449     }
<a name="l03450"></a>03450 
<a name="l03451"></a>03451     <span class="keywordflow">if</span> (!config.mobileSyncServer) {
<a name="l03452"></a>03452       error = <span class="stringliteral">&#39;No MobileSync server found&#39;</span>;
<a name="l03453"></a>03453       <span class="keywordflow">return</span> postResponse(error, config);
<a name="l03454"></a>03454     }
<a name="l03455"></a>03455 
<a name="l03456"></a>03456     postResponse(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, config);
<a name="l03457"></a>03457   };
<a name="l03458"></a>03458 
<a name="l03459"></a>03459   var <span class="keyword">self</span> = {
<a name="l03460"></a>03460     name: <span class="stringliteral">&#39;configparser&#39;</span>,
<a name="l03461"></a>03461     sendMessage: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03462"></a>03462     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>: <span class="keyword">function</span>(uid, cmd, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l03463"></a>03463       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;process &#39;</span> + cmd);
<a name="l03464"></a>03464       <span class="keywordflow">switch</span> (cmd) {
<a name="l03465"></a>03465         <span class="keywordflow">case</span> <span class="stringliteral">&#39;accountcommon&#39;</span>:
<a name="l03466"></a>03466           parseAccountCommon(uid, cmd, args[0]);
<a name="l03467"></a>03467           <span class="keywordflow">break</span>;
<a name="l03468"></a>03468         <span class="keywordflow">case</span> <span class="stringliteral">&#39;accountactivesync&#39;</span>:
<a name="l03469"></a>03469           parseActiveSyncAccount(uid, cmd, args[0]);
<a name="l03470"></a>03470           <span class="keywordflow">break</span>;
<a name="l03471"></a>03471       }
<a name="l03472"></a>03472     }
<a name="l03473"></a>03473   };
<a name="l03474"></a>03474   <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l03475"></a>03475 });
<a name="l03476"></a>03476 
<a name="l03477"></a>03477 <span class="comment">/*jshint browser: true */</span>
<a name="l03478"></a>03478 <span class="comment">/*global define, console */</span>
<a name="l03479"></a>03479 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/worker-support/cronsync-main&#39;</span>,[<span class="stringliteral">&#39;require&#39;</span>,<span class="stringliteral">&#39;evt&#39;</span>],<span class="keyword">function</span>(<a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>) {
<a name="l03480"></a>03480   <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l03481"></a>03481 
<a name="l03482"></a>03482   var evt = <a class="code" href="../../d9/d2e/alameda_8js.html#a4b4eb847520ff4e45de16db801e26133">require</a>(<span class="stringliteral">&#39;evt&#39;</span>);
<a name="l03483"></a>03483 
<a name="l03484"></a>03484   <span class="keyword">function</span> <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l03485"></a>03485     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;cronsync-main: &#39;</span> + <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>);
<a name="l03486"></a>03486   }
<a name="l03487"></a>03487 
<a name="l03488"></a>03488   <span class="keyword">function</span> makeData(accountIds, interval, <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>) {
<a name="l03489"></a>03489     <span class="keywordflow">return</span> {
<a name="l03490"></a>03490       <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>: <span class="stringliteral">&#39;sync&#39;</span>,
<a name="l03491"></a>03491       accountIds: accountIds,
<a name="l03492"></a>03492       interval: interval,
<a name="l03493"></a>03493       timestamp: <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a>.getTime()
<a name="l03494"></a>03494     };
<a name="l03495"></a>03495   }
<a name="l03496"></a>03496 
<a name="l03497"></a>03497   <span class="comment">// Creates a string key from an array of string IDs. Uses a space</span>
<a name="l03498"></a>03498   <span class="comment">// separator since that cannot show up in an ID.</span>
<a name="l03499"></a>03499   <span class="keyword">function</span> makeAccountKey(accountIds) {
<a name="l03500"></a>03500     <span class="keywordflow">return</span> <span class="stringliteral">&#39;id&#39;</span> + accountIds.join(<span class="charliteral">&#39; &#39;</span>);
<a name="l03501"></a>03501   }
<a name="l03502"></a>03502 
<a name="l03503"></a>03503   <span class="comment">// Converts &#39;interval&#39; + intervalInMillis to just a intervalInMillis</span>
<a name="l03504"></a>03504   <span class="comment">// Number.</span>
<a name="l03505"></a>03505   var prefixLength = <span class="stringliteral">&#39;interval&#39;</span>.length;
<a name="l03506"></a>03506   <span class="keyword">function</span> toInterval(intervalKey) {
<a name="l03507"></a>03507     <span class="keywordflow">return</span> parseInt(intervalKey.substring(prefixLength), 10);
<a name="l03508"></a>03508   }
<a name="l03509"></a>03509 
<a name="l03510"></a>03510   <span class="comment">// Makes sure two arrays have the same values, account IDs.</span>
<a name="l03511"></a>03511   <span class="keyword">function</span> hasSameValues(ary1, ary2) {
<a name="l03512"></a>03512     <span class="keywordflow">if</span> (ary1.length !== ary2.length)
<a name="l03513"></a>03513       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03514"></a>03514 
<a name="l03515"></a>03515     var hasMismatch = ary1.some(<span class="keyword">function</span>(item, i) {
<a name="l03516"></a>03516       <span class="keywordflow">return</span> item !== ary2[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l03517"></a>03517     });
<a name="l03518"></a>03518 
<a name="l03519"></a>03519     <span class="keywordflow">return</span> !hasMismatch;
<a name="l03520"></a>03520   }
<a name="l03521"></a>03521 
<a name="l03522"></a>03522   <span class="keywordflow">if</span> (<a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozSetMessageHandler) {
<a name="l03523"></a>03523     <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozSetMessageHandler(<span class="stringliteral">&#39;alarm&#39;</span>, <span class="keyword">function</span> onAlarm(alarm) {
<a name="l03524"></a>03524       <span class="comment">// Do not bother with alarms that are not sync alarms.</span>
<a name="l03525"></a>03525       var <a class="code" href="../../d9/d04/expat_8h.html#aa11c5d56dba0976f16f07ea50b1999ba">data</a> = alarm.data;
<a name="l03526"></a>03526       <span class="keywordflow">if</span> (!data || data.type !== <span class="stringliteral">&#39;sync&#39;</span>)
<a name="l03527"></a>03527         <span class="keywordflow">return</span>;
<a name="l03528"></a>03528 
<a name="l03529"></a>03529       <span class="comment">// Need to acquire the wake locks during this alarm notification</span>
<a name="l03530"></a>03530       <span class="comment">// turn of the event loop -- later turns are not guaranteed to</span>
<a name="l03531"></a>03531       <span class="comment">// be up and running. However, knowing when to release the locks</span>
<a name="l03532"></a>03532       <span class="comment">// is only known to the front end, so publish event about it.</span>
<a name="l03533"></a>03533       <span class="comment">// Need a CPU lock since otherwise the app can be paused</span>
<a name="l03534"></a>03534       <span class="comment">// mid-function, which could lead to unexpected behavior, and the</span>
<a name="l03535"></a>03535       <span class="comment">// sync should be completed as quick as possible to then close</span>
<a name="l03536"></a>03536       <span class="comment">// down the app.</span>
<a name="l03537"></a>03537       <span class="comment">// TODO: removed wifi wake lock due to network complications, to</span>
<a name="l03538"></a>03538       <span class="comment">// be addressed in a separate changset.</span>
<a name="l03539"></a>03539       <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (<a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.requestWakeLock) {
<a name="l03540"></a>03540         var locks = [
<a name="l03541"></a>03541           <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.requestWakeLock(<span class="stringliteral">&#39;cpu&#39;</span>)
<a name="l03542"></a>03542         ];
<a name="l03543"></a>03543 
<a name="l03544"></a>03544         <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;wake locks acquired: &#39;</span> + locks +
<a name="l03545"></a>03545               <span class="stringliteral">&#39; for account IDs: &#39;</span> + data.accountIds);
<a name="l03546"></a>03546 
<a name="l03547"></a>03547         evt.emitWhenListener(<span class="stringliteral">&#39;cronSyncWakeLocks&#39;</span>,
<a name="l03548"></a>03548                              makeAccountKey(data.accountIds), locks);
<a name="l03549"></a>03549       }
<a name="l03550"></a>03550 
<a name="l03551"></a>03551       dispatcher._sendMessage(<span class="stringliteral">&#39;alarm&#39;</span>, [data.accountIds, data.interval]);
<a name="l03552"></a>03552     });
<a name="l03553"></a>03553   }
<a name="l03554"></a>03554 
<a name="l03555"></a>03555   var dispatcher = {
<a name="l03556"></a>03556     _routeReady: <span class="keyword">false</span>,
<a name="l03557"></a>03557     _routeQueue: [],
<a name="l03558"></a>03558     _sendMessage: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l03559"></a>03559       <span class="keywordflow">if</span> (this._routeReady) {
<a name="l03560"></a>03560         <span class="comment">// sendMessage is added to routeRegistration by the main-router module.</span>
<a name="l03561"></a>03561         routeRegistration.sendMessage(<a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, args);
<a name="l03562"></a>03562       } <span class="keywordflow">else</span> {
<a name="l03563"></a>03563         this._routeQueue.push([<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>, args]);
<a name="l03564"></a>03564       }
<a name="l03565"></a>03565     },
<a name="l03566"></a>03566 
<a name="l03570"></a>03570     hello: <span class="keyword">function</span>() {
<a name="l03571"></a>03571       this._routeReady = <span class="keyword">true</span>;
<a name="l03572"></a>03572       <span class="keywordflow">if</span> (this._routeQueue.length) {
<a name="l03573"></a>03573         var queue = this._routeQueue;
<a name="l03574"></a>03574         this._routeQueue = [];
<a name="l03575"></a>03575         queue.forEach(<span class="keyword">function</span>(args) {
<a name="l03576"></a>03576           this._sendMessage(args[0], args[1]);
<a name="l03577"></a>03577         }.bind(<span class="keyword">this</span>));
<a name="l03578"></a>03578       }
<a name="l03579"></a>03579     },
<a name="l03580"></a>03580 
<a name="l03585"></a>03585     clearAll: <span class="keyword">function</span>() {
<a name="l03586"></a>03586       var mozAlarms = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozAlarms;
<a name="l03587"></a>03587       <span class="keywordflow">if</span> (!mozAlarms)
<a name="l03588"></a>03588         <span class="keywordflow">return</span>;
<a name="l03589"></a>03589 
<a name="l03590"></a>03590       var r = mozAlarms.getAll();
<a name="l03591"></a>03591 
<a name="l03592"></a>03592       r.onsuccess = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l03593"></a>03593         var alarms = <span class="keyword">event</span>.target.result;
<a name="l03594"></a>03594         <span class="keywordflow">if</span> (!alarms)
<a name="l03595"></a>03595           <span class="keywordflow">return</span>;
<a name="l03596"></a>03596 
<a name="l03597"></a>03597         alarms.forEach(<span class="keyword">function</span>(alarm) {
<a name="l03598"></a>03598           <span class="keywordflow">if</span> (alarm.data &amp;&amp; alarm.data.type === <span class="stringliteral">&#39;sync&#39;</span>)
<a name="l03599"></a>03599             mozAlarms.remove(alarm.id);
<a name="l03600"></a>03600         });
<a name="l03601"></a>03601       }.bind(<span class="keyword">this</span>);
<a name="l03602"></a>03602       r.onerror = <span class="keyword">function</span>(err) {
<a name="l03603"></a>03603         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;cronsync-main clearAll mozAlarms.getAll: error: &#39;</span> +
<a name="l03604"></a>03604                       err);
<a name="l03605"></a>03605       }.bind(<span class="keyword">this</span>);
<a name="l03606"></a>03606     },
<a name="l03607"></a>03607 
<a name="l03615"></a>03615     ensureSync: <span class="keyword">function</span> (syncData) {
<a name="l03616"></a>03616       var mozAlarms = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozAlarms;
<a name="l03617"></a>03617       <span class="keywordflow">if</span> (!mozAlarms)
<a name="l03618"></a>03618         <span class="keywordflow">return</span>;
<a name="l03619"></a>03619 
<a name="l03620"></a>03620       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;ensureSync called&#39;</span>);
<a name="l03621"></a>03621 
<a name="l03622"></a>03622       var <a class="code" href="../../df/d44/permission__manager_8js.html#ad9abb423164fcb98d6ad9333893e4682">request</a> = mozAlarms.getAll();
<a name="l03623"></a>03623 
<a name="l03624"></a>03624       request.onsuccess = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l03625"></a>03625         var alarms = <span class="keyword">event</span>.target.result;
<a name="l03626"></a>03626         <span class="keywordflow">if</span> (!alarms)
<a name="l03627"></a>03627           <span class="keywordflow">return</span>;
<a name="l03628"></a>03628 
<a name="l03629"></a>03629         <span class="comment">// Find all IDs being tracked by alarms</span>
<a name="l03630"></a>03630         var expiredAlarmIds = [],
<a name="l03631"></a>03631             okAlarmIntervals = {},
<a name="l03632"></a>03632             uniqueAlarms = {};
<a name="l03633"></a>03633 
<a name="l03634"></a>03634         alarms.forEach(<span class="keyword">function</span>(alarm) {
<a name="l03635"></a>03635           <span class="comment">// Only care about sync alarms.</span>
<a name="l03636"></a>03636           <span class="keywordflow">if</span> (!alarm.data || !alarm.data.type || alarm.data.type !== <span class="stringliteral">&#39;sync&#39;</span>)
<a name="l03637"></a>03637             <span class="keywordflow">return</span>;
<a name="l03638"></a>03638 
<a name="l03639"></a>03639           var intervalKey = <span class="stringliteral">&#39;interval&#39;</span> + alarm.data.interval,
<a name="l03640"></a>03640               wantedAccountIds = syncData[intervalKey];
<a name="l03641"></a>03641 
<a name="l03642"></a>03642           <a class="code" href="../../d6/d52/js_2browser_8js.html#a7321fd84345f4f9455f25996b932b8fd">if</a> (!wantedAccountIds || !hasSameValues(wantedAccountIds,
<a name="l03643"></a>03643                                                   alarm.data.accountIds)) {
<a name="l03644"></a>03644             <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;account array mismatch, canceling existing alarm&#39;</span>);
<a name="l03645"></a>03645             expiredAlarmIds.push(alarm.id);
<a name="l03646"></a>03646           } <span class="keywordflow">else</span> {
<a name="l03647"></a>03647             <span class="comment">// Confirm the existing alarm is still good.</span>
<a name="l03648"></a>03648             var interval = toInterval(intervalKey),
<a name="l03649"></a>03649                 now = Date.now(),
<a name="l03650"></a>03650                 alarmTime = alarm.data.timestamp,
<a name="l03651"></a>03651                 accountKey = makeAccountKey(wantedAccountIds);
<a name="l03652"></a>03652 
<a name="l03653"></a>03653             <span class="comment">// If the interval is nonzero, and there is no other alarm found</span>
<a name="l03654"></a>03654             <span class="comment">// for that account combo, and if it is not in the past and if it</span>
<a name="l03655"></a>03655             <span class="comment">// is not too far in the future, it is OK to keep.</span>
<a name="l03656"></a>03656             <span class="keywordflow">if</span> (interval &amp;&amp; !uniqueAlarms.hasOwnProperty(accountKey) &amp;&amp;
<a name="l03657"></a>03657                 alarmTime &gt; now &amp;&amp; alarmTime &lt; now + interval) {
<a name="l03658"></a>03658               <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;existing alarm is OK&#39;</span>);
<a name="l03659"></a>03659               uniqueAlarms[accountKey] = <span class="keyword">true</span>;
<a name="l03660"></a>03660               okAlarmIntervals[intervalKey] = <span class="keyword">true</span>;
<a name="l03661"></a>03661             } <span class="keywordflow">else</span> {
<a name="l03662"></a>03662               <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;existing alarm is out of interval range, canceling&#39;</span>);
<a name="l03663"></a>03663               expiredAlarmIds.push(alarm.id);
<a name="l03664"></a>03664             }
<a name="l03665"></a>03665           }
<a name="l03666"></a>03666         });
<a name="l03667"></a>03667 
<a name="l03668"></a>03668         expiredAlarmIds.forEach(<span class="keyword">function</span>(alarmId) {
<a name="l03669"></a>03669           mozAlarms.remove(alarmId);
<a name="l03670"></a>03670         });
<a name="l03671"></a>03671 
<a name="l03672"></a>03672         var alarmMax = 0,
<a name="l03673"></a>03673             alarmCount = 0,
<a name="l03674"></a>03674             <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l03675"></a>03675 
<a name="l03676"></a>03676         <span class="comment">// Called when alarms are confirmed to be set.</span>
<a name="l03677"></a>03677         <span class="keyword">function</span> <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>() {
<a name="l03678"></a>03678           alarmCount += 1;
<a name="l03679"></a>03679           <span class="keywordflow">if</span> (alarmCount &lt; alarmMax)
<a name="l03680"></a>03680             <span class="keywordflow">return</span>;
<a name="l03681"></a>03681 
<a name="l03682"></a>03682           <span class="comment">// Indicate ensureSync has completed because the</span>
<a name="l03683"></a>03683           <span class="comment">// back end is waiting to hear alarm was set before</span>
<a name="l03684"></a>03684           <span class="comment">// triggering sync complete.</span>
<a name="l03685"></a>03685           <span class="keyword">self</span>._sendMessage(<span class="stringliteral">&#39;syncEnsured&#39;</span>);
<a name="l03686"></a>03686         }
<a name="l03687"></a>03687 
<a name="l03688"></a>03688         Object.keys(syncData).forEach(<span class="keyword">function</span>(intervalKey) {
<a name="l03689"></a>03689           <span class="comment">// Skip if the existing alarm is already good.</span>
<a name="l03690"></a>03690           <span class="keywordflow">if</span> (okAlarmIntervals.hasOwnProperty(intervalKey))
<a name="l03691"></a>03691             <span class="keywordflow">return</span>;
<a name="l03692"></a>03692 
<a name="l03693"></a>03693           var interval = toInterval(intervalKey),
<a name="l03694"></a>03694               accountIds = syncData[intervalKey],
<a name="l03695"></a>03695               <a class="code" href="../../d3/d4b/lockscreen_8js.html#a94ea84d1e418dad15ea65e006b293fdd">date</a> = <span class="keyword">new</span> Date(Date.now() + interval);
<a name="l03696"></a>03696 
<a name="l03697"></a>03697           <span class="comment">// Do not set an timer for a 0 interval, bad things happen.</span>
<a name="l03698"></a>03698           <span class="keywordflow">if</span> (!interval)
<a name="l03699"></a>03699             <span class="keywordflow">return</span>;
<a name="l03700"></a>03700 
<a name="l03701"></a>03701           alarmMax += 1;
<a name="l03702"></a>03702 
<a name="l03703"></a>03703           var alarmRequest = mozAlarms.add(date, <span class="stringliteral">&#39;ignoreTimezone&#39;</span>,
<a name="l03704"></a>03704                                        makeData(accountIds, interval, date));
<a name="l03705"></a>03705 
<a name="l03706"></a>03706           alarmRequest.onsuccess = <span class="keyword">function</span>() {
<a name="l03707"></a>03707             <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;success: mozAlarms.add for &#39;</span> + <span class="stringliteral">&#39;IDs: &#39;</span> + accountIds +
<a name="l03708"></a>03708                   <span class="stringliteral">&#39; at &#39;</span> + interval + <span class="stringliteral">&#39;ms&#39;</span>);
<a name="l03709"></a>03709             <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l03710"></a>03710           };
<a name="l03711"></a>03711 
<a name="l03712"></a>03712           alarmRequest.onerror = <span class="keyword">function</span>(err) {
<a name="l03713"></a>03713             <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;cronsync-main mozAlarms.add for IDs: &#39;</span> +
<a name="l03714"></a>03714                           accountIds +
<a name="l03715"></a>03715                           <span class="stringliteral">&#39; failed: &#39;</span> + err);
<a name="l03716"></a>03716           };
<a name="l03717"></a>03717         });
<a name="l03718"></a>03718 
<a name="l03719"></a>03719         <span class="comment">// If no alarms were added, indicate ensureSync is done.</span>
<a name="l03720"></a>03720         <span class="keywordflow">if</span> (!alarmMax)
<a name="l03721"></a>03721           <a class="code" href="../../d4/daf/video_2js_2view_8js.html#af9c6eaaef1f3af067f5ea1aff90ff861">done</a>();
<a name="l03722"></a>03722       }.bind(<span class="keyword">this</span>);
<a name="l03723"></a>03723 
<a name="l03724"></a>03724       request.onerror = <span class="keyword">function</span>(err) {
<a name="l03725"></a>03725         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;cronsync-main ensureSync mozAlarms.getAll: error: &#39;</span> +
<a name="l03726"></a>03726                       err);
<a name="l03727"></a>03727       };
<a name="l03728"></a>03728     }
<a name="l03729"></a>03729   };
<a name="l03730"></a>03730 
<a name="l03731"></a>03731   var routeRegistration = {
<a name="l03732"></a>03732     name: <span class="stringliteral">&#39;cronsync&#39;</span>,
<a name="l03733"></a>03733     sendMessage: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03734"></a>03734     dispatch: dispatcher
<a name="l03735"></a>03735   };
<a name="l03736"></a>03736 
<a name="l03737"></a>03737   <span class="keywordflow">return</span> routeRegistration;
<a name="l03738"></a>03738 });
<a name="l03739"></a>03739 
<a name="l03740"></a>03740 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/worker-support/devicestorage-main&#39;</span>,[],<span class="keyword">function</span>() {
<a name="l03741"></a>03741   <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l03742"></a>03742 
<a name="l03743"></a>03743   <span class="keyword">function</span> <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l03744"></a>03744     <a class="code" href="../../d6/d1b/pprthred_8h.html#a49e6921d95ff0b994cd312b3f856a8a6">dump</a>(<span class="stringliteral">&#39;DeviceStorage: &#39;</span> + <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> + <span class="charliteral">&#39;\n&#39;</span>);
<a name="l03745"></a>03745   }
<a name="l03746"></a>03746 
<a name="l03747"></a>03747 
<a name="l03748"></a>03748   <span class="keyword">function</span> <a class="code" href="../../db/d3b/vcard__parser_8js.html#a718354ac603e0a010374cb7b41badb94">save</a>(uid, cmd, storage, blob, <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>) {
<a name="l03749"></a>03749     var <a class="code" href="../../df/d5c/mock__sdcard_8js.html#a91e5d8fc517e24ca527f4536644c806a">deviceStorage</a> = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.getDeviceStorage(storage);
<a name="l03750"></a>03750     var req = deviceStorage.addNamed(blob, <a class="code" href="../../d2/d7d/jsapi_8h.html#a9b61fad0b15688b43345d3f5c3a3d44b">filename</a>);
<a name="l03751"></a>03751 
<a name="l03752"></a>03752     req.onerror = <span class="keyword">function</span>() {
<a name="l03753"></a>03753       <span class="keyword">self</span>.sendMessage(uid, cmd, [<span class="keyword">false</span>, req.error.name]);
<a name="l03754"></a>03754     };
<a name="l03755"></a>03755 
<a name="l03756"></a>03756     req.onsuccess = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>) {
<a name="l03757"></a>03757       var <a class="code" href="../../d9/d04/expat_8h.html#ab9c3d990bb61927ef5406b25c41652ee">prefix</a> = <span class="stringliteral">&#39;&#39;</span>;
<a name="l03758"></a>03758 
<a name="l03759"></a>03759       <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a> <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>.IS_GELAM_TEST !== <span class="stringliteral">&#39;undefined&#39;</span>) {
<a name="l03760"></a>03760         prefix = <span class="stringliteral">&#39;TEST_PREFIX/&#39;</span>;
<a name="l03761"></a>03761       }
<a name="l03762"></a>03762 
<a name="l03763"></a>03763       <span class="comment">// Bool success, String err, String filename</span>
<a name="l03764"></a>03764       <span class="keyword">self</span>.sendMessage(uid, cmd, [<span class="keyword">true</span>, <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, prefix + <a class="code" href="../../d1/d04/app__install__manager_8js.html#ab5902775854a8b8440bcd25e0fe1c120">e</a>.target.result]);
<a name="l03765"></a>03765     };
<a name="l03766"></a>03766   }
<a name="l03767"></a>03767 
<a name="l03768"></a>03768   var <span class="keyword">self</span> = {
<a name="l03769"></a>03769     name: <span class="stringliteral">&#39;devicestorage&#39;</span>,
<a name="l03770"></a>03770     sendMessage: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03771"></a>03771     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>: <span class="keyword">function</span>(uid, cmd, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l03772"></a>03772       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;process &#39;</span> + cmd);
<a name="l03773"></a>03773       <span class="keywordflow">switch</span> (cmd) {
<a name="l03774"></a>03774         <span class="keywordflow">case</span> <span class="stringliteral">&#39;save&#39;</span>:
<a name="l03775"></a>03775           <a class="code" href="../../db/d3b/vcard__parser_8js.html#a718354ac603e0a010374cb7b41badb94">save</a>(uid, cmd, args[0], args[1], args[2]);
<a name="l03776"></a>03776           <span class="keywordflow">break</span>;
<a name="l03777"></a>03777       }
<a name="l03778"></a>03778     }
<a name="l03779"></a>03779   };
<a name="l03780"></a>03780   <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l03781"></a>03781 });
<a name="l03782"></a>03782 
<a name="l03783"></a>03783 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/worker-support/maildb-main&#39;</span>,[],<span class="keyword">function</span>() {
<a name="l03784"></a>03784 <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l03785"></a>03785 
<a name="l03786"></a>03786   <span class="keyword">function</span> <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l03787"></a>03787     <a class="code" href="../../d6/d1b/pprthred_8h.html#a49e6921d95ff0b994cd312b3f856a8a6">dump</a>(<span class="stringliteral">&#39;MailDB: &#39;</span> + <a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a> + <span class="charliteral">&#39;\n&#39;</span>);
<a name="l03788"></a>03788   }
<a name="l03789"></a>03789 
<a name="l03790"></a>03790   var <a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a> = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03791"></a>03791   <span class="keyword">function</span> <a class="code" href="../../df/d65/openaudio_8js.html#ad0452adbe6c8d74d2e2afaa489294b68">open</a>(uid, cmd, args) {
<a name="l03792"></a>03792     db = <span class="keyword">self</span>._debugDB = <span class="keyword">new</span> MailDB(args[0], <span class="keyword">function</span>() {
<a name="l03793"></a>03793       <span class="keyword">self</span>.sendMessage(uid, cmd, Array.prototype.slice.call(arguments));
<a name="l03794"></a>03794     });
<a name="l03795"></a>03795   }
<a name="l03796"></a>03796 
<a name="l03797"></a>03797   <span class="keyword">function</span> others(uid, cmd, args) {
<a name="l03798"></a>03798     <span class="keywordflow">if</span> (!Array.isArray(args))
<a name="l03799"></a>03799       args = [];
<a name="l03800"></a>03800     args.push(<span class="keyword">function</span>() {
<a name="l03801"></a>03801       <span class="keyword">self</span>.sendMessage(uid, cmd, Array.prototype.slice.call(arguments));
<a name="l03802"></a>03802     });
<a name="l03803"></a>03803     <span class="keywordflow">if</span> (!db._db)
<a name="l03804"></a>03804       <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.warn(<span class="stringliteral">&#39;trying to call&#39;</span>, cmd, <span class="stringliteral">&#39;on apparently dead db. skipping.&#39;</span>);
<a name="l03805"></a>03805     <span class="keywordflow">else</span>
<a name="l03806"></a>03806       db[cmd].apply(db, args);
<a name="l03807"></a>03807   }
<a name="l03808"></a>03808 
<a name="l03809"></a>03809   var <span class="keyword">self</span> = {
<a name="l03810"></a>03810     name: <span class="stringliteral">&#39;maildb&#39;</span>,
<a name="l03811"></a>03811     sendMessage: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l03812"></a>03812     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>: <span class="keyword">function</span>(uid, cmd, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l03813"></a>03813       <span class="keywordflow">switch</span> (cmd) {
<a name="l03814"></a>03814         <span class="keywordflow">case</span> <span class="stringliteral">&#39;open&#39;</span>:
<a name="l03815"></a>03815           <a class="code" href="../../df/d65/openaudio_8js.html#ad0452adbe6c8d74d2e2afaa489294b68">open</a>(uid, cmd, args);
<a name="l03816"></a>03816           <span class="keywordflow">break</span>;
<a name="l03817"></a>03817         <span class="keywordflow">default</span>:
<a name="l03818"></a>03818           others(uid, cmd, args);
<a name="l03819"></a>03819           <span class="keywordflow">break</span>;
<a name="l03820"></a>03820       }
<a name="l03821"></a>03821     },
<a name="l03822"></a>03822     _debugDB: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>
<a name="l03823"></a>03823   };
<a name="l03824"></a>03824 
<a name="l03825"></a>03825 var IndexedDB;
<a name="l03826"></a>03826 <span class="keywordflow">if</span> ((<span class="stringliteral">&quot;indexedDB&quot;</span> in <a class="code" href="../../dd/d64/apps_2email_2js_2ext_2mailapi_2worker-bootstrap_8js.html#a1f5517920aaab1f97bda91f10438fb05">window</a>) &amp;&amp; window.indexedDB) {
<a name="l03827"></a>03827   IndexedDB = window.indexedDB;
<a name="l03828"></a>03828 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="stringliteral">&quot;mozIndexedDB&quot;</span> in window) &amp;&amp; window.mozIndexedDB) {
<a name="l03829"></a>03829   IndexedDB = window.mozIndexedDB;
<a name="l03830"></a>03830 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="stringliteral">&quot;webkitIndexedDB&quot;</span> in window) &amp;&amp; window.webkitIndexedDB) {
<a name="l03831"></a>03831   IndexedDB = window.webkitIndexedDB;
<a name="l03832"></a>03832 } <span class="keywordflow">else</span> {
<a name="l03833"></a>03833   <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&quot;No IndexedDB!&quot;</span>);
<a name="l03834"></a>03834   <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="../../dc/d06/calendar_2js_2error_8js.html#abd05c43175d3c93c6889542cefc822f3">Error</a>(<span class="stringliteral">&quot;I need IndexedDB; load me in a content page universe!&quot;</span>);
<a name="l03835"></a>03835 }
<a name="l03836"></a>03836 
<a name="l03859"></a>03859 var CUR_VERSION = 22;
<a name="l03860"></a>03860 
<a name="l03869"></a>03869 var FRIENDLY_LAZY_DB_UPGRADE_VERSION = 5;
<a name="l03870"></a>03870 
<a name="l03876"></a>03876 var TBL_CONFIG = <span class="stringliteral">&#39;config&#39;</span>,
<a name="l03877"></a>03877       CONFIG_KEY_ROOT = <span class="stringliteral">&#39;config&#39;</span>,
<a name="l03878"></a>03878       <span class="comment">// key: accountDef:`AccountId`</span>
<a name="l03879"></a>03879       CONFIG_KEYPREFIX_ACCOUNT_DEF = <span class="stringliteral">&#39;accountDef:&#39;</span>;
<a name="l03880"></a>03880 
<a name="l03895"></a>03895 var TBL_FOLDER_INFO = <span class="stringliteral">&#39;folderInfo&#39;</span>;
<a name="l03896"></a>03896 
<a name="l03913"></a>03913 var TBL_HEADER_BLOCKS = <span class="stringliteral">&#39;headerBlocks&#39;</span>;
<a name="l03929"></a>03929 var TBL_BODY_BLOCKS = <span class="stringliteral">&#39;bodyBlocks&#39;</span>;
<a name="l03930"></a>03930 
<a name="l03976"></a>03976 <span class="keyword">function</span> MailDB(testOptions, successCb, errorCb, upgradeCb) {
<a name="l03977"></a>03977   this._db = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03978"></a>03978 
<a name="l03979"></a>03979   this._lazyConfigCarryover = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l03980"></a>03980 
<a name="l03985"></a>03985   this._fatalError = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l03986"></a>03986     <span class="keyword">function</span> explainSource(source) {
<a name="l03987"></a>03987       <span class="keywordflow">if</span> (!source)
<a name="l03988"></a>03988         <span class="keywordflow">return</span> <span class="stringliteral">&#39;unknown source&#39;</span>;
<a name="l03989"></a>03989       <span class="keywordflow">if</span> (source instanceof <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a13093c169cc6d476322264b437526d63">IDBObjectStore</a>)
<a name="l03990"></a>03990         <span class="keywordflow">return</span> <span class="stringliteral">&#39;object store &quot;&#39;</span> + source.name + <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03991"></a>03991       <span class="keywordflow">if</span> (source instanceof <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28af18d7d5f0af340fb17cc01e9b8f24d0b">IDBIndex</a>)
<a name="l03992"></a>03992         <span class="keywordflow">return</span> <span class="stringliteral">&#39;index &quot;&#39;</span> + source.name + <span class="stringliteral">&#39;&quot; on object store &quot;&#39;</span> +
<a name="l03993"></a>03993           source.objectStore.name + <span class="charliteral">&#39;&quot;&#39;</span>;
<a name="l03994"></a>03994       <span class="keywordflow">if</span> (source instanceof <a class="code" href="../../d0/dfb/namespacemozilla_1_1dom_1_1prototypes_1_1id.html#addcec93baff9084aadf2519231ea4a28a5aadd38a1fbdb991c63c2b6122e8af10">IDBCursor</a>)
<a name="l03995"></a>03995         <span class="keywordflow">return</span> <span class="stringliteral">&#39;cursor on &#39;</span> + explainSource(source.source);
<a name="l03996"></a>03996       <span class="keywordflow">return</span> <span class="stringliteral">&#39;unexpected source&#39;</span>;
<a name="l03997"></a>03997     }
<a name="l03998"></a>03998     var explainedSource, <a class="code" href="../../d9/d04/expat_8h.html#acfcb72e11f425a604663d645d2a4ea80">target</a> = <span class="keyword">event</span>.target;
<a name="l03999"></a>03999     <span class="keywordflow">if</span> (target instanceof <a class="code" href="../../df/d2f/class_i_d_b_transaction.html">IDBTransaction</a>) {
<a name="l04000"></a>04000       explainedSource = <span class="stringliteral">&#39;transaction (&#39;</span> + target.mode + <span class="charliteral">&#39;)&#39;</span>;
<a name="l04001"></a>04001     }
<a name="l04002"></a>04002     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (target instanceof <a class="code" href="../../d4/d2b/class_i_d_b_request.html">IDBRequest</a>) {
<a name="l04003"></a>04003       explainedSource = <span class="stringliteral">&#39;request as part of &#39;</span> +
<a name="l04004"></a>04004         (target.transaction ? target.transaction.mode : <span class="stringliteral">&#39;NO&#39;</span>) +
<a name="l04005"></a>04005         <span class="stringliteral">&#39; transaction on &#39;</span> + explainSource(target.source);
<a name="l04006"></a>04006     }
<a name="l04007"></a>04007     <span class="keywordflow">else</span> { <span class="comment">// dunno, ask it to stringify itself.</span>
<a name="l04008"></a>04008       explainedSource = target.toString();
<a name="l04009"></a>04009     }
<a name="l04010"></a>04010     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;indexedDB error:&#39;</span>, target.error.name, <span class="stringliteral">&#39;from&#39;</span>,
<a name="l04011"></a>04011                   explainedSource);
<a name="l04012"></a>04012   };
<a name="l04013"></a>04013 
<a name="l04014"></a>04014   var dbVersion = CUR_VERSION;
<a name="l04015"></a>04015   <span class="keywordflow">if</span> (testOptions &amp;&amp; testOptions.dbDelta)
<a name="l04016"></a>04016     dbVersion += testOptions.dbDelta;
<a name="l04017"></a>04017   <span class="keywordflow">if</span> (testOptions &amp;&amp; testOptions.dbVersion)
<a name="l04018"></a>04018     dbVersion = testOptions.dbVersion;
<a name="l04019"></a>04019   var openRequest = IndexedDB.open(<span class="stringliteral">&#39;b2g-email&#39;</span>, dbVersion), <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l04020"></a>04020   openRequest.onsuccess = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l04021"></a>04021     <span class="keyword">self</span>._db = openRequest.result;
<a name="l04022"></a>04022 
<a name="l04023"></a>04023     successCb();
<a name="l04024"></a>04024   };
<a name="l04025"></a>04025   openRequest.onupgradeneeded = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l04026"></a>04026     <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.log(<span class="stringliteral">&#39;MailDB in onupgradeneeded&#39;</span>);
<a name="l04027"></a>04027     var db = openRequest.result;
<a name="l04028"></a>04028 
<a name="l04029"></a>04029     <span class="comment">// - reset to clean slate</span>
<a name="l04030"></a>04030     <span class="keywordflow">if</span> ((<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>.oldVersion &lt; FRIENDLY_LAZY_DB_UPGRADE_VERSION) ||
<a name="l04031"></a>04031         (testOptions &amp;&amp; testOptions.nukeDb)) {
<a name="l04032"></a>04032       <span class="keyword">self</span>._nukeDB(db);
<a name="l04033"></a>04033     }
<a name="l04034"></a>04034     <span class="comment">// - friendly, lazy upgrade</span>
<a name="l04035"></a>04035     <span class="keywordflow">else</span> {
<a name="l04036"></a>04036       var trans = openRequest.transaction;
<a name="l04037"></a>04037       <span class="comment">// Load the current config, save it off so getConfig can use it, then nuke</span>
<a name="l04038"></a>04038       <span class="comment">// like usual.  This is obviously a potentially data-lossy approach to</span>
<a name="l04039"></a>04039       <span class="comment">// things; but this is a &#39;lazy&#39; / best-effort approach to make us more</span>
<a name="l04040"></a>04040       <span class="comment">// willing to bump revs during development, not the holy grail.</span>
<a name="l04041"></a>04041       <span class="keyword">self</span>.getConfig(<span class="keyword">function</span>(configObj, accountInfos) {
<a name="l04042"></a>04042         <span class="keywordflow">if</span> (configObj)
<a name="l04043"></a>04043           <span class="keyword">self</span>._lazyConfigCarryover = {
<a name="l04044"></a>04044             oldVersion: <span class="keyword">event</span>.oldVersion,
<a name="l04045"></a>04045             config: configObj,
<a name="l04046"></a>04046             accountInfos: accountInfos
<a name="l04047"></a>04047           };
<a name="l04048"></a>04048         <span class="keyword">self</span>._nukeDB(db);
<a name="l04049"></a>04049       }, trans);
<a name="l04050"></a>04050     }
<a name="l04051"></a>04051   };
<a name="l04052"></a>04052   openRequest.onerror = this._fatalError;
<a name="l04053"></a>04053 }
<a name="l04054"></a>04054 
<a name="l04055"></a>04055 MailDB.prototype = {
<a name="l04059"></a>04059   _nukeDB: <span class="keyword">function</span>(<a class="code" href="../../d1/d0b/browser__db_8js.html#a699c7194b69fa5470e5f97986af77ee1">db</a>) {
<a name="l04060"></a>04060     var existingNames = db.objectStoreNames;
<a name="l04061"></a>04061     <span class="keywordflow">for</span> (var i = 0; i &lt; existingNames.length; i++) {
<a name="l04062"></a>04062       db.deleteObjectStore(existingNames[i]);
<a name="l04063"></a>04063     }
<a name="l04064"></a>04064 
<a name="l04065"></a>04065     db.createObjectStore(TBL_CONFIG);
<a name="l04066"></a>04066     db.createObjectStore(TBL_FOLDER_INFO);
<a name="l04067"></a>04067     db.createObjectStore(TBL_HEADER_BLOCKS);
<a name="l04068"></a>04068     db.createObjectStore(TBL_BODY_BLOCKS);
<a name="l04069"></a>04069   },
<a name="l04070"></a>04070 
<a name="l04071"></a>04071   <a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a>: <span class="keyword">function</span>() {
<a name="l04072"></a>04072     <span class="keywordflow">if</span> (this._db) {
<a name="l04073"></a>04073       this._db.close();
<a name="l04074"></a>04074       this._db = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04075"></a>04075     }
<a name="l04076"></a>04076   },
<a name="l04077"></a>04077 
<a name="l04078"></a>04078   getConfig: <span class="keyword">function</span>(<a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>, trans) {
<a name="l04079"></a>04079     var transaction = trans ||
<a name="l04080"></a>04080                       this._db.transaction([TBL_CONFIG, TBL_FOLDER_INFO],
<a name="l04081"></a>04081                                            <span class="stringliteral">&#39;readonly&#39;</span>);
<a name="l04082"></a>04082     var configStore = transaction.objectStore(TBL_CONFIG),
<a name="l04083"></a>04083         folderInfoStore = transaction.objectStore(TBL_FOLDER_INFO);
<a name="l04084"></a>04084 
<a name="l04085"></a>04085     <span class="comment">// these will fire sequentially</span>
<a name="l04086"></a>04086     var configReq = configStore.mozGetAll(),
<a name="l04087"></a>04087         folderInfoReq = folderInfoStore.mozGetAll();
<a name="l04088"></a>04088 
<a name="l04089"></a>04089     configReq.onerror = this._fatalError;
<a name="l04090"></a>04090     <span class="comment">// no need to track success, we can read it off folderInfoReq</span>
<a name="l04091"></a>04091     folderInfoReq.onerror = this._fatalError;
<a name="l04092"></a>04092     var <span class="keyword">self</span> = <span class="keyword">this</span>;
<a name="l04093"></a>04093     folderInfoReq.onsuccess = <span class="keyword">function</span>(<a class="code" href="../../df/dea/pkcs11t_8h.html#afaa077e4b9760c92cbaf0d838e743d8c">event</a>) {
<a name="l04094"></a>04094       var configObj = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>, accounts = [], <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>, <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>;
<a name="l04095"></a>04095 
<a name="l04096"></a>04096       <span class="comment">// - Check for lazy carryover.</span>
<a name="l04097"></a>04097       <span class="comment">// IndexedDB provides us with a strong ordering guarantee that this is</span>
<a name="l04098"></a>04098       <span class="comment">// happening after any upgrade check.  Doing it outside this closure would</span>
<a name="l04099"></a>04099       <span class="comment">// be race-prone/reliably fail.</span>
<a name="l04100"></a>04100       <span class="keywordflow">if</span> (<span class="keyword">self</span>._lazyConfigCarryover) {
<a name="l04101"></a>04101         var lazyCarryover = <span class="keyword">self</span>._lazyConfigCarryover;
<a name="l04102"></a>04102         <span class="keyword">self</span>._lazyConfigCarryover = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04103"></a>04103         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(configObj, accounts, lazyCarryover);
<a name="l04104"></a>04104         <span class="keywordflow">return</span>;
<a name="l04105"></a>04105       }
<a name="l04106"></a>04106 
<a name="l04107"></a>04107       <span class="comment">// - Process the results</span>
<a name="l04108"></a>04108       <span class="keywordflow">for</span> (i = 0; i &lt; configReq.result.length; i++) {
<a name="l04109"></a>04109         obj = configReq.result[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l04110"></a>04110         <span class="keywordflow">if</span> (obj.id === <span class="stringliteral">&#39;config&#39;</span>)
<a name="l04111"></a>04111           configObj = <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>;
<a name="l04112"></a>04112         <span class="keywordflow">else</span>
<a name="l04113"></a>04113           accounts.push({<a class="code" href="../../d2/d7d/jsapi_8h.html#a6d77125b32b2b42d84796493ad83a708">def</a>: <a class="code" href="../../d2/d7d/jsapi_8h.html#a2219cf9467e8547184b3cf2b051e8067">obj</a>, folderInfo: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>});
<a name="l04114"></a>04114       }
<a name="l04115"></a>04115       <span class="keywordflow">for</span> (i = 0; i &lt; folderInfoReq.result.length; i++) {
<a name="l04116"></a>04116         accounts[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>].folderInfo = folderInfoReq.result[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>];
<a name="l04117"></a>04117       }
<a name="l04118"></a>04118 
<a name="l04119"></a>04119       <span class="keywordflow">try</span> {
<a name="l04120"></a>04120         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(configObj, accounts);
<a name="l04121"></a>04121       }
<a name="l04122"></a>04122       <span class="keywordflow">catch</span>(ex) {
<a name="l04123"></a>04123         <a class="code" href="../../d9/d42/caldav__worker_8js.html#ac798a668e63cdb5c7af2b97ab014f85f">console</a>.error(<span class="stringliteral">&#39;Problem in configCallback&#39;</span>, ex, <span class="charliteral">&#39;\n&#39;</span>, ex.stack);
<a name="l04124"></a>04124       }
<a name="l04125"></a>04125     };
<a name="l04126"></a>04126   },
<a name="l04127"></a>04127 
<a name="l04128"></a>04128   saveConfig: <span class="keyword">function</span>(<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>) {
<a name="l04129"></a>04129     var req = this._db.transaction(TBL_CONFIG, <span class="stringliteral">&#39;readwrite&#39;</span>)
<a name="l04130"></a>04130                         .objectStore(TBL_CONFIG)
<a name="l04131"></a>04131                         .put(config, <span class="stringliteral">&#39;config&#39;</span>);
<a name="l04132"></a>04132     req.onerror = this._fatalError;
<a name="l04133"></a>04133   },
<a name="l04134"></a>04134 
<a name="l04141"></a>04141   saveAccountDef: <span class="keyword">function</span>(<a class="code" href="../../d1/d0b/fb__init_8js.html#aeac120c9ce32d189166215752b0b1a76">config</a>, accountDef, folderInfo) {
<a name="l04142"></a>04142     var trans = this._db.transaction([TBL_CONFIG, TBL_FOLDER_INFO],
<a name="l04143"></a>04143                                      <span class="stringliteral">&#39;readwrite&#39;</span>);
<a name="l04144"></a>04144 
<a name="l04145"></a>04145     var configStore = trans.objectStore(TBL_CONFIG);
<a name="l04146"></a>04146     configStore.put(config, <span class="stringliteral">&#39;config&#39;</span>);
<a name="l04147"></a>04147     configStore.put(accountDef, CONFIG_KEYPREFIX_ACCOUNT_DEF + accountDef.id);
<a name="l04148"></a>04148     <span class="keywordflow">if</span> (folderInfo) {
<a name="l04149"></a>04149       trans.objectStore(TBL_FOLDER_INFO)
<a name="l04150"></a>04150            .put(folderInfo, accountDef.id);
<a name="l04151"></a>04151     }
<a name="l04152"></a>04152     trans.onerror = this._fatalError;
<a name="l04153"></a>04153   },
<a name="l04154"></a>04154 
<a name="l04155"></a>04155   loadHeaderBlock: <span class="keyword">function</span>(folderId, blockId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04156"></a>04156     var req = this._db.transaction(TBL_HEADER_BLOCKS, <span class="stringliteral">&#39;readonly&#39;</span>)
<a name="l04157"></a>04157                          .objectStore(TBL_HEADER_BLOCKS)
<a name="l04158"></a>04158                          .get(folderId + <span class="charliteral">&#39;:&#39;</span> + blockId);
<a name="l04159"></a>04159     req.onerror = this._fatalError;
<a name="l04160"></a>04160     req.onsuccess = <span class="keyword">function</span>() {
<a name="l04161"></a>04161       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(req.result);
<a name="l04162"></a>04162     };
<a name="l04163"></a>04163   },
<a name="l04164"></a>04164 
<a name="l04165"></a>04165   loadBodyBlock: <span class="keyword">function</span>(folderId, blockId, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04166"></a>04166     var req = this._db.transaction(TBL_BODY_BLOCKS, <span class="stringliteral">&#39;readonly&#39;</span>)
<a name="l04167"></a>04167                          .objectStore(TBL_BODY_BLOCKS)
<a name="l04168"></a>04168                          .get(folderId + <span class="charliteral">&#39;:&#39;</span> + blockId);
<a name="l04169"></a>04169     req.onerror = this._fatalError;
<a name="l04170"></a>04170     req.onsuccess = <span class="keyword">function</span>() {
<a name="l04171"></a>04171       <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>(req.result);
<a name="l04172"></a>04172     };
<a name="l04173"></a>04173   },
<a name="l04174"></a>04174 
<a name="l04191"></a>04191   saveAccountFolderStates: <span class="keyword">function</span>(accountId, folderInfo, perFolderStuff,
<a name="l04192"></a>04192                                     deletedFolderIds, <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>) {
<a name="l04193"></a>04193     var trans = this._db.transaction([TBL_FOLDER_INFO, TBL_HEADER_BLOCKS,
<a name="l04194"></a>04194                                       TBL_BODY_BLOCKS], <span class="stringliteral">&#39;readwrite&#39;</span>);
<a name="l04195"></a>04195     trans.onerror = this._fatalError;
<a name="l04196"></a>04196     trans.objectStore(TBL_FOLDER_INFO).put(folderInfo, accountId);
<a name="l04197"></a>04197 
<a name="l04198"></a>04198     var headerStore = trans.objectStore(TBL_HEADER_BLOCKS),
<a name="l04199"></a>04199         bodyStore = trans.objectStore(TBL_BODY_BLOCKS),
<a name="l04200"></a>04200         <a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>;
<a name="l04201"></a>04201 
<a name="l04208"></a>04208     var operationQueue = [];
<a name="l04209"></a>04209 
<a name="l04210"></a>04210     <span class="keyword">function</span> addToQueue() {
<a name="l04211"></a>04211       var args = Array.slice(arguments);
<a name="l04212"></a>04212       var store = args.shift();
<a name="l04213"></a>04213       var <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a> = args.shift();
<a name="l04214"></a>04214 
<a name="l04215"></a>04215       operationQueue.push({
<a name="l04216"></a>04216         store: store,
<a name="l04217"></a>04217         type: <a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>,
<a name="l04218"></a>04218         args: args
<a name="l04219"></a>04219       });
<a name="l04220"></a>04220     }
<a name="l04221"></a>04221 
<a name="l04222"></a>04222     <span class="keyword">function</span> workQueue() {
<a name="l04223"></a>04223       var pendingRequest = operationQueue.shift();
<a name="l04224"></a>04224 
<a name="l04225"></a>04225       <span class="comment">// no more the transition complete handles the callback</span>
<a name="l04226"></a>04226       <span class="keywordflow">if</span> (!pendingRequest)
<a name="l04227"></a>04227         <span class="keywordflow">return</span>;
<a name="l04228"></a>04228 
<a name="l04229"></a>04229       var store = pendingRequest.store;
<a name="l04230"></a>04230       var type = pendingRequest.type;
<a name="l04231"></a>04231 
<a name="l04232"></a>04232       var request = store[<a class="code" href="../../df/d44/permission__manager_8js.html#a5996578fe734dff3d2912807ee458e83">type</a>].apply(store, pendingRequest.args);
<a name="l04233"></a>04233 
<a name="l04234"></a>04234       request.onsuccess = request.onerror = workQueue;
<a name="l04235"></a>04235     }
<a name="l04236"></a>04236 
<a name="l04237"></a>04237     <span class="keywordflow">for</span> (i = 0; i &lt; perFolderStuff.length; i++) {
<a name="l04238"></a>04238       var pfs = perFolderStuff[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>], block;
<a name="l04239"></a>04239 
<a name="l04240"></a>04240       <span class="keywordflow">for</span> (var headerBlockId in pfs.headerBlocks) {
<a name="l04241"></a>04241         block = pfs.headerBlocks[headerBlockId];
<a name="l04242"></a>04242         <span class="keywordflow">if</span> (block)
<a name="l04243"></a>04243           addToQueue(headerStore, <span class="stringliteral">&#39;put&#39;</span>, block, pfs.id + <span class="charliteral">&#39;:&#39;</span> + headerBlockId);
<a name="l04244"></a>04244         <span class="keywordflow">else</span>
<a name="l04245"></a>04245           addToQueue(headerStore, <span class="stringliteral">&#39;delete&#39;</span>, pfs.id + <span class="charliteral">&#39;:&#39;</span> + headerBlockId);
<a name="l04246"></a>04246       }
<a name="l04247"></a>04247 
<a name="l04248"></a>04248       <span class="keywordflow">for</span> (var bodyBlockId in pfs.bodyBlocks) {
<a name="l04249"></a>04249         block = pfs.bodyBlocks[bodyBlockId];
<a name="l04250"></a>04250         <span class="keywordflow">if</span> (block)
<a name="l04251"></a>04251           addToQueue(bodyStore, <span class="stringliteral">&#39;put&#39;</span>, block, pfs.id + <span class="charliteral">&#39;:&#39;</span> + bodyBlockId);
<a name="l04252"></a>04252         <span class="keywordflow">else</span>
<a name="l04253"></a>04253           addToQueue(bodyStore, <span class="stringliteral">&#39;delete&#39;</span>, pfs.id + <span class="charliteral">&#39;:&#39;</span> + bodyBlockId);
<a name="l04254"></a>04254       }
<a name="l04255"></a>04255     }
<a name="l04256"></a>04256 
<a name="l04257"></a>04257     <span class="keywordflow">if</span> (deletedFolderIds) {
<a name="l04258"></a>04258       <span class="keywordflow">for</span> (i = 0; i &lt; deletedFolderIds.length; i++) {
<a name="l04259"></a>04259         var folderId = deletedFolderIds[<a class="code" href="../../da/d7d/sylvester_8js.html#a091f0effa2d52e9315e1f032073e953b">i</a>],
<a name="l04260"></a>04260             range = IDBKeyRange.bound(folderId + <span class="charliteral">&#39;:&#39;</span>,
<a name="l04261"></a>04261                                       folderId + <span class="stringliteral">&#39;:\ufff0&#39;</span>,
<a name="l04262"></a>04262                                       <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l04263"></a>04263         addToQueue(headerStore, <span class="stringliteral">&#39;delete&#39;</span>, range);
<a name="l04264"></a>04264         addToQueue(bodyStore, <span class="stringliteral">&#39;delete&#39;</span>, range);
<a name="l04265"></a>04265       }
<a name="l04266"></a>04266     }
<a name="l04267"></a>04267 
<a name="l04268"></a>04268     <span class="keywordflow">if</span> (callback) {
<a name="l04269"></a>04269       trans.addEventListener(<span class="stringliteral">&#39;complete&#39;</span>, <span class="keyword">function</span>() {
<a name="l04270"></a>04270         <a class="code" href="../../df/d44/permission__manager_8js.html#ab95eebdb2a4acb8510417bf0bdabc3c5">callback</a>();
<a name="l04271"></a>04271       });
<a name="l04272"></a>04272     }
<a name="l04273"></a>04273 
<a name="l04274"></a>04274     workQueue();
<a name="l04275"></a>04275 
<a name="l04276"></a>04276     <span class="keywordflow">return</span> trans;
<a name="l04277"></a>04277   },
<a name="l04278"></a>04278 
<a name="l04282"></a>04282   deleteAccount: <span class="keyword">function</span>(accountId) {
<a name="l04283"></a>04283     var trans = this._db.transaction([TBL_CONFIG, TBL_FOLDER_INFO,
<a name="l04284"></a>04284                                       TBL_HEADER_BLOCKS, TBL_BODY_BLOCKS],
<a name="l04285"></a>04285                                       <span class="stringliteral">&#39;readwrite&#39;</span>);
<a name="l04286"></a>04286     trans.onerror = this._fatalError;
<a name="l04287"></a>04287 
<a name="l04288"></a>04288     trans.objectStore(TBL_CONFIG).delete(<span class="stringliteral">&#39;accountDef:&#39;</span> + accountId);
<a name="l04289"></a>04289     trans.objectStore(TBL_FOLDER_INFO).delete(accountId);
<a name="l04290"></a>04290     var range = IDBKeyRange.bound(accountId + <span class="charliteral">&#39;/&#39;</span>,
<a name="l04291"></a>04291                                   accountId + <span class="stringliteral">&#39;/\ufff0&#39;</span>,
<a name="l04292"></a>04292                                   <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l04293"></a>04293     trans.objectStore(TBL_HEADER_BLOCKS).delete(range);
<a name="l04294"></a>04294     trans.objectStore(TBL_BODY_BLOCKS).delete(range);
<a name="l04295"></a>04295   },
<a name="l04296"></a>04296 };
<a name="l04297"></a>04297 
<a name="l04298"></a>04298 <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l04299"></a>04299 });
<a name="l04300"></a>04300 
<a name="l04301"></a>04301 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/worker-support/net-main&#39;</span>,[],<span class="keyword">function</span>() {
<a name="l04302"></a>04302   <span class="stringliteral">&#39;use strict&#39;</span>;
<a name="l04303"></a>04303 
<a name="l04304"></a>04304   <span class="keyword">function</span> <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<a class="code" href="../../df/d44/permission__manager_8js.html#a176e0fe9a3e516f5aa501f9dcf2eb97b">str</a>) {
<a name="l04305"></a>04305     <span class="comment">//dump(&#39;NetSocket: &#39; + str + &#39;\n&#39;);</span>
<a name="l04306"></a>04306   }
<a name="l04307"></a>04307 
<a name="l04308"></a>04308   <span class="comment">// Maintain a list of active sockets</span>
<a name="l04309"></a>04309   var socks = {};
<a name="l04310"></a>04310 
<a name="l04311"></a>04311   <span class="keyword">function</span> <a class="code" href="../../df/d65/openaudio_8js.html#ad0452adbe6c8d74d2e2afaa489294b68">open</a>(uid, host, <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>, options) {
<a name="l04312"></a>04312     var socket = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.mozTCPSocket;
<a name="l04313"></a>04313     var sock = socks[uid] = socket.open(host, <a class="code" href="../../df/d9e/prnetdb_8h.html#a2442718810e8bab593a8ef904979ca72">port</a>, options);
<a name="l04314"></a>04314 
<a name="l04315"></a>04315     sock.onopen = <span class="keyword">function</span>(evt) {
<a name="l04316"></a>04316       <span class="comment">//debug(&#39;onopen &#39; + uid + &quot;: &quot; + evt.data.toString());</span>
<a name="l04317"></a>04317       <span class="keyword">self</span>.sendMessage(uid, <span class="stringliteral">&#39;onopen&#39;</span>);
<a name="l04318"></a>04318     };
<a name="l04319"></a>04319 
<a name="l04320"></a>04320     sock.onerror = <span class="keyword">function</span>(evt) {
<a name="l04321"></a>04321       <span class="comment">//debug(&#39;onerror &#39; + uid + &quot;: &quot; + new Uint8Array(evt.data));</span>
<a name="l04322"></a>04322       var err = evt.data;
<a name="l04323"></a>04323       var wrappedErr;
<a name="l04324"></a>04324       <span class="keywordflow">if</span> (err &amp;&amp; <a class="code" href="../../d1/d22/ical_8js.html#a6053319846c80bf9561a1958bb817380">typeof</a>(err) === <span class="stringliteral">&#39;object&#39;</span>) {
<a name="l04325"></a>04325         wrappedErr = {
<a name="l04326"></a>04326           name: err.name,
<a name="l04327"></a>04327           type: err.type,
<a name="l04328"></a>04328           <a class="code" href="../../d1/d04/app__install__manager_8js.html#ad031ac2c2bcd5e0fe9c6b67fc309acd4">message</a>: err.message
<a name="l04329"></a>04329         };
<a name="l04330"></a>04330       }
<a name="l04331"></a>04331       <span class="keywordflow">else</span> {
<a name="l04332"></a>04332         wrappedErr = err;
<a name="l04333"></a>04333       }
<a name="l04334"></a>04334       <span class="keyword">self</span>.sendMessage(uid, <span class="stringliteral">&#39;onerror&#39;</span>, wrappedErr);
<a name="l04335"></a>04335     };
<a name="l04336"></a>04336 
<a name="l04337"></a>04337     sock.ondata = <span class="keyword">function</span>(evt) {
<a name="l04338"></a>04338       var <a class="code" href="../../da/d32/prio_8h.html#ac14417684334d01b4e1e807a19d92816">buf</a> = evt.data;
<a name="l04339"></a>04339       <span class="keyword">self</span>.sendMessage(uid, <span class="stringliteral">&#39;ondata&#39;</span>, buf, [buf]);
<a name="l04340"></a>04340     };
<a name="l04341"></a>04341 
<a name="l04342"></a>04342     sock.onclose = <span class="keyword">function</span>(evt) {
<a name="l04343"></a>04343       <span class="comment">//debug(&#39;onclose &#39; + uid + &quot;: &quot; + evt.data.toString());</span>
<a name="l04344"></a>04344       <span class="keyword">self</span>.sendMessage(uid, <span class="stringliteral">&#39;onclose&#39;</span>);
<a name="l04345"></a>04345     };
<a name="l04346"></a>04346   }
<a name="l04347"></a>04347 
<a name="l04348"></a>04348   <span class="keyword">function</span> <a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a>(uid) {
<a name="l04349"></a>04349     var sock = socks[uid];
<a name="l04350"></a>04350     <span class="keywordflow">if</span> (!sock)
<a name="l04351"></a>04351       <span class="keywordflow">return</span>;
<a name="l04352"></a>04352     sock.close();
<a name="l04353"></a>04353     sock.onopen = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04354"></a>04354     sock.onerror = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04355"></a>04355     sock.ondata = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04356"></a>04356     sock.onclose = <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>;
<a name="l04357"></a>04357     <span class="keyword">delete</span> socks[uid];
<a name="l04358"></a>04358   }
<a name="l04359"></a>04359 
<a name="l04360"></a>04360   <span class="keyword">function</span> upgradeToSecure(uid) {
<a name="l04361"></a>04361     socks[uid].upgradeToSecure();
<a name="l04362"></a>04362   }
<a name="l04363"></a>04363 
<a name="l04364"></a>04364   <span class="keyword">function</span> write(uid, data, <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a>, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>) {
<a name="l04365"></a>04365     <span class="comment">// XXX why are we doing this? ask Vivien or try to remove...</span>
<a name="l04366"></a>04366     socks[uid].send(data, <a class="code" href="../../da/d32/prio_8h.html#a894bdfa2d603d8343f8ef01dda6fcd23">offset</a>, <a class="code" href="../../d3/d91/j3d_8js.html#a3f87557d7488bfe7545844c394baa854">length</a>);
<a name="l04367"></a>04367   }
<a name="l04368"></a>04368 
<a name="l04369"></a>04369   var <span class="keyword">self</span> = {
<a name="l04370"></a>04370     name: <span class="stringliteral">&#39;netsocket&#39;</span>,
<a name="l04371"></a>04371     sendMessage: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04372"></a>04372     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>: <span class="keyword">function</span>(uid, cmd, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l04373"></a>04373       <a class="code" href="../../d8/d0e/apps_2costcontrol_2js_2settings_2settings_8js.html#a651046067579e48d7f0d03ce38dc7cf8">debug</a>(<span class="stringliteral">&#39;process &#39;</span> + cmd);
<a name="l04374"></a>04374       <span class="keywordflow">switch</span> (cmd) {
<a name="l04375"></a>04375         <span class="keywordflow">case</span> <span class="stringliteral">&#39;open&#39;</span>:
<a name="l04376"></a>04376           <a class="code" href="../../df/d65/openaudio_8js.html#ad0452adbe6c8d74d2e2afaa489294b68">open</a>(uid, args[0], args[1], args[2]);
<a name="l04377"></a>04377           <span class="keywordflow">break</span>;
<a name="l04378"></a>04378         <span class="keywordflow">case</span> <span class="stringliteral">&#39;close&#39;</span>:
<a name="l04379"></a>04379           <a class="code" href="../../dd/df0/dialogs__end__init_8js.html#acdb1449d11a5550a30ee4a18b9c7f133">close</a>(uid);
<a name="l04380"></a>04380           <span class="keywordflow">break</span>;
<a name="l04381"></a>04381         <span class="keywordflow">case</span> <span class="stringliteral">&#39;write&#39;</span>:
<a name="l04382"></a>04382           write(uid, args[0], args[1], args[2]);
<a name="l04383"></a>04383           <span class="keywordflow">break</span>;
<a name="l04384"></a>04384         <span class="keywordflow">case</span> <span class="stringliteral">&#39;upgradeToSecure&#39;</span>:
<a name="l04385"></a>04385           upgradeToSecure(uid);
<a name="l04386"></a>04386           <span class="keywordflow">break</span>;
<a name="l04387"></a>04387       }
<a name="l04388"></a>04388     }
<a name="l04389"></a>04389   };
<a name="l04390"></a>04390   <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l04391"></a>04391 });
<a name="l04392"></a>04392 
<a name="l04411"></a>04411 <a class="code" href="../../d9/d2e/alameda_8js.html#a8a3a5595e65e7e2a2cf64c08ba74833f">define</a>(<span class="stringliteral">&#39;mailapi/main-frame-setup&#39;</span>,
<a name="l04412"></a>04412   [
<a name="l04413"></a>04413     <span class="comment">// Pretty much everything could be dynamically loaded after we kickoff the</span>
<a name="l04414"></a>04414     <span class="comment">// worker thread.  We just would need to be sure to latch any received</span>
<a name="l04415"></a>04415     <span class="comment">// messages that we receive before we finish setup.</span>
<a name="l04416"></a>04416     <span class="stringliteral">&#39;./worker-support/shim-sham&#39;</span>,
<a name="l04417"></a>04417     <span class="stringliteral">&#39;./mailapi&#39;</span>,
<a name="l04418"></a>04418     <span class="stringliteral">&#39;./worker-support/main-router&#39;</span>,
<a name="l04419"></a>04419     <span class="stringliteral">&#39;./worker-support/configparser-main&#39;</span>,
<a name="l04420"></a>04420     <span class="stringliteral">&#39;./worker-support/cronsync-main&#39;</span>,
<a name="l04421"></a>04421     <span class="stringliteral">&#39;./worker-support/devicestorage-main&#39;</span>,
<a name="l04422"></a>04422     <span class="stringliteral">&#39;./worker-support/maildb-main&#39;</span>,
<a name="l04423"></a>04423     <span class="stringliteral">&#39;./worker-support/net-main&#39;</span>
<a name="l04424"></a>04424   ],
<a name="l04425"></a>04425   <span class="keyword">function</span>(
<a name="l04426"></a>04426     $shim_setup,
<a name="l04427"></a>04427     $mailapi,
<a name="l04428"></a>04428     $router,
<a name="l04429"></a>04429     $configparser,
<a name="l04430"></a>04430     $cronsync,
<a name="l04431"></a>04431     $devicestorage,
<a name="l04432"></a>04432     $maildb,
<a name="l04433"></a>04433     $net
<a name="l04434"></a>04434   ) {
<a name="l04435"></a>04435 
<a name="l04436"></a>04436   var control = {
<a name="l04437"></a>04437     name: <span class="stringliteral">&#39;control&#39;</span>,
<a name="l04438"></a>04438     sendMessage: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04439"></a>04439     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>: <span class="keyword">function</span>(uid, cmd, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l04440"></a>04440       var online = <a class="code" href="../../d0/d94/tools_2xpcwindow_2lib_2loader_8js.html#a1ab79c9277f7648d0dfe676bab65dde4">navigator</a>.onLine;
<a name="l04441"></a>04441       control.sendMessage(uid, <span class="stringliteral">&#39;hello&#39;</span>, [online]);
<a name="l04442"></a>04442 
<a name="l04443"></a>04443       window.addEventListener(<span class="stringliteral">&#39;online&#39;</span>, <span class="keyword">function</span>(evt) {
<a name="l04444"></a>04444         control.sendMessage(uid, evt.type, [<span class="keyword">true</span>]);
<a name="l04445"></a>04445       });
<a name="l04446"></a>04446       window.addEventListener(<span class="stringliteral">&#39;offline&#39;</span>, <span class="keyword">function</span>(evt) {
<a name="l04447"></a>04447         control.sendMessage(uid, evt.type, [<span class="keyword">false</span>]);
<a name="l04448"></a>04448       });
<a name="l04449"></a>04449 
<a name="l04450"></a>04450       $router.unregister(control);
<a name="l04451"></a>04451     },
<a name="l04452"></a>04452   };
<a name="l04453"></a>04453 
<a name="l04454"></a>04454   var MailAPI = <span class="keyword">new</span> $mailapi.MailAPI();
<a name="l04455"></a>04455 
<a name="l04456"></a>04456   var bridge = {
<a name="l04457"></a>04457     name: <span class="stringliteral">&#39;bridge&#39;</span>,
<a name="l04458"></a>04458     sendMessage: <a class="code" href="../../d1/d04/app__install__manager_8js.html#a66d98f9009f0502b9a5ce70e907f8f27">null</a>,
<a name="l04459"></a>04459     <a class="code" href="../../db/d3b/vcard__parser_8js.html#a6f2ec0a8b53b1e2d7d68df633707f9ae">process</a>: <span class="keyword">function</span>(uid, cmd, <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>) {
<a name="l04460"></a>04460       var msg = <a class="code" href="../../db/d7b/r_8js.html#a283fa4dd58795cf5b621404be6601e86">args</a>;
<a name="l04461"></a>04461 
<a name="l04462"></a>04462       <span class="keywordflow">if</span> (msg.type === <span class="stringliteral">&#39;hello&#39;</span>) {
<a name="l04463"></a>04463         <span class="keyword">delete</span> MailAPI._fake;
<a name="l04464"></a>04464         MailAPI.__bridgeSend = <span class="keyword">function</span>(<a class="code" href="../../d1/d04/app__install__manager_8js.html#aa32988dd09d5a9481dfadbb89d1426ab">msg</a>) {
<a name="l04465"></a>04465           worker.postMessage({
<a name="l04466"></a>04466             uid: uid,
<a name="l04467"></a>04467             type: <span class="stringliteral">&#39;bridge&#39;</span>,
<a name="l04468"></a>04468             msg: msg
<a name="l04469"></a>04469           });
<a name="l04470"></a>04470         };
<a name="l04471"></a>04471 
<a name="l04472"></a>04472         MailAPI.config = msg.config;
<a name="l04473"></a>04473 
<a name="l04474"></a>04474         <span class="comment">// Send up all the queued messages to real backend now.</span>
<a name="l04475"></a>04475         MailAPI._storedSends.forEach(<span class="keyword">function</span> (msg) {
<a name="l04476"></a>04476           MailAPI.__bridgeSend(msg);
<a name="l04477"></a>04477         });
<a name="l04478"></a>04478         MailAPI._storedSends = [];
<a name="l04479"></a>04479       } <span class="keywordflow">else</span> {
<a name="l04480"></a>04480         MailAPI.__bridgeReceive(msg);
<a name="l04481"></a>04481       }
<a name="l04482"></a>04482     },
<a name="l04483"></a>04483   };
<a name="l04484"></a>04484 
<a name="l04485"></a>04485   <span class="comment">// Wire up the worker to the router</span>
<a name="l04486"></a>04486   var worker = <span class="keyword">new</span> Worker(<span class="stringliteral">&#39;js/ext/mailapi/worker-bootstrap.js&#39;</span>);
<a name="l04487"></a>04487   $router.useWorker(worker);
<a name="l04488"></a>04488   $router.register(control);
<a name="l04489"></a>04489   $router.register(bridge);
<a name="l04490"></a>04490   $router.register($configparser);
<a name="l04491"></a>04491   $router.register($cronsync);
<a name="l04492"></a>04492   $router.register($devicestorage);
<a name="l04493"></a>04493   $router.register($maildb);
<a name="l04494"></a>04494   $router.register($net);
<a name="l04495"></a>04495 
<a name="l04496"></a>04496   <span class="keywordflow">return</span> MailAPI;
<a name="l04497"></a>04497 }); <span class="comment">// end define</span>
<a name="l04498"></a>04498 ;
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>全て</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>データ構造</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>ネームスペース</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>ファイル</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>関数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>変数</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>型定義</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>列挙型</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>列挙型の値</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>フレンド</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>マクロ定義</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d3/da0/apps_2email_2js_2ext_2mailapi_2main-frame-setup_8js.html">main-frame-setup.js</a>      </li>

    <li class="footer">FxOS Code Readingに対してSat Oct 19 2013 00:52:44に生成されました。
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
